<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="">
  <meta name="theme-color" content="#f57c00">
  <title>Article | Ball603</title>
  
  <!-- Favicon -->
  <link rel="icon" type="image/png" href="/logo.png">
  <link rel="apple-touch-icon" href="/logo.png">
  
  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  
  <!-- Styles -->
  <link rel="stylesheet" href="/styles.css">
  
  <!-- Article-specific styles -->
  <style>
    /* Article Layout */
    .article-container {
      max-width: 800px;
      margin: 0 auto;
      padding: var(--space-lg);
    }
    
    @media (max-width: 768px) {
      .article-container {
        padding: var(--space-md);
        padding-bottom: 100px;
      }
    }
    
    /* Article Header */
    .article-header {
      margin-bottom: var(--space-xl);
    }
    
    .article-tag {
      display: inline-block;
      background: var(--accent);
      color: white;
      padding: var(--space-xs) var(--space-sm);
      border-radius: var(--radius-sm);
      font-size: var(--font-size-xs);
      font-weight: var(--font-weight-bold);
      text-transform: uppercase;
      margin-bottom: var(--space-md);
    }
    
    .article-title {
      font-size: var(--font-size-3xl);
      font-weight: var(--font-weight-bold);
      line-height: 1.2;
      margin-bottom: var(--space-md);
      color: var(--text-primary);
    }
    
    @media (max-width: 768px) {
      .article-title {
        font-size: var(--font-size-2xl);
      }
    }
    
    .article-meta {
      display: flex;
      align-items: center;
      gap: var(--space-md);
      color: var(--text-secondary);
      font-size: var(--font-size-sm);
      flex-wrap: wrap;
    }
    
    .article-author {
      font-weight: var(--font-weight-semibold);
      color: var(--text-primary);
    }
    
    .article-date {
      color: var(--text-muted);
    }
    
    .article-share {
      margin-left: auto;
      display: flex;
      gap: var(--space-sm);
    }
    
    .share-btn {
      background: var(--bg-tertiary);
      border: none;
      width: 36px;
      height: 36px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 16px;
      transition: background var(--transition-fast);
    }
    
    .share-btn:hover {
      background: var(--accent);
      color: white;
    }
    
    /* Featured Media */
    .article-featured {
      margin-bottom: var(--space-xl);
      border-radius: var(--radius-lg);
      overflow: hidden;
      background: var(--bg-tertiary);
    }
    
    .article-featured img,
    .article-featured video {
      width: 100%;
      aspect-ratio: 16 / 9;
      object-fit: cover;
    }
    
    .article-featured iframe {
      width: 100%;
      aspect-ratio: 16 / 9;
      border: none;
    }
    
    .featured-caption {
      padding: var(--space-sm) var(--space-md);
      font-size: var(--font-size-sm);
      color: var(--text-muted);
      background: var(--bg-tertiary);
    }
    
    /* Game Info Box */
    .game-box {
      background: var(--bg-card);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-lg);
      padding: var(--space-lg);
      margin-bottom: var(--space-xl);
    }
    
    .game-box-header {
      font-size: var(--font-size-sm);
      font-weight: var(--font-weight-semibold);
      color: var(--text-muted);
      text-transform: uppercase;
      margin-bottom: var(--space-md);
      text-align: center;
    }
    
    .game-matchup {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: var(--space-lg);
      margin-bottom: var(--space-md);
    }
    
    .game-team {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: var(--space-sm);
      flex: 1;
    }
    
    .game-team-logo {
      width: 64px;
      height: 64px;
      border-radius: var(--radius-md);
      object-fit: contain;
      background: var(--bg-tertiary);
    }
    
    @media (max-width: 500px) {
      .game-team-logo {
        width: 48px;
        height: 48px;
      }
    }
    
    .game-team-name {
      font-size: var(--font-size-md);
      font-weight: var(--font-weight-semibold);
      color: var(--text-primary);
      text-align: center;
    }
    
    .game-score-center {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 0 var(--space-md);
    }
    
    .game-scores {
      display: flex;
      align-items: center;
      gap: var(--space-sm);
      font-size: var(--font-size-3xl);
      font-weight: var(--font-weight-bold);
    }
    
    .game-score {
      min-width: 50px;
      text-align: center;
      color: var(--text-secondary);
    }
    
    .game-score.winner {
      color: var(--accent);
    }
    
    .game-score-dash {
      color: var(--text-muted);
      font-weight: var(--font-weight-normal);
    }
    
    .game-status {
      font-size: var(--font-size-xs);
      font-weight: var(--font-weight-bold);
      text-transform: uppercase;
      color: var(--score-win);
      margin-top: var(--space-xs);
    }
    
    .game-details {
      display: flex;
      justify-content: center;
      gap: var(--space-xl);
      padding-top: var(--space-md);
      border-top: 1px solid var(--border-color);
      margin-top: var(--space-md);
      font-size: var(--font-size-sm);
      color: var(--text-secondary);
    }
    
    .game-detail {
      display: flex;
      align-items: center;
      gap: var(--space-xs);
    }
    
    /* Quarter Scores Section (inside game box) */
    .quarter-scores-section {
      border-top: 1px solid var(--border-color);
      margin-top: var(--space-md);
      padding-top: var(--space-md);
      overflow-x: auto;
    }
    
    /* Quarter Scores Box (standalone, when no linked game) */
    .quarter-scores-box {
      background: var(--bg-card);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-lg);
      padding: var(--space-md) var(--space-lg);
      margin-bottom: var(--space-xl);
      overflow-x: auto;
    }
    
    .quarter-scores-table {
      width: 100%;
      border-collapse: collapse;
      font-size: var(--font-size-sm);
      text-align: center;
      min-width: 380px;
    }
    
    .quarter-scores-table th {
      padding: var(--space-sm) var(--space-xs);
      font-weight: var(--font-weight-semibold);
      color: var(--text-muted);
      border-bottom: 1px solid var(--border-color);
    }
    
    .quarter-scores-table th:first-child {
      text-align: left;
      padding-left: var(--space-sm);
    }
    
    .quarter-scores-table td {
      padding: var(--space-sm) var(--space-xs);
      color: var(--text-secondary);
    }
    
    .quarter-scores-table td:first-child {
      text-align: left;
      padding-left: var(--space-sm);
      font-weight: var(--font-weight-semibold);
      color: var(--text-primary);
    }
    
    .quarter-scores-table td:last-child {
      font-weight: var(--font-weight-bold);
      font-size: var(--font-size-md);
    }
    
    .quarter-scores-table .winner-final {
      color: var(--accent);
    }
    
    .quarter-scores-table tbody tr {
      border-top: 1px solid var(--border-color);
    }
    
    .quarter-scores-table tbody tr:first-child {
      border-top: none;
    }
    
    /* Article Content */
    .article-content {
      font-size: var(--font-size-md);
      line-height: 1.8;
      color: var(--text-primary);
    }
    
    .article-content p {
      margin-bottom: var(--space-lg);
    }
    
    .article-content p:last-child {
      margin-bottom: 0;
    }
    
    .article-content p {
      margin-bottom: var(--space-lg);
    }
    
    .article-content h2 {
      font-size: var(--font-size-xl);
      font-weight: var(--font-weight-bold);
      margin-top: var(--space-xl);
      margin-bottom: var(--space-md);
    }
    
    .article-content h3 {
      font-size: var(--font-size-lg);
      font-weight: var(--font-weight-semibold);
      margin-top: var(--space-lg);
      margin-bottom: var(--space-md);
    }
    
    .article-content ul,
    .article-content ol {
      margin-bottom: var(--space-lg);
      padding-left: var(--space-xl);
    }
    
    .article-content li {
      margin-bottom: var(--space-sm);
    }
    
    .article-content blockquote {
      border-left: 4px solid var(--accent);
      padding-left: var(--space-lg);
      margin: var(--space-lg) 0;
      font-style: italic;
      color: var(--text-secondary);
    }
    
    .article-content img {
      max-width: 100%;
      border-radius: var(--radius-md);
      margin: var(--space-lg) 0;
    }
    
    .article-content a {
      color: var(--accent);
      text-decoration: underline;
    }
    
    .article-content a:hover {
      opacity: 0.8;
    }
    
    /* Tags */
    .article-tags {
      display: flex;
      flex-wrap: wrap;
      gap: var(--space-sm);
      margin-top: var(--space-xl);
      padding-top: var(--space-lg);
      border-top: 1px solid var(--border-color);
    }
    
    .tag {
      background: var(--bg-tertiary);
      color: var(--text-secondary);
      padding: var(--space-xs) var(--space-md);
      border-radius: var(--radius-full);
      font-size: var(--font-size-sm);
      font-weight: var(--font-weight-medium);
      text-decoration: none;
    }
    
    .tag:hover {
      background: var(--accent-light);
      color: var(--accent);
    }
    
    /* Gallery Section */
    .gallery-section {
      margin-top: var(--space-2xl);
      padding-top: var(--space-xl);
      border-top: 1px solid var(--border-color);
    }
    
    .gallery-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: var(--space-lg);
    }
    
    .gallery-title {
      font-size: var(--font-size-xl);
      font-weight: var(--font-weight-bold);
      color: var(--text-primary);
    }
    
    .gallery-count {
      font-size: var(--font-size-sm);
      color: var(--text-muted);
      display: block;
      margin-top: var(--space-xs);
    }
    
    .gallery-link {
      color: var(--accent);
      font-size: var(--font-size-sm);
      font-weight: var(--font-weight-semibold);
      text-decoration: none;
    }
    
    .gallery-link:hover {
      text-decoration: underline;
    }
    
    /* SmugMug Embed */
    .smugmug-embed {
      margin-top: var(--space-md);
      border-radius: var(--radius-lg);
      overflow: hidden;
      background: var(--bg-tertiary);
    }
    
    .smugmug-embed iframe {
      display: block;
      width: 100%;
      min-height: 500px;
    }
    
    @media (max-width: 768px) {
      .smugmug-embed iframe {
        min-height: 400px;
      }
    }
    
    /* Photo Grid (legacy - keeping for potential future use) */
    .photo-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: var(--space-sm);
    }
    
    @media (max-width: 600px) {
      .photo-grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }
    
    .photo-grid-item {
      aspect-ratio: 1;
      border-radius: var(--radius-md);
      overflow: hidden;
      cursor: pointer;
      position: relative;
    }
    
    .photo-grid-item img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      transition: transform var(--transition-normal);
    }
    
    .photo-grid-item:hover img {
      transform: scale(1.05);
    }
    
    .photo-grid-item.featured {
      grid-column: span 2;
      grid-row: span 2;
    }
    
    @media (max-width: 600px) {
      .photo-grid-item.featured {
        grid-column: span 2;
        grid-row: span 1;
        aspect-ratio: 16/9;
      }
    }
    
    /* View All Photos Button */
    .view-all-photos {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: var(--space-sm);
      width: 100%;
      padding: var(--space-md);
      margin-top: var(--space-md);
      background: var(--bg-card);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-lg);
      color: var(--accent);
      font-size: var(--font-size-md);
      font-weight: var(--font-weight-semibold);
      cursor: pointer;
      transition: background var(--transition-fast);
    }
    
    .view-all-photos:hover {
      background: var(--accent-light);
    }
    
    /* Related Stories */
    .related-section {
      margin-top: var(--space-2xl);
      padding-top: var(--space-xl);
      border-top: 1px solid var(--border-color);
    }
    
    .related-title {
      font-size: var(--font-size-lg);
      font-weight: var(--font-weight-bold);
      margin-bottom: var(--space-lg);
      color: var(--text-primary);
    }
    
    .related-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: var(--space-md);
    }
    
    @media (max-width: 600px) {
      .related-grid {
        grid-template-columns: 1fr;
      }
    }
    
    .related-card {
      display: flex;
      gap: var(--space-md);
      background: var(--bg-card);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-lg);
      padding: var(--space-md);
      text-decoration: none;
      transition: box-shadow var(--transition-fast);
    }
    
    .related-card:hover {
      box-shadow: var(--shadow-md);
    }
    
    .related-card-image {
      width: 100px;
      height: 75px;
      border-radius: var(--radius-md);
      object-fit: cover;
      flex-shrink: 0;
    }
    
    .related-card-content {
      flex: 1;
      min-width: 0;
    }
    
    .related-card-title {
      font-size: var(--font-size-sm);
      font-weight: var(--font-weight-semibold);
      color: var(--text-primary);
      line-height: 1.4;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }
    
    .related-card-meta {
      font-size: var(--font-size-xs);
      color: var(--text-muted);
      margin-top: var(--space-xs);
    }
    
    /* Loading State */
    .article-loading {
      display: flex;
      flex-direction: column;
      gap: var(--space-lg);
      padding: var(--space-xl);
    }
    
    /* Error State */
    .article-error {
      text-align: center;
      padding: var(--space-2xl);
    }
    
    .article-error h2 {
      font-size: var(--font-size-xl);
      margin-bottom: var(--space-md);
      color: var(--text-primary);
    }
    
    .article-error p {
      color: var(--text-secondary);
      margin-bottom: var(--space-lg);
    }
  </style>
  
  <!-- Open Graph (updated by JS) -->
  <meta property="og:title" content="Ball603">
  <meta property="og:description" content="New Hampshire Basketball Coverage">
  <meta property="og:image" content="https://ball603.com/logo.png">
  <meta property="og:url" content="https://ball603.com">
  <meta property="og:type" content="article">
</head>
<body>
  <!-- Scores Ticker -->
  <div class="ticker" id="ticker">
    <div class="ticker-header">
      <span class="ticker-title">Scores</span>
      <button class="ticker-toggle" onclick="Ball603.toggleTicker()" title="Hide scores">‚úï</button>
    </div>
    <div class="ticker-scroll hide-scrollbar" id="tickerScroll">
      <div class="skeleton" style="width: 180px; height: 100px;"></div>
      <div class="skeleton" style="width: 180px; height: 100px;"></div>
      <div class="skeleton" style="width: 180px; height: 100px;"></div>
    </div>
  </div>
  <div class="ticker-expand" onclick="Ball603.toggleTicker()">
    <span>üìä Show Scores</span>
  </div>
  
  <!-- Desktop Header -->
  <header class="header-desktop">
    <a href="/">
      <img src="/logo.png" alt="Ball603" class="header-logo" onerror="this.outerHTML='<span class=\'header-logo-text\'><span class=\'ball\'>BALL</span>603</span>'">
    </a>
    <nav class="header-nav">
      <a href="/">Home</a>
      <a href="/schedule">Schedule</a>
      <a href="/standings">Standings</a>
      <a href="/galleries">Galleries</a>
      <a href="/teams.html">Teams</a>
      <a href="/boys">Boys ‚ñæ</a>
      <a href="/girls">Girls ‚ñæ</a>
      <a href="/college">College ‚ñæ</a>
    </nav>
    <div class="header-actions">
      <div class="header-search">
        <span>üîç</span>
        <input type="text" placeholder="Search..." id="searchInput">
      </div>
      <button class="btn btn-primary btn-pill" onclick="openMyTeams()">‚≠ê My Teams</button>
    </div>
  </header>
  
  <!-- Mobile Header -->
  <header class="header-mobile">
    <a href="/">
      <img src="/logo.png" alt="Ball603" class="header-logo" onerror="this.outerHTML='<span class=\'header-logo-text\'><span class=\'ball\'>BALL</span>603</span>'">
    </a>
    <div class="header-mobile-actions">
      <button onclick="openSearch()" title="Search">üîç</button>
      <button onclick="openMyTeams()" title="My Teams">‚≠ê</button>
    </div>
  </header>
  
  <!-- Article Container -->
  <article class="article-container" id="articleContainer">
    <!-- Loading State -->
    <div class="article-loading" id="articleLoading">
      <div class="skeleton" style="height: 30px; width: 100px;"></div>
      <div class="skeleton" style="height: 48px; width: 80%;"></div>
      <div class="skeleton" style="height: 20px; width: 200px;"></div>
      <div class="skeleton" style="height: 400px; width: 100%; border-radius: 12px;"></div>
      <div class="skeleton" style="height: 100px;"></div>
      <div class="skeleton" style="height: 200px;"></div>
    </div>
    
    <!-- Article Content (populated by JS) -->
    <div id="articleContent" style="display: none;"></div>
  </article>
  
  <!-- Bottom Navigation (Mobile) -->
  <nav class="bottom-nav">
    <div class="bottom-nav-items">
      <a href="/" class="bottom-nav-item">
        <span class="bottom-nav-icon">üè†</span>
        <span>Home</span>
      </a>
      <a href="/schedule" class="bottom-nav-item">
        <span class="bottom-nav-icon">üìÖ</span>
        <span>Schedule</span>
      </a>
      <a href="/galleries" class="bottom-nav-item">
        <span class="bottom-nav-icon">üì∏</span>
        <span>Galleries</span>
      </a>
      <a href="/my-teams" class="bottom-nav-item">
        <span class="bottom-nav-icon">‚≠ê</span>
        <span>My Teams</span>
      </a>
      <button class="bottom-nav-item" onclick="openMoreMenu()">
        <span class="bottom-nav-icon">‚ò∞</span>
        <span>More</span>
      </button>
    </div>
  </nav>
  
  <!-- Photo Gallery Overlay -->
  <div class="gallery-overlay" id="galleryOverlay">
    <div class="gallery-header">
      <button class="gallery-close" onclick="Ball603.closeGallery()">‚úï</button>
      <span class="gallery-title" id="galleryTitle"></span>
      <span class="gallery-count" id="galleryCount"></span>
    </div>
    <div class="gallery-main">
      <img src="" alt="" id="galleryImage">
      <div class="gallery-nav-arrows">
        <button class="gallery-arrow" onclick="Ball603.prevPhoto()">‚Äπ</button>
        <button class="gallery-arrow" onclick="Ball603.nextPhoto()">‚Ä∫</button>
      </div>
    </div>
    <div class="gallery-dots" id="galleryDots"></div>
    <div class="gallery-info">
      <p class="gallery-caption" id="galleryCaption"></p>
      <p class="gallery-credit" id="galleryCredit">üì∏ Ball603</p>
      <div class="gallery-actions">
        <button class="gallery-action-btn" onclick="downloadPhoto()">üíæ Save</button>
        <button class="gallery-action-btn" onclick="sharePhoto()">‚ÜóÔ∏è Share</button>
        <button class="gallery-action-btn" id="galleryFullLink">üñºÔ∏è Full Gallery</button>
      </div>
    </div>
  </div>
  
  <!-- App Script -->
  <script src="/app.js"></script>
  
  <!-- Article Page Script -->
  <script>
    // State
    let currentArticle = null;
    let linkedGame = null;
    let galleryPhotos = [];
    
    // Use Supabase client from app.js (will be initialized on ball603:ready)
    let supabaseClient = null;
    
    // Initialize on app ready
    document.addEventListener('ball603:ready', async () => {
      // Initialize Supabase client
      supabaseClient = window.supabase.createClient(
        'https://suncdkxfqkwwnmhosxcf.supabase.co',
        'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InN1bmNka3hmcWt3d25taG9zeGNmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUwNTk4MzIsImV4cCI6MjA4MDYzNTgzMn0.aT6V8Zx_YozqOh1ZnC6x-czI9vo-QhHKmP69PgY-8xw'
      );
      await loadArticle();
    });
    
    /**
     * Load article based on URL slug
     */
    async function loadArticle() {
      // Get slug from URL - supports /articles/slug and /articles/slug.html
      const pathParts = window.location.pathname.split('/');
      let slug = pathParts[pathParts.length - 1].replace('.html', '');
      
      // If path is /articles/, get next segment
      if (slug === 'articles' || slug === '') {
        slug = pathParts[pathParts.length - 2] || '';
      }
      
      if (!slug || slug === 'article') {
        showError('Article not found');
        return;
      }
      
      try {
        // Fetch article from Supabase
        const { data: article, error } = await supabaseClient
          .from('articles')
          .select('*')
          .eq('slug', slug)
          .single();
        
        if (error || !article) {
          showError('Article not found');
          return;
        }
        
        currentArticle = article;
        
        // Fetch linked game if exists
        if (article.game_id && Ball603.state.games) {
          linkedGame = Ball603.state.games.find(g => g.game_id === article.game_id);
        }
        
        // Update page metadata
        updateMetadata(article);
        
        // Render article
        renderArticle(article);
        
        // Load gallery photos
        await loadGalleryPhotos(article);
        
        // Load related articles
        await loadRelatedArticles(article);
        
      } catch (err) {
        console.error('Error loading article:', err);
        showError('Error loading article');
      }
    }
    
    /**
     * Update page metadata
     */
    function updateMetadata(article) {
      document.title = `${article.title} | Ball603`;
      
      const descMeta = document.querySelector('meta[name="description"]');
      if (descMeta) descMeta.content = article.excerpt || article.title;
      
      const ogTitle = document.querySelector('meta[property="og:title"]');
      if (ogTitle) ogTitle.content = article.title;
      
      const ogDesc = document.querySelector('meta[property="og:description"]');
      if (ogDesc) ogDesc.content = article.excerpt || article.title;
      
      if (article.featured_image_url) {
        const ogImage = document.querySelector('meta[property="og:image"]');
        if (ogImage) ogImage.content = article.featured_image_url;
      }
      
      const ogUrl = document.querySelector('meta[property="og:url"]');
      if (ogUrl) ogUrl.content = window.location.href;
    }
    
    /**
     * Render the article
     */
    function renderArticle(article) {
      const container = document.getElementById('articleContent');
      const loading = document.getElementById('articleLoading');
      
      // Build game box HTML if linked game exists
      let gameBoxHtml = '';
      if (linkedGame) {
        const awayScore = linkedGame.awayScore || linkedGame.away_score;
        const homeScore = linkedGame.homeScore || linkedGame.home_score;
        const hasScore = awayScore !== null && awayScore !== '' && homeScore !== null && homeScore !== '';
        const awayWins = hasScore && parseInt(awayScore) > parseInt(homeScore);
        const homeWins = hasScore && parseInt(homeScore) > parseInt(awayScore);
        
        // Build quarter scores section if game_data exists
        let quarterScoresSection = '';
        if (article.game_data && article.game_data.awayQuarters && article.game_data.homeQuarters) {
          const gd = article.game_data;
          const gdAwayWins = gd.awayFinal > gd.homeFinal;
          const gdHomeWins = gd.homeFinal > gd.awayFinal;
          
          // Build header row with quarters
          let headerCells = '<th>Team</th><th>Q1</th><th>Q2</th><th>Q3</th><th>Q4</th>';
          let awayCells = `<td>${gd.awayTeam}</td><td>${gd.awayQuarters[0] || '-'}</td><td>${gd.awayQuarters[1] || '-'}</td><td>${gd.awayQuarters[2] || '-'}</td><td>${gd.awayQuarters[3] || '-'}</td>`;
          let homeCells = `<td>${gd.homeTeam}</td><td>${gd.homeQuarters[0] || '-'}</td><td>${gd.homeQuarters[1] || '-'}</td><td>${gd.homeQuarters[2] || '-'}</td><td>${gd.homeQuarters[3] || '-'}</td>`;
          
          // Add OT columns if present
          for (let i = 4; i < gd.awayQuarters.length; i++) {
            const otNum = i - 3;
            const otLabel = gd.awayQuarters.length === 5 ? 'OT' : `OT${otNum}`;
            headerCells += `<th>${otLabel}</th>`;
            awayCells += `<td>${gd.awayQuarters[i] || '-'}</td>`;
            homeCells += `<td>${gd.homeQuarters[i] || '-'}</td>`;
          }
          
          // Add final column
          headerCells += '<th>Final</th>';
          awayCells += `<td class="${gdAwayWins ? 'winner-final' : ''}">${gd.awayFinal}</td>`;
          homeCells += `<td class="${gdHomeWins ? 'winner-final' : ''}">${gd.homeFinal}</td>`;
          
          quarterScoresSection = `
            <div class="quarter-scores-section">
              <table class="quarter-scores-table">
                <thead>
                  <tr>${headerCells}</tr>
                </thead>
                <tbody>
                  <tr>${awayCells}</tr>
                  <tr>${homeCells}</tr>
                </tbody>
              </table>
            </div>
          `;
        }
        
        gameBoxHtml = `
          <div class="game-box">
            <div class="game-box-header">${Ball603.formatDivision(linkedGame)}</div>
            <div class="game-matchup">
              <div class="game-team">
                <img class="game-team-logo" src="${Ball603.getLogoUrl(linkedGame.away)}" alt="${linkedGame.away}" onerror="this.src='/logos/100px/Ball603-white.png'">
                <div class="game-team-name">${linkedGame.away}</div>
              </div>
              <div class="game-score-center">
                <div class="game-scores">
                  <span class="game-score ${awayWins ? 'winner' : ''}">${awayScore || '-'}</span>
                  <span class="game-score-dash">-</span>
                  <span class="game-score ${homeWins ? 'winner' : ''}">${homeScore || '-'}</span>
                </div>
                ${hasScore ? '<div class="game-status">Final</div>' : ''}
              </div>
              <div class="game-team">
                <img class="game-team-logo" src="${Ball603.getLogoUrl(linkedGame.home)}" alt="${linkedGame.home}" onerror="this.src='/logos/100px/Ball603-white.png'">
                <div class="game-team-name">${linkedGame.home}</div>
              </div>
            </div>
            ${quarterScoresSection}
            <div class="game-details">
              <div class="game-detail">üìÖ ${Ball603.formatDate(linkedGame.date, 'medium')}</div>
              ${linkedGame.location ? `<div class="game-detail">üìç ${linkedGame.location}</div>` : ''}
            </div>
          </div>
        `;
      }
      
      // Build quarter scores box HTML if game_data exists but no linked game
      let quarterScoresHtml = '';
      if (!linkedGame && article.game_data && article.game_data.awayQuarters && article.game_data.homeQuarters) {
        const gd = article.game_data;
        const awayWins = gd.awayFinal > gd.homeFinal;
        const homeWins = gd.homeFinal > gd.awayFinal;
        
        // Build header row with quarters
        let headerCells = '<th>Team</th><th>Q1</th><th>Q2</th><th>Q3</th><th>Q4</th>';
        let awayCells = `<td>${gd.awayTeam}</td><td>${gd.awayQuarters[0] || '-'}</td><td>${gd.awayQuarters[1] || '-'}</td><td>${gd.awayQuarters[2] || '-'}</td><td>${gd.awayQuarters[3] || '-'}</td>`;
        let homeCells = `<td>${gd.homeTeam}</td><td>${gd.homeQuarters[0] || '-'}</td><td>${gd.homeQuarters[1] || '-'}</td><td>${gd.homeQuarters[2] || '-'}</td><td>${gd.homeQuarters[3] || '-'}</td>`;
        
        // Add OT columns if present
        for (let i = 4; i < gd.awayQuarters.length; i++) {
          const otNum = i - 3;
          const otLabel = gd.awayQuarters.length === 5 ? 'OT' : `OT${otNum}`;
          headerCells += `<th>${otLabel}</th>`;
          awayCells += `<td>${gd.awayQuarters[i] || '-'}</td>`;
          homeCells += `<td>${gd.homeQuarters[i] || '-'}</td>`;
        }
        
        // Add final column
        headerCells += '<th>Final</th>';
        awayCells += `<td class="${awayWins ? 'winner-final' : ''}">${gd.awayFinal}</td>`;
        homeCells += `<td class="${homeWins ? 'winner-final' : ''}">${gd.homeFinal}</td>`;
        
        quarterScoresHtml = `
          <div class="quarter-scores-box">
            <table class="quarter-scores-table">
              <thead>
                <tr>${headerCells}</tr>
              </thead>
              <tbody>
                <tr>${awayCells}</tr>
                <tr>${homeCells}</tr>
              </tbody>
            </table>
          </div>
        `;
      }
      
      // Build tags HTML
      let tagsHtml = '';
      if (article.tags && article.tags.length > 0) {
        tagsHtml = `
          <div class="article-tags">
            ${article.tags.map(tag => `<a href="/tag/${encodeURIComponent(tag.toLowerCase())}" class="tag">${tag}</a>`).join('')}
          </div>
        `;
      }
      
      // Get primary tag
      const primaryTag = article.tags && article.tags.length > 0 ? article.tags[0] : 'Coverage';
      
      // Featured media (video or image)
      let featuredHtml = '';
      if (article.youtube_url) {
        const videoId = extractYouTubeId(article.youtube_url);
        if (videoId) {
          featuredHtml = `
            <div class="article-featured">
              <iframe 
                src="https://www.youtube.com/embed/${videoId}" 
                allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
                allowfullscreen>
              </iframe>
            </div>
          `;
        }
      } else if (article.featured_image_url) {
        featuredHtml = `
          <div class="article-featured">
            <img src="${article.featured_image_url}" alt="${article.title}">
            ${article.featured_image_caption ? `<div class="featured-caption">${article.featured_image_caption}</div>` : ''}
          </div>
        `;
      }
      
      // Render article
      container.innerHTML = `
        <header class="article-header">
          <span class="article-tag">${primaryTag}</span>
          <h1 class="article-title">${article.title}</h1>
          <div class="article-meta">
            <span class="article-author">${article.author || 'Ball603'}</span>
            <span class="article-date">${Ball603.formatDate(article.article_date || article.published_at?.split('T')[0], 'long')}</span>
            <div class="article-share">
              <button class="share-btn" onclick="shareTwitter()" title="Share on Twitter">ùïè</button>
              <button class="share-btn" onclick="shareFacebook()" title="Share on Facebook">f</button>
              <button class="share-btn" onclick="copyLink()" title="Copy link">üîó</button>
            </div>
          </div>
        </header>
        
        ${featuredHtml}
        ${gameBoxHtml}
        ${quarterScoresHtml}
        
        <div class="article-content">
          ${article.content || '<p>No content available.</p>'}
        </div>
        
        ${tagsHtml}
        
        <section class="gallery-section" id="gallerySection" style="display: none;">
          <div class="gallery-header">
            <div>
              <h2 class="gallery-title">üì∏ Photo Gallery</h2>
            </div>
            <a href="#" target="_blank" class="gallery-link" id="smugmugLink">View on SmugMug ‚Üí</a>
          </div>
          <div class="smugmug-embed" id="smugmugEmbed"></div>
        </section>
        
        <section class="related-section" id="relatedSection" style="display: none;">
          <h2 class="related-title">More Stories</h2>
          <div class="related-grid" id="relatedGrid"></div>
        </section>
      `;
      
      loading.style.display = 'none';
      container.style.display = 'block';
    }
    
    /**
     * Load gallery from SmugMug - embed iframe
     */
    async function loadGalleryPhotos(article) {
      if (!article.smugmug_gallery_url) return;
      
      document.getElementById('gallerySection').style.display = 'block';
      document.getElementById('smugmugLink').href = article.smugmug_gallery_url;
      
      // Convert SmugMug gallery URL to embed URL
      // SmugMug URLs look like: https://ball603.smugmug.com/2024-25/Gallery-Name
      // Embed URL adds /frame/slideshow at the end
      let embedUrl = article.smugmug_gallery_url;
      if (!embedUrl.includes('/frame/')) {
        // Remove trailing slash if present, then add embed path
        embedUrl = embedUrl.replace(/\/$/, '') + '/frame/slideshow?speed=3&transition=fade&autoStart=0&captions=1&navigation=1&playButton=1&randomize=0&transitionSpeed=2';
      }
      
      const embedContainer = document.getElementById('smugmugEmbed');
      embedContainer.innerHTML = `
        <iframe 
          src="${embedUrl}" 
          width="100%" 
          height="600" 
          frameborder="0" 
          allowfullscreen
          style="border-radius: var(--radius-lg); background: var(--bg-tertiary);">
        </iframe>
      `;
    }
    
    /**
     * Load related articles
     */
    async function loadRelatedArticles(article) {
      const related = (Ball603.state.articles || [])
        .filter(a => a.id !== article.id && a.status === 'published')
        .slice(0, 4);
      
      if (related.length === 0) return;
      
      document.getElementById('relatedSection').style.display = 'block';
      
      document.getElementById('relatedGrid').innerHTML = related.map(a => `
        <a href="/articles/${a.slug}" class="related-card">
          <img src="${a.featured_image_url || '/logo.png'}" alt="" class="related-card-image" loading="lazy">
          <div class="related-card-content">
            <h3 class="related-card-title">${a.title}</h3>
            <p class="related-card-meta">${Ball603.formatDate(a.published_at?.split('T')[0], 'short')}</p>
          </div>
        </a>
      `).join('');
    }
    
    /**
     * Show error state
     */
    function showError(message) {
      document.getElementById('articleContainer').innerHTML = `
        <div class="article-error">
          <h2>üòï ${message}</h2>
          <p>The article you're looking for might have been moved or doesn't exist.</p>
          <a href="/" class="btn btn-primary">‚Üê Back to Home</a>
        </div>
      `;
    }
    
    /**
     * Extract YouTube video ID
     */
    function extractYouTubeId(url) {
      if (!url) return null;
      const match = url.match(/(?:youtube\.com\/(?:watch\?v=|embed\/)|youtu\.be\/)([a-zA-Z0-9_-]{11})/);
      return match ? match[1] : null;
    }
    
    /**
     * Gallery functions
     */
    function openGalleryAt(index) {
      if (galleryPhotos.length === 0) return;
      Ball603.openGallery(galleryPhotos, index, currentArticle?.title || 'Gallery');
    }
    
    function openFullGallery() {
      if (galleryPhotos.length > 0) {
        Ball603.openGallery(galleryPhotos, 0, currentArticle?.title || 'Gallery');
      } else if (currentArticle?.smugmug_gallery_url) {
        window.open(currentArticle.smugmug_gallery_url, '_blank');
      }
    }
    
    /**
     * Share functions
     */
    function shareTwitter() {
      const url = encodeURIComponent(window.location.href);
      const text = encodeURIComponent(currentArticle?.title || 'Ball603');
      window.open(`https://twitter.com/intent/tweet?url=${url}&text=${text}`, '_blank', 'width=550,height=420');
    }
    
    function shareFacebook() {
      const url = encodeURIComponent(window.location.href);
      window.open(`https://www.facebook.com/sharer/sharer.php?u=${url}`, '_blank', 'width=550,height=420');
    }
    
    function copyLink() {
      navigator.clipboard.writeText(window.location.href).then(() => {
        Ball603.showToast('Link copied!', 'success');
      }).catch(() => {
        Ball603.showToast('Failed to copy link', 'error');
      });
    }
    
    function downloadPhoto() {
      Ball603.showToast('Download coming soon!');
    }
    
    function sharePhoto() {
      if (navigator.share) {
        navigator.share({ title: currentArticle?.title || 'Ball603', url: window.location.href });
      } else {
        copyLink();
      }
    }
    
    function openSearch() { Ball603.showToast('Search coming soon!'); }
    function openMyTeams() { Ball603.showToast('My Teams coming soon!'); }
    function openMoreMenu() { Ball603.showToast('More menu coming soon!'); }
  </script>
</body>
</html>
