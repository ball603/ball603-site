<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ball603 Contributor Portal</title>
  <!-- Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-S4BN80729K"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-S4BN80729K');
  </script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.css" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.js"></script>
  <link href="contributor-schedule.css" rel="stylesheet">
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f5f5f5; color: #333; min-height: 100vh; }
    
    /* Login Screen */
    .login-screen { display: flex; justify-content: center; align-items: center; min-height: 100vh; padding: 20px; }
    .login-box { background: #fff; padding: 40px; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); text-align: center; max-width: 400px; width: 100%; }
    .login-box img { height: 80px; margin-bottom: 20px; cursor: pointer; }
    .login-box h2 { margin-bottom: 10px; color: #333; font-size: 20px; }
    .login-box p { color: #666; margin-bottom: 25px; font-size: 14px; }
    .login-box input { width: 100%; padding: 12px 15px; border: 1px solid #ddd; border-radius: 5px; font-size: 14px; margin-bottom: 15px; }
    .login-box input:focus { outline: none; border-color: #f57c00; }
    .login-box button { width: 100%; padding: 12px; background: #f57c00; color: #fff; border: none; border-radius: 5px; font-size: 14px; font-weight: 600; cursor: pointer; }
    .login-box button:hover { background: #e56a00; }
    .login-error { color: #c00; font-size: 13px; margin-bottom: 15px; min-height: 20px; }
    .login-success { color: #4CAF50; font-size: 13px; margin-bottom: 15px; }
    .login-link { margin-top: 15px; font-size: 13px; color: #666; }
    .login-link a { color: #f57c00; cursor: pointer; }
    .login-link a:hover { text-decoration: underline; }
    
    /* Header */
    .header { background: #fff; padding: 12px 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
    .header-inner { max-width: 1200px; margin: 0 auto; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px; }
    .header-left { display: flex; align-items: center; gap: 12px; }
    .header-left img { height: 45px; cursor: pointer; }
    .header-nav { display: flex; align-items: center; gap: 8px; flex-wrap: wrap; }
    .nav-link { display: flex; align-items: center; gap: 5px; padding: 8px 14px; border-radius: 6px; text-decoration: none; font-size: 13px; color: #555; background: #f5f5f5; transition: all 0.2s; cursor: pointer; border: none; font-family: inherit; }
    .nav-link:hover { background: #e8e8e8; color: #333; }
    .nav-link.active { background: #f57c00; color: #fff; }
    .nav-link .nav-icon { font-size: 16px; }
    .header-right { display: flex; align-items: center; gap: 12px; }
    .user-name { font-size: 13px; color: #666; }
    .btn-logout { background: #eee; border: none; padding: 8px 14px; border-radius: 5px; cursor: pointer; font-size: 13px; }
    .btn-logout:hover { background: #ddd; }
    
    /* Main Container */
    .main-container { max-width: 1200px; margin: 0 auto; padding: 20px; display: none; }
    
    /* Views */
    .view { display: none; }
    .view.active { display: block; }
    
    /* Dashboard Styles */
    .dashboard-welcome { margin-bottom: 25px; }
    .dashboard-welcome h1 { font-size: 24px; color: #333; margin-bottom: 5px; }
    .dashboard-welcome p { color: #666; font-size: 14px; }
    
    .dashboard-grid { display: grid; grid-template-columns: 1fr; gap: 25px; }
    
    /* Section Card */
    .section-card { background: #fff; border-radius: 12px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.06); }
    .section-card h2 { font-size: 16px; color: #333; margin-bottom: 15px; display: flex; align-items: center; gap: 8px; }
    .section-card h2 .section-icon { font-size: 20px; }
    
    /* Calendar Cards for Upcoming */
    .upcoming-cards { display: flex; gap: 15px; overflow-x: auto; padding: 5px 0; }
    .calendar-card { flex: 0 0 170px; background: #fff; border-radius: 12px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.1); cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; display: flex; flex-direction: column; }
    .calendar-card:hover { transform: translateY(-3px); box-shadow: 0 4px 15px rgba(0,0,0,0.15); }
    .calendar-header { background: #f57c00; color: #fff; text-align: center; padding: 10px 10px; font-size: 14px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; }
    .calendar-body { text-align: center; padding: 15px 10px; background: #fff; }
    .calendar-day { font-size: 48px; font-weight: 700; color: #555; line-height: 1; margin-bottom: 5px; }
    .calendar-footer { background: #f5f5f5; padding: 12px 10px; text-align: center; flex: 1; display: flex; flex-direction: column; justify-content: center; }
    .calendar-away { font-size: 12px; font-weight: 600; color: #333; line-height: 1.3; }
    .calendar-home { font-size: 12px; font-weight: 600; color: #333; line-height: 1.3; }
    .calendar-meta { font-size: 10px; color: #888; margin-top: 4px; }
    
    .empty-state { text-align: center; padding: 30px; color: #888; }
    .empty-state .empty-icon { font-size: 40px; margin-bottom: 10px; opacity: 0.5; }
    
    /* Recent Coverage Grid */
    .recent-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 15px; }
    .recent-card { background: #f9f9f9; border-radius: 8px; overflow: hidden; transition: transform 0.2s, box-shadow 0.2s; cursor: pointer; text-decoration: none; color: inherit; }
    .recent-card:hover { transform: translateY(-3px); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
    .recent-thumb { width: 100%; aspect-ratio: 16/9; background: #e0e0e0; display: flex; align-items: center; justify-content: center; overflow: hidden; }
    .recent-thumb img { width: 100%; height: 100%; object-fit: cover; }
    .recent-thumb .thumb-placeholder { font-size: 30px; opacity: 0.3; }
    .recent-info { padding: 12px; }
    .recent-teams { font-weight: 600; font-size: 13px; color: #333; margin-bottom: 4px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .recent-date { font-size: 11px; color: #888; }
    .recent-badges { display: flex; gap: 6px; margin-top: 8px; }
    .recent-badge { font-size: 14px; }
    
    /* Profile Section Styles */
    .section { background: #fff; border-radius: 10px; padding: 25px; margin-bottom: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
    .section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 10px; border-bottom: 2px solid #f57c00; }
    .section-header h2 { font-size: 16px; color: #333; margin: 0; }
    .section h3 { font-size: 14px; color: #555; margin: 20px 0 12px 0; }
    .btn-save-inline { background: #f57c00; color: white; border: none; padding: 8px 20px; border-radius: 5px; font-size: 13px; font-weight: 600; cursor: pointer; }
    .btn-save-inline:hover { background: #e56a00; }
    
    /* Form Grid */
    .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 15px; }
    .form-row.three { grid-template-columns: 1fr 1fr 1fr; }
    .form-row.single { grid-template-columns: 1fr; }
    @media (max-width: 600px) {
      .form-row, .form-row.three { grid-template-columns: 1fr; }
      .header-nav { width: 100%; justify-content: center; }
      .upcoming-cards { flex-wrap: nowrap; }
    }
    
    .form-group { display: flex; flex-direction: column; gap: 6px; }
    .form-group label { font-size: 12px; font-weight: 600; color: #555; }
    .form-group input, .form-group select, .form-group textarea { padding: 10px 12px; border: 1px solid #ddd; border-radius: 5px; font-size: 14px; font-family: inherit; }
    .form-group input:focus, .form-group select:focus, .form-group textarea:focus { outline: none; border-color: #f57c00; }
    .form-group textarea { resize: vertical; min-height: 80px; }
    .form-group small { font-size: 11px; color: #999; }
    .form-group .char-count { text-align: right; font-size: 11px; color: #999; }
    .form-group .char-count.over { color: #c00; }
    
    /* Checkboxes & Radio */
    .checkbox-group { display: flex; flex-wrap: wrap; gap: 15px; }
    .checkbox-item { display: flex; align-items: center; gap: 8px; cursor: pointer; }
    .checkbox-item input { width: auto; margin: 0; }
    .radio-group { display: flex; flex-wrap: wrap; gap: 15px; }
    .radio-item { display: flex; align-items: center; gap: 6px; cursor: pointer; font-size: 14px; }
    .radio-item input { width: auto; margin: 0; }
    
    /* Image Upload */
    .image-upload-area { display: flex; gap: 20px; align-items: flex-start; flex-wrap: wrap; }
    .image-preview { width: 120px; height: 120px; border: 2px dashed #ddd; border-radius: 8px; display: flex; align-items: center; justify-content: center; overflow: hidden; cursor: pointer; background: #fafafa; transition: all 0.2s; }
    .image-preview:hover { border-color: #f57c00; background: #fff8f0; }
    .image-preview.has-image { border-style: solid; }
    .image-preview img { max-width: 100%; max-height: 100%; object-fit: contain; }
    .image-preview .placeholder { text-align: center; color: #999; font-size: 11px; padding: 10px; }
    .image-upload-info { flex: 1; min-width: 200px; }
    .image-upload-info p { font-size: 12px; color: #666; margin-bottom: 8px; }
    .btn-remove-image { background: #ffebee; color: #c62828; border: none; padding: 6px 12px; border-radius: 4px; font-size: 12px; cursor: pointer; margin-top: 8px; }
    .btn-remove-image:hover { background: #ffcdd2; }
    
    /* Portfolio */
    .portfolio-list { display: flex; flex-direction: column; gap: 10px; max-height: none; }
    .portfolio-list.collapsed { max-height: 320px; overflow: hidden; }
    .portfolio-item { display: flex; align-items: center; gap: 12px; padding: 12px; background: #f9f9f9; border-radius: 6px; }
    .portfolio-item.auto { background: #e3f2fd; }
    .portfolio-icon { font-size: 20px; }
    .portfolio-info { flex: 1; min-width: 0; }
    .portfolio-title { font-weight: 500; font-size: 14px; }
    .portfolio-url { font-size: 12px; color: #666; word-break: break-all; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .portfolio-type { font-size: 11px; color: #888; background: #eee; padding: 2px 8px; border-radius: 10px; }
    .portfolio-type.auto { background: #bbdefb; color: #1565c0; }
    .btn-remove-portfolio { background: none; border: none; color: #999; cursor: pointer; font-size: 16px; padding: 5px; }
    .btn-remove-portfolio:hover { color: #c00; }
    .btn-show-more { width: 100%; padding: 10px; background: #f0f0f0; border: none; border-radius: 6px; cursor: pointer; font-size: 13px; color: #666; margin-top: 10px; }
    .btn-show-more:hover { background: #e8e8e8; }
    
    .add-portfolio { margin-top: 15px; padding: 15px; background: #f5f5f5; border-radius: 8px; }
    .add-portfolio h4 { font-size: 13px; margin-bottom: 12px; color: #555; }
    .add-portfolio-row { display: flex; gap: 10px; flex-wrap: wrap; }
    .add-portfolio-row input, .add-portfolio-row select { flex: 1; min-width: 150px; }
    .btn-add-portfolio { background: #f57c00; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-size: 13px; white-space: nowrap; }
    .btn-add-portfolio:hover { background: #e56a00; }
    
    /* Toast */
    .toast { position: fixed; bottom: 20px; right: 20px; padding: 15px 25px; border-radius: 8px; color: white; font-size: 14px; z-index: 9999; animation: slideIn 0.3s ease; }
    .toast.success { background: #4CAF50; }
    .toast.error { background: #f44336; }
    @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
    
    /* Modal */
    .modal-overlay { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 1000; justify-content: center; align-items: center; }
    .modal-overlay.open { display: flex; }
    .modal { background: #fff; border-radius: 10px; max-width: 600px; width: 90%; max-height: 90vh; overflow: hidden; }
    .modal-header { padding: 15px 20px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
    .modal-header h3 { font-size: 16px; }
    .modal-close { background: none; border: none; font-size: 24px; cursor: pointer; color: #999; }
    .modal-body { padding: 20px; }
    .modal-footer { padding: 15px 20px; border-top: 1px solid #eee; display: flex; justify-content: flex-end; gap: 10px; }
    .cropper-container-wrapper { max-height: 400px; overflow: hidden; }
    .cropper-container-wrapper img { max-width: 100%; display: block; }
    .btn-modal { padding: 10px 20px; border-radius: 5px; font-size: 14px; cursor: pointer; }
    .btn-modal-cancel { background: #eee; border: none; color: #333; }
    .btn-modal-save { background: #f57c00; border: none; color: white; }
    
    /* Loading */
    .loading { text-align: center; padding: 40px; color: #666; }
    .loading-spinner { display: inline-block; width: 20px; height: 20px; border: 2px solid #f3f3f3; border-top: 2px solid #f57c00; border-radius: 50%; animation: spin 1s linear infinite; margin-right: 10px; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
  </style>
</head>
<body>
  <!-- Login Screen -->
  <div id="loginScreen" class="login-screen">
    <div class="login-box">
      <img src="/logo.png" alt="Ball603" onclick="window.location.href='https://ball603.com'">
      <h2>Contributor Portal</h2>
      <p id="loginSubtitle">Sign in to manage your profile</p>
      
      <div id="loginError" class="login-error"></div>
      
      <div id="loginForm">
        <input type="email" id="loginEmail" placeholder="Email address">
        <input type="password" id="loginPassword" placeholder="Password">
        <button onclick="handleLogin()">Sign In</button>
        <div class="login-link">
          <a onclick="showForgotPassword()">Forgot password?</a>
        </div>
      </div>
      
      <div id="forgotForm" style="display: none;">
        <input type="email" id="resetEmail" placeholder="Email address">
        <button onclick="handleResetPassword()">Send Reset Link</button>
        <div class="login-link">
          <a onclick="showLogin()">Back to login</a>
        </div>
      </div>
      
      <div id="setPasswordForm" style="display: none;">
        <input type="password" id="newPassword" placeholder="Create password (min 6 characters)">
        <input type="password" id="confirmPassword" placeholder="Confirm password">
        <button onclick="handleSetPassword()">Set Password</button>
      </div>
    </div>
  </div>
  
  <!-- Header -->
  <div class="header" id="mainHeader" style="display: none;">
    <div class="header-inner">
      <div class="header-left">
        <img src="/logo.png" alt="Ball603" onclick="window.location.href='https://ball603.com'">
      </div>
      <nav class="header-nav">
        <button class="nav-link active" id="navDashboard" onclick="showView('dashboard')">
          <span class="nav-icon">üè†</span> Dashboard
        </button>
        <button class="nav-link" id="navSchedule" onclick="showView('schedule')">
          <span class="nav-icon">üìÖ</span> Manage Schedule
        </button>
        <button class="nav-link" onclick="openTop10Upload()">
          <span class="nav-icon">üîü</span> Upload Top-10
        </button>
        <button class="nav-link" onclick="window.open('https://www.smugmug.com/upload/options', 'smugmugUpload', 'width=1200,height=800,scrollbars=yes,resizable=yes')">
          <span class="nav-icon">üì∏</span> Upload Full Gallery
        </button>
        <button class="nav-link" id="navProfile" onclick="showView('profile')">
          <span class="nav-icon">üë§</span> Edit Profile
        </button>
      </nav>
      <div class="header-right">
        <span class="user-name" id="userName"></span>
        <button class="btn-logout" onclick="handleLogout()">Log Out</button>
      </div>
    </div>
  </div>
  
  <!-- Main Content -->
  <div class="main-container" id="mainContent">
    
    <!-- Dashboard View -->
    <div class="view active" id="dashboardView">
      <div class="dashboard-welcome">
        <h1>Welcome back, <span id="welcomeName"></span>!</h1>
        <p>Here's your coverage overview</p>
      </div>
      
      <div class="dashboard-grid">
        <!-- Upcoming Coverage -->
        <div class="section-card">
          <h2><span class="section-icon">üìÖ</span> Your Upcoming Coverage</h2>
          <div class="upcoming-cards" id="upcomingCards">
            <div class="loading"><span class="loading-spinner"></span> Loading...</div>
          </div>
        </div>
        
        <!-- Recent Coverage -->
        <div class="section-card">
          <h2><span class="section-icon">üì∏</span> Your Recent Coverage</h2>
          <div class="recent-grid" id="recentGrid">
            <div class="loading"><span class="loading-spinner"></span> Loading...</div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Schedule View - Powered by contributor-schedule.js -->
    <div class="view" id="scheduleView">
      <div class="section-card">
        <h2><span class="section-icon">üìÖ</span> Contributor Coverage Schedule</h2>
        <div id="scheduleContainer"></div>
      </div>
    </div>
    
    <!-- Profile View -->
    <div class="view" id="profileView">
      <div class="section">
        <div class="section-header">
          <h2>üë§ Personal Information</h2>
          <button class="btn-save-inline" onclick="saveProfile()">Save Changes</button>
        </div>
        
        <div class="form-row">
          <div class="form-group">
            <label>Full Name *</label>
            <input type="text" id="profileName" placeholder="Your name">
          </div>
          <div class="form-group">
            <label>Email Address *</label>
            <input type="email" id="profileEmail" placeholder="email@example.com" readonly style="background: #f5f5f5;">
          </div>
        </div>
        
        <div class="form-row">
          <div class="form-group">
            <label>Primary School/Area</label>
            <input type="text" id="profileArea" placeholder="e.g., Manchester area, Plymouth State">
          </div>
          <div class="form-group">
            <label>Cell Phone</label>
            <input type="tel" id="profileCell" placeholder="(603) 555-1234">
          </div>
        </div>
        
        <div class="form-row single">
          <div class="form-group">
            <label>Mailing Address</label>
            <input type="text" id="profileAddress" placeholder="Street, City, State ZIP">
          </div>
        </div>
        
        <div class="form-row three">
          <div class="form-group">
            <label>Venmo Handle</label>
            <input type="text" id="profileVenmo" placeholder="@username">
          </div>
          <div class="form-group">
            <label>Shirt Size</label>
            <select id="profileShirtSize">
              <option value="">Select...</option>
              <option value="XS">XS</option>
              <option value="S">S</option>
              <option value="M">M</option>
              <option value="L">L</option>
              <option value="XL">XL</option>
              <option value="2XL">2XL</option>
              <option value="3XL">3XL</option>
            </select>
          </div>
          <div class="form-group">
            <label>NHIAA Alma Mater (if applicable)</label>
            <select id="profileAlmaMater">
              <option value="">Select school...</option>
            </select>
          </div>
        </div>
        
        <div class="form-row">
          <div class="form-group">
            <label>College (if applicable)</label>
            <input type="text" id="profileCollege" placeholder="College/University attended">
          </div>
        </div>
        
        <h3>Contributor Type (select all that apply)</h3>
        <div class="checkbox-group">
          <label class="checkbox-item">
            <input type="checkbox" id="typePhotographer"> üì∏ Photographer
          </label>
          <label class="checkbox-item">
            <input type="checkbox" id="typeVideographer"> üé• Videographer
          </label>
          <label class="checkbox-item">
            <input type="checkbox" id="typeWriter"> üìù Reporter/Writer
          </label>
          <label class="checkbox-item">
            <input type="checkbox" id="typeGraphics"> üé® Graphics
          </label>
        </div>
      </div>
      
      <div class="section">
        <div class="section-header">
          <h2>üîó Links & Social Media</h2>
          <button class="btn-save-inline" onclick="saveProfile()">Save Changes</button>
        </div>
        
        <div class="form-row">
          <div class="form-group">
            <label>Website</label>
            <input type="url" id="profileWebsite" placeholder="https://yourwebsite.com">
          </div>
          <div class="form-group">
            <label>Instagram</label>
            <input type="text" id="profileInstagram" placeholder="@username or full URL">
          </div>
        </div>
        
        <div class="form-row">
          <div class="form-group">
            <label>Facebook</label>
            <input type="text" id="profileFacebook" placeholder="Profile or page URL">
          </div>
          <div class="form-group">
            <label>Twitter/X</label>
            <input type="text" id="profileTwitter" placeholder="@username or full URL">
          </div>
        </div>
      </div>
      
      <div class="section">
        <div class="section-header">
          <h2>üì∑ Equipment & Preferences</h2>
          <button class="btn-save-inline" onclick="saveProfile()">Save Changes</button>
        </div>
        
        <div class="form-row">
          <div class="form-group">
            <label>Camera Brand</label>
            <div class="radio-group">
              <label class="radio-item"><input type="radio" name="cameraBrand" value="Canon"> Canon</label>
              <label class="radio-item"><input type="radio" name="cameraBrand" value="Nikon"> Nikon</label>
              <label class="radio-item"><input type="radio" name="cameraBrand" value="Sony"> Sony</label>
              <label class="radio-item"><input type="radio" name="cameraBrand" value="Other"> Other</label>
            </div>
            <input type="text" id="cameraBrandOther" placeholder="Specify brand..." style="display: none; margin-top: 8px;">
          </div>
          <div class="form-group">
            <label>Computer Preference</label>
            <div class="radio-group">
              <label class="radio-item"><input type="radio" name="computerPref" value="Mac"> Mac</label>
              <label class="radio-item"><input type="radio" name="computerPref" value="PC"> PC</label>
              <label class="radio-item"><input type="radio" name="computerPref" value="Other"> Other</label>
            </div>
            <input type="text" id="computerPrefOther" placeholder="Specify..." style="display: none; margin-top: 8px;">
          </div>
        </div>
      </div>
      
      <div class="section">
        <div class="section-header">
          <h2>üìù About You</h2>
          <button class="btn-save-inline" onclick="saveProfile()">Save Changes</button>
        </div>
        
        <div class="form-group">
          <label>Brief Bio</label>
          <textarea id="profileBio" placeholder="Tell us why you're a Ball603 contributor..." oninput="updateCharCount()"></textarea>
          <div class="char-count" id="bioCharCount">0 / 100 words</div>
          <small>This may appear on your public contributor page.</small>
        </div>
      </div>
      
      <div class="section">
        <div class="section-header">
          <h2>üñºÔ∏è Images & Branding</h2>
          <button class="btn-save-inline" onclick="saveProfile()">Save Changes</button>
        </div>
        
        <h3>Headshot</h3>
        <div class="image-upload-area">
          <div class="image-preview" id="headshotPreview" onclick="triggerUpload('headshot')">
            <div class="placeholder">Click to upload</div>
          </div>
          <input type="file" id="headshotInput" accept="image/*" style="display: none;" onchange="handleImageSelect(event, 'headshot')">
          <input type="hidden" id="headshotUrl">
          <div class="image-upload-info">
            <p>Square photo (1:1 ratio) recommended</p>
            <p>Max file size: 2MB</p>
            <button class="btn-remove-image" id="headshotRemove" style="display: none;" onclick="removeImage('headshot')">Remove</button>
          </div>
        </div>
        
        <h3>Photography Watermark</h3>
        <div class="image-upload-area">
          <div class="image-preview" id="watermarkPreview" onclick="triggerUpload('watermark')" style="width: 200px;">
            <div class="placeholder">Click to upload</div>
          </div>
          <input type="file" id="watermarkInput" accept="image/*" style="display: none;" onchange="handleImageSelect(event, 'watermark')">
          <input type="hidden" id="watermarkUrl">
          <div class="image-upload-info">
            <p>Upload at 100% opacity</p>
            <p>Max file size: 2MB</p>
            <button class="btn-remove-image" id="watermarkRemove" style="display: none;" onclick="removeImage('watermark')">Remove</button>
          </div>
        </div>
        
        <h3>Photography Logo</h3>
        <div class="image-upload-area">
          <div class="image-preview" id="logoPreview" onclick="triggerUpload('logo')">
            <div class="placeholder">Click to upload</div>
          </div>
          <input type="file" id="logoInput" accept="image/*" style="display: none;" onchange="handleImageSelect(event, 'logo')">
          <input type="hidden" id="logoUrl">
          <div class="image-upload-info">
            <p>Your business logo</p>
            <p>Max file size: 2MB</p>
            <button class="btn-remove-image" id="logoRemove" style="display: none;" onclick="removeImage('logo')">Remove</button>
          </div>
        </div>
      </div>
      
      <div class="section">
        <div class="section-header">
          <h2>üîó Portfolio & Sample Work</h2>
          <button class="btn-save-inline" onclick="saveProfile()">Save Changes</button>
        </div>
        <p style="font-size: 13px; color: #666; margin-bottom: 15px;">SmugMug galleries from your coverage will appear automatically. Add additional links below.</p>
        
        <div class="portfolio-list collapsed" id="portfolioList">
          <div class="loading">Loading portfolio...</div>
        </div>
        <button class="btn-show-more" id="btnShowMore" style="display: none;" onclick="togglePortfolioExpand()">Show all galleries</button>
        
        <div class="add-portfolio">
          <h4>Add New Link</h4>
          <div class="add-portfolio-row">
            <input type="text" id="newPortfolioTitle" placeholder="Title (e.g., My Photo Website)">
            <input type="url" id="newPortfolioUrl" placeholder="https://...">
            <select id="newPortfolioType">
              <option value="website">Website</option>
              <option value="instagram">Instagram</option>
              <option value="youtube">YouTube</option>
              <option value="other">Other</option>
            </select>
            <button class="btn-add-portfolio" onclick="addPortfolioLink()">Add Link</button>
          </div>
        </div>
      </div>
      
      <div class="section">
        <div class="section-header">
          <h2>&#128274; Change Password</h2>
        </div>
        
        <div class="form-row">
          <div class="form-group">
            <label>New Password</label>
            <input type="password" id="changeNewPassword" placeholder="Enter new password">
          </div>
          <div class="form-group">
            <label>Confirm New Password</label>
            <input type="password" id="changeConfirmPassword" placeholder="Confirm new password">
          </div>
        </div>
        <p style="font-size: 12px; color: #666; margin-bottom: 15px;">Password must be at least 6 characters.</p>
        <button class="btn-save-inline" onclick="changePassword()">Update Password</button>
        <span id="passwordChangeStatus" style="margin-left: 10px; font-size: 13px;"></span>
      </div>
    </div>
  </div>
  <div class="modal-overlay" id="cropperModal">
    <div class="modal">
      <div class="modal-header">
        <h3>Crop Image</h3>
        <button class="modal-close" onclick="closeCropper()">&times;</button>
      </div>
      <div class="modal-body">
        <div class="cropper-container-wrapper">
          <img id="cropperImage" src="">
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn-modal btn-modal-cancel" onclick="closeCropper()">Cancel</button>
        <button class="btn-modal btn-modal-save" onclick="applyCrop()">Apply</button>
      </div>
    </div>
  </div>
  
  <!-- Load shared schedule module -->
  <script src="contributor-schedule.js"></script>
  
  <script>
    // Supabase setup
    const SUPABASE_URL = 'https://suncdkxfqkwwnmhosxcf.supabase.co';
    const SUPABASE_ANON_KEY = 'sb_publishable_hHSpgZPD327r11GaQG9iHw_uZbuaWmF';
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    
    let currentUser = null;
    let currentContributor = null;
    let portfolioItems = [];
    let cropper = null;
    let currentUploadType = null;
    let portfolioExpanded = false;
    let scheduleInstance = null;
    
    const NHIAA_SCHOOLS = [
      'Alvirne', 'Bedford', 'Belmont', 'Berlin', 'Bishop Brady', 'Bishop Guertin', 'Bow',
      'Campbell', 'Coe-Brown', 'Colebrook', 'Conant', 'Concord', 'Concord Christian', 'ConVal',
      'Derryfield', 'Dover', 'Epping', 'Exeter', 'Fall Mountain', 'Farmington', 'Franklin',
      'Gilford', 'Goffstown', 'Gorham', 'Groveton', 'Hanover', 'Hillsboro-Deering', 'Hinsdale',
      'Hollis-Brookline', 'Holy Family', 'Hopkinton', 'Inter-Lakes', 'John Stark', 'Kearsarge',
      'Keene', 'Kennett', 'Kingswood', 'Laconia', 'Lebanon', 'Lin-Wood', 'Lisbon', 'Littleton',
      'Londonderry', 'Manchester Central', 'Manchester Memorial', 'Manchester West', 'Mascenic',
      'Mascoma', 'Merrimack', 'Merrimack Valley', 'Milford', 'Monadnock', 'Moultonborough',
      'Mount Royal', 'Nashua North', 'Nashua South', 'Newfound', 'Newmarket', 'Newport',
      'Nute', 'Oyster River', 'Pelham', 'Pembroke', 'Pinkerton', 'Pittsburg-Canaan',
      'Pittsfield', 'Plymouth', 'Portsmouth', 'Portsmouth Christian', 'Profile',
      'Prospect Mountain', 'Raymond', 'Salem', 'Sanborn', 'Somersworth', 'Souhegan',
      'Spaulding', 'Stevens', 'St. Thomas Aquinas', 'Sunapee', 'Timberlane', 'Trinity',
      'White Mountains', 'Wilton-Lyndeborough', 'Windham', 'Winnacunnet', 'Winnisquam', 'Woodsville'
    ];
    
    const MONTH_NAMES_SHORT = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
    const MONTH_NAMES_FULL = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
    
    // Initialize
    document.addEventListener('DOMContentLoaded', async () => {
      // Populate alma mater dropdown
      const almaMaterSelect = document.getElementById('profileAlmaMater');
      NHIAA_SCHOOLS.forEach(school => {
        const opt = document.createElement('option');
        opt.value = school;
        opt.textContent = school;
        almaMaterSelect.appendChild(opt);
      });
      
      // Radio button listeners
      document.querySelectorAll('input[name="cameraBrand"]').forEach(radio => {
        radio.addEventListener('change', () => {
          document.getElementById('cameraBrandOther').style.display = 
            document.querySelector('input[name="cameraBrand"][value="Other"]').checked ? 'block' : 'none';
        });
      });
      
      document.querySelectorAll('input[name="computerPref"]').forEach(radio => {
        radio.addEventListener('change', () => {
          document.getElementById('computerPrefOther').style.display = 
            document.querySelector('input[name="computerPref"][value="Other"]').checked ? 'block' : 'none';
        });
      });
      
      // Set up auth state listener FIRST - this handles all auth events including recovery/magic links
      supabase.auth.onAuthStateChange(async (event, session) => {
        console.log('Auth event:', event, session ? 'has session' : 'no session');
        
        if (event === 'PASSWORD_RECOVERY') {
          // User clicked password reset link - show set password form
          currentUser = session.user;
          showSetPassword();
          return;
        }
        
        if (event === 'SIGNED_IN' && session) {
          console.log('SIGNED_IN event - calling loadContributorProfile');
          currentUser = session.user;
          // Only load profile if not in password set mode
          if (document.getElementById('setPasswordForm').style.display !== 'block') {
            await loadContributorProfile();
          } else {
            console.log('Skipping profile load - in password set mode');
          }
        } else if (event === 'SIGNED_OUT') {
          currentUser = null;
          currentContributor = null;
          showLoginScreen();
        } else if (event === 'INITIAL_SESSION' && session) {
          // Existing session on page load
          console.log('INITIAL_SESSION event - calling loadContributorProfile');
          currentUser = session.user;
          await loadContributorProfile();
        }
      });
      
      // Check for error in URL (e.g., expired link)
      if (window.location.hash && window.location.hash.includes('error=')) {
        const hashParams = new URLSearchParams(window.location.hash.substring(1));
        const error = hashParams.get('error');
        const errorDescription = hashParams.get('error_description');
        
        console.log('Auth error in URL:', error, errorDescription);
        
        if (error === 'access_denied' || errorDescription?.includes('expired')) {
          document.getElementById('loginError').textContent = 'Reset link has expired. Please request a new one.';
          showForgotPassword();
          // Clear the error from URL
          const cleanUrl = window.location.pathname + window.location.search;
          history.replaceState(null, '', cleanUrl);
          return;
        }
      }
      
      // Check if URL has auth tokens (hash fragment)
      if (window.location.hash && window.location.hash.includes('access_token')) {
        // Parse the hash to check token type
        const hashParams = new URLSearchParams(window.location.hash.substring(1));
        const tokenType = hashParams.get('type');
        
        console.log('Token detected, type:', tokenType);
        
        if (tokenType === 'recovery') {
          // Password reset link - let Supabase process the token first
          // Then show the set password form
          // DON'T clear hash yet - Supabase needs it
          
          // Give Supabase a moment to process the token and establish session
          setTimeout(async () => {
            const { data: { session } } = await supabase.auth.getSession();
            console.log('Recovery session check:', session ? 'valid' : 'none');
            if (session) {
              currentUser = session.user;
              showSetPassword();
              // Now we can clear the hash
              const cleanUrl = window.location.pathname + window.location.search;
              history.replaceState(null, '', cleanUrl);
            } else {
              console.error('No session after recovery token');
              document.getElementById('loginError').textContent = 'Reset link expired. Please request a new one.';
              showForgotPassword();
            }
          }, 500);
          return;
        }
        
        // Other token types (magic link, etc) - let onAuthStateChange handle them
        return;
      }
      
      // No tokens in URL - check for existing session
      const { data: { session }, error } = await supabase.auth.getSession();
      if (error) {
        console.error('Session check error:', error);
      }
      // If there's a session, INITIAL_SESSION event will fire from onAuthStateChange
      // If no session, just show login screen (it's already visible by default)
    });
    
    // View Management
    function showView(viewName) {
      document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
      document.querySelectorAll('.nav-link').forEach(n => n.classList.remove('active'));
      
      document.getElementById(viewName + 'View').classList.add('active');
      const navBtn = document.getElementById('nav' + viewName.charAt(0).toUpperCase() + viewName.slice(1));
      if (navBtn) navBtn.classList.add('active');
      
      if (viewName === 'dashboard') loadDashboardData();
      if (viewName === 'schedule') initScheduleIfNeeded();
    }
    
    // Initialize schedule module when needed
    function initScheduleIfNeeded() {
      if (!scheduleInstance && currentContributor) {
        scheduleInstance = initContributorSchedule({
          container: '#scheduleContainer',
          contributorName: currentContributor.name,
          showContributorDropdown: false,
          showAlerts: false,
          supabaseClient: supabase
        });
      } else if (scheduleInstance && currentContributor) {
        // Update contributor name if it changed
        scheduleInstance.setContributor(currentContributor.name);
      }
    }
    
    // Auth functions
    function showLogin() {
      document.getElementById('loginForm').style.display = 'block';
      document.getElementById('forgotForm').style.display = 'none';
      document.getElementById('setPasswordForm').style.display = 'none';
      document.getElementById('loginSubtitle').textContent = 'Sign in to manage your profile';
      document.getElementById('loginError').textContent = '';
    }
    
    function showForgotPassword() {
      document.getElementById('loginForm').style.display = 'none';
      document.getElementById('forgotForm').style.display = 'block';
      document.getElementById('setPasswordForm').style.display = 'none';
      document.getElementById('loginSubtitle').textContent = 'Reset your password';
      document.getElementById('loginError').textContent = '';
    }
    
    function showSetPassword() {
      document.getElementById('loginForm').style.display = 'none';
      document.getElementById('forgotForm').style.display = 'none';
      document.getElementById('setPasswordForm').style.display = 'block';
      document.getElementById('loginSubtitle').textContent = 'Create your password';
      document.getElementById('loginError').textContent = '';
    }
    
    function showLoginScreen() {
      document.getElementById('loginScreen').style.display = 'flex';
      document.getElementById('mainHeader').style.display = 'none';
      document.getElementById('mainContent').style.display = 'none';
    }
    
    function showMainScreen() {
      document.getElementById('loginScreen').style.display = 'none';
      document.getElementById('mainHeader').style.display = 'block';
      document.getElementById('mainContent').style.display = 'block';
    }
    
    async function handleLogin() {
      const email = document.getElementById('loginEmail').value.trim();
      const password = document.getElementById('loginPassword').value;
      const errorEl = document.getElementById('loginError');
      const loginBtn = document.querySelector('#loginForm button');
      
      if (!email || !password) {
        errorEl.textContent = 'Please enter email and password';
        return;
      }
      
      loginBtn.disabled = true;
      loginBtn.textContent = 'Signing in...';
      errorEl.textContent = '';
      
      try {
        console.log('Attempting sign in for:', email);
        const { data, error } = await supabase.auth.signInWithPassword({ email, password });
        if (error) {
          console.log('Sign in error:', error);
          errorEl.textContent = error.message.includes('Invalid') ? 'Invalid email or password' : error.message;
          loginBtn.disabled = false;
          loginBtn.textContent = 'Sign In';
          return;
        }
        console.log('Sign in successful, loading profile...');
        currentUser = data.user;
        // Don't call loadContributorProfile here - let onAuthStateChange handle it
        // This prevents double loading
      } catch (err) {
        console.error('Login catch error:', err);
        errorEl.textContent = 'Login failed. Please try again.';
        loginBtn.disabled = false;
        loginBtn.textContent = 'Sign In';
      }
    }
    
    async function handleResetPassword() {
      const email = document.getElementById('resetEmail').value.trim();
      const errorEl = document.getElementById('loginError');
      if (!email) { errorEl.textContent = 'Please enter your email'; return; }
      
      try {
        const { error } = await supabase.auth.resetPasswordForEmail(email, {
          redirectTo: window.location.origin + '/contributor-portal.html'
        });
        if (error) { errorEl.textContent = error.message; return; }
        errorEl.className = 'login-success';
        errorEl.textContent = 'Check your email for the reset link!';
      } catch (err) {
        errorEl.textContent = 'Failed to send reset email';
      }
    }
    
    async function handleSetPassword() {
      const password = document.getElementById('newPassword').value;
      const confirmPassword = document.getElementById('confirmPassword').value;
      const errorEl = document.getElementById('loginError');
      
      if (!password || !confirmPassword) { errorEl.textContent = 'Please enter and confirm your password'; return; }
      if (password.length < 6) { errorEl.textContent = 'Password must be at least 6 characters'; return; }
      if (password !== confirmPassword) { errorEl.textContent = 'Passwords do not match'; return; }
      
      try {
        // Verify we have an active session before attempting to update
        const { data: { session } } = await supabase.auth.getSession();
        if (!session) {
          errorEl.textContent = 'Session expired. Please request a new password reset link.';
          setTimeout(() => showForgotPassword(), 2000);
          return;
        }
        
        const { error } = await supabase.auth.updateUser({ password });
        if (error) { 
          console.error('Password update error:', error);
          errorEl.textContent = error.message; 
          return; 
        }
        document.getElementById('newPassword').value = '';
        document.getElementById('confirmPassword').value = '';
        showToast('Password set successfully!', 'success');
        await loadContributorProfile();
      } catch (err) {
        console.error('Password set error:', err);
        errorEl.textContent = 'Error setting password. Please try again.';
      }
    }
    
    async function handleLogout() {
      try {
        await supabase.auth.signOut();
        currentUser = null;
        currentContributor = null;
        scheduleInstance = null;
        window.location.reload();
      } catch (err) {
        console.error('Logout error:', err);
        window.location.reload();
      }
    }
    
    // Load contributor profile
    async function loadContributorProfile() {
      console.log('loadContributorProfile called, currentUser:', currentUser?.email);
      if (!currentUser) {
        console.log('No currentUser, returning');
        return;
      }
      
      try {
        console.log('Querying contributors table for:', currentUser.email);
        const { data: contributor, error } = await supabase
          .from('contributors')
          .select('*')
          .eq('email', currentUser.email)
          .single();
        
        console.log('Query result:', { contributor, error });
        
        if (error || !contributor) {
          console.log('No contributor found or error');
          document.getElementById('loginError').textContent = 'No contributor account found.';
          await supabase.auth.signOut();
          return;
        }
        
        if (!contributor.active) {
          console.log('Contributor inactive');
          document.getElementById('loginError').textContent = 'Your account is inactive.';
          await supabase.auth.signOut();
          return;
        }
        
        if (!contributor.auth_user_id) {
          console.log('Linking auth_user_id');
          await supabase.from('contributors').update({ auth_user_id: currentUser.id }).eq('id', contributor.id);
        }
        
        console.log('Setting currentContributor and showing main screen');
        currentContributor = contributor;
        populateForm(contributor);
        await loadPortfolio();
        
        document.getElementById('userName').textContent = contributor.name;
        document.getElementById('welcomeName').textContent = contributor.name.split(' ')[0];
        showMainScreen();
        loadDashboardData();
        
      } catch (err) {
        console.error('Error loading profile:', err);
        document.getElementById('loginError').textContent = 'Error loading profile';
      }
    }
    
    // Dashboard
    async function loadDashboardData() {
      if (!currentContributor) return;
      const contributorName = currentContributor.name;
      // Use local date (not UTC) to avoid timezone issues in evening hours
      const today = new Date().toLocaleDateString('en-CA'); // Returns YYYY-MM-DD in local timezone
      loadUpcomingCoverage(contributorName, today);
      loadRecentCoverage(contributorName, today);
    }
    
    async function loadUpcomingCoverage(contributorName, today) {
      const container = document.getElementById('upcomingCards');
      container.innerHTML = '<div class="loading"><span class="loading-spinner"></span> Loading...</div>';
      
      try {
        const response = await fetch(`/.netlify/functions/games?start_date=${today}&limit=500`);
        const games = await response.json();
        
        const myGames = games.filter(g => 
          (g.photog1 || '').trim() === contributorName || 
          (g.photog2 || '').trim() === contributorName || 
          (g.videog || '').trim() === contributorName || 
          (g.writer || '').trim() === contributorName
        ).slice(0, 6);
        
        if (myGames.length === 0) {
          container.innerHTML = `
            <div class="empty-state" style="width:100%;">
              <div class="empty-icon">üìÖ</div>
              <p>No upcoming coverage assigned</p>
              <p style="font-size: 12px; margin-top: 5px;"><a href="#" onclick="showView('schedule'); return false;">Claim games on the schedule</a></p>
            </div>
          `;
          return;
        }
        
        container.innerHTML = myGames.map(game => {
          const [year, month, day] = game.date.split('-');
          const monthName = MONTH_NAMES_FULL[parseInt(month, 10) - 1];
          const dayNum = parseInt(day, 10);
          const time = game.time ? game.time.replace(/^0/, '') : 'TBD';
          const awayTeam = game.away || 'TBD';
          const homeTeam = game.home || 'TBD';
          
          return `
            <div class="calendar-card" onclick="showView('schedule')">
              <div class="calendar-header">${monthName}</div>
              <div class="calendar-body">
                <div class="calendar-day">${dayNum}</div>
              </div>
              <div class="calendar-footer">
                <div class="calendar-away">${awayTeam}</div>
                <div class="calendar-home">@ ${homeTeam}</div>
                <div class="calendar-meta">${time} ‚Ä¢ ${game.gender || ''}</div>
              </div>
            </div>
          `;
        }).join('');
        
      } catch (err) {
        console.error('Error loading upcoming:', err);
        container.innerHTML = '<div class="empty-state">Error loading games</div>';
      }
    }
    
    async function loadRecentCoverage(contributorName, today) {
      const container = document.getElementById('recentGrid');
      container.innerHTML = '<div class="loading"><span class="loading-spinner"></span> Loading...</div>';
      
      try {
        const response = await fetch(`/.netlify/functions/games?end_date=${today}&limit=500`);
        const games = await response.json();
        
        const myGames = games.filter(g => 
          ((g.photog1 || '').trim() === contributorName || 
           (g.photog2 || '').trim() === contributorName || 
           (g.videog || '').trim() === contributorName || 
           (g.writer || '').trim() === contributorName) &&
          (g.photos_url || g.recap_url)
        ).sort((a, b) => b.date.localeCompare(a.date)).slice(0, 8);
        
        if (myGames.length === 0) {
          container.innerHTML = `
            <div class="empty-state" style="grid-column: 1/-1;">
              <div class="empty-icon">üì∏</div>
              <p>No recent coverage yet</p>
            </div>
          `;
          return;
        }
        
        container.innerHTML = myGames.map(game => {
          const [year, month, day] = game.date.split('-');
          const monthName = MONTH_NAMES_SHORT[parseInt(month, 10) - 1];
          const link = game.photos_url || game.recap_url || '#';
          const hasPhotos = !!game.photos_url;
          const hasRecap = !!game.recap_url;
          const thumbUrl = game.photos_thumb_url;
          
          return `
            <a class="recent-card" href="${link}" target="_blank">
              <div class="recent-thumb">
                ${thumbUrl 
                  ? `<img src="${thumbUrl}" alt="${game.away} @ ${game.home}" onerror="this.parentElement.innerHTML='<span class=\\'thumb-placeholder\\'>üì∑</span>'">` 
                  : '<span class="thumb-placeholder">üì∑</span>'}
              </div>
              <div class="recent-info">
                <div class="recent-teams">${game.away} @ ${game.home}</div>
                <div class="recent-date">${monthName} ${parseInt(day)}, ${year}</div>
                <div class="recent-badges">
                  ${hasPhotos ? '<span class="recent-badge">üì∏</span>' : ''}
                  ${hasRecap ? '<span class="recent-badge">üìù</span>' : ''}
                </div>
              </div>
            </a>
          `;
        }).join('');
        
      } catch (err) {
        console.error('Error loading recent:', err);
        container.innerHTML = '<div class="empty-state" style="grid-column: 1/-1;">Error loading coverage</div>';
      }
    }
    
    // Profile functions
    function populateForm(c) {
      document.getElementById('profileName').value = c.name || '';
      document.getElementById('profileEmail').value = c.email || '';
      document.getElementById('profileArea').value = c.primary_area || '';
      document.getElementById('profileCell').value = c.cell || '';
      document.getElementById('profileAddress').value = c.mailing_address || '';
      document.getElementById('profileVenmo').value = c.venmo || '';
      document.getElementById('profileShirtSize').value = c.shirt_size || '';
      document.getElementById('profileAlmaMater').value = c.nhiaa_alma_mater || '';
      document.getElementById('profileCollege').value = c.college || '';
      
      document.getElementById('typePhotographer').checked = c.is_photographer || false;
      document.getElementById('typeVideographer').checked = c.is_videographer || false;
      document.getElementById('typeWriter').checked = c.is_writer || false;
      document.getElementById('typeGraphics').checked = c.is_graphics || false;
      
      document.getElementById('profileWebsite').value = c.website_url || '';
      document.getElementById('profileInstagram').value = c.instagram_url || '';
      document.getElementById('profileFacebook').value = c.facebook_url || '';
      document.getElementById('profileTwitter').value = c.twitter_url || '';
      
      if (c.camera_brand) {
        const validBrands = ['Canon', 'Nikon', 'Sony'];
        if (validBrands.includes(c.camera_brand)) {
          const radio = document.querySelector(`input[name="cameraBrand"][value="${c.camera_brand}"]`);
          if (radio) radio.checked = true;
        } else {
          document.querySelector('input[name="cameraBrand"][value="Other"]').checked = true;
          document.getElementById('cameraBrandOther').value = c.camera_brand;
          document.getElementById('cameraBrandOther').style.display = 'block';
        }
      }
      
      if (c.computer_preference) {
        const validPrefs = ['Mac', 'PC'];
        if (validPrefs.includes(c.computer_preference)) {
          const radio = document.querySelector(`input[name="computerPref"][value="${c.computer_preference}"]`);
          if (radio) radio.checked = true;
        } else {
          document.querySelector('input[name="computerPref"][value="Other"]').checked = true;
          document.getElementById('computerPrefOther').value = c.computer_preference;
          document.getElementById('computerPrefOther').style.display = 'block';
        }
      }
      
      document.getElementById('profileBio').value = c.bio || '';
      updateCharCount();
      
      if (c.headshot_url) setImagePreview('headshot', c.headshot_url);
      if (c.watermark_url) setImagePreview('watermark', c.watermark_url);
      if (c.logo_url) setImagePreview('logo', c.logo_url);
    }
    
    async function saveProfile() {
      if (!currentContributor) return;
      
      const btns = document.querySelectorAll('.btn-save-inline');
      btns.forEach(btn => { btn.disabled = true; btn.textContent = 'Saving...'; });
      
      let cameraBrand = '';
      const selectedCamera = document.querySelector('input[name="cameraBrand"]:checked');
      if (selectedCamera) {
        cameraBrand = selectedCamera.value === 'Other' ? document.getElementById('cameraBrandOther').value : selectedCamera.value;
      }
      
      let computerPref = '';
      const selectedComputer = document.querySelector('input[name="computerPref"]:checked');
      if (selectedComputer) {
        computerPref = selectedComputer.value === 'Other' ? document.getElementById('computerPrefOther').value : selectedComputer.value;
      }
      
      const updates = {
        name: document.getElementById('profileName').value.trim(),
        primary_area: document.getElementById('profileArea').value.trim(),
        cell: document.getElementById('profileCell').value.trim(),
        mailing_address: document.getElementById('profileAddress').value.trim(),
        venmo: document.getElementById('profileVenmo').value.trim(),
        shirt_size: document.getElementById('profileShirtSize').value,
        nhiaa_alma_mater: document.getElementById('profileAlmaMater').value,
        college: document.getElementById('profileCollege').value.trim(),
        is_photographer: document.getElementById('typePhotographer').checked,
        is_videographer: document.getElementById('typeVideographer').checked,
        is_writer: document.getElementById('typeWriter').checked,
        is_graphics: document.getElementById('typeGraphics').checked,
        website_url: document.getElementById('profileWebsite').value.trim(),
        instagram_url: document.getElementById('profileInstagram').value.trim(),
        facebook_url: document.getElementById('profileFacebook').value.trim(),
        twitter_url: document.getElementById('profileTwitter').value.trim(),
        camera_brand: cameraBrand,
        computer_preference: computerPref,
        bio: document.getElementById('profileBio').value.trim(),
        headshot_url: document.getElementById('headshotUrl').value,
        watermark_url: document.getElementById('watermarkUrl').value,
        logo_url: document.getElementById('logoUrl').value
      };
      
      try {
        const { error } = await supabase.from('contributors').update(updates).eq('id', currentContributor.id);
        if (error) throw error;
        
        currentContributor = { ...currentContributor, ...updates };
        document.getElementById('userName').textContent = updates.name;
        document.getElementById('welcomeName').textContent = updates.name.split(' ')[0];
        
        // Update schedule instance if name changed
        if (scheduleInstance) {
          scheduleInstance.setContributor(updates.name);
        }
        
        showToast('Profile saved!', 'success');
      } catch (err) {
        showToast('Error saving profile', 'error');
      } finally {
        btns.forEach(btn => { btn.disabled = false; btn.textContent = 'Save Changes'; });
      }
    }
    
    async function changePassword() {
      const newPassword = document.getElementById('changeNewPassword').value;
      const confirmPassword = document.getElementById('changeConfirmPassword').value;
      const statusEl = document.getElementById('passwordChangeStatus');
      
      // Validation
      if (!newPassword || !confirmPassword) {
        statusEl.style.color = '#c00';
        statusEl.textContent = 'Please fill in both fields';
        return;
      }
      
      if (newPassword.length < 6) {
        statusEl.style.color = '#c00';
        statusEl.textContent = 'Password must be at least 6 characters';
        return;
      }
      
      if (newPassword !== confirmPassword) {
        statusEl.style.color = '#c00';
        statusEl.textContent = 'Passwords do not match';
        return;
      }
      
      statusEl.style.color = '#666';
      statusEl.textContent = 'Updating...';
      
      try {
        const { error } = await supabase.auth.updateUser({ password: newPassword });
        
        if (error) {
          statusEl.style.color = '#c00';
          statusEl.textContent = error.message;
          return;
        }
        
        // Clear fields and show success
        document.getElementById('changeNewPassword').value = '';
        document.getElementById('changeConfirmPassword').value = '';
        statusEl.style.color = '#4CAF50';
        statusEl.textContent = 'Password updated successfully!';
        
        // Clear status after 3 seconds
        setTimeout(() => { statusEl.textContent = ''; }, 3000);
        
      } catch (err) {
        statusEl.style.color = '#c00';
        statusEl.textContent = 'Error updating password';
      }
    }
    
    // Portfolio
    async function loadPortfolio() {
      if (!currentContributor) return;
      
      try {
        const { data, error } = await supabase
          .from('contributor_portfolio')
          .select('*')
          .eq('contributor_id', currentContributor.id)
          .order('created_at', { ascending: false });
        
        if (error) throw error;
        
        const smugmugGalleries = await fetchSmugMugGalleries();
        
        portfolioItems = [
          ...smugmugGalleries.map(g => ({ ...g, isAuto: true })),
          ...(data || []).map(p => ({ ...p, isAuto: false }))
        ];
        
        renderPortfolio();
      } catch (err) {
        console.error('Error loading portfolio:', err);
        document.getElementById('portfolioList').innerHTML = '<p style="color:#999">Error loading portfolio</p>';
      }
    }
    
    async function fetchSmugMugGalleries() {
      try {
        const contributorName = (currentContributor.name || '').trim();
        if (!contributorName) return [];
        
        const response = await fetch(`/.netlify/functions/games?limit=500`);
        const games = await response.json();
        
        const myGalleries = games.filter(g => {
          if (!g.photos_url) return false;
          const photog1 = (g.photog1 || '').trim();
          const photog2 = (g.photog2 || '').trim();
          return photog1 === contributorName || photog2 === contributorName;
        }).sort((a, b) => (b.date || '').localeCompare(a.date || '')).slice(0, 20);
        
        return myGalleries.map(g => ({
          title: `${g.away || 'TBD'} @ ${g.home || 'TBD'}`,
          url: g.photos_url,
          link_type: 'smugmug',
          date: g.date
        }));
      } catch (err) {
        console.error('Error fetching galleries:', err);
        return [];
      }
    }
    
    function renderPortfolio() {
      const listEl = document.getElementById('portfolioList');
      const showMoreBtn = document.getElementById('btnShowMore');
      
      if (portfolioItems.length === 0) {
        listEl.innerHTML = '<p style="color:#999; text-align:center; padding: 20px;">No portfolio items yet</p>';
        showMoreBtn.style.display = 'none';
        return;
      }
      
      const typeIcons = { 'website': 'üåê', 'instagram': 'üì∑', 'youtube': '‚ñ∂Ô∏è', 'graphics': 'üé®', 'other': 'üîó', 'smugmug': 'üì∏' };
      const itemsToShow = portfolioExpanded ? portfolioItems : portfolioItems.slice(0, 5);
      
      listEl.innerHTML = itemsToShow.map(item => `
        <div class="portfolio-item ${item.isAuto ? 'auto' : ''}">
          <span class="portfolio-icon">${typeIcons[item.link_type] || 'üîó'}</span>
          <div class="portfolio-info">
            <div class="portfolio-title">${escapeHtml(item.title)}</div>
            <div class="portfolio-url"><a href="${escapeHtml(item.url)}" target="_blank">${escapeHtml(item.url)}</a></div>
          </div>
          <span class="portfolio-type ${item.isAuto ? 'auto' : ''}">${item.isAuto ? 'SmugMug' : item.link_type}</span>
          ${!item.isAuto ? `<button class="btn-remove-portfolio" onclick="removePortfolioItem(${item.id})">√ó</button>` : ''}
        </div>
      `).join('');
      
      if (portfolioItems.length > 5) {
        showMoreBtn.style.display = 'block';
        showMoreBtn.textContent = portfolioExpanded ? 'Show less' : `Show all (${portfolioItems.length})`;
      } else {
        showMoreBtn.style.display = 'none';
      }
      
      listEl.classList.toggle('collapsed', !portfolioExpanded && portfolioItems.length > 5);
    }
    
    function togglePortfolioExpand() {
      portfolioExpanded = !portfolioExpanded;
      renderPortfolio();
    }
    
    async function addPortfolioLink() {
      const title = document.getElementById('newPortfolioTitle').value.trim();
      const url = document.getElementById('newPortfolioUrl').value.trim();
      const type = document.getElementById('newPortfolioType').value;
      
      if (!title || !url) { showToast('Please enter title and URL', 'error'); return; }
      
      try {
        const { data, error } = await supabase
          .from('contributor_portfolio')
          .insert({ contributor_id: currentContributor.id, title, url, link_type: type })
          .select()
          .single();
        
        if (error) throw error;
        
        portfolioItems.push({ ...data, isAuto: false });
        renderPortfolio();
        document.getElementById('newPortfolioTitle').value = '';
        document.getElementById('newPortfolioUrl').value = '';
        showToast('Link added!', 'success');
      } catch (err) {
        showToast('Error adding link', 'error');
      }
    }
    
    async function removePortfolioItem(id) {
      if (!confirm('Remove this link?')) return;
      
      try {
        const { error } = await supabase.from('contributor_portfolio').delete().eq('id', id);
        if (error) throw error;
        portfolioItems = portfolioItems.filter(p => p.id !== id);
        renderPortfolio();
        showToast('Link removed', 'success');
      } catch (err) {
        showToast('Error removing link', 'error');
      }
    }
    
    // Image upload
    function triggerUpload(type) { document.getElementById(`${type}Input`).click(); }
    
    function handleImageSelect(event, type) {
      const file = event.target.files[0];
      if (!file) return;
      if (file.size > 2 * 1024 * 1024) { showToast('File too large (max 2MB)', 'error'); return; }
      currentUploadType = type;
      if (type === 'headshot') { openCropper(file, 1); } else { uploadImage(file, type); }
    }
    
    function openCropper(file, aspectRatio) {
      const reader = new FileReader();
      reader.onload = (e) => {
        document.getElementById('cropperImage').src = e.target.result;
        document.getElementById('cropperModal').classList.add('open');
        if (cropper) cropper.destroy();
        setTimeout(() => {
          cropper = new Cropper(document.getElementById('cropperImage'), { aspectRatio, viewMode: 1, autoCropArea: 1 });
        }, 100);
      };
      reader.readAsDataURL(file);
    }
    
    function closeCropper() {
      document.getElementById('cropperModal').classList.remove('open');
      if (cropper) { cropper.destroy(); cropper = null; }
      currentUploadType = null;
    }
    
    async function applyCrop() {
      if (!cropper || !currentUploadType) return;
      const canvas = cropper.getCroppedCanvas({ maxWidth: 800, maxHeight: 800 });
      canvas.toBlob(async (blob) => {
        await uploadImage(blob, currentUploadType);
        closeCropper();
      }, 'image/jpeg', 0.9);
    }
    
    async function uploadImage(file, type) {
      const preview = document.getElementById(`${type}Preview`);
      preview.innerHTML = '<div class="placeholder">Uploading...</div>';
      
      try {
        const filename = `contributors/${currentContributor.id}/${type}-${Date.now()}.jpg`;
        const { error } = await supabase.storage.from('images').upload(filename, file, { cacheControl: '3600', upsert: true });
        if (error) throw error;
        
        const { data: urlData } = supabase.storage.from('images').getPublicUrl(filename);
        document.getElementById(`${type}Url`).value = urlData.publicUrl;
        setImagePreview(type, urlData.publicUrl);
        showToast('Image uploaded!', 'success');
      } catch (err) {
        preview.innerHTML = '<div class="placeholder">Click to upload</div>';
        showToast('Upload failed', 'error');
      }
    }
    
    function setImagePreview(type, url) {
      const preview = document.getElementById(`${type}Preview`);
      preview.innerHTML = `<img src="${url}" alt="${type}">`;
      preview.classList.add('has-image');
      document.getElementById(`${type}Url`).value = url;
      document.getElementById(`${type}Remove`).style.display = 'inline-block';
    }
    
    function removeImage(type) {
      document.getElementById(`${type}Preview`).innerHTML = '<div class="placeholder">Click to upload</div>';
      document.getElementById(`${type}Preview`).classList.remove('has-image');
      document.getElementById(`${type}Url`).value = '';
      document.getElementById(`${type}Remove`).style.display = 'none';
    }
    
    // Helpers
    function updateCharCount() {
      const text = document.getElementById('profileBio').value;
      const words = text.trim() ? text.trim().split(/\s+/).length : 0;
      const countEl = document.getElementById('bioCharCount');
      countEl.textContent = `${words} / 100 words`;
      countEl.classList.toggle('over', words > 100);
    }
    
    function openTop10Upload() {
      if (currentContributor?.top10_dropbox_url) {
        window.open(currentContributor.top10_dropbox_url, 'top10Upload', 'width=1200,height=800,scrollbars=yes,resizable=yes');
      } else {
        showToast('Top-10 upload link not configured', 'error');
      }
    }
    
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text || '';
      return div.innerHTML;
    }
    
    function showToast(message, type = 'success') {
      const toast = document.createElement('div');
      toast.className = `toast ${type}`;
      toast.textContent = message;
      document.body.appendChild(toast);
      setTimeout(() => toast.remove(), 3000);
    }
  </script>
</body>
</html>
