<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ball603 CMS</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f5f5f5; color: #333; min-height: 100vh; }
    
    /* Header */
    .header { background: #fff; padding: 15px 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); position: relative; z-index: 1000; }
    .header-inner { max-width: 1200px; margin: 0 auto; display: flex; justify-content: space-between; align-items: center; }
    .header-left { display: flex; align-items: center; gap: 15px; }
    .header-left img { height: 50px; cursor: pointer; }
    .header-left h1 { font-size: 20px; color: #333; }
    .header-right { display: flex; align-items: center; gap: 15px; }
    .user-info { font-size: 13px; color: #666; }
    .btn-logout { background: #eee; border: none; padding: 8px 16px; border-radius: 5px; cursor: pointer; font-size: 13px; }
    .btn-logout:hover { background: #ddd; }
    
    /* Login Screen */
    .login-screen { display: flex; justify-content: center; align-items: center; min-height: 100vh; padding: 20px; }
    .login-box { background: #fff; padding: 40px; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); text-align: center; max-width: 400px; width: 100%; }
    .login-box img { height: 80px; margin-bottom: 20px; }
    .login-box h2 { margin-bottom: 10px; color: #333; }
    .login-box p { color: #666; margin-bottom: 25px; font-size: 14px; }
    .login-box input { width: 100%; padding: 12px 15px; border: 1px solid #ddd; border-radius: 5px; font-size: 14px; margin-bottom: 15px; }
    .login-box input:focus { outline: none; border-color: #f57c00; }
    .login-box button { width: 100%; padding: 12px; background: #f57c00; color: #fff; border: none; border-radius: 5px; font-size: 14px; font-weight: 600; cursor: pointer; }
    .login-box button:hover { background: #e56a00; }
    .login-error { color: #c00; font-size: 13px; margin-bottom: 15px; }
    
    /* Main Layout */
    .main-container { max-width: 1200px; margin: 0 auto; padding: 20px; display: none; }
    
    /* Tabs */
    .tabs { display: flex; gap: 5px; margin-bottom: 20px; }
    .tab { padding: 10px 20px; background: #fff; border: none; border-radius: 8px 8px 0 0; cursor: pointer; font-size: 14px; font-weight: 500; color: #666; }
    .tab:hover { background: #f0f0f0; }
    .tab.active { background: #f57c00; color: #fff; }
    
    /* Panel */
    .panel { background: #fff; border-radius: 0 8px 8px 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); padding: 20px; }
    
    /* Article List */
    .toolbar { display: flex; align-items: center; margin-bottom: 20px; gap: 10px; }
    .btn-new { background: #e0e0e0; color: #333; border: none; padding: 10px 20px; border-radius: 5px; font-size: 14px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 8px; }
    .btn-new:hover { background: #d0d0d0; }
    .search-box { padding: 10px 15px; border: 1px solid #ddd; border-radius: 5px; font-size: 14px; width: 250px; margin-left: auto; }
    
    .article-list { border: 1px solid #eee; border-radius: 8px; overflow: hidden; }
    .article-row { display: grid; grid-template-columns: 1fr 120px 150px 100px; padding: 15px; border-bottom: 1px solid #eee; align-items: center; }
    .article-row:last-child { border-bottom: none; }
    .article-row:hover { background: #f9f9f9; }
    .article-row.header { background: #f5f5f5; font-weight: 600; font-size: 12px; text-transform: uppercase; color: #666; }
    .article-title { font-weight: 500; color: #333; cursor: pointer; }
    .article-title:hover { color: #f57c00; }
    .article-status { font-size: 12px; padding: 4px 10px; border-radius: 20px; display: inline-block; }
    .article-status.draft { background: #fff3e0; color: #e65100; }
    .article-status.published { background: #e8f5e9; color: #2e7d32; }
    .article-date { font-size: 13px; color: #666; }
    .article-actions { display: flex; gap: 8px; }
    .btn-edit, .btn-delete { padding: 6px 12px; border: none; border-radius: 4px; font-size: 12px; cursor: pointer; }
    .btn-edit { background: #e3f2fd; color: #1565c0; }
    .btn-edit:hover { background: #bbdefb; }
    .btn-delete { background: #ffebee; color: #c62828; }
    .btn-delete:hover { background: #ffcdd2; }
    
    /* Editor */
    .editor-panel { display: none; }
    .editor-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid #eee; }
    .editor-header h2 { font-size: 18px; }
    .editor-actions { display: flex; gap: 10px; }
    .btn-back { background: #eee; color: #333; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-size: 14px; }
    .btn-back:hover { background: #ddd; }
    .btn-save { background: #2196F3; color: #fff; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-size: 14px; font-weight: 500; }
    .btn-save:hover { background: #1976D2; }
    .btn-publish { background: #4CAF50; color: #fff; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-size: 14px; font-weight: 500; }
    .btn-publish:hover { background: #388E3C; }
    
    .form-grid { display: grid; grid-template-columns: 2fr 1fr; gap: 30px; }
    .form-main, .form-sidebar { display: flex; flex-direction: column; gap: 20px; }
    
    .form-group { display: flex; flex-direction: column; gap: 6px; }
    .form-group label { font-size: 13px; font-weight: 600; color: #555; }
    .form-group input, .form-group select, .form-group textarea { padding: 10px 12px; border: 1px solid #ddd; border-radius: 5px; font-size: 14px; font-family: inherit; }
    .form-group input:focus, .form-group select:focus, .form-group textarea:focus { outline: none; border-color: #f57c00; }
    .form-group textarea { min-height: 300px; resize: vertical; }
    .form-group small { font-size: 11px; color: #999; }
    
    .sidebar-card { background: #f9f9f9; border-radius: 8px; padding: 15px; }
    .sidebar-card h4 { font-size: 13px; font-weight: 600; margin-bottom: 12px; color: #555; }
    
    .game-selector { border: 1px solid #ddd; border-radius: 5px; max-height: 200px; overflow-y: auto; background: #fff; }
    .game-option { padding: 10px; border-bottom: 1px solid #eee; cursor: pointer; font-size: 13px; }
    .game-option:hover { background: #fff3e0; }
    .game-option.selected { background: #f57c00; color: #fff; }
    .game-option .teams { font-weight: 500; }
    .game-option .meta { font-size: 11px; opacity: 0.8; margin-top: 3px; }
    
    .ai-generate { margin-top: 15px; }
    .btn-ai { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: #fff; border: none; padding: 12px 20px; border-radius: 5px; cursor: pointer; font-size: 14px; font-weight: 500; width: 100%; display: flex; align-items: center; justify-content: center; gap: 8px; }
    .btn-ai:hover { opacity: 0.9; }
    .btn-ai:disabled { opacity: 0.5; cursor: not-allowed; }
    
    /* Social posting */
    .social-buttons { display: flex; flex-direction: column; gap: 8px; }
    .btn-social { padding: 10px; border: none; border-radius: 5px; cursor: pointer; font-size: 13px; font-weight: 500; display: flex; align-items: center; gap: 8px; }
    .btn-social.facebook { background: #1877f2; color: #fff; }
    .btn-social.instagram { background: linear-gradient(45deg, #f09433, #e6683c, #dc2743, #cc2366, #bc1888); color: #fff; }
    .btn-social.twitter { background: #000; color: #fff; }
    .btn-social:disabled { opacity: 0.5; }
    .btn-social .posted { margin-left: auto; font-size: 11px; opacity: 0.8; }
    
    /* Browse button */
    .btn-browse { background: #f57c00; color: #fff; border: none; padding: 10px 15px; border-radius: 5px; cursor: pointer; font-size: 13px; font-weight: 500; white-space: nowrap; }
    .btn-browse:hover { background: #e56a00; }
    
    /* SmugMug Modal */
    .modal-overlay { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.6); z-index: 3000; justify-content: center; align-items: center; }
    .modal-overlay.open { display: flex; }
    .modal { background: #fff; border-radius: 10px; width: 90%; max-width: 800px; max-height: 80vh; display: flex; flex-direction: column; }
    .modal-header { padding: 15px 20px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
    .modal-header h3 { font-size: 16px; }
    .modal-close { background: none; border: none; font-size: 24px; cursor: pointer; color: #999; }
    .modal-close:hover { color: #333; }
    .modal-search { padding: 15px 20px; border-bottom: 1px solid #eee; }
    .modal-search input { width: 100%; padding: 10px 15px; border: 1px solid #ddd; border-radius: 5px; font-size: 14px; }
    .modal-body { flex: 1; overflow-y: auto; padding: 15px; }
    .album-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 15px; }
    .album-card { border: 1px solid #eee; border-radius: 8px; overflow: hidden; cursor: pointer; transition: box-shadow 0.2s; }
    .album-card:hover { box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
    .album-card.selected { border: 2px solid #f57c00; }
    .album-thumb { width: 100%; height: 120px; object-fit: cover; background: #f5f5f5; }
    .album-info { padding: 10px; }
    .album-name { font-size: 13px; font-weight: 500; margin-bottom: 4px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .album-meta { font-size: 11px; color: #888; }
    .modal-footer { padding: 15px 20px; border-top: 1px solid #eee; display: flex; justify-content: flex-end; gap: 10px; }
    .btn-modal { padding: 10px 20px; border-radius: 5px; font-size: 14px; cursor: pointer; }
    .btn-modal-cancel { background: #eee; border: none; color: #333; }
    .btn-modal-cancel:hover { background: #ddd; }
    .btn-modal-select { background: #f57c00; border: none; color: #fff; font-weight: 500; }
    .btn-modal-select:hover { background: #e56a00; }
    .btn-modal-select:disabled { background: #ccc; cursor: not-allowed; }
    
    /* Empty state */
    .empty-state { text-align: center; padding: 60px 20px; color: #888; }
    .empty-state p { margin-bottom: 20px; }
    
    /* Toast notifications */
    .toast { position: fixed; bottom: 20px; right: 20px; padding: 15px 25px; background: #333; color: #fff; border-radius: 8px; font-size: 14px; z-index: 2000; display: none; }
    .toast.success { background: #4CAF50; }
    .toast.error { background: #f44336; }
    
    /* Loading */
    .loading { text-align: center; padding: 40px; color: #888; }
    
    @media (max-width: 900px) {
      .form-grid { grid-template-columns: 1fr; }
      .article-row { grid-template-columns: 1fr; gap: 8px; }
      .article-row.header { display: none; }
    }
  </style>
</head>
<body>
  <!-- Login Screen -->
  <div class="login-screen" id="loginScreen">
    <div class="login-box">
      <img src="logo.png" alt="Ball603">
      <h2>Ball603 CMS</h2>
      <p>Content Management System</p>
      <div class="login-error" id="loginError" style="display: none;"></div>
      <input type="password" id="loginPassword" placeholder="Enter password" onkeypress="if(event.key==='Enter')login()">
      <button onclick="login()">Sign In</button>
    </div>
  </div>
  
  <!-- Main App -->
  <div class="header" id="mainHeader" style="display: none;">
    <div class="header-inner">
      <div class="header-left">
        <img src="logo.png" alt="Ball603" onclick="window.location.href='/'">
        <h1>CMS</h1>
      </div>
      <div class="header-right">
        <span class="user-info">Welcome, Admin</span>
        <button class="btn-logout" onclick="logout()">Logout</button>
      </div>
    </div>
  </div>
  
  <div class="main-container" id="mainContainer">
    <div class="tabs">
      <button class="tab active" onclick="showTab('articles')">Articles</button>
      <button class="tab" onclick="showTab('sponsors')">Sponsors</button>
      <button class="tab" onclick="showTab('products')">Webstore</button>
    </div>
    
    <!-- Articles List Panel -->
    <div class="panel" id="articlesPanel">
      <div class="toolbar">
        <button class="btn-new" onclick="newGameStory()">
          <span>+</span> Scorebook Story
        </button>
        <button class="btn-new" onclick="newBoxscoreStory()" style="background: #e3f2fd;">
          <span>+</span> Boxscore Story
        </button>
        <button class="btn-new" onclick="newArticle()">
          <span>+</span> News Article
        </button>
        <input type="text" class="search-box" placeholder="Search articles..." oninput="filterArticles(this.value)">
      </div>
      
      <div class="article-list" id="articleList">
        <div class="article-row header">
          <div>Title</div>
          <div>Status</div>
          <div>Date</div>
          <div>Actions</div>
        </div>
        <div class="loading">Loading articles...</div>
      </div>
    </div>
    
    <!-- Game Story Modal -->
    <div id="gameStoryModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 1000; overflow-y: auto;">
      <div style="max-width: 550px; margin: 30px auto; background: #f5f5f5; border-radius: 10px; overflow: hidden; box-shadow: 0 4px 20px rgba(0,0,0,0.3);">
        
        <!-- Modal Header -->
        <div style="background: #444; color: white; padding: 12px 16px; display: flex; justify-content: space-between; align-items: center;">
          <h2 style="margin: 0; font-size: 15px; font-weight: 500;" id="gameStoryTitle">New Scorebook Story</h2>
          <button onclick="closeGameStory()" style="background: none; border: none; color: #ccc; font-size: 20px; cursor: pointer; line-height: 1;">&times;</button>
        </div>
        
        <!-- Step 1: Select Game -->
        <div id="gsStep1" style="padding: 16px;">
          <!-- Date Nav + Search + Gender -->
          <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 12px;">
            <button onclick="gsPrevDay()" style="background: #fff; border: 1px solid #ccc; border-radius: 4px; padding: 6px 10px; cursor: pointer; font-size: 14px;">‚óÄ</button>
            <div id="gsCurrentDate" style="font-size: 13px; font-weight: 600; min-width: 120px; text-align: center;"></div>
            <button onclick="gsNextDay()" style="background: #fff; border: 1px solid #ccc; border-radius: 4px; padding: 6px 10px; cursor: pointer; font-size: 14px;">‚ñ∂</button>
            <input type="text" id="gsGameSearch" placeholder="Search..." oninput="filterGameList()" style="flex: 1; padding: 6px 10px; border: 1px solid #ccc; border-radius: 4px; font-size: 13px;">
            <div style="display: flex; gap: 8px; font-size: 11px; white-space: nowrap; flex-wrap: wrap;">
              <label style="display: flex; align-items: center; gap: 3px; cursor: pointer;">
                <input type="radio" name="gsGender" value="Boys" checked onchange="filterGameList()"> Boys
              </label>
              <label style="display: flex; align-items: center; gap: 3px; cursor: pointer;">
                <input type="radio" name="gsGender" value="Girls" onchange="filterGameList()"> Girls
              </label>
              <label style="display: flex; align-items: center; gap: 3px; cursor: pointer;">
                <input type="radio" name="gsGender" value="Men" onchange="filterGameList()"> Men
              </label>
              <label style="display: flex; align-items: center; gap: 3px; cursor: pointer;">
                <input type="radio" name="gsGender" value="Women" onchange="filterGameList()"> Women
              </label>
            </div>
          </div>
          <div id="gsGameList" class="gs-game-list">
            <!-- Games populated here -->
          </div>
        </div>
        
        <!-- Step 2: Box Score Entry -->
        <div id="gsStep2" style="display: none; padding: 16px;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <button onclick="backToGameSelect()" style="background: #f5f5f5; border: none; padding: 8px 15px; border-radius: 6px; cursor: pointer;">‚Üê Back</button>
            <h3 style="margin: 0; font-size: 16px; color: #333;" id="gsMatchupTitle">Game</h3>
            <div style="width: 80px;"></div>
          </div>
          
          <!-- Quarter Scores -->
          <div style="background: #fff; border: 1px solid #ddd; border-radius: 6px; padding: 12px; margin-bottom: 12px;">
            <span style="font-weight: 600; font-size: 12px; display: block; margin-bottom: 8px;">Quarter Scores</span>
            <table style="width: 100%; font-size: 12px; border-collapse: collapse;">
              <thead>
                <tr style="background: #f5f5f5;">
                  <th style="padding: 6px; text-align: left; width: 120px;">Team</th>
                  <th style="padding: 6px; width: 40px;">Q1</th>
                  <th style="padding: 6px; width: 40px;">Q2</th>
                  <th style="padding: 6px; width: 40px;">Q3</th>
                  <th style="padding: 6px; width: 40px;">Q4</th>
                  <th id="otHeaders" style="padding: 0;"></th>
                  <th style="padding: 6px; width: 40px;"><button onclick="addOT()" style="background: #e0e0e0; border: none; padding: 3px 6px; border-radius: 3px; cursor: pointer; font-size: 10px;">+OT</button></th>
                  <th style="padding: 6px; width: 50px;">Final</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td id="gsAwayName" style="padding: 6px; font-weight: 500;">Away</td>
                  <td><input type="text" id="gsAwayQ1" class="quarter-input" onchange="calcGameFinal('away')"></td>
                  <td><input type="text" id="gsAwayQ2" class="quarter-input" onchange="calcGameFinal('away')"></td>
                  <td><input type="text" id="gsAwayQ3" class="quarter-input" onchange="calcGameFinal('away')"></td>
                  <td><input type="text" id="gsAwayQ4" class="quarter-input" onchange="calcGameFinal('away')"></td>
                  <td id="gsAwayOT" style="padding: 0;"></td>
                  <td></td>
                  <td><input type="text" id="gsAwayFinal" class="quarter-input" style="background: #e8f5e9; font-weight: bold;" readonly></td>
                </tr>
                <tr>
                  <td id="gsHomeName" style="padding: 6px; font-weight: 500;">Home</td>
                  <td><input type="text" id="gsHomeQ1" class="quarter-input" onchange="calcGameFinal('home')"></td>
                  <td><input type="text" id="gsHomeQ2" class="quarter-input" onchange="calcGameFinal('home')"></td>
                  <td><input type="text" id="gsHomeQ3" class="quarter-input" onchange="calcGameFinal('home')"></td>
                  <td><input type="text" id="gsHomeQ4" class="quarter-input" onchange="calcGameFinal('home')"></td>
                  <td id="gsHomeOT" style="padding: 0;"></td>
                  <td></td>
                  <td><input type="text" id="gsHomeFinal" class="quarter-input" style="background: #e8f5e9; font-weight: bold;" readonly></td>
                </tr>
              </tbody>
            </table>
          </div>
          
          <!-- Team Rosters Stacked - Away (Road) on top -->
          <div style="margin-bottom: 15px;">
            <!-- Away Team -->
            <div style="background: #fff; border: 1px solid #ddd; border-radius: 6px; padding: 12px; margin-bottom: 12px;">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                <span style="font-weight: 600; font-size: 13px;" id="gsAwayLabel">Away</span>
                <span style="font-size: 11px; color: #666;">Pts: <strong id="gsAwayPtsTotal">0</strong> <span id="gsAwayMatch"></span></span>
              </div>
              <div style="display: grid; grid-template-columns: 1fr 45px 45px; gap: 5px; font-size: 10px; color: #888; margin-bottom: 5px; padding: 0 5px;">
                <span>Player</span>
                <span style="text-align: center;">Pts</span>
                <span style="text-align: center;">3FG</span>
              </div>
              <div id="gsAwayRoster">
                <!-- Roster rows -->
              </div>
              <button onclick="addBlankPlayer('away')" style="width: 100%; margin-top: 8px; background: #e0e0e0; border: none; padding: 6px; border-radius: 4px; cursor: pointer; font-size: 11px;">+ Add Player</button>
            </div>
            
            <!-- Home Team -->
            <div style="background: #fff; border: 1px solid #ddd; border-radius: 6px; padding: 12px;">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                <span style="font-weight: 600; font-size: 13px;" id="gsHomeLabel">Home</span>
                <span style="font-size: 11px; color: #666;">Pts: <strong id="gsHomePtsTotal">0</strong> <span id="gsHomeMatch"></span></span>
              </div>
              <div style="display: grid; grid-template-columns: 1fr 45px 45px; gap: 5px; font-size: 10px; color: #888; margin-bottom: 5px; padding: 0 5px;">
                <span>Player</span>
                <span style="text-align: center;">Pts</span>
                <span style="text-align: center;">3FG</span>
              </div>
              <div id="gsHomeRoster">
                <!-- Roster rows -->
              </div>
              <button onclick="addBlankPlayer('home')" style="width: 100%; margin-top: 8px; background: #e0e0e0; border: none; padding: 6px; border-radius: 4px; cursor: pointer; font-size: 11px;">+ Add Player</button>
            </div>
          </div>
          
          <!-- Notes -->
          <div style="margin-bottom: 12px;">
            <label style="font-size: 12px; font-weight: 600; color: #333; display: block; margin-bottom: 5px;">Game Notes (optional)</label>
            <textarea id="gsNotes" style="width: 100%; min-height: 50px; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 13px;" placeholder="Any storylines, key plays, milestones..."></textarea>
          </div>
          
          <!-- Photographers -->
          <div id="gsPhotographers" style="margin-bottom: 15px; padding: 10px 12px; background: #fff; border: 1px solid #ddd; border-radius: 6px; font-size: 12px; display: none;">
            <span style="color: #666; font-weight: 500;">üì∑ Photo Credit:</span>
            <div id="gsPhotogCheckboxes" style="margin-top: 8px;"></div>
          </div>
          
          <!-- Generate Button -->
          <button onclick="generateGameStory()" id="gsGenerateBtn" style="width: 100%; background: #444; color: white; border: none; padding: 15px; border-radius: 6px; font-size: 14px; font-weight: 600; cursor: pointer;">
            ‚ú® Generate Story
          </button>
        </div>
        
      </div>
    </div>
    
    <!-- Boxscore Story Modal (for collegiate games with full stats) -->
    <div id="boxscoreStoryModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 1000; overflow-y: auto;">
      <div style="max-width: 600px; margin: 30px auto; background: #f5f5f5; border-radius: 10px; overflow: hidden; box-shadow: 0 4px 20px rgba(0,0,0,0.3);">
        
        <!-- Modal Header -->
        <div style="background: #1565c0; color: white; padding: 12px 16px; display: flex; justify-content: space-between; align-items: center;">
          <h2 style="margin: 0; font-size: 15px; font-weight: 500;" id="boxscoreStoryTitle">New Boxscore Story</h2>
          <button onclick="closeBoxscoreStory()" style="background: none; border: none; color: #ccc; font-size: 20px; cursor: pointer; line-height: 1;">&times;</button>
        </div>
        
        <!-- Step 1: Select Game -->
        <div id="bsStep1" style="padding: 16px;">
          <!-- Date Nav + Search + Gender -->
          <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 12px;">
            <button onclick="bsPrevDay()" style="background: #fff; border: 1px solid #ccc; border-radius: 4px; padding: 6px 10px; cursor: pointer; font-size: 14px;">‚óÄ</button>
            <div id="bsCurrentDate" style="font-size: 13px; font-weight: 600; min-width: 120px; text-align: center;"></div>
            <button onclick="bsNextDay()" style="background: #fff; border: 1px solid #ccc; border-radius: 4px; padding: 6px 10px; cursor: pointer; font-size: 14px;">‚ñ∂</button>
            <input type="text" id="bsGameSearch" placeholder="Search..." oninput="filterBsGameList()" style="flex: 1; padding: 6px 10px; border: 1px solid #ccc; border-radius: 4px; font-size: 13px;">
            <div style="display: flex; gap: 10px; font-size: 12px; white-space: nowrap;">
              <label style="display: flex; align-items: center; gap: 3px; cursor: pointer;">
                <input type="radio" name="bsGender" value="Boys" checked onchange="filterBsGameList()"> Boys
              </label>
              <label style="display: flex; align-items: center; gap: 3px; cursor: pointer;">
                <input type="radio" name="bsGender" value="Girls" onchange="filterBsGameList()"> Girls
              </label>
            </div>
          </div>
          <div id="bsGameList" class="gs-game-list">
            <!-- Games populated here -->
          </div>
        </div>
        
        <!-- Step 2: Paste Boxscore -->
        <div id="bsStep2" style="display: none; padding: 16px;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
            <button onclick="backToBsGameSelect()" style="background: #f5f5f5; border: none; padding: 8px 15px; border-radius: 6px; cursor: pointer;">‚Üê Back</button>
            <h3 style="margin: 0; font-size: 16px; color: #333;" id="bsMatchupTitle">Game</h3>
            <div style="width: 80px;"></div>
          </div>
          
          <!-- Boxscore Paste Area -->
          <div style="margin-bottom: 15px;">
            <label style="font-size: 12px; font-weight: 600; color: #333; display: block; margin-bottom: 5px;">Paste Full Boxscore</label>
            <textarea id="bsBoxscoreText" style="width: 100%; min-height: 200px; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 12px; font-family: monospace; resize: vertical;" placeholder="Paste the complete boxscore here including:
- Team names and final score
- Quarter/half scores
- Individual player stats (MIN, FG, 3PT, FT, REB, AST, STL, BLK, TO, PTS)
- Team totals

Example:
TEAM A 75, Team B 68

Player        MIN  FG    3PT   FT    REB  AST  STL  BLK  TO  PTS
J. Smith      32   8-14  2-5   4-4   7    3    2    0    2   22
..."></textarea>
            <small style="color: #888; font-size: 11px;">Copy/paste from official box score. Include all available stats.</small>
          </div>
          
          <!-- Game Notes -->
          <div style="margin-bottom: 15px;">
            <label style="font-size: 12px; font-weight: 600; color: #333; display: block; margin-bottom: 5px;">Game Notes (optional)</label>
            <textarea id="bsNotes" style="width: 100%; min-height: 60px; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 13px;" placeholder="Any storylines, key plays, milestones, context..."></textarea>
          </div>
          
          <!-- Photographers -->
          <div id="bsPhotographers" style="margin-bottom: 15px; padding: 10px 12px; background: #fff; border: 1px solid #ddd; border-radius: 6px; font-size: 12px; display: none;">
            <span style="color: #666; font-weight: 500;">üì∑ Photo Credit:</span>
            <div id="bsPhotogCheckboxes" style="margin-top: 8px;"></div>
          </div>
          
          <!-- Generate Button -->
          <button onclick="generateBoxscoreStory()" id="bsGenerateBtn" style="width: 100%; background: #1565c0; color: white; border: none; padding: 15px; border-radius: 6px; font-size: 14px; font-weight: 600; cursor: pointer;">
            ‚ú® Generate Story
          </button>
        </div>
        
      </div>
    </div>
    
    <style>
      .quarter-input {
        width: 45px;
        padding: 6px;
        text-align: center;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 13px;
        -moz-appearance: textfield;
      }
      .quarter-input::-webkit-outer-spin-button,
      .quarter-input::-webkit-inner-spin-button {
        -webkit-appearance: none;
        margin: 0;
      }
      .roster-row {
        display: grid;
        grid-template-columns: 1fr 50px 50px;
        gap: 5px;
        margin-bottom: 4px;
        align-items: center;
      }
      .roster-row input {
        padding: 6px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 12px;
        -moz-appearance: textfield;
      }
      .roster-row input::-webkit-outer-spin-button,
      .roster-row input::-webkit-inner-spin-button {
        -webkit-appearance: none;
        margin: 0;
      }
      .roster-row .player-name {
        font-size: 12px;
        color: #333;
        padding: 6px;
        background: #fff;
        border-radius: 4px;
      }
      .roster-row input[type="text"] {
        text-align: center;
      }
      .game-row {
        padding: 12px 15px;
        border-bottom: 1px solid #eee;
        cursor: pointer;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      .game-row:hover {
        background: #f5f5f5;
      }
      .game-row-hover:hover {
        background: #e0e0e0;
      }
      .game-row .teams {
        font-size: 14px;
        font-weight: 500;
      }
      .game-row .meta {
        font-size: 12px;
        color: #888;
      }
      .gs-game-list {
        max-height: 350px;
        overflow-y: auto;
        background: #fff;
        border: 1px solid #ddd;
        border-radius: 6px;
        -ms-overflow-style: none;
        scrollbar-width: none;
      }
      .gs-game-list::-webkit-scrollbar {
        display: none;
      }
      .gs-roster-list {
        max-height: 250px;
        overflow-y: auto;
        -ms-overflow-style: none;
        scrollbar-width: none;
      }
      .gs-roster-list::-webkit-scrollbar {
        display: none;
      }
    </style>
    <!-- Article Editor Panel -->
    <div class="panel editor-panel" id="editorPanel">
      <div class="editor-header">
        <h2 id="editorTitle">New Article</h2>
        <div class="editor-actions">
          <button class="btn-back" onclick="closeEditor()">‚Üê Back</button>
          <button class="btn-save" onclick="saveArticle()">Save Draft</button>
          <button class="btn-publish" onclick="publishArticle()">Publish</button>
        </div>
      </div>
      
      <div class="form-grid">
        <div class="form-main">
          <div class="form-group">
            <label>Headline</label>
            <input type="text" id="articleTitle" placeholder="Enter headline...">
          </div>
          
          <div class="form-group">
            <label>Story</label>
            <textarea id="articleContent" placeholder="Write your article..."></textarea>
          </div>
          
          <div class="form-group">
            <label>Excerpt</label>
            <textarea id="articleExcerpt" placeholder="Brief summary for previews..." style="min-height: 80px;"></textarea>
            <small>Used for social media and article previews</small>
          </div>
        </div>
        
        <div class="form-sidebar">
          <div class="sidebar-card">
            <h4>üì∏ Link to Game</h4>
            <input type="text" id="gameSearch" placeholder="Search games..." style="width: 100%; margin-bottom: 10px;" oninput="searchGames(this.value)">
            <div class="game-selector" id="gameSelector">
              <div class="loading">Loading games...</div>
            </div>
            <input type="hidden" id="selectedGameId">
          </div>
          
          <div class="sidebar-card" style="background: #e3f2fd;">
            <div style="text-align: center; padding: 15px; color: #1565c0;">
              <div style="font-size: 20px; margin-bottom: 8px;">üìù</div>
              <p style="font-size: 12px; margin: 0;">Use <strong>+ Game Story</strong> button to quickly create game recaps with box scores</p>
            </div>
          </div>
          
          <div class="sidebar-card">
            <h4>üì∑ Media</h4>
            <div class="form-group">
              <label>SmugMug Gallery</label>
              <div style="display: flex; gap: 8px;">
                <input type="text" id="smugmugUrl" placeholder="https://ball603.smugmug.com/..." style="flex: 1;">
                <button type="button" class="btn-browse" onclick="openSmugMugBrowser()">Browse</button>
              </div>
              <div id="selectedAlbumPreview" style="margin-top: 8px; display: none;">
                <img id="albumThumbnail" style="width: 100%; border-radius: 4px; margin-bottom: 5px;">
                <small id="albumInfo" style="color: #666;"></small>
              </div>
            </div>
            <div class="form-group">
              <label>Photographer Credit</label>
              <input type="text" id="photographerCredit" placeholder="Photo by...">
            </div>
          </div>
          
          <div class="sidebar-card">
            <h4>üì± Social Media</h4>
            <div class="social-buttons">
              <button class="btn-social facebook" onclick="postToSocial('facebook')" id="btnFacebook">
                üìò Post to Facebook
                <span class="posted" id="facebookPosted" style="display: none;">‚úì Posted</span>
              </button>
              <button class="btn-social instagram" onclick="postToSocial('instagram')" id="btnInstagram">
                üì∏ Copy for Instagram
                <span class="posted" id="instagramPosted" style="display: none;">‚úì Copied</span>
              </button>
              <button class="btn-social twitter" onclick="postToSocial('twitter')" id="btnTwitter">
                ùïè Post to X
                <span class="posted" id="twitterPosted" style="display: none;">‚úì Posted</span>
              </button>
            </div>
            <small style="display: block; margin-top: 10px; color: #999;">Social posting available after publishing</small>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Sponsors Panel -->
    <div class="panel" id="sponsorsPanel" style="display: none;">
      <div class="toolbar">
        <button class="btn-new" onclick="newSponsor()">
          <span>+</span> Add Sponsor
        </button>
      </div>
      <div id="sponsorList">
        <div class="empty-state">
          <p>No sponsors yet</p>
        </div>
      </div>
    </div>
    
    <!-- Products Panel -->
    <div class="panel" id="productsPanel" style="display: none;">
      <div class="toolbar">
        <button class="btn-new" onclick="newProduct()">
          <span>+</span> Add Product
        </button>
      </div>
      <div id="productList">
        <div class="empty-state">
          <p>No products yet</p>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Toast -->
  <div class="toast" id="toast"></div>
  
  <!-- SmugMug Browser Modal -->
  <div class="modal-overlay" id="smugmugModal">
    <div class="modal">
      <div class="modal-header">
        <h3>üì∏ Select SmugMug Gallery</h3>
        <button class="modal-close" onclick="closeSmugMugBrowser()">&times;</button>
      </div>
      <div class="modal-search">
        <input type="text" id="albumSearch" placeholder="Search albums..." oninput="searchAlbums(this.value)">
      </div>
      <div class="modal-body">
        <div class="album-grid" id="albumGrid">
          <div class="loading">Loading albums...</div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn-modal btn-modal-cancel" onclick="closeSmugMugBrowser()">Cancel</button>
        <button class="btn-modal btn-modal-select" id="btnSelectAlbum" onclick="selectSmugMugAlbum()" disabled>Select Album</button>
      </div>
    </div>
  </div>

  <script src="rosters_data.js"></script>
  <script>
    // Supabase config
    const SUPABASE_URL = 'https://suncdkxfqkwwnmhosxcf.supabase.co';
    const SUPABASE_ANON_KEY = 'sb_publishable_hHSpgZPD327r11GaQG9iHw_uZbuaWmF';
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    
    // CMS Password
    const CMS_PASSWORD = 'Gr@niteSt@teHoops';
    
    // State
    let articles = [];
    let games = [];
    let currentArticle = null;
    let selectedGame = null;
    
    // Generated social posts (populated by story generators)
    let generatedSocialPosts = {
      facebookPost: null,
      instagramPost: null,
      twitterPost: null
    };
    
    // Login
    function login() {
      const password = document.getElementById('loginPassword').value;
      if (password === CMS_PASSWORD) {
        sessionStorage.setItem('cms_auth', 'true');
        showApp();
      } else {
        document.getElementById('loginError').textContent = 'Incorrect password';
        document.getElementById('loginError').style.display = 'block';
      }
    }
    
    function logout() {
      sessionStorage.removeItem('cms_auth');
      location.reload();
    }
    
    function showApp() {
      document.getElementById('loginScreen').style.display = 'none';
      document.getElementById('mainHeader').style.display = 'block';
      document.getElementById('mainContainer').style.display = 'block';
      loadArticles();
      loadGames();
    }
    
    // Check auth on load
    if (sessionStorage.getItem('cms_auth') === 'true') {
      showApp();
    }
    
    // Tabs
    function showTab(tab) {
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      event.target.classList.add('active');
      
      document.getElementById('articlesPanel').style.display = tab === 'articles' ? 'block' : 'none';
      document.getElementById('sponsorsPanel').style.display = tab === 'sponsors' ? 'block' : 'none';
      document.getElementById('productsPanel').style.display = tab === 'products' ? 'block' : 'none';
      document.getElementById('editorPanel').style.display = 'none';
    }
    
    // Load articles
    async function loadArticles() {
      const { data, error } = await supabase
        .from('articles')
        .select('*')
        .order('created_at', { ascending: false });
      
      if (error) {
        console.error('Error loading articles:', error);
        showToast('Error loading articles', 'error');
        return;
      }
      
      articles = data || [];
      renderArticles();
    }
    
    function renderArticles(filter = '') {
      const list = document.getElementById('articleList');
      const filtered = articles.filter(a => 
        a.title.toLowerCase().includes(filter.toLowerCase())
      );
      
      if (filtered.length === 0) {
        list.innerHTML = `
          <div class="article-row header">
            <div>Title</div>
            <div>Status</div>
            <div>Date</div>
            <div>Actions</div>
          </div>
          <div class="empty-state">
            <p>No articles found</p>
            <button class="btn-new" onclick="newArticle()">Create your first article</button>
          </div>
        `;
        return;
      }
      
      list.innerHTML = `
        <div class="article-row header">
          <div>Title</div>
          <div>Status</div>
          <div>Date</div>
          <div>Actions</div>
        </div>
        ${filtered.map(article => `
          <div class="article-row">
            <div class="article-title" onclick="editArticle('${article.id}')">${article.title || 'Untitled'}</div>
            <div><span class="article-status ${article.status}">${article.status}</span></div>
            <div class="article-date">${formatDate(article.created_at)}</div>
            <div class="article-actions">
              <button class="btn-edit" onclick="editArticle('${article.id}')">Edit</button>
              <button class="btn-delete" onclick="deleteArticle('${article.id}')">Delete</button>
            </div>
          </div>
        `).join('')}
      `;
    }
    
    function filterArticles(value) {
      renderArticles(value);
    }
    
    function formatDate(dateStr) {
      if (!dateStr) return '-';
      const date = new Date(dateStr);
      return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
    }
    
    // Load games for selector
    async function loadGames() {
      try {
        const response = await fetch('/.netlify/functions/get-games');
        const data = await response.json();
        games = data.games || [];
        renderGameSelector();
      } catch (err) {
        console.error('Error loading games:', err);
        document.getElementById('gameSelector').innerHTML = '<div style="padding: 10px; color: #999;">Could not load games</div>';
      }
    }
    
    function renderGameSelector(filter = '') {
      const selector = document.getElementById('gameSelector');
      
      let filtered = games.filter(g => {
        if (filter) {
          const search = filter.toLowerCase();
          return g.away?.toLowerCase().includes(search) || 
                 g.home?.toLowerCase().includes(search);
        }
        return true;
      }).slice(0, 20);
      
      if (filtered.length === 0) {
        selector.innerHTML = '<div style="padding: 10px; color: #999;">No games found</div>';
        return;
      }
      
      selector.innerHTML = filtered.map(g => `
        <div class="game-option ${g.game_id === document.getElementById('selectedGameId').value ? 'selected' : ''}" 
             onclick="selectGame('${g.game_id}', '${g.away} @ ${g.home}')">
          <div class="teams">${g.away || 'TBD'} @ ${g.home || 'TBD'}</div>
          <div class="meta">${g.date} ‚Ä¢ ${g.gender} ${g.division || ''}</div>
        </div>
      `).join('');
    }
    
    function searchGames(value) {
      renderGameSelector(value);
    }
    
    function selectGame(gameId, label) {
      document.getElementById('selectedGameId').value = gameId;
      selectedGame = games.find(g => g.game_id === gameId) || null;
      renderGameSelector();
    }
    
    // Game Story Modal Functions
    let gsSelectedGame = null;
    let otCount = 0;
    let gsSelectedDate = new Date();
    
    function newGameStory() {
      gsSelectedGame = null;
      otCount = 0;
      gsSelectedDate = new Date(); // Start with today
      document.getElementById('gameStoryModal').style.display = 'block';
      document.getElementById('gsStep1').style.display = 'block';
      document.getElementById('gsStep2').style.display = 'none';
      document.getElementById('gsGameSearch').value = '';
      updateGsDateDisplay();
      populateGameList();
      document.body.style.overflow = 'hidden';
    }
    
    function closeGameStory() {
      document.getElementById('gameStoryModal').style.display = 'none';
      document.body.style.overflow = 'auto';
    }
    
    function formatDateShort(date) {
      const months = ['Jan.', 'Feb.', 'Mar.', 'Apr.', 'May', 'June', 'July', 'Aug.', 'Sept.', 'Oct.', 'Nov.', 'Dec.'];
      return `${months[date.getMonth()]} ${date.getDate()}, ${date.getFullYear()}`;
    }
    
    function formatGameDate(dateStr) {
      if (!dateStr) return '';
      const date = new Date(dateStr + 'T12:00:00');
      return formatDateShort(date);
    }
    
    function updateGsDateDisplay() {
      document.getElementById('gsCurrentDate').textContent = formatDateShort(gsSelectedDate);
    }
    
    function gsPrevDay() {
      gsSelectedDate.setDate(gsSelectedDate.getDate() - 1);
      updateGsDateDisplay();
      populateGameList();
    }
    
    function gsNextDay() {
      gsSelectedDate.setDate(gsSelectedDate.getDate() + 1);
      updateGsDateDisplay();
      populateGameList();
    }
    
    function getDateString(date) {
      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const day = String(date.getDate()).padStart(2, '0');
      return `${year}-${month}-${day}`;
    }
    
    function populateGameList() {
      const container = document.getElementById('gsGameList');
      
      // Check if games have loaded
      if (!games || games.length === 0) {
        container.innerHTML = '<div style="padding: 20px; text-align: center; color: #888;">Loading games...</div>';
        setTimeout(() => {
          if (games && games.length > 0) populateGameList();
        }, 500);
        return;
      }
      
      const searchFilter = document.getElementById('gsGameSearch').value.toLowerCase();
      const selectedDateStr = getDateString(gsSelectedDate);
      const selectedGender = document.querySelector('input[name="gsGender"]:checked')?.value || 'Boys';
      
      // Filter by selected date, gender, and search
      let filtered = games.filter(g => {
        // Must match selected date
        if (g.date !== selectedDateStr) return false;
        // Must match selected gender
        if (g.gender !== selectedGender) return false;
        // Filter by search
        if (searchFilter) {
          const searchStr = `${g.away} ${g.home}`.toLowerCase();
          if (!searchStr.includes(searchFilter)) return false;
        }
        return true;
      });
      
      // Sort by time, then gender
      filtered.sort((a, b) => {
        if (a.time !== b.time) return (a.time || '').localeCompare(b.time || '');
        return (a.gender || '').localeCompare(b.gender || '');
      });
      
      if (filtered.length === 0) {
        const message = searchFilter 
          ? `No ${selectedGender.toLowerCase()} games found for "${searchFilter}"` 
          : `No ${selectedGender.toLowerCase()} games on this date`;
        container.innerHTML = `<div style="padding: 30px; text-align: center; color: #888; font-size: 13px;">${message}</div>`;
        return;
      }
      
      // Build simple list
      let html = '';
      
      filtered.forEach(g => {
        const hasRecap = g.recap_link && g.recap_link.trim() !== '';
        const rowStyle = hasRecap 
          ? 'background: #f9f9f9; color: #bbb; cursor: not-allowed;' 
          : 'cursor: pointer;';
        const hoverClass = hasRecap ? '' : 'game-row-hover';
        const onclick = hasRecap ? '' : `onclick="selectGameForStory('${g.game_id}')"`;
        
        html += `
          <div class="${hoverClass}" style="padding: 10px 12px; border-bottom: 1px solid #eee; ${rowStyle}" ${onclick}>
            <span style="font-size: 13px;">${g.away} @ ${g.home}${hasRecap ? ' <span style="font-size: 10px; color: #aaa;">(done)</span>' : ''}</span>
          </div>`;
      });
      
      container.innerHTML = html;
    }
    
    function filterGameList() {
      populateGameList();
    }
    
    function selectGameForStory(gameId) {
      gsSelectedGame = games.find(g => g.game_id === gameId);
      if (!gsSelectedGame) return;
      
      // Move to step 2
      document.getElementById('gsStep1').style.display = 'none';
      document.getElementById('gsStep2').style.display = 'block';
      
      // Set matchup title
      document.getElementById('gsMatchupTitle').textContent = `${gsSelectedGame.away} @ ${gsSelectedGame.home}`;
      document.getElementById('gsAwayName').textContent = gsSelectedGame.away;
      document.getElementById('gsHomeName').textContent = gsSelectedGame.home;
      document.getElementById('gsAwayLabel').textContent = gsSelectedGame.away;
      document.getElementById('gsHomeLabel').textContent = gsSelectedGame.home;
      
      // Clear quarter scores
      ['gsAwayQ1', 'gsAwayQ2', 'gsAwayQ3', 'gsAwayQ4', 'gsAwayFinal', 
       'gsHomeQ1', 'gsHomeQ2', 'gsHomeQ3', 'gsHomeQ4', 'gsHomeFinal'].forEach(id => {
        document.getElementById(id).value = '';
      });
      
      // Clear OT
      otCount = 0;
      document.getElementById('otHeaders').innerHTML = '';
      document.getElementById('gsAwayOT').innerHTML = '';
      document.getElementById('gsHomeOT').innerHTML = '';
      
      // Populate rosters
      const rosters = getTeamRosters();
      populateGSRoster('away', rosters.away, gsSelectedGame.away);
      populateGSRoster('home', rosters.home, gsSelectedGame.home);
      
      // Clear notes
      document.getElementById('gsNotes').value = '';
      
      // Show photographers if assigned
      console.log('Game data:', gsSelectedGame.game_id, 'photog1:', gsSelectedGame.photog1, 'photog2:', gsSelectedGame.photog2);
      const photogs = [gsSelectedGame.photog1, gsSelectedGame.photog2].filter(p => p && p.trim());
      const photogDiv = document.getElementById('gsPhotographers');
      const checkboxContainer = document.getElementById('gsPhotogCheckboxes');
      if (photogs.length > 0) {
        checkboxContainer.innerHTML = photogs.map((p, i) => `
          <label style="display: flex; align-items: center; gap: 6px; margin-bottom: 4px; cursor: pointer;">
            <input type="checkbox" name="gsPhotog" value="${p}" checked style="cursor: pointer;">
            <span>${p}</span>
          </label>
        `).join('');
        photogDiv.style.display = 'block';
      } else {
        photogDiv.style.display = 'none';
      }
      
      // Reset totals
      updateGSPointsTotal('away');
      updateGSPointsTotal('home');
    }
    
    function getTeamRosters() {
      // Works for both game story modal and regular article editor
      const game = gsSelectedGame || selectedGame;
      if (!game || typeof ROSTERS_DATA === 'undefined') return { away: null, home: null };
      
      const gender = game.gender || 'Boys';
      const awayName = game.away;
      const homeName = game.home;
      
      let awayRoster = null;
      let homeRoster = null;
      
      if (ROSTERS_DATA.rosters) {
        awayRoster = ROSTERS_DATA.rosters.find(r => 
          r.gender === gender && 
          (r.school === awayName || awayName.includes(r.school) || r.school.includes(awayName))
        );
        homeRoster = ROSTERS_DATA.rosters.find(r => 
          r.gender === gender && 
          (r.school === homeName || homeName.includes(r.school) || r.school.includes(homeName))
        );
      }
      
      return { away: awayRoster, home: homeRoster };
    }
    
    function populateGSRoster(team, roster, teamName) {
      const container = document.getElementById(`gs${team.charAt(0).toUpperCase() + team.slice(1)}Roster`);
      container.innerHTML = '';
      
      if (roster && roster.players && roster.players.length > 0) {
        roster.players.forEach(player => {
          const row = document.createElement('div');
          row.className = 'roster-row';
          row.innerHTML = `
            <span class="player-name" data-player="${player.name}" data-team="${team}">#${player.number} ${player.name}</span>
            <input type="text" class="gs-pts" data-player="${player.name}" data-team="${team}" placeholder="" onchange="updateGSPointsTotal('${team}')">
            <input type="text" class="gs-3fg" data-player="${player.name}" data-team="${team}" placeholder="">
          `;
          container.appendChild(row);
        });
      } else {
        // No roster - add blank rows
        for (let i = 0; i < 12; i++) {
          addBlankPlayer(team);
        }
      }
    }
    
    function addBlankPlayer(team) {
      const container = document.getElementById(`gs${team.charAt(0).toUpperCase() + team.slice(1)}Roster`);
      const row = document.createElement('div');
      row.className = 'roster-row';
      row.innerHTML = `
        <input type="text" class="gs-name" data-team="${team}" placeholder="Player name" style="text-align: left;">
        <input type="text" class="gs-pts" data-team="${team}" placeholder="" onchange="updateGSPointsTotal('${team}')">
        <input type="text" class="gs-3fg" data-team="${team}" placeholder="">
      `;
      container.appendChild(row);
    }
    
    function addOT() {
      otCount++;
      
      // Add header
      const headerCell = document.getElementById('otHeaders');
      headerCell.innerHTML += `<th style="padding: 8px; width: 50px;">OT${otCount > 1 ? otCount : ''}</th>`;
      
      // Add away input
      const awayOT = document.getElementById('gsAwayOT');
      awayOT.innerHTML += `<td><input type="text" id="gsAwayOT${otCount}" class="quarter-input" onchange="calcGameFinal('away')"></td>`;
      
      // Add home input
      const homeOT = document.getElementById('gsHomeOT');
      homeOT.innerHTML += `<td><input type="text" id="gsHomeOT${otCount}" class="quarter-input" onchange="calcGameFinal('home')"></td>`;
    }
    
    function calcGameFinal(team) {
      const prefix = team === 'away' ? 'gsAway' : 'gsHome';
      let total = 0;
      
      // Add quarters
      for (let q = 1; q <= 4; q++) {
        total += parseInt(document.getElementById(`${prefix}Q${q}`).value) || 0;
      }
      
      // Add OT periods
      for (let ot = 1; ot <= otCount; ot++) {
        const otInput = document.getElementById(`${prefix}OT${ot}`);
        if (otInput) {
          total += parseInt(otInput.value) || 0;
        }
      }
      
      document.getElementById(`${prefix}Final`).value = total || '';
      updateGSPointsTotal(team);
    }
    
    function updateGSPointsTotal(team) {
      const container = document.getElementById(`gs${team.charAt(0).toUpperCase() + team.slice(1)}Roster`);
      const ptsInputs = container.querySelectorAll('.gs-pts');
      let total = 0;
      
      ptsInputs.forEach(input => {
        total += parseInt(input.value) || 0;
      });
      
      document.getElementById(`gs${team.charAt(0).toUpperCase() + team.slice(1)}PtsTotal`).textContent = total;
      
      const prefix = team === 'away' ? 'gsAway' : 'gsHome';
      const final = parseInt(document.getElementById(`${prefix}Final`).value) || 0;
      const matchSpan = document.getElementById(`gs${team.charAt(0).toUpperCase() + team.slice(1)}Match`);
      
      if (!final) {
        matchSpan.textContent = '';
        matchSpan.style.color = '#888';
      } else if (total === final) {
        matchSpan.textContent = '‚úì';
        matchSpan.style.color = '#2e7d32';
      } else {
        matchSpan.textContent = `(off by ${Math.abs(final - total)})`;
        matchSpan.style.color = '#c62828';
      }
    }
    
    function backToGameSelect() {
      document.getElementById('gsStep1').style.display = 'block';
      document.getElementById('gsStep2').style.display = 'none';
    }
    
    function collectGSScorers(team) {
      const container = document.getElementById(`gs${team.charAt(0).toUpperCase() + team.slice(1)}Roster`);
      const scorers = [];
      
      container.querySelectorAll('.roster-row').forEach(row => {
        const nameEl = row.querySelector('.player-name');
        const nameInput = row.querySelector('.gs-name');
        const ptsInput = row.querySelector('.gs-pts');
        const threeFgInput = row.querySelector('.gs-3fg');
        
        let name = '';
        if (nameEl) {
          name = nameEl.getAttribute('data-player');
        } else if (nameInput) {
          name = nameInput.value.trim();
        }
        
        const pts = parseInt(ptsInput?.value) || 0;
        const threeFg = parseInt(threeFgInput?.value) || 0;
        
        if (name && pts > 0) {
          scorers.push({ name, points: pts, threePointers: threeFg });
        }
      });
      
      // Sort by points descending
      scorers.sort((a, b) => b.points - a.points);
      return scorers;
    }
    
    async function generateGameStory() {
      const awayFinal = parseInt(document.getElementById('gsAwayFinal').value) || 0;
      const homeFinal = parseInt(document.getElementById('gsHomeFinal').value) || 0;
      
      if (!awayFinal && !homeFinal) {
        showToast('Please enter quarter scores first', 'error');
        return;
      }
      
      // Collect quarters + OT
      const awayQuarters = [
        parseInt(document.getElementById('gsAwayQ1').value) || 0,
        parseInt(document.getElementById('gsAwayQ2').value) || 0,
        parseInt(document.getElementById('gsAwayQ3').value) || 0,
        parseInt(document.getElementById('gsAwayQ4').value) || 0
      ];
      const homeQuarters = [
        parseInt(document.getElementById('gsHomeQ1').value) || 0,
        parseInt(document.getElementById('gsHomeQ2').value) || 0,
        parseInt(document.getElementById('gsHomeQ3').value) || 0,
        parseInt(document.getElementById('gsHomeQ4').value) || 0
      ];
      
      // Add OT if any
      for (let ot = 1; ot <= otCount; ot++) {
        const awayOT = parseInt(document.getElementById(`gsAwayOT${ot}`)?.value) || 0;
        const homeOT = parseInt(document.getElementById(`gsHomeOT${ot}`)?.value) || 0;
        awayQuarters.push(awayOT);
        homeQuarters.push(homeOT);
      }
      
      const awayScorers = collectGSScorers('away');
      const homeScorers = collectGSScorers('home');
      
      // Validate
      const awayPtsTotal = awayScorers.reduce((sum, s) => sum + s.points, 0);
      const homePtsTotal = homeScorers.reduce((sum, s) => sum + s.points, 0);
      
      if (awayPtsTotal !== awayFinal) {
        showToast(`${gsSelectedGame.away} points (${awayPtsTotal}) don't match final (${awayFinal})`, 'error');
        return;
      }
      if (homePtsTotal !== homeFinal) {
        showToast(`${gsSelectedGame.home} points (${homePtsTotal}) don't match final (${homeFinal})`, 'error');
        return;
      }
      
      const btn = document.getElementById('gsGenerateBtn');
      btn.disabled = true;
      btn.textContent = '‚è≥ Writing story...';
      
      const rosters = getTeamRosters();
      
      // Get school info for mascots and towns
      const awaySchoolInfo = getSchoolInfo(gsSelectedGame.away);
      const homeSchoolInfo = getSchoolInfo(gsSelectedGame.home);
      
      // Get selected photographer(s)
      const selectedPhotogs = [];
      document.querySelectorAll('input[name="gsPhotog"]:checked').forEach(cb => {
        selectedPhotogs.push(cb.value);
      });
      const photographerName = selectedPhotogs.join(' & ');
      
      const proofData = {
        awayTeam: gsSelectedGame.away,
        homeTeam: gsSelectedGame.home,
        awayQuarters,
        homeQuarters,
        awayFinal,
        homeFinal,
        awayScorers,
        homeScorers,
        gender: gsSelectedGame.gender || 'Boys',
        division: gsSelectedGame.division || '',
        date: gsSelectedGame.date || '',
        notes: document.getElementById('gsNotes').value.trim(),
        hasOT: otCount > 0
      };
      
      try {
        const response = await fetch('/.netlify/functions/generate-article', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            mode: 'write',
            proofData,
            awayRoster: rosters.away,
            homeRoster: rosters.home,
            schoolData: {
              away: awaySchoolInfo,
              home: homeSchoolInfo
            },
            photographerName: photographerName || null,
            galleryUrl: null
          })
        });
        
        const data = await response.json();
        
        if (data.success) {
          // Close modal and open editor with generated content
          closeGameStory();
          
          // Store generated social posts for later use
          generatedSocialPosts = {
            facebookPost: data.facebookPost || null,
            instagramPost: data.instagramPost || null,
            twitterPost: data.twitterPost || null
          };
          
          // Set up article editor
          currentArticle = null;
          document.getElementById('editorTitle').textContent = 'New Article';
          document.getElementById('articleTitle').value = data.headline || '';
          document.getElementById('articleContent').value = data.article || '';
          document.getElementById('articleExcerpt').value = data.excerpt || '';
          document.getElementById('selectedGameId').value = gsSelectedGame.game_id;
          selectedGame = gsSelectedGame;
          
          // Set photographer credit if we had one
          if (photographerName) {
            document.getElementById('photographerCredit').value = photographerName;
          }
          
          document.getElementById('articlesPanel').style.display = 'none';
          document.getElementById('editorPanel').style.display = 'block';
          
          renderGameSelector();
          showToast('Story generated! Review and edit as needed.', 'success');
        } else {
          showToast(data.error || 'Failed to generate story', 'error');
        }
      } catch (err) {
        console.error('Generation error:', err);
        showToast('Failed to generate story', 'error');
      }
      
      btn.disabled = false;
      btn.textContent = '‚ú® Generate Story';
    }

    // ==================== BOXSCORE STORY MODAL FUNCTIONS ====================
    let bsSelectedGame = null;
    let bsSelectedDate = new Date();
    
    function newBoxscoreStory() {
      bsSelectedGame = null;
      bsSelectedDate = new Date(); // Start with today
      document.getElementById('boxscoreStoryModal').style.display = 'block';
      document.getElementById('bsStep1').style.display = 'block';
      document.getElementById('bsStep2').style.display = 'none';
      document.getElementById('bsGameSearch').value = '';
      updateBsDateDisplay();
      populateBsGameList();
      document.body.style.overflow = 'hidden';
    }
    
    function closeBoxscoreStory() {
      document.getElementById('boxscoreStoryModal').style.display = 'none';
      document.body.style.overflow = 'auto';
    }
    
    function updateBsDateDisplay() {
      document.getElementById('bsCurrentDate').textContent = formatDateShort(bsSelectedDate);
    }
    
    function bsPrevDay() {
      bsSelectedDate.setDate(bsSelectedDate.getDate() - 1);
      updateBsDateDisplay();
      populateBsGameList();
    }
    
    function bsNextDay() {
      bsSelectedDate.setDate(bsSelectedDate.getDate() + 1);
      updateBsDateDisplay();
      populateBsGameList();
    }
    
    function populateBsGameList() {
      const container = document.getElementById('bsGameList');
      
      // Check if games have loaded
      if (!games || games.length === 0) {
        container.innerHTML = '<div style="padding: 20px; text-align: center; color: #888;">Loading games...</div>';
        setTimeout(() => {
          if (games && games.length > 0) populateBsGameList();
        }, 500);
        return;
      }
      
      const searchFilter = document.getElementById('bsGameSearch').value.toLowerCase();
      const selectedDateStr = getDateString(bsSelectedDate);
      const selectedGender = document.querySelector('input[name="bsGender"]:checked')?.value || 'Men';
      
      // Filter by selected date, gender, and search
      let filtered = games.filter(g => {
        // Must match selected date
        if (g.date !== selectedDateStr) return false;
        // Must match selected gender
        if (g.gender !== selectedGender) return false;
        // Filter by search
        if (searchFilter) {
          const searchStr = `${g.away} ${g.home}`.toLowerCase();
          if (!searchStr.includes(searchFilter)) return false;
        }
        return true;
      });
      
      // Sort by time, then gender
      filtered.sort((a, b) => {
        if (a.time !== b.time) return (a.time || '').localeCompare(b.time || '');
        return (a.gender || '').localeCompare(b.gender || '');
      });
      
      if (filtered.length === 0) {
        const genderLabel = selectedGender.toLowerCase();
        const message = searchFilter 
          ? `No ${genderLabel}'s games found for "${searchFilter}"` 
          : `No ${genderLabel}'s games on this date`;
        container.innerHTML = `<div style="padding: 30px; text-align: center; color: #888; font-size: 13px;">${message}</div>`;
        return;
      }
      
      // Build simple list
      let html = '';
      
      filtered.forEach(g => {
        const hasRecap = g.recap_link && g.recap_link.trim() !== '';
        const rowStyle = hasRecap 
          ? 'background: #f9f9f9; color: #bbb; cursor: not-allowed;' 
          : 'cursor: pointer;';
        const hoverClass = hasRecap ? '' : 'game-row-hover';
        const onclick = hasRecap ? '' : `onclick="selectGameForBoxscore('${g.game_id}')"`;
        
        html += `
          <div class="${hoverClass}" style="padding: 10px 12px; border-bottom: 1px solid #eee; ${rowStyle}" ${onclick}>
            <span style="font-size: 13px;">${g.away} @ ${g.home}${hasRecap ? ' <span style="font-size: 10px; color: #aaa;">(done)</span>' : ''}</span>
          </div>`;
      });
      
      container.innerHTML = html;
    }
    
    function filterBsGameList() {
      populateBsGameList();
    }
    
    function selectGameForBoxscore(gameId) {
      bsSelectedGame = games.find(g => g.game_id === gameId);
      if (!bsSelectedGame) return;
      
      // Move to step 2
      document.getElementById('bsStep1').style.display = 'none';
      document.getElementById('bsStep2').style.display = 'block';
      
      // Set matchup title
      document.getElementById('bsMatchupTitle').textContent = `${bsSelectedGame.away} @ ${bsSelectedGame.home}`;
      
      // Clear boxscore and notes
      document.getElementById('bsBoxscoreText').value = '';
      document.getElementById('bsNotes').value = '';
      
      // Show photographers if assigned
      const photogs = [bsSelectedGame.photog1, bsSelectedGame.photog2].filter(p => p && p.trim());
      const photogDiv = document.getElementById('bsPhotographers');
      const checkboxContainer = document.getElementById('bsPhotogCheckboxes');
      if (photogs.length > 0) {
        checkboxContainer.innerHTML = photogs.map((p, i) => `
          <label style="display: flex; align-items: center; gap: 6px; margin-bottom: 4px; cursor: pointer;">
            <input type="checkbox" name="bsPhotog" value="${p}" checked style="cursor: pointer;">
            <span>${p}</span>
          </label>
        `).join('');
        photogDiv.style.display = 'block';
      } else {
        photogDiv.style.display = 'none';
      }
    }
    
    function backToBsGameSelect() {
      document.getElementById('bsStep1').style.display = 'block';
      document.getElementById('bsStep2').style.display = 'none';
    }
    
    async function generateBoxscoreStory() {
      const boxscoreText = document.getElementById('bsBoxscoreText').value.trim();
      
      if (!boxscoreText) {
        showToast('Please paste the boxscore data first', 'error');
        return;
      }
      
      const btn = document.getElementById('bsGenerateBtn');
      btn.disabled = true;
      btn.textContent = '‚è≥ Writing story...';
      
      // Get selected photographer(s)
      const selectedPhotogs = [];
      document.querySelectorAll('input[name="bsPhotog"]:checked').forEach(cb => {
        selectedPhotogs.push(cb.value);
      });
      const photographerName = selectedPhotogs.join(' & ');
      
      // Get school info
      const awaySchoolInfo = getSchoolInfo(bsSelectedGame.away);
      const homeSchoolInfo = getSchoolInfo(bsSelectedGame.home);
      
      try {
        const response = await fetch('/.netlify/functions/generate-article', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            mode: 'boxscore',
            boxscoreText: boxscoreText,
            gameInfo: {
              awayTeam: bsSelectedGame.away,
              homeTeam: bsSelectedGame.home,
              gender: bsSelectedGame.gender || 'Men',
              division: bsSelectedGame.division || '',
              date: bsSelectedGame.date || ''
            },
            notes: document.getElementById('bsNotes').value.trim(),
            schoolData: {
              away: awaySchoolInfo,
              home: homeSchoolInfo
            },
            photographerName: photographerName || null
          })
        });
        
        const data = await response.json();
        
        if (data.success) {
          // Close modal and open editor with generated content
          closeBoxscoreStory();
          
          // Store generated social posts for later use
          generatedSocialPosts = {
            facebookPost: data.facebookPost || null,
            instagramPost: data.instagramPost || null,
            twitterPost: data.twitterPost || null
          };
          
          // Set up article editor
          currentArticle = null;
          document.getElementById('editorTitle').textContent = 'New Article';
          document.getElementById('articleTitle').value = data.headline || '';
          document.getElementById('articleContent').value = data.article || '';
          document.getElementById('articleExcerpt').value = data.excerpt || '';
          document.getElementById('selectedGameId').value = bsSelectedGame.game_id;
          selectedGame = bsSelectedGame;
          
          // Set photographer credit if we had one
          if (photographerName) {
            document.getElementById('photographerCredit').value = photographerName;
          }
          
          document.getElementById('articlesPanel').style.display = 'none';
          document.getElementById('editorPanel').style.display = 'block';
          
          renderGameSelector();
          showToast('Story generated! Review and edit as needed.', 'success');
        } else {
          showToast(data.error || 'Failed to generate story', 'error');
        }
      } catch (err) {
        console.error('Generation error:', err);
        showToast('Failed to generate story', 'error');
      }
      
      btn.disabled = false;
      btn.textContent = '‚ú® Generate Story';
    }
    
    // Helper function to get school info from ROSTERS_DATA
    function getSchoolInfo(schoolName) {
      if (typeof ROSTERS_DATA === 'undefined' || !ROSTERS_DATA.schools) return null;
      
      // Try exact match first
      for (const [fullName, info] of Object.entries(ROSTERS_DATA.schools)) {
        if (info.shortname === schoolName || fullName === schoolName || fullName.includes(schoolName)) {
          return info;
        }
      }
      return null;
    }

    // Article CRUD
    function newArticle() {
      currentArticle = null;
      document.getElementById('editorTitle').textContent = 'New Article';
      document.getElementById('articleTitle').value = '';
      document.getElementById('articleContent').value = '';
      document.getElementById('articleExcerpt').value = '';
      document.getElementById('selectedGameId').value = '';
      selectedGame = null;
      document.getElementById('smugmugUrl').value = '';
      document.getElementById('photographerCredit').value = '';
      selectedGame = null;
      
      // Clear generated social posts (this is a manual article)
      generatedSocialPosts = {
        facebookPost: null,
        instagramPost: null,
        twitterPost: null
      };
      
      document.getElementById('articlesPanel').style.display = 'none';
      document.getElementById('editorPanel').style.display = 'block';
      
      renderGameSelector();
      updateSocialButtons(false);
    }
    
    async function editArticle(id) {
      const article = articles.find(a => a.id === id);
      if (!article) return;
      
      currentArticle = article;
      document.getElementById('editorTitle').textContent = 'Edit Article';
      document.getElementById('articleTitle').value = article.title || '';
      document.getElementById('articleContent').value = article.content || '';
      document.getElementById('articleExcerpt').value = article.excerpt || '';
      document.getElementById('selectedGameId').value = article.game_id || '';
      selectedGame = article.game_id ? games.find(g => g.game_id === article.game_id) : null;
      document.getElementById('smugmugUrl').value = article.smugmug_gallery_url || '';
      document.getElementById('photographerCredit').value = article.photographer_credit || '';
      
      // Clear generated social posts (editing existing article, no stored social versions)
      generatedSocialPosts = {
        facebookPost: null,
        instagramPost: null,
        twitterPost: null
      };
      
      document.getElementById('articlesPanel').style.display = 'none';
      document.getElementById('editorPanel').style.display = 'block';
      
      renderGameSelector();
      updateSocialButtons(article.status === 'published', article);
    }
    
    function closeEditor() {
      document.getElementById('editorPanel').style.display = 'none';
      document.getElementById('articlesPanel').style.display = 'block';
      currentArticle = null;
    }
    
    function generateSlug(title) {
      return title
        .toLowerCase()
        .replace(/[^a-z0-9]+/g, '-')
        .replace(/(^-|-$)/g, '')
        .substring(0, 60);
    }
    
    async function saveArticle() {
      const title = document.getElementById('articleTitle').value.trim();
      if (!title) {
        showToast('Please enter a headline', 'error');
        return;
      }
      
      const articleData = {
        title,
        slug: generateSlug(title) + '-' + Date.now(),
        content: document.getElementById('articleContent').value,
        excerpt: document.getElementById('articleExcerpt').value,
        game_id: document.getElementById('selectedGameId').value || null,
        smugmug_gallery_url: document.getElementById('smugmugUrl').value || null,
        photographer_credit: document.getElementById('photographerCredit').value || null,
        status: 'draft',
        updated_at: new Date().toISOString()
      };
      
      let result;
      if (currentArticle) {
        result = await supabase
          .from('articles')
          .update(articleData)
          .eq('id', currentArticle.id)
          .select();
      } else {
        result = await supabase
          .from('articles')
          .insert([articleData])
          .select();
      }
      
      if (result.error) {
        console.error('Save error:', result.error);
        showToast('Error saving article', 'error');
        return;
      }
      
      showToast('Article saved!', 'success');
      currentArticle = result.data[0];
      loadArticles();
    }
    
    async function publishArticle() {
      const title = document.getElementById('articleTitle').value.trim();
      if (!title) {
        showToast('Please enter a headline', 'error');
        return;
      }
      
      const articleData = {
        title,
        slug: generateSlug(title) + '-' + Date.now(),
        content: document.getElementById('articleContent').value,
        excerpt: document.getElementById('articleExcerpt').value,
        game_id: document.getElementById('selectedGameId').value || null,
        smugmug_gallery_url: document.getElementById('smugmugUrl').value || null,
        photographer_credit: document.getElementById('photographerCredit').value || null,
        status: 'published',
        published_at: new Date().toISOString(),
        updated_at: new Date().toISOString()
      };
      
      let result;
      if (currentArticle) {
        result = await supabase
          .from('articles')
          .update(articleData)
          .eq('id', currentArticle.id)
          .select();
      } else {
        result = await supabase
          .from('articles')
          .insert([articleData])
          .select();
      }
      
      if (result.error) {
        console.error('Publish error:', result.error);
        showToast('Error publishing article', 'error');
        return;
      }
      
      showToast('Article published!', 'success');
      currentArticle = result.data[0];
      loadArticles();
      updateSocialButtons(true, currentArticle);
    }
    
    async function deleteArticle(id) {
      if (!confirm('Delete this article?')) return;
      
      const { error } = await supabase
        .from('articles')
        .delete()
        .eq('id', id);
      
      if (error) {
        showToast('Error deleting article', 'error');
        return;
      }
      
      showToast('Article deleted', 'success');
      loadArticles();
    }
    
    // AI Generation
    let scorePhotoBase64 = null;
    let extractedData = null;
    
    function previewScorePhoto(input) {
      const file = input.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
          scorePhotoBase64 = e.target.result;
          document.getElementById('photoPreviewImg').src = scorePhotoBase64;
          document.getElementById('photoPreview').style.display = 'block';
        };
        reader.readAsDataURL(file);
      }
    }
    
    function clearScorePhoto() {
      scorePhotoBase64 = null;
      document.getElementById('scorePhoto').value = '';
      document.getElementById('photoPreview').style.display = 'none';
    }
    
    // Get rosters for selected teams
    
    // Update roster status when game is selected
    function updateRosterStatus() {
      const status = document.getElementById('rosterStatus');
      if (!selectedGame) {
        status.textContent = '‚ö†Ô∏è Select a game above to enable roster matching';
        status.style.color = '#e65100';
        return;
      }
      
      const rosters = getTeamRosters();
      const hasAway = !!rosters.away;
      const hasHome = !!rosters.home;
      
      if (hasAway && hasHome) {
        status.innerHTML = `‚úÖ Rosters loaded: <strong>${selectedGame.away}</strong> & <strong>${selectedGame.home}</strong>`;
        status.style.color = '#2e7d32';
      } else if (hasAway || hasHome) {
        const missing = !hasAway ? selectedGame.away : selectedGame.home;
        status.innerHTML = `‚ö†Ô∏è Roster missing for: <strong>${missing}</strong>`;
        status.style.color = '#e65100';
      } else {
        status.innerHTML = `‚ö†Ô∏è No rosters found for either team`;
        status.style.color = '#e65100';
      }
    }
    
    // Add scorer row to proof form
    function addScorerRow(team, data = {}) {
      const container = document.getElementById(team + 'Scorers');
      const rosters = getTeamRosters();
      const roster = team === 'away' ? rosters.away : rosters.home;
      
      const row = document.createElement('div');
      row.style.cssText = 'display: flex; gap: 5px; margin-bottom: 5px; align-items: center;';
      
      // Build player dropdown if roster available
      let playerSelect = '';
      if (roster && roster.players) {
        playerSelect = `<select style="flex: 2; padding: 4px; font-size: 12px;" onchange="this.nextElementSibling.value=this.value">
          <option value="">-- Select --</option>
          ${roster.players.map(p => `<option value="${p.name}" ${data.name === p.name ? 'selected' : ''}>#${p.number} ${p.name} (${p.class})</option>`).join('')}
        </select>`;
      }
      
      row.innerHTML = `
        ${playerSelect}
        <input type="text" placeholder="Player name" value="${data.name || ''}" style="flex: 2; padding: 4px; font-size: 12px;">
        <input type="text" placeholder="Pts" value="${data.points || ''}" style="width: 35px; padding: 4px; font-size: 12px; text-align: center;">
        <button type="button" onclick="this.parentElement.remove()" style="background: #ffebee; border: none; padding: 4px 8px; border-radius: 3px; cursor: pointer; color: #c62828; font-size: 11px;">‚úï</button>
      `;
      container.appendChild(row);
    }
    
    // Extract box score from image
    async function extractBoxScore() {
      if (!scorePhotoBase64 && !document.getElementById('aiInput').value.trim()) {
        showToast('Please upload a scorebook photo or enter notes', 'error');
        return;
      }
      
      if (!selectedGame) {
        showToast('Please select a game first to enable roster matching', 'error');
        return;
      }
      
      const btn = document.getElementById('btnExtract');
      btn.disabled = true;
      btn.innerHTML = '‚è≥ Reading scorebook...';
      
      const rosters = getTeamRosters();
      const notes = document.getElementById('aiInput').value.trim();
      
      try {
        const response = await fetch('/.netlify/functions/generate-article', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            mode: 'extract',
            image: scorePhotoBase64,
            notes: notes,
            gameInfo: {
              away: selectedGame.away,
              home: selectedGame.home,
              gender: selectedGame.gender,
              date: selectedGame.date,
              division: selectedGame.division
            },
            awayRoster: rosters.away,
            homeRoster: rosters.home
          })
        });
        
        const data = await response.json();
        
        if (data.success && data.extracted) {
          extractedData = data.extracted;
          populateProofForm(data.extracted);
          document.getElementById('aiStep1').style.display = 'none';
          document.getElementById('aiStep2').style.display = 'block';
          showToast('Box score extracted! Please verify and edit if needed.', 'success');
        } else {
          showToast(data.error || 'Failed to extract box score', 'error');
        }
      } catch (err) {
        console.error('Extract error:', err);
        showToast('Failed to extract box score', 'error');
      }
      
      btn.disabled = false;
      btn.innerHTML = 'üìã Extract & Review';
    }
    
    // Populate proof form with extracted data
    function populateProofForm(data) {
      // Team names
      document.getElementById('proofAwayTeam').textContent = selectedGame.away;
      document.getElementById('proofHomeTeam').textContent = selectedGame.home;
      document.getElementById('awayScorerLabel').textContent = selectedGame.away + ' Scorers';
      document.getElementById('homeScorerLabel').textContent = selectedGame.home + ' Scorers';
      
      // Quarter scores
      document.getElementById('awayQ1').value = data.awayQuarters?.[0] || '';
      document.getElementById('awayQ2').value = data.awayQuarters?.[1] || '';
      document.getElementById('awayQ3').value = data.awayQuarters?.[2] || '';
      document.getElementById('awayQ4').value = data.awayQuarters?.[3] || '';
      document.getElementById('awayFinal').value = data.awayFinal || '';
      
      document.getElementById('homeQ1').value = data.homeQuarters?.[0] || '';
      document.getElementById('homeQ2').value = data.homeQuarters?.[1] || '';
      document.getElementById('homeQ3').value = data.homeQuarters?.[2] || '';
      document.getElementById('homeQ4').value = data.homeQuarters?.[3] || '';
      document.getElementById('homeFinal').value = data.homeFinal || '';
      
      // Clear and populate scorers
      document.getElementById('awayScorers').innerHTML = '';
      document.getElementById('homeScorers').innerHTML = '';
      
      (data.awayScorers || []).forEach(s => addScorerRow('away', s));
      (data.homeScorers || []).forEach(s => addScorerRow('home', s));
      
      // Add empty rows if none
      if (!data.awayScorers?.length) addScorerRow('away');
      if (!data.homeScorers?.length) addScorerRow('home');
      
      // Notes
      document.getElementById('proofNotes').value = data.notes || '';
    }
    
    // Go back to upload step
    function backToUpload() {
      document.getElementById('aiStep1').style.display = 'block';
      document.getElementById('aiStep2').style.display = 'none';
    }
    
    // Collect data from proof form
    function collectProofData() {
      const awayScorers = [];
      document.querySelectorAll('#awayScorers > div').forEach(row => {
        const inputs = row.querySelectorAll('input[type="text"]');
        const name = inputs[inputs.length - 2]?.value?.trim();
        const points = inputs[inputs.length - 1]?.value?.trim();
        if (name && points) awayScorers.push({ name, points });
      });
      
      const homeScorers = [];
      document.querySelectorAll('#homeScorers > div').forEach(row => {
        const inputs = row.querySelectorAll('input[type="text"]');
        const name = inputs[inputs.length - 2]?.value?.trim();
        const points = inputs[inputs.length - 1]?.value?.trim();
        if (name && points) homeScorers.push({ name, points });
      });
      
      return {
        awayTeam: selectedGame.away,
        homeTeam: selectedGame.home,
        gender: selectedGame.gender,
        division: selectedGame.division,
        date: selectedGame.date,
        awayQuarters: [
          document.getElementById('awayQ1').value,
          document.getElementById('awayQ2').value,
          document.getElementById('awayQ3').value,
          document.getElementById('awayQ4').value
        ],
        homeQuarters: [
          document.getElementById('homeQ1').value,
          document.getElementById('homeQ2').value,
          document.getElementById('homeQ3').value,
          document.getElementById('homeQ4').value
        ],
        awayFinal: document.getElementById('awayFinal').value,
        homeFinal: document.getElementById('homeFinal').value,
        awayScorers,
        homeScorers,
        notes: document.getElementById('proofNotes').value
      };
    }
    
    // Generate article from confirmed proof data
    // Generate article from manual box score entry
    async function generateArticle() {
      // Validate quarters entered
      const awayFinal = parseInt(document.getElementById('awayFinal').value) || 0;
      const homeFinal = parseInt(document.getElementById('homeFinal').value) || 0;
      
      if (!awayFinal && !homeFinal) {
        showToast('Please enter quarter scores first', 'error');
        return;
      }
      
      // Collect quarter scores
      const awayQuarters = [
        parseInt(document.getElementById('awayQ1').value) || 0,
        parseInt(document.getElementById('awayQ2').value) || 0,
        parseInt(document.getElementById('awayQ3').value) || 0,
        parseInt(document.getElementById('awayQ4').value) || 0
      ];
      const homeQuarters = [
        parseInt(document.getElementById('homeQ1').value) || 0,
        parseInt(document.getElementById('homeQ2').value) || 0,
        parseInt(document.getElementById('homeQ3').value) || 0,
        parseInt(document.getElementById('homeQ4').value) || 0
      ];
      
      // Collect scorers from roster entries
      const awayScorers = collectScorers('away');
      const homeScorers = collectScorers('home');
      
      // Validate points match
      const awayPtsTotal = awayScorers.reduce((sum, s) => sum + s.points, 0);
      const homePtsTotal = homeScorers.reduce((sum, s) => sum + s.points, 0);
      
      if (awayPtsTotal !== awayFinal) {
        showToast(`${selectedGame.away} points (${awayPtsTotal}) don't match final (${awayFinal})`, 'error');
        return;
      }
      if (homePtsTotal !== homeFinal) {
        showToast(`${selectedGame.home} points (${homePtsTotal}) don't match final (${homeFinal})`, 'error');
        return;
      }
      
      const btn = document.getElementById('btnGenerate');
      btn.disabled = true;
      btn.innerHTML = '‚è≥ Writing article...';
      
      const rosters = getTeamRosters();
      const notes = document.getElementById('gameNotes').value.trim();
      
      const proofData = {
        awayTeam: selectedGame.away,
        homeTeam: selectedGame.home,
        awayQuarters: awayQuarters,
        homeQuarters: homeQuarters,
        awayFinal: awayFinal,
        homeFinal: homeFinal,
        awayScorers: awayScorers,
        homeScorers: homeScorers,
        gender: selectedGame.gender || 'Boys',
        division: selectedGame.division || '',
        date: selectedGame.date || '',
        notes: notes
      };
      
      try {
        const response = await fetch('/.netlify/functions/generate-article', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            mode: 'write',
            proofData: proofData,
            awayRoster: rosters.away,
            homeRoster: rosters.home
          })
        });
        
        const data = await response.json();
        
        if (data.success) {
          if (data.headline) {
            document.getElementById('articleTitle').value = data.headline;
          }
          if (data.article) {
            document.getElementById('articleContent').value = data.article;
          }
          if (data.excerpt) {
            document.getElementById('articleExcerpt').value = data.excerpt;
          }
          
          showToast('Article generated! Review and edit as needed.', 'success');
        } else {
          showToast(data.error || 'Failed to generate article', 'error');
        }
      } catch (err) {
        console.error('Generation error:', err);
        showToast('Failed to generate article', 'error');
      }
      
      btn.disabled = false;
      btn.innerHTML = '‚ú® Generate Article';
    }
    
    // Collect scorers from roster entry section
    function collectScorers(team) {
      const container = document.getElementById(team + 'RosterEntry');
      const scorers = [];
      
      // Roster players with points
      container.querySelectorAll('.pts-input[data-player]').forEach(input => {
        const pts = parseInt(input.value) || 0;
        if (pts > 0) {
          const name = input.getAttribute('data-player');
          const threePtInput = container.querySelector(`.threept-input[data-player="${name}"]`);
          const threePts = parseInt(threePtInput?.value) || 0;
          scorers.push({ name: name, points: pts, threePointers: threePts });
        }
      });
      
      // Manual entries
      container.querySelectorAll('.manual-name').forEach(nameInput => {
        const name = nameInput.value.trim();
        if (name) {
          const row = nameInput.parentElement;
          const ptsInput = row.querySelector('.manual-pts');
          const threePtInput = row.querySelector('.threept-input');
          const pts = parseInt(ptsInput?.value) || 0;
          const threePts = parseInt(threePtInput?.value) || 0;
          if (pts > 0) {
            scorers.push({ name: name, points: pts, threePointers: threePts });
          }
        }
      });
      
      // Sort by points descending
      scorers.sort((a, b) => b.points - a.points);
      return scorers;
    }

    async function generateFromProof() {
      const proofData = collectProofData();
      
      if (!proofData.awayFinal || !proofData.homeFinal) {
        showToast('Please enter final scores', 'error');
        return;
      }
      
      const btn = document.getElementById('btnGenerate');
      btn.disabled = true;
      btn.innerHTML = '‚è≥ Writing article...';
      
      const rosters = getTeamRosters();
      
      try {
        const response = await fetch('/.netlify/functions/generate-article', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            mode: 'write',
            proofData: proofData,
            awayRoster: rosters.away,
            homeRoster: rosters.home
          })
        });
        
        const data = await response.json();
        
        if (data.success) {
          if (data.headline) {
            document.getElementById('articleTitle').value = data.headline;
          }
          if (data.article) {
            document.getElementById('articleContent').value = data.article;
          }
          if (data.excerpt) {
            document.getElementById('articleExcerpt').value = data.excerpt;
          }
          
          // Reset AI section
          backToUpload();
          clearScorePhoto();
          document.getElementById('aiInput').value = '';
          
          showToast('Article generated! Review and edit as needed.', 'success');
        } else {
          showToast(data.error || 'Failed to generate article', 'error');
        }
      } catch (err) {
        console.error('Generation error:', err);
        showToast('Failed to generate article', 'error');
      }
      
      btn.disabled = false;
      btn.innerHTML = '‚ú® Generate Article';
    }
    
    // Social posting
    function updateSocialButtons(enabled, article = null) {
      const btns = ['btnFacebook', 'btnInstagram', 'btnTwitter'];
      btns.forEach(id => {
        document.getElementById(id).disabled = !enabled;
      });
      
      if (article) {
        document.getElementById('facebookPosted').style.display = article.posted_facebook ? 'inline' : 'none';
        document.getElementById('instagramPosted').style.display = article.posted_instagram ? 'inline' : 'none';
        document.getElementById('twitterPosted').style.display = article.posted_twitter ? 'inline' : 'none';
      }
    }
    
    async function postToSocial(platform) {
      const title = document.getElementById('articleTitle').value;
      const content = document.getElementById('articleContent').value;
      const excerpt = document.getElementById('articleExcerpt').value || content.substring(0, 200);
      const gallery = document.getElementById('smugmugUrl').value;
      const photographer = document.getElementById('photographerCredit').value;
      
      let postText = '';
      
      // Use pre-generated content if available (from story generators)
      if (platform === 'facebook' && generatedSocialPosts.facebookPost) {
        postText = generatedSocialPosts.facebookPost;
        // Update with current gallery URL if changed
        if (gallery && !postText.includes(gallery)) {
          postText = postText.replace(/over at https?:\/\/[^\s]+|over at Ball603\.com/, `over at ${gallery}`);
        }
      } else if (platform === 'instagram' && generatedSocialPosts.instagramPost) {
        postText = generatedSocialPosts.instagramPost;
      } else if (platform === 'twitter' && generatedSocialPosts.twitterPost) {
        postText = generatedSocialPosts.twitterPost;
        // Update with current gallery URL if changed
        if (gallery && !postText.includes(gallery)) {
          postText = postText.replace(/over at https?:\/\/[^\s]+|over at Ball603\.com/, `over at ${gallery}`);
        }
      } else {
        // Fallback to old behavior for non-generated articles
        if (platform === 'facebook') {
          postText = content;
          if (photographer && gallery) {
            postText += `\n\nCheck out the full photo gallery by ${photographer} over at ${gallery}`;
          } else if (gallery) {
            postText += `\n\nCheck out the full photo gallery over at ${gallery}`;
          }
        } else if (platform === 'instagram') {
          postText = `üèÄ ${title}\n\n${excerpt}\n\nüì∏ Link in bio for full gallery!\n`;
          if (photographer) postText += `üì∑ @${photographer.replace(/\s+/g, '')}\n`;
          postText += `\n#Ball603 #NHBasketball #NHIAA`;
        } else if (platform === 'twitter') {
          postText = `üèÄ ${title}\n\n${excerpt.substring(0, 180)}...\n\n`;
          if (gallery) postText += `üì∏ ${gallery}\n`;
          postText += `#NHBasketball`;
        }
      }
      
      // Copy to clipboard
      try {
        await navigator.clipboard.writeText(postText);
        showToast(`${platform.charAt(0).toUpperCase() + platform.slice(1)} post copied to clipboard!`, 'success');
        
        // Mark as posted
        if (currentArticle) {
          const update = {};
          update[`posted_${platform}`] = true;
          await supabase
            .from('articles')
            .update(update)
            .eq('id', currentArticle.id);
          
          document.getElementById(`${platform}Posted`).style.display = 'inline';
        }
      } catch (err) {
        showToast('Could not copy to clipboard', 'error');
      }
    }
    
    // Toast
    function showToast(message, type = 'success') {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.className = `toast ${type}`;
      toast.style.display = 'block';
      setTimeout(() => toast.style.display = 'none', 3000);
    }
    
    // Sponsors & Products (placeholders)
    function newSponsor() {
      showToast('Sponsor management coming soon!', 'error');
    }
    
    function newProduct() {
      showToast('Product management coming soon!', 'error');
    }
    
    // SmugMug Browser
    let smugmugAlbums = [];
    let selectedAlbum = null;
    
    async function openSmugMugBrowser() {
      document.getElementById('smugmugModal').classList.add('open');
      document.getElementById('albumGrid').innerHTML = '<div class="loading">Loading albums...</div>';
      selectedAlbum = null;
      document.getElementById('btnSelectAlbum').disabled = true;
      
      try {
        const response = await fetch('/.netlify/functions/smugmug?action=albums');
        const data = await response.json();
        
        if (data.success) {
          smugmugAlbums = data.albums || [];
          renderAlbumGrid();
        } else {
          document.getElementById('albumGrid').innerHTML = '<div class="loading">Error loading albums</div>';
        }
      } catch (err) {
        console.error('SmugMug error:', err);
        document.getElementById('albumGrid').innerHTML = '<div class="loading">Could not connect to SmugMug</div>';
      }
    }
    
    function closeSmugMugBrowser() {
      document.getElementById('smugmugModal').classList.remove('open');
      selectedAlbum = null;
    }
    
    function renderAlbumGrid(filter = '') {
      const grid = document.getElementById('albumGrid');
      
      let filtered = smugmugAlbums;
      if (filter) {
        filtered = smugmugAlbums.filter(a => 
          a.name.toLowerCase().includes(filter.toLowerCase())
        );
      }
      
      if (filtered.length === 0) {
        grid.innerHTML = '<div class="loading">No albums found</div>';
        return;
      }
      
      grid.innerHTML = filtered.map(album => `
        <div class="album-card ${selectedAlbum?.key === album.key ? 'selected' : ''}" 
             onclick="selectAlbumCard('${album.key}')">
          <img class="album-thumb" 
               src="${album.highlightImage || 'data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><rect fill=%22%23f5f5f5%22 width=%22100%22 height=%22100%22/><text x=%2250%22 y=%2255%22 text-anchor=%22middle%22 fill=%22%23ccc%22 font-size=%2230%22>üì∑</text></svg>'}" 
               alt="${album.name}"
               onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><rect fill=%22%23f5f5f5%22 width=%22100%22 height=%22100%22/><text x=%2250%22 y=%2255%22 text-anchor=%22middle%22 fill=%22%23ccc%22 font-size=%2230%22>üì∑</text></svg>'">
          <div class="album-info">
            <div class="album-name" title="${album.name}">${album.name}</div>
            <div class="album-meta">${album.imageCount || 0} photos${album.date ? ' ‚Ä¢ ' + album.date : ''}</div>
          </div>
        </div>
      `).join('');
    }
    
    function searchAlbums(value) {
      renderAlbumGrid(value);
    }
    
    function selectAlbumCard(key) {
      selectedAlbum = smugmugAlbums.find(a => a.key === key);
      document.getElementById('btnSelectAlbum').disabled = !selectedAlbum;
      renderAlbumGrid(document.getElementById('albumSearch').value);
    }
    
    function selectSmugMugAlbum() {
      if (!selectedAlbum) return;
      
      document.getElementById('smugmugUrl').value = selectedAlbum.url;
      
      // Show preview
      const preview = document.getElementById('selectedAlbumPreview');
      if (selectedAlbum.highlightImage) {
        document.getElementById('albumThumbnail').src = selectedAlbum.highlightImage;
        preview.style.display = 'block';
      } else {
        preview.style.display = 'none';
      }
      document.getElementById('albumInfo').textContent = `${selectedAlbum.name} ‚Ä¢ ${selectedAlbum.imageCount} photos`;
      preview.style.display = 'block';
      
      closeSmugMugBrowser();
      showToast('Album selected!', 'success');
    }
  </script>
</body>
</html>
