<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ball603 CMS</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f5f5f5; color: #333; min-height: 100vh; }
    
    /* Header */
    .header { background: #fff; padding: 15px 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); position: relative; z-index: 1000; }
    .header-inner { max-width: 1200px; margin: 0 auto; display: flex; justify-content: space-between; align-items: center; }
    .header-left { display: flex; align-items: center; gap: 15px; }
    .header-left img { height: 50px; cursor: pointer; }
    .header-left h1 { font-size: 20px; color: #333; }
    .header-right { display: flex; align-items: center; gap: 15px; }
    .user-info { font-size: 13px; color: #666; }
    .btn-logout { background: #eee; border: none; padding: 8px 16px; border-radius: 5px; cursor: pointer; font-size: 13px; }
    .btn-logout:hover { background: #ddd; }
    
    /* Login Screen */
    .login-screen { display: flex; justify-content: center; align-items: center; min-height: 100vh; padding: 20px; }
    .login-box { background: #fff; padding: 40px; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); text-align: center; max-width: 400px; width: 100%; }
    .login-box img { height: 80px; margin-bottom: 20px; }
    .login-box h2 { margin-bottom: 10px; color: #333; }
    .login-box p { color: #666; margin-bottom: 25px; font-size: 14px; }
    .login-box input { width: 100%; padding: 12px 15px; border: 1px solid #ddd; border-radius: 5px; font-size: 14px; margin-bottom: 15px; }
    .login-box input:focus { outline: none; border-color: #f57c00; }
    .login-box button { width: 100%; padding: 12px; background: #f57c00; color: #fff; border: none; border-radius: 5px; font-size: 14px; font-weight: 600; cursor: pointer; }
    .login-box button:hover { background: #e56a00; }
    .login-error { color: #c00; font-size: 13px; margin-bottom: 15px; }
    
    /* Main Layout */
    .main-container { max-width: 1200px; margin: 0 auto; padding: 20px; display: none; }
    
    /* Tabs */
    .tabs { display: flex; gap: 5px; margin-bottom: 20px; }
    .tab { padding: 10px 20px; background: #fff; border: none; border-radius: 8px 8px 0 0; cursor: pointer; font-size: 14px; font-weight: 500; color: #666; }
    .tab:hover { background: #f0f0f0; }
    .tab.active { background: #f57c00; color: #fff; }
    
    /* Panel */
    .panel { background: #fff; border-radius: 0 8px 8px 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); padding: 20px; }
    
    /* Article List */
    .toolbar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
    .btn-new { background: #f57c00; color: #fff; border: none; padding: 10px 20px; border-radius: 5px; font-size: 14px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 8px; }
    .btn-new:hover { background: #e56a00; }
    .search-box { padding: 10px 15px; border: 1px solid #ddd; border-radius: 5px; font-size: 14px; width: 250px; }
    
    .article-list { border: 1px solid #eee; border-radius: 8px; overflow: hidden; }
    .article-row { display: grid; grid-template-columns: 1fr 120px 150px 100px; padding: 15px; border-bottom: 1px solid #eee; align-items: center; }
    .article-row:last-child { border-bottom: none; }
    .article-row:hover { background: #f9f9f9; }
    .article-row.header { background: #f5f5f5; font-weight: 600; font-size: 12px; text-transform: uppercase; color: #666; }
    .article-title { font-weight: 500; color: #333; cursor: pointer; }
    .article-title:hover { color: #f57c00; }
    .article-status { font-size: 12px; padding: 4px 10px; border-radius: 20px; display: inline-block; }
    .article-status.draft { background: #fff3e0; color: #e65100; }
    .article-status.published { background: #e8f5e9; color: #2e7d32; }
    .article-date { font-size: 13px; color: #666; }
    .article-actions { display: flex; gap: 8px; }
    .btn-edit, .btn-delete { padding: 6px 12px; border: none; border-radius: 4px; font-size: 12px; cursor: pointer; }
    .btn-edit { background: #e3f2fd; color: #1565c0; }
    .btn-edit:hover { background: #bbdefb; }
    .btn-delete { background: #ffebee; color: #c62828; }
    .btn-delete:hover { background: #ffcdd2; }
    
    /* Editor */
    .editor-panel { display: none; }
    .editor-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid #eee; }
    .editor-header h2 { font-size: 18px; }
    .editor-actions { display: flex; gap: 10px; }
    .btn-back { background: #eee; color: #333; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-size: 14px; }
    .btn-back:hover { background: #ddd; }
    .btn-save { background: #2196F3; color: #fff; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-size: 14px; font-weight: 500; }
    .btn-save:hover { background: #1976D2; }
    .btn-publish { background: #4CAF50; color: #fff; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-size: 14px; font-weight: 500; }
    .btn-publish:hover { background: #388E3C; }
    
    .form-grid { display: grid; grid-template-columns: 2fr 1fr; gap: 30px; }
    .form-main, .form-sidebar { display: flex; flex-direction: column; gap: 20px; }
    
    .form-group { display: flex; flex-direction: column; gap: 6px; }
    .form-group label { font-size: 13px; font-weight: 600; color: #555; }
    .form-group input, .form-group select, .form-group textarea { padding: 10px 12px; border: 1px solid #ddd; border-radius: 5px; font-size: 14px; font-family: inherit; }
    .form-group input:focus, .form-group select:focus, .form-group textarea:focus { outline: none; border-color: #f57c00; }
    .form-group textarea { min-height: 300px; resize: vertical; }
    .form-group small { font-size: 11px; color: #999; }
    
    .sidebar-card { background: #f9f9f9; border-radius: 8px; padding: 15px; }
    .sidebar-card h4 { font-size: 13px; font-weight: 600; margin-bottom: 12px; color: #555; }
    
    .game-selector { border: 1px solid #ddd; border-radius: 5px; max-height: 200px; overflow-y: auto; background: #fff; }
    .game-option { padding: 10px; border-bottom: 1px solid #eee; cursor: pointer; font-size: 13px; }
    .game-option:hover { background: #fff3e0; }
    .game-option.selected { background: #f57c00; color: #fff; }
    .game-option .teams { font-weight: 500; }
    .game-option .meta { font-size: 11px; opacity: 0.8; margin-top: 3px; }
    
    .ai-generate { margin-top: 15px; }
    .btn-ai { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: #fff; border: none; padding: 12px 20px; border-radius: 5px; cursor: pointer; font-size: 14px; font-weight: 500; width: 100%; display: flex; align-items: center; justify-content: center; gap: 8px; }
    .btn-ai:hover { opacity: 0.9; }
    .btn-ai:disabled { opacity: 0.5; cursor: not-allowed; }
    
    /* Social posting */
    .social-buttons { display: flex; flex-direction: column; gap: 8px; }
    .btn-social { padding: 10px; border: none; border-radius: 5px; cursor: pointer; font-size: 13px; font-weight: 500; display: flex; align-items: center; gap: 8px; }
    .btn-social.facebook { background: #1877f2; color: #fff; }
    .btn-social.instagram { background: linear-gradient(45deg, #f09433, #e6683c, #dc2743, #cc2366, #bc1888); color: #fff; }
    .btn-social.twitter { background: #000; color: #fff; }
    .btn-social:disabled { opacity: 0.5; }
    .btn-social .posted { margin-left: auto; font-size: 11px; opacity: 0.8; }
    
    /* Browse button */
    .btn-browse { background: #f57c00; color: #fff; border: none; padding: 10px 15px; border-radius: 5px; cursor: pointer; font-size: 13px; font-weight: 500; white-space: nowrap; }
    .btn-browse:hover { background: #e56a00; }
    
    /* SmugMug Modal */
    .modal-overlay { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.6); z-index: 3000; justify-content: center; align-items: center; }
    .modal-overlay.open { display: flex; }
    .modal { background: #fff; border-radius: 10px; width: 90%; max-width: 800px; max-height: 80vh; display: flex; flex-direction: column; }
    .modal-header { padding: 15px 20px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
    .modal-header h3 { font-size: 16px; }
    .modal-close { background: none; border: none; font-size: 24px; cursor: pointer; color: #999; }
    .modal-close:hover { color: #333; }
    .modal-search { padding: 15px 20px; border-bottom: 1px solid #eee; }
    .modal-search input { width: 100%; padding: 10px 15px; border: 1px solid #ddd; border-radius: 5px; font-size: 14px; }
    .modal-body { flex: 1; overflow-y: auto; padding: 15px; }
    .album-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 15px; }
    .album-card { border: 1px solid #eee; border-radius: 8px; overflow: hidden; cursor: pointer; transition: box-shadow 0.2s; }
    .album-card:hover { box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
    .album-card.selected { border: 2px solid #f57c00; }
    .album-thumb { width: 100%; height: 120px; object-fit: cover; background: #f5f5f5; }
    .album-info { padding: 10px; }
    .album-name { font-size: 13px; font-weight: 500; margin-bottom: 4px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .album-meta { font-size: 11px; color: #888; }
    .modal-footer { padding: 15px 20px; border-top: 1px solid #eee; display: flex; justify-content: flex-end; gap: 10px; }
    .btn-modal { padding: 10px 20px; border-radius: 5px; font-size: 14px; cursor: pointer; }
    .btn-modal-cancel { background: #eee; border: none; color: #333; }
    .btn-modal-cancel:hover { background: #ddd; }
    .btn-modal-select { background: #f57c00; border: none; color: #fff; font-weight: 500; }
    .btn-modal-select:hover { background: #e56a00; }
    .btn-modal-select:disabled { background: #ccc; cursor: not-allowed; }
    
    /* Empty state */
    .empty-state { text-align: center; padding: 60px 20px; color: #888; }
    .empty-state p { margin-bottom: 20px; }
    
    /* Toast notifications */
    .toast { position: fixed; bottom: 20px; right: 20px; padding: 15px 25px; background: #333; color: #fff; border-radius: 8px; font-size: 14px; z-index: 2000; display: none; }
    .toast.success { background: #4CAF50; }
    .toast.error { background: #f44336; }
    
    /* Loading */
    .loading { text-align: center; padding: 40px; color: #888; }
    
    @media (max-width: 900px) {
      .form-grid { grid-template-columns: 1fr; }
      .article-row { grid-template-columns: 1fr; gap: 8px; }
      .article-row.header { display: none; }
    }
  </style>
</head>
<body>
  <!-- Login Screen -->
  <div class="login-screen" id="loginScreen">
    <div class="login-box">
      <img src="logo.png" alt="Ball603">
      <h2>Ball603 CMS</h2>
      <p>Content Management System</p>
      <div class="login-error" id="loginError" style="display: none;"></div>
      <input type="password" id="loginPassword" placeholder="Enter password" onkeypress="if(event.key==='Enter')login()">
      <button onclick="login()">Sign In</button>
    </div>
  </div>
  
  <!-- Main App -->
  <div class="header" id="mainHeader" style="display: none;">
    <div class="header-inner">
      <div class="header-left">
        <img src="logo.png" alt="Ball603" onclick="window.location.href='/'">
        <h1>CMS</h1>
      </div>
      <div class="header-right">
        <span class="user-info">Welcome, Admin</span>
        <button class="btn-logout" onclick="logout()">Logout</button>
      </div>
    </div>
  </div>
  
  <div class="main-container" id="mainContainer">
    <div class="tabs">
      <button class="tab active" onclick="showTab('articles')">Articles</button>
      <button class="tab" onclick="showTab('sponsors')">Sponsors</button>
      <button class="tab" onclick="showTab('products')">Webstore</button>
    </div>
    
    <!-- Articles List Panel -->
    <div class="panel" id="articlesPanel">
      <div class="toolbar">
        <button class="btn-new" onclick="newArticle()">
          <span>+</span> New Article
        </button>
        <input type="text" class="search-box" placeholder="Search articles..." oninput="filterArticles(this.value)">
      </div>
      
      <div class="article-list" id="articleList">
        <div class="article-row header">
          <div>Title</div>
          <div>Status</div>
          <div>Date</div>
          <div>Actions</div>
        </div>
        <div class="loading">Loading articles...</div>
      </div>
    </div>
    
    <!-- Article Editor Panel -->
    <div class="panel editor-panel" id="editorPanel">
      <div class="editor-header">
        <h2 id="editorTitle">New Article</h2>
        <div class="editor-actions">
          <button class="btn-back" onclick="closeEditor()">‚Üê Back</button>
          <button class="btn-save" onclick="saveArticle()">Save Draft</button>
          <button class="btn-publish" onclick="publishArticle()">Publish</button>
        </div>
      </div>
      
      <div class="form-grid">
        <div class="form-main">
          <div class="form-group">
            <label>Headline</label>
            <input type="text" id="articleTitle" placeholder="Enter headline...">
          </div>
          
          <div class="form-group">
            <label>Story</label>
            <textarea id="articleContent" placeholder="Write your article..."></textarea>
          </div>
          
          <div class="form-group">
            <label>Excerpt</label>
            <textarea id="articleExcerpt" placeholder="Brief summary for previews..." style="min-height: 80px;"></textarea>
            <small>Used for social media and article previews</small>
          </div>
        </div>
        
        <div class="form-sidebar">
          <div class="sidebar-card">
            <h4>üì∏ Link to Game</h4>
            <input type="text" id="gameSearch" placeholder="Search games..." style="width: 100%; margin-bottom: 10px;" oninput="searchGames(this.value)">
            <div class="game-selector" id="gameSelector">
              <div class="loading">Loading games...</div>
            </div>
            <input type="hidden" id="selectedGameId">
          </div>
          
          <div class="sidebar-card ai-generate" id="boxScoreEntry" style="display: none;">
            <h4>üìä Box Score Entry</h4>
            <p style="font-size: 12px; color: #666; margin-bottom: 12px;">Enter stats to generate article</p>
            
            <div style="background: #f9f9f9; border-radius: 8px; padding: 15px;">
              <!-- Quarter Scores -->
              <div style="margin-bottom: 15px;">
                <label style="font-size: 11px; font-weight: 600; color: #555;">Quarter Scores</label>
                <table style="width: 100%; font-size: 12px; border-collapse: collapse; margin-top: 5px;">
                  <thead>
                    <tr style="background: #eee;">
                      <th style="padding: 5px; text-align: left;">Team</th>
                      <th style="padding: 5px; width: 35px;">Q1</th>
                      <th style="padding: 5px; width: 35px;">Q2</th>
                      <th style="padding: 5px; width: 35px;">Q3</th>
                      <th style="padding: 5px; width: 35px;">Q4</th>
                      <th style="padding: 5px; width: 45px;">Final</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr>
                      <td id="boxAwayTeam" style="padding: 5px; font-weight: 500;">Away</td>
                      <td><input type="number" id="awayQ1" style="width: 32px; padding: 3px; text-align: center;" onchange="calcFinal('away')"></td>
                      <td><input type="number" id="awayQ2" style="width: 32px; padding: 3px; text-align: center;" onchange="calcFinal('away')"></td>
                      <td><input type="number" id="awayQ3" style="width: 32px; padding: 3px; text-align: center;" onchange="calcFinal('away')"></td>
                      <td><input type="number" id="awayQ4" style="width: 32px; padding: 3px; text-align: center;" onchange="calcFinal('away')"></td>
                      <td><input type="number" id="awayFinal" style="width: 42px; padding: 3px; text-align: center; font-weight: bold; background: #e8f5e9;" readonly></td>
                    </tr>
                    <tr>
                      <td id="boxHomeTeam" style="padding: 5px; font-weight: 500;">Home</td>
                      <td><input type="number" id="homeQ1" style="width: 32px; padding: 3px; text-align: center;" onchange="calcFinal('home')"></td>
                      <td><input type="number" id="homeQ2" style="width: 32px; padding: 3px; text-align: center;" onchange="calcFinal('home')"></td>
                      <td><input type="number" id="homeQ3" style="width: 32px; padding: 3px; text-align: center;" onchange="calcFinal('home')"></td>
                      <td><input type="number" id="homeQ4" style="width: 32px; padding: 3px; text-align: center;" onchange="calcFinal('home')"></td>
                      <td><input type="number" id="homeFinal" style="width: 42px; padding: 3px; text-align: center; font-weight: bold; background: #e8f5e9;" readonly></td>
                    </tr>
                  </tbody>
                </table>
              </div>
              
              <!-- Away Team Roster -->
              <div style="margin-bottom: 15px;">
                <label style="font-size: 11px; font-weight: 600; color: #555;" id="awayRosterLabel">Away Roster</label>
                <div style="font-size: 10px; color: #888; margin-bottom: 5px;">Enter points for players who scored. Add 3PT count if notable.</div>
                <div id="awayRosterEntry" style="margin-top: 5px; max-height: 200px; overflow-y: auto;"></div>
                <div style="margin-top: 5px; font-size: 11px; color: #666;">
                  Points total: <strong id="awayPointsTotal">0</strong> | <span id="awayPointsMatch" style="color: #888;">Enter quarters first</span>
                </div>
              </div>
              
              <!-- Home Team Roster -->
              <div style="margin-bottom: 15px;">
                <label style="font-size: 11px; font-weight: 600; color: #555;" id="homeRosterLabel">Home Roster</label>
                <div style="font-size: 10px; color: #888; margin-bottom: 5px;">Enter points for players who scored. Add 3PT count if notable.</div>
                <div id="homeRosterEntry" style="margin-top: 5px; max-height: 200px; overflow-y: auto;"></div>
                <div style="margin-top: 5px; font-size: 11px; color: #666;">
                  Points total: <strong id="homePointsTotal">0</strong> | <span id="homePointsMatch" style="color: #888;">Enter quarters first</span>
                </div>
              </div>
              
              <!-- Notes -->
              <div style="margin-bottom: 15px;">
                <label style="font-size: 11px; font-weight: 600; color: #555;">Game Notes (optional)</label>
                <textarea id="gameNotes" style="width: 100%; min-height: 60px; margin-top: 5px; font-size: 12px; padding: 8px;" placeholder="Any storylines, big plays, injuries, milestones..."></textarea>
              </div>
              
              <button class="btn-ai" onclick="generateArticle()" id="btnGenerate" style="width: 100%;">
                ‚ú® Generate Article
              </button>
            </div>
          </div>
          
          <div class="sidebar-card" id="noGameSelected">
            <div style="text-align: center; padding: 20px; color: #888;">
              <div style="font-size: 24px; margin-bottom: 10px;">üìã</div>
              <p style="font-size: 13px;">Select a game from "Link to Game" above to enter box score</p>
            </div>
          </div>
          
          <div class="sidebar-card">
            <h4>üì∑ Media</h4>
            <div class="form-group">
              <label>SmugMug Gallery</label>
              <div style="display: flex; gap: 8px;">
                <input type="text" id="smugmugUrl" placeholder="https://ball603.smugmug.com/..." style="flex: 1;">
                <button type="button" class="btn-browse" onclick="openSmugMugBrowser()">Browse</button>
              </div>
              <div id="selectedAlbumPreview" style="margin-top: 8px; display: none;">
                <img id="albumThumbnail" style="width: 100%; border-radius: 4px; margin-bottom: 5px;">
                <small id="albumInfo" style="color: #666;"></small>
              </div>
            </div>
            <div class="form-group">
              <label>Photographer Credit</label>
              <input type="text" id="photographerCredit" placeholder="Photo by...">
            </div>
          </div>
          
          <div class="sidebar-card">
            <h4>üì± Social Media</h4>
            <div class="social-buttons">
              <button class="btn-social facebook" onclick="postToSocial('facebook')" id="btnFacebook">
                üìò Post to Facebook
                <span class="posted" id="facebookPosted" style="display: none;">‚úì Posted</span>
              </button>
              <button class="btn-social instagram" onclick="postToSocial('instagram')" id="btnInstagram">
                üì∏ Copy for Instagram
                <span class="posted" id="instagramPosted" style="display: none;">‚úì Copied</span>
              </button>
              <button class="btn-social twitter" onclick="postToSocial('twitter')" id="btnTwitter">
                ùïè Post to X
                <span class="posted" id="twitterPosted" style="display: none;">‚úì Posted</span>
              </button>
            </div>
            <small style="display: block; margin-top: 10px; color: #999;">Social posting available after publishing</small>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Sponsors Panel -->
    <div class="panel" id="sponsorsPanel" style="display: none;">
      <div class="toolbar">
        <button class="btn-new" onclick="newSponsor()">
          <span>+</span> Add Sponsor
        </button>
      </div>
      <div id="sponsorList">
        <div class="empty-state">
          <p>No sponsors yet</p>
        </div>
      </div>
    </div>
    
    <!-- Products Panel -->
    <div class="panel" id="productsPanel" style="display: none;">
      <div class="toolbar">
        <button class="btn-new" onclick="newProduct()">
          <span>+</span> Add Product
        </button>
      </div>
      <div id="productList">
        <div class="empty-state">
          <p>No products yet</p>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Toast -->
  <div class="toast" id="toast"></div>
  
  <!-- SmugMug Browser Modal -->
  <div class="modal-overlay" id="smugmugModal">
    <div class="modal">
      <div class="modal-header">
        <h3>üì∏ Select SmugMug Gallery</h3>
        <button class="modal-close" onclick="closeSmugMugBrowser()">&times;</button>
      </div>
      <div class="modal-search">
        <input type="text" id="albumSearch" placeholder="Search albums..." oninput="searchAlbums(this.value)">
      </div>
      <div class="modal-body">
        <div class="album-grid" id="albumGrid">
          <div class="loading">Loading albums...</div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn-modal btn-modal-cancel" onclick="closeSmugMugBrowser()">Cancel</button>
        <button class="btn-modal btn-modal-select" id="btnSelectAlbum" onclick="selectSmugMugAlbum()" disabled>Select Album</button>
      </div>
    </div>
  </div>

  <script src="rosters_data.js"></script>
  <script>
    // Supabase config
    const SUPABASE_URL = 'https://suncdkxfqkwwnmhosxcf.supabase.co';
    const SUPABASE_ANON_KEY = 'sb_publishable_hHSpgZPD327r11GaQG9iHw_uZbuaWmF';
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    
    // CMS Password
    const CMS_PASSWORD = 'Gr@niteSt@teHoops';
    
    // State
    let articles = [];
    let games = [];
    let currentArticle = null;
    let selectedGame = null;
    
    // Login
    function login() {
      const password = document.getElementById('loginPassword').value;
      if (password === CMS_PASSWORD) {
        sessionStorage.setItem('cms_auth', 'true');
        showApp();
      } else {
        document.getElementById('loginError').textContent = 'Incorrect password';
        document.getElementById('loginError').style.display = 'block';
      }
    }
    
    function logout() {
      sessionStorage.removeItem('cms_auth');
      location.reload();
    }
    
    function showApp() {
      document.getElementById('loginScreen').style.display = 'none';
      document.getElementById('mainHeader').style.display = 'block';
      document.getElementById('mainContainer').style.display = 'block';
      loadArticles();
      loadGames();
    }
    
    // Check auth on load
    if (sessionStorage.getItem('cms_auth') === 'true') {
      showApp();
    }
    
    // Tabs
    function showTab(tab) {
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      event.target.classList.add('active');
      
      document.getElementById('articlesPanel').style.display = tab === 'articles' ? 'block' : 'none';
      document.getElementById('sponsorsPanel').style.display = tab === 'sponsors' ? 'block' : 'none';
      document.getElementById('productsPanel').style.display = tab === 'products' ? 'block' : 'none';
      document.getElementById('editorPanel').style.display = 'none';
    }
    
    // Load articles
    async function loadArticles() {
      const { data, error } = await supabase
        .from('articles')
        .select('*')
        .order('created_at', { ascending: false });
      
      if (error) {
        console.error('Error loading articles:', error);
        showToast('Error loading articles', 'error');
        return;
      }
      
      articles = data || [];
      renderArticles();
    }
    
    function renderArticles(filter = '') {
      const list = document.getElementById('articleList');
      const filtered = articles.filter(a => 
        a.title.toLowerCase().includes(filter.toLowerCase())
      );
      
      if (filtered.length === 0) {
        list.innerHTML = `
          <div class="article-row header">
            <div>Title</div>
            <div>Status</div>
            <div>Date</div>
            <div>Actions</div>
          </div>
          <div class="empty-state">
            <p>No articles found</p>
            <button class="btn-new" onclick="newArticle()">Create your first article</button>
          </div>
        `;
        return;
      }
      
      list.innerHTML = `
        <div class="article-row header">
          <div>Title</div>
          <div>Status</div>
          <div>Date</div>
          <div>Actions</div>
        </div>
        ${filtered.map(article => `
          <div class="article-row">
            <div class="article-title" onclick="editArticle('${article.id}')">${article.title || 'Untitled'}</div>
            <div><span class="article-status ${article.status}">${article.status}</span></div>
            <div class="article-date">${formatDate(article.created_at)}</div>
            <div class="article-actions">
              <button class="btn-edit" onclick="editArticle('${article.id}')">Edit</button>
              <button class="btn-delete" onclick="deleteArticle('${article.id}')">Delete</button>
            </div>
          </div>
        `).join('')}
      `;
    }
    
    function filterArticles(value) {
      renderArticles(value);
    }
    
    function formatDate(dateStr) {
      if (!dateStr) return '-';
      const date = new Date(dateStr);
      return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
    }
    
    // Load games for selector
    async function loadGames() {
      try {
        const response = await fetch('/.netlify/functions/get-games');
        const data = await response.json();
        games = data.games || [];
        renderGameSelector();
      } catch (err) {
        console.error('Error loading games:', err);
        document.getElementById('gameSelector').innerHTML = '<div style="padding: 10px; color: #999;">Could not load games</div>';
      }
    }
    
    function renderGameSelector(filter = '') {
      const selector = document.getElementById('gameSelector');
      
      let filtered = games.filter(g => {
        if (filter) {
          const search = filter.toLowerCase();
          return g.away?.toLowerCase().includes(search) || 
                 g.home?.toLowerCase().includes(search);
        }
        return true;
      }).slice(0, 20);
      
      if (filtered.length === 0) {
        selector.innerHTML = '<div style="padding: 10px; color: #999;">No games found</div>';
        return;
      }
      
      selector.innerHTML = filtered.map(g => `
        <div class="game-option ${g.game_id === document.getElementById('selectedGameId').value ? 'selected' : ''}" 
             onclick="selectGame('${g.game_id}', '${g.away} @ ${g.home}')">
          <div class="teams">${g.away || 'TBD'} @ ${g.home || 'TBD'}</div>
          <div class="meta">${g.date} ‚Ä¢ ${g.gender} ${g.division || ''}</div>
        </div>
      `).join('');
    }
    
    function searchGames(value) {
      renderGameSelector(value);
    }
    
    function selectGame(gameId, label) {
      document.getElementById('selectedGameId').value = gameId;
      selectedGame = games.find(g => g.game_id === gameId) || null;
      renderGameSelector();
      showBoxScoreEntry();
    }
    
    // Show/hide box score entry based on game selection
    function showBoxScoreEntry() {
      const entryForm = document.getElementById('boxScoreEntry');
      const noGameMsg = document.getElementById('noGameSelected');
      
      if (selectedGame) {
        entryForm.style.display = 'block';
        noGameMsg.style.display = 'none';
        populateBoxScoreForm();
      } else {
        entryForm.style.display = 'none';
        noGameMsg.style.display = 'block';
      }
    }
    
    // Populate box score form with team rosters
    function populateBoxScoreForm() {
      if (!selectedGame) return;
      
      // Set team names
      document.getElementById('boxAwayTeam').textContent = selectedGame.away;
      document.getElementById('boxHomeTeam').textContent = selectedGame.home;
      document.getElementById('awayRosterLabel').textContent = selectedGame.away + ' Roster';
      document.getElementById('homeRosterLabel').textContent = selectedGame.home + ' Roster';
      
      // Clear quarter scores
      ['awayQ1', 'awayQ2', 'awayQ3', 'awayQ4', 'awayFinal', 'homeQ1', 'homeQ2', 'homeQ3', 'homeQ4', 'homeFinal'].forEach(id => {
        document.getElementById(id).value = '';
      });
      
      // Get rosters
      const rosters = getTeamRosters();
      
      // Populate roster entry sections
      populateRosterEntry('away', rosters.away);
      populateRosterEntry('home', rosters.home);
      
      // Reset notes
      document.getElementById('gameNotes').value = '';
    }
    
    // Populate roster entry for a team
    function populateRosterEntry(team, roster) {
      const container = document.getElementById(team + 'RosterEntry');
      container.innerHTML = '';
      
      if (!roster || !roster.players) {
        container.innerHTML = '<div style="color: #e65100; font-size: 11px; padding: 10px;">‚ö†Ô∏è No roster found. Enter player names manually below.</div>';
        // Add a few empty rows for manual entry
        for (let i = 0; i < 5; i++) {
          addManualPlayerRow(container, team);
        }
        return;
      }
      
      // Create row for each player on roster
      roster.players.forEach(player => {
        const row = document.createElement('div');
        row.style.cssText = 'display: flex; gap: 5px; margin-bottom: 3px; align-items: center;';
        row.innerHTML = `
          <span style="flex: 2; font-size: 11px; color: #333;">#${player.number} ${player.name} <span style="color: #888;">(${player.class || ''}${player.position ? ' ' + player.position : ''})</span></span>
          <input type="number" data-player="${player.name}" data-team="${team}" class="pts-input" placeholder="Pts" style="width: 40px; padding: 3px; font-size: 11px; text-align: center;" onchange="updatePointsTotal('${team}')">
          <input type="number" data-player="${player.name}" data-team="${team}" class="threept-input" placeholder="3PT" style="width: 40px; padding: 3px; font-size: 11px; text-align: center; color: #1565c0;">
        `;
        container.appendChild(row);
      });
      
      // Add button for unlisted players
      const addBtn = document.createElement('button');
      addBtn.type = 'button';
      addBtn.style.cssText = 'font-size: 10px; background: #e3f2fd; border: none; padding: 4px 8px; border-radius: 3px; cursor: pointer; margin-top: 5px;';
      addBtn.textContent = '+ Add unlisted player';
      addBtn.onclick = () => addManualPlayerRow(container, team, addBtn);
      container.appendChild(addBtn);
    }
    
    // Add manual player entry row
    function addManualPlayerRow(container, team, beforeElement) {
      const row = document.createElement('div');
      row.style.cssText = 'display: flex; gap: 5px; margin-bottom: 3px; align-items: center;';
      row.innerHTML = `
        <input type="text" placeholder="Player name" class="manual-name" data-team="${team}" style="flex: 2; padding: 3px; font-size: 11px;">
        <input type="number" class="pts-input manual-pts" data-team="${team}" placeholder="Pts" style="width: 40px; padding: 3px; font-size: 11px; text-align: center;" onchange="updatePointsTotal('${team}')">
        <input type="number" class="threept-input" data-team="${team}" placeholder="3PT" style="width: 40px; padding: 3px; font-size: 11px; text-align: center; color: #1565c0;">
        <button type="button" onclick="this.parentElement.remove(); updatePointsTotal('${team}')" style="background: #ffebee; border: none; padding: 2px 6px; border-radius: 3px; cursor: pointer; color: #c62828; font-size: 10px;">‚úï</button>
      `;
      if (beforeElement) {
        container.insertBefore(row, beforeElement);
      } else {
        container.appendChild(row);
      }
    }
    
    // Calculate final from quarters
    function calcFinal(team) {
      const q1 = parseInt(document.getElementById(team + 'Q1').value) || 0;
      const q2 = parseInt(document.getElementById(team + 'Q2').value) || 0;
      const q3 = parseInt(document.getElementById(team + 'Q3').value) || 0;
      const q4 = parseInt(document.getElementById(team + 'Q4').value) || 0;
      const final = q1 + q2 + q3 + q4;
      document.getElementById(team + 'Final').value = final || '';
      updatePointsTotal(team);
    }
    
    // Update points total and check if it matches final
    function updatePointsTotal(team) {
      const container = document.getElementById(team + 'RosterEntry');
      const ptsInputs = container.querySelectorAll('.pts-input');
      let total = 0;
      ptsInputs.forEach(input => {
        total += parseInt(input.value) || 0;
      });
      
      document.getElementById(team + 'PointsTotal').textContent = total;
      
      const final = parseInt(document.getElementById(team + 'Final').value) || 0;
      const matchSpan = document.getElementById(team + 'PointsMatch');
      
      if (!final) {
        matchSpan.textContent = 'Enter quarters first';
        matchSpan.style.color = '#888';
      } else if (total === final) {
        matchSpan.textContent = '‚úì Matches final';
        matchSpan.style.color = '#2e7d32';
      } else {
        matchSpan.textContent = `‚â† Final is ${final} (off by ${Math.abs(final - total)})`;
        matchSpan.style.color = '#c62828';
      }
    }
    
    // Article CRUD
    function newArticle() {
      currentArticle = null;
      document.getElementById('editorTitle').textContent = 'New Article';
      document.getElementById('articleTitle').value = '';
      document.getElementById('articleContent').value = '';
      document.getElementById('articleExcerpt').value = '';
      document.getElementById('selectedGameId').value = '';
      selectedGame = null;
      document.getElementById('smugmugUrl').value = '';
      document.getElementById('photographerCredit').value = '';
      selectedGame = null;
      
      document.getElementById('articlesPanel').style.display = 'none';
      document.getElementById('editorPanel').style.display = 'block';
      
      renderGameSelector();
      showBoxScoreEntry();
      updateSocialButtons(false);
    }
    
    async function editArticle(id) {
      const article = articles.find(a => a.id === id);
      if (!article) return;
      
      currentArticle = article;
      document.getElementById('editorTitle').textContent = 'Edit Article';
      document.getElementById('articleTitle').value = article.title || '';
      document.getElementById('articleContent').value = article.content || '';
      document.getElementById('articleExcerpt').value = article.excerpt || '';
      document.getElementById('selectedGameId').value = article.game_id || '';
      selectedGame = article.game_id ? games.find(g => g.game_id === article.game_id) : null;
      document.getElementById('smugmugUrl').value = article.smugmug_gallery_url || '';
      document.getElementById('photographerCredit').value = article.photographer_credit || '';
      
      document.getElementById('articlesPanel').style.display = 'none';
      document.getElementById('editorPanel').style.display = 'block';
      
      renderGameSelector();
      updateSocialButtons(article.status === 'published', article);
    }
    
    function closeEditor() {
      document.getElementById('editorPanel').style.display = 'none';
      document.getElementById('articlesPanel').style.display = 'block';
      currentArticle = null;
    }
    
    function generateSlug(title) {
      return title
        .toLowerCase()
        .replace(/[^a-z0-9]+/g, '-')
        .replace(/(^-|-$)/g, '')
        .substring(0, 60);
    }
    
    async function saveArticle() {
      const title = document.getElementById('articleTitle').value.trim();
      if (!title) {
        showToast('Please enter a headline', 'error');
        return;
      }
      
      const articleData = {
        title,
        slug: generateSlug(title) + '-' + Date.now(),
        content: document.getElementById('articleContent').value,
        excerpt: document.getElementById('articleExcerpt').value,
        game_id: document.getElementById('selectedGameId').value || null,
        smugmug_gallery_url: document.getElementById('smugmugUrl').value || null,
        photographer_credit: document.getElementById('photographerCredit').value || null,
        status: 'draft',
        updated_at: new Date().toISOString()
      };
      
      let result;
      if (currentArticle) {
        result = await supabase
          .from('articles')
          .update(articleData)
          .eq('id', currentArticle.id)
          .select();
      } else {
        result = await supabase
          .from('articles')
          .insert([articleData])
          .select();
      }
      
      if (result.error) {
        console.error('Save error:', result.error);
        showToast('Error saving article', 'error');
        return;
      }
      
      showToast('Article saved!', 'success');
      currentArticle = result.data[0];
      loadArticles();
    }
    
    async function publishArticle() {
      const title = document.getElementById('articleTitle').value.trim();
      if (!title) {
        showToast('Please enter a headline', 'error');
        return;
      }
      
      const articleData = {
        title,
        slug: generateSlug(title) + '-' + Date.now(),
        content: document.getElementById('articleContent').value,
        excerpt: document.getElementById('articleExcerpt').value,
        game_id: document.getElementById('selectedGameId').value || null,
        smugmug_gallery_url: document.getElementById('smugmugUrl').value || null,
        photographer_credit: document.getElementById('photographerCredit').value || null,
        status: 'published',
        published_at: new Date().toISOString(),
        updated_at: new Date().toISOString()
      };
      
      let result;
      if (currentArticle) {
        result = await supabase
          .from('articles')
          .update(articleData)
          .eq('id', currentArticle.id)
          .select();
      } else {
        result = await supabase
          .from('articles')
          .insert([articleData])
          .select();
      }
      
      if (result.error) {
        console.error('Publish error:', result.error);
        showToast('Error publishing article', 'error');
        return;
      }
      
      showToast('Article published!', 'success');
      currentArticle = result.data[0];
      loadArticles();
      updateSocialButtons(true, currentArticle);
    }
    
    async function deleteArticle(id) {
      if (!confirm('Delete this article?')) return;
      
      const { error } = await supabase
        .from('articles')
        .delete()
        .eq('id', id);
      
      if (error) {
        showToast('Error deleting article', 'error');
        return;
      }
      
      showToast('Article deleted', 'success');
      loadArticles();
    }
    
    // AI Generation
    let scorePhotoBase64 = null;
    let extractedData = null;
    
    function previewScorePhoto(input) {
      const file = input.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
          scorePhotoBase64 = e.target.result;
          document.getElementById('photoPreviewImg').src = scorePhotoBase64;
          document.getElementById('photoPreview').style.display = 'block';
        };
        reader.readAsDataURL(file);
      }
    }
    
    function clearScorePhoto() {
      scorePhotoBase64 = null;
      document.getElementById('scorePhoto').value = '';
      document.getElementById('photoPreview').style.display = 'none';
    }
    
    // Get rosters for selected teams
    function getTeamRosters() {
      if (!selectedGame || typeof ROSTERS_DATA === 'undefined') return { away: null, home: null };
      
      const gender = selectedGame.gender || 'Boys';
      const awayName = selectedGame.away;
      const homeName = selectedGame.home;
      
      let awayRoster = null;
      let homeRoster = null;
      
      if (ROSTERS_DATA.rosters) {
        awayRoster = ROSTERS_DATA.rosters.find(r => 
          r.gender === gender && 
          (r.school === awayName || awayName.includes(r.school) || r.school.includes(awayName))
        );
        homeRoster = ROSTERS_DATA.rosters.find(r => 
          r.gender === gender && 
          (r.school === homeName || homeName.includes(r.school) || r.school.includes(homeName))
        );
      }
      
      return { away: awayRoster, home: homeRoster };
    }
    
    // Update roster status when game is selected
    function updateRosterStatus() {
      const status = document.getElementById('rosterStatus');
      if (!selectedGame) {
        status.textContent = '‚ö†Ô∏è Select a game above to enable roster matching';
        status.style.color = '#e65100';
        return;
      }
      
      const rosters = getTeamRosters();
      const hasAway = !!rosters.away;
      const hasHome = !!rosters.home;
      
      if (hasAway && hasHome) {
        status.innerHTML = `‚úÖ Rosters loaded: <strong>${selectedGame.away}</strong> & <strong>${selectedGame.home}</strong>`;
        status.style.color = '#2e7d32';
      } else if (hasAway || hasHome) {
        const missing = !hasAway ? selectedGame.away : selectedGame.home;
        status.innerHTML = `‚ö†Ô∏è Roster missing for: <strong>${missing}</strong>`;
        status.style.color = '#e65100';
      } else {
        status.innerHTML = `‚ö†Ô∏è No rosters found for either team`;
        status.style.color = '#e65100';
      }
    }
    
    // Add scorer row to proof form
    function addScorerRow(team, data = {}) {
      const container = document.getElementById(team + 'Scorers');
      const rosters = getTeamRosters();
      const roster = team === 'away' ? rosters.away : rosters.home;
      
      const row = document.createElement('div');
      row.style.cssText = 'display: flex; gap: 5px; margin-bottom: 5px; align-items: center;';
      
      // Build player dropdown if roster available
      let playerSelect = '';
      if (roster && roster.players) {
        playerSelect = `<select style="flex: 2; padding: 4px; font-size: 12px;" onchange="this.nextElementSibling.value=this.value">
          <option value="">-- Select --</option>
          ${roster.players.map(p => `<option value="${p.name}" ${data.name === p.name ? 'selected' : ''}>#${p.number} ${p.name} (${p.class})</option>`).join('')}
        </select>`;
      }
      
      row.innerHTML = `
        ${playerSelect}
        <input type="text" placeholder="Player name" value="${data.name || ''}" style="flex: 2; padding: 4px; font-size: 12px;">
        <input type="text" placeholder="Pts" value="${data.points || ''}" style="width: 35px; padding: 4px; font-size: 12px; text-align: center;">
        <button type="button" onclick="this.parentElement.remove()" style="background: #ffebee; border: none; padding: 4px 8px; border-radius: 3px; cursor: pointer; color: #c62828; font-size: 11px;">‚úï</button>
      `;
      container.appendChild(row);
    }
    
    // Extract box score from image
    async function extractBoxScore() {
      if (!scorePhotoBase64 && !document.getElementById('aiInput').value.trim()) {
        showToast('Please upload a scorebook photo or enter notes', 'error');
        return;
      }
      
      if (!selectedGame) {
        showToast('Please select a game first to enable roster matching', 'error');
        return;
      }
      
      const btn = document.getElementById('btnExtract');
      btn.disabled = true;
      btn.innerHTML = '‚è≥ Reading scorebook...';
      
      const rosters = getTeamRosters();
      const notes = document.getElementById('aiInput').value.trim();
      
      try {
        const response = await fetch('/.netlify/functions/generate-article', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            mode: 'extract',
            image: scorePhotoBase64,
            notes: notes,
            gameInfo: {
              away: selectedGame.away,
              home: selectedGame.home,
              gender: selectedGame.gender,
              date: selectedGame.date,
              division: selectedGame.division
            },
            awayRoster: rosters.away,
            homeRoster: rosters.home
          })
        });
        
        const data = await response.json();
        
        if (data.success && data.extracted) {
          extractedData = data.extracted;
          populateProofForm(data.extracted);
          document.getElementById('aiStep1').style.display = 'none';
          document.getElementById('aiStep2').style.display = 'block';
          showToast('Box score extracted! Please verify and edit if needed.', 'success');
        } else {
          showToast(data.error || 'Failed to extract box score', 'error');
        }
      } catch (err) {
        console.error('Extract error:', err);
        showToast('Failed to extract box score', 'error');
      }
      
      btn.disabled = false;
      btn.innerHTML = 'üìã Extract & Review';
    }
    
    // Populate proof form with extracted data
    function populateProofForm(data) {
      // Team names
      document.getElementById('proofAwayTeam').textContent = selectedGame.away;
      document.getElementById('proofHomeTeam').textContent = selectedGame.home;
      document.getElementById('awayScorerLabel').textContent = selectedGame.away + ' Scorers';
      document.getElementById('homeScorerLabel').textContent = selectedGame.home + ' Scorers';
      
      // Quarter scores
      document.getElementById('awayQ1').value = data.awayQuarters?.[0] || '';
      document.getElementById('awayQ2').value = data.awayQuarters?.[1] || '';
      document.getElementById('awayQ3').value = data.awayQuarters?.[2] || '';
      document.getElementById('awayQ4').value = data.awayQuarters?.[3] || '';
      document.getElementById('awayFinal').value = data.awayFinal || '';
      
      document.getElementById('homeQ1').value = data.homeQuarters?.[0] || '';
      document.getElementById('homeQ2').value = data.homeQuarters?.[1] || '';
      document.getElementById('homeQ3').value = data.homeQuarters?.[2] || '';
      document.getElementById('homeQ4').value = data.homeQuarters?.[3] || '';
      document.getElementById('homeFinal').value = data.homeFinal || '';
      
      // Clear and populate scorers
      document.getElementById('awayScorers').innerHTML = '';
      document.getElementById('homeScorers').innerHTML = '';
      
      (data.awayScorers || []).forEach(s => addScorerRow('away', s));
      (data.homeScorers || []).forEach(s => addScorerRow('home', s));
      
      // Add empty rows if none
      if (!data.awayScorers?.length) addScorerRow('away');
      if (!data.homeScorers?.length) addScorerRow('home');
      
      // Notes
      document.getElementById('proofNotes').value = data.notes || '';
    }
    
    // Go back to upload step
    function backToUpload() {
      document.getElementById('aiStep1').style.display = 'block';
      document.getElementById('aiStep2').style.display = 'none';
    }
    
    // Collect data from proof form
    function collectProofData() {
      const awayScorers = [];
      document.querySelectorAll('#awayScorers > div').forEach(row => {
        const inputs = row.querySelectorAll('input[type="text"]');
        const name = inputs[inputs.length - 2]?.value?.trim();
        const points = inputs[inputs.length - 1]?.value?.trim();
        if (name && points) awayScorers.push({ name, points });
      });
      
      const homeScorers = [];
      document.querySelectorAll('#homeScorers > div').forEach(row => {
        const inputs = row.querySelectorAll('input[type="text"]');
        const name = inputs[inputs.length - 2]?.value?.trim();
        const points = inputs[inputs.length - 1]?.value?.trim();
        if (name && points) homeScorers.push({ name, points });
      });
      
      return {
        awayTeam: selectedGame.away,
        homeTeam: selectedGame.home,
        gender: selectedGame.gender,
        division: selectedGame.division,
        date: selectedGame.date,
        awayQuarters: [
          document.getElementById('awayQ1').value,
          document.getElementById('awayQ2').value,
          document.getElementById('awayQ3').value,
          document.getElementById('awayQ4').value
        ],
        homeQuarters: [
          document.getElementById('homeQ1').value,
          document.getElementById('homeQ2').value,
          document.getElementById('homeQ3').value,
          document.getElementById('homeQ4').value
        ],
        awayFinal: document.getElementById('awayFinal').value,
        homeFinal: document.getElementById('homeFinal').value,
        awayScorers,
        homeScorers,
        notes: document.getElementById('proofNotes').value
      };
    }
    
    // Generate article from confirmed proof data
    // Generate article from manual box score entry
    async function generateArticle() {
      // Validate quarters entered
      const awayFinal = parseInt(document.getElementById('awayFinal').value) || 0;
      const homeFinal = parseInt(document.getElementById('homeFinal').value) || 0;
      
      if (!awayFinal && !homeFinal) {
        showToast('Please enter quarter scores first', 'error');
        return;
      }
      
      // Collect quarter scores
      const awayQuarters = [
        parseInt(document.getElementById('awayQ1').value) || 0,
        parseInt(document.getElementById('awayQ2').value) || 0,
        parseInt(document.getElementById('awayQ3').value) || 0,
        parseInt(document.getElementById('awayQ4').value) || 0
      ];
      const homeQuarters = [
        parseInt(document.getElementById('homeQ1').value) || 0,
        parseInt(document.getElementById('homeQ2').value) || 0,
        parseInt(document.getElementById('homeQ3').value) || 0,
        parseInt(document.getElementById('homeQ4').value) || 0
      ];
      
      // Collect scorers from roster entries
      const awayScorers = collectScorers('away');
      const homeScorers = collectScorers('home');
      
      // Validate points match
      const awayPtsTotal = awayScorers.reduce((sum, s) => sum + s.points, 0);
      const homePtsTotal = homeScorers.reduce((sum, s) => sum + s.points, 0);
      
      if (awayPtsTotal !== awayFinal) {
        showToast(`${selectedGame.away} points (${awayPtsTotal}) don't match final (${awayFinal})`, 'error');
        return;
      }
      if (homePtsTotal !== homeFinal) {
        showToast(`${selectedGame.home} points (${homePtsTotal}) don't match final (${homeFinal})`, 'error');
        return;
      }
      
      const btn = document.getElementById('btnGenerate');
      btn.disabled = true;
      btn.innerHTML = '‚è≥ Writing article...';
      
      const rosters = getTeamRosters();
      const notes = document.getElementById('gameNotes').value.trim();
      
      const proofData = {
        awayTeam: selectedGame.away,
        homeTeam: selectedGame.home,
        awayQuarters: awayQuarters,
        homeQuarters: homeQuarters,
        awayFinal: awayFinal,
        homeFinal: homeFinal,
        awayScorers: awayScorers,
        homeScorers: homeScorers,
        gender: selectedGame.gender || 'Boys',
        division: selectedGame.division || '',
        date: selectedGame.date || '',
        notes: notes
      };
      
      try {
        const response = await fetch('/.netlify/functions/generate-article', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            mode: 'write',
            proofData: proofData,
            awayRoster: rosters.away,
            homeRoster: rosters.home
          })
        });
        
        const data = await response.json();
        
        if (data.success) {
          if (data.headline) {
            document.getElementById('articleTitle').value = data.headline;
          }
          if (data.article) {
            document.getElementById('articleContent').value = data.article;
          }
          if (data.excerpt) {
            document.getElementById('articleExcerpt').value = data.excerpt;
          }
          
          showToast('Article generated! Review and edit as needed.', 'success');
        } else {
          showToast(data.error || 'Failed to generate article', 'error');
        }
      } catch (err) {
        console.error('Generation error:', err);
        showToast('Failed to generate article', 'error');
      }
      
      btn.disabled = false;
      btn.innerHTML = '‚ú® Generate Article';
    }
    
    // Collect scorers from roster entry section
    function collectScorers(team) {
      const container = document.getElementById(team + 'RosterEntry');
      const scorers = [];
      
      // Roster players with points
      container.querySelectorAll('.pts-input[data-player]').forEach(input => {
        const pts = parseInt(input.value) || 0;
        if (pts > 0) {
          const name = input.getAttribute('data-player');
          const threePtInput = container.querySelector(`.threept-input[data-player="${name}"]`);
          const threePts = parseInt(threePtInput?.value) || 0;
          scorers.push({ name: name, points: pts, threePointers: threePts });
        }
      });
      
      // Manual entries
      container.querySelectorAll('.manual-name').forEach(nameInput => {
        const name = nameInput.value.trim();
        if (name) {
          const row = nameInput.parentElement;
          const ptsInput = row.querySelector('.manual-pts');
          const threePtInput = row.querySelector('.threept-input');
          const pts = parseInt(ptsInput?.value) || 0;
          const threePts = parseInt(threePtInput?.value) || 0;
          if (pts > 0) {
            scorers.push({ name: name, points: pts, threePointers: threePts });
          }
        }
      });
      
      // Sort by points descending
      scorers.sort((a, b) => b.points - a.points);
      return scorers;
    }

    async function generateFromProof() {
      const proofData = collectProofData();
      
      if (!proofData.awayFinal || !proofData.homeFinal) {
        showToast('Please enter final scores', 'error');
        return;
      }
      
      const btn = document.getElementById('btnGenerate');
      btn.disabled = true;
      btn.innerHTML = '‚è≥ Writing article...';
      
      const rosters = getTeamRosters();
      
      try {
        const response = await fetch('/.netlify/functions/generate-article', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            mode: 'write',
            proofData: proofData,
            awayRoster: rosters.away,
            homeRoster: rosters.home
          })
        });
        
        const data = await response.json();
        
        if (data.success) {
          if (data.headline) {
            document.getElementById('articleTitle').value = data.headline;
          }
          if (data.article) {
            document.getElementById('articleContent').value = data.article;
          }
          if (data.excerpt) {
            document.getElementById('articleExcerpt').value = data.excerpt;
          }
          
          // Reset AI section
          backToUpload();
          clearScorePhoto();
          document.getElementById('aiInput').value = '';
          
          showToast('Article generated! Review and edit as needed.', 'success');
        } else {
          showToast(data.error || 'Failed to generate article', 'error');
        }
      } catch (err) {
        console.error('Generation error:', err);
        showToast('Failed to generate article', 'error');
      }
      
      btn.disabled = false;
      btn.innerHTML = '‚ú® Generate Article';
    }
    
    // Social posting
    function updateSocialButtons(enabled, article = null) {
      const btns = ['btnFacebook', 'btnInstagram', 'btnTwitter'];
      btns.forEach(id => {
        document.getElementById(id).disabled = !enabled;
      });
      
      if (article) {
        document.getElementById('facebookPosted').style.display = article.posted_facebook ? 'inline' : 'none';
        document.getElementById('instagramPosted').style.display = article.posted_instagram ? 'inline' : 'none';
        document.getElementById('twitterPosted').style.display = article.posted_twitter ? 'inline' : 'none';
      }
    }
    
    async function postToSocial(platform) {
      const title = document.getElementById('articleTitle').value;
      const content = document.getElementById('articleContent').value;
      const excerpt = document.getElementById('articleExcerpt').value || content.substring(0, 200);
      const gallery = document.getElementById('smugmugUrl').value;
      const photographer = document.getElementById('photographerCredit').value;
      
      let postText = '';
      
      if (platform === 'facebook') {
        postText = `üèÄ ${title}\n\n${excerpt}\n\n`;
        if (gallery) postText += `üì∏ Full gallery: ${gallery}\n`;
        if (photographer) postText += `üì∑ Photos by ${photographer}\n`;
        postText += `\n#Ball603 #NHBasketball`;
      } else if (platform === 'instagram') {
        postText = `üèÄ ${title}\n\n${excerpt}\n\nüì∏ Link in bio for full gallery!\n`;
        if (photographer) postText += `üì∑ @${photographer.replace(/\s+/g, '')}\n`;
        postText += `\n#Ball603 #NHBasketball #NHIAA`;
      } else if (platform === 'twitter') {
        postText = `üèÄ ${title}\n\n${excerpt.substring(0, 180)}...\n\n`;
        if (gallery) postText += `üì∏ ${gallery}\n`;
        postText += `#NHBasketball`;
      }
      
      // Copy to clipboard
      try {
        await navigator.clipboard.writeText(postText);
        showToast(`${platform.charAt(0).toUpperCase() + platform.slice(1)} post copied to clipboard!`, 'success');
        
        // Mark as posted
        if (currentArticle) {
          const update = {};
          update[`posted_${platform}`] = true;
          await supabase
            .from('articles')
            .update(update)
            .eq('id', currentArticle.id);
          
          document.getElementById(`${platform}Posted`).style.display = 'inline';
        }
      } catch (err) {
        showToast('Could not copy to clipboard', 'error');
      }
    }
    
    // Toast
    function showToast(message, type = 'success') {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.className = `toast ${type}`;
      toast.style.display = 'block';
      setTimeout(() => toast.style.display = 'none', 3000);
    }
    
    // Sponsors & Products (placeholders)
    function newSponsor() {
      showToast('Sponsor management coming soon!', 'error');
    }
    
    function newProduct() {
      showToast('Product management coming soon!', 'error');
    }
    
    // SmugMug Browser
    let smugmugAlbums = [];
    let selectedAlbum = null;
    
    async function openSmugMugBrowser() {
      document.getElementById('smugmugModal').classList.add('open');
      document.getElementById('albumGrid').innerHTML = '<div class="loading">Loading albums...</div>';
      selectedAlbum = null;
      document.getElementById('btnSelectAlbum').disabled = true;
      
      try {
        const response = await fetch('/.netlify/functions/smugmug?action=albums');
        const data = await response.json();
        
        if (data.success) {
          smugmugAlbums = data.albums || [];
          renderAlbumGrid();
        } else {
          document.getElementById('albumGrid').innerHTML = '<div class="loading">Error loading albums</div>';
        }
      } catch (err) {
        console.error('SmugMug error:', err);
        document.getElementById('albumGrid').innerHTML = '<div class="loading">Could not connect to SmugMug</div>';
      }
    }
    
    function closeSmugMugBrowser() {
      document.getElementById('smugmugModal').classList.remove('open');
      selectedAlbum = null;
    }
    
    function renderAlbumGrid(filter = '') {
      const grid = document.getElementById('albumGrid');
      
      let filtered = smugmugAlbums;
      if (filter) {
        filtered = smugmugAlbums.filter(a => 
          a.name.toLowerCase().includes(filter.toLowerCase())
        );
      }
      
      if (filtered.length === 0) {
        grid.innerHTML = '<div class="loading">No albums found</div>';
        return;
      }
      
      grid.innerHTML = filtered.map(album => `
        <div class="album-card ${selectedAlbum?.key === album.key ? 'selected' : ''}" 
             onclick="selectAlbumCard('${album.key}')">
          <img class="album-thumb" 
               src="${album.highlightImage || 'data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><rect fill=%22%23f5f5f5%22 width=%22100%22 height=%22100%22/><text x=%2250%22 y=%2255%22 text-anchor=%22middle%22 fill=%22%23ccc%22 font-size=%2230%22>üì∑</text></svg>'}" 
               alt="${album.name}"
               onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><rect fill=%22%23f5f5f5%22 width=%22100%22 height=%22100%22/><text x=%2250%22 y=%2255%22 text-anchor=%22middle%22 fill=%22%23ccc%22 font-size=%2230%22>üì∑</text></svg>'">
          <div class="album-info">
            <div class="album-name" title="${album.name}">${album.name}</div>
            <div class="album-meta">${album.imageCount || 0} photos${album.date ? ' ‚Ä¢ ' + album.date : ''}</div>
          </div>
        </div>
      `).join('');
    }
    
    function searchAlbums(value) {
      renderAlbumGrid(value);
    }
    
    function selectAlbumCard(key) {
      selectedAlbum = smugmugAlbums.find(a => a.key === key);
      document.getElementById('btnSelectAlbum').disabled = !selectedAlbum;
      renderAlbumGrid(document.getElementById('albumSearch').value);
    }
    
    function selectSmugMugAlbum() {
      if (!selectedAlbum) return;
      
      document.getElementById('smugmugUrl').value = selectedAlbum.url;
      
      // Show preview
      const preview = document.getElementById('selectedAlbumPreview');
      if (selectedAlbum.highlightImage) {
        document.getElementById('albumThumbnail').src = selectedAlbum.highlightImage;
        preview.style.display = 'block';
      } else {
        preview.style.display = 'none';
      }
      document.getElementById('albumInfo').textContent = `${selectedAlbum.name} ‚Ä¢ ${selectedAlbum.imageCount} photos`;
      preview.style.display = 'block';
      
      closeSmugMugBrowser();
      showToast('Album selected!', 'success');
    }
  </script>
</body>
</html>
