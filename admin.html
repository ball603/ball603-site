<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ball603 CMS</title>
  <script>window.BALL603_CMS_VERSION = '2024.12.21.v3';</script>
  <!-- Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-S4BN80729K"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-S4BN80729K');
  </script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.0"></script>
  <!-- Fabric.js for Graphic Creator -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.1/fabric.min.js"></script>
  <!-- Google Fonts for Graphic Creator -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Covered+By+Your+Grace&family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
  <!-- Quill.js Rich Text Editor -->
  <link href="https://cdn.quilljs.com/1.3.7/quill.snow.css" rel="stylesheet">
  <script src="https://cdn.quilljs.com/1.3.7/quill.min.js"></script>
  <!-- Cropper.js for image cropping -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.css" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.js"></script>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f5f5f5; color: #333; min-height: 100vh; }
    
    /* Header */
    .header { background: #fff; padding: 15px 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); position: relative; z-index: 1000; }
    .header-inner { max-width: 1200px; margin: 0 auto; display: flex; justify-content: space-between; align-items: center; }
    .header-left { display: flex; align-items: center; gap: 15px; }
    .header-left img { height: 50px; cursor: pointer; }
    .header-left h1 { font-size: 20px; color: #333; }
    .header-right { display: flex; align-items: center; gap: 15px; }
    .user-info { font-size: 13px; color: #666; }
    .btn-logout { background: #eee; border: none; padding: 8px 16px; border-radius: 5px; cursor: pointer; font-size: 13px; }
    .btn-logout:hover { background: #ddd; }
    
    /* Login Screen */
    .login-screen { display: flex; justify-content: center; align-items: center; min-height: 100vh; padding: 20px; }
    .login-box { background: #fff; padding: 40px; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); text-align: center; max-width: 400px; width: 100%; }
    .login-box img { height: 80px; margin-bottom: 20px; }
    .login-box h2 { margin-bottom: 10px; color: #333; }
    .login-box p { color: #666; margin-bottom: 25px; font-size: 14px; }
    .login-box input { width: 100%; padding: 12px 15px; border: 1px solid #ddd; border-radius: 5px; font-size: 14px; margin-bottom: 15px; }
    .login-box input:focus { outline: none; border-color: #f57c00; }
    .login-box button { width: 100%; padding: 12px; background: #f57c00; color: #fff; border: none; border-radius: 5px; font-size: 14px; font-weight: 600; cursor: pointer; }
    .login-box button:hover { background: #e56a00; }
    .login-error { color: #c00; font-size: 13px; margin-bottom: 15px; }
    
    /* Main Layout */
    .main-container { max-width: 1200px; margin: 0 auto; padding: 20px; display: none; }
    
    /* Tabs */
    .tabs { display: flex; gap: 5px; margin-bottom: 5px; flex-wrap: wrap; }
    .tabs-row-2 { display: flex; gap: 5px; margin-bottom: 20px; flex-wrap: wrap; }
    .tabs-row-2 .tab { background: #f0f0f0; }
    .tabs-row-2 .tab:hover { background: #e5e5e5; }
    .tabs-row-2 .tab.active { background: #1a73e8; color: #fff; }
    .tab { padding: 10px 20px; background: #fff; border: none; border-radius: 8px 8px 0 0; cursor: pointer; font-size: 14px; font-weight: 500; color: #666; }
    .tab:hover { background: #f0f0f0; }
    .tab.active { background: #f57c00; color: #fff; }
    
    /* Panel */
    .panel { background: #fff; border-radius: 0 8px 8px 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); padding: 20px; }
    
    /* Article List */
    .toolbar { display: flex; align-items: center; margin-bottom: 20px; gap: 10px; }
    .btn-new { background: #e0e0e0; color: #333; border: none; padding: 10px 20px; border-radius: 5px; font-size: 14px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 8px; }
    .btn-new:hover { background: #d0d0d0; }
    .search-box { padding: 10px 15px; border: 1px solid #ddd; border-radius: 5px; font-size: 14px; width: 250px; margin-left: auto; }
    
    .article-list { border: 1px solid #eee; border-radius: 8px; overflow: hidden; }
    .article-row { display: grid; grid-template-columns: 1fr 80px 70px 90px 100px 100px 100px; padding: 12px 15px; border-bottom: 1px solid #eee; align-items: center; gap: 8px; }
    .article-row:last-child { border-bottom: none; }
    .article-row:hover { background: #f9f9f9; }
    .article-row.pinned { background: #fff8e1; }
    .article-row.pinned:hover { background: #ffecb3; }
    .article-row.header { background: #f5f5f5; font-weight: 600; font-size: 12px; text-transform: uppercase; color: #666; }
    .article-row.header:hover { background: #f5f5f5; }
    .article-row.header .sortable:hover { color: #1a73e8; }
    .article-thumb { width: 48px; height: 27px; object-fit: cover; border-radius: 4px; flex-shrink: 0; }
    .article-thumb-placeholder { width: 48px; height: 27px; background: #eee; border-radius: 4px; display: flex; align-items: center; justify-content: center; font-size: 12px; flex-shrink: 0; }
    .article-title { font-weight: 500; color: #333; cursor: pointer; }
    .article-title:hover { color: #f57c00; }
    .article-status { font-size: 12px; padding: 4px 10px; border-radius: 20px; display: inline-block; }
    .article-status.draft { background: #fff3e0; color: #e65100; }
    .article-status.published { background: #e8f5e9; color: #2e7d32; }
    .article-status.scheduled { background: #f3e5f5; color: #7b1fa2; }
    .article-date { font-size: 13px; color: #666; }
    .article-level { font-size: 13px; color: #666; }
    .article-gender { font-size: 13px; color: #666; }
    .article-actions { display: flex; gap: 8px; }
    .btn-edit, .btn-delete { padding: 6px 12px; border: none; border-radius: 4px; font-size: 12px; cursor: pointer; }
    .btn-edit { background: #e3f2fd; color: #1565c0; }
    .btn-edit:hover { background: #bbdefb; }
    .btn-delete { background: #ffebee; color: #c62828; }
    .btn-delete:hover { background: #ffcdd2; }
    
    /* Editor */
    .editor-panel { display: none; }
    .editor-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid #eee; }
    .editor-header h2 { font-size: 18px; }
    .editor-actions { display: flex; gap: 10px; }
    .btn-back { background: #e0e0e0; color: #333; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-size: 14px; }
    .btn-back:hover { background: #d0d0d0; }
    .btn-save { background: #f57c00; color: #fff; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-size: 14px; font-weight: 500; }
    .btn-save:hover { background: #e56a00; }
    .btn-publish { background: #f57c00; color: #fff; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-size: 14px; font-weight: 500; }
    .btn-publish:hover { background: #e56a00; }
    .btn-preview { background: #e0e0e0; color: #333; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-size: 14px; font-weight: 500; }
    .btn-preview:hover { background: #d0d0d0; }
    
    .form-grid { display: grid; grid-template-columns: 2fr 1fr; gap: 30px; }
    .form-main, .form-sidebar { display: flex; flex-direction: column; gap: 20px; }
    
    .form-group { display: flex; flex-direction: column; gap: 6px; }
    .form-group label { font-size: 13px; font-weight: 600; color: #555; }
    .form-group input, .form-group select, .form-group textarea { padding: 10px 12px; border: 1px solid #ddd; border-radius: 5px; font-size: 14px; font-family: inherit; }
    .form-group input:focus, .form-group select:focus, .form-group textarea:focus { outline: none; border-color: #f57c00; }
    .form-group textarea { min-height: 300px; resize: vertical; }
    .form-group small { font-size: 11px; color: #999; }
    
    .sidebar-card { background: #f9f9f9; border-radius: 8px; padding: 15px; }
    .sidebar-card h4 { font-size: 13px; font-weight: 600; margin-bottom: 12px; color: #555; }
    
    /* Quill Editor Styles */
    .ql-container { font-size: 15px; font-family: inherit; }
    .ql-editor { min-height: 350px; line-height: 1.7; }
    .ql-editor p { margin-bottom: 1em; }
    .ql-toolbar.ql-snow { border-radius: 5px 5px 0 0; background: #fafafa; }
    .ql-container.ql-snow { border-radius: 0 0 5px 5px; }
    
    /* Custom Image Styles in Editor */
    .ql-editor .article-image { margin: 20px 0; }
    .ql-editor .article-image.align-left { float: left; margin-right: 20px; margin-bottom: 10px; clear: left; }
    .ql-editor .article-image.align-right { float: right; margin-left: 20px; margin-bottom: 10px; clear: right; }
    .ql-editor .article-image.align-center { display: block; margin-left: auto; margin-right: auto; clear: both; }
    .ql-editor .article-image.size-small { width: 25%; }
    .ql-editor .article-image.size-medium { width: 50%; }
    .ql-editor .article-image.size-full { width: 100%; }
    .ql-editor .article-image img { width: 100%; height: auto; border-radius: 6px; }
    .ql-editor .article-image .caption { font-size: 13px; color: #666; font-style: italic; margin-top: 6px; text-align: center; }
    .ql-editor .clearfix { clear: both; }
    
    /* Featured Image */
    .featured-image-container { border: 2px dashed #ddd; border-radius: 8px; padding: 20px; text-align: center; margin-bottom: 15px; cursor: pointer; transition: all 0.2s; background: #fafafa; }
    .featured-image-container:hover { border-color: #f57c00; background: #fff8f0; }
    .featured-image-container.drag-over { border-color: #f57c00; background: #fff3e0; border-style: solid; }
    .featured-image-container.has-image { border-style: solid; border-color: #ddd; padding: 0; overflow: hidden; }
    .featured-image-container .placeholder { color: #888; }
    .featured-image-container .placeholder span { font-size: 40px; display: block; margin-bottom: 10px; }
    .featured-image-preview { position: relative; }
    .featured-image-preview img { width: 100%; aspect-ratio: 16/9; object-fit: cover; display: block; }
    .featured-image-preview .remove-btn { position: absolute; top: 10px; right: 10px; background: rgba(0,0,0,0.7); color: white; border: none; border-radius: 50%; width: 30px; height: 30px; cursor: pointer; font-size: 16px; }
    .featured-image-preview .image-info { padding: 10px; background: #f5f5f5; font-size: 12px; color: #666; }
    
    /* Image Insert Modal */
    .image-modal { max-width: 500px; }
    .image-modal .form-group { margin-bottom: 15px; }
    .image-modal .alignment-options, .image-modal .size-options { display: flex; gap: 10px; }
    .image-modal .alignment-options label, .image-modal .size-options label { flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 5px; text-align: center; cursor: pointer; transition: all 0.2s; }
    .image-modal .alignment-options input, .image-modal .size-options input { display: none; }
    .image-modal .alignment-options input:checked + span, .image-modal .size-options input:checked + span { background: #f57c00; color: white; }
    .image-modal .alignment-options label:has(input:checked), .image-modal .size-options label:has(input:checked) { border-color: #f57c00; background: #fff8f0; }
    
    /* Cropper Modal */
    .cropper-modal-content { max-width: 700px; }
    .cropper-container-wrapper { max-height: 400px; overflow: hidden; background: #333; border-radius: 6px; }
    .cropper-container-wrapper img { max-width: 100%; display: block; }
    .crop-aspect-buttons { display: flex; gap: 8px; margin-bottom: 15px; flex-wrap: wrap; }
    .crop-aspect-buttons button { padding: 8px 14px; border: 1px solid #ddd; background: #fff; border-radius: 5px; cursor: pointer; font-size: 13px; }
    .crop-aspect-buttons button:hover { background: #f5f5f5; }
    .crop-aspect-buttons button.active { background: #f57c00; color: white; border-color: #f57c00; }
    
    .game-selector { border: 1px solid #ddd; border-radius: 5px; max-height: 200px; overflow-y: auto; background: #fff; }
    .game-option { padding: 10px; border-bottom: 1px solid #eee; cursor: pointer; font-size: 13px; }
    .game-option:hover { background: #fff3e0; }
    .game-option.selected { background: #f57c00; color: #fff; }
    .game-option .teams { font-weight: 500; }
    .game-option .meta { font-size: 11px; opacity: 0.8; margin-top: 3px; }
    
    .ai-generate { margin-top: 15px; }
    .btn-ai { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: #fff; border: none; padding: 12px 20px; border-radius: 5px; cursor: pointer; font-size: 14px; font-weight: 500; width: 100%; display: flex; align-items: center; justify-content: center; gap: 8px; }
    .btn-ai:hover { opacity: 0.9; }
    .btn-ai:disabled { opacity: 0.5; cursor: not-allowed; }
    
    /* Social posting */
    .social-buttons { display: flex; flex-direction: column; gap: 8px; }
    .btn-social { padding: 10px; border: none; border-radius: 5px; cursor: pointer; font-size: 13px; font-weight: 500; display: flex; align-items: center; gap: 8px; }
    .btn-social.facebook { background: #1877f2; color: #fff; }
    .btn-social.instagram { background: linear-gradient(45deg, #f09433, #e6683c, #dc2743, #cc2366, #bc1888); color: #fff; }
    .btn-social.twitter { background: #000; color: #fff; }
    .btn-social:disabled { opacity: 0.5; }
    .btn-social .posted { margin-left: auto; font-size: 11px; opacity: 0.8; }
    
    /* Browse button */
    .btn-browse { background: #f57c00; color: #fff; border: none; padding: 10px 15px; border-radius: 5px; cursor: pointer; font-size: 13px; font-weight: 500; white-space: nowrap; }
    .btn-browse:hover { background: #e56a00; }
    
    /* SmugMug Modal */
    .modal-overlay { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.6); z-index: 3000; justify-content: center; align-items: center; }
    .modal-overlay.open { display: flex; }
    .modal { background: #fff; border-radius: 10px; width: 90%; max-width: 800px; max-height: 80vh; display: flex; flex-direction: column; }
    .modal-header { padding: 15px 20px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
    .modal-header h3 { font-size: 16px; }
    .modal-close { background: none; border: none; font-size: 24px; cursor: pointer; color: #999; }
    .modal-close:hover { color: #333; }
    .modal-search { padding: 15px 20px; border-bottom: 1px solid #eee; }
    .modal-search input { width: 100%; padding: 10px 15px; border: 1px solid #ddd; border-radius: 5px; font-size: 14px; }
    .modal-body { flex: 1; overflow-y: auto; padding: 15px; }
    .album-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 15px; }
    .album-card { border: 1px solid #eee; border-radius: 8px; overflow: hidden; cursor: pointer; transition: box-shadow 0.2s; }
    .album-card:hover { box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
    .album-card.selected { border: 2px solid #f57c00; }
    .album-thumb { width: 100%; height: 120px; object-fit: cover; background: #f5f5f5; }
    .album-info { padding: 10px; }
    .album-name { font-size: 13px; font-weight: 500; margin-bottom: 4px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .album-meta { font-size: 11px; color: #888; }
    .modal-footer { padding: 15px 20px; border-top: 1px solid #eee; display: flex; justify-content: flex-end; gap: 10px; }
    .btn-modal { padding: 10px 20px; border-radius: 5px; font-size: 14px; cursor: pointer; }
    .btn-modal-cancel { background: #eee; border: none; color: #333; }
    .btn-modal-cancel:hover { background: #ddd; }
    .btn-modal-select { background: #f57c00; border: none; color: #fff; font-weight: 500; }
    .btn-modal-select:hover { background: #e56a00; }
    .btn-modal-select:disabled { background: #ccc; cursor: not-allowed; }
    
    /* Empty state */
    .empty-state { text-align: center; padding: 60px 20px; color: #888; }
    .empty-state p { margin-bottom: 20px; }
    
    /* Toast notifications */
    .toast { position: fixed; bottom: 20px; right: 20px; padding: 15px 25px; background: #333; color: #fff; border-radius: 8px; font-size: 14px; z-index: 2000; display: none; }
    .toast.success { background: #4CAF50; }
    .toast.error { background: #f44336; }
    
    /* Loading */
    .loading { text-align: center; padding: 40px; color: #888; }
    
    @media (max-width: 900px) {
      .form-grid { grid-template-columns: 1fr; }
      .article-row { grid-template-columns: 1fr; gap: 8px; }
      .article-row.header { display: none; }
    }
    
    /* The Bash Panel Styles */
    .bash-admin-tabs { display: flex; gap: 5px; margin-bottom: 20px; border-bottom: 2px solid #eee; padding-bottom: 10px; }
    .bash-admin-tab { padding: 8px 16px; background: none; border: 1px solid #ddd; border-radius: 5px 5px 0 0; cursor: pointer; font-size: 13px; color: #666; }
    .bash-admin-tab:hover { background: #f5f5f5; }
    .bash-admin-tab.active { background: #f57c00; color: white; border-color: #f57c00; }
    .bash-sub-panel { display: none; }
    .bash-sub-panel.active { display: block; }
    .bash-table { width: 100%; border-collapse: collapse; }
    .bash-table th, .bash-table td { padding: 10px 12px; text-align: left; border-bottom: 1px solid #eee; font-size: 13px; }
    .bash-table th { background: #f5f5f5; font-weight: 600; color: #555; text-transform: uppercase; font-size: 11px; }
    .bash-table tr:hover { background: #f9f9f9; }
    .bash-score { font-weight: 600; }
    .bash-winner { color: #f57c00; }
    .bash-form-row { display: grid; gap: 15px; margin-bottom: 15px; }
    .bash-form-row.cols-2 { grid-template-columns: 1fr 1fr; }
    .bash-form-row.cols-3 { grid-template-columns: 1fr 1fr 1fr; }
    .bash-form-row.cols-4 { grid-template-columns: 1fr 1fr 1fr 1fr; }
    .bash-scorer-row { display: flex; gap: 6px; margin-bottom: 6px; }
    .bash-scorer-row .bash-scorer-name { flex: 2; padding: 6px 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px; }
    .bash-scorer-row .bash-scorer-pts { width: 50px; padding: 6px 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px; text-align: center; }
    .bash-roster-container { max-height: 220px; overflow-y: auto; border: 1px solid #eee; border-radius: 5px; padding: 6px; background: #fafafa; }
    .bash-roster-row { display: flex; gap: 4px; margin-bottom: 4px; align-items: center; }
    .bash-roster-row .player-info { flex: 1; font-size: 11px; color: #333; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; min-width: 0; }
    .bash-roster-row .player-num { color: #888; font-size: 10px; margin-right: 2px; }
    .bash-roster-row input[type="number"] { width: 36px; padding: 3px 4px; border: 1px solid #ddd; border-radius: 3px; font-size: 11px; text-align: center; }
    .bash-roster-row input[type="text"] { flex: 1; padding: 3px 4px; border: 1px solid #ddd; border-radius: 3px; font-size: 11px; min-width: 0; }
    .bash-roster-row .input-label { font-size: 9px; color: #999; text-align: center; display: block; }
    
    /* Graphics Creator Styles */
    .gc-sidebar-card { background: #fff; border: 1px solid #e5e5e5; border-radius: 8px; overflow: hidden; }
    .gc-card-header { display: flex; justify-content: space-between; align-items: center; padding: 10px 12px; background: #f8f8f8; border-bottom: 1px solid #e5e5e5; cursor: pointer; font-size: 13px; font-weight: 600; color: #444; }
    .gc-card-header:hover { background: #f0f0f0; }
    .gc-card-body { padding: 12px; }
    .gc-card-body.collapsed { display: none; }
    .gc-toggle { font-size: 10px; color: #888; transition: transform 0.2s; }
    .gc-toggle.collapsed { transform: rotate(-90deg); }
    
    .gc-layers-panel .gc-card-header { cursor: default; }
    .gc-layer-item { background: #f9f9f9; border: 1px solid #e5e5e5; border-radius: 6px; margin: 4px 0; overflow: hidden; }
    .gc-layer-item.selected { border-color: #f57c00; background: #fff8f0; }
    .gc-layer-item.dragging { opacity: 0.5; }
    .gc-layer-header { display: flex; align-items: center; gap: 8px; padding: 8px 10px; cursor: pointer; font-size: 12px; }
    .gc-layer-header:hover { background: #f0f0f0; }
    .gc-layer-drag { cursor: grab; color: #aaa; font-size: 14px; }
    .gc-layer-name { flex: 1; font-weight: 500; color: #333; }
    .gc-layer-type-badge { font-size: 10px; padding: 2px 6px; border-radius: 3px; background: #e0e0e0; color: #666; }
    .gc-layer-actions { display: flex; gap: 4px; }
    .gc-layer-btn { background: none; border: none; cursor: pointer; font-size: 14px; opacity: 0.6; padding: 2px; }
    .gc-layer-btn:hover { opacity: 1; }
    .gc-layer-btn.active { opacity: 1; }
    .gc-layer-btn.visibility-off { opacity: 0.3; }
    .gc-layer-body { display: none; padding: 10px; border-top: 1px solid #e5e5e5; background: #fff; }
    .gc-layer-item.expanded .gc-layer-body { display: block; }
    
    .gc-layer-field { margin-bottom: 10px; }
    .gc-layer-field:last-child { margin-bottom: 0; }
    .gc-layer-field label { display: block; font-size: 11px; color: #666; margin-bottom: 4px; }
    .gc-layer-field input, .gc-layer-field select, .gc-layer-field textarea { width: 100%; padding: 6px 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px; }
    .gc-layer-field input[type="color"] { width: 40px; height: 30px; padding: 2px; cursor: pointer; }
    .gc-layer-field input[type="range"] { padding: 0; }
    .gc-layer-field input[type="checkbox"] { width: auto; }
    .gc-layer-field-row { display: flex; gap: 10px; }
    .gc-layer-field-row > * { flex: 1; }
    
    .gc-dropzone { border: 2px dashed #ddd; border-radius: 6px; padding: 20px 10px; text-align: center; cursor: pointer; transition: all 0.2s; background: #fafafa; }
    .gc-dropzone:hover { border-color: #bbb; background: #f5f5f5; }
    .gc-dropzone.drag-over { border-color: #f57c00; background: #fff8f0; }
    .gc-dropzone-icon { font-size: 24px; margin-bottom: 5px; }
    .gc-dropzone-text { font-size: 11px; color: #888; }
    
    .gc-btn { padding: 8px 16px; border: none; border-radius: 5px; font-size: 13px; font-weight: 500; cursor: pointer; display: inline-flex; align-items: center; gap: 6px; transition: all 0.15s; }
    .gc-btn-primary { background: #f57c00; color: #fff; }
    .gc-btn-primary:hover { background: #e56a00; }
    .gc-btn-secondary { background: #e0e0e0; color: #333; }
    .gc-btn-secondary:hover { background: #d0d0d0; }
    .gc-btn-success { background: #4caf50; color: #fff; }
    .gc-btn-success:hover { background: #43a047; }
    .gc-btn-danger { background: #ffebee; color: #c62828; }
    .gc-btn-danger:hover { background: #ffcdd2; }
    
    .gc-template-card { background: #fff; border: 1px solid #e5e5e5; border-radius: 8px; padding: 15px; text-align: center; cursor: pointer; transition: all 0.2s; }
    .gc-template-card:hover { border-color: #f57c00; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
    .gc-template-card.gc-template-new { border-style: dashed; background: #fafafa; color: #888; }
    .gc-template-card.gc-template-new:hover { background: #fff; color: #f57c00; }
    .gc-template-thumb { width: 100%; aspect-ratio: 4/5; object-fit: cover; border-radius: 4px; margin-bottom: 10px; background: #f0f0f0; }
    .gc-template-name { font-size: 13px; font-weight: 500; color: #333; margin-bottom: 4px; }
    .gc-template-desc { font-size: 11px; color: #888; }
    .gc-align-btn { width: 28px; height: 26px; border: 1px solid #ddd; background: #fff; border-radius: 4px; cursor: pointer; font-size: 12px; display: flex; align-items: center; justify-content: center; }
    .gc-align-btn:hover { background: #f5f5f5; border-color: #ccc; }
    .gc-align-btn:active { background: #e8e8e8; }
    .gc-polygon-drawing { cursor: crosshair !important; }
    .gc-polygon-point { fill: #f57c00; stroke: #fff; stroke-width: 2; }
  </style>
</head>
<body>
  <!-- Login Screen -->
  <div class="login-screen" id="loginScreen">
    <div class="login-box">
      <img src="logo.png" alt="Ball603">
      <h2>Ball603 CMS</h2>
      <p>Content Management System</p>
      <div class="login-error" id="loginError" style="display: none;"></div>
      <input type="password" id="loginPassword" placeholder="Enter password" onkeypress="if(event.key==='Enter')login()">
      <button onclick="login()">Sign In</button>
    </div>
  </div>
  
  <!-- Main App -->
  <div class="header" id="mainHeader" style="display: none;">
    <div class="header-inner">
      <div class="header-left">
        <img src="logo.png" alt="Ball603" onclick="window.location.href='/'">
        <h1>CMS</h1>
      </div>
      <div class="header-right">
        <span class="user-info">Welcome, Admin</span>
        <button class="btn-logout" onclick="logout()">Logout</button>
      </div>
    </div>
  </div>
  
  <div class="main-container" id="mainContainer">
    <div class="tabs">
      <button class="tab active" onclick="showTab('articles')">Articles</button>
      <button class="tab" onclick="showTab('schedule')">Schedule</button>
      <button class="tab" onclick="showTab('teams')">Teams</button>
      <button class="tab" onclick="showTab('contributors')">Contributors</button>
      <button class="tab" onclick="showTab('sponsors')">Sponsors</button>
      <button class="tab" onclick="showTab('products')">Webstore</button>
      <button class="tab" onclick="showTab('rosters')">Rosters</button>
      <button class="tab" onclick="showTab('bash')">The Bash</button>
      <button class="tab" onclick="showTab('graphics')">üé® Graphics</button>
      <button class="tab" onclick="showTab('galleries')">üì∑ Galleries</button>
      <button class="tab" onclick="showTab('video')">üé¨ Video</button>
    </div>
    
    <!-- Second Row of Tabs (Data Management) -->
    <div class="tabs tabs-row-2">
      <button class="tab" onclick="showTab('championships')">üèÜ Championships</button>
      <button class="tab" onclick="showTab('scorers1k')">üéØ 1K Scorers</button>
      <button class="tab" onclick="showTab('ncaaplayers')">üéì NCAA Players</button>
      <button class="tab" onclick="showTab('settings')" style="margin-left: auto;">‚öôÔ∏è Settings</button>
    </div>
    
    <!-- Articles List Panel -->
    <div class="panel" id="articlesPanel">
      <div class="toolbar">
        <button class="btn-new" onclick="newGameStory()">
          <span>+</span> Scorebook Story
        </button>
        <button class="btn-new" onclick="newBoxscoreStory()">
          <span>+</span> Boxscore Story
        </button>
        <button class="btn-new" onclick="newArticle()">
          <span>+</span> News Article
        </button>
        <input type="text" class="search-box" placeholder="Search articles..." oninput="filterArticles(this.value)" id="articleSearch">
        <button class="btn-new" style="background: #fff3e0; color: #e65100;" onclick="openPinArticlesModal()">
          <span>üìå</span> Pin Stories
        </button>
        <button class="btn-new" style="background: #ffebee; color: #c62828;" onclick="openDeleteBySlugModal()">
          <span>üóëÔ∏è</span> Delete by Slug
        </button>
      </div>
      
      <div class="article-list" id="articleList">
        <div class="article-row header">
          <div>Title</div>
          <div>Status</div>
          <div>Date</div>
          <div>Actions</div>
        </div>
        <div class="loading">Loading articles...</div>
      </div>
    </div>
    
    <!-- Schedule Panel -->
    <div class="panel" id="schedulePanel" style="display: none;">
      <div class="toolbar" style="flex-wrap: wrap; gap: 10px;">
        <button class="btn-new" onclick="openGameModal()">
          <span>+</span> Add Game
        </button>
        <button class="btn-new" style="background: #e3f2fd; color: #1565c0;" onclick="openGameImportModal()">
          <span>üì•</span> Import CSV
        </button>
        <button class="btn-new" style="background: #fff3e0; color: #e65100;" onclick="exportGames()">
          <span>üì§</span> Export CSV
        </button>
        <button class="btn-new" style="background: #e8f5e9; color: #2e7d32;" onclick="document.getElementById('coverageRestoreInput').click()">
          <span>üìÑ</span> Restore Coverage
        </button>
        <input type="file" id="coverageRestoreInput" accept=".csv" style="display: none;" onchange="restoreCoverageFromCSV(this.files[0])">
        
        <!-- Date Navigation -->
        <div style="display: flex; align-items: center; gap: 8px; margin-left: auto;">
          <button onclick="navigateGameDate(-1)" style="padding: 8px 14px; border: 1px solid #ddd; background: #fff; border-radius: 5px; cursor: pointer; font-size: 16px;">‚óÄ</button>
          <button onclick="goToToday()" id="currentGameDate" style="padding: 8px 16px; border: 1px solid #ddd; background: #fff; border-radius: 5px; cursor: pointer; font-size: 13px; font-weight: 600; min-width: 140px;">Today</button>
          <button onclick="navigateGameDate(1)" style="padding: 8px 14px; border: 1px solid #ddd; background: #fff; border-radius: 5px; cursor: pointer; font-size: 16px;">‚ñ∂</button>
        </div>
        
        <div style="display: flex; gap: 8px; align-items: center; flex-wrap: wrap;">
          <select id="gameLevelFilter" onchange="filterGames()" style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 5px; font-size: 13px;">
            <option value="">All Levels</option>
            <option value="NHIAA">NHIAA</option>
            <option value="College">College</option>
            <option value="Prep School">Prep School</option>
          </select>
          <select id="gameDivisionFilter" onchange="filterGames()" style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 5px; font-size: 13px;">
            <option value="">All Divisions</option>
            <optgroup label="High School">
              <option value="D-I">D-I</option>
              <option value="D-II">D-II</option>
              <option value="D-III">D-III</option>
              <option value="D-IV">D-IV</option>
            </optgroup>
            <optgroup label="College">
              <option value="D1">D1 (NCAA)</option>
              <option value="D2">D2 (NCAA)</option>
              <option value="D3">D3 (NCAA)</option>
            </optgroup>
            <optgroup label="Prep">
              <option value="NEPSAC">NEPSAC</option>
            </optgroup>
          </select>
          <select id="gameGenderFilter" onchange="filterGames()" style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 5px; font-size: 13px;">
            <option value="">All Genders</option>
            <option value="Boys">Boys</option>
            <option value="Girls">Girls</option>
            <option value="Men">Men</option>
            <option value="Women">Women</option>
          </select>
          <input type="text" id="gameSearchBox" placeholder="Search teams..." oninput="filterGames()" style="width: 150px; padding: 8px 12px; border: 1px solid #ddd; border-radius: 5px; font-size: 13px;">
        </div>
      </div>
      
      <div style="padding: 10px 15px; background: #f5f5f5; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center;">
        <span id="gameCount" style="font-size: 13px; color: #666;">Loading games...</span>
        <div style="display: flex; gap: 10px;">
          <label style="font-size: 12px; display: flex; align-items: center; gap: 5px; cursor: pointer;">
            <input type="checkbox" id="showCoverageOnly" onchange="filterGames()"> With coverage
          </label>
          <label style="font-size: 12px; display: flex; align-items: center; gap: 5px; cursor: pointer;">
            <input type="checkbox" id="showFinalOnly" onchange="filterGames()"> Final only
          </label>
        </div>
      </div>
      
      <div class="article-list" id="gameList" style="max-height: calc(100vh - 280px); overflow-y: auto;">
        <div class="article-row header" style="grid-template-columns: 90px 1fr 1fr 70px 80px 50px 80px 100px; position: sticky; top: 0; z-index: 10; background: #fff;">
          <div>Date</div>
          <div>Away</div>
          <div>Home</div>
          <div>Score</div>
          <div>Division</div>
          <div>URLs</div>
          <div>Coverage</div>
          <div>Actions</div>
        </div>
        <div class="loading">Loading games...</div>
      </div>
    </div>
    
    <!-- Quick Score Modal -->
    <div id="quickScoreModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 2000; align-items: center; justify-content: center;">
      <div style="background: #fff; border-radius: 10px; padding: 25px; max-width: 350px; width: 90%; box-shadow: 0 4px 20px rgba(0,0,0,0.3);">
        <h3 style="margin: 0 0 5px; font-size: 16px; color: #333;">Quick Score Update</h3>
        <p id="quickScoreMatchup" style="margin: 0 0 20px; font-size: 13px; color: #666;"></p>
        <input type="hidden" id="quickScoreGameId">
        <div style="display: grid; grid-template-columns: 1fr auto 1fr; gap: 10px; align-items: center; margin-bottom: 20px;">
          <div>
            <label style="display: block; font-size: 11px; color: #888; margin-bottom: 5px;" id="quickScoreAwayLabel">Away</label>
            <input type="number" id="quickScoreAway" style="width: 100%; padding: 12px; font-size: 24px; text-align: center; border: 2px solid #ddd; border-radius: 8px; font-weight: 600;" min="0">
          </div>
          <span style="font-size: 24px; color: #ccc; padding-top: 15px;">-</span>
          <div>
            <label style="display: block; font-size: 11px; color: #888; margin-bottom: 5px;" id="quickScoreHomeLabel">Home</label>
            <input type="number" id="quickScoreHome" style="width: 100%; padding: 12px; font-size: 24px; text-align: center; border: 2px solid #ddd; border-radius: 8px; font-weight: 600;" min="0">
          </div>
        </div>
        <div style="display: flex; gap: 10px;">
          <button onclick="closeQuickScore()" style="flex: 1; padding: 12px; border: 1px solid #ddd; background: #f5f5f5; border-radius: 6px; cursor: pointer; font-size: 14px;">Cancel</button>
          <button onclick="clearQuickScore()" style="padding: 12px 16px; border: 1px solid #ffcdd2; background: #ffebee; color: #c62828; border-radius: 6px; cursor: pointer; font-size: 14px;">Clear</button>
          <button onclick="saveQuickScore()" style="flex: 1; padding: 12px; border: none; background: #1565c0; color: white; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 600;">Save</button>
        </div>
      </div>
    </div>

    <!-- Game Edit Modal -->
    <div id="gameModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 2000; overflow-y: auto;">
      <div style="max-width: 800px; margin: 30px auto; background: #fff; border-radius: 10px; overflow: hidden; box-shadow: 0 4px 20px rgba(0,0,0,0.3);">
        <div style="background: #1565c0; color: white; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center;">
          <h2 style="margin: 0; font-size: 16px; font-weight: 500;" id="gameModalTitle">Add Game</h2>
          <button onclick="closeGameModal()" style="background: none; border: none; color: white; font-size: 24px; cursor: pointer; line-height: 1;">&times;</button>
        </div>
        
        <div style="padding: 20px;">
          <input type="hidden" id="gameId">
          <input type="hidden" id="gameExternalId">
          
          <!-- Row 1: Date, Time, Status -->
          <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin-bottom: 15px;">
            <div class="form-group">
              <label>Date *</label>
              <input type="date" id="gameDate">
            </div>
            <div class="form-group">
              <label>Time</label>
              <input type="text" id="gameTime" placeholder="7:00 PM or FINAL">
            </div>
            <div class="form-group">
              <label>Status</label>
              <select id="gameStatus">
                <option value="scheduled">Scheduled</option>
                <option value="final">Final</option>
                <option value="postponed">Postponed</option>
                <option value="cancelled">Cancelled</option>
              </select>
            </div>
          </div>
          
          <!-- Row 2: Teams -->
          <div style="display: grid; grid-template-columns: 1fr 80px 1fr 80px; gap: 15px; margin-bottom: 15px;">
            <div class="form-group">
              <label>Away Team *</label>
              <input type="text" id="gameAwayTeam" placeholder="Farmington" list="teamsList">
            </div>
            <div class="form-group">
              <label>Away Score</label>
              <input type="number" id="gameAwayScore" min="0">
            </div>
            <div class="form-group">
              <label>Home Team *</label>
              <input type="text" id="gameHomeTeam" placeholder="Berlin" list="teamsList">
            </div>
            <div class="form-group">
              <label>Home Score</label>
              <input type="number" id="gameHomeScore" min="0">
            </div>
          </div>
          <datalist id="teamsList"></datalist>
          
          <!-- Row 3: Classification -->
          <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin-bottom: 15px;">
            <div class="form-group">
              <label>Level *</label>
              <select id="gameLevel" onchange="updateGameDivisionOptions()">
                <option value="NHIAA">NHIAA</option>
                <option value="College">College</option>
                <option value="Prep School">Prep School</option>
              </select>
            </div>
            <div class="form-group">
              <label>Division</label>
              <select id="gameDivision">
                <option value="">None</option>
                <option value="D-I">D-I</option>
                <option value="D-II">D-II</option>
                <option value="D-III">D-III</option>
                <option value="D-IV">D-IV</option>
              </select>
            </div>
            <div class="form-group">
              <label>Gender</label>
              <select id="gameGender">
                <option value="Boys">Boys</option>
                <option value="Girls">Girls</option>
                <option value="Men">Men</option>
                <option value="Women">Women</option>
              </select>
            </div>
          </div>
          
          <!-- Coverage Section -->
          <div style="background: #f9f9f9; border: 1px solid #eee; border-radius: 8px; padding: 15px; margin-bottom: 15px;">
            <h3 style="margin: 0 0 12px 0; font-size: 14px; color: #333;">Coverage Assignments</h3>
            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px;">
              <div class="form-group" style="min-width: 0;">
                <label>Photog 1</label>
                <input type="text" id="gamePhotog1" placeholder="Name" style="width: 100%; min-width: 0;">
              </div>
              <div class="form-group" style="min-width: 0;">
                <label>Photog 2</label>
                <input type="text" id="gamePhotog2" placeholder="Name" style="width: 100%; min-width: 0;">
              </div>
              <div class="form-group" style="min-width: 0;">
                <label>Videog</label>
                <input type="text" id="gameVideog" placeholder="Name" style="width: 100%; min-width: 0;">
              </div>
              <div class="form-group" style="min-width: 0;">
                <label>Writer</label>
                <input type="text" id="gameWriter" placeholder="Name" style="width: 100%; min-width: 0;">
              </div>
            </div>
          </div>
          
          <!-- Links Section -->
          <div style="background: #e3f2fd; border: 1px solid #bbdefb; border-radius: 8px; padding: 15px; margin-bottom: 15px;">
            <h3 style="margin: 0 0 12px 0; font-size: 14px; color: #1565c0;">Coverage Links</h3>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
              <div class="form-group">
                <label>Photos URL</label>
                <input type="url" id="gamePhotosUrl" placeholder="https://ball603.smugmug.com/...">
              </div>
              <div class="form-group">
                <label>Recap/Article URL</label>
                <input type="url" id="gameRecapUrl" placeholder="https://ball603.com/...">
              </div>
              <div class="form-group">
                <label>Highlights URL</label>
                <input type="url" id="gameHighlightsUrl" placeholder="https://youtube.com/...">
              </div>
              <div class="form-group">
                <label>Live Stream URL</label>
                <input type="url" id="gameLiveStreamUrl" placeholder="https://...">
              </div>
            </div>
          </div>
          
          <!-- Additional Info -->
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
            <div class="form-group">
              <label>Special Event</label>
              <input type="text" id="gameSpecialEvent" placeholder="Tournament name, rivalry, etc.">
            </div>
            <div class="form-group">
              <label>Location (if not home team)</label>
              <input type="text" id="gameLocation" placeholder="Venue name">
            </div>
          </div>
          
          <div class="form-group" style="margin-bottom: 15px;">
            <label>Notes</label>
            <textarea id="gameNotes" rows="2" placeholder="Internal notes..." style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; font-size: 14px; resize: vertical;"></textarea>
          </div>
          
          <div style="display: flex; justify-content: flex-end; gap: 10px; padding-top: 15px; border-top: 1px solid #eee;">
            <button onclick="closeGameModal()" style="padding: 10px 20px; background: #f5f5f5; border: 1px solid #ddd; border-radius: 5px; cursor: pointer;">Cancel</button>
            <button onclick="saveGame()" style="padding: 10px 25px; background: #1565c0; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: 500;">Save Game</button>
          </div>
        </div>
      </div>
    </div>
    
    <!-- URL Management Modal -->
    <div id="urlModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 2000; overflow-y: auto;">
      <div style="max-width: 550px; margin: 80px auto; background: #fff; border-radius: 10px; overflow: hidden; box-shadow: 0 4px 20px rgba(0,0,0,0.3);">
        <div style="background: #7b1fa2; color: white; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center;">
          <h2 style="margin: 0; font-size: 16px; font-weight: 500;"> üîó Manage Coverage URLs</h2>
          <button onclick="closeUrlModal()" style="background: none; border: none; color: white; font-size: 24px; cursor: pointer; line-height: 1;">&times;</button>
        </div>
        
        <div style="padding: 20px;">
          <input type="hidden" id="urlGameId">
          
          <!-- Game Info Header -->
          <div style="background: #f5f5f5; border-radius: 8px; padding: 12px 15px; margin-bottom: 20px;">
            <div style="font-weight: 600; font-size: 14px;" id="urlGameTitle">Loading...</div>
            <div style="font-size: 12px; color: #666; margin-top: 4px;" id="urlGameMeta"></div>
          </div>
          
          <!-- URL Fields -->
          <div style="display: flex; flex-direction: column; gap: 15px;">
            <div class="form-group">
              <label style="display: flex; align-items: center; gap: 6px;">
                <span>üì∑</span> Photos URL
              </label>
              <div style="display: flex; gap: 8px;">
                <input type="url" id="urlPhotos" placeholder="https://ball603.smugmug.com/..." style="flex: 1;">
                <button onclick="clearUrlField('urlPhotos')" style="padding: 8px 12px; background: #ffebee; color: #c62828; border: none; border-radius: 5px; cursor: pointer;" title="Clear">‚úï</button>
              </div>
            </div>
            
            <div class="form-group">
              <label style="display: flex; align-items: center; gap: 6px;">
                <span>üì∞</span> Recap/Article URL
              </label>
              <div style="display: flex; gap: 8px;">
                <input type="url" id="urlRecap" placeholder="https://ball603.com/..." style="flex: 1;">
                <button onclick="clearUrlField('urlRecap')" style="padding: 8px 12px; background: #ffebee; color: #c62828; border: none; border-radius: 5px; cursor: pointer;" title="Clear">‚úï</button>
              </div>
            </div>
            
            <div class="form-group">
              <label style="display: flex; align-items: center; gap: 6px;">
                <span>üé¨</span> Highlights URL
              </label>
              <div style="display: flex; gap: 8px;">
                <input type="url" id="urlHighlights" placeholder="https://youtube.com/..." style="flex: 1;">
                <button onclick="clearUrlField('urlHighlights')" style="padding: 8px 12px; background: #ffebee; color: #c62828; border: none; border-radius: 5px; cursor: pointer;" title="Clear">‚úï</button>
              </div>
            </div>
            
            <div class="form-group">
              <label style="display: flex; align-items: center; gap: 6px;">
                <span>üì∫</span> Live Stream URL
              </label>
              <div style="display: flex; gap: 8px;">
                <input type="url" id="urlLiveStream" placeholder="https://..." style="flex: 1;">
                <button onclick="clearUrlField('urlLiveStream')" style="padding: 8px 12px; background: #ffebee; color: #c62828; border: none; border-radius: 5px; cursor: pointer;" title="Clear">‚úï</button>
              </div>
            </div>
          </div>
          
          <!-- Actions -->
          <div style="display: flex; justify-content: space-between; gap: 10px; padding-top: 20px; margin-top: 20px; border-top: 1px solid #eee;">
            <button onclick="clearAllUrls()" style="padding: 10px 16px; background: #ffebee; color: #c62828; border: none; border-radius: 5px; cursor: pointer; font-size: 13px;">Clear All URLs</button>
            <div style="display: flex; gap: 10px;">
              <button onclick="closeUrlModal()" style="padding: 10px 20px; background: #f5f5f5; border: 1px solid #ddd; border-radius: 5px; cursor: pointer;">Cancel</button>
              <button onclick="saveUrls()" style="padding: 10px 25px; background: #7b1fa2; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: 500;">Save URLs</button>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Game Import Modal -->
    <div id="gameImportModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 2000; overflow-y: auto;">
      <div style="max-width: 700px; margin: 30px auto; background: #fff; border-radius: 10px; overflow: hidden; box-shadow: 0 4px 20px rgba(0,0,0,0.3);">
        <div style="background: #1565c0; color: white; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center;">
          <h2 style="margin: 0; font-size: 16px; font-weight: 500;">Import Games from CSV</h2>
          <button onclick="closeGameImportModal()" style="background: none; border: none; color: white; font-size: 24px; cursor: pointer; line-height: 1;">&times;</button>
        </div>
        
        <div style="padding: 20px;">
          <div id="gameImportDropZone" style="border: 2px dashed #1565c0; border-radius: 10px; padding: 40px; text-align: center; margin-bottom: 15px; cursor: pointer; transition: all 0.2s;"
               ondragover="event.preventDefault(); this.style.background='#e3f2fd';"
               ondragleave="this.style.background='transparent';"
               ondrop="event.preventDefault(); this.style.background='transparent'; handleGameCsvFile(event.dataTransfer.files[0]);"
               onclick="document.getElementById('gameFileInput').click();">
            <div style="font-size: 48px; margin-bottom: 10px;">üìÑ</div>
            <p style="margin: 0; color: #666;">Drop CSV file here or click to browse</p>
            <p style="margin: 5px 0 0 0; font-size: 12px; color: #999;">Supports Ball603 schedule export format</p>
            <input type="file" id="gameFileInput" accept=".csv" style="display: none;" onchange="handleGameCsvFile(this.files[0])">
          </div>
          
          <div id="gameImportPreview" style="display: none;">
            <div style="background: #e8f5e9; padding: 10px 15px; border-radius: 5px; margin-bottom: 15px;">
              <strong id="gameImportPreviewCount">0 games</strong> ready to import from <span id="gameImportPreviewFile"></span>
            </div>
            <div style="max-height: 300px; overflow-y: auto; border: 1px solid #ddd; border-radius: 5px;">
              <table style="width: 100%; border-collapse: collapse; font-size: 13px;">
                <thead style="background: #f5f5f5; position: sticky; top: 0;">
                  <tr>
                    <th style="padding: 8px; text-align: left; border-bottom: 1px solid #ddd;">Date</th>
                    <th style="padding: 8px; text-align: left; border-bottom: 1px solid #ddd;">Away</th>
                    <th style="padding: 8px; text-align: left; border-bottom: 1px solid #ddd;">Home</th>
                    <th style="padding: 8px; text-align: left; border-bottom: 1px solid #ddd;">Level</th>
                  </tr>
                </thead>
                <tbody id="gameImportPreviewBody"></tbody>
              </table>
            </div>
            <div style="margin-top: 15px; display: flex; justify-content: flex-end; gap: 10px;">
              <button onclick="closeGameImportModal()" style="padding: 10px 20px; background: #f5f5f5; border: 1px solid #ddd; border-radius: 5px; cursor: pointer;">Cancel</button>
              <button id="btnExecuteGameImport" onclick="executeGameImport()" style="padding: 10px 25px; background: #1565c0; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: 500;">Import Games</button>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Teams Panel -->
    <div class="panel" id="teamsPanel" style="display: none;">
      <div class="toolbar" style="flex-wrap: wrap; gap: 10px;">
        <button class="btn-new" onclick="openTeamModal()">
          <span>+</span> Add Team
        </button>
        <button class="btn-new" style="background: #e3f2fd; color: #1565c0;" onclick="openImportModal()">
          <span>üì•</span> Import CSV
        </button>
        <button class="btn-new" style="background: #fff3e0; color: #e65100;" onclick="exportTeams()">
          <span>üì§</span> Export CSV
        </button>
        <div style="display: flex; gap: 8px; align-items: center; margin-left: auto;">
          <select id="teamLevelFilter" onchange="filterTeams()" style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 5px; font-size: 13px;">
            <option value="">All Levels</option>
            <option value="High School">High School</option>
            <option value="College">College</option>
            <option value="Prep School">Prep School</option>
          </select>
          <select id="teamDivisionFilter" onchange="filterTeams()" style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 5px; font-size: 13px;">
            <option value="">All Divisions</option>
            <optgroup label="High School">
              <option value="D1">D1</option>
              <option value="D2">D2</option>
              <option value="D3">D3</option>
              <option value="D4">D4</option>
            </optgroup>
            <optgroup label="College">
              <option value="DI">DI (NCAA)</option>
              <option value="DII">DII (NCAA)</option>
              <option value="DIII">DIII (NCAA)</option>
            </optgroup>
            <optgroup label="Prep School">
              <option value="NEPSAC">NEPSAC</option>
            </optgroup>
          </select>
          <select id="teamGenderFilter" onchange="filterTeams()" style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 5px; font-size: 13px;">
            <option value="">All Genders</option>
            <option value="Boys">Boys</option>
            <option value="Girls">Girls</option>
            <option value="Men">Men</option>
            <option value="Women">Women</option>
          </select>
          <input type="text" class="search-box" id="teamSearchBox" placeholder="Search teams..." oninput="filterTeams()" style="width: 200px;">
        </div>
      </div>
      
      <div style="margin-bottom: 15px; display: flex; gap: 15px; font-size: 13px; color: #666;">
        <span id="teamCount">0 teams</span>
        <span id="teamActiveCount"></span>
      </div>
      
      <div class="article-list" id="teamList">
        <div class="article-row header" style="grid-template-columns: 50px 1fr 100px 80px 80px 100px 120px;">
          <div>Logo</div>
          <div>Team</div>
          <div>Level</div>
          <div>Division</div>
          <div>Gender</div>
          <div>Location</div>
          <div>Actions</div>
        </div>
        <div class="loading">Loading teams...</div>
      </div>
    </div>
    
    <!-- Team Edit Modal -->
    <div id="teamModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 2000; overflow-y: auto;">
      <div style="max-width: 700px; margin: 30px auto; background: #fff; border-radius: 10px; overflow: hidden; box-shadow: 0 4px 20px rgba(0,0,0,0.3);">
        <div style="background: #f57c00; color: white; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center;">
          <h2 style="margin: 0; font-size: 16px; font-weight: 500;" id="teamModalTitle">Add Team</h2>
          <button onclick="closeTeamModal()" style="background: none; border: none; color: white; font-size: 24px; cursor: pointer; line-height: 1;">&times;</button>
        </div>
        
        <div style="padding: 20px;">
          <input type="hidden" id="teamId">
          
          <!-- Row 1: Names -->
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
            <div class="form-group">
              <label>Full Name *</label>
              <input type="text" id="teamFullName" placeholder="Farmington High School">
            </div>
            <div class="form-group">
              <label>Short Name *</label>
              <input type="text" id="teamShortname" placeholder="Farmington" oninput="updateLogoPreview()">
            </div>
          </div>
          
          <!-- Row 2: Abbrev, Emoji, Mascot -->
          <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin-bottom: 15px;">
            <div class="form-group">
              <label>Abbreviation *</label>
              <input type="text" id="teamAbbrev" placeholder="FHS" maxlength="10">
            </div>
            <div class="form-group">
              <label>Emoji</label>
              <input type="text" id="teamEmoji" placeholder="" maxlength="5">
            </div>
            <div class="form-group">
              <label>Mascot</label>
              <input type="text" id="teamMascot" placeholder="Tigers">
            </div>
          </div>
          
          <!-- Row 2b: Logo Preview -->
          <div style="background: #f9f9f9; border: 1px solid #eee; border-radius: 8px; padding: 15px; margin-bottom: 15px;">
            <div style="display: flex; align-items: center; gap: 20px;">
              <div>
                <label style="font-size: 13px; font-weight: 600; color: #555; display: block; margin-bottom: 8px;">Team Logo</label>
                <div id="teamLogoPreview" style="width: 100px; height: 100px; border: 2px solid #ddd; border-radius: 8px; background: #fff; display: flex; align-items: center; justify-content: center; overflow: hidden;">
                  <span style="color: #ccc; font-size: 12px; text-align: center;">No logo<br>selected</span>
                </div>
                <input type="hidden" id="teamLogoUrl">
                <input type="hidden" id="teamLogoFilename">
              </div>
              <div style="flex: 1;">
                <label style="font-size: 13px; font-weight: 600; color: #555; display: block; margin-bottom: 8px;">Select Logo</label>
                <select id="teamLogoSelect" onchange="onLogoSelected()" style="width: 100%; padding: 8px 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
                  <option value="">-- No Logo --</option>
                </select>
                <p style="font-size: 11px; color: #999; margin: 8px 0 0 0;">
                  Logos are stored in <code style="background: #eee; padding: 2px 6px; border-radius: 3px;">/logos/100px/</code>, <code style="background: #eee; padding: 2px 6px; border-radius: 3px;">200px/</code>, <code style="background: #eee; padding: 2px 6px; border-radius: 3px;">400px/</code>
                </p>
              </div>
            </div>
          </div>
          
          <!-- Row 3: Level, Division, Gender -->
          <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin-bottom: 15px;">
            <div class="form-group">
              <label>Level *</label>
              <select id="teamLevel" onchange="updateDivisionOptions()">
                <option value="High School">High School</option>
                <option value="College">College</option>
                <option value="Prep School">Prep School</option>
              </select>
            </div>
            <div class="form-group">
              <label>Division</label>
              <select id="teamDivision">
                <option value="">None</option>
                <option value="D1">D1</option>
                <option value="D2">D2</option>
                <option value="D3">D3</option>
                <option value="D4">D4</option>
              </select>
            </div>
            <div class="form-group">
              <label>Gender</label>
              <select id="teamGender">
                <option value="">N/A (Both)</option>
                <option value="Boys">Boys</option>
                <option value="Girls">Girls</option>
                <option value="Men">Men</option>
                <option value="Women">Women</option>
              </select>
            </div>
          </div>
          
          <!-- Row 4: Location, Conference -->
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
            <div class="form-group">
              <label>Location (Town)</label>
              <input type="text" id="teamLocation" placeholder="Farmington">
            </div>
            <div class="form-group">
              <label>Conference</label>
              <input type="text" id="teamConference" placeholder="NHIAA, America East, etc.">
            </div>
          </div>
          
          <!-- Row 5: Colors (simplified - hex only) -->
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
            <div class="form-group">
              <label>Primary Color</label>
              <div style="display: flex; gap: 8px; align-items: center;">
                <input type="color" id="teamPrimaryHexPicker" style="width: 50px; height: 36px; border: 1px solid #ddd; border-radius: 4px; cursor: pointer;" onchange="document.getElementById('teamPrimaryHex').value = this.value">
                <input type="text" id="teamPrimaryHex" placeholder="#000000" style="flex: 1;" oninput="syncColorPicker('teamPrimaryHexPicker', this.value)">
              </div>
            </div>
            <div class="form-group">
              <label>Secondary Color</label>
              <div style="display: flex; gap: 8px; align-items: center;">
                <input type="color" id="teamSecondaryHexPicker" style="width: 50px; height: 36px; border: 1px solid #ddd; border-radius: 4px; cursor: pointer;" onchange="document.getElementById('teamSecondaryHex').value = this.value">
                <input type="text" id="teamSecondaryHex" placeholder="#FFFFFF" style="flex: 1;" oninput="syncColorPicker('teamSecondaryHexPicker', this.value)">
              </div>
            </div>
          </div>
          
          <!-- Row 6: Website, Livestream -->
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
            <div class="form-group">
              <label>Website URL</label>
              <input type="url" id="teamWebsite" placeholder="https://...">
            </div>
            <div class="form-group">
              <label>Livestream URL</label>
              <input type="url" id="teamLivestream" placeholder="https://...">
            </div>
          </div>
          
          <!-- Row 7: Combined Team -->
          <div style="background: #f9f9f9; border: 1px solid #eee; border-radius: 8px; padding: 15px; margin-bottom: 15px;">
            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; margin-bottom: 10px;">
              <input type="checkbox" id="teamCombined" onchange="toggleCombinedSection()">
              <span style="font-weight: 600;">This is a combined team</span>
              <span style="font-size: 12px; color: #666;">(e.g., Pittsburg-Canaan)</span>
            </label>
            <div id="combinedTeamSection" style="display: none;">
              <label style="font-size: 13px; color: #555; display: block; margin-bottom: 6px;">Select teams being combined:</label>
              <input type="text" id="combinedTeamSearch" placeholder="Search teams..." oninput="filterCombinedTeams()" style="width: 100%; padding: 8px 12px; border: 1px solid #ddd; border-radius: 4px; margin-bottom: 8px; font-size: 13px;">
              <div id="combinedTeamList" style="max-height: 150px; overflow-y: auto; border: 1px solid #ddd; border-radius: 4px; background: #fff;">
                <!-- Populated dynamically -->
              </div>
              <div id="selectedCombinedTeams" style="margin-top: 10px; display: flex; flex-wrap: wrap; gap: 6px;">
                <!-- Selected teams shown as chips -->
              </div>
            </div>
          </div>
          
          <!-- Row 8: Notes and Active -->
          <div style="display: grid; grid-template-columns: 1fr auto; gap: 15px; margin-bottom: 15px;">
            <div class="form-group">
              <label>Notes</label>
              <input type="text" id="teamNotes" placeholder="Internal notes...">
            </div>
            <div class="form-group">
              <label>&nbsp;</label>
              <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; padding: 10px 0;">
                <input type="checkbox" id="teamActive" checked>
                <span>Active</span>
              </label>
            </div>
          </div>
          
          <div style="display: flex; gap: 10px; justify-content: flex-end; padding-top: 15px; border-top: 1px solid #eee;">
            <button onclick="closeTeamModal()" style="background: #eee; border: none; padding: 12px 25px; border-radius: 5px; cursor: pointer; font-size: 14px;">Cancel</button>
            <button onclick="saveTeam()" style="background: #f57c00; color: white; border: none; padding: 12px 25px; border-radius: 5px; cursor: pointer; font-size: 14px; font-weight: 500;">Save Team</button>
          </div>
        </div>
      </div>
    </div>
    
    <!-- CSV Import Modal -->
    <div id="importModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 2000; overflow-y: auto;">
      <div style="max-width: 600px; margin: 30px auto; background: #fff; border-radius: 10px; overflow: hidden; box-shadow: 0 4px 20px rgba(0,0,0,0.3);">
        <div style="background: #1565c0; color: white; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center;">
          <h2 style="margin: 0; font-size: 16px; font-weight: 500;">Import Teams from CSV</h2>
          <button onclick="closeImportModal()" style="background: none; border: none; color: white; font-size: 24px; cursor: pointer; line-height: 1;">&times;</button>
        </div>
        
        <div style="padding: 20px;">
          <div style="background: #e3f2fd; padding: 15px; border-radius: 8px; margin-bottom: 20px; font-size: 13px;">
            <strong>Expected CSV columns:</strong><br>
            <code style="font-size: 11px; color: #1565c0;">full_name, shortname, abbrev, emoji, mascot, level, division, gender, location, conference, primary_color, primary_hex, secondary_color, secondary_hex, website, active</code>
            <br><br>
            <em>Required: full_name, shortname, abbrev, level</em>
          </div>
          
          <div style="border: 2px dashed #ddd; border-radius: 8px; padding: 40px 20px; text-align: center; margin-bottom: 20px; cursor: pointer;" id="dropZone" onclick="document.getElementById('csvFileInput').click()">
            <input type="file" id="csvFileInput" accept=".csv" style="display: none;" onchange="handleCsvFile(this.files[0])">
            <div style="font-size: 40px; margin-bottom: 10px;">üìÑ</div>
            <p style="color: #666; margin: 0;">Drop CSV file here or click to browse</p>
          </div>
          
          <div id="importPreview" style="display: none; margin-bottom: 20px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
              <strong id="importPreviewCount">0 teams ready to import</strong>
              <span style="font-size: 12px; color: #666;" id="importPreviewFile"></span>
            </div>
            <div style="max-height: 200px; overflow-y: auto; border: 1px solid #ddd; border-radius: 5px;">
              <table style="width: 100%; font-size: 12px; border-collapse: collapse;">
                <thead style="position: sticky; top: 0; background: #f5f5f5;">
                  <tr>
                    <th style="padding: 8px; text-align: left;">Short Name</th>
                    <th style="padding: 8px; text-align: left;">Full Name</th>
                    <th style="padding: 8px; text-align: left;">Level</th>
                    <th style="padding: 8px; text-align: left;">Division</th>
                  </tr>
                </thead>
                <tbody id="importPreviewBody"></tbody>
              </table>
            </div>
          </div>
          
          <div id="importResults" style="display: none; margin-bottom: 20px; padding: 15px; border-radius: 8px;"></div>
          
          <div style="display: flex; gap: 10px; justify-content: flex-end; padding-top: 15px; border-top: 1px solid #eee;">
            <button onclick="closeImportModal()" style="background: #eee; border: none; padding: 12px 25px; border-radius: 5px; cursor: pointer; font-size: 14px;">Cancel</button>
            <button onclick="executeImport()" id="btnExecuteImport" disabled style="background: #1565c0; color: white; border: none; padding: 12px 25px; border-radius: 5px; cursor: pointer; font-size: 14px; font-weight: 500;">Import Teams</button>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Game Story Modal -->
    <div id="gameStoryModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 1000; overflow-y: auto;">
      <div style="max-width: 950px; margin: 30px auto; background: #f5f5f5; border-radius: 10px; overflow: hidden; box-shadow: 0 4px 20px rgba(0,0,0,0.3);">
        
        <!-- Modal Header -->
        <div style="background: #444; color: white; padding: 12px 16px; display: flex; justify-content: space-between; align-items: center;">
          <h2 style="margin: 0; font-size: 15px; font-weight: 500;" id="gameStoryTitle">Scorebook Story</h2>
          <button onclick="closeGameStory()" style="background: none; border: none; color: #ccc; font-size: 20px; cursor: pointer; line-height: 1;">&times;</button>
        </div>
        
        <!-- Main Content: Side-by-Side Layout -->
        <div id="gsMainContent" style="display: flex; gap: 20px; padding: 16px; flex-wrap: wrap;">
          
          <!-- Left: Game Selection -->
          <div style="flex: 1; min-width: 300px; max-width: 400px;">
            <div style="background: #fff; border: 1px solid #ddd; border-radius: 8px; overflow: hidden;">
              <div style="background: #f57c00; color: white; padding: 12px 16px;">
                <h3 style="margin: 0; font-size: 14px;">Select Game</h3>
              </div>
              <div style="padding: 12px;">
                <div style="display: flex; gap: 4px; margin-bottom: 12px; align-items: center;">
                  <button onclick="gsPrevDay()" style="background: #fff; border: 1px solid #ddd; border-radius: 4px; padding: 6px 8px; cursor: pointer; font-size: 12px;">&lt;</button>
                  <input type="date" id="gsDateFilter" onchange="populateGameList()" style="flex: 1; padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px;">
                  <button onclick="gsNextDay()" style="background: #fff; border: 1px solid #ddd; border-radius: 4px; padding: 6px 8px; cursor: pointer; font-size: 12px;">&gt;</button>
                  <select id="gsGenderFilter" onchange="populateGameList()" style="padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px;">
                    <option value="Boys">Boys</option>
                    <option value="Girls">Girls</option>
                  </select>
                </div>
                <input type="text" id="gsGameSearch" placeholder="Search teams..." oninput="populateGameList()" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 5px; font-size: 12px; margin-bottom: 12px; box-sizing: border-box;">
                <div id="gsGameList" style="max-height: 400px; overflow-y: auto; border: 1px solid #eee; border-radius: 5px;">
                  <div style="padding: 20px; text-align: center; color: #888;">Loading games...</div>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Right: Box Score Entry -->
          <div style="flex: 2; min-width: 400px;">
            
            <!-- Entry Panel (shown when game selected) -->
            <div id="gsEntryPanel" style="display: none; background: #fff; border: 1px solid #ddd; border-radius: 8px; overflow: hidden;">
              <div style="background: #333; color: white; padding: 12px 16px; display: flex; justify-content: space-between; align-items: center;">
                <h3 style="margin: 0; font-size: 14px;" id="gsMatchupTitle">Game</h3>
                <button onclick="clearGameSelection()" style="background: none; border: none; color: #ccc; font-size: 18px; cursor: pointer;">&times;</button>
              </div>
              <div style="padding: 16px;">
                
                <!-- Quarter Scores -->
                <div style="margin-bottom: 16px;">
                  <label style="font-size: 12px; font-weight: 600; display: block; margin-bottom: 8px;">Quarter Scores</label>
                  <table style="width: 100%; font-size: 12px; border-collapse: collapse; background: #f9f9f9; border-radius: 5px;">
                    <thead>
                      <tr style="background: #eee;">
                        <th style="padding: 8px; text-align: left; width: 100px;">Team</th>
                        <th style="padding: 8px; width: 45px;">Q1</th>
                        <th style="padding: 8px; width: 45px;">Q2</th>
                        <th style="padding: 8px; width: 45px;">Q3</th>
                        <th style="padding: 8px; width: 45px;">Q4</th>
                        <th style="padding: 8px; width: 45px;" id="otHeaders"></th>
                        <th style="padding: 8px; width: 50px;">Final</th>
                      </tr>
                    </thead>
                    <tbody>
                      <tr>
                        <td id="gsAwayName" style="padding: 8px; font-weight: 500;">Away</td>
                        <td><input type="number" id="gsAwayQ1" class="quarter-input" onchange="calcGameFinal('away')"></td>
                        <td><input type="number" id="gsAwayQ2" class="quarter-input" onchange="calcGameFinal('away')"></td>
                        <td><input type="number" id="gsAwayQ3" class="quarter-input" onchange="calcGameFinal('away')"></td>
                        <td><input type="number" id="gsAwayQ4" class="quarter-input" onchange="calcGameFinal('away')"></td>
                        <td id="gsAwayOT"></td>
                        <td><input type="number" id="gsAwayFinal" class="quarter-input" style="background: #e8f5e9; font-weight: bold;" readonly></td>
                      </tr>
                      <tr>
                        <td id="gsHomeName" style="padding: 8px; font-weight: 500;">Home</td>
                        <td><input type="number" id="gsHomeQ1" class="quarter-input" onchange="calcGameFinal('home')"></td>
                        <td><input type="number" id="gsHomeQ2" class="quarter-input" onchange="calcGameFinal('home')"></td>
                        <td><input type="number" id="gsHomeQ3" class="quarter-input" onchange="calcGameFinal('home')"></td>
                        <td><input type="number" id="gsHomeQ4" class="quarter-input" onchange="calcGameFinal('home')"></td>
                        <td id="gsHomeOT"></td>
                        <td><input type="number" id="gsHomeFinal" class="quarter-input" style="background: #e8f5e9; font-weight: bold;" readonly></td>
                      </tr>
                    </tbody>
                  </table>
                  <button onclick="addOT()" style="margin-top: 8px; background: #eee; border: 1px solid #ccc; padding: 4px 10px; border-radius: 4px; font-size: 11px; cursor: pointer;">+ Add OT</button>
                </div>
                
                <!-- Rosters Side-by-Side -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 16px;">
                  <!-- Away Team -->
                  <div>
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px;">
                      <label style="font-size: 12px; font-weight: 600;" id="gsAwayLabel">Away Scorers</label>
                      <span style="font-size: 11px; color: #888;">Total: <strong id="gsAwayPtsTotal">0</strong> <span id="gsAwayMatch"></span></span>
                    </div>
                    <div id="gsAwayRoster" class="bash-roster-container">
                      <!-- Populated by JS -->
                    </div>
                    <button onclick="addBlankPlayer('away')" style="margin-top: 6px; background: #f5f5f5; border: 1px solid #ddd; padding: 4px 10px; border-radius: 4px; font-size: 11px; cursor: pointer; width: 100%;">+ Add Player</button>
                  </div>
                  <!-- Home Team -->
                  <div>
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px;">
                      <label style="font-size: 12px; font-weight: 600;" id="gsHomeLabel">Home Scorers</label>
                      <span style="font-size: 11px; color: #888;">Total: <strong id="gsHomePtsTotal">0</strong> <span id="gsHomeMatch"></span></span>
                    </div>
                    <div id="gsHomeRoster" class="bash-roster-container">
                      <!-- Populated by JS -->
                    </div>
                    <button onclick="addBlankPlayer('home')" style="margin-top: 6px; background: #f5f5f5; border: 1px solid #ddd; padding: 4px 10px; border-radius: 4px; font-size: 11px; cursor: pointer; width: 100%;">+ Add Player</button>
                  </div>
                </div>
                
                <!-- Game Notes -->
                <div style="margin-bottom: 16px;">
                  <label style="font-size: 12px; font-weight: 600; display: block; margin-bottom: 6px;">Game Notes (optional)</label>
                  <textarea id="gsNotes" style="width: 100%; min-height: 60px; padding: 8px; border: 1px solid #ddd; border-radius: 5px; font-size: 12px; box-sizing: border-box;" placeholder="Key plays, storylines, milestones..."></textarea>
                </div>
                
                <!-- Photographers -->
                <div id="gsPhotographers" style="margin-bottom: 16px; padding: 10px 12px; background: #f9f9f9; border: 1px solid #ddd; border-radius: 6px; font-size: 12px; display: none;">
                  <span style="color: #666; font-weight: 500;">üì∑ Photo Credit:</span>
                  <div id="gsPhotogCheckboxes" style="margin-top: 8px;"></div>
                  <div style="margin-top: 10px; padding-top: 10px; border-top: 1px dashed #ddd;">
                    <label style="font-size: 11px; color: #888; display: block; margin-bottom: 4px;">Guest Photographer:</label>
                    <input type="text" id="gsGuestPhotographer" placeholder="Enter guest photographer name..." style="width: 100%; padding: 6px 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px; box-sizing: border-box;">
                  </div>
                </div>
                
                <!-- Generate Buttons -->
                <div style="display: flex; gap: 8px;">
                  <button onclick="generateGameStory()" id="gsGenerateBtn" style="flex: 1; background: #f57c00; color: white; border: none; padding: 12px; border-radius: 5px; font-size: 14px; font-weight: 600; cursor: pointer;">
                    ‚ú® Generate Story
                  </button>
                  <button onclick="writeYourOwn()" id="gsWriteOwnBtn" style="flex: 1; background: #1a73e8; color: white; border: none; padding: 12px; border-radius: 5px; font-size: 14px; font-weight: 600; cursor: pointer;">
                    ‚úçÔ∏è Write Your Own
                  </button>
                </div>
              </div>
            </div>
            
            <!-- Empty State -->
            <div id="gsEmptyState" style="background: #f9f9f9; border: 2px dashed #ddd; border-radius: 8px; padding: 60px 20px; text-align: center;">
              <div style="font-size: 48px; margin-bottom: 10px; color: #ccc;">‚úèÔ∏è</div>
              <h3 style="margin: 0 0 8px; color: #666;">Select a Game</h3>
              <p style="margin: 0; color: #888; font-size: 13px;">Choose a game from the list to create a scorebook story</p>
            </div>
          </div>
        </div>
        
        <!-- Step 3: Preview & Edit Article -->
        <!-- Step 3: Preview & Edit Article -->
        <div id="gsStep3" style="display: none; padding: 16px;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
            <button onclick="backToBoxScore()" style="background: #f5f5f5; border: none; padding: 8px 15px; border-radius: 6px; cursor: pointer;">‚Üê¬ê Back</button>
            <h3 style="margin: 0; font-size: 16px; color: #333;">Review & Edit Story</h3>
            <div style="width: 80px;"></div>
          </div>
          
          <!-- Quarter Scores Display Box -->
          <div id="gsQuarterScoresBox" style="background: #fff; border: 1px solid #ddd; border-radius: 8px; padding: 15px; margin-bottom: 15px;">
            <table style="width: 100%; border-collapse: collapse; font-size: 13px; text-align: center;">
              <thead>
                <tr style="border-bottom: 2px solid #ddd;">
                  <th style="text-align: left; padding: 8px 10px; font-weight: 600;">Team</th>
                  <th style="padding: 8px 6px; font-weight: 500; color: #666;">Q1</th>
                  <th style="padding: 8px 6px; font-weight: 500; color: #666;">Q2</th>
                  <th style="padding: 8px 6px; font-weight: 500; color: #666;">Q3</th>
                  <th style="padding: 8px 6px; font-weight: 500; color: #666;">Q4</th>
                  <th id="gsPreviewOTHeaders"></th>
                  <th style="padding: 8px 10px; font-weight: 600;">Final</th>
                </tr>
              </thead>
              <tbody>
                <tr id="gsPreviewAwayRow">
                  <td id="gsPreviewAwayName" style="text-align: left; padding: 10px; font-weight: 600;"></td>
                  <td id="gsPreviewAwayQ1" style="padding: 10px;"></td>
                  <td id="gsPreviewAwayQ2" style="padding: 10px;"></td>
                  <td id="gsPreviewAwayQ3" style="padding: 10px;"></td>
                  <td id="gsPreviewAwayQ4" style="padding: 10px;"></td>
                  <td id="gsPreviewAwayOT"></td>
                  <td id="gsPreviewAwayFinal" style="padding: 10px; font-weight: 700; font-size: 15px;"></td>
                </tr>
                <tr id="gsPreviewHomeRow" style="border-top: 1px solid #eee;">
                  <td id="gsPreviewHomeName" style="text-align: left; padding: 10px; font-weight: 600;"></td>
                  <td id="gsPreviewHomeQ1" style="padding: 10px;"></td>
                  <td id="gsPreviewHomeQ2" style="padding: 10px;"></td>
                  <td id="gsPreviewHomeQ3" style="padding: 10px;"></td>
                  <td id="gsPreviewHomeQ4" style="padding: 10px;"></td>
                  <td id="gsPreviewHomeOT"></td>
                  <td id="gsPreviewHomeFinal" style="padding: 10px; font-weight: 700; font-size: 15px;"></td>
                </tr>
              </tbody>
            </table>
          </div>
          
          <!-- Headline -->
          <div style="margin-bottom: 12px;">
            <label style="font-size: 12px; font-weight: 600; color: #333; display: block; margin-bottom: 5px;">Headline</label>
            <input type="text" id="gsPreviewHeadline" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; font-weight: 600;">
          </div>
          
          <!-- Article Body - WYSIWYG style preview -->
          <div style="margin-bottom: 12px;">
            <label style="font-size: 12px; font-weight: 600; color: #333; display: block; margin-bottom: 5px;">Article</label>
            <div id="gsPreviewArticleDisplay" style="background: #fff; border: 1px solid #ddd; border-radius: 6px; padding: 15px; font-size: 14px; line-height: 1.8; font-family: Georgia, serif; min-height: 200px; max-height: 350px; overflow-y: auto;"></div>
            <textarea id="gsPreviewArticle" style="display: none;"></textarea>
            <div style="margin-top: 8px; display: flex; gap: 8px;">
              <button onclick="toggleArticleEdit()" id="gsEditToggleBtn" style="background: #f0f0f0; border: 1px solid #ccc; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 12px;">‚úçÔ∏è¬è¬è Edit Text</button>
              <small style="color: #888; font-size: 11px; line-height: 28px;">Click to edit. Social media posts will be generated from this text.</small>
            </div>
          </div>
          
          <!-- Save & Generate Social Button -->
          <button onclick="saveAndGenerateSocial()" id="gsSaveBtn" style="width: 100%; background: #2e7d32; color: white; border: none; padding: 15px; border-radius: 6px; font-size: 14px; font-weight: 600; cursor: pointer;">
            ‚úî Save & Generate Social Media Posts
          </button>
        </div>
        
      </div>
    </div>
    
    <!-- Boxscore Story Modal (for collegiate games with full stats) -->
    <div id="boxscoreStoryModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 1000; overflow-y: auto;">
      <div style="max-width: 600px; margin: 30px auto; background: #f5f5f5; border-radius: 10px; overflow: hidden; box-shadow: 0 4px 20px rgba(0,0,0,0.3);">
        
        <!-- Modal Header -->
        <div style="background: #1565c0; color: white; padding: 12px 16px; display: flex; justify-content: space-between; align-items: center;">
          <h2 style="margin: 0; font-size: 15px; font-weight: 500;" id="boxscoreStoryTitle">New Boxscore Story</h2>
          <button onclick="closeBoxscoreStory()" style="background: none; border: none; color: #ccc; font-size: 20px; cursor: pointer; line-height: 1;">&times;</button>
        </div>
        
        <!-- Step 1: Select Game -->
        <div id="bsStep1" style="padding: 16px;">
          <!-- Date Nav + Search + Gender -->
          <div style="display: flex; align-items: center; gap: 6px; margin-bottom: 12px;">
            <button onclick="bsPrevDay()" style="background: #fff; border: 1px solid #ccc; border-radius: 4px; padding: 6px 10px; cursor: pointer; font-size: 14px;">&lt;</button>
            <div id="bsCurrentDate" style="font-size: 12px; font-weight: 600; min-width: 90px; text-align: center;"></div>
            <button onclick="bsNextDay()" style="background: #fff; border: 1px solid #ccc; border-radius: 4px; padding: 6px 10px; cursor: pointer; font-size: 14px;">&gt;</button>
            <input type="text" id="bsGameSearch" placeholder="Search..." oninput="filterBsGameList()" style="width: 70px; padding: 5px 6px; border: 1px solid #ccc; border-radius: 4px; font-size: 11px;">
            <div style="display: flex; gap: 6px; font-size: 11px; white-space: nowrap;">
              <label style="display: flex; align-items: center; gap: 2px; cursor: pointer;">
                <input type="radio" name="bsGender" value="Boys" onchange="filterBsGameList()"> Boys
              </label>
              <label style="display: flex; align-items: center; gap: 2px; cursor: pointer;">
                <input type="radio" name="bsGender" value="Girls" onchange="filterBsGameList()"> Girls
              </label>
              <label style="display: flex; align-items: center; gap: 2px; cursor: pointer;">
                <input type="radio" name="bsGender" value="Men" checked onchange="filterBsGameList()"> Men
              </label>
              <label style="display: flex; align-items: center; gap: 2px; cursor: pointer;">
                <input type="radio" name="bsGender" value="Women" onchange="filterBsGameList()"> Women
              </label>
            </div>
          </div>
          <div id="bsGameList" class="gs-game-list">
            <!-- Games populated here -->
          </div>
        </div>
        
        <!-- Step 2: Paste Boxscore -->
        <div id="bsStep2" style="display: none; padding: 16px;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
            <button onclick="backToBsGameSelect()" style="background: #f5f5f5; border: none; padding: 8px 15px; border-radius: 6px; cursor: pointer;">‚Üê¬ê Back</button>
            <h3 style="margin: 0; font-size: 16px; color: #333;" id="bsMatchupTitle">Game</h3>
            <div style="width: 80px;"></div>
          </div>
          
          <!-- Boxscore Paste Area -->
          <div style="margin-bottom: 15px;">
            <label style="font-size: 12px; font-weight: 600; color: #333; display: block; margin-bottom: 5px;">Paste Full Boxscore</label>
            <textarea id="bsBoxscoreText" style="width: 100%; min-height: 200px; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 12px; font-family: monospace; resize: vertical;" placeholder="Paste the complete boxscore here including:
- Team names and final score
- Quarter/half scores
- Individual player stats (MIN, FG, 3PT, FT, REB, AST, STL, BLK, TO, PTS)
- Team totals

Example:
TEAM A 75, Team B 68

Player        MIN  FG    3PT   FT    REB  AST  STL  BLK  TO  PTS
J. Smith      32   8-14  2-5   4-4   7    3    2    0    2   22
..."></textarea>
            <small style="color: #888; font-size: 11px;">Copy/paste from official box score. Include all available stats.</small>
          </div>
          
          <!-- Game Notes -->
          <div style="margin-bottom: 15px;">
            <label style="font-size: 12px; font-weight: 600; color: #333; display: block; margin-bottom: 5px;">Game Notes (optional)</label>
            <textarea id="bsNotes" style="width: 100%; min-height: 60px; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 13px;" placeholder="Any storylines, key plays, milestones, context..."></textarea>
          </div>
          
          <!-- Photographers -->
          <div id="bsPhotographers" style="margin-bottom: 15px; padding: 10px 12px; background: #fff; border: 1px solid #ddd; border-radius: 6px; font-size: 12px; display: none;">
            <span style="color: #666; font-weight: 500;">üì∑ Photo Credit:</span>
            <div id="bsPhotogCheckboxes" style="margin-top: 8px;"></div>
            <div style="margin-top: 10px; padding-top: 10px; border-top: 1px dashed #ddd;">
              <label style="font-size: 11px; color: #888; display: block; margin-bottom: 4px;">Guest Photographer:</label>
              <input type="text" id="bsGuestPhotographer" placeholder="Enter guest photographer name..." style="width: 100%; padding: 6px 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px; box-sizing: border-box;">
            </div>
          </div>
          
          <!-- Generate Button -->
          <button onclick="generateBoxscoreStory()" id="bsGenerateBtn" style="width: 100%; background: #1565c0; color: white; border: none; padding: 15px; border-radius: 6px; font-size: 14px; font-weight: 600; cursor: pointer;">‚ú® Generate Story
          </button>
        </div>
        
      </div>
    </div>
    
    <style>
      .quarter-input {
        width: 45px;
        padding: 6px;
        text-align: center;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 13px;
        -moz-appearance: textfield;
      }
      .quarter-input::-webkit-outer-spin-button,
      .quarter-input::-webkit-inner-spin-button {
        -webkit-appearance: none;
        margin: 0;
      }
      .roster-row {
        display: grid;
        grid-template-columns: 1fr 50px 50px;
        gap: 5px;
        margin-bottom: 4px;
        align-items: center;
      }
      .roster-row input {
        padding: 6px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 12px;
        -moz-appearance: textfield;
      }
      .roster-row input::-webkit-outer-spin-button,
      .roster-row input::-webkit-inner-spin-button {
        -webkit-appearance: none;
        margin: 0;
      }
      .roster-row .player-name {
        font-size: 12px;
        color: #333;
        padding: 6px;
        background: #fff;
        border-radius: 4px;
      }
      .roster-row input[type="text"] {
        text-align: center;
      }
      .game-row {
        padding: 12px 15px;
        border-bottom: 1px solid #eee;
        cursor: pointer;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      .game-row:hover {
        background: #f5f5f5;
      }
      .game-row-hover:hover {
        background: #e0e0e0;
      }
      .game-row .teams {
        font-size: 14px;
        font-weight: 500;
      }
      .game-row .meta {
        font-size: 12px;
        color: #888;
      }
      .gs-game-list {
        max-height: 350px;
        overflow-y: auto;
        background: #fff;
        border: 1px solid #ddd;
        border-radius: 6px;
        -ms-overflow-style: none;
        scrollbar-width: none;
      }
      .gs-game-list::-webkit-scrollbar {
        display: none;
      }
      .gs-roster-list {
        max-height: 250px;
        overflow-y: auto;
        -ms-overflow-style: none;
        scrollbar-width: none;
      }
      .gs-roster-list::-webkit-scrollbar {
        display: none;
      }
    </style>
    <!-- Article Editor Panel -->
    <div class="panel editor-panel" id="editorPanel">
      <div class="editor-header">
        <h2 id="editorTitle">New Article</h2>
        <div style="display: flex; flex-direction: column; align-items: flex-end; gap: 6px;">
          <div class="editor-actions">
            <button class="btn-back" onclick="closeEditor()">‚Üê¬ê Back</button>
            <button class="btn-preview" onclick="openPreview()">üëç¬Å Preview</button>
            <button class="btn-preview" onclick="saveAndPreviewSocial()" title="Save as draft and preview social posts">üì± Social</button>
            <button class="btn-preview" onclick="saveArticle()">Save Draft</button>
            <button class="btn-publish" onclick="publishArticle()">Publish</button>
          </div>
          <button onclick="openScheduleModal()" style="background: none; border: none; color: #666; font-size: 12px; cursor: pointer; padding: 2px 0;" id="scheduleBtn">
             üîç‚Ä¶ <span id="scheduleBtnText">Schedule for later</span>
          </button>
        </div>
      </div>
      
      <div class="form-grid">
        <div class="form-main">
          <div class="form-group">
            <label>Headline</label>
            <input type="text" id="articleTitle" placeholder="Enter headline...">
          </div>
          
          <!-- Featured Image -->
          <div class="form-group">
            <label>Featured Image</label>
            <div class="featured-image-container" id="featuredImageContainer" 
                 onclick="document.getElementById('featuredImageFileInput').click()"
                 ondragover="handleDragOver(event)" 
                 ondragleave="handleDragLeave(event)" 
                 ondrop="handleFeaturedImageDrop(event)">
              <div class="placeholder" id="featuredImagePlaceholder">
                <span></span>
                <div>Click or drag image here</div>
                <small style="color: #aaa;">16:9 crop will be applied</small>
              </div>
              <div class="featured-image-preview" id="featuredImagePreview" style="display: none;">
                <img id="featuredImageImg" src="" alt="Featured">
                <button class="remove-btn" onclick="event.stopPropagation(); removeFeaturedImage()"></button>
              </div>
            </div>
            <input type="file" id="featuredImageFileInput" accept="image/*" onchange="handleFeaturedImageSelect(this)" style="display: none;">
            <input type="text" id="featuredImageCaptionField" placeholder="Photo caption (optional)..." style="margin-top: 10px;">
            <input type="hidden" id="featuredImageUrl">
          </div>
          
          <!-- Story Editor (Quill) -->
          <div class="form-group">
            <label>Story</label>
            <div id="quillToolbar">
              <span class="ql-formats">
                <select class="ql-header">
                  <option value="">Normal</option>
                  <option value="2">Heading</option>
                  <option value="3">Subheading</option>
                </select>
              </span>
              <span class="ql-formats">
                <button class="ql-bold"></button>
                <button class="ql-italic"></button>
                <button class="ql-underline"></button>
              </span>
              <span class="ql-formats">
                <button class="ql-list" value="ordered"></button>
                <button class="ql-list" value="bullet"></button>
              </span>
              <span class="ql-formats">
                <button class="ql-link"></button>
                <button class="ql-blockquote"></button>
              </span>
              <span class="ql-formats">
                <button class="ql-insertImage" title="Insert Image">üñºÔ∏è¬è</button>
              </span>
              <span class="ql-formats">
                <button class="ql-clean"></button>
              </span>
            </div>
            <div id="articleContent"></div>
          </div>
          
          <div class="form-group">
            <label>Excerpt</label>
            <textarea id="articleExcerpt" placeholder="Brief summary for previews..." style="min-height: 80px;"></textarea>
            <small>Used for social media and article previews</small>
          </div>
        </div>
        
        <div class="form-sidebar">
          <div class="sidebar-card">
            <h4>üì∏ Photo Gallery</h4>
            <div class="form-group">
              <label>SmugMug Gallery</label>
              <div style="display: flex; gap: 8px;">
                <input type="text" id="smugmugUrl" placeholder="https://ball603.smugmug.com/..." style="flex: 1;">
                <input type="hidden" id="smugmugThumbUrl">
                <button type="button" class="btn-browse" onclick="openSmugMugBrowser()">Browse</button>
              </div>
              <div id="selectedAlbumPreview" style="margin-top: 8px; display: none;">
                <img id="albumThumbnail" style="width: 100%; border-radius: 4px; margin-bottom: 5px;">
                <small id="albumInfo" style="color: #666;"></small>
              </div>
            </div>
          </div>
          
          <div class="sidebar-card">
            <h4>&#127909; Video</h4>
            <div class="form-group">
              <label>YouTube URL</label>
              <input type="text" id="youtubeUrl" placeholder="https://youtube.com/watch?v=...">
            </div>
            <div class="form-group" style="margin-top: 12px;">
              <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                <input type="checkbox" id="videoAutoplay" style="width: 16px; height: 16px;">
                Autoplay (muted)
              </label>
            </div>
            <div class="form-group" style="margin-top: 8px;">
              <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                <input type="checkbox" id="videoStandalone" style="width: 16px; height: 16px;">
                Standalone video (no article link)
              </label>
            </div>
          </div>
          
          <input type="hidden" id="selectedGameId">
          
          <div class="sidebar-card">
            <h4>‚úçÔ∏è¬è¬è Author</h4>
            <div class="form-group">
              <select id="articleAuthor" onchange="toggleOtherAuthor()">
                <option value="Ball603 Staff">Ball603 Staff</option>
                <option value="KJ Cardinal">KJ Cardinal</option>
                <option value="Guest Contributor">Guest Contributor</option>
                <option value="other">Other...</option>
              </select>
              <input type="text" id="articleAuthorOther" placeholder="Enter author name..." style="display: none; margin-top: 8px;">
            </div>
          </div>
          
          <div class="sidebar-card">
            <h4>üì∑ Photographer</h4>
            <div class="form-group">
              <select id="articlePhotographer" onchange="toggleOtherPhotographer()">
                <option value="">None</option>
                <!-- Photographers populated dynamically -->
              </select>
              <input type="text" id="articlePhotographerOther" placeholder="Enter photographer name..." style="display: none; margin-top: 8px;">
            </div>
          </div>
          
          <div class="sidebar-card">
            <h4>üì∏ Bonus Galleries</h4>
            <div style="display: flex; gap: 8px; margin-bottom: 10px;">
              <button type="button" onclick="openBonusGalleryModal(1)" style="flex: 1; padding: 8px 12px; background: #e3f2fd; color: #1565c0; border: 1px solid #bbdefb; border-radius: 20px; cursor: pointer; font-size: 12px; font-weight: 500;">üì∑ Bonus 1</button>
              <button type="button" onclick="openBonusGalleryModal(2)" style="flex: 1; padding: 8px 12px; background: #e3f2fd; color: #1565c0; border: 1px solid #bbdefb; border-radius: 20px; cursor: pointer; font-size: 12px; font-weight: 500;">üì∑ Bonus 2</button>
            </div>
            <div id="bonusGalleryPreviews">
              <div id="bonusGallery1Preview" style="display: none; margin-bottom: 8px; padding: 8px; background: #f5f5f5; border-radius: 6px;">
                <div style="display: flex; align-items: center; gap: 8px;">
                  <img id="bonusGallery1Thumb" style="width: 50px; height: 50px; object-fit: cover; border-radius: 4px;">
                  <div style="flex: 1; min-width: 0;">
                    <div style="font-size: 11px; font-weight: 600; color: #333;">Bonus 1</div>
                    <div id="bonusGallery1Photog" style="font-size: 10px; color: #666; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;"></div>
                  </div>
                  <button type="button" onclick="clearBonusGallery(1)" style="background: none; border: none; color: #c62828; cursor: pointer; font-size: 14px;" title="Remove">&times;</button>
                </div>
              </div>
              <div id="bonusGallery2Preview" style="display: none; margin-bottom: 8px; padding: 8px; background: #f5f5f5; border-radius: 6px;">
                <div style="display: flex; align-items: center; gap: 8px;">
                  <img id="bonusGallery2Thumb" style="width: 50px; height: 50px; object-fit: cover; border-radius: 4px;">
                  <div style="flex: 1; min-width: 0;">
                    <div style="font-size: 11px; font-weight: 600; color: #333;">Bonus 2</div>
                    <div id="bonusGallery2Photog" style="font-size: 10px; color: #666; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;"></div>
                  </div>
                  <button type="button" onclick="clearBonusGallery(2)" style="background: none; border: none; color: #c62828; cursor: pointer; font-size: 14px;" title="Remove">&times;</button>
                </div>
              </div>
            </div>
            <input type="hidden" id="bonusGallery1Url">
            <input type="hidden" id="bonusGallery1ThumbUrl">
            <input type="hidden" id="bonusGallery1Photographer">
            <input type="hidden" id="bonusGallery2Url">
            <input type="hidden" id="bonusGallery2ThumbUrl">
            <input type="hidden" id="bonusGallery2Photographer">
          </div>
          
          <div class="sidebar-card">
            <h4> Article Date</h4>
            <div class="form-group">
              <label>Publication Date</label>
              <input type="date" id="articleDate" style="width: 100%;">
              <small>Date shown on the article (defaults to today)</small>
            </div>
          </div>
          
          <div class="sidebar-card">
            <h4>&#128188; Sponsors</h4>
            <div class="form-group" style="margin-bottom: 12px;">
              <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                <input type="checkbox" id="showSponsors" checked style="width: 16px; height: 16px;">
                Show sponsors on this article
              </label>
            </div>
            <div class="form-group">
              <label>Manual Sponsor Override</label>
              <select id="manualSponsorId" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 5px;">
                <option value="">Auto-detect from teams</option>
              </select>
              <small>Leave as auto to show sponsors for teams in this story</small>
            </div>
          </div>
          
          <div class="sidebar-card" id="socialPostsCard" style="display: none;">
            <h4> Social Posts</h4>
            <button onclick="viewSocialPosts()" style="width: 100%; padding: 10px; background: #9c27b0; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 13px;">
               View Social Posts
            </button>
            <small style="display: block; margin-top: 8px; color: #888;">Edit and copy social media posts</small>
          </div>
        </div>
      </div>
      
      <!-- Tags Section -->
      <div style="margin-top: 20px; padding: 15px; background: #f9f9f9; border-radius: 8px;">
        <h4 style="margin: 0 0 12px 0; font-size: 13px; font-weight: 600; color: #555;">üè∑Ô∏è Tags</h4>
        <div id="tagsContainer" style="display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 10px;">
          <!-- Tags will be rendered here -->
        </div>
        <div style="display: flex; gap: 8px; margin-bottom: 10px;">
          <input type="text" id="newTagInput" placeholder="Add custom tag..." style="flex: 1; padding: 8px 12px; border: 1px solid #ddd; border-radius: 5px; font-size: 13px;" onkeypress="if(event.key==='Enter'){event.preventDefault();addCustomTag();}">
          <button onclick="addCustomTag()" style="padding: 8px 15px; background: #f57c00; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 13px;">Add</button>
        </div>
        <div style="display: flex; flex-wrap: wrap; gap: 6px; margin-bottom: 10px;">
          <span style="font-size: 11px; color: #666; margin-right: 4px; line-height: 28px;">Quick add:</span>
          <button onclick="addQuickTag('nhiaa')" style="padding: 5px 10px; background: #fff3e0; color: #e65100; border: 1px solid #ffcc80; border-radius: 15px; cursor: pointer; font-size: 11px; font-weight: 500;">All NHIAA</button>
          <button onclick="addQuickTag('d-i')" style="padding: 5px 10px; background: #e3f2fd; color: #1565c0; border: 1px solid #90caf9; border-radius: 15px; cursor: pointer; font-size: 11px; font-weight: 500;">All D-I</button>
          <button onclick="addQuickTag('d-ii')" style="padding: 5px 10px; background: #e8f5e9; color: #2e7d32; border: 1px solid #a5d6a7; border-radius: 15px; cursor: pointer; font-size: 11px; font-weight: 500;">All D-II</button>
          <button onclick="addQuickTag('d-iii')" style="padding: 5px 10px; background: #fce4ec; color: #c2185b; border: 1px solid #f48fb1; border-radius: 15px; cursor: pointer; font-size: 11px; font-weight: 500;">All D-III</button>
          <button onclick="addQuickTag('d-iv')" style="padding: 5px 10px; background: #f3e5f5; color: #7b1fa2; border: 1px solid #ce93d8; border-radius: 15px; cursor: pointer; font-size: 11px; font-weight: 500;">All D-IV</button>
        </div>
        <small style="color: #999; font-size: 11px; display: block;">Tags are auto-generated based on linked game. Click √ó to remove.</small>
      </div>
    </div>
    
    <!-- Sponsors Panel -->
    <div class="panel" id="sponsorsPanel" style="display: none;">
      <div class="toolbar" style="flex-wrap: wrap; gap: 10px;">
        <button class="btn-new" onclick="openSponsorModal()">
          <span>+</span> Add Sponsor
        </button>
        <div style="margin-left: auto; display: flex; gap: 10px; align-items: center;">
          <select id="sponsorTeamFilter" onchange="filterSponsors()" style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 5px; font-size: 13px;">
            <option value="">All Teams</option>
          </select>
          <select id="sponsorStatusFilter" onchange="filterSponsors()" style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 5px; font-size: 13px;">
            <option value="active">Active</option>
            <option value="inactive">Inactive</option>
            <option value="all">All</option>
          </select>
          <input type="text" id="sponsorSearchBox" placeholder="Search sponsors..." oninput="filterSponsors()" style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 5px; font-size: 13px; width: 150px;">
        </div>
      </div>
      
      <div class="article-list" id="sponsorList" style="margin-top: 15px;">
        <div class="article-row header" style="grid-template-columns: 80px 1fr 150px 100px 100px 120px;">
          <div>Logo</div>
          <div>Sponsor</div>
          <div>Team</div>
          <div>Tier</div>
          <div>Status</div>
          <div>Actions</div>
        </div>
        <div class="loading">Loading sponsors...</div>
      </div>
    </div>
    
    <!-- Sponsor Modal -->
    <div id="sponsorModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center;">
      <div style="background: white; padding: 30px; border-radius: 12px; max-width: 600px; width: 90%; max-height: 90vh; overflow-y: auto;">
        <h2 style="margin-top: 0; margin-bottom: 20px;" id="sponsorModalTitle">Add Sponsor</h2>
        <input type="hidden" id="sponsorId">
        
        <div class="form-group" style="margin-bottom: 15px;">
          <label>Sponsor Name *</label>
          <input type="text" id="sponsorName" placeholder="Company name..." style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
        </div>
        
        <div class="form-group" style="margin-bottom: 15px;">
          <label>Logo *</label>
          <div style="display: flex; gap: 10px; margin-bottom: 10px;">
            <input type="file" id="sponsorLogoFile" accept="image/*" onchange="handleSponsorLogoUpload(this)" style="flex: 1;">
            <span style="color: #888; font-size: 12px; align-self: center;">or</span>
            <input type="text" id="sponsorLogoUrl" placeholder="Paste URL..." style="flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 5px;" onchange="previewSponsorLogo()">
          </div>
          <div id="sponsorLogoPreview" style="display: none; padding: 10px; background: #f5f5f5; border-radius: 6px; text-align: center;">
            <img id="sponsorLogoImg" src="" alt="Preview" style="max-width: 200px; max-height: 80px; border-radius: 4px;">
            <div id="sponsorUploadStatus" style="font-size: 11px; color: #666; margin-top: 5px;"></div>
          </div>
        </div>
        
        <div class="form-group" style="margin-bottom: 15px;">
          <label>Website URL</label>
          <input type="text" id="sponsorWebsite" placeholder="https://..." style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
        </div>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
          <div class="form-group">
            <label>Team *</label>
            <select id="sponsorTeam" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
              <option value="">Select team...</option>
            </select>
          </div>
          <div class="form-group">
            <label>Tier</label>
            <select id="sponsorTier" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
              <option value="standard">Standard</option>
              <option value="premium">Premium</option>
              <option value="presenting">Presenting</option>
            </select>
          </div>
        </div>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
          <div class="form-group">
            <label>Start Date</label>
            <input type="date" id="sponsorStartDate" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
          </div>
          <div class="form-group">
            <label>End Date</label>
            <input type="date" id="sponsorEndDate" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
          </div>
        </div>
        
        <div class="form-group" style="margin-bottom: 15px;">
          <label>Notes</label>
          <textarea id="sponsorNotes" rows="2" placeholder="Internal notes..." style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; font-family: inherit;"></textarea>
        </div>
        
        <div style="margin-bottom: 20px;">
          <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
            <input type="checkbox" id="sponsorActive" checked style="width: 18px; height: 18px;">
            <span>Active</span>
          </label>
        </div>
        
        <div style="display: flex; justify-content: space-between; padding-top: 15px; border-top: 1px solid #eee;">
          <button id="sponsorDeleteBtn" onclick="deleteSponsor()" style="padding: 10px 20px; background: #ffebee; color: #c62828; border: none; border-radius: 5px; cursor: pointer; display: none;">Delete</button>
          <div style="display: flex; gap: 10px; margin-left: auto;">
            <button onclick="closeSponsorModal()" style="padding: 10px 20px; background: #f5f5f5; border: 1px solid #ddd; border-radius: 5px; cursor: pointer;">Cancel</button>
            <button onclick="saveSponsor()" style="padding: 10px 20px; background: #f57c00; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: 500;">Save Sponsor</button>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Contributors Panel -->
    <div class="panel" id="contributorsPanel" style="display: none;">
      <div class="toolbar" style="flex-wrap: wrap; gap: 10px;">
        <button class="btn-new" onclick="showCreateAccount()">
          <span>+</span> Create Account
        </button>
        <button onclick="bulkCreateAccounts()" style="background: #555; color: white; border: none; padding: 8px 16px; border-radius: 5px; cursor: pointer; font-size: 13px;">
           Create All Accounts
        </button>
        <button onclick="exportContributorsCSV()" style="background: #666; color: white; border: none; padding: 8px 16px; border-radius: 5px; cursor: pointer; font-size: 13px;">
           Export CSV
        </button>
        <div style="margin-left: auto; display: flex; gap: 10px; flex-wrap: wrap;">
          <select id="contributorTypeFilter" onchange="filterContributors()" style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 5px; font-size: 14px;">
            <option value="all">All Types</option>
            <option value="photographer">Photographers</option>
            <option value="videographer">Videographers</option>
            <option value="writer">Writers</option>
            <option value="graphics">Graphics</option>
            <option value="administrative">Administrative</option>
          </select>
          <select id="contributorStatusFilter" onchange="filterContributors()" style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 5px; font-size: 14px;">
            <option value="active">Active</option>
            <option value="inactive">Inactive</option>
            <option value="all">All</option>
          </select>
          <input type="text" id="contributorSearch" placeholder="Search..." oninput="filterContributors()" style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 5px; font-size: 14px; width: 150px;">
        </div>
      </div>
      
      <!-- Email Lists -->
      <div style="background: #e3f2fd; border-radius: 8px; padding: 15px; margin-bottom: 20px;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
          <h4 style="margin: 0; font-size: 14px; color: #1565c0;"> Email Lists</h4>
          <button onclick="toggleEmailLists()" id="emailListToggle" style="background: none; border: none; color: #1565c0; cursor: pointer; font-size: 12px;">Show Lists v</button>
        </div>
        <div id="emailListsContainer" style="display: none;">
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px;">
            <div>
              <label style="font-size: 12px; font-weight: 600; color: #555; display: block; margin-bottom: 5px;">All Contributors</label>
              <textarea id="emailListAll" readonly style="width: 100%; height: 60px; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 11px; resize: none;"></textarea>
              <button onclick="copyEmailList('emailListAll')" style="margin-top: 5px; background: #1565c0; color: white; border: none; padding: 5px 10px; border-radius: 4px; font-size: 11px; cursor: pointer;">Copy</button>
            </div>
            <div>
              <label style="font-size: 12px; font-weight: 600; color: #555; display: block; margin-bottom: 5px;">Photographers Only</label>
              <textarea id="emailListPhotog" readonly style="width: 100%; height: 60px; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 11px; resize: none;"></textarea>
              <button onclick="copyEmailList('emailListPhotog')" style="margin-top: 5px; background: #1565c0; color: white; border: none; padding: 5px 10px; border-radius: 4px; font-size: 11px; cursor: pointer;">Copy</button>
            </div>
            <div>
              <label style="font-size: 12px; font-weight: 600; color: #555; display: block; margin-bottom: 5px;">Videographers Only</label>
              <textarea id="emailListVideog" readonly style="width: 100%; height: 60px; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 11px; resize: none;"></textarea>
              <button onclick="copyEmailList('emailListVideog')" style="margin-top: 5px; background: #1565c0; color: white; border: none; padding: 5px 10px; border-radius: 4px; font-size: 11px; cursor: pointer;">Copy</button>
            </div>
            <div>
              <label style="font-size: 12px; font-weight: 600; color: #555; display: block; margin-bottom: 5px;">Writers Only</label>
              <textarea id="emailListWriter" readonly style="width: 100%; height: 60px; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 11px; resize: none;"></textarea>
              <button onclick="copyEmailList('emailListWriter')" style="margin-top: 5px; background: #1565c0; color: white; border: none; padding: 5px 10px; border-radius: 4px; font-size: 11px; cursor: pointer;">Copy</button>
            </div>
            <div>
              <label style="font-size: 12px; font-weight: 600; color: #555; display: block; margin-bottom: 5px;">Graphics Only</label>
              <textarea id="emailListGraphics" readonly style="width: 100%; height: 60px; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 11px; resize: none;"></textarea>
              <button onclick="copyEmailList('emailListGraphics')" style="margin-top: 5px; background: #1565c0; color: white; border: none; padding: 5px 10px; border-radius: 4px; font-size: 11px; cursor: pointer;">Copy</button>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Contributors Count -->
      <div style="font-size: 13px; color: #666; margin-bottom: 10px;">
        <span id="contributorCount">0 contributors</span>
      </div>
      
      <!-- Contributors List -->
      <div class="article-list" id="contributorList">
        <div class="article-row header" style="grid-template-columns: 50px 1fr 150px 120px 100px 120px;">
          <div></div>
          <div>Name</div>
          <div>Type</div>
          <div>Area</div>
          <div>Status</div>
          <div>Actions</div>
        </div>
        <div class="loading">Loading contributors...</div>
      </div>
    </div>
    
    <!-- Contributor Edit Modal -->
    <div id="contributorModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 2000; overflow-y: auto;">
      <div style="max-width: 800px; margin: 30px auto; background: #fff; border-radius: 10px; overflow: hidden; box-shadow: 0 4px 20px rgba(0,0,0,0.3);">
        <div style="background: #9c27b0; color: white; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center;">
          <h2 style="margin: 0; font-size: 16px; font-weight: 500;" id="contributorModalTitle">Edit Contributor</h2>
          <button onclick="closeContributorModal()" style="background: none; border: none; color: white; font-size: 24px; cursor: pointer; line-height: 1;">&times;</button>
        </div>
        
        <div style="padding: 20px; max-height: 70vh; overflow-y: auto;">
          <input type="hidden" id="contributorId">
          
          <!-- Basic Info -->
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
            <div class="form-group">
              <label>Name *</label>
              <input type="text" id="contribName">
            </div>
            <div class="form-group">
              <label>Email *</label>
              <input type="email" id="contribEmail">
            </div>
            <div class="form-group">
              <label>Primary Area</label>
              <input type="text" id="contribPrimaryArea">
            </div>
            <div class="form-group">
              <label>Cell</label>
              <input type="text" id="contribCell">
            </div>
          </div>
          
          <div class="form-group" style="margin-bottom: 15px;">
            <label>Mailing Address</label>
            <input type="text" id="contribAddress">
          </div>
          
          <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin-bottom: 15px;">
            <div class="form-group">
              <label>Venmo</label>
              <input type="text" id="contribVenmo">
            </div>
            <div class="form-group">
              <label>Shirt Size</label>
              <select id="contribShirtSize">
                <option value="">Select...</option>
                <option value="XS">XS</option>
                <option value="S">S</option>
                <option value="M">M</option>
                <option value="L">L</option>
                <option value="XL">XL</option>
                <option value="2XL">2XL</option>
                <option value="3XL">3XL</option>
              </select>
            </div>
            <div class="form-group">
              <label>SmugMug Name</label>
              <input type="text" id="contribSmugmugName" placeholder="Name as shown in galleries">
            </div>
          </div>
          
          <!-- Contributor Types -->
          <div style="background: #f9f9f9; border-radius: 8px; padding: 15px; margin-bottom: 15px;">
            <label style="font-size: 13px; font-weight: 600; color: #555; display: block; margin-bottom: 10px;">Contributor Type(s)</label>
            <div style="display: flex; gap: 20px; flex-wrap: wrap;">
              <label style="display: flex; align-items: center; gap: 6px; cursor: pointer;">
                <input type="checkbox" id="contribIsPhotographer">  Photographer
              </label>
              <label style="display: flex; align-items: center; gap: 6px; cursor: pointer;">
                <input type="checkbox" id="contribIsVideographer">  Videographer
              </label>
              <label style="display: flex; align-items: center; gap: 6px; cursor: pointer;">
                <input type="checkbox" id="contribIsWriter">  Writer
              </label>
              <label style="display: flex; align-items: center; gap: 6px; cursor: pointer;">
                <input type="checkbox" id="contribIsGraphics">  Graphics
              </label>
              <label style="display: flex; align-items: center; gap: 6px; cursor: pointer;">
                <input type="checkbox" id="contribIsAdministrative">  Administrative
              </label>
            </div>
          </div>
          
          <!-- Admin Settings -->
          <div style="background: #fff3e0; border-radius: 8px; padding: 15px; margin-bottom: 15px;">
            <label style="font-size: 13px; font-weight: 600; color: #e65100; display: block; margin-bottom: 10px;">Admin Settings</label>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
              <div class="form-group">
                <label>Top-10 Dropbox URL</label>
                <input type="url" id="contribTop10Url" placeholder="https://dropbox.com/request/...">
              </div>
              <div class="form-group">
                <label>&nbsp;</label>
                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; padding: 10px 0;">
                  <input type="checkbox" id="contribActive" checked>
                  <span style="font-weight: 600;">Active Contributor</span>
                </label>
              </div>
            </div>
          </div>
          
          <!-- Auth Status -->
          <div id="contribAuthStatus" style="background: #e8f5e9; border-radius: 8px; padding: 15px; margin-bottom: 15px; display: none;">
            <label style="font-size: 13px; font-weight: 600; color: #2e7d32; display: block; margin-bottom: 5px;">‚úî Account Created</label>
            <p style="font-size: 12px; color: #666; margin: 0;">This contributor has a login account.</p>
          </div>
          
          <!-- Save -->
          <div style="display: flex; justify-content: space-between; align-items: center; padding-top: 15px; border-top: 1px solid #eee;">
            <button onclick="deleteContributor()" id="deleteContribBtn" style="background: #ffebee; color: #c62828; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-size: 13px;">
               Delete
            </button>
            <div style="display: flex; gap: 10px;">
              <button onclick="closeContributorModal()" style="background: #eee; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">Cancel</button>
              <button onclick="saveContributor()" style="background: #f57c00; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-weight: 500;">Save</button>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Create Account Modal -->
    <div id="createAccountModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 2000; overflow-y: auto;">
      <div style="max-width: 500px; margin: 100px auto; background: #fff; border-radius: 10px; overflow: hidden; box-shadow: 0 4px 20px rgba(0,0,0,0.3);">
        <div style="background: #555; color: white; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center;">
          <h2 style="margin: 0; font-size: 16px; font-weight: 500;">Create Contributor Account</h2>
          <button onclick="closeCreateAccountModal()" style="background: none; border: none; color: white; font-size: 24px; cursor: pointer; line-height: 1;">&times;</button>
        </div>
        
        <div style="padding: 20px;">
          <p style="font-size: 13px; color: #666; margin-bottom: 20px;">Create a new contributor account with login credentials.</p>
          
          <div class="form-group" style="margin-bottom: 15px;">
            <label>Full Name *</label>
            <input type="text" id="createName">
          </div>
          <div class="form-group" style="margin-bottom: 15px;">
            <label>Email Address *</label>
            <input type="email" id="createEmail">
          </div>
          <div class="form-group" style="margin-bottom: 15px;">
            <label>Password *</label>
            <input type="text" id="createPassword" value="Gr@niteSt@teHoops">
          </div>
          
          <div style="display: flex; justify-content: flex-end; gap: 10px;">
            <button onclick="closeCreateAccountModal()" style="background: #eee; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">Cancel</button>
            <button onclick="createAccount()" style="background: #555; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-weight: 500;">Create Account</button>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Products Panel -->
    <div class="panel" id="productsPanel" style="display: none;">
      <div class="toolbar">
        <button class="btn-new" onclick="newProduct()">
          <span>+</span> Add Product
        </button>
      </div>
      <div id="productList">
        <div class="empty-state">
          <p>No products yet</p>
        </div>
      </div>
    </div>
    
    <!-- Rosters Panel -->
    <div class="panel" id="rostersPanel" style="display: none;">
      <div class="toolbar" style="flex-wrap: wrap; gap: 10px;">
        <div style="display: flex; gap: 8px; align-items: center;">
          <span style="font-size: 13px; color: #666;">Status:</span>
          <select id="rosterStatusFilter" onchange="filterRosters()" style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 5px; font-size: 13px;">
            <option value="pending">Pending</option>
            <option value="approved">Approved</option>
            <option value="rejected">Rejected</option>
            <option value="all">All</option>
          </select>
        </div>
        <div style="display: flex; gap: 8px; align-items: center;">
          <span style="font-size: 13px; color: #666;">Gender:</span>
          <select id="rosterGenderFilter" onchange="filterRosters()" style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 5px; font-size: 13px;">
            <option value="">All</option>
            <option value="Boys">Boys</option>
            <option value="Girls">Girls</option>
          </select>
        </div>
        <input type="text" id="rosterSearchBox" placeholder="Search school..." oninput="filterRosters()" style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 5px; font-size: 13px; width: 180px; margin-left: auto;">
      </div>
      
      <div style="padding: 10px 15px; background: #f5f5f5; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; margin-top: 15px;">
        <span id="rosterCount" style="font-size: 13px; color: #666;">Loading submissions...</span>
        <button onclick="loadRosters()" style="background: #f5f5f5; border: 1px solid #ddd; padding: 6px 12px; border-radius: 5px; cursor: pointer; font-size: 12px;"> Refresh</button>
      </div>
      
      <div class="article-list" id="rosterList">
        <div class="article-row header" style="grid-template-columns: 1fr 100px 100px 150px 120px 120px;">
          <div>School</div>
          <div>Gender</div>
          <div>Division</div>
          <div>Submitted</div>
          <div>Status</div>
          <div>Actions</div>
        </div>
        <div class="loading">Loading roster submissions...</div>
      </div>
    </div>
    
    <!-- Roster Review Modal -->
    <div id="rosterModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 2000; overflow-y: auto;">
      <div style="max-width: 900px; margin: 30px auto; background: #fff; border-radius: 10px; overflow: hidden; box-shadow: 0 4px 20px rgba(0,0,0,0.3);">
        <div style="background: #2e7d32; color: white; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center;">
          <h2 style="margin: 0; font-size: 16px; font-weight: 500;" id="rosterModalTitle">Review Roster Submission</h2>
          <button onclick="closeRosterModal()" style="background: none; border: none; color: white; font-size: 24px; cursor: pointer; line-height: 1;">&times;</button>
        </div>
        
        <div style="padding: 20px; max-height: 75vh; overflow-y: auto;">
          <input type="hidden" id="rosterId">
          
          <!-- Team Info Section -->
          <div style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 15px; margin-bottom: 20px;">
            <div class="form-group">
              <label>School *</label>
              <input type="text" id="rosterSchool" list="schoolsList">
            </div>
            <div class="form-group">
              <label>Gender *</label>
              <select id="rosterGender">
                <option value="Boys">Boys</option>
                <option value="Girls">Girls</option>
              </select>
            </div>
            <div class="form-group">
              <label>Division</label>
              <select id="rosterDivision">
                <option value="">Select...</option>
                <option value="D-I">D-I</option>
                <option value="D-II">D-II</option>
                <option value="D-III">D-III</option>
                <option value="D-IV">D-IV</option>
              </select>
            </div>
            <div class="form-group">
              <label>Season</label>
              <input type="text" id="rosterSeason" placeholder="2025-26" value="2025-26">
            </div>
          </div>
          <datalist id="schoolsList"></datalist>
          
          <!-- Coaches Section -->
          <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin-bottom: 20px;">
            <div class="form-group">
              <label>Head Coach</label>
              <input type="text" id="rosterHeadCoach">
            </div>
            <div class="form-group">
              <label>Assistant Coaches</label>
              <input type="text" id="rosterAssistants" placeholder="Comma-separated">
            </div>
            <div class="form-group">
              <label>Managers</label>
              <input type="text" id="rosterManagers" placeholder="Comma-separated">
            </div>
          </div>
          
          <!-- Submission Info -->
          <div style="background: #f5f5f5; border-radius: 8px; padding: 12px 15px; margin-bottom: 20px;">
            <div style="font-size: 12px; color: #666;">
              <span>Submitted by: <strong id="rosterSubmitter">-</strong></span>
              <span style="margin-left: 20px;">Email: <strong id="rosterEmail">-</strong></span>
              <span style="margin-left: 20px;">Type: <strong id="rosterType">-</strong></span>
              <span style="margin-left: 20px;">Date: <strong id="rosterSubmitDate">-</strong></span>
            </div>
          </div>
          
          <!-- PDF Link if applicable -->
          <div id="rosterPdfSection" style="display: none; background: #e3f2fd; border-radius: 8px; padding: 12px 15px; margin-bottom: 20px;">
            <a id="rosterPdfLink" href="#" target="_blank" style="color: #1565c0; font-weight: 500;">üìÑ View Uploaded PDF</a>
          </div>
          
          <!-- Players Section -->
          <div style="background: #fafafa; border: 1px solid #eee; border-radius: 8px; padding: 15px; margin-bottom: 20px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
              <h3 style="margin: 0; font-size: 14px; color: #333;">Players</h3>
              <button onclick="addPlayerRow()" style="background: #2e7d32; color: white; border: none; padding: 6px 14px; border-radius: 5px; cursor: pointer; font-size: 12px;">+ Add Player</button>
            </div>
            <div id="playersContainer" style="max-height: 350px; overflow-y: auto;">
              <table style="width: 100%; border-collapse: collapse; font-size: 13px;">
                <thead>
                  <tr style="background: #e8f5e9; text-align: left;">
                    <th style="padding: 8px 10px; width: 60px;">#</th>
                    <th style="padding: 8px 10px;">Name</th>
                    <th style="padding: 8px 10px; width: 80px;">Class</th>
                    <th style="padding: 8px 10px; width: 80px;">Position</th>
                    <th style="padding: 8px 10px; width: 50px;"></th>
                  </tr>
                </thead>
                <tbody id="playersTableBody">
                </tbody>
              </table>
            </div>
          </div>
          
          <!-- Admin Notes -->
          <div class="form-group" style="margin-bottom: 20px;">
            <label>Admin Notes</label>
            <textarea id="rosterNotes" rows="2" placeholder="Internal notes about this submission..." style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; font-size: 14px; resize: vertical;"></textarea>
          </div>
          
          <!-- Actions -->
          <div style="display: flex; justify-content: space-between; padding-top: 15px; border-top: 1px solid #eee;">
            <div>
              <button onclick="rejectRoster()" style="padding: 10px 20px; background: #ffebee; color: #c62828; border: none; border-radius: 5px; cursor: pointer; font-weight: 500;">Reject</button>
            </div>
            <div style="display: flex; gap: 10px;">
              <button onclick="closeRosterModal()" style="padding: 10px 20px; background: #f5f5f5; border: 1px solid #ddd; border-radius: 5px; cursor: pointer;">Cancel</button>
              <button onclick="saveRosterChanges()" style="padding: 10px 20px; background: #1565c0; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: 500;">Save Changes</button>
              <button onclick="approveRoster()" style="padding: 10px 25px; background: #2e7d32; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: 500;"> Approve & Export</button>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Social Publishing Panel -->
    <div class="panel" id="socialPublishingPanel" style="display: none;">
      <div class="editor-header">
        <h2> Social Media Posts</h2>
        <div class="editor-actions">
          <button class="btn-save" onclick="saveSocialPosts()" style="background: #2e7d32;">üíæ Save All</button>
          <button class="btn-back" onclick="closeSocialPublishing()">‚Üê Done</button>
        </div>
      </div>
      
      <p style="color: #666; margin-bottom: 20px;">Your article has been published! Edit and copy these posts for social media.</p>
      
      <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px;">
        <!-- Facebook -->
        <div class="sidebar-card" style="background: #fff; border: 2px solid #1877f2;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
            <h4 style="color: #1877f2; margin: 0;">üîò Facebook</h4>
            <button onclick="copySocialPost('facebook')" style="background: #1877f2; color: #fff; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 12px;">Copy</button>
          </div>
          <textarea id="socialFacebookPost" style="width: 100%; min-height: 300px; border: 1px solid #ddd; border-radius: 6px; padding: 10px; font-size: 13px; line-height: 1.5; resize: vertical; font-family: inherit;"></textarea>
          <div style="margin-top: 8px; font-size: 11px; color: #888;">
            <span id="fbCharCount">0</span> characters
          </div>
        </div>
        
        <!-- Instagram -->
        <div class="sidebar-card" style="background: #fff; border: 2px solid #e1306c;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
            <h4 style="color: #e1306c; margin: 0;">üì∏ Instagram</h4>
            <button onclick="copySocialPost('instagram')" style="background: linear-gradient(45deg, #f09433, #e6683c, #dc2743, #cc2366, #bc1888); color: #fff; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 12px;">Copy</button>
          </div>
          <textarea id="socialInstagramPost" style="width: 100%; min-height: 300px; border: 1px solid #ddd; border-radius: 6px; padding: 10px; font-size: 13px; line-height: 1.5; resize: vertical; font-family: inherit;"></textarea>
          <div style="margin-top: 8px; font-size: 11px; color: #888;">
            <span id="igCharCount">0</span> / 2,200 characters
          </div>
        </div>
        
        <!-- Twitter -->
        <div class="sidebar-card" style="background: #fff; border: 2px solid #000;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
            <h4 style="color: #000; margin: 0;">ùïè Twitter</h4>
            <button onclick="copySocialPost('twitter')" style="background: #000; color: #fff; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 12px;">Copy</button>
          </div>
          <textarea id="socialTwitterPost" style="width: 100%; min-height: 300px; border: 1px solid #ddd; border-radius: 6px; padding: 10px; font-size: 13px; line-height: 1.5; resize: vertical; font-family: inherit;"></textarea>
          <div style="margin-top: 8px; font-size: 11px;">
            <span id="twCharCount" style="color: #888;">0</span><span style="color: #888;"> / 280 characters</span>
          </div>
        </div>
      </div>
      
      <div style="margin-top: 20px; padding: 15px; background: #f5f5f5; border-radius: 8px;">
        <p style="margin: 0; font-size: 13px; color: #666;">
          üí° <strong>Tip:</strong> Copy each post, then paste into Hootsuite. Select your images from your photo gallery and schedule or post.
        </p>
      </div>
    </div>
    
    <!-- The Bash Panel -->
    <div class="panel" id="bashPanel" style="display: none;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h2 style="margin: 0; font-size: 18px;">The Bash Tournament</h2>
        <div style="display: flex; gap: 10px;">
          <button class="btn-new" style="background: #e8f5e9; color: #2e7d32;" onclick="exportBashData()">
            <span>Export</span>
          </button>
          <button class="btn-new" style="background: #e3f2fd; color: #1565c0;" onclick="importBashData()">
            <span>Import</span>
          </button>
        </div>
      </div>
      
      <!-- Sub-tabs -->
      <div class="bash-admin-tabs">
        <button class="bash-admin-tab active" onclick="showBashTab('schedule')">Schedule</button>
        <button class="bash-admin-tab" onclick="showBashTab('champions')">Champions</button>
        <button class="bash-admin-tab" onclick="showBashTab('awards')">Awards</button>
        <button class="bash-admin-tab" onclick="showBashTab('scorebook')">Scorebook</button>
        <button class="bash-admin-tab" onclick="showBashTab('stories')">üì∞ Stories</button>
        <button class="bash-admin-tab" onclick="showBashTab('recap')">Nightly Recap</button>
        <button class="bash-admin-tab" onclick="showBashTab('settings')">Settings</button>
      </div>
      
      <!-- Schedule Sub-Panel -->
      <div class="bash-sub-panel active" id="bashSchedulePanel">
        <div class="toolbar" style="margin-bottom: 15px;">
          <button class="btn-new" onclick="openBashGameModal()">
            <span>+</span> Add Game
          </button>
          <select id="bashYearFilter" onchange="filterBashSchedule()" style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 5px; font-size: 13px; margin-left: 10px;">
            <option value="2025">2025</option>
            <option value="2024">2024</option>
          </select>
          <select id="bashDivisionFilter" onchange="filterBashSchedule()" style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 5px; font-size: 13px; margin-left: 10px;">
            <option value="">All Divisions</option>
            <option value="Boys">Boys</option>
            <option value="Girls">Girls</option>
          </select>
          <span id="bashGameCount" style="margin-left: auto; font-size: 13px; color: #666;">0 games</span>
        </div>
        
        <div style="overflow-x: auto;">
          <table class="bash-table" id="bashScheduleTable">
            <thead>
              <tr>
                <th>Date</th>
                <th>Time</th>
                <th>Game#</th>
                <th>Div</th>
                <th>Away</th>
                <th>Score</th>
                <th>Home</th>
                <th>Site</th>
                <th>Coverage</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="bashScheduleBody">
              <tr><td colspan="10" class="loading">Loading schedule...</td></tr>
            </tbody>
          </table>
        </div>
      </div>
      
      <!-- Champions Sub-Panel -->
      <div class="bash-sub-panel" id="bashChampionsPanel">
        <div class="toolbar" style="margin-bottom: 15px;">
          <button class="btn-new" onclick="openBashChampionModal()">
            <span>+</span> Add Champion
          </button>
          <select id="bashChampionDivisionFilter" onchange="filterBashChampions()" style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 5px; font-size: 13px; margin-left: 10px;">
            <option value="">All Divisions</option>
            <option value="Boys">Boys</option>
            <option value="Girls">Girls</option>
          </select>
          <span id="bashChampionCount" style="margin-left: auto; font-size: 13px; color: #666;">0 records</span>
        </div>
        
        <div style="overflow-x: auto;">
          <table class="bash-table" id="bashChampionsTable">
            <thead>
              <tr>
                <th>Year</th>
                <th>Division</th>
                <th>Champion</th>
                <th>Score</th>
                <th>Runner-Up</th>
                <th>OT</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="bashChampionsBody">
              <tr><td colspan="7" class="loading">Loading champions...</td></tr>
            </tbody>
          </table>
        </div>
      </div>
      
      <!-- Awards Sub-Panel -->
      <div class="bash-sub-panel" id="bashAwardsPanel">
        <div class="toolbar" style="margin-bottom: 15px;">
          <button class="btn-new" onclick="openBashAwardModal()">
            <span>+</span> Add Award
          </button>
          <select id="bashAwardYearFilter" onchange="filterBashAwards()" style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 5px; font-size: 13px; margin-left: 10px;">
            <option value="">All Years</option>
          </select>
          <select id="bashAwardTypeFilter" onchange="filterBashAwards()" style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 5px; font-size: 13px; margin-left: 10px;">
            <option value="">All Awards</option>
            <option value="MVP">MVP</option>
            <option value="All-Tournament">All-Tournament</option>
            <option value="Sportsmanship">Sportsmanship</option>
            <option value="Team Sportsmanship">Team Sportsmanship</option>
            <option value="3-Point Contest Champ">3-Point Contest</option>
            <option value="Skills Challenge Champ">Skills Challenge</option>
            <option value="Slam Dunk Contest Champ">Slam Dunk</option>
          </select>
          <span id="bashAwardCount" style="margin-left: auto; font-size: 13px; color: #666;">0 records</span>
        </div>
        
        <div style="overflow-x: auto;">
          <table class="bash-table" id="bashAwardsTable">
            <thead>
              <tr>
                <th>Year</th>
                <th>Division</th>
                <th>Award</th>
                <th>Name</th>
                <th>School</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="bashAwardsBody">
              <tr><td colspan="6" class="loading">Loading awards...</td></tr>
            </tbody>
          </table>
        </div>
      </div>
      
      <!-- Scorebook Sub-Panel -->
      <div class="bash-sub-panel" id="bashScorebookPanel">
        <div style="display: flex; gap: 20px; flex-wrap: wrap;">
          <!-- Left: Game Selection -->
          <div style="flex: 1; min-width: 300px; max-width: 400px;">
            <div style="background: #fff; border: 1px solid #ddd; border-radius: 8px; overflow: hidden;">
              <div style="background: #f57c00; color: white; padding: 12px 16px;">
                <h3 style="margin: 0; font-size: 14px;">Select Game</h3>
              </div>
              <div style="padding: 12px;">
                <div style="display: flex; gap: 8px; margin-bottom: 12px;">
                  <select id="bashSBDateFilter" onchange="filterBashSBGames()" style="flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 5px;">
                    <option value="">All Days</option>
                    <option value="Dec 26">Dec 26</option>
                    <option value="Dec 27">Dec 27</option>
                    <option value="Dec 28">Dec 28</option>
                    <option value="Dec 29">Dec 29</option>
                    <option value="Dec 30">Dec 30</option>
                  </select>
                  <select id="bashSBDivFilter" onchange="filterBashSBGames()" style="flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 5px;">
                    <option value="">All</option>
                    <option value="Boys">Boys</option>
                    <option value="Girls">Girls</option>
                  </select>
                </div>
                <div id="bashSBGameList" style="max-height: 400px; overflow-y: auto; border: 1px solid #eee; border-radius: 5px;">
                  <div style="padding: 20px; text-align: center; color: #888;">Loading games...</div>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Right: Box Score Entry -->
          <div style="flex: 2; min-width: 400px;">
            <div id="bashSBEntryPanel" style="display: none; background: #fff; border: 1px solid #ddd; border-radius: 8px; overflow: hidden;">
              <div style="background: #333; color: white; padding: 12px 16px; display: flex; justify-content: space-between; align-items: center;">
                <h3 style="margin: 0; font-size: 14px;" id="bashSBMatchup">Game</h3>
                <button onclick="closeBashSBEntry()" style="background: none; border: none; color: #ccc; font-size: 18px; cursor: pointer;">&times;</button>
              </div>
              <div style="padding: 16px;">
                <input type="hidden" id="bashSBGameId">
                
                <!-- Quarter Scores -->
                <div style="margin-bottom: 16px;">
                  <label style="font-size: 12px; font-weight: 600; display: block; margin-bottom: 8px;">Quarter Scores</label>
                  <table style="width: 100%; font-size: 12px; border-collapse: collapse; background: #f9f9f9; border-radius: 5px;">
                    <thead>
                      <tr style="background: #eee;">
                        <th style="padding: 8px; text-align: left; width: 100px;">Team</th>
                        <th style="padding: 8px; width: 45px;">Q1</th>
                        <th style="padding: 8px; width: 45px;">Q2</th>
                        <th style="padding: 8px; width: 45px;">Q3</th>
                        <th style="padding: 8px; width: 45px;">Q4</th>
                        <th style="padding: 8px; width: 45px;" id="bashSBOTHeader"></th>
                        <th style="padding: 8px; width: 50px;">Final</th>
                      </tr>
                    </thead>
                    <tbody>
                      <tr>
                        <td id="bashSBAwayName" style="padding: 8px; font-weight: 500;">Away</td>
                        <td><input type="number" id="bashSBAwayQ1" class="quarter-input" onchange="calcBashSBFinal('away')"></td>
                        <td><input type="number" id="bashSBAwayQ2" class="quarter-input" onchange="calcBashSBFinal('away')"></td>
                        <td><input type="number" id="bashSBAwayQ3" class="quarter-input" onchange="calcBashSBFinal('away')"></td>
                        <td><input type="number" id="bashSBAwayQ4" class="quarter-input" onchange="calcBashSBFinal('away')"></td>
                        <td id="bashSBAwayOTCell"></td>
                        <td><input type="number" id="bashSBAwayFinal" class="quarter-input" style="background: #e8f5e9; font-weight: bold;" readonly></td>
                      </tr>
                      <tr>
                        <td id="bashSBHomeName" style="padding: 8px; font-weight: 500;">Home</td>
                        <td><input type="number" id="bashSBHomeQ1" class="quarter-input" onchange="calcBashSBFinal('home')"></td>
                        <td><input type="number" id="bashSBHomeQ2" class="quarter-input" onchange="calcBashSBFinal('home')"></td>
                        <td><input type="number" id="bashSBHomeQ3" class="quarter-input" onchange="calcBashSBFinal('home')"></td>
                        <td><input type="number" id="bashSBHomeQ4" class="quarter-input" onchange="calcBashSBFinal('home')"></td>
                        <td id="bashSBHomeOTCell"></td>
                        <td><input type="number" id="bashSBHomeFinal" class="quarter-input" style="background: #e8f5e9; font-weight: bold;" readonly></td>
                      </tr>
                    </tbody>
                  </table>
                  <button onclick="addBashSBOT()" style="margin-top: 8px; background: #eee; border: 1px solid #ccc; padding: 4px 10px; border-radius: 4px; font-size: 11px; cursor: pointer;">+ Add OT</button>
                </div>
                
                <!-- Rosters / Scorers -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 16px;">
                  <div>
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px;">
                      <label style="font-size: 12px; font-weight: 600;" id="bashSBAwayLabel">Away Scorers</label>
                      <span style="font-size: 11px; color: #888;">Total: <strong id="bashSBAwayTotal">0</strong> <span id="bashSBAwayMatch"></span></span>
                    </div>
                    <div id="bashSBAwayScorers" class="bash-roster-container">
                      <!-- Populated by JS -->
                    </div>
                    <button onclick="addBashBlankPlayer('away')" style="margin-top: 6px; background: #f5f5f5; border: 1px solid #ddd; padding: 4px 10px; border-radius: 4px; font-size: 11px; cursor: pointer; width: 100%;">+ Add Player</button>
                  </div>
                  <div>
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px;">
                      <label style="font-size: 12px; font-weight: 600;" id="bashSBHomeLabel">Home Scorers</label>
                      <span style="font-size: 11px; color: #888;">Total: <strong id="bashSBHomeTotal">0</strong> <span id="bashSBHomeMatch"></span></span>
                    </div>
                    <div id="bashSBHomeScorers" class="bash-roster-container">
                      <!-- Populated by JS -->
                    </div>
                    <button onclick="addBashBlankPlayer('home')" style="margin-top: 6px; background: #f5f5f5; border: 1px solid #ddd; padding: 4px 10px; border-radius: 4px; font-size: 11px; cursor: pointer; width: 100%;">+ Add Player</button>
                  </div>
                </div>
                
                <!-- Game Notes -->
                <div style="margin-bottom: 16px;">
                  <label style="font-size: 12px; font-weight: 600; display: block; margin-bottom: 6px;">Game Notes (optional)</label>
                  <textarea id="bashSBNotes" style="width: 100%; min-height: 60px; padding: 8px; border: 1px solid #ddd; border-radius: 5px; font-size: 12px;" placeholder="Key plays, storylines, milestones..."></textarea>
                </div>
                
                <!-- Generate Buttons -->
                <div style="display: flex; gap: 8px;">
                  <button onclick="generateBashStory()" id="bashSBGenerateBtn" style="flex: 1; background: #f57c00; color: white; border: none; padding: 12px; border-radius: 5px; font-size: 14px; font-weight: 600; cursor: pointer;">
                    ‚ú® Generate Story
                  </button>
                  <button onclick="writeBashOwn()" id="bashSBWriteOwnBtn" style="flex: 1; background: #1a73e8; color: white; border: none; padding: 12px; border-radius: 5px; font-size: 14px; font-weight: 600; cursor: pointer;">
                    ‚úçÔ∏è Write Your Own
                  </button>
                </div>
              </div>
            </div>
            
            <!-- Story Preview Panel -->
            <div id="bashSBPreviewPanel" style="display: none; background: #fff; border: 1px solid #ddd; border-radius: 8px; overflow: hidden;">
              <div style="background: #2e7d32; color: white; padding: 12px 16px; display: flex; justify-content: space-between; align-items: center;">
                <h3 style="margin: 0; font-size: 14px;">Review & Edit Story</h3>
                <button onclick="backToBashSBEntry()" style="background: rgba(255,255,255,0.2); border: none; color: white; padding: 4px 10px; border-radius: 4px; cursor: pointer; font-size: 12px;">‚Üê Back</button>
              </div>
              <div style="padding: 16px;">
                
                <!-- Quarter Scores Display Box -->
                <div style="background: #f9f9f9; border: 1px solid #ddd; border-radius: 8px; padding: 15px; margin-bottom: 15px;">
                  <table style="width: 100%; border-collapse: collapse; font-size: 13px; text-align: center;">
                    <thead>
                      <tr style="border-bottom: 2px solid #ddd;">
                        <th style="text-align: left; padding: 8px 10px; font-weight: 600;">Team</th>
                        <th style="padding: 8px 6px; font-weight: 500; color: #666;">Q1</th>
                        <th style="padding: 8px 6px; font-weight: 500; color: #666;">Q2</th>
                        <th style="padding: 8px 6px; font-weight: 500; color: #666;">Q3</th>
                        <th style="padding: 8px 6px; font-weight: 500; color: #666;">Q4</th>
                        <th id="bashSBPreviewOTHeaders"></th>
                        <th style="padding: 8px 10px; font-weight: 600;">Final</th>
                      </tr>
                    </thead>
                    <tbody>
                      <tr>
                        <td id="bashSBPreviewAwayName" style="text-align: left; padding: 10px; font-weight: 600;"></td>
                        <td id="bashSBPreviewAwayQ1" style="padding: 10px;"></td>
                        <td id="bashSBPreviewAwayQ2" style="padding: 10px;"></td>
                        <td id="bashSBPreviewAwayQ3" style="padding: 10px;"></td>
                        <td id="bashSBPreviewAwayQ4" style="padding: 10px;"></td>
                        <td id="bashSBPreviewAwayOT"></td>
                        <td id="bashSBPreviewAwayFinal" style="padding: 10px; font-weight: 700; font-size: 15px;"></td>
                      </tr>
                      <tr style="border-top: 1px solid #eee;">
                        <td id="bashSBPreviewHomeName" style="text-align: left; padding: 10px; font-weight: 600;"></td>
                        <td id="bashSBPreviewHomeQ1" style="padding: 10px;"></td>
                        <td id="bashSBPreviewHomeQ2" style="padding: 10px;"></td>
                        <td id="bashSBPreviewHomeQ3" style="padding: 10px;"></td>
                        <td id="bashSBPreviewHomeQ4" style="padding: 10px;"></td>
                        <td id="bashSBPreviewHomeOT"></td>
                        <td id="bashSBPreviewHomeFinal" style="padding: 10px; font-weight: 700; font-size: 15px;"></td>
                      </tr>
                    </tbody>
                  </table>
                </div>
                
                <!-- Headline -->
                <div style="margin-bottom: 12px;">
                  <label style="font-size: 12px; font-weight: 600; color: #333; display: block; margin-bottom: 5px;">Headline</label>
                  <input type="text" id="bashSBHeadline" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; font-weight: 600;">
                </div>
                
                <!-- Article Body - WYSIWYG style preview -->
                <div style="margin-bottom: 12px;">
                  <label style="font-size: 12px; font-weight: 600; color: #333; display: block; margin-bottom: 5px;">Article</label>
                  <div id="bashSBPreviewArticleDisplay" style="background: #fff; border: 1px solid #ddd; border-radius: 6px; padding: 15px; font-size: 14px; line-height: 1.8; font-family: Georgia, serif; min-height: 200px; max-height: 350px; overflow-y: auto;"></div>
                  <textarea id="bashSBArticle" style="display: none;"></textarea>
                  <div style="margin-top: 8px; display: flex; gap: 8px;">
                    <button onclick="toggleBashArticleEdit()" id="bashSBEditToggleBtn" style="background: #f0f0f0; border: 1px solid #ccc; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 12px;">‚úçÔ∏è Edit Text</button>
                    <small style="color: #888; font-size: 11px; line-height: 28px;">Click to edit. Social media posts will be generated from this text.</small>
                  </div>
                </div>
                
                <!-- Publish Buttons -->
                <div style="display: flex; gap: 10px;">
                  <button onclick="saveBashAndGenerateSocial()" id="bashSBSaveBtn" style="flex: 1; background: #2e7d32; color: white; border: none; padding: 15px; border-radius: 6px; font-size: 14px; font-weight: 600; cursor: pointer;">
                    ‚úî Save & Generate Social
                  </button>
                  <button onclick="publishBashDirect()" id="bashSBPublishDirectBtn" style="flex: 1; background: #1565c0; color: white; border: none; padding: 15px; border-radius: 6px; font-size: 14px; font-weight: 600; cursor: pointer;">
                    üì∞ Publish Without Social
                  </button>
                </div>
              </div>
            </div>

            
            <!-- Empty State -->
            <div id="bashSBEmptyState" style="background: #f9f9f9; border: 2px dashed #ddd; border-radius: 8px; padding: 60px 20px; text-align: center;">
              <div style="font-size: 48px; margin-bottom: 10px; color: #ccc;">‚úèÔ∏è</div>
              <h3 style="margin: 0 0 8px; color: #666;">Select a Game</h3>
              <p style="margin: 0; color: #888; font-size: 13px;">Choose a game from the list to create a scorebook story</p>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Stories Sub-Panel (All Bash Content) -->
      <div class="bash-sub-panel" id="bashStoriesPanel">
        <div class="toolbar" style="margin-bottom: 15px;">
          <button class="btn-new" onclick="openBashStoryModal()">
            <span>+</span> New Story
          </button>
          <select id="bashContentTypeFilter" onchange="filterBashContent()" style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 5px; font-size: 13px; margin-left: 10px;">
            <option value="">All Content</option>
            <option value="scorebook">Scorebook Stories</option>
            <option value="story">Feature Stories</option>
            <option value="recap">Nightly Recaps</option>
          </select>
          <span id="bashContentCount" style="margin-left: auto; font-size: 13px; color: #666;">0 items</span>
        </div>
        
        <div style="overflow-x: auto;">
          <table class="bash-table" id="bashContentTable">
            <thead>
              <tr>
                <th style="width: 30px;">üìå</th>
                <th>Title</th>
                <th>Type</th>
                <th>Day</th>
                <th>Teams</th>
                <th>Main Site</th>
                <th>Status</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="bashContentBody">
              <tr><td colspan="8" class="loading">Loading content...</td></tr>
            </tbody>
          </table>
        </div>
      </div>
      
      <!-- Nightly Recap Sub-Panel -->
      <div class="bash-sub-panel" id="bashRecapPanel">
        <div style="max-width: 800px;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h3 style="margin: 0;">Nightly Recap Generator</h3>
            <select id="bashRecapDate" style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 5px;">
              <option value="Dec 26">December 26</option>
              <option value="Dec 27">December 27</option>
              <option value="Dec 28">December 28</option>
              <option value="Dec 29">December 29</option>
              <option value="Dec 30">December 30</option>
            </select>
          </div>
          
          <!-- Day Summary -->
          <div style="background: #fff; border: 1px solid #ddd; border-radius: 8px; padding: 16px; margin-bottom: 20px;">
            <h4 style="margin: 0 0 12px; font-size: 14px;">Day Summary</h4>
            <div id="bashRecapSummary" style="font-size: 13px; color: #666;">
              Select a date to see completed games for that day.
            </div>
          </div>
          
          <!-- Recap Sections -->
          <div style="background: #fff; border: 1px solid #ddd; border-radius: 8px; overflow: hidden; margin-bottom: 20px;">
            <div style="background: #1565c0; color: white; padding: 12px 16px;">
              <h4 style="margin: 0; font-size: 14px;">Recap Content</h4>
            </div>
            <div style="padding: 16px;">
              <div style="margin-bottom: 16px;">
                <label style="font-size: 12px; font-weight: 600; display: block; margin-bottom: 6px;">Headline</label>
                <input type="text" id="bashRecapHeadline" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;" placeholder="Day 1: Opening Day Delivers Thrilling Finishes">
              </div>
              
              <div style="margin-bottom: 16px;">
                <label style="font-size: 12px; font-weight: 600; display: block; margin-bottom: 6px;">Highlights & Storylines</label>
                <textarea id="bashRecapHighlights" style="width: 100%; min-height: 120px; padding: 10px; border: 1px solid #ddd; border-radius: 5px; font-size: 13px;" placeholder="Key moments, upsets, standout performances, records broken..."></textarea>
              </div>
              
              <div style="margin-bottom: 16px;">
                <label style="font-size: 12px; font-weight: 600; display: block; margin-bottom: 6px;">Looking Ahead (Tomorrow's Preview)</label>
                <textarea id="bashRecapPreview" style="width: 100%; min-height: 80px; padding: 10px; border: 1px solid #ddd; border-radius: 5px; font-size: 13px;" placeholder="Key matchups to watch tomorrow..."></textarea>
              </div>
            </div>
          </div>
          
          <!-- Generate & Publish -->
          <div style="display: flex; gap: 10px;">
            <button onclick="generateBashRecap()" style="flex: 1; background: #1565c0; color: white; border: none; padding: 12px; border-radius: 5px; font-size: 14px; font-weight: 600; cursor: pointer;">
              Generate Recap
            </button>
            <button onclick="publishBashRecap()" style="flex: 1; background: #2e7d32; color: white; border: none; padding: 12px; border-radius: 5px; font-size: 14px; font-weight: 600; cursor: pointer;">
              Publish to Both Sites
            </button>
          </div>
          <small style="display: block; margin-top: 10px; color: #888; text-align: center;">
            Nightly recaps appear on both The Bash landing page AND the main Ball603 homepage.
          </small>
        </div>
      </div>
      
      <!-- Settings Sub-Panel -->
      <div class="bash-sub-panel" id="bashSettingsPanel">
        <div style="max-width: 600px;">
          <h3 style="margin-bottom: 20px;">Tournament Settings</h3>
          
          <div class="form-group" style="margin-bottom: 20px;">
            <label>Tournament Year</label>
            <input type="number" id="bashSettingYear" value="2025" style="width: 100px;">
          </div>
          
          <div class="form-group" style="margin-bottom: 20px;">
            <label>Start Date</label>
            <input type="date" id="bashSettingStartDate" value="2025-12-26">
          </div>
          
          <div class="form-group" style="margin-bottom: 20px;">
            <label>End Date</label>
            <input type="date" id="bashSettingEndDate" value="2025-12-30">
          </div>
          
          <div class="form-group" style="margin-bottom: 20px;">
            <label>Primary Venue</label>
            <input type="text" id="bashSettingVenue" value="Farmington High School" style="width: 100%;">
          </div>
          
          <button onclick="saveBashSettings()" style="background: #f57c00; color: white; border: none; padding: 12px 24px; border-radius: 5px; cursor: pointer; font-weight: 500;">
            Save Settings
          </button>
          
          <hr style="margin: 30px 0; border: none; border-top: 1px solid #eee;">
          
          <h3 style="margin-bottom: 20px;">Data Management</h3>
          
          <div style="display: flex; gap: 10px; flex-wrap: wrap;">
            <button onclick="regenerateBashDataFile()" style="background: #1565c0; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">
              Regenerate Data File
            </button>
          </div>
          <small style="display: block; margin-top: 10px; color: #888;">
            Regenerate will download a new the-bash-data.js file from the database.
          </small>
        </div>
      </div>
    </div>
    
    <!-- Bash Game Modal -->
    <div id="bashGameModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 2000; overflow-y: auto;">
      <div style="max-width: 700px; margin: 30px auto; background: #fff; border-radius: 10px; overflow: hidden;">
        <div style="background: #f57c00; color: white; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center;">
          <h2 style="margin: 0; font-size: 16px;" id="bashGameModalTitle">Add Game</h2>
          <button onclick="closeBashGameModal()" style="background: none; border: none; color: white; font-size: 24px; cursor: pointer;">&times;</button>
        </div>
        
        <div style="padding: 20px;">
          <input type="hidden" id="bashGameId">
          
          <div class="bash-form-row cols-4">
            <div class="form-group">
              <label>Date *</label>
              <select id="bashGameDate">
                <option value="Dec 26">Dec 26</option>
                <option value="Dec 27">Dec 27</option>
                <option value="Dec 28">Dec 28</option>
                <option value="Dec 29">Dec 29</option>
                <option value="Dec 30">Dec 30</option>
              </select>
            </div>
            <div class="form-group">
              <label>Time *</label>
              <input type="text" id="bashGameTime" placeholder="9:00 AM">
            </div>
            <div class="form-group">
              <label>Game #</label>
              <input type="number" id="bashGameNumber" placeholder="1">
            </div>
            <div class="form-group">
              <label>Division *</label>
              <select id="bashGameDivision">
                <option value="Boys">Boys</option>
                <option value="Girls">Girls</option>
              </select>
            </div>
          </div>
          
          <div class="bash-form-row cols-4">
            <div class="form-group">
              <label>Away Team *</label>
              <input type="text" id="bashGameAway" placeholder="Team name">
            </div>
            <div class="form-group">
              <label>Away Score</label>
              <input type="number" id="bashGameAwayScore" min="0">
            </div>
            <div class="form-group">
              <label>Home Team *</label>
              <input type="text" id="bashGameHome" placeholder="Team name">
            </div>
            <div class="form-group">
              <label>Home Score</label>
              <input type="number" id="bashGameHomeScore" min="0">
            </div>
          </div>
          
          <div class="bash-form-row cols-3">
            <div class="form-group">
              <label>Site</label>
              <select id="bashGameSite">
                <option value="FHS">FHS</option>
                <option value="HWMS">HWMS</option>
              </select>
            </div>
            <div class="form-group">
              <label>Overtime</label>
              <select id="bashGameOvertime">
                <option value="false">No</option>
                <option value="true">Yes</option>
              </select>
            </div>
            <div class="form-group">
              <label>Special Event</label>
              <select id="bashGameSpecial">
                <option value="false">No</option>
                <option value="true">Yes (Contests)</option>
              </select>
            </div>
          </div>
          
          <h4 style="margin: 20px 0 15px; padding-top: 15px; border-top: 1px solid #eee;">Coverage Links</h4>
          
          <div class="bash-form-row cols-2">
            <div class="form-group">
              <label>Recap URL</label>
              <input type="url" id="bashGameRecap" placeholder="https://...">
            </div>
            <div class="form-group">
              <label>Photos URL</label>
              <input type="url" id="bashGamePhotos" placeholder="https://...">
            </div>
          </div>
          
          <div class="bash-form-row cols-2">
            <div class="form-group">
              <label>Video URL</label>
              <input type="url" id="bashGameVideo" placeholder="https://...">
            </div>
            <div class="form-group">
              <label>Highlights URL</label>
              <input type="url" id="bashGameHighlights" placeholder="https://...">
            </div>
          </div>
          
          <div style="display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px; padding-top: 15px; border-top: 1px solid #eee;">
            <button onclick="closeBashGameModal()" style="padding: 10px 20px; background: #f5f5f5; border: 1px solid #ddd; border-radius: 5px; cursor: pointer;">Cancel</button>
            <button onclick="saveBashGame()" style="padding: 10px 20px; background: #f57c00; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: 500;">Save Game</button>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Bash Champion Modal -->
    <div id="bashChampionModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 2000; overflow-y: auto;">
      <div style="max-width: 500px; margin: 30px auto; background: #fff; border-radius: 10px; overflow: hidden;">
        <div style="background: #f57c00; color: white; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center;">
          <h2 style="margin: 0; font-size: 16px;" id="bashChampionModalTitle">Add Champion</h2>
          <button onclick="closeBashChampionModal()" style="background: none; border: none; color: white; font-size: 24px; cursor: pointer;">&times;</button>
        </div>
        
        <div style="padding: 20px;">
          <input type="hidden" id="bashChampionId">
          
          <div class="bash-form-row cols-2">
            <div class="form-group">
              <label>Year *</label>
              <input type="number" id="bashChampionYear" placeholder="2024" min="1979" max="2030">
            </div>
            <div class="form-group">
              <label>Division *</label>
              <select id="bashChampionDivision">
                <option value="Boys">Boys</option>
                <option value="Girls">Girls</option>
              </select>
            </div>
          </div>
          
          <div class="bash-form-row cols-2">
            <div class="form-group">
              <label>Champion *</label>
              <input type="text" id="bashChampionWinner" placeholder="Team name">
            </div>
            <div class="form-group">
              <label>Champion Score *</label>
              <input type="number" id="bashChampionWinnerScore" min="0">
            </div>
          </div>
          
          <div class="bash-form-row cols-2">
            <div class="form-group">
              <label>Runner-Up *</label>
              <input type="text" id="bashChampionRunnerUp" placeholder="Team name">
            </div>
            <div class="form-group">
              <label>Runner-Up Score *</label>
              <input type="number" id="bashChampionRunnerUpScore" min="0">
            </div>
          </div>
          
          <div class="form-group">
            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
              <input type="checkbox" id="bashChampionOvertime"> Overtime
            </label>
          </div>
          
          <div style="display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px; padding-top: 15px; border-top: 1px solid #eee;">
            <button onclick="closeBashChampionModal()" style="padding: 10px 20px; background: #f5f5f5; border: 1px solid #ddd; border-radius: 5px; cursor: pointer;">Cancel</button>
            <button onclick="saveBashChampion()" style="padding: 10px 20px; background: #f57c00; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: 500;">Save Champion</button>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Bash Award Modal -->
    <div id="bashAwardModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 2000; overflow-y: auto;">
      <div style="max-width: 500px; margin: 30px auto; background: #fff; border-radius: 10px; overflow: hidden;">
        <div style="background: #f57c00; color: white; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center;">
          <h2 style="margin: 0; font-size: 16px;" id="bashAwardModalTitle">Add Award</h2>
          <button onclick="closeBashAwardModal()" style="background: none; border: none; color: white; font-size: 24px; cursor: pointer;">&times;</button>
        </div>
        
        <div style="padding: 20px;">
          <input type="hidden" id="bashAwardId">
          
          <div class="bash-form-row cols-2">
            <div class="form-group">
              <label>Year *</label>
              <input type="number" id="bashAwardYear" placeholder="2024" min="1979" max="2030">
            </div>
            <div class="form-group">
              <label>Division *</label>
              <select id="bashAwardDivision">
                <option value="Boys">Boys</option>
                <option value="Girls">Girls</option>
              </select>
            </div>
          </div>
          
          <div class="form-group" style="margin-bottom: 15px;">
            <label>Award Type *</label>
            <select id="bashAwardType">
              <option value="MVP">MVP</option>
              <option value="All-Tournament">All-Tournament</option>
              <option value="Sportsmanship">Sportsmanship</option>
              <option value="Team Sportsmanship">Team Sportsmanship</option>
              <option value="3-Point Contest Champ">3-Point Contest Champ</option>
              <option value="Skills Challenge Champ">Skills Challenge Champ</option>
              <option value="Slam Dunk Contest Champ">Slam Dunk Contest Champ</option>
            </select>
          </div>
          
          <div class="form-group" style="margin-bottom: 15px;">
            <label>Recipient Name</label>
            <input type="text" id="bashAwardName" placeholder="Player name (blank for team awards)">
          </div>
          
          <div class="form-group" style="margin-bottom: 15px;">
            <label>School *</label>
            <input type="text" id="bashAwardSchool" placeholder="School name">
          </div>
          
          <div style="display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px; padding-top: 15px; border-top: 1px solid #eee;">
            <button onclick="closeBashAwardModal()" style="padding: 10px 20px; background: #f5f5f5; border: 1px solid #ddd; border-radius: 5px; cursor: pointer;">Cancel</button>
            <button onclick="saveBashAward()" style="padding: 10px 20px; background: #f57c00; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: 500;">Save Award</button>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Bash Story Modal -->
    <div id="bashStoryModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 2000; overflow-y: auto;">
      <div style="max-width: 700px; margin: 30px auto; background: #fff; border-radius: 10px; overflow: hidden;">
        <div style="background: #f57c00; color: white; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center;">
          <h2 style="margin: 0; font-size: 16px;" id="bashStoryModalTitle">New Story</h2>
          <button onclick="closeBashStoryModal()" style="background: none; border: none; color: white; font-size: 24px; cursor: pointer;">&times;</button>
        </div>
        
        <div style="padding: 20px;">
          <input type="hidden" id="bashStoryId">
          
          <div class="form-group" style="margin-bottom: 15px;">
            <label>Title *</label>
            <input type="text" id="bashStoryTitle" placeholder="Story headline..." style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
          </div>
          
          <div class="bash-form-row cols-3">
            <div class="form-group">
              <label>Day</label>
              <select id="bashStoryDay" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                <option value="">Select day...</option>
                <option value="1">Day 1 - Dec 26</option>
                <option value="2">Day 2 - Dec 27</option>
                <option value="3">Day 3 - Dec 28</option>
                <option value="4">Day 4 - Dec 29</option>
                <option value="5">Day 5 - Dec 30</option>
              </select>
            </div>
            <div class="form-group">
              <label>Division</label>
              <select id="bashStoryDivision" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                <option value="">Both/General</option>
                <option value="Boys">Boys</option>
                <option value="Girls">Girls</option>
              </select>
            </div>
            <div class="form-group">
              <label>Author</label>
              <input type="text" id="bashStoryAuthor" placeholder="Author name" value="Ball603 Staff" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
            </div>
          </div>
          
          <div class="form-group" style="margin-bottom: 15px;">
            <label>Teams (comma-separated)</label>
            <input type="text" id="bashStoryTeams" placeholder="e.g. Franklin, Kennett" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
          </div>
          
          <div class="form-group" style="margin-bottom: 15px;">
            <label>Featured Image URL</label>
            <input type="text" id="bashStoryImage" placeholder="https://..." style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
          </div>
          
          <div class="form-group" style="margin-bottom: 15px;">
            <label>Content</label>
            <textarea id="bashStoryContent" rows="10" placeholder="Write your story..." style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; font-family: inherit;"></textarea>
          </div>
          
          <div style="display: flex; gap: 20px; margin-bottom: 15px;">
            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
              <input type="checkbox" id="bashStoryPinned" style="width: 18px; height: 18px;">
              <span>üìå Pin to top</span>
            </label>
            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
              <input type="checkbox" id="bashStoryPublished" checked style="width: 18px; height: 18px;">
              <span>Published</span>
            </label>
          </div>
          
          <div style="display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px; padding-top: 15px; border-top: 1px solid #eee;">
            <button onclick="closeBashStoryModal()" style="padding: 10px 20px; background: #f5f5f5; border: 1px solid #ddd; border-radius: 5px; cursor: pointer;">Cancel</button>
            <button onclick="saveBashStory()" style="padding: 10px 20px; background: #f57c00; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: 500;">Save Story</button>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Graphics Creator Panel -->
  <div class="panel" id="graphicsPanel" style="display: none;">
    <!-- Sub-tabs for Graphics -->
    <div style="display: flex; gap: 5px; margin-bottom: 20px; border-bottom: 2px solid #eee; padding-bottom: 10px;">
      <button class="graphics-subtab active" onclick="showGraphicsSubTab('creator', this)" style="padding: 10px 20px; background: #f57c00; color: white; border: 1px solid #f57c00; border-radius: 5px 5px 0 0; cursor: pointer; font-size: 14px; font-weight: 500;">üé® Creator</button>
      <button class="graphics-subtab" onclick="showGraphicsSubTab('templates', this)" style="padding: 10px 20px; background: none; color: #666; border: 1px solid #ddd; border-radius: 5px 5px 0 0; cursor: pointer; font-size: 14px; font-weight: 500;">üìÇ Templates</button>
    </div>
    
    <!-- ========== CREATOR TAB ========== -->
    <div id="graphicsCreatorPanel">
      <div style="display: grid; grid-template-columns: 320px 1fr; gap: 20px;">
        <!-- Left Sidebar -->
        <div style="display: flex; flex-direction: column; gap: 12px; max-height: calc(100vh - 250px); overflow-y: auto;">
          
          <!-- Output Size -->
          <div class="gc-sidebar-card">
            <div class="gc-card-header" onclick="toggleGcCard(this)">
              <span>üìà Output Size</span>
              <span class="gc-toggle">‚ñº</span>
            </div>
            <div class="gc-card-body">
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px;">
                <div>
                  <label style="font-size: 11px; color: #666;">Width</label>
                  <input type="number" id="gcOutputWidth" value="2400" min="100" max="4000" onchange="updateCanvasSize()" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px;">
                </div>
                <div>
                  <label style="font-size: 11px; color: #666;">Height</label>
                  <input type="number" id="gcOutputHeight" value="3000" min="100" max="4000" onchange="updateCanvasSize()" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px;">
                </div>
              </div>
              <select id="gcSizePreset" onchange="applySizePreset()" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px;">
                <option value="custom">Custom</option>
                <option value="2400x3000" selected>Ball603 Standard (2400√ó3000)</option>
                <option value="1080x1350">Instagram Post (1080√ó1350)</option>
                <option value="1080x1920">Instagram Story (1080√ó1920)</option>
                <option value="1200x630">Facebook Post (1200√ó630)</option>
                <option value="1200x675">Twitter Post (1200√ó675)</option>
              </select>
            </div>
          </div>
          
          <!-- School Colors (for variables) -->
          <div class="gc-sidebar-card">
            <div class="gc-card-header" onclick="toggleGcCard(this)">
              <span>üé® School Colors</span>
              <span class="gc-toggle">‚ñº</span>
            </div>
            <div class="gc-card-body">
              <select id="gcCreatorTeamSelect" onchange="applyCreatorTeamColors()" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px; margin-bottom: 10px;">
                <option value="">Select team for color variables...</option>
              </select>
              <div style="display: flex; gap: 10px;">
                <div style="flex: 1; text-align: center;">
                  <div id="gcCreatorPrimaryPreview" style="width: 100%; height: 30px; background: #1e3a8a; border-radius: 4px; border: 1px solid #ddd;"></div>
                  <div style="font-size: 10px; color: #888; margin-top: 4px;">{{primary}}</div>
                </div>
                <div style="flex: 1; text-align: center;">
                  <div id="gcCreatorSecondaryPreview" style="width: 100%; height: 30px; background: #fbbf24; border-radius: 4px; border: 1px solid #ddd;"></div>
                  <div style="font-size: 10px; color: #888; margin-top: 4px;">{{secondary}}</div>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Layers Panel -->
          <div class="gc-sidebar-card gc-layers-panel">
            <div class="gc-card-header">
              <span>üìã Layers</span>
              <button onclick="addGcLayer()" style="background: #e8f5e9; color: #2e7d32; border: none; padding: 4px 10px; border-radius: 4px; font-size: 11px; cursor: pointer;">+ Add</button>
            </div>
            <div id="gcLayersList" style="display: flex; flex-direction: column; gap: 2px;">
              <!-- Layers rendered here dynamically -->
            </div>
          </div>
          
        </div>
        
        <!-- Right Side - Canvas Area -->
        <div style="display: flex; flex-direction: column; gap: 15px;">
          <!-- Canvas Preview -->
          <div id="gcCanvasContainer" style="background: #e8e8e8; border-radius: 8px; padding: 20px; display: flex; justify-content: center; align-items: center; min-height: 500px; position: relative; overflow: hidden;">
            <div style="background: #fff; border-radius: 4px; box-shadow: 0 4px 20px rgba(0,0,0,0.15); overflow: hidden; position: relative;">
              <canvas id="gcCanvas"></canvas>
            </div>
          </div>
          
          <!-- Canvas Controls -->
          <div style="display: flex; align-items: center; gap: 15px; padding: 10px 15px; background: #f5f5f5; border-radius: 8px;">
            <div style="display: flex; align-items: center; gap: 8px;">
              <button onclick="gcZoom('out')" style="width: 28px; height: 28px; border: 1px solid #ddd; background: #fff; border-radius: 4px; cursor: pointer; font-size: 16px;">‚àí</button>
              <span id="gcZoomLevel" style="font-size: 12px; color: #666; min-width: 45px; text-align: center;">100%</span>
              <button onclick="gcZoom('in')" style="width: 28px; height: 28px; border: 1px solid #ddd; background: #fff; border-radius: 4px; cursor: pointer; font-size: 16px;">+</button>
              <button onclick="gcZoom('fit')" style="padding: 5px 10px; border: 1px solid #ddd; background: #fff; border-radius: 4px; cursor: pointer; font-size: 11px;">Fit</button>
            </div>
            <div style="flex: 1;"></div>
            <span id="gcCanvasSizeLabel" style="font-size: 11px; color: #888;">2400 √ó 3000px</span>
          </div>
          
          <!-- Bottom Toolbar -->
          <div style="display: flex; gap: 10px; justify-content: space-between; padding: 15px; background: #f9f9f9; border-radius: 8px; border: 1px solid #eee;">
            <div style="display: flex; gap: 10px;">
              <button onclick="resetGcCreator()" class="gc-btn gc-btn-danger">üîÑ Reset</button>
              <button onclick="previewGcFullSize()" class="gc-btn gc-btn-secondary">üëÅÔ∏è Preview Full Size</button>
            </div>
            <div style="display: flex; gap: 10px;">
              <button onclick="saveGcAsPNG()" class="gc-btn gc-btn-success">üíæ Save PNG</button>
              <button onclick="openSaveTemplateModal()" class="gc-btn gc-btn-primary">üìÇ Save Template</button>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- ========== TEMPLATES TAB ========== -->
    <div id="graphicsTemplatesPanel" style="display: none;">
      <!-- Template Selection View -->
      <div id="gcTemplateGrid">
        <div style="margin-bottom: 20px;">
          <h3 style="margin: 0 0 5px 0; font-size: 16px; color: #333;">Select a Template</h3>
          <p style="margin: 0; font-size: 13px; color: #666;">Choose a template to customize and export</p>
        </div>
        <div id="gcTemplatesList" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 15px;">
          <!-- Templates rendered dynamically -->
          <div class="gc-template-card gc-template-new" onclick="showGraphicsSubTab('creator', document.querySelector('.graphics-subtab'))">
            <div style="font-size: 40px; margin-bottom: 8px;">+</div>
            <div style="font-size: 13px; font-weight: 500;">Create New</div>
          </div>
        </div>
      </div>
      
      <!-- Template Editor View -->
      <div id="gcTemplateEditor" style="display: none;">
        <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 20px;">
          <button onclick="backToTemplateGrid()" class="gc-btn gc-btn-secondary">‚Üê Back</button>
          <h3 id="gcTemplateEditorTitle" style="margin: 0; font-size: 16px;">Editing Template</h3>
          <button onclick="deleteCurrentTemplate()" class="gc-btn gc-btn-danger" style="margin-left: auto;">üóëÔ∏è Delete Template</button>
        </div>
        
        <div style="display: grid; grid-template-columns: 300px 1fr; gap: 20px;">
          <!-- Left Panel - Editable Fields -->
          <div style="display: flex; flex-direction: column; gap: 15px;">
            <!-- Team Colors -->
            <div class="gc-sidebar-card">
              <div class="gc-card-header">
                <span>üé® Team Colors</span>
              </div>
              <div class="gc-card-body">
                <select id="gcTemplateTeamSelect" onchange="applyTemplateTeamColors()" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; font-size: 14px; margin-bottom: 10px;">
                  <option value="">Select team...</option>
                </select>
                <div style="display: flex; gap: 15px;">
                  <div style="flex: 1;">
                    <label style="font-size: 11px; color: #666;">Primary</label>
                    <div style="display: flex; align-items: center; gap: 8px; margin-top: 4px;">
                      <input type="color" id="gcTemplatePrimary" value="#1e3a8a" onchange="updateTemplateColors()" style="width: 40px; height: 32px; border: none; cursor: pointer;">
                      <input type="text" id="gcTemplatePrimaryHex" value="#1e3a8a" onchange="updateTemplateColorFromHex('primary')" style="flex: 1; padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px;">
                    </div>
                  </div>
                  <div style="flex: 1;">
                    <label style="font-size: 11px; color: #666;">Secondary</label>
                    <div style="display: flex; align-items: center; gap: 8px; margin-top: 4px;">
                      <input type="color" id="gcTemplateSecondary" value="#fbbf24" onchange="updateTemplateColors()" style="width: 40px; height: 32px; border: none; cursor: pointer;">
                      <input type="text" id="gcTemplateSecondaryHex" value="#fbbf24" onchange="updateTemplateColorFromHex('secondary')" style="flex: 1; padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px;">
                    </div>
                  </div>
                </div>
                <label style="display: flex; align-items: center; gap: 8px; margin-top: 10px; font-size: 12px; cursor: pointer;">
                  <input type="checkbox" id="gcTemplateCustomColors" onchange="toggleTemplateCustomColors()">
                  Use custom colors
                </label>
              </div>
            </div>
            
            <!-- Editable Fields (dynamically populated) -->
            <div id="gcTemplateEditableFields">
              <!-- Fields populated based on template -->
            </div>
            
            <!-- Export Button -->
            <button onclick="exportFromTemplate()" class="gc-btn gc-btn-success" style="width: 100%; padding: 12px;">üíæ Export PNG</button>
          </div>
          
          <!-- Right Panel - Canvas Preview -->
          <div style="background: #e8e8e8; border-radius: 8px; padding: 20px; display: flex; justify-content: center; align-items: center; min-height: 500px;">
            <div style="background: #fff; border-radius: 4px; box-shadow: 0 4px 20px rgba(0,0,0,0.15); overflow: hidden;">
              <canvas id="gcTemplateCanvas"></canvas>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Save Template Modal -->
  <div class="modal-overlay" id="saveTemplateModal">
    <div class="modal" style="max-width: 450px;">
      <div class="modal-header">
        <h3>üìÇ Save as Template</h3>
        <button class="modal-close" onclick="closeSaveTemplateModal()">&times;</button>
      </div>
      <div class="modal-body" style="padding: 20px;">
        <div class="form-group" style="margin-bottom: 15px;">
          <label style="font-size: 13px; font-weight: 600; color: #555; display: block; margin-bottom: 6px;">Template Name *</label>
          <input type="text" id="gcTemplateName" placeholder="e.g., Game Day Post" style="width: 100%; padding: 10px 12px; border: 1px solid #ddd; border-radius: 5px; font-size: 14px;">
        </div>
        <div class="form-group">
          <label style="font-size: 13px; font-weight: 600; color: #555; display: block; margin-bottom: 6px;">Description</label>
          <textarea id="gcTemplateDescription" placeholder="Brief description of when to use this template..." style="width: 100%; padding: 10px 12px; border: 1px solid #ddd; border-radius: 5px; font-size: 14px; min-height: 80px; resize: vertical;"></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn-modal btn-modal-cancel" onclick="closeSaveTemplateModal()">Cancel</button>
        <button class="btn-modal btn-modal-select" onclick="saveTemplate()">Save Template</button>
      </div>
    </div>
  </div>
  
  <!-- Galleries Manager Panel -->
  <div class="panel" id="galleriesPanel" style="display: none;">
    <div class="toolbar" style="flex-wrap: wrap; gap: 10px; margin-bottom: 20px;">
      <h2 style="margin: 0; font-size: 18px; color: #333;">üì∑ Galleries</h2>
      <button class="btn-new" onclick="loadGalleryAlbums()" style="margin-left: auto;">
        <span>üìÑ</span> Refresh
      </button>
    </div>
    
    <!-- Sub-tabs for Gallery sections -->
    <div style="display: flex; gap: 5px; margin-bottom: 20px; border-bottom: 2px solid #eee; padding-bottom: 10px;">
      <button class="gallery-subtab active" onclick="showGallerySubTab('manager', this)" style="padding: 8px 16px; background: #f57c00; color: white; border: 1px solid #f57c00; border-radius: 5px 5px 0 0; cursor: pointer; font-size: 13px;">Gallery Manager</button>
      <button class="gallery-subtab" onclick="showGallerySubTab('teams', this)" style="padding: 8px 16px; background: none; color: #666; border: 1px solid #ddd; border-radius: 5px 5px 0 0; cursor: pointer; font-size: 13px;">Team Gallery Manager</button>
    </div>
    
    <!-- Gallery Manager Sub-panel (pin/hide) -->
    <div id="galleryManagerSubPanel">
      <p style="color: #666; font-size: 13px; margin-bottom: 15px;">Pin galleries to feature them at the top, or hide galleries from the public page.</p>
      
      <!-- Filters -->
      <div style="display: flex; gap: 15px; margin-bottom: 15px; flex-wrap: wrap; align-items: center;">
        <div style="display: flex; gap: 5px;">
          <button class="gm-filter-btn active" onclick="filterGalleryManager('all', this)" style="padding: 6px 14px; border: 1px solid #ddd; background: #f57c00; color: white; border-radius: 15px; font-size: 12px; cursor: pointer;">All</button>
          <button class="gm-filter-btn" onclick="filterGalleryManager('pinned', this)" style="padding: 6px 14px; border: 1px solid #ddd; background: #fff; border-radius: 15px; font-size: 12px; cursor: pointer;">üìå Pinned</button>
          <button class="gm-filter-btn" onclick="filterGalleryManager('hidden', this)" style="padding: 6px 14px; border: 1px solid #ddd; background: #fff; border-radius: 15px; font-size: 12px; cursor: pointer;">üëç¬Å¬çüó®Ô∏è Hidden</button>
        </div>
        <input type="text" id="galleryManagerSearch" placeholder="Search galleries..." oninput="searchGalleryManager(this.value)" style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 15px; font-size: 13px; width: 200px;">
        <span id="galleryManagerCount" style="margin-left: auto; font-size: 13px; color: #666;">0 galleries</span>
      </div>
      
      <!-- Gallery List -->
      <div id="galleryManagerList" style="border: 1px solid #eee; border-radius: 8px; overflow: hidden; max-height: 600px; overflow-y: auto;">
        <div style="display: grid; grid-template-columns: 80px 1fr 100px 80px 80px; padding: 10px 12px; background: #f5f5f5; font-weight: 600; font-size: 11px; text-transform: uppercase; color: #666; gap: 10px;">
          <div>Thumb</div>
          <div>Gallery</div>
          <div>Date</div>
          <div>Pinned</div>
          <div>Hidden</div>
        </div>
        <div id="galleryManagerListBody">
          <div class="loading">Loading galleries...</div>
        </div>
      </div>
    </div>
    
    <!-- Team Gallery Manager Sub-panel (original tagging) -->
    <div id="galleryTeamsSubPanel" style="display: none;">
      <p style="color: #666; font-size: 13px; margin-bottom: 15px;">Tag SmugMug galleries to teams for display on team pages.</p>
      
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px;">
        <!-- Left Panel: Album Browser -->
        <div style="background: #f9f9f9; border-radius: 8px; padding: 15px;">
          <h3 style="margin: 0 0 12px 0; font-size: 14px; color: #555;">SmugMug Albums</h3>
          <input type="text" id="galleryAlbumSearch" placeholder="Search albums..." oninput="filterGalleryAlbums(this.value)" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; font-size: 14px; margin-bottom: 12px;">
          <div id="galleryAlbumList" style="max-height: 550px; overflow-y: auto; border: 1px solid #eee; border-radius: 6px; background: #fff;">
            <div class="loading">Loading albums...</div>
          </div>
        </div>
        
        <!-- Right Panel: Team Tagging -->
        <div style="background: #f9f9f9; border-radius: 8px; padding: 15px;">
          <h3 style="margin: 0 0 12px 0; font-size: 14px; color: #555;">Tag to Teams</h3>
          <div id="galleryTagPanel">
            <div style="text-align: center; padding: 60px 20px; color: #999;">
              Select an album from the left to tag it to teams
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- ==================== VIDEO PANEL ==================== -->
  <div class="panel" id="videoPanel" style="display: none;">
    <div class="toolbar" style="flex-wrap: wrap; gap: 10px; margin-bottom: 20px;">
      <h2 style="margin: 0; font-size: 18px; color: #333;">üé¨ Video Manager</h2>
      <p style="margin: 0; color: #666; font-size: 13px; margin-left: 15px;">Manage YouTube videos and tag them to teams</p>
      <button class="btn-new" onclick="openAddVideoModal()" style="margin-left: auto;">
        <span>+</span> Add Video
      </button>
      <button class="btn-new" onclick="loadVideos()" style="background: #e3f2fd; color: #1565c0;">
        <span>üìÑ</span> Refresh
      </button>
    </div>
    
    <!-- Filters -->
    <div style="display: flex; gap: 15px; margin-bottom: 20px; flex-wrap: wrap; align-items: center;">
      <div style="display: flex; gap: 5px;">
        <button class="filter-btn active" onclick="filterVideos('all', this)" data-filter="all" style="padding: 8px 16px; border: 1px solid #ddd; background: #f57c00; color: white; border-radius: 20px; font-size: 13px; cursor: pointer;">All</button>
        <button class="filter-btn" onclick="filterVideos('pinned', this)" data-filter="pinned" style="padding: 8px 16px; border: 1px solid #ddd; background: #fff; border-radius: 20px; font-size: 13px; cursor: pointer;">üìå Pinned</button>
        <button class="filter-btn" onclick="filterVideos('hidden', this)" data-filter="hidden" style="padding: 8px 16px; border: 1px solid #ddd; background: #fff; border-radius: 20px; font-size: 13px; cursor: pointer;">üëç¬Å¬çüó®Ô∏è Hidden</button>
      </div>
      <input type="text" id="videoSearchInput" placeholder="Search videos..." oninput="searchVideos(this.value)" style="padding: 8px 15px; border: 1px solid #ddd; border-radius: 20px; font-size: 13px; width: 250px;">
      <span id="videoCountDisplay" style="margin-left: auto; font-size: 13px; color: #666;">0 videos</span>
    </div>
    
    <!-- Video List -->
    <div id="videoList" style="border: 1px solid #eee; border-radius: 8px; overflow: hidden;">
      <div style="display: grid; grid-template-columns: 120px 1fr 100px 80px 80px 120px; padding: 12px 15px; background: #f5f5f5; font-weight: 600; font-size: 12px; text-transform: uppercase; color: #666; gap: 10px;">
        <div>Thumbnail</div>
        <div>Title</div>
        <div>Published</div>
        <div>Pinned</div>
        <div>Hidden</div>
        <div>Actions</div>
      </div>
      <div id="videoListBody">
        <div class="loading">Loading videos...</div>
      </div>
    </div>
  </div>

  <!-- Add/Edit Video Modal -->
  <div class="modal-overlay" id="videoModal">
    <div class="modal" style="max-width: 700px;">
      <div class="modal-header">
        <h3 id="videoModalTitle">Add YouTube Video</h3>
        <button class="modal-close" onclick="closeVideoModal()">&times;</button>
      </div>
      <div class="modal-body" style="padding: 20px;">
        <input type="hidden" id="videoId">
        
        <!-- YouTube URL/ID Input -->
        <div class="form-group" style="margin-bottom: 20px;">
          <label style="font-size: 13px; font-weight: 600; color: #555; display: block; margin-bottom: 6px;">YouTube Video URL or ID</label>
          <div style="display: flex; gap: 10px;">
            <input type="text" id="videoYoutubeInput" placeholder="https://youtube.com/watch?v=... or video ID" style="flex: 1; padding: 10px 12px; border: 1px solid #ddd; border-radius: 5px; font-size: 14px;">
            <button onclick="fetchVideoDetails()" style="background: #ff0000; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-weight: 500;">Fetch Info</button>
          </div>
          <small style="font-size: 11px; color: #999;">Paste a YouTube URL or just the video ID (e.g., dQw4w9WgXcQ)</small>
        </div>
        
        <!-- Video Preview -->
        <div id="videoPreviewSection" style="display: none; margin-bottom: 20px; background: #f9f9f9; border-radius: 8px; padding: 15px;">
          <div style="display: flex; gap: 15px;">
            <img id="videoPreviewThumb" src="" style="width: 180px; height: 100px; object-fit: cover; border-radius: 6px; background: #333;">
            <div style="flex: 1;">
              <div id="videoPreviewTitle" style="font-weight: 600; margin-bottom: 5px;"></div>
              <div id="videoPreviewMeta" style="font-size: 12px; color: #666;"></div>
            </div>
          </div>
        </div>
        
        <!-- Manual Fields -->
        <div class="form-group" style="margin-bottom: 15px;">
          <label style="font-size: 13px; font-weight: 600; color: #555; display: block; margin-bottom: 6px;">Title</label>
          <input type="text" id="videoTitle" placeholder="Video title" style="width: 100%; padding: 10px 12px; border: 1px solid #ddd; border-radius: 5px; font-size: 14px;">
        </div>
        
        <div class="form-group" style="margin-bottom: 15px;">
          <label style="font-size: 13px; font-weight: 600; color: #555; display: block; margin-bottom: 6px;">Description</label>
          <textarea id="videoDescription" placeholder="Video description (optional)" rows="3" style="width: 100%; padding: 10px 12px; border: 1px solid #ddd; border-radius: 5px; font-size: 14px; font-family: inherit; resize: vertical;"></textarea>
        </div>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
          <div class="form-group">
            <label style="font-size: 13px; font-weight: 600; color: #555; display: block; margin-bottom: 6px;">Published Date</label>
            <input type="date" id="videoPublishedAt" style="width: 100%; padding: 10px 12px; border: 1px solid #ddd; border-radius: 5px; font-size: 14px;">
          </div>
          <div class="form-group">
            <label style="font-size: 13px; font-weight: 600; color: #555; display: block; margin-bottom: 6px;">Duration</label>
            <input type="text" id="videoDuration" placeholder="e.g., PT5M30S" style="width: 100%; padding: 10px 12px; border: 1px solid #ddd; border-radius: 5px; font-size: 14px;">
            <small style="font-size: 11px; color: #999;">ISO 8601 format (auto-filled from YouTube)</small>
          </div>
        </div>
        
        <!-- Team Tags -->
        <div class="form-group" style="margin-bottom: 15px;">
          <label style="font-size: 13px; font-weight: 600; color: #555; display: block; margin-bottom: 6px;">Team Tags</label>
          <div id="videoTeamTags" style="display: flex; flex-wrap: wrap; gap: 6px; padding: 10px; border: 1px solid #ddd; border-radius: 5px; min-height: 50px; background: #fafafa;">
            <!-- Tags will be added here -->
          </div>
          <div style="margin-top: 8px;">
            <select id="videoTeamSelect" onchange="addVideoTeamTag(this.value); this.value='';" style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 5px; font-size: 13px;">
              <option value="">+ Add team tag...</option>
            </select>
          </div>
        </div>
        
        <!-- Options -->
        <div style="display: flex; gap: 20px; padding: 15px; background: #f5f5f5; border-radius: 8px;">
          <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
            <input type="checkbox" id="videoPinned" style="width: 18px; height: 18px;">
            <span style="font-size: 13px;">üìå Pin to top</span>
          </label>
          <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
            <input type="checkbox" id="videoHidden" style="width: 18px; height: 18px;">
            <span style="font-size: 13px;">üëç¬Å¬çüó®Ô∏è Hidden</span>
          </label>
        </div>
      </div>
      <div class="modal-footer" style="display: flex; justify-content: space-between;">
        <button onclick="deleteVideo()" id="videoDeleteBtn" style="background: #ffebee; color: #c62828; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; display: none;">Delete</button>
        <div style="display: flex; gap: 10px; margin-left: auto;">
          <button class="btn-modal btn-modal-cancel" onclick="closeVideoModal()">Cancel</button>
          <button class="btn-modal btn-modal-select" onclick="saveVideo()">Save Video</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div class="toast" id="toast"></div>
  
  <!-- SmugMug Browser Modal -->
  <div class="modal-overlay" id="smugmugModal">
    <div class="modal">
      <div class="modal-header">
        <h3>üì∏ Select SmugMug Gallery</h3>
        <button class="modal-close" onclick="closeSmugMugBrowser()">&times;</button>
      </div>
      <div class="modal-search">
        <input type="text" id="albumSearch" placeholder="Search albums..." oninput="searchAlbums(this.value)">
      </div>
      <div class="modal-body">
        <div class="album-grid" id="albumGrid">
          <div class="loading">Loading albums...</div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn-modal btn-modal-cancel" onclick="closeSmugMugBrowser()">Cancel</button>
        <button class="btn-modal btn-modal-select" id="btnSelectAlbum" onclick="selectSmugMugAlbum()" disabled>Select Album</button>
      </div>
    </div>
  </div>

  <!-- Bonus Gallery Modal -->
  <div class="modal-overlay" id="bonusGalleryModal">
    <div class="modal">
      <div class="modal-header">
        <h3>üì∏ Select Bonus Gallery</h3>
        <button class="modal-close" onclick="closeBonusGalleryModal()">&times;</button>
      </div>
      <div class="modal-search">
        <input type="text" id="bonusAlbumSearch" placeholder="Search albums..." oninput="searchBonusAlbums(this.value)">
      </div>
      <div class="modal-body">
        <div class="album-grid" id="bonusAlbumGrid">
          <div class="loading">Loading albums...</div>
        </div>
      </div>
      <div style="padding: 15px 20px; border-top: 1px solid #eee;">
        <label style="display: block; font-size: 13px; font-weight: 500; margin-bottom: 6px;">Photographer</label>
        <select id="bonusGalleryPhotographerSelect" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; font-size: 14px;">
          <option value="">Select photographer...</option>
          <!-- Populated dynamically -->
        </select>
      </div>
      <div class="modal-footer">
        <button class="btn-modal btn-modal-cancel" onclick="closeBonusGalleryModal()">Cancel</button>
        <button class="btn-modal btn-modal-select" id="btnSelectBonusAlbum" onclick="selectBonusGalleryAlbum()" disabled>Select</button>
      </div>
    </div>
  </div>

  <!-- Featured Image Modal -->
  <div class="modal-overlay" id="featuredImageModal">
    <div class="modal image-modal">
      <div class="modal-header">
        <h3> Featured Image</h3>
        <button class="modal-close" onclick="closeFeaturedImageModal()">&times;</button>
      </div>
      <div class="modal-body" style="padding: 20px;">
        <!-- Upload Section -->
        <div class="form-group">
          <label>Upload Image</label>
          <div style="display: flex; gap: 10px; align-items: center;">
            <input type="file" id="featuredImageFile" accept="image/*" onchange="handleFeaturedImageUpload(this)" style="flex: 1;">
            <span id="featuredUploadStatus" style="font-size: 12px; color: #888;"></span>
          </div>
        </div>
        <div style="text-align: center; color: #999; font-size: 12px; margin: 10px 0;">- or -</div>
        <div class="form-group">
          <label>Image URL</label>
          <input type="text" id="featuredImageUrlInput" placeholder="https://...">
          <small>Paste URL from SmugMug or elsewhere</small>
        </div>
        <div class="form-group">
          <label>Caption (optional)</label>
          <input type="text" id="featuredImageCaptionInput" placeholder="Photo caption...">
        </div>
        <div id="featuredImagePreviewBox" style="margin-top: 15px; display: none;">
          <img id="featuredImagePreviewImg" style="width: 100%; max-height: 200px; object-fit: cover; border-radius: 6px;">
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn-modal btn-modal-cancel" onclick="closeFeaturedImageModal()">Cancel</button>
        <button class="btn-modal btn-modal-select" onclick="saveFeaturedImage()">Save</button>
      </div>
    </div>
  </div>

  <!-- Insert Image Modal -->
  <div class="modal-overlay" id="insertImageModal">
    <div class="modal image-modal">
      <div class="modal-header">
        <h3> Insert Image</h3>
        <button class="modal-close" onclick="closeInsertImageModal()">&times;</button>
      </div>
      <div class="modal-body" style="padding: 20px;">
        <!-- Upload Section -->
        <div class="form-group">
          <label>Upload Image</label>
          <div style="display: flex; gap: 10px; align-items: center;">
            <input type="file" id="insertImageFile" accept="image/*" onchange="handleInsertImageUpload(this)" style="flex: 1;">
            <span id="insertUploadStatus" style="font-size: 12px; color: #888;"></span>
          </div>
        </div>
        <div style="text-align: center; color: #999; font-size: 12px; margin: 10px 0;">- or -</div>
        <div class="form-group">
          <label>Image URL</label>
          <input type="text" id="insertImageUrl" placeholder="https://...">
        </div>
        <div class="form-group">
          <label>Caption (optional)</label>
          <input type="text" id="insertImageCaption" placeholder="Photo caption...">
        </div>
        <div class="form-group">
          <label>Link To (optional)</label>
          <input type="text" id="insertImageLink" placeholder="https://...">
          <label style="margin-top: 8px; display: flex; align-items: center; gap: 8px; font-weight: normal; cursor: pointer;">
            <input type="checkbox" id="insertImageNewWindow">
            <span>Open in new window</span>
          </label>
        </div>
        <div class="form-group">
          <label>Alignment</label>
          <div class="alignment-options">
            <label><input type="radio" name="imageAlign" value="left"><span>‚¨ÖÔ∏è¬è Left</span></label>
            <label><input type="radio" name="imageAlign" value="center" checked><span>‚Üê‚Äù¬è Center</span></label>
            <label><input type="radio" name="imageAlign" value="right"><span>‚û°Ô∏è¬è Right</span></label>
          </div>
        </div>
        <div class="form-group">
          <label>Size</label>
          <div class="size-options">
            <label><input type="radio" name="imageSize" value="small"><span>Small</span></label>
            <label><input type="radio" name="imageSize" value="medium" checked><span>Medium</span></label>
            <label><input type="radio" name="imageSize" value="full"><span>Full</span></label>
          </div>
        </div>
        <div id="insertImagePreviewBox" style="margin-top: 15px; display: none;">
          <img id="insertImagePreviewImg" style="max-width: 100%; max-height: 150px; border-radius: 6px;">
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn-modal btn-modal-cancel" onclick="closeInsertImageModal()">Cancel</button>
        <button class="btn-modal btn-modal-select" onclick="insertImageToEditor()">Insert</button>
      </div>
    </div>
  </div>

  <!-- Image Cropper Modal -->
  <div class="modal-overlay" id="cropperModal">
    <div class="modal cropper-modal-content">
      <div class="modal-header">
        <h3>‚úçÔ∏è‚Äö¬è Crop Image</h3>
        <button class="modal-close" onclick="closeCropperModal()">&times;</button>
      </div>
      <div class="modal-body" style="padding: 20px;">
        <div class="crop-aspect-buttons">
          <button onclick="setCropAspect(NaN)" class="active" id="aspectFree">Free</button>
          <button onclick="setCropAspect(16/9)" id="aspect169">16:9</button>
          <button onclick="setCropAspect(4/3)" id="aspect43">4:3</button>
          <button onclick="setCropAspect(1)" id="aspect11">1:1</button>
          <button onclick="setCropAspect(3/4)" id="aspect34">3:4</button>
          <button onclick="setCropAspect(9/16)" id="aspect916">9:16</button>
        </div>
        <div class="cropper-container-wrapper">
          <img id="cropperImage" src="" alt="Crop preview">
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn-modal btn-modal-cancel" onclick="closeCropperModal()">Cancel</button>
        <button class="btn-modal btn-modal-select" onclick="applyCrop()">Apply Crop</button>
      </div>
    </div>
  </div>

  <!-- Schedule Modal -->
  <div class="modal-overlay" id="scheduleModal">
    <div class="modal" style="max-width: 400px;">
      <div class="modal-header">
        <h3> Schedule Publication</h3>
        <button class="modal-close" onclick="closeScheduleModal()">&times;</button>
      </div>
      <div class="modal-body" style="padding: 20px;">
        <div class="form-group">
          <label style="font-weight: 600; margin-bottom: 8px; display: block;">Publish Date & Time</label>
          <input type="datetime-local" id="scheduledDateTime" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
        </div>
        <p style="font-size: 12px; color: #666; margin-top: 12px;">
          The article will be automatically published at the scheduled time.
        </p>
      </div>
      <div class="modal-footer">
        <button class="btn-modal btn-modal-cancel" onclick="clearSchedule()">Clear Schedule</button>
        <button class="btn-modal btn-modal-select" onclick="setSchedule()">Set Schedule</button>
      </div>
    </div>
  </div>

  <!-- Preview Modal -->
  <div class="modal-overlay" id="previewModal">
    <div class="modal" style="max-width: 1000px; max-height: 90vh;">
      <div class="modal-header">
        <h3>üëç¬Å Article Preview</h3>
        <button class="modal-close" onclick="closePreview()">&times;</button>
      </div>
      <div class="modal-body" style="padding: 0;">
        <div style="display: flex; height: calc(90vh - 120px);">
          <!-- Article Preview -->
          <div style="flex: 1; padding: 20px; overflow-y: auto; border-right: 1px solid #eee;">
            <h4 style="font-size: 12px; color: #888; margin-bottom: 15px; text-transform: uppercase;">Article</h4>
            <div id="previewFeaturedImage" style="display: none; margin-bottom: 20px;">
              <img id="previewFeaturedImg" src="" alt="Featured" style="width: 100%; aspect-ratio: 16/9; object-fit: cover; border-radius: 8px;">
              <p id="previewFeaturedCaption" style="font-size: 13px; color: #666; font-style: italic; margin-top: 8px; text-align: center;"></p>
            </div>
            <h1 id="previewHeadline" style="font-size: 24px; margin-bottom: 10px; line-height: 1.3;"></h1>
            <p id="previewExcerpt" style="font-size: 14px; color: #666; font-style: italic; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid #eee;"></p>
            <div id="previewContent" style="font-size: 15px; line-height: 1.7;"></div>
          </div>
          <!-- Social Preview -->
          <div style="width: 350px; padding: 20px; overflow-y: auto; background: #f9f9f9;">
            <h4 style="font-size: 12px; color: #888; margin-bottom: 15px; text-transform: uppercase;">Social Media Posts</h4>
            
            <div style="margin-bottom: 20px;">
              <div style="font-size: 12px; font-weight: 600; color: #1877f2; margin-bottom: 8px;">üîò Facebook</div>
              <div id="previewFacebook" style="background: #fff; padding: 12px; border-radius: 8px; font-size: 13px; line-height: 1.5; white-space: pre-wrap; border: 1px solid #ddd;"></div>
            </div>
            
            <div style="margin-bottom: 20px;">
              <div style="font-size: 12px; font-weight: 600; color: #e1306c; margin-bottom: 8px;">üì∏ Instagram</div>
              <div id="previewInstagram" style="background: #fff; padding: 12px; border-radius: 8px; font-size: 13px; line-height: 1.5; white-space: pre-wrap; border: 1px solid #ddd;"></div>
            </div>
            
            <div style="margin-bottom: 20px;">
              <div style="font-size: 12px; font-weight: 600; color: #000; margin-bottom: 8px;">ùïè Twitter</div>
              <div id="previewTwitter" style="background: #fff; padding: 12px; border-radius: 8px; font-size: 13px; line-height: 1.5; white-space: pre-wrap; border: 1px solid #ddd;"></div>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn-modal btn-modal-cancel" onclick="closePreview()">Close</button>
        <button class="btn-modal btn-modal-select" onclick="closePreview(); publishArticle();">Publish Now</button>
      </div>
    </div>
  </div>

  <!-- Settings Panel -->
  <div class="panel" id="settingsPanel" style="display: none;">
    <div style="max-width: 800px; margin: 0 auto; padding: 20px;">
      <h2 style="margin-bottom: 30px; color: #333;">Site Settings</h2>
      
      <!-- Ticker Settings -->
      <div style="background: #fff; border-radius: 10px; padding: 25px; margin-bottom: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.08);">
        <h3 style="margin: 0 0 20px; font-size: 18px; color: #333; border-bottom: 2px solid #f57c00; padding-bottom: 10px;">
          üìä Scores Ticker
        </h3>
        
        <div style="margin-bottom: 20px;">
          <label style="font-weight: 600; color: #555; display: block; margin-bottom: 10px;">Mode</label>
          <div style="display: flex; gap: 15px;">
            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
              <input type="radio" name="tickerMode" value="auto" id="tickerModeAuto" checked onchange="updateTickerMode()">
              <span>Auto (Yesterday + Today)</span>
            </label>
            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
              <input type="radio" name="tickerMode" value="manual" id="tickerModeManual" onchange="updateTickerMode()">
              <span>Manual</span>
            </label>
          </div>
        </div>
        
        <div id="tickerManualOptions" style="display: none; background: #f9f9f9; padding: 15px; border-radius: 8px; margin-top: 15px;">
          <label style="font-weight: 600; color: #555; display: block; margin-bottom: 10px;">Show games from:</label>
          <div style="display: flex; gap: 20px; flex-wrap: wrap;">
            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
              <input type="checkbox" id="tickerShowYesterday" checked onchange="saveTickerSettings()">
              <span>Yesterday</span>
            </label>
            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
              <input type="checkbox" id="tickerShowToday" checked onchange="saveTickerSettings()">
              <span>Today</span>
            </label>
            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
              <input type="checkbox" id="tickerShowTomorrow" onchange="saveTickerSettings()">
              <span>Tomorrow</span>
            </label>
          </div>
          <p style="margin-top: 10px; font-size: 12px; color: #888;">
            Past dates show only completed games (finals). Today and tomorrow show all games.
          </p>
        </div>
        
        <div style="margin-top: 20px;">
          <button onclick="saveTickerSettings()" style="background: #f57c00; color: white; border: none; padding: 10px 25px; border-radius: 5px; cursor: pointer; font-weight: 600;">
            Save Ticker Settings
          </button>
          <span id="tickerSaveStatus" style="margin-left: 15px; color: #4caf50; display: none;">‚úì Saved!</span>
        </div>
      </div>
      
      <!-- Future settings sections can go here -->
      <div style="background: #f5f5f5; border-radius: 10px; padding: 25px; color: #888; text-align: center;">
        <p>More settings coming soon...</p>
      </div>
      
    </div>
  </div>
  
  <!-- Championships Panel -->
  <div class="panel" id="championshipsPanel" style="display: none;">
    <div class="toolbar" style="flex-wrap: wrap; gap: 10px;">
      <button class="btn-new" onclick="openChampionshipModal()">
        <span>+</span> Add Championship
      </button>
      <div style="margin-left: auto; display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
        <select id="champGenderFilter" onchange="filterChampionships()" style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 5px; font-size: 13px;">
          <option value="">All Genders</option>
          <option value="Boys">Boys</option>
          <option value="Girls">Girls</option>
        </select>
        <select id="champDivisionFilter" onchange="filterChampionships()" style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 5px; font-size: 13px;">
          <option value="">All Divisions</option>
        </select>
        <input type="number" id="champYearFilter" placeholder="Year" oninput="filterChampionships()" style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 5px; font-size: 13px; width: 80px;">
        <input type="text" id="champSearchBox" placeholder="Search teams..." oninput="filterChampionships()" style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 5px; font-size: 13px; width: 150px;">
      </div>
    </div>
    
    <div style="margin-bottom: 15px; padding: 10px 15px; background: #f0f7ff; border-radius: 6px; display: flex; justify-content: space-between; align-items: center;">
      <span id="champCount" style="font-size: 13px; color: #1565c0;">Loading...</span>
      <div style="display: flex; gap: 10px;">
        <input type="file" id="champImportFile" accept=".csv" onchange="importChampionships(this)" style="display: none;">
        <button onclick="document.getElementById('champImportFile').click()" style="padding: 6px 12px; background: #fff3e0; color: #e65100; border: none; border-radius: 4px; font-size: 12px; cursor: pointer;">Import CSV</button>
        <button onclick="exportChampionships()" style="padding: 6px 12px; background: #e8f5e9; color: #2e7d32; border: none; border-radius: 4px; font-size: 12px; cursor: pointer;">Export CSV</button>
      </div>
    </div>
    
    <div class="article-list" id="championshipList" style="margin-top: 15px;">
      <div class="article-row header" style="grid-template-columns: 60px 100px 150px 1fr 1fr 80px 100px;">
        <div class="sortable" onclick="sortChampionships('year')" style="cursor: pointer;">Year ‚Üï</div>
        <div>Gender</div>
        <div>Division</div>
        <div>Champion</div>
        <div>Runner-Up</div>
        <div>Score</div>
        <div>Actions</div>
      </div>
      <div class="loading">Loading championships...</div>
    </div>
  </div>
  
  <!-- Championship Modal -->
  <div id="championshipModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center;">
    <div style="background: white; padding: 30px; border-radius: 12px; max-width: 550px; width: 90%; max-height: 90vh; overflow-y: auto;">
      <h2 style="margin-top: 0; margin-bottom: 20px;" id="championshipModalTitle">Add Championship</h2>
      <input type="hidden" id="championshipId">
      
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
        <div class="form-group">
          <label>Year *</label>
          <input type="number" id="champYear" placeholder="2024" min="1900" max="2100" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
        </div>
        <div class="form-group">
          <label>Gender *</label>
          <select id="champGender" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
            <option value="Boys">Boys</option>
            <option value="Girls">Girls</option>
          </select>
        </div>
      </div>
      
      <div class="form-group" style="margin-bottom: 15px;">
        <label>Division *</label>
        <select id="champDivision" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
          <option value="Division I">Division I</option>
          <option value="Division II">Division II</option>
          <option value="Division III">Division III</option>
          <option value="Division IV">Division IV</option>
          <option value="Class L">Class L</option>
          <option value="Class I">Class I</option>
          <option value="Class M">Class M</option>
          <option value="Class S">Class S</option>
        </select>
      </div>
      
      <div class="form-group" style="margin-bottom: 15px;">
        <label>Champion *</label>
        <input type="text" id="champChampion" placeholder="Winning school name..." style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
      </div>
      
      <div class="form-group" style="margin-bottom: 15px;">
        <label>Runner-Up *</label>
        <input type="text" id="champRunnerUp" placeholder="Losing school name..." style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
      </div>
      
      <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin-bottom: 15px;">
        <div class="form-group">
          <label>Champion Score</label>
          <input type="number" id="champChampionScore" placeholder="0" min="0" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
        </div>
        <div class="form-group">
          <label>Runner-Up Score</label>
          <input type="number" id="champRunnerUpScore" placeholder="0" min="0" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
        </div>
        <div class="form-group">
          <label>Overtime?</label>
          <select id="champOvertime" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
            <option value="false">No</option>
            <option value="true">Yes (OT)</option>
          </select>
        </div>
      </div>
      
      <div class="form-group" style="margin-bottom: 20px;">
        <label>Notes</label>
        <textarea id="champNotes" rows="2" placeholder="Optional notes about this championship..." style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; font-family: inherit;"></textarea>
      </div>
      
      <div style="display: flex; justify-content: space-between; padding-top: 15px; border-top: 1px solid #eee;">
        <button id="championshipDeleteBtn" onclick="deleteChampionship()" style="padding: 10px 20px; background: #ffebee; color: #c62828; border: none; border-radius: 5px; cursor: pointer; display: none;">Delete</button>
        <div style="display: flex; gap: 10px; margin-left: auto;">
          <button onclick="closeChampionshipModal()" style="padding: 10px 20px; background: #f5f5f5; border: 1px solid #ddd; border-radius: 5px; cursor: pointer;">Cancel</button>
          <button onclick="saveChampionship()" style="padding: 10px 20px; background: #f57c00; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: 500;">Save</button>
        </div>
      </div>
    </div>
  </div>

  <!-- 1K Scorers Panel -->
  <div class="panel" id="scorers1kPanel" style="display: none;">
    <div class="toolbar" style="flex-wrap: wrap; gap: 10px;">
      <button class="btn-new" onclick="openScorer1KModal()">
        <span>+</span> Add Scorer
      </button>
      <div style="margin-left: auto; display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
        <select id="scorer1kSchoolFilter" onchange="filterScorers1K()" style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 5px; font-size: 13px;">
          <option value="">All Schools</option>
        </select>
        <select id="scorer1kGenderFilter" onchange="filterScorers1K()" style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 5px; font-size: 13px;">
          <option value="">All Genders</option>
          <option value="Boys">Boys</option>
          <option value="Girls">Girls</option>
        </select>
        <select id="scorer1kPointsFilter" onchange="filterScorers1K()" style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 5px; font-size: 13px;">
          <option value="">All Point Totals</option>
          <option value="2000">2,000+ Club</option>
          <option value="1500">1,500+</option>
          <option value="known">Known Totals Only</option>
        </select>
        <input type="text" id="scorer1kSearchBox" placeholder="Search name or school..." oninput="filterScorers1K()" style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 5px; font-size: 13px; width: 180px;">
      </div>
    </div>
    
    <div style="margin-bottom: 15px; padding: 10px 15px; background: #fff3e0; border-radius: 6px; display: flex; justify-content: space-between; align-items: center;">
      <span id="scorer1kCount" style="font-size: 13px; color: #e65100;">Loading...</span>
      <div style="display: flex; gap: 10px;">
        <input type="file" id="scorer1kImportFile" accept=".csv" onchange="importScorers1K(this)" style="display: none;">
        <button onclick="document.getElementById('scorer1kImportFile').click()" style="padding: 6px 12px; background: #fff3e0; color: #e65100; border: none; border-radius: 4px; font-size: 12px; cursor: pointer;">Import CSV</button>
        <button onclick="exportScorers1K()" style="padding: 6px 12px; background: #e8f5e9; color: #2e7d32; border: none; border-radius: 4px; font-size: 12px; cursor: pointer;">Export CSV</button>
      </div>
    </div>
    
    <div class="article-list" id="scorers1kList" style="margin-top: 15px; max-height: 600px; overflow-y: auto;">
      <div class="article-row header" style="grid-template-columns: 1fr 180px 80px 80px 80px 100px;">
        <div>Name</div>
        <div>School</div>
        <div>Gender</div>
        <div>Points</div>
        <div>Class</div>
        <div>Actions</div>
      </div>
      <div class="loading">Loading scorers...</div>
    </div>
  </div>
  
  <!-- 1K Scorer Modal -->
  <div id="scorer1kModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center;">
    <div style="background: white; padding: 30px; border-radius: 12px; max-width: 500px; width: 90%; max-height: 90vh; overflow-y: auto;">
      <h2 style="margin-top: 0; margin-bottom: 20px;" id="scorer1kModalTitle">Add 1K Scorer</h2>
      <input type="hidden" id="scorer1kId">
      
      <div class="form-group" style="margin-bottom: 15px;">
        <label>Player Name *</label>
        <input type="text" id="scorer1kName" placeholder="Full name..." style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
      </div>
      
      <div class="form-group" style="margin-bottom: 15px;">
        <label>School *</label>
        <input type="text" id="scorer1kSchool" placeholder="High school name..." style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;" list="schoolsList">
        <datalist id="schoolsList"></datalist>
      </div>
      
      <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin-bottom: 15px;">
        <div class="form-group">
          <label>Gender</label>
          <select id="scorer1kGender" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
            <option value="">Unknown</option>
            <option value="Boys">Boys</option>
            <option value="Girls">Girls</option>
          </select>
        </div>
        <div class="form-group">
          <label>Career Points</label>
          <input type="number" id="scorer1kPoints" placeholder="1000+" min="1000" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
        </div>
        <div class="form-group">
          <label>Grad Year</label>
          <input type="number" id="scorer1kGradYear" placeholder="2024" min="1950" max="2100" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
        </div>
      </div>
      
      <div class="form-group" style="margin-bottom: 15px;">
        <label>Notes</label>
        <textarea id="scorer1kNotes" rows="2" placeholder="Optional notes (records, achievements, etc.)..." style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; font-family: inherit;"></textarea>
      </div>
      
      <div style="margin-bottom: 20px;">
        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
          <input type="checkbox" id="scorer1kVerified" style="width: 18px; height: 18px;">
          <span>Verified (confirmed with school/records)</span>
        </label>
      </div>
      
      <div style="display: flex; justify-content: space-between; padding-top: 15px; border-top: 1px solid #eee;">
        <button id="scorer1kDeleteBtn" onclick="deleteScorer1K()" style="padding: 10px 20px; background: #ffebee; color: #c62828; border: none; border-radius: 5px; cursor: pointer; display: none;">Delete</button>
        <div style="display: flex; gap: 10px; margin-left: auto;">
          <button onclick="closeScorer1KModal()" style="padding: 10px 20px; background: #f5f5f5; border: 1px solid #ddd; border-radius: 5px; cursor: pointer;">Cancel</button>
          <button onclick="saveScorer1K()" style="padding: 10px 20px; background: #f57c00; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: 500;">Save</button>
        </div>
      </div>
    </div>
  </div>

  <!-- NCAA Players Panel -->
  <div class="panel" id="ncaaplayersPanel" style="display: none;">
    <div class="toolbar" style="flex-wrap: wrap; gap: 10px;">
      <button class="btn-new" onclick="openNCAAPlayerModal()">
        <span>+</span> Add Player
      </button>
      <div style="margin-left: auto; display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
        <select id="ncaaCollegeFilter" onchange="filterNCAAPlayers()" style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 5px; font-size: 13px;">
          <option value="">All Colleges</option>
        </select>
        <select id="ncaaGenderFilter" onchange="filterNCAAPlayers()" style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 5px; font-size: 13px;">
          <option value="">All Genders</option>
          <option value="Boys">Boys</option>
          <option value="Girls">Girls</option>
        </select>
        <select id="ncaaDivisionFilter" onchange="filterNCAAPlayers()" style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 5px; font-size: 13px;">
          <option value="">All Divisions</option>
          <option value="D1">D1</option>
          <option value="D2">D2</option>
          <option value="D3">D3</option>
          <option value="JUCO">JUCO</option>
        </select>
        <select id="ncaaActiveFilter" onchange="filterNCAAPlayers()" style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 5px; font-size: 13px;">
          <option value="true">Active Only</option>
          <option value="">All Players</option>
          <option value="false">Inactive Only</option>
        </select>
        <input type="text" id="ncaaSearchBox" placeholder="Search name, school, college..." oninput="filterNCAAPlayers()" style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 5px; font-size: 13px; width: 200px;">
      </div>
    </div>
    
    <div style="margin-bottom: 15px; padding: 10px 15px; background: #e8f5e9; border-radius: 6px; display: flex; justify-content: space-between; align-items: center;">
      <span id="ncaaCount" style="font-size: 13px; color: #2e7d32;">Loading...</span>
      <div style="display: flex; gap: 10px;">
        <input type="file" id="ncaaImportFile" accept=".csv" onchange="importNCAAPlayers(this)" style="display: none;">
        <button onclick="document.getElementById('ncaaImportFile').click()" style="padding: 6px 12px; background: #fff3e0; color: #e65100; border: none; border-radius: 4px; font-size: 12px; cursor: pointer;">Import CSV</button>
        <button onclick="exportNCAAPlayers()" style="padding: 6px 12px; background: #e3f2fd; color: #1565c0; border: none; border-radius: 4px; font-size: 12px; cursor: pointer;">Export CSV</button>
      </div>
    </div>
    
    <div class="article-list" id="ncaaPlayersList" style="margin-top: 15px; max-height: 600px; overflow-y: auto;">
      <div class="article-row header" style="grid-template-columns: 1fr 180px 180px 60px 60px 100px;">
        <div>Name</div>
        <div>High School</div>
        <div>College</div>
        <div>Gender</div>
        <div>Div</div>
        <div>Actions</div>
      </div>
      <div class="loading">Loading players...</div>
    </div>
  </div>
  
  <!-- NCAA Player Modal -->
  <div id="ncaaPlayerModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center;">
    <div style="background: white; padding: 30px; border-radius: 12px; max-width: 500px; width: 90%; max-height: 90vh; overflow-y: auto;">
      <h2 style="margin-top: 0; margin-bottom: 20px;" id="ncaaPlayerModalTitle">Add NCAA Player</h2>
      <input type="hidden" id="ncaaPlayerId">
      
      <div class="form-group" style="margin-bottom: 15px;">
        <label>Player Name *</label>
        <input type="text" id="ncaaPlayerName" placeholder="Full name..." style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
      </div>
      
      <div class="form-group" style="margin-bottom: 15px;">
        <label>High School *</label>
        <input type="text" id="ncaaPlayerHighSchool" placeholder="NH high school..." style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
      </div>
      
      <div class="form-group" style="margin-bottom: 15px;">
        <label>College *</label>
        <input type="text" id="ncaaPlayerCollege" placeholder="Current college..." style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;" list="collegesList">
        <datalist id="collegesList"></datalist>
      </div>
      
      <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin-bottom: 15px;">
        <div class="form-group">
          <label>Gender</label>
          <select id="ncaaPlayerGender" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
            <option value="">Unknown</option>
            <option value="Boys">Boys</option>
            <option value="Girls">Girls</option>
          </select>
        </div>
        <div class="form-group">
          <label>Division</label>
          <select id="ncaaPlayerDivision" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
            <option value="">Unknown</option>
            <option value="D1">D1</option>
            <option value="D2">D2</option>
            <option value="D3">D3</option>
            <option value="JUCO">JUCO</option>
            <option value="NAIA">NAIA</option>
          </select>
        </div>
        <div class="form-group">
          <label>HS Grad Year</label>
          <input type="number" id="ncaaPlayerGradYear" placeholder="2024" min="2000" max="2100" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
        </div>
      </div>
      
      <div class="form-group" style="margin-bottom: 15px;">
        <label>Position</label>
        <input type="text" id="ncaaPlayerPosition" placeholder="G, F, C..." style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
      </div>
      
      <div class="form-group" style="margin-bottom: 15px;">
        <label>Notes</label>
        <textarea id="ncaaPlayerNotes" rows="2" placeholder="Optional notes..." style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; font-family: inherit;"></textarea>
      </div>
      
      <div style="margin-bottom: 20px;">
        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
          <input type="checkbox" id="ncaaPlayerActive" checked style="width: 18px; height: 18px;">
          <span>Currently Active (still playing in college)</span>
        </label>
      </div>
      
      <div style="display: flex; justify-content: space-between; padding-top: 15px; border-top: 1px solid #eee;">
        <button id="ncaaPlayerDeleteBtn" onclick="deleteNCAAPlayer()" style="padding: 10px 20px; background: #ffebee; color: #c62828; border: none; border-radius: 5px; cursor: pointer; display: none;">Delete</button>
        <div style="display: flex; gap: 10px; margin-left: auto;">
          <button onclick="closeNCAAPlayerModal()" style="padding: 10px 20px; background: #f5f5f5; border: 1px solid #ddd; border-radius: 5px; cursor: pointer;">Cancel</button>
          <button onclick="saveNCAAPlayer()" style="padding: 10px 20px; background: #f57c00; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: 500;">Save</button>
        </div>
      </div>
    </div>
  </div>

  <script src="rosters_data.js"></script>
  <script>
    // Supabase config
    const SUPABASE_URL = 'https://suncdkxfqkwwnmhosxcf.supabase.co';
    const SUPABASE_ANON_KEY = 'sb_publishable_hHSpgZPD327r11GaQG9iHw_uZbuaWmF';
    const db = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    
    // CMS Password
    const CMS_PASSWORD = 'Gr@niteSt@teHoops';
    
    // State
    let articles = [];
    let games = [];
    let currentArticle = null;
    let selectedGame = null;
    
    // Game data for articles (quarter scores, player stats)
    let currentGameData = null;
    
    // Generated social posts (populated by story generators)
    let generatedSocialPosts = {
      facebookPost: null,
      instagramPost: null,
      twitterPost: null
    };
    
    // Quill Editor
    let quillEditor = null;
    
    function initQuillEditor() {
      if (quillEditor) return; // Already initialized
      
      // Custom image insert button handler
      const insertImageHandler = function() {
        openInsertImageModal();
      };
      
      quillEditor = new Quill('#articleContent', {
        theme: 'snow',
        modules: {
          toolbar: {
            container: '#quillToolbar',
            handlers: {
              'insertImage': insertImageHandler
            }
          }
        },
        placeholder: 'Write your article...'
      });
      
      // Add custom button styling
      const insertBtn = document.querySelector('.ql-insertImage');
      if (insertBtn) {
        insertBtn.innerHTML = 'üñºÔ∏è¬è';
        insertBtn.style.width = 'auto';
        insertBtn.style.padding = '0 8px';
      }
    }
    
    // Featured Image Functions
    // Featured image drag/drop handlers
    function handleDragOver(event) {
      event.preventDefault();
      event.stopPropagation();
      event.currentTarget.classList.add('drag-over');
    }
    
    function handleDragLeave(event) {
      event.preventDefault();
      event.stopPropagation();
      event.currentTarget.classList.remove('drag-over');
    }
    
    function handleFeaturedImageDrop(event) {
      event.preventDefault();
      event.stopPropagation();
      event.currentTarget.classList.remove('drag-over');
      
      const files = event.dataTransfer.files;
      if (files.length > 0 && files[0].type.startsWith('image/')) {
        openFeaturedImageCropper(files[0]);
      }
    }
    
    function handleFeaturedImageSelect(input) {
      if (input.files && input.files[0]) {
        openFeaturedImageCropper(input.files[0]);
      }
    }
    
    function openFeaturedImageCropper(file) {
      currentCropFile = file;
      currentCropFolder = 'articles';
      currentCropStatusEl = { textContent: '', style: {} }; // Dummy status element
      currentCropUrlInput = 'featuredImageUrl';
      currentCropPreviewImg = 'featuredImageImg';
      currentCropPreviewBox = 'featuredImagePreview';
      currentCropIsFeatured = true;
      
      const imageUrl = URL.createObjectURL(file);
      const cropperImage = document.getElementById('cropperImage');
      cropperImage.src = imageUrl;
      
      if (cropper) {
        cropper.destroy();
        cropper = null;
      }
      
      document.getElementById('cropperModal').classList.add('open');
      
      cropperImage.onload = function() {
        cropper = new Cropper(cropperImage, {
          viewMode: 2,
          autoCropArea: 1,
          responsive: true,
          background: false,
          aspectRatio: 16/9 // Force 16:9 for featured images
        });
      };
      
      // Set 16:9 button as active
      document.querySelectorAll('.crop-aspect-buttons button').forEach(b => b.classList.remove('active'));
      document.getElementById('aspect169').classList.add('active');
    }
    
    let currentCropIsFeatured = false;
    
    function removeFeaturedImage() {
      document.getElementById('featuredImageUrl').value = '';
      document.getElementById('featuredImageCaptionField').value = '';
      document.getElementById('featuredImageContainer').classList.remove('has-image');
      document.getElementById('featuredImagePlaceholder').style.display = 'block';
      document.getElementById('featuredImagePreview').style.display = 'none';
      document.getElementById('featuredImageFileInput').value = '';
    }
    
    // Inline Image Insert Functions
    function openInsertImageModal() {
      document.getElementById('insertImageUrl').value = '';
      document.getElementById('insertImageCaption').value = '';
      document.getElementById('insertImageLink').value = '';
      document.getElementById('insertImageNewWindow').checked = false;
      document.querySelector('input[name="imageAlign"][value="center"]').checked = true;
      document.querySelector('input[name="imageSize"][value="medium"]').checked = true;
      document.getElementById('insertImagePreviewBox').style.display = 'none';
      document.getElementById('insertImageFile').value = ''; // Reset file input
      document.getElementById('insertUploadStatus').textContent = ''; // Reset status
      
      document.getElementById('insertImageModal').classList.add('open');
      
      // Preview on URL input
      document.getElementById('insertImageUrl').oninput = function() {
        const url = this.value.trim();
        if (url) {
          document.getElementById('insertImagePreviewImg').src = url;
          document.getElementById('insertImagePreviewBox').style.display = 'block';
        } else {
          document.getElementById('insertImagePreviewBox').style.display = 'none';
        }
      };
    }
    
    function closeInsertImageModal() {
      document.getElementById('insertImageModal').classList.remove('open');
    }
    
    function insertImageToEditor() {
      const url = document.getElementById('insertImageUrl').value.trim();
      if (!url) {
        showToast('Please enter an image URL', 'error');
        return;
      }
      
      const caption = document.getElementById('insertImageCaption').value.trim();
      const link = document.getElementById('insertImageLink').value.trim();
      const newWindow = document.getElementById('insertImageNewWindow').checked;
      const align = document.querySelector('input[name="imageAlign"]:checked').value;
      const size = document.querySelector('input[name="imageSize"]:checked').value;
      
      // Build the HTML for the image block
      let imgHtml = `<img src="${url}" alt="${caption || 'Article image'}">`;
      
      if (link) {
        const target = newWindow ? ' target="_blank" rel="noopener"' : '';
        imgHtml = `<a href="${link}"${target}>${imgHtml}</a>`;
      }
      
      let captionHtml = caption ? `<div class="caption">${caption}</div>` : '';
      
      const imageBlock = `<div class="article-image align-${align} size-${size}" contenteditable="false">${imgHtml}${captionHtml}</div><p><br></p>`;
      
      // Insert at cursor position in Quill
      const range = quillEditor.getSelection(true);
      quillEditor.clipboard.dangerouslyPasteHTML(range.index, imageBlock);
      
      closeInsertImageModal();
      showToast('Image inserted!', 'success');
    }
    
    // Helper to get Quill content as HTML
    function getEditorContent() {
      if (quillEditor) {
        return quillEditor.root.innerHTML;
      }
      return '';
    }
    
    // Helper to set Quill content from HTML
    function setEditorContent(html) {
      if (quillEditor) {
        if (html) {
          quillEditor.root.innerHTML = html;
        } else {
          quillEditor.setText('');
        }
      }
    }
    
    // Helper to get plain text from Quill (for excerpts, social posts)
    function getEditorPlainText() {
      if (quillEditor) {
        return quillEditor.getText().trim();
      }
      return '';
    }
    
    // Author "Other" toggle
    function toggleOtherAuthor() {
      const select = document.getElementById('articleAuthor');
      const otherInput = document.getElementById('articleAuthorOther');
      
      if (select.value === 'other') {
        otherInput.style.display = 'block';
        otherInput.focus();
      } else {
        otherInput.style.display = 'none';
        otherInput.value = '';
      }
    }
    
    // Get the actual author value (handles "other" option)
    function getAuthorValue() {
      const select = document.getElementById('articleAuthor');
      if (select.value === 'other') {
        return document.getElementById('articleAuthorOther').value.trim() || 'Guest Contributor';
      }
      return select.value;
    }
    
    // Set author value (handles custom names)
    function setAuthorValue(author) {
      const select = document.getElementById('articleAuthor');
      const otherInput = document.getElementById('articleAuthorOther');
      
      // Check if author matches one of the preset options
      const options = Array.from(select.options).map(o => o.value);
      if (options.includes(author) && author !== 'other') {
        select.value = author;
        otherInput.style.display = 'none';
        otherInput.value = '';
      } else {
        // Custom author - select "other" and fill in the name
        select.value = 'other';
        otherInput.style.display = 'block';
        otherInput.value = author || '';
      }
    }
    
    // Photographer "Other" toggle
    function toggleOtherPhotographer() {
      const select = document.getElementById('articlePhotographer');
      const otherInput = document.getElementById('articlePhotographerOther');
      
      if (select.value === 'other') {
        otherInput.style.display = 'block';
        otherInput.focus();
      } else {
        otherInput.style.display = 'none';
        otherInput.value = '';
      }
    }
    
    // Get the actual photographer value (handles "other" option)
    function getPhotographerValue() {
      const select = document.getElementById('articlePhotographer');
      if (!select) return '';
      if (select.value === 'other') {
        return document.getElementById('articlePhotographerOther').value.trim() || '';
      }
      return select.value || '';
    }
    
    // Set photographer value (handles custom names)
    function setPhotographerValue(photographer) {
      const select = document.getElementById('articlePhotographer');
      const otherInput = document.getElementById('articlePhotographerOther');
      
      if (!select || !otherInput) return;
      
      if (!photographer) {
        select.value = '';
        otherInput.style.display = 'none';
        otherInput.value = '';
        return;
      }
      
      // Check if photographer matches one of the preset options
      const options = Array.from(select.options).map(o => o.value);
      if (options.includes(photographer) && photographer !== 'other') {
        select.value = photographer;
        otherInput.style.display = 'none';
        otherInput.value = '';
      } else {
        // Custom photographer - select "other" and fill in the name
        select.value = 'other';
        otherInput.style.display = 'block';
        otherInput.value = photographer || '';
      }
    }
    
    // Populate photographer dropdown from contributors
    async function populatePhotographerDropdown() {
      const select = document.getElementById('articlePhotographer');
      if (!select) return;
      
      // Always start with None option
      select.innerHTML = '<option value="">None</option>';
      
      // Try to load photographers from contributors table
      try {
        const { data: photographers, error } = await db
          .from('contributors')
          .select('name')
          .eq('is_photographer', true)
          .eq('active', true)
          .order('name');
        
        if (!error && photographers && photographers.length > 0) {
          // Add photographers from database
          photographers.forEach(p => {
            if (p.name) {
              const option = document.createElement('option');
              option.value = p.name;
              option.textContent = p.name;
              select.appendChild(option);
            }
          });
        }
      } catch (err) {
        console.error('Error loading photographers:', err);
      }
      
      // Always add "Other..." option at the end
      const otherOption = document.createElement('option');
      otherOption.value = 'other';
      otherOption.textContent = 'Other...';
      select.appendChild(otherOption);
    }
    
    // Image Upload to Supabase Storage
    async function uploadImageToSupabase(file, folder = 'articles') {
      const timestamp = Date.now();
      const safeName = file.name.replace(/[^a-zA-Z0-9.-]/g, '_');
      const filePath = `${folder}/${timestamp}-${safeName}`;
      
      const { data, error } = await db.storage
        .from('images')
        .upload(filePath, file, {
          cacheControl: '3600',
          upsert: false
        });
      
      if (error) {
        console.error('Upload error:', error);
        throw error;
      }
      
      // Get public URL
      const { data: urlData } = db.storage
        .from('images')
        .getPublicUrl(filePath);
      
      return urlData.publicUrl;
    }
    
    // Featured Image Upload Handler
    // Cropper state
    let cropper = null;
    let cropperCallback = null;
    let currentCropFile = null;
    let currentCropFolder = 'articles';
    let currentCropStatusEl = null;
    let currentCropUrlInput = null;
    let currentCropPreviewImg = null;
    let currentCropPreviewBox = null;
    
    function openCropperModal(file, folder, statusEl, urlInput, previewImg, previewBox) {
      currentCropFile = file;
      currentCropFolder = folder;
      currentCropStatusEl = statusEl;
      currentCropUrlInput = urlInput;
      currentCropPreviewImg = previewImg;
      currentCropPreviewBox = previewBox;
      
      // Create object URL for the image
      const imageUrl = URL.createObjectURL(file);
      const cropperImage = document.getElementById('cropperImage');
      cropperImage.src = imageUrl;
      
      // Destroy existing cropper if any
      if (cropper) {
        cropper.destroy();
        cropper = null;
      }
      
      document.getElementById('cropperModal').classList.add('open');
      
      // Initialize cropper after image loads
      cropperImage.onload = function() {
        cropper = new Cropper(cropperImage, {
          viewMode: 2,
          autoCropArea: 1,
          responsive: true,
          background: false
        });
      };
      
      // Reset aspect buttons
      document.querySelectorAll('.crop-aspect-buttons button').forEach(b => b.classList.remove('active'));
      document.getElementById('aspectFree').classList.add('active');
    }
    
    function closeCropperModal() {
      document.getElementById('cropperModal').classList.remove('open');
      if (cropper) {
        cropper.destroy();
        cropper = null;
      }
      // Revoke object URL
      const cropperImage = document.getElementById('cropperImage');
      if (cropperImage.src.startsWith('blob:')) {
        URL.revokeObjectURL(cropperImage.src);
      }
    }
    
    function setCropAspect(ratio) {
      if (cropper) {
        cropper.setAspectRatio(ratio);
      }
      // Update button states
      document.querySelectorAll('.crop-aspect-buttons button').forEach(b => b.classList.remove('active'));
      event.target.classList.add('active');
    }
    
    async function applyCrop() {
      if (!cropper) return;
      
      const statusEl = currentCropStatusEl;
      if (statusEl.textContent !== undefined) {
        statusEl.textContent = 'Processing...';
        statusEl.style.color = '#f57c00';
      }
      
      try {
        // Get cropped canvas
        const canvas = cropper.getCroppedCanvas({
          maxWidth: 2000,
          maxHeight: 2000
        });
        
        // Convert to blob
        const blob = await new Promise(resolve => {
          canvas.toBlob(resolve, 'image/jpeg', 0.9);
        });
        
        // Create file from blob
        const croppedFile = new File([blob], currentCropFile.name.replace(/\.[^/.]+$/, '.jpg'), {
          type: 'image/jpeg'
        });
        
        if (statusEl.textContent !== undefined) {
          statusEl.textContent = 'Uploading...';
        }
        
        // Upload
        const url = await uploadImageToSupabase(croppedFile, currentCropFolder);
        
        // Update the appropriate fields
        document.getElementById(currentCropUrlInput).value = url;
        document.getElementById(currentCropPreviewImg).src = url;
        document.getElementById(currentCropPreviewBox).style.display = 'block';
        
        // Handle featured image specific UI
        if (currentCropIsFeatured) {
          document.getElementById('featuredImageContainer').classList.add('has-image');
          document.getElementById('featuredImagePlaceholder').style.display = 'none';
          currentCropIsFeatured = false;
        }
        
        if (statusEl.textContent !== undefined) {
          statusEl.textContent = '‚úî Uploaded';
          statusEl.style.color = '#4CAF50';
        }
        
        closeCropperModal();
        showToast('Image cropped and uploaded!', 'success');
        
      } catch (err) {
        console.error('Crop/upload failed:', err);
        if (statusEl.textContent !== undefined) {
          statusEl.textContent = '‚úçÔ∏è‚Äî Failed';
          statusEl.style.color = '#f44336';
        }
        showToast('Image processing failed', 'error');
      }
    }
    
    // Featured Image Upload Handler - Opens Cropper
    function handleFeaturedImageUpload(input) {
      const file = input.files[0];
      if (!file) return;
      
      openCropperModal(
        file,
        'featured',
        document.getElementById('featuredUploadStatus'),
        'featuredImageUrlInput',
        'featuredImagePreviewImg',
        'featuredImagePreviewBox'
      );
    }
    
    // Insert Image Upload Handler - Opens Cropper
    function handleInsertImageUpload(input) {
      const file = input.files[0];
      if (!file) return;
      
      openCropperModal(
        file,
        'articles',
        document.getElementById('insertUploadStatus'),
        'insertImageUrl',
        'insertImagePreviewImg',
        'insertImagePreviewBox'
      );
    }
    
    // Login
    function login() {
      const password = document.getElementById('loginPassword').value;
      if (password === CMS_PASSWORD) {
        sessionStorage.setItem('cms_auth', 'true');
        showApp();
      } else {
        document.getElementById('loginError').textContent = 'Incorrect password';
        document.getElementById('loginError').style.display = 'block';
      }
    }
    
    function logout() {
      sessionStorage.removeItem('cms_auth');
      location.reload();
    }
    
    function showApp() {
      document.getElementById('loginScreen').style.display = 'none';
      document.getElementById('mainHeader').style.display = 'block';
      document.getElementById('mainContainer').style.display = 'block';
      loadArticles();
      loadGamesForStory();
      populatePhotographerDropdown();
      loadSponsors(); // Load sponsors for article dropdown
      
      // Initialize Quill editor
      setTimeout(() => {
        initQuillEditor();
      }, 100);
    }
    
    // Check auth on load
    if (sessionStorage.getItem('cms_auth') === 'true') {
      showApp();
    }
    
    // Tabs
    function showTab(tab) {
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      event.target.classList.add('active');
      
      document.getElementById('articlesPanel').style.display = tab === 'articles' ? 'block' : 'none';
      document.getElementById('schedulePanel').style.display = tab === 'schedule' ? 'block' : 'none';
      document.getElementById('teamsPanel').style.display = tab === 'teams' ? 'block' : 'none';
      document.getElementById('contributorsPanel').style.display = tab === 'contributors' ? 'block' : 'none';
      document.getElementById('sponsorsPanel').style.display = tab === 'sponsors' ? 'block' : 'none';
      document.getElementById('productsPanel').style.display = tab === 'products' ? 'block' : 'none';
      document.getElementById('rostersPanel').style.display = tab === 'rosters' ? 'block' : 'none';
      document.getElementById('bashPanel').style.display = tab === 'bash' ? 'block' : 'none';
      document.getElementById('graphicsPanel').style.display = tab === 'graphics' ? 'block' : 'none';
      document.getElementById('galleriesPanel').style.display = tab === 'galleries' ? 'block' : 'none';
      document.getElementById('videoPanel').style.display = tab === 'video' ? 'block' : 'none';
      document.getElementById('settingsPanel').style.display = tab === 'settings' ? 'block' : 'none';
      document.getElementById('championshipsPanel').style.display = tab === 'championships' ? 'block' : 'none';
      document.getElementById('scorers1kPanel').style.display = tab === 'scorers1k' ? 'block' : 'none';
      document.getElementById('ncaaplayersPanel').style.display = tab === 'ncaaplayers' ? 'block' : 'none';
      document.getElementById('editorPanel').style.display = 'none';
      
      // Load teams when tab is selected
      if (tab === 'teams' && allTeams.length === 0) {
        loadTeams();
      }
      
      // Load games when schedule tab is selected
      if (tab === 'schedule' && allGames.length === 0) {
        loadGames();
      }
      
      // Load contributors when tab is selected
      if (tab === 'contributors' && allContributors.length === 0) {
        loadContributors();
      }
      
      // Load rosters when tab is selected
      if (tab === 'rosters' && allRosterSubmissions.length === 0) {
        loadRosters();
      }
      
      // Load Bash data when tab is selected
      if (tab === 'bash' && bashSchedule.length === 0) {
        loadBashData();
      }
      
      // Load settings when tab is selected
      if (tab === 'settings') {
        loadSiteSettings();
      }
      
      // Initialize Graphics Creator when tab is selected
      if (tab === 'graphics') {
        initGraphicsCreator();
      }
      
      // Load Gallery Manager when tab is selected
      if (tab === 'galleries' && galleryAlbums.length === 0) {
        loadGalleryAlbums();
      }
      
      // Load Sponsors when tab is selected
      if (tab === 'sponsors' && allSponsors.length === 0) {
        loadSponsors();
      }
      
      // Load Videos when tab is selected
      if (tab === 'video' && allVideos.length === 0) {
        loadVideos();
      }
      
      // Load Championships when tab is selected
      if (tab === 'championships' && allChampionships.length === 0) {
        loadChampionships();
      }
      
      // Load 1K Scorers when tab is selected
      if (tab === 'scorers1k' && allScorers1K.length === 0) {
        loadScorers1K();
      }
      
      // Load NCAA Players when tab is selected
      if (tab === 'ncaaplayers' && allNCAAPlayers.length === 0) {
        loadNCAAPlayers();
      }
    }
    
    // Load articles
    async function loadArticles() {
      const { data, error } = await db
        .from('articles')
        .select('*')
        .order('created_at', { ascending: false });
      
      if (error) {
        console.error('Error loading articles:', error);
        showToast('Error loading articles', 'error');
        return;
      }
      
      articles = data || [];
      renderArticles();
    }
    
    // Article sorting state
    let articleSortColumn = 'created_at';
    let articleSortDirection = 'desc';
    
    function renderArticles(filter = '') {
      const list = document.getElementById('articleList');
      let filtered = articles.filter(a => 
        a.title.toLowerCase().includes(filter.toLowerCase())
      );
      
      // Sort articles
      filtered.sort((a, b) => {
        // Pinned articles always come first, in order of pinning
        const aPinned = pinnedArticles.indexOf(a.id);
        const bPinned = pinnedArticles.indexOf(b.id);
        
        if (aPinned !== -1 && bPinned === -1) return -1;
        if (aPinned === -1 && bPinned !== -1) return 1;
        if (aPinned !== -1 && bPinned !== -1) return aPinned - bPinned;
        
        // Regular sorting for non-pinned
        let aVal, bVal;
        
        switch (articleSortColumn) {
          case 'title':
            aVal = (a.title || '').toLowerCase();
            bVal = (b.title || '').toLowerCase();
            break;
          case 'level':
            aVal = getArticleLevel(a).toLowerCase();
            bVal = getArticleLevel(b).toLowerCase();
            break;
          case 'gender':
            aVal = getArticleGender(a).toLowerCase();
            bVal = getArticleGender(b).toLowerCase();
            break;
          case 'status':
            aVal = a.status || '';
            bVal = b.status || '';
            break;
          case 'pub_date':
            aVal = getArticlePubDate(a) || '';
            bVal = getArticlePubDate(b) || '';
            break;
          case 'created_at':
          default:
            aVal = a.created_at || '';
            bVal = b.created_at || '';
            break;
        }
        
        if (aVal < bVal) return articleSortDirection === 'asc' ? -1 : 1;
        if (aVal > bVal) return articleSortDirection === 'asc' ? 1 : -1;
        return 0;
      });
      
      const sortIcon = (col) => {
        if (articleSortColumn !== col) return '';
        return articleSortDirection === 'asc' ? ' ^' : ' v';
      };
      
      const headerHtml = `
        <div class="article-row header">
          <div class="sortable" onclick="sortArticles('title')" style="cursor: pointer;">Title${sortIcon('title')}</div>
          <div class="sortable" onclick="sortArticles('level')" style="cursor: pointer;">Level${sortIcon('level')}</div>
          <div class="sortable" onclick="sortArticles('gender')" style="cursor: pointer;">Gender${sortIcon('gender')}</div>
          <div class="sortable" onclick="sortArticles('status')" style="cursor: pointer;">Status${sortIcon('status')}</div>
          <div class="sortable" onclick="sortArticles('created_at')" style="cursor: pointer;">Created${sortIcon('created_at')}</div>
          <div class="sortable" onclick="sortArticles('pub_date')" style="cursor: pointer;">Pub Date${sortIcon('pub_date')}</div>
          <div>Actions</div>
        </div>
      `;
      
      if (filtered.length === 0) {
        list.innerHTML = headerHtml + `
          <div class="empty-state">
            <p>No articles found</p>
            <button class="btn-new" onclick="newArticle()">Create your first article</button>
          </div>
        `;
        return;
      }
      
      list.innerHTML = headerHtml +
        filtered.map(article => {
          const isPublished = article.status === 'published';
          const articleUrl = isPublished ? `https://ball603.com/article/${article.slug}` : '';
          const shareButtons = isPublished ? `
            <div style="display: flex; gap: 4px; margin-top: 4px;">
              <button onclick="event.stopPropagation(); shareArticle('facebook', '${articleUrl}')" style="padding: 3px 6px; font-size: 10px; background: #1877f2; color: white; border: none; border-radius: 3px; cursor: pointer;" title="Share to Facebook">FB</button>
              <button onclick="event.stopPropagation(); shareArticle('twitter', '${articleUrl}', '${article.title.replace(/'/g, "\\'")}')" style="padding: 3px 6px; font-size: 10px; background: #000; color: white; border: none; border-radius: 3px; cursor: pointer;" title="Share to X">X</button>
              <button onclick="event.stopPropagation(); copyArticleUrl('${articleUrl}')" style="padding: 3px 6px; font-size: 10px; background: #666; color: white; border: none; border-radius: 3px; cursor: pointer;" title="Copy Link">üîó</button>
              ${article.social_posts ? `<button onclick="event.stopPropagation(); viewStoredSocialPosts('${article.id}')" style="padding: 3px 6px; font-size: 10px; background: #9c27b0; color: white; border: none; border-radius: 3px; cursor: pointer;" title="View Social Posts">üì±</button>` : ''}
            </div>
          ` : '';
          const scheduledInfo = article.scheduled_at ? `<div style="font-size: 10px; color: #9c27b0;">üîç‚Ä¶  ${formatDateTime(article.scheduled_at)}</div>` : '';
          
          const level = getArticleLevel(article);
          const gender = getArticleGender(article);
          const pubDate = getArticlePubDate(article);
          const thumbnail = article.featured_image_url 
            ? `<img src="${article.featured_image_url}" class="article-thumb" alt="">`
            : `<div class="article-thumb-placeholder">üì∑</div>`;
          const isPinned = pinnedArticles.includes(article.id);
          
          return `
          <div class="article-row ${isPinned ? 'pinned' : ''}">
            <div style="display: flex; align-items: center; gap: 10px;">
              ${thumbnail}
              <div>
                <div class="article-title" onclick="editArticle('${article.id}')">${article.title || 'Untitled'}</div>
                ${isPinned ? '<span style="font-size: 10px; color: #f57c00;">üìå Pinned</span>' : ''}
                ${shareButtons}
              </div>
            </div>
            <div class="article-level">${level}</div>
            <div class="article-gender">${gender}</div>
            <div>
              <span class="article-status ${article.status}">${article.status}</span>
              ${scheduledInfo}
            </div>
            <div class="article-date">${formatDate(article.created_at)}</div>
            <div class="article-date">${pubDate ? formatDate(pubDate) : '-'}</div>
            <div class="article-actions">
              <button class="btn-edit" onclick="editArticle('${article.id}')">Edit</button>
              <button class="btn-delete" onclick="deleteArticle('${article.id}')">Delete</button>
            </div>
          </div>
        `}).join('');
    }
    
    function getArticleLevel(article) {
      // Try to get from game_data first
      if (article.game_data?.division) {
        // Infer level from division
        const div = article.game_data.division.toLowerCase();
        if (div.includes('d1') || div.includes('division i') || div.includes('d2') || div.includes('d3')) return 'College';
        return 'High School';
      }
      // Try to get from linked game
      if (article.game_id) {
        const game = games.find(g => g.game_id === article.game_id);
        if (game?.level) return game.level;
        if (game?.division) {
          const div = game.division.toLowerCase();
          if (div.includes('d1') || div.includes('division i') || div.includes('d2') || div.includes('d3')) return 'College';
          return 'High School';
        }
      }
      return '-';
    }
    
    function getArticleGender(article) {
      // Try to get from game_data first
      if (article.game_data?.gender) return article.game_data.gender;
      // Try to get from linked game
      if (article.game_id) {
        const game = games.find(g => g.game_id === article.game_id);
        if (game?.gender) return game.gender;
      }
      return '-';
    }
    
    function getArticlePubDate(article) {
      // Priority: article_date > published_at > created_at
      return article.article_date || article.published_at || null;
    }
    
    // Pinned articles state
    let pinnedArticles = JSON.parse(localStorage.getItem('ball603_pinned_articles') || '[]');
    
    function savePinnedArticles() {
      localStorage.setItem('ball603_pinned_articles', JSON.stringify(pinnedArticles));
    }
    
    function openPinArticlesModal() {
      document.getElementById('pinArticlesModal').style.display = 'flex';
      renderPinArticlesList();
    }
    
    function closePinArticlesModal() {
      document.getElementById('pinArticlesModal').style.display = 'none';
    }
    
    function renderPinArticlesList() {
      const container = document.getElementById('pinArticlesList');
      const publishedArticles = articles.filter(a => a.status === 'published');
      
      container.innerHTML = publishedArticles.map(article => {
        const isPinned = pinnedArticles.includes(article.id);
        const pinOrder = pinnedArticles.indexOf(article.id) + 1;
        const thumbnail = article.featured_image_url 
          ? `<img src="${article.featured_image_url}" style="width: 48px; height: 27px; object-fit: cover; border-radius: 4px;">`
          : `<div style="width: 48px; height: 27px; background: #eee; border-radius: 4px; display: flex; align-items: center; justify-content: center; font-size: 12px;"></div>`;
        
        return `
          <div style="display: flex; align-items: center; gap: 10px; padding: 10px; border-bottom: 1px solid #eee; ${isPinned ? 'background: #fff8e1;' : ''}">
            <input type="checkbox" 
              ${isPinned ? 'checked' : ''} 
              onchange="togglePinArticle('${article.id}')"
              ${!isPinned && pinnedArticles.length >= 3 ? 'disabled' : ''}>
            ${thumbnail}
            <div style="flex: 1;">
              <div style="font-weight: 500;">${article.title || 'Untitled'}</div>
              <div style="font-size: 11px; color: #666;">${formatDate(getArticlePubDate(article))}</div>
            </div>
            ${isPinned ? `<span style="background: #f57c00; color: white; padding: 2px 8px; border-radius: 10px; font-size: 11px;">#${pinOrder}</span>` : ''}
          </div>
        `;
      }).join('');
      
      // Update count display
      document.getElementById('pinnedCount').textContent = `${pinnedArticles.length}/3 pinned`;
    }
    
    function togglePinArticle(articleId) {
      const idx = pinnedArticles.indexOf(articleId);
      if (idx > -1) {
        pinnedArticles.splice(idx, 1);
      } else if (pinnedArticles.length < 3) {
        pinnedArticles.push(articleId);
      }
      savePinnedArticles();
      renderPinArticlesList();
      renderArticles(document.getElementById('articleSearch')?.value || '');
    }
    
    function clearPinnedArticles() {
      pinnedArticles = [];
      savePinnedArticles();
      renderPinArticlesList();
      renderArticles(document.getElementById('articleSearch')?.value || '');
    }
    
    function sortArticles(column) {
      if (articleSortColumn === column) {
        // Toggle direction
        articleSortDirection = articleSortDirection === 'asc' ? 'desc' : 'asc';
      } else {
        articleSortColumn = column;
        articleSortDirection = column === 'created_at' ? 'desc' : 'asc';
      }
      renderArticles(document.getElementById('articleSearch')?.value || '');
    }
    
    function filterArticles(value) {
      renderArticles(value);
    }
    
    function formatDate(dateStr) {
      if (!dateStr) return '-';
      const date = new Date(dateStr);
      return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
    }
    
    function formatDateTime(dateStr) {
      if (!dateStr) return '-';
      const date = new Date(dateStr);
      return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }) + ' ' + 
             date.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
    }
    
    // Get today's date in EST timezone (YYYY-MM-DD format for input fields)
    function getTodayEST() {
      return new Date().toLocaleDateString('en-CA', { timeZone: 'America/New_York' });
    }
    
    // Social sharing functions
    function shareArticle(platform, url, title = '') {
      let shareUrl;
      if (platform === 'facebook') {
        shareUrl = `https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(url)}`;
      } else if (platform === 'twitter') {
        shareUrl = `https://twitter.com/intent/tweet?url=${encodeURIComponent(url)}&text=${encodeURIComponent(title)}`;
      }
      window.open(shareUrl, '_blank', 'width=600,height=400');
    }
    
    function copyArticleUrl(url) {
      navigator.clipboard.writeText(url).then(() => {
        showToast('Link copied!', 'success');
      });
    }
    
    async function viewStoredSocialPosts(articleId) {
      const article = articles.find(a => a.id === articleId);
      if (!article || !article.social_posts) {
        showToast('No social posts found', 'error');
        return;
      }
      
      // Load the social posts into the generatedSocialPosts object
      generatedSocialPosts = article.social_posts;
      currentArticle = article;
      
      // Show the social publishing panel
      showSocialPublishing(article);
    }
    
    // Schedule modal functions
    let isScheduled = false;
    let scheduledTime = null;
    
    function openScheduleModal() {
      const modal = document.getElementById('scheduleModal');
      modal.classList.add('open');
      document.body.style.overflow = 'hidden';
      
      // If already scheduled, show that time; otherwise default to tomorrow 9 AM
      if (scheduledTime) {
        document.getElementById('scheduledDateTime').value = scheduledTime;
      } else if (!document.getElementById('scheduledDateTime').value) {
        const tomorrow = new Date();
        tomorrow.setDate(tomorrow.getDate() + 1);
        tomorrow.setHours(9, 0, 0, 0);
        document.getElementById('scheduledDateTime').value = tomorrow.toISOString().slice(0, 16);
      }
    }
    
    function closeScheduleModal() {
      document.getElementById('scheduleModal').classList.remove('open');
      document.body.style.overflow = 'auto';
    }
    
    function setSchedule() {
      const dateTime = document.getElementById('scheduledDateTime').value;
      if (dateTime) {
        isScheduled = true;
        scheduledTime = dateTime;
        updateScheduleButton();
        closeScheduleModal();
        showToast('Schedule set!', 'success');
      }
    }
    
    function clearSchedule() {
      isScheduled = false;
      scheduledTime = null;
      document.getElementById('scheduledDateTime').value = '';
      updateScheduleButton();
      closeScheduleModal();
      showToast('Schedule cleared', 'success');
    }
    
    function updateScheduleButton() {
      const btn = document.getElementById('scheduleBtnText');
      if (isScheduled && scheduledTime) {
        const date = new Date(scheduledTime);
        const formatted = date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', hour: 'numeric', minute: '2-digit' });
        btn.textContent = `Scheduled: ${formatted}`;
        btn.parentElement.style.color = '#9c27b0';
      } else {
        btn.textContent = 'üîç‚Ä¶ Schedule for later';
        btn.parentElement.style.color = '#666';
      }
    }
    
    // Tags management
    let currentTags = [];
    
    function generateAutoTags() {
      let tags = ['news'];
      
      if (selectedGame) {
        if (selectedGame.home) tags.push(selectedGame.home.toLowerCase().replace(/\s+/g, '-'));
        if (selectedGame.away) tags.push(selectedGame.away.toLowerCase().replace(/\s+/g, '-'));
        if (selectedGame.level) tags.push(selectedGame.level.toLowerCase());
        if (selectedGame.gender) tags.push(selectedGame.gender.toLowerCase());
        if (selectedGame.division) tags.push(selectedGame.division.toLowerCase().replace(/\s+/g, '-'));
        if (selectedGame.conference) tags.push(selectedGame.conference.toLowerCase().replace(/\s+/g, '-'));
      }
      
      const youtubeUrl = document.getElementById('youtubeUrl').value;
      const smugmugUrl = document.getElementById('smugmugUrl').value;
      if (youtubeUrl) tags.push('video');
      if (smugmugUrl) tags.push('photo-gallery');
      
      return [...new Set(tags)]; // Remove duplicates
    }
    
    function renderTags() {
      const container = document.getElementById('tagsContainer');
      if (!container) return;
      
      // Generate auto tags if currentTags is empty
      if (currentTags.length === 0) {
        currentTags = generateAutoTags();
      }
      
      container.innerHTML = currentTags.map(tag => `
        <span style="display: inline-flex; align-items: center; gap: 5px; padding: 4px 10px; background: #e3f2fd; color: #1565c0; border-radius: 20px; font-size: 12px;">
          ${tag}
          <button onclick="removeTag('${tag}')" style="background: none; border: none; cursor: pointer; color: #1565c0; font-size: 14px; line-height: 1; padding: 0;">&times;</button>
        </span>
      `).join('');
    }
    
    function removeTag(tag) {
      currentTags = currentTags.filter(t => t !== tag);
      renderTags();
    }
    
    function addCustomTag() {
      const input = document.getElementById('newTagInput');
      const tag = input.value.trim().toLowerCase().replace(/\s+/g, '-');
      
      if (tag && !currentTags.includes(tag)) {
        currentTags.push(tag);
        renderTags();
      }
      
      input.value = '';
    }
    
    function addQuickTag(tag) {
      if (tag && !currentTags.includes(tag)) {
        currentTags.push(tag);
        renderTags();
      }
    }
    
    function refreshTags() {
      // Refresh auto-generated tags based on current game selection
      const autoTags = generateAutoTags();
      // Keep custom tags (tags not in auto-generated list that were manually added)
      const customTags = currentTags.filter(t => !['news', 'video', 'photo-gallery'].includes(t) && 
        !(selectedGame && [
          selectedGame.home?.toLowerCase().replace(/\s+/g, '-'),
          selectedGame.away?.toLowerCase().replace(/\s+/g, '-'),
          selectedGame.level?.toLowerCase(),
          selectedGame.gender?.toLowerCase(),
          selectedGame.division?.toLowerCase().replace(/\s+/g, '-'),
          selectedGame.conference?.toLowerCase().replace(/\s+/g, '-')
        ].includes(t)));
      
      currentTags = [...new Set([...autoTags, ...customTags])];
      renderTags();
    }
    
    // View social posts for current article
    function viewSocialPosts() {
      if (!currentArticle || !currentArticle.social_posts) {
        showToast('No social posts available', 'error');
        return;
      }
      generatedSocialPosts = currentArticle.social_posts;
      showSocialPublishing(currentArticle);
    }
    
    // Load games for selector (Scorebook/Boxscore Story modals)
    async function loadGamesForStory() {
      try {
        const response = await fetch('/.netlify/functions/games?limit=5000');
        const data = await response.json();
        games = data || [];
        renderGameSelector();
      } catch (err) {
        console.error('Error loading games:', err);
        const selector = document.getElementById('gameSelector');
        if (selector) {
          selector.innerHTML = '<div style="padding: 10px; color: #999;">Could not load games</div>';
        }
      }
    }
    
    function renderGameSelector(filter = '') {
      const selector = document.getElementById('gameSelector');
      if (!selector) return; // Element doesn't exist on this page/state
      
      let filtered = games.filter(g => {
        if (filter) {
          const search = filter.toLowerCase();
          return g.away?.toLowerCase().includes(search) || 
                 g.home?.toLowerCase().includes(search);
        }
        return true;
      }).slice(0, 20);
      
      if (filtered.length === 0) {
        selector.innerHTML = '<div style="padding: 10px; color: #999;">No games found</div>';
        return;
      }
      
      selector.innerHTML = filtered.map(g => `
        <div class="game-option ${g.game_id === document.getElementById('selectedGameId').value ? 'selected' : ''}" 
             onclick="selectGame('${g.game_id}', '${g.away} @ ${g.home}')">
          <div class="teams">${g.away || 'TBD'} @ ${g.home || 'TBD'}</div>
          <div class="meta">${g.date} ‚Ä¢${g.gender} ${g.division || ''}</div>
        </div>
      `).join('');
    }
    
    function searchGames(value) {
      renderGameSelector(value);
    }
    
    function selectGame(gameId, label) {
      document.getElementById('selectedGameId').value = gameId;
      selectedGame = games.find(g => g.game_id === gameId) || null;
      renderGameSelector();
    }
    
    // Game Story Modal Functions
    let gsSelectedGame = null;
    let otCount = 0;
    let gsSelectedDate = new Date();
    let gsGeneratedData = null; // Store generated article data for preview step
    
    function newGameStory() {
      gsSelectedGame = null;
      otCount = 0;
      gsGeneratedData = null;
      document.getElementById('gameStoryModal').style.display = 'block';
      document.getElementById('gsMainContent').style.display = 'flex';
      document.getElementById('gsEntryPanel').style.display = 'none';
      document.getElementById('gsEmptyState').style.display = 'block';
      document.getElementById('gsStep3').style.display = 'none';
      document.getElementById('gsGameSearch').value = '';
      // Set date filter to today
      const today = new Date();
      document.getElementById('gsDateFilter').value = getDateString(today);
      document.getElementById('gsGenderFilter').value = 'Boys';
      populateGameList();
      document.body.style.overflow = 'hidden';
    }
    
    function clearGameSelection() {
      gsSelectedGame = null;
      otCount = 0;
      document.getElementById('gsEntryPanel').style.display = 'none';
      document.getElementById('gsEmptyState').style.display = 'block';
    }
    
    function closeGameStory() {
      document.getElementById('gameStoryModal').style.display = 'none';
      document.body.style.overflow = 'auto';
    }
    
    function formatDateShort(date) {
      const months = ['Jan.', 'Feb.', 'Mar.', 'Apr.', 'May', 'June', 'July', 'Aug.', 'Sept.', 'Oct.', 'Nov.', 'Dec.'];
      return `${months[date.getMonth()]} ${date.getDate()}, ${date.getFullYear()}`;
    }
    
    function formatGameDate(dateStr) {
      if (!dateStr) return '';
      const date = new Date(dateStr + 'T12:00:00');
      return formatDateShort(date);
    }
    
    function updateGsDateDisplay() {
      document.getElementById('gsDateFilter').value = getDateString(gsSelectedDate);
    }
    
    function gsPrevDay() {
      const dateInput = document.getElementById('gsDateFilter');
      const currentDate = new Date(dateInput.value + 'T12:00:00');
      currentDate.setDate(currentDate.getDate() - 1);
      dateInput.value = getDateString(currentDate);
      populateGameList();
    }
    
    function gsNextDay() {
      const dateInput = document.getElementById('gsDateFilter');
      const currentDate = new Date(dateInput.value + 'T12:00:00');
      currentDate.setDate(currentDate.getDate() + 1);
      dateInput.value = getDateString(currentDate);
      populateGameList();
    }
    
    function getDateString(date) {
      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const day = String(date.getDate()).padStart(2, '0');
      return `${year}-${month}-${day}`;
    }
    
    function populateGameList() {
      const container = document.getElementById('gsGameList');
      
      // Check if games have loaded
      if (!games || games.length === 0) {
        container.innerHTML = '<div style="padding: 20px; text-align: center; color: #888;">Loading games...</div>';
        setTimeout(() => {
          if (games && games.length > 0) populateGameList();
        }, 500);
        return;
      }
      
      const searchFilter = document.getElementById('gsGameSearch').value.toLowerCase();
      const selectedDateStr = document.getElementById('gsDateFilter').value;
      const selectedGender = document.getElementById('gsGenderFilter').value;
      
      // Filter by selected date, gender, and search
      let filtered = games.filter(g => {
        // Must match selected date
        if (selectedDateStr && g.date !== selectedDateStr) return false;
        // Must match selected gender
        if (g.gender !== selectedGender) return false;
        // Filter by search
        if (searchFilter) {
          const searchStr = `${g.away} ${g.home}`.toLowerCase();
          if (!searchStr.includes(searchFilter)) return false;
        }
        return true;
      });
      
      // Sort by time, then gender
      filtered.sort((a, b) => {
        if (a.time !== b.time) return (a.time || '').localeCompare(b.time || '');
        return (a.gender || '').localeCompare(b.gender || '');
      });
      
      if (filtered.length === 0) {
        const message = searchFilter 
          ? `No ${selectedGender.toLowerCase()} games found for "${searchFilter}"` 
          : `No ${selectedGender.toLowerCase()} games on this date`;
        container.innerHTML = `<div style="padding: 30px; text-align: center; color: #888; font-size: 13px;">${message}</div>`;
        return;
      }
      
      // Build game list with status indicators like Bash version
      let html = '';
      
      filtered.forEach(g => {
        const hasRecap = g.recap_link && g.recap_link.trim() !== '';
        const hasScore = g.away_score !== null && g.home_score !== null;
        const statusColor = hasRecap ? '#4caf50' : (hasScore ? '#ff9800' : '#ccc');
        const statusText = hasRecap ? 'Published' : (hasScore ? 'Has Score' : 'Pending');
        
        html += `<div onclick="selectGameForStory('${g.game_id}')" style="padding: 8px 12px; border-bottom: 1px solid #eee; cursor: pointer; display: flex; justify-content: space-between; align-items: center;" onmouseover="this.style.background='#f5f5f5'" onmouseout="this.style.background=''">
          <div>
            <div style="font-size: 13px; font-weight: 500;">${g.away}</div>
            <div style="font-size: 12px; color: #666;">@ ${g.home}</div>
          </div>
          <span style="font-size: 10px; padding: 2px 8px; border-radius: 10px; background: ${statusColor}; color: white;">${statusText}</span>
        </div>`;
      });
      
      container.innerHTML = html;
    }
    
    function filterGameList() {
      populateGameList();
    }
    
    async function selectGameForStory(gameId) {
      gsSelectedGame = games.find(g => g.game_id === gameId);
      if (!gsSelectedGame) return;
      
      // Show entry panel, hide empty state
      document.getElementById('gsEmptyState').style.display = 'none';
      document.getElementById('gsEntryPanel').style.display = 'block';
      
      // Set matchup title
      document.getElementById('gsMatchupTitle').textContent = `${gsSelectedGame.away} @ ${gsSelectedGame.home}`;
      document.getElementById('gsAwayName').textContent = gsSelectedGame.away;
      document.getElementById('gsHomeName').textContent = gsSelectedGame.home;
      document.getElementById('gsAwayLabel').textContent = gsSelectedGame.away;
      document.getElementById('gsHomeLabel').textContent = gsSelectedGame.home;
      
      // Clear quarter scores
      ['gsAwayQ1', 'gsAwayQ2', 'gsAwayQ3', 'gsAwayQ4', 'gsAwayFinal', 
       'gsHomeQ1', 'gsHomeQ2', 'gsHomeQ3', 'gsHomeQ4', 'gsHomeFinal'].forEach(id => {
        document.getElementById(id).value = '';
      });
      
      // Clear OT
      otCount = 0;
      document.getElementById('otHeaders').innerHTML = '';
      document.getElementById('gsAwayOT').innerHTML = '';
      document.getElementById('gsHomeOT').innerHTML = '';
      
      // Populate rosters
      const rosters = await getTeamRosters();
      populateGSRoster('away', rosters.away, gsSelectedGame.away);
      populateGSRoster('home', rosters.home, gsSelectedGame.home);
      
      // Clear notes
      document.getElementById('gsNotes').value = '';
      
      // Show photographers if assigned
      console.log('Game data:', gsSelectedGame.game_id, 'photog1:', gsSelectedGame.photog1, 'photog2:', gsSelectedGame.photog2);
      const photogs = [gsSelectedGame.photog1, gsSelectedGame.photog2].filter(p => p && p.trim());
      const photogDiv = document.getElementById('gsPhotographers');
      const checkboxContainer = document.getElementById('gsPhotogCheckboxes');
      if (photogs.length > 0) {
        checkboxContainer.innerHTML = photogs.map((p, i) => `
          <label style="display: flex; align-items: center; gap: 6px; margin-bottom: 4px; cursor: pointer;">
            <input type="checkbox" name="gsPhotog" value="${p}" checked style="cursor: pointer;">
            <span>${p}</span>
          </label>
        `).join('');
        photogDiv.style.display = 'block';
      } else {
        photogDiv.style.display = 'none';
      }
      
      // Reset totals
      updateGSPointsTotal('away');
      updateGSPointsTotal('home');
    }
    
    async function getTeamRosters() {
      // Works for both game story modal and regular article editor
      const game = gsSelectedGame || selectedGame;
      if (!game) return { away: null, home: null };
      
      const gender = game.gender || 'Boys';
      const awayName = game.away;
      const homeName = game.home;
      
      console.log('=== getTeamRosters DEBUG ===');
      console.log('Looking for:', { gender, awayName, homeName });
      
      try {
        // Fetch rosters from database
        const { data: rosters, error } = await db
          .from('roster_submissions')
          .select('*')
          .eq('gender', gender);
        
        if (error) {
          console.error('Error fetching rosters:', error);
          return { away: null, home: null };
        }
        
        console.log('Found', rosters?.length || 0, 'rosters for gender:', gender);
        console.log('Available schools:', rosters?.map(r => `${r.school} (${r.status})`).join(', '));
        
        // Find matching rosters with flexible name matching
        // Prefer approved, but use any status if no approved match
        const findRoster = (teamName) => {
          if (!rosters || !teamName) return null;
          const normalizedTeam = teamName.toLowerCase().trim();
          
          // First try to find approved roster - EXACT MATCH ONLY
          let match = rosters.find(r => {
            if (r.status !== 'approved') return false;
            const normalizedSchool = (r.school || '').toLowerCase().trim();
            return normalizedSchool === normalizedTeam;
          });
          
          // If no approved match, try any roster - EXACT MATCH ONLY
          if (!match) {
            match = rosters.find(r => {
              const normalizedSchool = (r.school || '').toLowerCase().trim();
              return normalizedSchool === normalizedTeam;
            });
          }
          
          if (match) {
            console.log('Found roster for', teamName, ':', match.school, '(status:', match.status + ')');
          } else {
            console.log('No roster found for:', teamName);
          }
          
          return match;
        };
        
        const awayRoster = findRoster(awayName);
        const homeRoster = findRoster(homeName);
        
        // Convert database format to expected format
        const formatRoster = (r) => {
          if (!r) return null;
          return {
            school: r.school,
            gender: r.gender,
            players: r.players_json || [],
            head_coach: r.head_coach,
            assistant_coaches: r.assistant_coaches,
            managers: r.managers
          };
        };
        
        return { 
          away: formatRoster(awayRoster), 
          home: formatRoster(homeRoster) 
        };
        
      } catch (err) {
        console.error('Error in getTeamRosters:', err);
        // Fallback to static ROSTERS_DATA if database fails
        if (typeof ROSTERS_DATA !== 'undefined' && ROSTERS_DATA.rosters) {
          const awayRoster = ROSTERS_DATA.rosters.find(r => 
            r.gender === gender && 
            (r.school === awayName || awayName.includes(r.school) || r.school.includes(awayName))
          );
          const homeRoster = ROSTERS_DATA.rosters.find(r => 
            r.gender === gender && 
            (r.school === homeName || homeName.includes(r.school) || r.school.includes(homeName))
          );
          return { away: awayRoster, home: homeRoster };
        }
        return { away: null, home: null };
      }
    }
    
    function populateGSRoster(team, roster, teamName) {
      const container = document.getElementById(`gs${team.charAt(0).toUpperCase() + team.slice(1)}Roster`);
      container.innerHTML = '';
      
      if (roster && roster.players && roster.players.length > 0) {
        roster.players.forEach(player => {
          const row = document.createElement('div');
          row.className = 'roster-row';
          row.innerHTML = `
            <span class="player-name" data-player="${player.name}" data-team="${team}">#${player.number} ${player.name}</span>
            <input type="text" class="gs-pts" data-player="${player.name}" data-team="${team}" placeholder="" onchange="updateGSPointsTotal('${team}')">
            <input type="text" class="gs-3fg" data-player="${player.name}" data-team="${team}" placeholder="">
          `;
          container.appendChild(row);
        });
      } else {
        // No roster - add blank rows
        for (let i = 0; i < 12; i++) {
          addBlankPlayer(team);
        }
      }
    }
    
    function addBlankPlayer(team) {
      const container = document.getElementById(`gs${team.charAt(0).toUpperCase() + team.slice(1)}Roster`);
      const row = document.createElement('div');
      row.className = 'roster-row';
      row.innerHTML = `
        <input type="text" class="gs-name" data-team="${team}" placeholder="Player name" style="text-align: left;">
        <input type="text" class="gs-pts" data-team="${team}" placeholder="" onchange="updateGSPointsTotal('${team}')">
        <input type="text" class="gs-3fg" data-team="${team}" placeholder="">
      `;
      container.appendChild(row);
    }
    
    function addOT() {
      otCount++;
      
      // Add header
      const headerCell = document.getElementById('otHeaders');
      headerCell.innerHTML += `<th style="padding: 8px; width: 50px;">OT${otCount > 1 ? otCount : ''}</th>`;
      
      // Add away input
      const awayOT = document.getElementById('gsAwayOT');
      awayOT.innerHTML += `<td><input type="text" id="gsAwayOT${otCount}" class="quarter-input" onchange="calcGameFinal('away')"></td>`;
      
      // Add home input
      const homeOT = document.getElementById('gsHomeOT');
      homeOT.innerHTML += `<td><input type="text" id="gsHomeOT${otCount}" class="quarter-input" onchange="calcGameFinal('home')"></td>`;
    }
    
    function calcGameFinal(team) {
      const prefix = team === 'away' ? 'gsAway' : 'gsHome';
      let total = 0;
      
      // Add quarters
      for (let q = 1; q <= 4; q++) {
        total += parseInt(document.getElementById(`${prefix}Q${q}`).value) || 0;
      }
      
      // Add OT periods
      for (let ot = 1; ot <= otCount; ot++) {
        const otInput = document.getElementById(`${prefix}OT${ot}`);
        if (otInput) {
          total += parseInt(otInput.value) || 0;
        }
      }
      
      document.getElementById(`${prefix}Final`).value = total || '';
      updateGSPointsTotal(team);
    }
    
    function updateGSPointsTotal(team) {
      const container = document.getElementById(`gs${team.charAt(0).toUpperCase() + team.slice(1)}Roster`);
      const ptsInputs = container.querySelectorAll('.gs-pts');
      let total = 0;
      
      ptsInputs.forEach(input => {
        total += parseInt(input.value) || 0;
      });
      
      document.getElementById(`gs${team.charAt(0).toUpperCase() + team.slice(1)}PtsTotal`).textContent = total;
      
      const prefix = team === 'away' ? 'gsAway' : 'gsHome';
      const final = parseInt(document.getElementById(`${prefix}Final`).value) || 0;
      const matchSpan = document.getElementById(`gs${team.charAt(0).toUpperCase() + team.slice(1)}Match`);
      
      if (!final) {
        matchSpan.textContent = '‚úî';
        matchSpan.style.color = '#888';
      } else if (total === final) {
        matchSpan.textContent = '‚úî';
        matchSpan.style.color = '#2e7d32';
      } else {
        matchSpan.textContent = `(off by ${Math.abs(final - total)})`;
        matchSpan.style.color = '#c62828';
      }
    }
    
    function backToGameSelect() {
      // In the new side-by-side layout, just clear selection and show empty state
      clearGameSelection();
      document.getElementById('gsStep3').style.display = 'none';
      document.getElementById('gsMainContent').style.display = 'flex';
    }
    
    function backToBoxScore() {
      document.getElementById('gsStep3').style.display = 'none';
      document.getElementById('gsMainContent').style.display = 'flex';
      document.getElementById('gsEntryPanel').style.display = 'block';
      document.getElementById('gsEmptyState').style.display = 'none';
    }
    
    function toggleArticleEdit() {
      const display = document.getElementById('gsPreviewArticleDisplay');
      const textarea = document.getElementById('gsPreviewArticle');
      const btn = document.getElementById('gsEditToggleBtn');
      
      if (textarea.style.display === 'none') {
        // Switch to edit mode
        textarea.style.display = 'block';
        textarea.style.width = '100%';
        textarea.style.minHeight = '300px';
        textarea.style.padding = '12px';
        textarea.style.border = '1px solid #ddd';
        textarea.style.borderRadius = '6px';
        textarea.style.fontSize = '14px';
        textarea.style.lineHeight = '1.6';
        textarea.style.fontFamily = 'Georgia, serif';
        textarea.style.resize = 'vertical';
        display.style.display = 'none';
        btn.textContent = 'üëç¬Å Preview';
        textarea.focus();
      } else {
        // Switch to preview mode - update display with edited text
        const articleHtml = textarea.value.split('\n\n').map(p => `<p style="margin: 0 0 1em 0;">${p}</p>`).join('');
        display.innerHTML = articleHtml;
        display.style.display = 'block';
        textarea.style.display = 'none';
        btn.textContent = '‚úçÔ∏è¬è¬è Edit Text';
      }
    }
    
    async function saveAndGenerateSocial() {
      if (!gsGeneratedData) {
        showToast('No article data found', 'error');
        return;
      }
      
      const btn = document.getElementById('gsSaveBtn');
      btn.disabled = true;
      btn.textContent = '‚è≥ Generating social posts...';
      
      // Get edited article from preview (textarea always has the value)
      const editedHeadline = document.getElementById('gsPreviewHeadline').value;
      const editedArticle = document.getElementById('gsPreviewArticle').value;
      
      if (!editedArticle || editedArticle.trim() === '') {
        showToast('Article text is empty', 'error');
        btn.disabled = false;
        btn.textContent = '‚úî Save & Generate Social Media Posts';
        return;
      }
      
      // Generate excerpt from first 2 sentences
      const excerpt = editedArticle.split('.').slice(0, 2).join('.').trim() + '.';
      
      console.log('Generating social posts with:', {
        articleLength: editedArticle.length,
        headline: editedHeadline,
        hasProofData: !!gsGeneratedData.proofData,
        hasSchoolData: !!gsGeneratedData.schoolData
      });
      
      try {
        // Call API to generate social posts from the edited article
        const response = await fetch('/.netlify/functions/generate-article', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            mode: 'social',
            article: editedArticle,
            headline: editedHeadline,
            proofData: gsGeneratedData.proofData,
            schoolData: gsGeneratedData.schoolData,
            photographerName: gsGeneratedData.photographerName,
            galleryUrl: null
          })
        });
        
        const data = await response.json();
        console.log('Social API response:', data);
        
        if (data.success) {
          // Close modal and open editor with generated content
          closeGameStory();
          
          // Store generated social posts
          generatedSocialPosts = {
            facebookPost: data.facebookPost || null,
            instagramPost: data.instagramPost || null,
            twitterPost: data.twitterPost || null
          };
          
          // Store game data for saving with article
          currentGameData = {
            awayTeam: gsGeneratedData.proofData.awayTeam,
            homeTeam: gsGeneratedData.proofData.homeTeam,
            awayQuarters: gsGeneratedData.proofData.awayQuarters,
            homeQuarters: gsGeneratedData.proofData.homeQuarters,
            awayFinal: gsGeneratedData.proofData.awayFinal,
            homeFinal: gsGeneratedData.proofData.homeFinal,
            awayScorers: gsGeneratedData.proofData.awayScorers,
            homeScorers: gsGeneratedData.proofData.homeScorers,
            gender: gsGeneratedData.proofData.gender,
            division: gsGeneratedData.proofData.division,
            awayRecord: gsGeneratedData.proofData.awayRecord,
            homeRecord: gsGeneratedData.proofData.homeRecord,
            photographerName: gsGeneratedData.photographerName
          };
          
          // Set up article editor
          currentArticle = null;
          document.getElementById('editorTitle').textContent = 'New Article';
          document.getElementById('articleTitle').value = editedHeadline;
          // Convert plain text paragraphs to HTML
          const articleHtml = editedArticle.split('\n\n').map(p => `<p>${p.trim()}</p>`).join('');
          setEditorContent(articleHtml);
          document.getElementById('articleExcerpt').value = excerpt;
          document.getElementById('selectedGameId').value = gsSelectedGame.game_id;
          selectedGame = gsSelectedGame;
          document.getElementById('smugmugUrl').value = '';
          document.getElementById('smugmugThumbUrl').value = '';
          
          // Set photographer from story
          setPhotographerValue(gsGeneratedData.photographerName || '');
          document.getElementById('youtubeUrl').value = '';
          setAuthorValue('KJ Cardinal');
          document.getElementById('articleDate').value = getTodayEST();
          isScheduled = false;
          scheduledTime = null;
          document.getElementById('scheduledDateTime').value = '';
          updateScheduleButton();
          document.getElementById('socialPostsCard').style.display = 'block';
          
          // Generate auto tags based on linked game
          currentTags = generateAutoTags();
          renderTags();
          
          document.getElementById('articlesPanel').style.display = 'none';
          document.getElementById('editorPanel').style.display = 'block';
          
          renderGameSelector();
          showToast('Social posts generated! Ready to publish.', 'success');
        } else {
          showToast(data.error || 'Failed to generate social posts', 'error');
        }
      } catch (err) {
        console.error('Social generation error:', err);
        showToast('Failed to generate social posts', 'error');
      }
      
      btn.disabled = false;
      btn.textContent = '‚úî Save & Generate Social Media Posts';
    }
    
    function collectGSScorers(team) {
      const container = document.getElementById(`gs${team.charAt(0).toUpperCase() + team.slice(1)}Roster`);
      const scorers = [];
      
      container.querySelectorAll('.roster-row').forEach(row => {
        const nameEl = row.querySelector('.player-name');
        const nameInput = row.querySelector('.gs-name');
        const ptsInput = row.querySelector('.gs-pts');
        const threeFgInput = row.querySelector('.gs-3fg');
        
        let name = '';
        if (nameEl) {
          name = nameEl.getAttribute('data-player');
        } else if (nameInput) {
          name = nameInput.value.trim();
        }
        
        const pts = parseInt(ptsInput?.value) || 0;
        const threeFg = parseInt(threeFgInput?.value) || 0;
        
        if (name && pts > 0) {
          scorers.push({ name, points: pts, threePointers: threeFg });
        }
      });
      
      // Sort by points descending
      scorers.sort((a, b) => b.points - a.points);
      return scorers;
    }
    
    async function generateGameStory() {
      const awayFinal = parseInt(document.getElementById('gsAwayFinal').value) || 0;
      const homeFinal = parseInt(document.getElementById('gsHomeFinal').value) || 0;
      
      if (!awayFinal && !homeFinal) {
        showToast('Please enter quarter scores first', 'error');
        return;
      }
      
      // Collect quarters + OT
      const awayQuarters = [
        parseInt(document.getElementById('gsAwayQ1').value) || 0,
        parseInt(document.getElementById('gsAwayQ2').value) || 0,
        parseInt(document.getElementById('gsAwayQ3').value) || 0,
        parseInt(document.getElementById('gsAwayQ4').value) || 0
      ];
      const homeQuarters = [
        parseInt(document.getElementById('gsHomeQ1').value) || 0,
        parseInt(document.getElementById('gsHomeQ2').value) || 0,
        parseInt(document.getElementById('gsHomeQ3').value) || 0,
        parseInt(document.getElementById('gsHomeQ4').value) || 0
      ];
      
      // Add OT if any
      for (let ot = 1; ot <= otCount; ot++) {
        const awayOT = parseInt(document.getElementById(`gsAwayOT${ot}`)?.value) || 0;
        const homeOT = parseInt(document.getElementById(`gsHomeOT${ot}`)?.value) || 0;
        awayQuarters.push(awayOT);
        homeQuarters.push(homeOT);
      }
      
      const awayScorers = collectGSScorers('away');
      const homeScorers = collectGSScorers('home');
      
      // Validate
      const awayPtsTotal = awayScorers.reduce((sum, s) => sum + s.points, 0);
      const homePtsTotal = homeScorers.reduce((sum, s) => sum + s.points, 0);
      
      if (awayPtsTotal !== awayFinal) {
        showToast(`${gsSelectedGame.away} points (${awayPtsTotal}) don't match final (${awayFinal})`, 'error');
        return;
      }
      if (homePtsTotal !== homeFinal) {
        showToast(`${gsSelectedGame.home} points (${homePtsTotal}) don't match final (${homeFinal})`, 'error');
        return;
      }
      
      const btn = document.getElementById('gsGenerateBtn');
      btn.disabled = true;
      btn.textContent = '‚è≥ Writing story...';
      
      const rosters = await getTeamRosters();
      
      // Get school info for mascots and towns
      const awaySchoolInfo = getSchoolInfo(gsSelectedGame.away);
      const homeSchoolInfo = getSchoolInfo(gsSelectedGame.home);
      
      // Calculate team records (games before this one)
      function getTeamRecord(teamName, gender, beforeDate) {
        let wins = 0, losses = 0;
        games.forEach(g => {
          if (g.gender !== gender) return;
          if (g.date >= beforeDate) return; // Only count games before this one
          if (!g.away_score || !g.home_score) return; // Skip games without scores
          
          const awayScore = parseInt(g.away_score) || 0;
          const homeScore = parseInt(g.home_score) || 0;
          if (awayScore === 0 && homeScore === 0) return;
          
          if (g.away === teamName) {
            if (awayScore > homeScore) wins++;
            else losses++;
          } else if (g.home === teamName) {
            if (homeScore > awayScore) wins++;
            else losses++;
          }
        });
        return { wins, losses };
      }
      
      const awayRecordBefore = getTeamRecord(gsSelectedGame.away, gsSelectedGame.gender, gsSelectedGame.date);
      const homeRecordBefore = getTeamRecord(gsSelectedGame.home, gsSelectedGame.gender, gsSelectedGame.date);
      
      // Determine new records after this game
      const awayWon = awayFinal > homeFinal;
      const awayRecordAfter = {
        wins: awayRecordBefore.wins + (awayWon ? 1 : 0),
        losses: awayRecordBefore.losses + (awayWon ? 0 : 1)
      };
      const homeRecordAfter = {
        wins: homeRecordBefore.wins + (awayWon ? 0 : 1),
        losses: homeRecordBefore.losses + (awayWon ? 1 : 0)
      };
      
      // Check if this is a season opener
      const awaySeasonOpener = awayRecordBefore.wins === 0 && awayRecordBefore.losses === 0;
      const homeSeasonOpener = homeRecordBefore.wins === 0 && homeRecordBefore.losses === 0;
      
      // Get selected photographer(s)
      const selectedPhotogs = [];
      document.querySelectorAll('input[name="gsPhotog"]:checked').forEach(cb => {
        selectedPhotogs.push(cb.value);
      });
      // Check for guest photographer
      const guestPhotog = document.getElementById('gsGuestPhotographer')?.value.trim();
      if (guestPhotog) {
        selectedPhotogs.push(guestPhotog);
      }
      const photographerName = selectedPhotogs.join(' & ');
      
      const proofData = {
        awayTeam: gsSelectedGame.away,
        homeTeam: gsSelectedGame.home,
        awayQuarters,
        homeQuarters,
        awayFinal,
        homeFinal,
        awayScorers,
        homeScorers,
        gender: gsSelectedGame.gender || 'Boys',
        division: gsSelectedGame.division || '',
        date: gsSelectedGame.date || '',
        notes: document.getElementById('gsNotes').value.trim(),
        hasOT: otCount > 0,
        awayRecord: awayRecordAfter,
        homeRecord: homeRecordAfter,
        awaySeasonOpener,
        homeSeasonOpener
      };
      
      try {
        const response = await fetch('/.netlify/functions/generate-article', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            mode: 'write',
            proofData,
            awayRoster: rosters.away,
            homeRoster: rosters.home,
            schoolData: {
              away: awaySchoolInfo,
              home: homeSchoolInfo
            },
            photographerName: photographerName || null,
            galleryUrl: null
          })
        });
        
        const data = await response.json();
        
        if (data.success) {
          // Store data for later use
          gsGeneratedData = {
            headline: data.headline || '',
            article: data.article || '',
            excerpt: data.excerpt || '',
            proofData: proofData,
            rosters: rosters,
            schoolData: {
              away: awaySchoolInfo,
              home: homeSchoolInfo
            },
            photographerName: photographerName || null
          };
          
          // Show preview step
          document.getElementById('gsMainContent').style.display = 'none';
          document.getElementById('gsStep3').style.display = 'block';
          document.getElementById('gsPreviewHeadline').value = data.headline || '';
          document.getElementById('gsPreviewArticle').value = data.article || '';
          
          // Format article with paragraphs for display
          const articleHtml = (data.article || '').split('\n\n').map(p => `<p style="margin: 0 0 1em 0;">${p}</p>`).join('');
          document.getElementById('gsPreviewArticleDisplay').innerHTML = articleHtml;
          
          // Populate quarter scores box
          document.getElementById('gsPreviewAwayName').textContent = gsSelectedGame.away;
          document.getElementById('gsPreviewHomeName').textContent = gsSelectedGame.home;
          document.getElementById('gsPreviewAwayQ1').textContent = awayQuarters[0] || '-';
          document.getElementById('gsPreviewAwayQ2').textContent = awayQuarters[1] || '-';
          document.getElementById('gsPreviewAwayQ3').textContent = awayQuarters[2] || '-';
          document.getElementById('gsPreviewAwayQ4').textContent = awayQuarters[3] || '-';
          document.getElementById('gsPreviewHomeQ1').textContent = homeQuarters[0] || '-';
          document.getElementById('gsPreviewHomeQ2').textContent = homeQuarters[1] || '-';
          document.getElementById('gsPreviewHomeQ3').textContent = homeQuarters[2] || '-';
          document.getElementById('gsPreviewHomeQ4').textContent = homeQuarters[3] || '-';
          document.getElementById('gsPreviewAwayFinal').textContent = awayFinal;
          document.getElementById('gsPreviewHomeFinal').textContent = homeFinal;
          
          // Handle OT columns
          let otHeadersHtml = '';
          let awayOTHtml = '';
          let homeOTHtml = '';
          for (let i = 4; i < awayQuarters.length; i++) {
            const otNum = i - 3;
            const otLabel = awayQuarters.length === 5 ? 'OT' : `OT${otNum}`;
            otHeadersHtml += `<th style="padding: 8px 6px; font-weight: 500; color: #666;">${otLabel}</th>`;
            awayOTHtml += `<td style="padding: 10px;">${awayQuarters[i] || '-'}</td>`;
            homeOTHtml += `<td style="padding: 10px;">${homeQuarters[i] || '-'}</td>`;
          }
          document.getElementById('gsPreviewOTHeaders').innerHTML = otHeadersHtml;
          document.getElementById('gsPreviewAwayOT').innerHTML = awayOTHtml;
          document.getElementById('gsPreviewHomeOT').innerHTML = homeOTHtml;
          
          // Highlight winner row
          if (awayFinal > homeFinal) {
            document.getElementById('gsPreviewAwayFinal').style.color = '#2e7d32';
            document.getElementById('gsPreviewHomeFinal').style.color = '#333';
          } else {
            document.getElementById('gsPreviewHomeFinal').style.color = '#2e7d32';
            document.getElementById('gsPreviewAwayFinal').style.color = '#333';
          }
          
          // Reset edit mode
          document.getElementById('gsPreviewArticleDisplay').style.display = 'block';
          document.getElementById('gsPreviewArticle').style.display = 'none';
          document.getElementById('gsEditToggleBtn').textContent = '‚úçÔ∏è¬è¬è Edit Text';
          
          showToast('Story generated! Review and edit before generating social posts.', 'success');
        } else {
          showToast(data.error || 'Failed to generate story', 'error');
        }
      } catch (err) {
        console.error('Generation error:', err);
        showToast('Failed to generate story', 'error');
      }
      
      btn.disabled = false;
      btn.textContent = '‚ú® Generate Story';
    }
    
    // Write Your Own - skip AI, go straight to edit with just quarter scores
    function writeYourOwn() {
      const awayFinal = parseInt(document.getElementById('gsAwayFinal').value) || 0;
      const homeFinal = parseInt(document.getElementById('gsHomeFinal').value) || 0;
      
      if (!awayFinal && !homeFinal) {
        showToast('Please enter quarter scores first', 'error');
        return;
      }
      
      // Collect quarters + OT
      const awayQuarters = [
        parseInt(document.getElementById('gsAwayQ1').value) || 0,
        parseInt(document.getElementById('gsAwayQ2').value) || 0,
        parseInt(document.getElementById('gsAwayQ3').value) || 0,
        parseInt(document.getElementById('gsAwayQ4').value) || 0
      ];
      const homeQuarters = [
        parseInt(document.getElementById('gsHomeQ1').value) || 0,
        parseInt(document.getElementById('gsHomeQ2').value) || 0,
        parseInt(document.getElementById('gsHomeQ3').value) || 0,
        parseInt(document.getElementById('gsHomeQ4').value) || 0
      ];
      
      // Add OT if any
      for (let ot = 1; ot <= otCount; ot++) {
        const awayOT = parseInt(document.getElementById(`gsAwayOT${ot}`)?.value) || 0;
        const homeOT = parseInt(document.getElementById(`gsHomeOT${ot}`)?.value) || 0;
        awayQuarters.push(awayOT);
        homeQuarters.push(homeOT);
      }
      
      const awayScorers = collectGSScorers('away');
      const homeScorers = collectGSScorers('home');
      
      // Get school info
      const awaySchoolInfo = getSchoolInfo(gsSelectedGame.away);
      const homeSchoolInfo = getSchoolInfo(gsSelectedGame.home);
      
      // Get selected photographer(s)
      const selectedPhotogs = [];
      document.querySelectorAll('input[name="gsPhotog"]:checked').forEach(cb => {
        selectedPhotogs.push(cb.value);
      });
      const guestPhotog = document.getElementById('gsGuestPhotographer')?.value.trim();
      if (guestPhotog) {
        selectedPhotogs.push(guestPhotog);
      }
      const photographerName = selectedPhotogs.join(' & ');
      
      // Store data for social post generation
      gsGeneratedData = {
        headline: '',
        article: '',
        excerpt: '',
        proofData: {
          awayTeam: gsSelectedGame.away,
          homeTeam: gsSelectedGame.home,
          awayQuarters,
          homeQuarters,
          awayFinal,
          homeFinal,
          awayScorers,
          homeScorers,
          gender: gsSelectedGame.gender || 'Boys',
          division: gsSelectedGame.division || '',
          date: gsSelectedGame.date || '',
          notes: document.getElementById('gsNotes').value.trim(),
          hasOT: otCount > 0
        },
        schoolData: {
          away: awaySchoolInfo,
          home: homeSchoolInfo
        },
        photographerName: photographerName || null
      };
      
      // Show preview step with empty fields
      document.getElementById('gsMainContent').style.display = 'none';
      document.getElementById('gsStep3').style.display = 'block';
      document.getElementById('gsPreviewHeadline').value = '';
      document.getElementById('gsPreviewArticle').value = '';
      document.getElementById('gsPreviewArticleDisplay').innerHTML = '<p style="margin: 0 0 1em 0; color: #888; font-style: italic;">Write your article here...</p>';
      
      // Populate quarter scores box
      document.getElementById('gsPreviewAwayName').textContent = gsSelectedGame.away;
      document.getElementById('gsPreviewHomeName').textContent = gsSelectedGame.home;
      document.getElementById('gsPreviewAwayQ1').textContent = awayQuarters[0] || '-';
      document.getElementById('gsPreviewAwayQ2').textContent = awayQuarters[1] || '-';
      document.getElementById('gsPreviewAwayQ3').textContent = awayQuarters[2] || '-';
      document.getElementById('gsPreviewAwayQ4').textContent = awayQuarters[3] || '-';
      document.getElementById('gsPreviewHomeQ1').textContent = homeQuarters[0] || '-';
      document.getElementById('gsPreviewHomeQ2').textContent = homeQuarters[1] || '-';
      document.getElementById('gsPreviewHomeQ3').textContent = homeQuarters[2] || '-';
      document.getElementById('gsPreviewHomeQ4').textContent = homeQuarters[3] || '-';
      document.getElementById('gsPreviewAwayFinal').textContent = awayFinal;
      document.getElementById('gsPreviewHomeFinal').textContent = homeFinal;
      
      // Handle OT columns
      let otHeadersHtml = '';
      let awayOTHtml = '';
      let homeOTHtml = '';
      for (let i = 4; i < awayQuarters.length; i++) {
        const otNum = i - 3;
        const otLabel = awayQuarters.length === 5 ? 'OT' : `OT${otNum}`;
        otHeadersHtml += `<th style="padding: 8px 6px; font-weight: 500; color: #666;">${otLabel}</th>`;
        awayOTHtml += `<td style="padding: 10px;">${awayQuarters[i] || '-'}</td>`;
        homeOTHtml += `<td style="padding: 10px;">${homeQuarters[i] || '-'}</td>`;
      }
      document.getElementById('gsPreviewOTHeaders').innerHTML = otHeadersHtml;
      document.getElementById('gsPreviewAwayOT').innerHTML = awayOTHtml;
      document.getElementById('gsPreviewHomeOT').innerHTML = homeOTHtml;
      
      // Switch to edit mode immediately so user can start typing
      toggleArticleEdit();
      
      showToast('Enter your headline and article, then generate social posts.', 'success');
    }

    // ==================== BOXSCORE STORY MODAL FUNCTIONS ====================
    let bsSelectedGame = null;
    let bsSelectedDate = new Date();
    
    function newBoxscoreStory() {
      bsSelectedGame = null;
      bsSelectedDate = new Date(); // Start with today
      document.getElementById('boxscoreStoryModal').style.display = 'block';
      document.getElementById('bsStep1').style.display = 'block';
      document.getElementById('bsStep2').style.display = 'none';
      document.getElementById('bsGameSearch').value = '';
      updateBsDateDisplay();
      populateBsGameList();
      document.body.style.overflow = 'hidden';
    }
    
    function closeBoxscoreStory() {
      document.getElementById('boxscoreStoryModal').style.display = 'none';
      document.body.style.overflow = 'auto';
    }
    
    function updateBsDateDisplay() {
      document.getElementById('bsCurrentDate').textContent = formatDateShort(bsSelectedDate);
    }
    
    function bsPrevDay() {
      bsSelectedDate.setDate(bsSelectedDate.getDate() - 1);
      updateBsDateDisplay();
      populateBsGameList();
    }
    
    function bsNextDay() {
      bsSelectedDate.setDate(bsSelectedDate.getDate() + 1);
      updateBsDateDisplay();
      populateBsGameList();
    }
    
    function populateBsGameList() {
      const container = document.getElementById('bsGameList');
      
      // Check if games have loaded
      if (!games || games.length === 0) {
        container.innerHTML = '<div style="padding: 20px; text-align: center; color: #888;">Loading games...</div>';
        setTimeout(() => {
          if (games && games.length > 0) populateBsGameList();
        }, 500);
        return;
      }
      
      const searchFilter = document.getElementById('bsGameSearch').value.toLowerCase();
      const selectedDateStr = getDateString(bsSelectedDate);
      const selectedGender = document.querySelector('input[name="bsGender"]:checked')?.value || 'Men';
      
      // Filter by selected date, gender, and search
      let filtered = games.filter(g => {
        // Must match selected date
        if (g.date !== selectedDateStr) return false;
        // Must match selected gender
        if (g.gender !== selectedGender) return false;
        // Filter by search
        if (searchFilter) {
          const searchStr = `${g.away} ${g.home}`.toLowerCase();
          if (!searchStr.includes(searchFilter)) return false;
        }
        return true;
      });
      
      // Sort by time, then gender
      filtered.sort((a, b) => {
        if (a.time !== b.time) return (a.time || '').localeCompare(b.time || '');
        return (a.gender || '').localeCompare(b.gender || '');
      });
      
      if (filtered.length === 0) {
        const genderLabel = selectedGender.toLowerCase();
        const message = searchFilter 
          ? `No ${genderLabel}'s games found for "${searchFilter}"` 
          : `No ${genderLabel}'s games on this date`;
        container.innerHTML = `<div style="padding: 30px; text-align: center; color: #888; font-size: 13px;">${message}</div>`;
        return;
      }
      
      // Build simple list
      let html = '';
      
      filtered.forEach(g => {
        const hasRecap = g.recap_link && g.recap_link.trim() !== '';
        const rowStyle = hasRecap 
          ? 'background: #f9f9f9; color: #bbb; cursor: not-allowed;' 
          : 'cursor: pointer;';
        const hoverClass = 'game-row-hover';
        const onclick = `onclick="selectGameForBoxscore('${g.game_id}')"`;
        
        html += `
          <div class="${hoverClass}" style="padding: 10px 12px; border-bottom: 1px solid #eee; ${rowStyle}" ${onclick}>
            <span style="font-size: 13px;">${g.away} @ ${g.home}${hasRecap ? ' <span style="font-size: 10px; color: #888;">(redo)</span>' : ''}</span>
          </div>`;
      });
      
      container.innerHTML = html;
    }
    
    function filterBsGameList() {
      populateBsGameList();
    }
    
    function selectGameForBoxscore(gameId) {
      bsSelectedGame = games.find(g => g.game_id === gameId);
      if (!bsSelectedGame) return;
      
      // Move to step 2
      document.getElementById('bsStep1').style.display = 'none';
      document.getElementById('bsStep2').style.display = 'block';
      
      // Set matchup title
      document.getElementById('bsMatchupTitle').textContent = `${bsSelectedGame.away} @ ${bsSelectedGame.home}`;
      
      // Clear boxscore and notes
      document.getElementById('bsBoxscoreText').value = '';
      document.getElementById('bsNotes').value = '';
      
      // Show photographers if assigned
      const photogs = [bsSelectedGame.photog1, bsSelectedGame.photog2].filter(p => p && p.trim());
      const photogDiv = document.getElementById('bsPhotographers');
      const checkboxContainer = document.getElementById('bsPhotogCheckboxes');
      if (photogs.length > 0) {
        checkboxContainer.innerHTML = photogs.map((p, i) => `
          <label style="display: flex; align-items: center; gap: 6px; margin-bottom: 4px; cursor: pointer;">
            <input type="checkbox" name="bsPhotog" value="${p}" checked style="cursor: pointer;">
            <span>${p}</span>
          </label>
        `).join('');
        photogDiv.style.display = 'block';
      } else {
        photogDiv.style.display = 'none';
      }
    }
    
    function backToBsGameSelect() {
      document.getElementById('bsStep1').style.display = 'block';
      document.getElementById('bsStep2').style.display = 'none';
    }
    
    async function generateBoxscoreStory() {
      const boxscoreText = document.getElementById('bsBoxscoreText').value.trim();
      
      if (!boxscoreText) {
        showToast('Please paste the boxscore data first', 'error');
        return;
      }
      
      const btn = document.getElementById('bsGenerateBtn');
      btn.disabled = true;
      btn.textContent = '‚è≥ Writing story...';
      
      // Get selected photographer(s)
      const selectedPhotogs = [];
      document.querySelectorAll('input[name="bsPhotog"]:checked').forEach(cb => {
        selectedPhotogs.push(cb.value);
      });
      // Check for guest photographer
      const guestPhotog = document.getElementById('bsGuestPhotographer')?.value.trim();
      if (guestPhotog) {
        selectedPhotogs.push(guestPhotog);
      }
      const photographerName = selectedPhotogs.join(' & ');
      
      // Get school info
      const awaySchoolInfo = getSchoolInfo(bsSelectedGame.away);
      const homeSchoolInfo = getSchoolInfo(bsSelectedGame.home);
      
      try {
        const response = await fetch('/.netlify/functions/generate-article', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            mode: 'boxscore',
            boxscoreText: boxscoreText,
            gameInfo: {
              awayTeam: bsSelectedGame.away,
              homeTeam: bsSelectedGame.home,
              gender: bsSelectedGame.gender || 'Men',
              division: bsSelectedGame.division || '',
              date: bsSelectedGame.date || ''
            },
            notes: document.getElementById('bsNotes').value.trim(),
            schoolData: {
              away: awaySchoolInfo,
              home: homeSchoolInfo
            },
            photographerName: photographerName || null
          })
        });
        
        const data = await response.json();
        
        if (data.success) {
          // Close modal and open editor with generated content
          closeBoxscoreStory();
          
          // Store generated social posts for later use
          generatedSocialPosts = {
            facebookPost: data.facebookPost || null,
            instagramPost: data.instagramPost || null,
            twitterPost: data.twitterPost || null
          };
          
          // Set up article editor
          currentArticle = null;
          document.getElementById('editorTitle').textContent = 'New Article';
          document.getElementById('articleTitle').value = data.headline || '';
          setEditorContent(data.article || '');
          document.getElementById('articleExcerpt').value = data.excerpt || '';
          document.getElementById('selectedGameId').value = bsSelectedGame.game_id;
          selectedGame = bsSelectedGame;
          document.getElementById('smugmugUrl').value = '';
          document.getElementById('smugmugThumbUrl').value = '';
          document.getElementById('youtubeUrl').value = '';
          setAuthorValue('KJ Cardinal');
          setPhotographerValue(photographerName || '');
          document.getElementById('articleDate').value = getTodayEST();
          isScheduled = false;
          scheduledTime = null;
          document.getElementById('scheduledDateTime').value = '';
          updateScheduleButton();
          document.getElementById('socialPostsCard').style.display = 'block';
          
          // Generate auto tags based on linked game
          currentTags = generateAutoTags();
          renderTags();
          
          document.getElementById('articlesPanel').style.display = 'none';
          document.getElementById('editorPanel').style.display = 'block';
          
          renderGameSelector();
          showToast('Story generated! Review and edit as needed.', 'success');
        } else {
          showToast(data.error || 'Failed to generate story', 'error');
        }
      } catch (err) {
        console.error('Generation error:', err);
        showToast('Failed to generate story', 'error');
      }
      
      btn.disabled = false;
      btn.textContent = '‚ú® Generate Story';
    }
    
    // Helper function to get school info from ROSTERS_DATA
    function getSchoolInfo(schoolName) {
      if (typeof ROSTERS_DATA === 'undefined' || !ROSTERS_DATA.schools) return null;
      
      // Try exact match on shortname first (most reliable)
      for (const [fullName, info] of Object.entries(ROSTERS_DATA.schools)) {
        if (info.shortname === schoolName) {
          return info;
        }
      }
      
      // Try exact match on fullName
      for (const [fullName, info] of Object.entries(ROSTERS_DATA.schools)) {
        if (fullName === schoolName) {
          return info;
        }
      }
      
      // Fallback: partial match, but ONLY if the schoolName is not a substring of another school
      // This prevents "Portsmouth" from matching "Portsmouth Christian"
      const confusableSchools = [
        ['Portsmouth', 'Portsmouth Christian'],
        ['Concord', 'Concord Christian'],
        ['Manchester Central', 'Manchester Memorial', 'Manchester West'],
        ['Bishop Brady', 'Bishop Guertin']
      ];
      
      // Check if this school name could be confused with another
      for (const group of confusableSchools) {
        if (group.includes(schoolName)) {
          // For confusable names, require exact match only
          return null;
        }
      }
      
      // Only use partial matching for non-confusable names
      for (const [fullName, info] of Object.entries(ROSTERS_DATA.schools)) {
        if (fullName.includes(schoolName)) {
          return info;
        }
      }
      return null;
    }

    // Article CRUD
    function newArticle() {
      currentArticle = null;
      currentGameData = null;
      document.getElementById('editorTitle').textContent = 'New Article';
      document.getElementById('articleTitle').value = '';
      setEditorContent(''); // Clear Quill editor
      document.getElementById('articleExcerpt').value = '';
      document.getElementById('selectedGameId').value = '';
      selectedGame = null;
      document.getElementById('smugmugUrl').value = '';
      document.getElementById('smugmugThumbUrl').value = '';
      document.getElementById('youtubeUrl').value = '';
      document.getElementById('videoAutoplay').checked = false;
      document.getElementById('videoStandalone').checked = false;
      document.getElementById('showSponsors').checked = true;
      document.getElementById('manualSponsorId').value = '';
      setAuthorValue('KJ Cardinal');
      setPhotographerValue('');
      document.getElementById('articleDate').value = getTodayEST();
      isScheduled = false;
      scheduledTime = null;
      document.getElementById('scheduledDateTime').value = '';
      updateScheduleButton();
      document.getElementById('socialPostsCard').style.display = 'none';
      
      // Clear featured image
      removeFeaturedImage();
      
      // Clear bonus galleries (silently)
      document.getElementById('bonusGallery1Url').value = '';
      document.getElementById('bonusGallery1ThumbUrl').value = '';
      document.getElementById('bonusGallery1Photographer').value = '';
      document.getElementById('bonusGallery1Preview').style.display = 'none';
      document.getElementById('bonusGallery2Url').value = '';
      document.getElementById('bonusGallery2ThumbUrl').value = '';
      document.getElementById('bonusGallery2Photographer').value = '';
      document.getElementById('bonusGallery2Preview').style.display = 'none';
      
      // Clear generated social posts (this is a manual article)
      generatedSocialPosts = {
        facebookPost: null,
        instagramPost: null,
        twitterPost: null
      };
      
      // Reset tags
      currentTags = [];
      renderTags();
      
      document.getElementById('articlesPanel').style.display = 'none';
      document.getElementById('editorPanel').style.display = 'block';
      
      renderGameSelector();
    }
    
    async function editArticle(id) {
      const article = articles.find(a => a.id === id);
      if (!article) return;
      
      currentArticle = article;
      document.getElementById('editorTitle').textContent = 'Edit Article';
      document.getElementById('articleTitle').value = article.title || '';
      setEditorContent(article.content || ''); // Load into Quill editor
      document.getElementById('articleExcerpt').value = article.excerpt || '';
      document.getElementById('selectedGameId').value = article.game_id || '';
      selectedGame = article.game_id ? games.find(g => g.game_id === article.game_id) : null;
      document.getElementById('smugmugUrl').value = article.smugmug_gallery_url || '';
      document.getElementById('youtubeUrl').value = article.youtube_url || '';
      document.getElementById('videoAutoplay').checked = article.video_autoplay || false;
      document.getElementById('videoStandalone').checked = article.video_standalone || false;
      document.getElementById('showSponsors').checked = article.show_sponsors !== false;
      document.getElementById('manualSponsorId').value = article.manual_sponsor_id || '';
      setAuthorValue(article.author || 'KJ Cardinal');
      setPhotographerValue(article.photographer || article.game_data?.photographerName || '');
      
      // Handle article date
      if (article.article_date) {
        document.getElementById('articleDate').value = article.article_date;
      } else if (article.published_at) {
        // Fallback to published_at date
        document.getElementById('articleDate').value = article.published_at.split('T')[0];
      } else {
        document.getElementById('articleDate').value = getTodayEST();
      }
      
      // Handle featured image
      if (article.featured_image_url) {
        document.getElementById('featuredImageUrl').value = article.featured_image_url;
        document.getElementById('featuredImageCaptionField').value = article.featured_image_caption || '';
        document.getElementById('featuredImageContainer').classList.add('has-image');
        document.getElementById('featuredImagePlaceholder').style.display = 'none';
        document.getElementById('featuredImagePreview').style.display = 'block';
        document.getElementById('featuredImageImg').src = article.featured_image_url;
      } else {
        removeFeaturedImage();
      }
      
      // Handle bonus galleries
      document.getElementById('bonusGallery1Url').value = article.bonus_gallery_1_url || '';
      document.getElementById('bonusGallery1ThumbUrl').value = article.bonus_gallery_1_thumb || '';
      document.getElementById('bonusGallery1Photographer').value = article.bonus_gallery_1_photographer || '';
      updateBonusGalleryPreview(1);
      
      document.getElementById('bonusGallery2Url').value = article.bonus_gallery_2_url || '';
      document.getElementById('bonusGallery2ThumbUrl').value = article.bonus_gallery_2_thumb || '';
      document.getElementById('bonusGallery2Photographer').value = article.bonus_gallery_2_photographer || '';
      updateBonusGalleryPreview(2);
      
      // Handle scheduling
      if (article.scheduled_at) {
        isScheduled = true;
        scheduledTime = article.scheduled_at.slice(0, 16);
        document.getElementById('scheduledDateTime').value = scheduledTime;
      } else {
        isScheduled = false;
        scheduledTime = null;
        document.getElementById('scheduledDateTime').value = '';
      }
      updateScheduleButton();
      
      // Handle tags
      currentTags = article.tags || [];
      if (currentTags.length === 0) {
        currentTags = generateAutoTags();
      }
      renderTags();
      
      // Handle social posts
      if (article.social_posts) {
        generatedSocialPosts = article.social_posts;
        document.getElementById('socialPostsCard').style.display = 'block';
      } else {
        generatedSocialPosts = {
          facebookPost: null,
          instagramPost: null,
          twitterPost: null
        };
        document.getElementById('socialPostsCard').style.display = 'none';
      }
      
      // Handle game data (quarter scores, player stats)
      currentGameData = article.game_data || null;
      
      document.getElementById('articlesPanel').style.display = 'none';
      document.getElementById('editorPanel').style.display = 'block';
      
      renderGameSelector();
    }
    
    function closeEditor() {
      document.getElementById('editorPanel').style.display = 'none';
      document.getElementById('articlesPanel').style.display = 'block';
      currentArticle = null;
    }
    
    function showSocialPublishing(article) {
      // Hide editor, show social publishing panel
      document.getElementById('editorPanel').style.display = 'none';
      document.getElementById('socialPublishingPanel').style.display = 'block';
      
      // Populate the textareas
      const fbPost = generatedSocialPosts.facebookPost || '';
      const igPost = generatedSocialPosts.instagramPost || '';
      const twPost = generatedSocialPosts.twitterPost || '';
      
      document.getElementById('socialFacebookPost').value = fbPost;
      document.getElementById('socialInstagramPost').value = igPost;
      document.getElementById('socialTwitterPost').value = twPost;
      
      // Update character counts
      updateCharCount('facebook');
      updateCharCount('instagram');
      updateCharCount('twitter');
      
      // Add input listeners for character counts
      document.getElementById('socialFacebookPost').oninput = () => updateCharCount('facebook');
      document.getElementById('socialInstagramPost').oninput = () => updateCharCount('instagram');
      document.getElementById('socialTwitterPost').oninput = () => updateCharCount('twitter');
    }
    
    function closeSocialPublishing() {
      document.getElementById('socialPublishingPanel').style.display = 'none';
      document.getElementById('articlesPanel').style.display = 'block';
      
      // Don't clear generatedSocialPosts - they're stored with the article
      // and can be re-accessed via the View Social Posts button
    }
    
    async function saveSocialPosts() {
      if (!currentArticle || !currentArticle.id) {
        showToast('No article to save to - please publish first', 'error');
        return;
      }
      
      // Get the edited values from the textareas
      const fbPost = document.getElementById('socialFacebookPost').value;
      const igPost = document.getElementById('socialInstagramPost').value;
      const twPost = document.getElementById('socialTwitterPost').value;
      
      // Update the generatedSocialPosts object
      generatedSocialPosts.facebookPost = fbPost;
      generatedSocialPosts.instagramPost = igPost;
      generatedSocialPosts.twitterPost = twPost;
      
      // Build social posts object for storage
      const socialPosts = {
        facebookPost: fbPost || null,
        instagramPost: igPost || null,
        twitterPost: twPost || null
      };
      
      // Save to database - match pattern used in saveAndPreviewSocial
      const result = await db
        .from('articles')
        .update({ 
          social_posts: socialPosts,
          updated_at: new Date().toISOString()
        })
        .eq('id', currentArticle.id)
        .select();
      
      if (result.error) {
        console.error('Error saving social posts:', result.error);
        showToast('Error saving social posts', 'error');
        return;
      }
      
      // Update currentArticle from result
      if (result.data && result.data[0]) {
        currentArticle = result.data[0];
      }
      
      // Refresh articles list
      loadArticles();
      
      showToast('Social posts saved!', 'success');
    }
    
    function updateCharCount(platform) {
      const textareaId = `social${platform.charAt(0).toUpperCase() + platform.slice(1)}Post`;
      const text = document.getElementById(textareaId).value;
      const count = text.length;
      
      if (platform === 'facebook') {
        document.getElementById('fbCharCount').textContent = count;
      } else if (platform === 'instagram') {
        document.getElementById('igCharCount').textContent = count;
        document.getElementById('igCharCount').style.color = count > 2200 ? '#c00' : '#888';
      } else if (platform === 'twitter') {
        document.getElementById('twCharCount').textContent = count;
        document.getElementById('twCharCount').style.color = count > 280 ? '#c00' : '#888';
      }
    }
    
    function copySocialPost(platform) {
      const textareaId = `social${platform.charAt(0).toUpperCase() + platform.slice(1)}Post`;
      const text = document.getElementById(textareaId).value;
      
      navigator.clipboard.writeText(text).then(() => {
        showToast(`${platform.charAt(0).toUpperCase() + platform.slice(1)} post copied!`, 'success');
      }).catch(err => {
        console.error('Copy failed:', err);
        showToast('Failed to copy', 'error');
      });
    }
    
    function generateSlug(title) {
      return title
        .toLowerCase()
        .replace(/[^a-z0-9]+/g, '-')
        .replace(/(^-|-$)/g, '')
        .substring(0, 60);
    }
    
    async function saveArticle() {
      const title = document.getElementById('articleTitle').value.trim();
      if (!title) {
        showToast('Please enter a headline', 'error');
        return;
      }
      
      // Check if this was a published article (will unpublish it)
      const wasPublished = currentArticle && currentArticle.status === 'published';
      
      // Handle scheduling
      let scheduledAt = null;
      if (isScheduled && scheduledTime) {
        scheduledAt = new Date(scheduledTime).toISOString();
      }
      
      // Build social posts object for storage (same as publish)
      const socialPosts = (generatedSocialPosts.facebookPost || generatedSocialPosts.instagramPost || generatedSocialPosts.twitterPost) ? {
        facebookPost: generatedSocialPosts.facebookPost || null,
        instagramPost: generatedSocialPosts.instagramPost || null,
        twitterPost: generatedSocialPosts.twitterPost || null
      } : null;
      
      const articleData = {
        title,
        slug: currentArticle?.slug || (generateSlug(title) + '-' + Date.now()),
        content: getEditorContent(), // Get from Quill
        excerpt: document.getElementById('articleExcerpt').value,
        game_id: document.getElementById('selectedGameId').value || null,
        smugmug_gallery_url: document.getElementById('smugmugUrl').value || null,
        youtube_url: document.getElementById('youtubeUrl').value || null,
        video_autoplay: document.getElementById('videoAutoplay').checked,
        video_standalone: document.getElementById('videoStandalone').checked,
        show_sponsors: document.getElementById('showSponsors').checked,
        manual_sponsor_id: document.getElementById('manualSponsorId').value || null,
        featured_image_url: document.getElementById('featuredImageUrl').value || null,
        featured_image_caption: document.getElementById('featuredImageCaptionField').value || null,
        author: getAuthorValue(),
        photographer: getPhotographerValue() || null,
        bonus_gallery_1_url: document.getElementById('bonusGallery1Url').value.trim() || null,
        bonus_gallery_1_thumb: document.getElementById('bonusGallery1ThumbUrl').value.trim() || null,
        bonus_gallery_1_photographer: document.getElementById('bonusGallery1Photographer').value.trim() || null,
        bonus_gallery_2_url: document.getElementById('bonusGallery2Url').value.trim() || null,
        bonus_gallery_2_thumb: document.getElementById('bonusGallery2ThumbUrl').value.trim() || null,
        bonus_gallery_2_photographer: document.getElementById('bonusGallery2Photographer').value.trim() || null,
        tags: currentTags,
        article_date: document.getElementById('articleDate').value || null,
        scheduled_at: scheduledAt,
        social_posts: socialPosts,
        game_data: currentGameData || null,
        status: 'draft',
        published_at: null, // Clear published_at when saving as draft
        updated_at: new Date().toISOString()
      };
      
      let result;
      if (currentArticle) {
        result = await db
          .from('articles')
          .update(articleData)
          .eq('id', currentArticle.id)
          .select();
      } else {
        result = await db
          .from('articles')
          .insert([articleData])
          .select();
      }
      
      if (result.error) {
        console.error('Save error:', result.error);
        showToast('Error saving article', 'error');
        return;
      }
      
      if (wasPublished) {
        showToast('Article unpublished and saved as draft!', 'success');
      } else {
        showToast('Article saved!', 'success');
      }
      currentArticle = result.data[0];
      loadArticles();
    }
    
    async function saveAndPreviewSocial() {
      // First save the article
      const title = document.getElementById('articleTitle').value.trim();
      if (!title) {
        showToast('Please enter a headline', 'error');
        return;
      }
      
      // Handle scheduling
      let scheduledAt = null;
      if (isScheduled && scheduledTime) {
        scheduledAt = new Date(scheduledTime).toISOString();
      }
      
      // Build social posts object for storage
      const socialPosts = (generatedSocialPosts.facebookPost || generatedSocialPosts.instagramPost || generatedSocialPosts.twitterPost) ? {
        facebookPost: generatedSocialPosts.facebookPost || null,
        instagramPost: generatedSocialPosts.instagramPost || null,
        twitterPost: generatedSocialPosts.twitterPost || null
      } : null;
      
      const articleData = {
        title,
        slug: currentArticle?.slug || (generateSlug(title) + '-' + Date.now()),
        content: getEditorContent(), // Get from Quill
        excerpt: document.getElementById('articleExcerpt').value,
        game_id: document.getElementById('selectedGameId').value || null,
        smugmug_gallery_url: document.getElementById('smugmugUrl').value || null,
        youtube_url: document.getElementById('youtubeUrl').value || null,
        video_autoplay: document.getElementById('videoAutoplay').checked,
        video_standalone: document.getElementById('videoStandalone').checked,
        show_sponsors: document.getElementById('showSponsors').checked,
        manual_sponsor_id: document.getElementById('manualSponsorId').value || null,
        featured_image_url: document.getElementById('featuredImageUrl').value || null,
        featured_image_caption: document.getElementById('featuredImageCaptionField').value || null,
        author: getAuthorValue(),
        photographer: getPhotographerValue() || null,
        bonus_gallery_1_url: document.getElementById('bonusGallery1Url').value.trim() || null,
        bonus_gallery_1_thumb: document.getElementById('bonusGallery1ThumbUrl').value.trim() || null,
        bonus_gallery_1_photographer: document.getElementById('bonusGallery1Photographer').value.trim() || null,
        bonus_gallery_2_url: document.getElementById('bonusGallery2Url').value.trim() || null,
        bonus_gallery_2_thumb: document.getElementById('bonusGallery2ThumbUrl').value.trim() || null,
        bonus_gallery_2_photographer: document.getElementById('bonusGallery2Photographer').value.trim() || null,
        tags: currentTags,
        article_date: document.getElementById('articleDate').value || null,
        social_posts: socialPosts,
        scheduled_at: scheduledAt,
        status: 'draft',
        updated_at: new Date().toISOString()
      };
      
      let result;
      if (currentArticle) {
        result = await db
          .from('articles')
          .update(articleData)
          .eq('id', currentArticle.id)
          .select();
      } else {
        result = await db
          .from('articles')
          .insert([articleData])
          .select();
      }
      
      if (result.error) {
        console.error('Save error:', result.error);
        showToast('Error saving article', 'error');
        return;
      }
      
      currentArticle = result.data[0];
      loadArticles();
      
      // Check if we have social posts to preview
      if (generatedSocialPosts.facebookPost || generatedSocialPosts.instagramPost || generatedSocialPosts.twitterPost) {
        showToast('Draft saved! Opening social preview...', 'success');
        showSocialPublishing(currentArticle);
      } else {
        // Show preview modal instead (which shows social posts placeholder)
        showToast('Draft saved! Note: Use Scorebook or Boxscore Story to generate social posts.', 'success');
        openPreview();
      }
    }
    
    async function publishArticle() {
      const title = document.getElementById('articleTitle').value.trim();
      if (!title) {
        showToast('Please enter a headline', 'error');
        return;
      }
      
      const gameId = document.getElementById('selectedGameId').value || null;
      const smugmugUrl = document.getElementById('smugmugUrl').value || null;
      const youtubeUrl = document.getElementById('youtubeUrl').value || null;
      const slug = currentArticle?.slug || (generateSlug(title) + '-' + Date.now());
      
      // Check if scheduling
      let scheduledAt = null;
      if (isScheduled && scheduledTime) {
        scheduledAt = new Date(scheduledTime).toISOString();
      }
      
      // Use currentTags (which may have been edited by user)
      // Refresh auto tags first to make sure we have latest
      if (currentTags.length === 0) {
        currentTags = generateAutoTags();
      }
      
      // Build social posts object for storage
      const socialPosts = (generatedSocialPosts.facebookPost || generatedSocialPosts.instagramPost || generatedSocialPosts.twitterPost) ? {
        facebookPost: generatedSocialPosts.facebookPost || null,
        instagramPost: generatedSocialPosts.instagramPost || null,
        twitterPost: generatedSocialPosts.twitterPost || null
      } : null;
      
      const articleData = {
        title,
        slug,
        content: getEditorContent(), // Get from Quill
        excerpt: document.getElementById('articleExcerpt').value,
        game_id: gameId,
        smugmug_gallery_url: smugmugUrl,
        youtube_url: youtubeUrl,
        video_autoplay: document.getElementById('videoAutoplay').checked,
        video_standalone: document.getElementById('videoStandalone').checked,
        show_sponsors: document.getElementById('showSponsors').checked,
        manual_sponsor_id: document.getElementById('manualSponsorId').value || null,
        featured_image_url: document.getElementById('featuredImageUrl').value || null,
        featured_image_caption: document.getElementById('featuredImageCaptionField').value || null,
        author: getAuthorValue(),
        photographer: getPhotographerValue() || null,
        bonus_gallery_1_url: document.getElementById('bonusGallery1Url').value.trim() || null,
        bonus_gallery_1_thumb: document.getElementById('bonusGallery1ThumbUrl').value.trim() || null,
        bonus_gallery_1_photographer: document.getElementById('bonusGallery1Photographer').value.trim() || null,
        bonus_gallery_2_url: document.getElementById('bonusGallery2Url').value.trim() || null,
        bonus_gallery_2_thumb: document.getElementById('bonusGallery2ThumbUrl').value.trim() || null,
        bonus_gallery_2_photographer: document.getElementById('bonusGallery2Photographer').value.trim() || null,
        tags: currentTags,
        article_date: document.getElementById('articleDate').value || null,
        social_posts: socialPosts,
        game_data: currentGameData || currentArticle?.game_data || null,
        scheduled_at: scheduledAt,
        status: isScheduled ? 'scheduled' : 'published',
        published_at: isScheduled ? null : new Date().toISOString(),
        updated_at: new Date().toISOString()
      };
      
      let result;
      if (currentArticle) {
        result = await db
          .from('articles')
          .update(articleData)
          .eq('id', currentArticle.id)
          .select();
      } else {
        result = await db
          .from('articles')
          .insert([articleData])
          .select();
      }
      
      if (result.error) {
        console.error('Publish error:', result.error);
        showToast('Error publishing article', 'error');
        return;
      }
      
      currentArticle = result.data[0];
      
      // Update game record with URLs if we have a game linked (and not scheduled)
      if (gameId && selectedGame && !isScheduled) {
        const gameUpdate = {};
        const articleUrl = `https://ball603.com/article/${slug}`;
        const smugmugThumbUrl = document.getElementById('smugmugThumbUrl').value || null;
        
        gameUpdate.recap_url = articleUrl;
        if (smugmugUrl) gameUpdate.photos_url = smugmugUrl;
        if (smugmugThumbUrl) gameUpdate.photos_thumb_url = smugmugThumbUrl;
        if (youtubeUrl) gameUpdate.highlights_url = youtubeUrl;
        
        const { error: gameError } = await db
          .from('games')
          .update(gameUpdate)
          .eq('game_id', gameId);
        
        if (gameError) {
          console.error('Error updating game:', gameError);
        }
      }
      
      if (isScheduled) {
        showToast(`Article scheduled for ${formatDateTime(scheduledAt)}!`, 'success');
        closeEditor();
      } else {
        showToast('Article published!', 'success');
        loadArticles();
        
        // Show social publishing page if we have generated posts
        if (generatedSocialPosts.facebookPost || generatedSocialPosts.instagramPost || generatedSocialPosts.twitterPost) {
          showSocialPublishing(currentArticle);
        } else {
          closeEditor();
        }
      }
    }
    
    async function deleteArticle(id) {
      // Find the article to check if it's linked to a game
      const article = articles.find(a => a.id === id);
      
      if (article && article.game_id) {
        // Article is linked to a game - offer to clear URLs
        const game = allGames.find(g => g.game_id === article.game_id);
        const gameLabel = game ? `${game.away_team} @ ${game.home_team} (${game.date})` : article.game_id;
        
        const clearUrls = confirm(
          `This article is linked to:\n${gameLabel}\n\n` +
          `Do you want to also clear the coverage URLs (photos, recap, highlights) from this game?\n\n` +
          `Click OK to delete article AND clear URLs\n` +
          `Click Cancel to just delete the article`
        );
        
        // First, always confirm the delete itself
        if (!confirm('Delete this article?')) return;
        
        // Delete the article
        const { error } = await db
          .from('articles')
          .delete()
          .eq('id', id);
        
        if (error) {
          showToast('Error deleting article', 'error');
          return;
        }
        
        // If user wanted to clear URLs, do that too
        if (clearUrls && game) {
          try {
            const response = await fetch(`/.netlify/functions/games?id=${game.id}`, {
              method: 'PUT',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                photos_url: null,
                photos_thumb_url: null,
                recap_url: null,
                highlights_url: null
              })
            });
            
            if (response.ok) {
              // Update local game data
              game.photos_url = null;
              game.photos_thumb_url = null;
              game.recap_url = null;
              game.highlights_url = null;
              showToast('Article deleted & URLs cleared', 'success');
            } else {
              showToast('Article deleted (URL clear failed)', 'warning');
            }
          } catch (err) {
            console.error('Error clearing game URLs:', err);
            showToast('Article deleted (URL clear failed)', 'warning');
          }
        } else {
          showToast('Article deleted', 'success');
        }
      } else {
        // No game linked - simple delete
        if (!confirm('Delete this article?')) return;
        
        const { error } = await db
          .from('articles')
          .delete()
          .eq('id', id);
        
        if (error) {
          showToast('Error deleting article', 'error');
          return;
        }
        
        showToast('Article deleted', 'success');
      }
      
      loadArticles();
    }
    
    // AI Generation
    let scorePhotoBase64 = null;
    let extractedData = null;
    
    function previewScorePhoto(input) {
      const file = input.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
          scorePhotoBase64 = e.target.result;
          document.getElementById('photoPreviewImg').src = scorePhotoBase64;
          document.getElementById('photoPreview').style.display = 'block';
        };
        reader.readAsDataURL(file);
      }
    }
    
    function clearScorePhoto() {
      scorePhotoBase64 = null;
      document.getElementById('scorePhoto').value = '';
      document.getElementById('photoPreview').style.display = 'none';
    }
    
    // Get rosters for selected teams
    
    // Update roster status when game is selected
    async function updateRosterStatus() {
      const status = document.getElementById('rosterStatus');
      if (!selectedGame) {
        status.textContent = '‚ö†Ô∏è Select a game above to enable roster matching';
        status.style.color = '#e65100';
        return;
      }
      
      const rosters = await getTeamRosters();
      const hasAway = !!rosters.away;
      const hasHome = !!rosters.home;
      
      if (hasAway && hasHome) {
        status.innerHTML = `‚úçÔ∏è‚Ä¶ Rosters loaded: <strong>${selectedGame.away}</strong> & <strong>${selectedGame.home}</strong>`;
        status.style.color = '#2e7d32';
      } else if (hasAway || hasHome) {
        const missing = !hasAway ? selectedGame.away : selectedGame.home;
        status.innerHTML = `‚ö†Ô∏è Roster missing for: <strong>${missing}</strong>`;
        status.style.color = '#e65100';
      } else {
        status.innerHTML = `‚ö†Ô∏è No rosters found for either team`;
        status.style.color = '#e65100';
      }
    }
    
    // Add scorer row to proof form
    async function addScorerRow(team, data = {}) {
      const container = document.getElementById(team + 'Scorers');
      const rosters = await getTeamRosters();
      const roster = team === 'away' ? rosters.away : rosters.home;
      
      const row = document.createElement('div');
      row.style.cssText = 'display: flex; gap: 5px; margin-bottom: 5px; align-items: center;';
      
      // Build player dropdown if roster available
      let playerSelect = '';
      if (roster && roster.players) {
        playerSelect = `<select style="flex: 2; padding: 4px; font-size: 12px;" onchange="this.nextElementSibling.value=this.value">
          <option value="">-- Select --</option>
          ${roster.players.map(p => `<option value="${p.name}" ${data.name === p.name ? 'selected' : ''}>#${p.number} ${p.name} (${p.class})</option>`).join('')}
        </select>`;
      }
      
      row.innerHTML = `
        ${playerSelect}
        <input type="text" placeholder="Player name" value="${data.name || ''}" style="flex: 2; padding: 4px; font-size: 12px;">
        <input type="text" placeholder="Pts" value="${data.points || ''}" style="width: 35px; padding: 4px; font-size: 12px; text-align: center;">
        <button type="button" onclick="this.parentElement.remove()" style="background: #ffebee; border: none; padding: 4px 8px; border-radius: 3px; cursor: pointer; color: #c62828; font-size: 11px;">‚úï</button>
      `;
      container.appendChild(row);
    }
    
    // Extract box score from image
    async function extractBoxScore() {
      if (!scorePhotoBase64 && !document.getElementById('aiInput').value.trim()) {
        showToast('Please upload a scorebook photo or enter notes', 'error');
        return;
      }
      
      if (!selectedGame) {
        showToast('Please select a game first to enable roster matching', 'error');
        return;
      }
      
      const btn = document.getElementById('btnExtract');
      btn.disabled = true;
      btn.innerHTML = '‚è≥ Reading scorebook...';
      
      const rosters = await getTeamRosters();
      const notes = document.getElementById('aiInput').value.trim();
      
      try {
        const response = await fetch('/.netlify/functions/generate-article', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            mode: 'extract',
            image: scorePhotoBase64,
            notes: notes,
            gameInfo: {
              away: selectedGame.away,
              home: selectedGame.home,
              gender: selectedGame.gender,
              date: selectedGame.date,
              division: selectedGame.division
            },
            awayRoster: rosters.away,
            homeRoster: rosters.home
          })
        });
        
        const data = await response.json();
        
        if (data.success && data.extracted) {
          extractedData = data.extracted;
          populateProofForm(data.extracted);
          document.getElementById('aiStep1').style.display = 'none';
          document.getElementById('aiStep2').style.display = 'block';
          showToast('Box score extracted! Please verify and edit if needed.', 'success');
        } else {
          showToast(data.error || 'Failed to extract box score', 'error');
        }
      } catch (err) {
        console.error('Extract error:', err);
        showToast('Failed to extract box score', 'error');
      }
      
      btn.disabled = false;
      btn.innerHTML = 'üîç‚Äπ Extract & Review';
    }
    
    // Populate proof form with extracted data
    function populateProofForm(data) {
      // Team names
      document.getElementById('proofAwayTeam').textContent = selectedGame.away;
      document.getElementById('proofHomeTeam').textContent = selectedGame.home;
      document.getElementById('awayScorerLabel').textContent = selectedGame.away + ' Scorers';
      document.getElementById('homeScorerLabel').textContent = selectedGame.home + ' Scorers';
      
      // Quarter scores
      document.getElementById('awayQ1').value = data.awayQuarters?.[0] || '';
      document.getElementById('awayQ2').value = data.awayQuarters?.[1] || '';
      document.getElementById('awayQ3').value = data.awayQuarters?.[2] || '';
      document.getElementById('awayQ4').value = data.awayQuarters?.[3] || '';
      document.getElementById('awayFinal').value = data.awayFinal || '';
      
      document.getElementById('homeQ1').value = data.homeQuarters?.[0] || '';
      document.getElementById('homeQ2').value = data.homeQuarters?.[1] || '';
      document.getElementById('homeQ3').value = data.homeQuarters?.[2] || '';
      document.getElementById('homeQ4').value = data.homeQuarters?.[3] || '';
      document.getElementById('homeFinal').value = data.homeFinal || '';
      
      // Clear and populate scorers
      document.getElementById('awayScorers').innerHTML = '';
      document.getElementById('homeScorers').innerHTML = '';
      
      (data.awayScorers || []).forEach(s => addScorerRow('away', s));
      (data.homeScorers || []).forEach(s => addScorerRow('home', s));
      
      // Add empty rows if none
      if (!data.awayScorers?.length) addScorerRow('away');
      if (!data.homeScorers?.length) addScorerRow('home');
      
      // Notes
      document.getElementById('proofNotes').value = data.notes || '';
    }
    
    // Go back to upload step
    function backToUpload() {
      document.getElementById('aiStep1').style.display = 'block';
      document.getElementById('aiStep2').style.display = 'none';
    }
    
    // Collect data from proof form
    function collectProofData() {
      const awayScorers = [];
      document.querySelectorAll('#awayScorers > div').forEach(row => {
        const inputs = row.querySelectorAll('input[type="text"]');
        const name = inputs[inputs.length - 2]?.value?.trim();
        const points = inputs[inputs.length - 1]?.value?.trim();
        if (name && points) awayScorers.push({ name, points });
      });
      
      const homeScorers = [];
      document.querySelectorAll('#homeScorers > div').forEach(row => {
        const inputs = row.querySelectorAll('input[type="text"]');
        const name = inputs[inputs.length - 2]?.value?.trim();
        const points = inputs[inputs.length - 1]?.value?.trim();
        if (name && points) homeScorers.push({ name, points });
      });
      
      return {
        awayTeam: selectedGame.away,
        homeTeam: selectedGame.home,
        gender: selectedGame.gender,
        division: selectedGame.division,
        date: selectedGame.date,
        awayQuarters: [
          document.getElementById('awayQ1').value,
          document.getElementById('awayQ2').value,
          document.getElementById('awayQ3').value,
          document.getElementById('awayQ4').value
        ],
        homeQuarters: [
          document.getElementById('homeQ1').value,
          document.getElementById('homeQ2').value,
          document.getElementById('homeQ3').value,
          document.getElementById('homeQ4').value
        ],
        awayFinal: document.getElementById('awayFinal').value,
        homeFinal: document.getElementById('homeFinal').value,
        awayScorers,
        homeScorers,
        notes: document.getElementById('proofNotes').value
      };
    }
    
    // Generate article from confirmed proof data
    // Generate article from manual box score entry
    async function generateArticle() {
      // Validate quarters entered
      const awayFinal = parseInt(document.getElementById('awayFinal').value) || 0;
      const homeFinal = parseInt(document.getElementById('homeFinal').value) || 0;
      
      if (!awayFinal && !homeFinal) {
        showToast('Please enter quarter scores first', 'error');
        return;
      }
      
      // Collect quarter scores
      const awayQuarters = [
        parseInt(document.getElementById('awayQ1').value) || 0,
        parseInt(document.getElementById('awayQ2').value) || 0,
        parseInt(document.getElementById('awayQ3').value) || 0,
        parseInt(document.getElementById('awayQ4').value) || 0
      ];
      const homeQuarters = [
        parseInt(document.getElementById('homeQ1').value) || 0,
        parseInt(document.getElementById('homeQ2').value) || 0,
        parseInt(document.getElementById('homeQ3').value) || 0,
        parseInt(document.getElementById('homeQ4').value) || 0
      ];
      
      // Collect scorers from roster entries
      const awayScorers = collectScorers('away');
      const homeScorers = collectScorers('home');
      
      // Validate points match
      const awayPtsTotal = awayScorers.reduce((sum, s) => sum + s.points, 0);
      const homePtsTotal = homeScorers.reduce((sum, s) => sum + s.points, 0);
      
      if (awayPtsTotal !== awayFinal) {
        showToast(`${selectedGame.away} points (${awayPtsTotal}) don't match final (${awayFinal})`, 'error');
        return;
      }
      if (homePtsTotal !== homeFinal) {
        showToast(`${selectedGame.home} points (${homePtsTotal}) don't match final (${homeFinal})`, 'error');
        return;
      }
      
      const btn = document.getElementById('btnGenerate');
      btn.disabled = true;
      btn.innerHTML = '‚è≥ Writing article...';
      
      const rosters = await getTeamRosters();
      const notes = document.getElementById('gameNotes').value.trim();
      
      const proofData = {
        awayTeam: selectedGame.away,
        homeTeam: selectedGame.home,
        awayQuarters: awayQuarters,
        homeQuarters: homeQuarters,
        awayFinal: awayFinal,
        homeFinal: homeFinal,
        awayScorers: awayScorers,
        homeScorers: homeScorers,
        gender: selectedGame.gender || 'Boys',
        division: selectedGame.division || '',
        date: selectedGame.date || '',
        notes: notes
      };
      
      try {
        const response = await fetch('/.netlify/functions/generate-article', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            mode: 'write',
            proofData: proofData,
            awayRoster: rosters.away,
            homeRoster: rosters.home
          })
        });
        
        const data = await response.json();
        
        if (data.success) {
          if (data.headline) {
            document.getElementById('articleTitle').value = data.headline;
          }
          if (data.article) {
            setEditorContent(data.article || '');
          }
          if (data.excerpt) {
            document.getElementById('articleExcerpt').value = data.excerpt;
          }
          
          showToast('Article generated! Review and edit as needed.', 'success');
        } else {
          showToast(data.error || 'Failed to generate article', 'error');
        }
      } catch (err) {
        console.error('Generation error:', err);
        showToast('Failed to generate article', 'error');
      }
      
      btn.disabled = false;
      btn.innerHTML = '‚ú® Generate Article';
    }
    
    // Collect scorers from roster entry section
    function collectScorers(team) {
      const container = document.getElementById(team + 'RosterEntry');
      const scorers = [];
      
      // Roster players with points
      container.querySelectorAll('.pts-input[data-player]').forEach(input => {
        const pts = parseInt(input.value) || 0;
        if (pts > 0) {
          const name = input.getAttribute('data-player');
          const threePtInput = container.querySelector(`.threept-input[data-player="${name}"]`);
          const threePts = parseInt(threePtInput?.value) || 0;
          scorers.push({ name: name, points: pts, threePointers: threePts });
        }
      });
      
      // Manual entries
      container.querySelectorAll('.manual-name').forEach(nameInput => {
        const name = nameInput.value.trim();
        if (name) {
          const row = nameInput.parentElement;
          const ptsInput = row.querySelector('.manual-pts');
          const threePtInput = row.querySelector('.threept-input');
          const pts = parseInt(ptsInput?.value) || 0;
          const threePts = parseInt(threePtInput?.value) || 0;
          if (pts > 0) {
            scorers.push({ name: name, points: pts, threePointers: threePts });
          }
        }
      });
      
      // Sort by points descending
      scorers.sort((a, b) => b.points - a.points);
      return scorers;
    }

    async function generateFromProof() {
      const proofData = collectProofData();
      
      if (!proofData.awayFinal || !proofData.homeFinal) {
        showToast('Please enter final scores', 'error');
        return;
      }
      
      const btn = document.getElementById('btnGenerate');
      btn.disabled = true;
      btn.innerHTML = '‚è≥ Writing article...';
      
      const rosters = await getTeamRosters();
      
      try {
        const response = await fetch('/.netlify/functions/generate-article', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            mode: 'write',
            proofData: proofData,
            awayRoster: rosters.away,
            homeRoster: rosters.home
          })
        });
        
        const data = await response.json();
        
        if (data.success) {
          if (data.headline) {
            document.getElementById('articleTitle').value = data.headline;
          }
          if (data.article) {
            setEditorContent(data.article || '');
          }
          if (data.excerpt) {
            document.getElementById('articleExcerpt').value = data.excerpt;
          }
          
          // Reset AI section
          backToUpload();
          clearScorePhoto();
          document.getElementById('aiInput').value = '';
          
          showToast('Article generated! Review and edit as needed.', 'success');
        } else {
          showToast(data.error || 'Failed to generate article', 'error');
        }
      } catch (err) {
        console.error('Generation error:', err);
        showToast('Failed to generate article', 'error');
      }
      
      btn.disabled = false;
      btn.innerHTML = '‚ú® Generate Article';
    }
    
    // Social posting
    // Toast
    function showToast(message, type = 'success') {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.className = `toast ${type}`;
      toast.style.display = 'block';
      setTimeout(() => toast.style.display = 'none', 3000);
    }
    
    // Sponsors & Products (placeholders)
    function newSponsor() {
      showToast('Sponsor management coming soon!', 'error');
    }
    
    function newProduct() {
      showToast('Product management coming soon!', 'error');
    }
    
    // ==========================================
    // TEAM MANAGER FUNCTIONS
    // ==========================================
    let allTeams = [];
    let importTeamsData = [];
    
    async function loadTeams() {
      document.getElementById('teamList').innerHTML = `
        <div class="article-row header" style="grid-template-columns: 50px 1fr 100px 80px 80px 100px 120px;">
          <div>Logo</div>
          <div>Team</div>
          <div>Level</div>
          <div>Division</div>
          <div>Gender</div>
          <div>Location</div>
          <div>Actions</div>
        </div>
        <div class="loading">Loading teams...</div>
      `;
      
      try {
        const response = await fetch('/.netlify/functions/teams');
        const data = await response.json();
        
        if (data.success) {
          allTeams = data.teams || [];
          filterTeams();
        } else {
          showToast('Error loading teams', 'error');
        }
      } catch (err) {
        console.error('Error loading teams:', err);
        showToast('Could not connect to server', 'error');
      }
    }
    
    function filterTeams() {
      const level = document.getElementById('teamLevelFilter').value;
      const division = document.getElementById('teamDivisionFilter').value;
      const gender = document.getElementById('teamGenderFilter').value;
      const search = document.getElementById('teamSearchBox').value.toLowerCase();
      
      let filtered = allTeams.filter(t => {
        if (level && t.level !== level) return false;
        if (division && t.division !== division) return false;
        if (gender && t.gender !== gender) return false;
        if (search) {
          const searchStr = `${t.shortname} ${t.full_name} ${t.mascot} ${t.location}`.toLowerCase();
          if (!searchStr.includes(search)) return false;
        }
        return true;
      });
      
      renderTeamList(filtered);
    }
    
    function renderTeamList(teams) {
      const list = document.getElementById('teamList');
      const activeCount = teams.filter(t => t.active).length;
      
      document.getElementById('teamCount').textContent = `${teams.length} team${teams.length !== 1 ? 's' : ''}`;
      document.getElementById('teamActiveCount').textContent = activeCount < teams.length ? `(${activeCount} active)` : '';
      
      if (teams.length === 0) {
        list.innerHTML = `
          <div class="article-row header" style="grid-template-columns: 50px 1fr 100px 80px 80px 100px 120px;">
            <div>Logo</div>
            <div>Team</div>
            <div>Level</div>
            <div>Division</div>
            <div>Gender</div>
            <div>Location</div>
            <div>Actions</div>
          </div>
          <div class="empty-state">
            <p>No teams found</p>
            <button class="btn-new" onclick="openTeamModal()">Add your first team</button>
          </div>
        `;
        return;
      }
      
      list.innerHTML = `
        <div class="article-row header" style="grid-template-columns: 50px 1fr 100px 80px 80px 100px 120px;">
          <div>Logo</div>
          <div>Team</div>
          <div>Level</div>
          <div>Division</div>
          <div>Gender</div>
          <div>Location</div>
          <div>Actions</div>
        </div>
        ${teams.map(team => {
          const logoName = (team.shortname || '').replace(/[^a-zA-Z0-9]/g, '');
          const logoSrc = team.logo_url || `/logos/100px/${logoName}.png`;
          return `
          <div class="article-row" style="grid-template-columns: 50px 1fr 100px 80px 80px 100px 120px; ${!team.active ? 'opacity: 0.5;' : ''}">
            <div style="text-align: center;">
              <img src="${logoSrc}" alt="" style="width: 32px; height: 32px; object-fit: contain;" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
              <span style="display: none; font-size: 18px;">üèÄ</span>
            </div>
            <div>
              <div style="font-weight: 500; color: #333;">
                ${team.shortname} ${team.emoji || ''}
                ${team.combined_team ? '<span style="background: #e3f2fd; color: #1565c0; font-size: 9px; padding: 2px 5px; border-radius: 3px; margin-left: 5px;">COMBINED</span>' : ''}
              </div>
              <div style="font-size: 11px; color: #888;">${team.mascot || ''} ${team.abbrev ? '(' + team.abbrev + ')' : ''}</div>
            </div>
            <div style="font-size: 12px;">${team.level === 'High School' ? 'HS' : team.level === 'Prep School' ? 'Prep' : 'College'}</div>
            <div style="font-size: 12px;">${team.division || '-'}</div>
            <div style="font-size: 12px;">${team.gender || '-'}</div>
            <div style="font-size: 12px; color: #666;">${team.location || '-'}</div>
            <div class="article-actions">
              <button class="btn-edit" onclick="editTeam(${team.id})">Edit</button>
              <button class="btn-delete" onclick="deleteTeam(${team.id}, '${team.shortname}')">Delete</button>
            </div>
          </div>
        `}).join('')}
      `;
    }
    
    function openTeamModal(team = null) {
      document.getElementById('teamModalTitle').textContent = team ? 'Edit Team' : 'Add Team';
      document.getElementById('teamModal').style.display = 'block';
      document.body.style.overflow = 'hidden';
      
      // Load available logos into dropdown
      loadAvailableLogos().then(() => {
        // After logos load, set the correct value if editing
        if (team?.logo_filename) {
          document.getElementById('teamLogoSelect').value = team.logo_filename;
        }
        updateLogoPreview();
      });
      
      // Reset form
      document.getElementById('teamId').value = team?.id || '';
      document.getElementById('teamFullName').value = team?.full_name || '';
      document.getElementById('teamShortname').value = team?.shortname || '';
      document.getElementById('teamAbbrev').value = team?.abbrev || '';
      document.getElementById('teamEmoji').value = team?.emoji || '';
      document.getElementById('teamMascot').value = team?.mascot || '';
      document.getElementById('teamLevel').value = team?.level || 'High School';
      updateDivisionOptions();
      document.getElementById('teamDivision').value = team?.division || '';
      document.getElementById('teamGender').value = team?.gender || '';
      document.getElementById('teamLocation').value = team?.location || '';
      document.getElementById('teamConference').value = team?.conference || '';
      document.getElementById('teamPrimaryHex').value = team?.primary_hex || '';
      document.getElementById('teamPrimaryHexPicker').value = team?.primary_hex || '#000000';
      document.getElementById('teamSecondaryHex').value = team?.secondary_hex || '';
      document.getElementById('teamSecondaryHexPicker').value = team?.secondary_hex || '#ffffff';
      document.getElementById('teamWebsite').value = team?.website || '';
      document.getElementById('teamLivestream').value = team?.livestream_url || '';
      document.getElementById('teamNotes').value = team?.notes || '';
      document.getElementById('teamActive').checked = team?.active !== false;
      
      // Logo - set both fields for compatibility
      document.getElementById('teamLogoUrl').value = team?.logo_url || '';
      document.getElementById('teamLogoFilename').value = team?.logo_filename || '';
      
      // Set the dropdown value
      const logoSelect = document.getElementById('teamLogoSelect');
      if (logoSelect && team?.logo_filename) {
        logoSelect.value = team.logo_filename;
      } else if (logoSelect) {
        logoSelect.value = '';
      }
      
      // Combined team handling
      document.getElementById('teamCombined').checked = team?.combined_team || false;
      selectedCombinedTeamIds = team?.combined_with || [];
      toggleCombinedSection();
      renderSelectedCombinedTeams();
      
      // Update logo preview
      updateLogoPreview();
    }
    
    // Update logo preview based on dropdown selection
    function updateLogoPreview() {
      const logoFilename = document.getElementById('teamLogoFilename').value || document.getElementById('teamLogoSelect').value;
      const container = document.getElementById('teamLogoPreview');
      
      if (logoFilename) {
        container.innerHTML = `<img src="/logos/100px/${logoFilename}" alt="Team logo" style="max-width: 100%; max-height: 100%; object-fit: contain;" onerror="this.parentElement.innerHTML='<span style=\\'color: #f44336; font-size: 11px; text-align: center;\\'>Logo not<br>found</span>'">`;
      } else {
        container.innerHTML = '<span style="color: #ccc; font-size: 12px; text-align: center;">No logo<br>selected</span>';
      }
    }
    
    // When a logo is selected from dropdown
    function onLogoSelected() {
      const selected = document.getElementById('teamLogoSelect').value;
      document.getElementById('teamLogoFilename').value = selected;
      updateLogoPreview();
    }
    
    // Load available logos into dropdown
    async function loadAvailableLogos() {
      try {
        const response = await fetch('/.netlify/functions/team-logos?list=true');
        const data = await response.json();
        
        if (data.success && data.logos) {
          const select = document.getElementById('teamLogoSelect');
          // Keep the first "No Logo" option
          select.innerHTML = '<option value="">-- No Logo --</option>';
          
          data.logos.forEach(logo => {
            const option = document.createElement('option');
            option.value = logo;
            // Display name without .png
            option.textContent = logo.replace('.png', '');
            select.appendChild(option);
          });
        }
      } catch (err) {
        console.error('Failed to load logo list:', err);
      }
    }
    
    // Combined team variables and functions
    let selectedCombinedTeamIds = [];
    
    function toggleCombinedSection() {
      const isChecked = document.getElementById('teamCombined').checked;
      document.getElementById('combinedTeamSection').style.display = isChecked ? 'block' : 'none';
      if (isChecked) {
        renderCombinedTeamList();
      }
    }
    
    function renderCombinedTeamList(filter = '') {
      const currentTeamId = parseInt(document.getElementById('teamId').value) || 0;
      const currentGender = document.getElementById('teamGender').value;
      const currentLevel = document.getElementById('teamLevel').value;
      
      // Filter to same gender and level, exclude current team
      let eligibleTeams = allTeams.filter(t => 
        t.id !== currentTeamId &&
        t.gender === currentGender &&
        t.level === currentLevel
      );
      
      if (filter) {
        const search = filter.toLowerCase();
        eligibleTeams = eligibleTeams.filter(t => 
          t.shortname.toLowerCase().includes(search) ||
          t.full_name.toLowerCase().includes(search)
        );
      }
      
      const list = document.getElementById('combinedTeamList');
      
      if (eligibleTeams.length === 0) {
        list.innerHTML = '<div style="padding: 10px; color: #888; font-size: 12px;">No matching teams found</div>';
        return;
      }
      
      list.innerHTML = eligibleTeams.slice(0, 30).map(t => `
        <div style="padding: 8px 12px; border-bottom: 1px solid #eee; cursor: pointer; font-size: 13px; display: flex; align-items: center; gap: 8px; ${selectedCombinedTeamIds.includes(t.id) ? 'background: #fff3e0;' : ''}" 
             onclick="toggleCombinedTeam(${t.id}, '${t.shortname}', '${t.emoji || ''}')">
          <input type="checkbox" ${selectedCombinedTeamIds.includes(t.id) ? 'checked' : ''} style="pointer-events: none;">
          <span>${t.emoji || ''}</span>
          <span>${t.shortname}</span>
          <span style="color: #888; font-size: 11px;">${t.gender || ''}</span>
        </div>
      `).join('');
    }
    
    function filterCombinedTeams() {
      const filter = document.getElementById('combinedTeamSearch').value;
      renderCombinedTeamList(filter);
    }
    
    function toggleCombinedTeam(teamId, shortname, emoji) {
      const idx = selectedCombinedTeamIds.indexOf(teamId);
      if (idx > -1) {
        selectedCombinedTeamIds.splice(idx, 1);
      } else {
        selectedCombinedTeamIds.push(teamId);
      }
      renderCombinedTeamList(document.getElementById('combinedTeamSearch').value);
      renderSelectedCombinedTeams();
    }
    
    function renderSelectedCombinedTeams() {
      const container = document.getElementById('selectedCombinedTeams');
      
      if (selectedCombinedTeamIds.length === 0) {
        container.innerHTML = '<span style="font-size: 12px; color: #888;">No teams selected</span>';
        return;
      }
      
      const selectedTeams = allTeams.filter(t => selectedCombinedTeamIds.includes(t.id));
      container.innerHTML = selectedTeams.map(t => `
        <span style="background: #f57c00; color: white; padding: 4px 10px; border-radius: 20px; font-size: 12px; display: inline-flex; align-items: center; gap: 5px;">
          ${t.emoji || ''} ${t.shortname}
          <span style="cursor: pointer; margin-left: 3px;" onclick="removeCombinedTeam(${t.id})">&times;</span>
        </span>
      `).join('');
    }
    
    function removeCombinedTeam(teamId) {
      selectedCombinedTeamIds = selectedCombinedTeamIds.filter(id => id !== teamId);
      renderCombinedTeamList(document.getElementById('combinedTeamSearch').value);
      renderSelectedCombinedTeams();
    }
    
    function closeTeamModal() {
      document.getElementById('teamModal').style.display = 'none';
      document.body.style.overflow = 'auto';
    }
    
    function updateDivisionOptions() {
      const level = document.getElementById('teamLevel').value;
      const divSelect = document.getElementById('teamDivision');
      const currentVal = divSelect.value;
      
      if (level === 'High School') {
        divSelect.innerHTML = `
          <option value="">None</option>
          <option value="D1">D1</option>
          <option value="D2">D2</option>
          <option value="D3">D3</option>
          <option value="D4">D4</option>
        `;
      } else if (level === 'Prep School') {
        divSelect.innerHTML = `
          <option value="">None</option>
          <option value="NEPSAC">NEPSAC</option>
        `;
      } else {
        divSelect.innerHTML = `
          <option value="">None</option>
          <option value="DI">DI (NCAA)</option>
          <option value="DII">DII (NCAA)</option>
          <option value="DIII">DIII (NCAA)</option>
        `;
      }
      
      // Try to restore previous value if still valid
      const validOptions = [...divSelect.options].map(o => o.value);
      if (validOptions.includes(currentVal)) {
        divSelect.value = currentVal;
      }
    }
    
    function syncColorPicker(pickerId, hexValue) {
      if (/^#[0-9A-Fa-f]{6}$/.test(hexValue)) {
        document.getElementById(pickerId).value = hexValue;
      }
    }
    
    async function editTeam(teamId) {
      const team = allTeams.find(t => t.id === teamId);
      if (team) {
        openTeamModal(team);
      }
    }
    
    async function saveTeam() {
      const teamId = document.getElementById('teamId').value;
      const teamData = {
        full_name: document.getElementById('teamFullName').value.trim(),
        shortname: document.getElementById('teamShortname').value.trim(),
        abbrev: document.getElementById('teamAbbrev').value.trim().toUpperCase(),
        emoji: document.getElementById('teamEmoji').value.trim() || null,
        mascot: document.getElementById('teamMascot').value.trim() || null,
        level: document.getElementById('teamLevel').value,
        division: document.getElementById('teamDivision').value || null,
        gender: document.getElementById('teamGender').value || null,
        location: document.getElementById('teamLocation').value.trim() || null,
        conference: document.getElementById('teamConference').value.trim() || null,
        primary_hex: document.getElementById('teamPrimaryHex').value.trim() || null,
        secondary_hex: document.getElementById('teamSecondaryHex').value.trim() || null,
        website: document.getElementById('teamWebsite').value.trim() || null,
        livestream_url: document.getElementById('teamLivestream').value.trim() || null,
        logo_url: document.getElementById('teamLogoUrl').value.trim() || null,
        logo_filename: document.getElementById('teamLogoFilename').value.trim() || null,
        notes: document.getElementById('teamNotes').value.trim() || null,
        active: document.getElementById('teamActive').checked,
        combined_team: document.getElementById('teamCombined').checked,
        combined_with: document.getElementById('teamCombined').checked && selectedCombinedTeamIds.length > 0 
          ? selectedCombinedTeamIds 
          : null
      };
      
      // Validation
      if (!teamData.full_name || !teamData.shortname || !teamData.abbrev || !teamData.level) {
        showToast('Please fill in required fields', 'error');
        return;
      }
      
      try {
        const url = teamId 
          ? `/.netlify/functions/teams?id=${teamId}` 
          : '/.netlify/functions/teams';
        
        const response = await fetch(url, {
          method: teamId ? 'PUT' : 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(teamData)
        });
        
        const result = await response.json();
        
        if (result.success) {
          showToast(teamId ? 'Team updated!' : 'Team created!', 'success');
          closeTeamModal();
          loadTeams();
        } else {
          showToast(result.error || 'Error saving team', 'error');
        }
      } catch (err) {
        console.error('Error saving team:', err);
        showToast('Could not save team', 'error');
      }
    }
    
    async function deleteTeam(teamId, teamName) {
      if (!confirm(`Are you sure you want to delete ${teamName}?`)) return;
      
      try {
        const response = await fetch(`/.netlify/functions/teams?id=${teamId}`, {
          method: 'DELETE'
        });
        
        const result = await response.json();
        
        if (result.success) {
          showToast('Team deleted', 'success');
          loadTeams();
        } else {
          showToast(result.error || 'Error deleting team', 'error');
        }
      } catch (err) {
        console.error('Error deleting team:', err);
        showToast('Could not delete team', 'error');
      }
    }
    
    // CSV Import Functions
    function openImportModal() {
      document.getElementById('importModal').style.display = 'block';
      document.body.style.overflow = 'hidden';
      document.getElementById('importPreview').style.display = 'none';
      document.getElementById('importResults').style.display = 'none';
      document.getElementById('btnExecuteImport').disabled = true;
      importTeamsData = [];
    }
    
    function closeImportModal() {
      document.getElementById('importModal').style.display = 'none';
      document.body.style.overflow = 'auto';
    }
    
    function handleCsvFile(file) {
      if (!file) return;
      
      const reader = new FileReader();
      reader.onload = function(e) {
        const csv = e.target.result;
        parseCsv(csv, file.name);
      };
      reader.readAsText(file);
    }
    
    function parseCsv(csv, filename) {
      const lines = csv.split('\n').filter(line => line.trim());
      if (lines.length < 2) {
        showToast('CSV file appears empty', 'error');
        return;
      }
      
      // Detect delimiter (tab or comma)
      const firstLine = lines[0];
      const delimiter = firstLine.includes('\t') ? '\t' : ',';
      
      const headers = firstLine.split(delimiter).map(h => h.trim().toLowerCase().replace(/[^a-z0-9_\s]/g, ''));
      const teams = [];
      
      // Header mapping from Google Sheets to database columns
      const headerMap = {
        'team id': '_skip',
        'full school name': 'full_name',
        'fullschoolname': 'full_name',
        'full_name': 'full_name',
        'fullname': 'full_name',
        'name': 'full_name',
        'shortname': 'shortname',
        'short': 'shortname',
        'abbrev': 'abbrev',
        'abbr': 'abbrev',
        'abbreviation': 'abbrev',
        'level': 'level',
        'conference': 'conference',
        'gender': 'gender',
        'division': 'division',
        'location': 'location',
        'town': 'location',
        'city': 'location',
        'mascot': 'mascot',
        'primary color': 'primary_color',
        'primarycolor': 'primary_color',
        'primary_color': 'primary_color',
        'primary hex': 'primary_hex',
        'primaryhex': 'primary_hex',
        'primary_hex': 'primary_hex',
        'secondary color': 'secondary_color',
        'secondarycolor': 'secondary_color',
        'secondary_color': 'secondary_color',
        'secondary hex': 'secondary_hex',
        'secondaryhex': 'secondary_hex',
        'secondary_hex': 'secondary_hex',
        'official website': 'website',
        'officialwebsite': 'website',
        'website': 'website',
        'live stream link': 'livestream_url',
        'livestreamlink': 'livestream_url',
        'livestream_url': 'livestream_url',
        'livestream': 'livestream_url',
        'combined team': 'combined_team',
        'combinedteam': 'combined_team',
        'combined_team': 'combined_team',
        'combined with team ids': 'combined_with',
        'combinedwithteamids': 'combined_with',
        'combined_with': 'combined_with',
        'active': 'active',
        'active_': 'active',
        'notes': 'notes',
        'emoji': 'emoji'
      };
      
      for (let i = 1; i < lines.length; i++) {
        const values = delimiter === '\t' ? lines[i].split('\t') : parseCSVLine(lines[i]);
        
        // Allow slight mismatch in column count (some CSVs have trailing commas)
        if (values.length < headers.length - 1) continue;
        
        const team = {};
        headers.forEach((h, idx) => {
          let val = values[idx]?.trim() || null;
          
          // Map header to database column
          const dbColumn = headerMap[h] || h.replace(/\s+/g, '_');
          
          // Skip certain columns
          if (dbColumn === '_skip' || !dbColumn) return;
          
          // Handle boolean fields
          if (dbColumn === 'active' || dbColumn === 'combined_team') {
            if (val === null || val === '') {
              val = dbColumn === 'active' ? true : false;
            } else {
              val = val.toLowerCase() === 'true' || val === '1' || val.toLowerCase() === 'yes';
            }
          }
          
          // Handle combined_with as array (skip for now, complex)
          if (dbColumn === 'combined_with' && val) {
            // Could parse comma-separated IDs, but skip for initial import
            return;
          }
          
          team[dbColumn] = val;
        });
        
        // Only add if has required fields
        if (team.full_name && team.shortname && team.abbrev && team.level) {
          teams.push(team);
        }
      }
      
      console.log('Parsed headers:', headers);
      console.log('First team parsed:', teams[0] || 'none');
      
      if (teams.length === 0) {
        console.log('Header mapping check:', headers.map(h => h + ' -> ' + (headerMap[h] || h.replace(/\s+/g, '_'))));
        showToast('No valid teams found in CSV. Check required fields: Full School Name, Shortname, abbrev, Level', 'error');
        return;
      }
      
      importTeamsData = teams;
      showImportPreview(teams, filename);
    }
    
    function parseCSVLine(line) {
      const result = [];
      let current = '';
      let inQuotes = false;
      
      for (let i = 0; i < line.length; i++) {
        const char = line[i];
        if (char === '"') {
          inQuotes = !inQuotes;
        } else if (char === ',' && !inQuotes) {
          result.push(current);
          current = '';
        } else {
          current += char;
        }
      }
      result.push(current);
      return result;
    }
    
    function parseCSV(text) {
      // Split by newlines, handling both \r\n and \n
      const lines = text.split(/\r?\n/).filter(line => line.trim());
      return lines.map(line => parseCSVLine(line));
    }
    
    function showImportPreview(teams, filename) {
      document.getElementById('importPreview').style.display = 'block';
      document.getElementById('importPreviewCount').textContent = `${teams.length} teams ready to import`;
      document.getElementById('importPreviewFile').textContent = filename;
      document.getElementById('btnExecuteImport').disabled = false;
      
      const tbody = document.getElementById('importPreviewBody');
      tbody.innerHTML = teams.slice(0, 50).map(t => `
        <tr>
          <td style="padding: 6px 8px;">${t.shortname}</td>
          <td style="padding: 6px 8px;">${t.full_name}</td>
          <td style="padding: 6px 8px;">${t.level}</td>
          <td style="padding: 6px 8px;">${t.division || '-'}</td>
        </tr>
      `).join('');
      
      if (teams.length > 50) {
        tbody.innerHTML += `<tr><td colspan="4" style="padding: 8px; color: #888; text-align: center;">...and ${teams.length - 50} more</td></tr>`;
      }
    }
    
    async function executeImport() {
      if (importTeamsData.length === 0) return;
      
      document.getElementById('btnExecuteImport').disabled = true;
      document.getElementById('btnExecuteImport').textContent = 'Importing...';
      
      try {
        const response = await fetch('/.netlify/functions/teams', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ teams: importTeamsData })
        });
        
        const result = await response.json();
        
        const resultsDiv = document.getElementById('importResults');
        resultsDiv.style.display = 'block';
        
        if (result.success) {
          resultsDiv.style.background = '#e8f5e9';
          resultsDiv.innerHTML = `
            <strong style="color: #2e7d32;">‚úî Import Complete</strong><br>
            <span style="font-size: 13px;">${result.results.inserted} inserted, ${result.results.updated} updated</span>
          `;
          showToast('Teams imported successfully!', 'success');
          loadTeams();
        } else {
          resultsDiv.style.background = '#ffebee';
          resultsDiv.innerHTML = `
            <strong style="color: #c62828;">Import had errors</strong><br>
            <span style="font-size: 13px;">${result.results?.inserted || 0} inserted, ${result.results?.updated || 0} updated, ${result.results?.errors?.length || 0} errors</span>
            ${result.results?.errors?.length ? '<br><small>' + result.results.errors.slice(0, 5).map(e => e.team + ': ' + e.error).join('<br>') + '</small>' : ''}
          `;
        }
      } catch (err) {
        console.error('Import error:', err);
        showToast('Import failed', 'error');
      }
      
      document.getElementById('btnExecuteImport').textContent = 'Import Teams';
    }
    
    function exportTeams() {
      if (allTeams.length === 0) {
        showToast('No teams to export', 'error');
        return;
      }
      
      const headers = ['full_name', 'shortname', 'abbrev', 'emoji', 'mascot', 'level', 'division', 'gender', 'location', 'conference', 'primary_color', 'primary_hex', 'secondary_color', 'secondary_hex', 'website', 'livestream_url', 'active'];
      
      let csv = headers.join(',') + '\n';
      
      allTeams.forEach(team => {
        const row = headers.map(h => {
          let val = team[h];
          if (val === null || val === undefined) return '';
          if (typeof val === 'boolean') return val ? 'true' : 'false';
          val = String(val);
          if (val.includes(',') || val.includes('"') || val.includes('\n')) {
            return '"' + val.replace(/"/g, '""') + '"';
          }
          return val;
        });
        csv += row.join(',') + '\n';
      });
      
      const blob = new Blob([csv], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `ball603-teams-${new Date().toISOString().split('T')[0]}.csv`;
      a.click();
      URL.revokeObjectURL(url);
      
      showToast('Teams exported!', 'success');
    }
    
    // ==================== CONTRIBUTOR MANAGER ====================
    
    let allContributors = [];
    
    async function loadContributors() {
      document.getElementById('contributorList').innerHTML = `
        <div class="article-row header" style="grid-template-columns: 50px 1fr 150px 120px 100px 120px;">
          <div></div>
          <div>Name</div>
          <div>Type</div>
          <div>Area</div>
          <div>Status</div>
          <div>Actions</div>
        </div>
        <div class="loading">Loading contributors...</div>
      `;
      
      const { data, error } = await db
        .from('contributors')
        .select('*')
        .order('name');
      
      if (error) {
        console.error('Error loading contributors:', error);
        showToast('Error loading contributors', 'error');
        return;
      }
      
      allContributors = data || [];
      filterContributors();
      updateEmailLists();
    }
    
    function filterContributors() {
      const typeFilter = document.getElementById('contributorTypeFilter').value;
      const statusFilter = document.getElementById('contributorStatusFilter').value;
      const search = document.getElementById('contributorSearch').value.toLowerCase();
      
      let filtered = allContributors;
      
      // Type filter
      if (typeFilter === 'photographer') filtered = filtered.filter(c => c.is_photographer);
      else if (typeFilter === 'videographer') filtered = filtered.filter(c => c.is_videographer);
      else if (typeFilter === 'writer') filtered = filtered.filter(c => c.is_writer);
      else if (typeFilter === 'graphics') filtered = filtered.filter(c => c.is_graphics);
      else if (typeFilter === 'administrative') filtered = filtered.filter(c => c.is_administrative);
      
      // Status filter
      if (statusFilter === 'active') filtered = filtered.filter(c => c.active);
      else if (statusFilter === 'inactive') filtered = filtered.filter(c => !c.active);
      
      // Search
      if (search) {
        filtered = filtered.filter(c => 
          c.name.toLowerCase().includes(search) ||
          (c.email && c.email.toLowerCase().includes(search)) ||
          (c.primary_area && c.primary_area.toLowerCase().includes(search))
        );
      }
      
      renderContributorList(filtered);
    }
    
    function renderContributorList(contributors) {
      const list = document.getElementById('contributorList');
      
      document.getElementById('contributorCount').textContent = `${contributors.length} contributor${contributors.length !== 1 ? 's' : ''}`;
      
      if (contributors.length === 0) {
        list.innerHTML = `
          <div class="article-row header" style="grid-template-columns: 50px 1fr 150px 120px 100px 120px;">
            <div></div>
            <div>Name</div>
            <div>Type</div>
            <div>Area</div>
            <div>Status</div>
            <div>Actions</div>
          </div>
          <div class="empty-state">
            <p>No contributors found</p>
          </div>
        `;
        return;
      }
      
      list.innerHTML = `
        <div class="article-row header" style="grid-template-columns: 50px 1fr 150px 120px 100px 120px;">
          <div></div>
          <div>Name</div>
          <div>Type</div>
          <div>Area</div>
          <div>Status</div>
          <div>Actions</div>
        </div>
        ${contributors.map(c => {
          const types = [];
          if (c.is_photographer) types.push('üì∏');
          if (c.is_videographer) types.push('üé•');
          if (c.is_writer) types.push('‚úçÔ∏è¬è¬è');
          if (c.is_graphics) types.push('üé®');
          if (c.is_administrative) types.push('üîç¬ß');
          
          return `
          <div class="article-row" style="grid-template-columns: 50px 1fr 150px 120px 100px 120px; ${!c.active ? 'opacity: 0.5;' : ''}">
            <div style="text-align: center;">
              ${c.headshot_url ? `<img src="${c.headshot_url}" style="width: 36px; height: 36px; border-radius: 50%; object-fit: cover;">` : '<span style="font-size: 24px;">üëç¬§</span>'}
            </div>
            <div>
              <div style="font-weight: 500; color: #333;">${c.name}</div>
              <div style="font-size: 11px; color: #888;">${c.email}</div>
            </div>
            <div style="font-size: 16px;">${types.join(' ') || '-'}</div>
            <div style="font-size: 12px; color: #666;">${c.primary_area || '-'}</div>
            <div>
              <button onclick="toggleContributorActive(${c.id}, ${!c.active})" style="background: ${c.active ? '#e8f5e9' : '#ffebee'}; color: ${c.active ? '#2e7d32' : '#c62828'}; border: none; padding: 4px 10px; border-radius: 12px; font-size: 11px; cursor: pointer;">
                ${c.active ? 'Active' : 'Inactive'}
              </button>
            </div>
            <div class="article-actions">
              <button class="btn-edit" onclick="editContributor(${c.id})">Edit</button>
            </div>
          </div>
        `}).join('')}
      `;
    }
    
    function updateEmailLists() {
      const active = allContributors.filter(c => c.active);
      
      document.getElementById('emailListAll').value = active.map(c => c.email).join(', ');
      document.getElementById('emailListPhotog').value = active.filter(c => c.is_photographer).map(c => c.email).join(', ');
      document.getElementById('emailListVideog').value = active.filter(c => c.is_videographer).map(c => c.email).join(', ');
      document.getElementById('emailListWriter').value = active.filter(c => c.is_writer).map(c => c.email).join(', ');
      document.getElementById('emailListGraphics').value = active.filter(c => c.is_graphics).map(c => c.email).join(', ');
    }
    
    function toggleEmailLists() {
      const container = document.getElementById('emailListsContainer');
      const btn = document.getElementById('emailListToggle');
      if (container.style.display === 'none') {
        container.style.display = 'block';
        btn.textContent = 'Hide Lists ‚ñ≤';
      } else {
        container.style.display = 'none';
        btn.textContent = 'Show Lists ‚ñº';
      }
    }
    
    function copyEmailList(id) {
      const textarea = document.getElementById(id);
      navigator.clipboard.writeText(textarea.value);
      showToast('Email list copied!', 'success');
    }
    
    async function toggleContributorActive(id, active) {
      const { error } = await db
        .from('contributors')
        .update({ active, updated_at: new Date().toISOString() })
        .eq('id', id);
      
      if (error) {
        showToast('Error updating status', 'error');
        return;
      }
      
      const contrib = allContributors.find(c => c.id === id);
      if (contrib) contrib.active = active;
      filterContributors();
      updateEmailLists();
      showToast(active ? 'Contributor activated' : 'Contributor deactivated', 'success');
    }
    
    function editContributor(id) {
      const contrib = allContributors.find(c => c.id === id);
      if (!contrib) return;
      
      document.getElementById('contributorModalTitle').textContent = 'Edit Contributor';
      document.getElementById('contributorModal').style.display = 'block';
      document.body.style.overflow = 'hidden';
      
      document.getElementById('contributorId').value = contrib.id;
      document.getElementById('contribName').value = contrib.name || '';
      document.getElementById('contribEmail').value = contrib.email || '';
      document.getElementById('contribPrimaryArea').value = contrib.primary_area || '';
      document.getElementById('contribCell').value = contrib.cell || '';
      document.getElementById('contribAddress').value = contrib.mailing_address || '';
      document.getElementById('contribVenmo').value = contrib.venmo || '';
      document.getElementById('contribShirtSize').value = contrib.shirt_size || '';
      document.getElementById('contribSmugmugName').value = contrib.smugmug_name || '';
      
      document.getElementById('contribIsPhotographer').checked = contrib.is_photographer || false;
      document.getElementById('contribIsVideographer').checked = contrib.is_videographer || false;
      document.getElementById('contribIsWriter').checked = contrib.is_writer || false;
      document.getElementById('contribIsGraphics').checked = contrib.is_graphics || false;
      document.getElementById('contribIsAdministrative').checked = contrib.is_administrative || false;
      
      document.getElementById('contribTop10Url').value = contrib.top10_dropbox_url || '';
      document.getElementById('contribActive').checked = contrib.active !== false;
      
      // Show auth status if they have an auth account
      document.getElementById('contribAuthStatus').style.display = contrib.auth_user_id ? 'block' : 'none';
    }
    
    function closeContributorModal() {
      document.getElementById('contributorModal').style.display = 'none';
      document.body.style.overflow = 'auto';
    }
    
    async function saveContributor() {
      const id = document.getElementById('contributorId').value;
      
      const updateData = {
        name: document.getElementById('contribName').value.trim(),
        email: document.getElementById('contribEmail').value.trim(),
        primary_area: document.getElementById('contribPrimaryArea').value.trim() || null,
        cell: document.getElementById('contribCell').value.trim() || null,
        mailing_address: document.getElementById('contribAddress').value.trim() || null,
        venmo: document.getElementById('contribVenmo').value.trim() || null,
        shirt_size: document.getElementById('contribShirtSize').value || null,
        smugmug_name: document.getElementById('contribSmugmugName').value.trim() || null,
        is_photographer: document.getElementById('contribIsPhotographer').checked,
        is_videographer: document.getElementById('contribIsVideographer').checked,
        is_writer: document.getElementById('contribIsWriter').checked,
        is_graphics: document.getElementById('contribIsGraphics').checked,
        is_administrative: document.getElementById('contribIsAdministrative').checked,
        top10_dropbox_url: document.getElementById('contribTop10Url').value.trim() || null,
        active: document.getElementById('contribActive').checked,
        updated_at: new Date().toISOString()
      };
      
      if (!updateData.name || !updateData.email) {
        showToast('Name and email are required', 'error');
        return;
      }
      
      const { error } = await db
        .from('contributors')
        .update(updateData)
        .eq('id', id);
      
      if (error) {
        showToast('Error saving contributor', 'error');
        return;
      }
      
      closeContributorModal();
      loadContributors();
      showToast('Contributor saved!', 'success');
    }
    
    async function deleteContributor() {
      const id = document.getElementById('contributorId').value;
      const name = document.getElementById('contribName').value;
      
      if (!id) return;
      
      if (!confirm(`Are you sure you want to delete ${name}?\n\nThis will also delete their login account and cannot be undone.`)) {
        return;
      }
      
      try {
        const response = await fetch('/.netlify/functions/contributor-invite', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ action: 'delete', contributorId: parseInt(id) })
        });
        
        const result = await response.json();
        
        if (result.success) {
          closeContributorModal();
          loadContributors();
          showToast(result.message, 'success');
        } else {
          showToast('Error: ' + (result.error || 'Unknown error'), 'error');
        }
      } catch (err) {
        showToast('Error deleting contributor', 'error');
      }
    }
    
    function showCreateAccount() {
      document.getElementById('createAccountModal').style.display = 'block';
      document.body.style.overflow = 'hidden';
      document.getElementById('createName').value = '';
      document.getElementById('createEmail').value = '';
      document.getElementById('createPassword').value = 'Gr@niteSt@teHoops';
    }
    
    function closeCreateAccountModal() {
      document.getElementById('createAccountModal').style.display = 'none';
      document.body.style.overflow = 'auto';
    }
    
    async function createAccount() {
      const name = document.getElementById('createName').value.trim();
      const email = document.getElementById('createEmail').value.trim();
      const password = document.getElementById('createPassword').value;
      
      if (!name || !email || !password) {
        showToast('Name, email, and password are required', 'error');
        return;
      }
      
      try {
        const response = await fetch('/.netlify/functions/contributor-invite', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            action: 'create-account',
            name,
            email,
            password
          })
        });
        
        const result = await response.json();
        
        if (result.success) {
          showToast(result.message, 'success');
          closeCreateAccountModal();
          loadContributors();
        } else {
          showToast('Error: ' + (result.error || 'Unknown error'), 'error');
        }
      } catch (err) {
        showToast('Error creating account', 'error');
      }
    }
    
    async function bulkCreateAccounts() {
      // Find contributors without auth accounts
      const noAuth = allContributors.filter(c => !c.auth_user_id);
      
      if (noAuth.length === 0) {
        showToast('All contributors already have accounts!', 'success');
        return;
      }
      
      const password = prompt(`Create accounts for ${noAuth.length} contributor(s):\n\n${noAuth.map(c => c.name).join('\n')}\n\nEnter password for all accounts:`, 'Gr@niteSt@teHoops');
      
      if (!password) return;
      
      showToast(`Creating ${noAuth.length} accounts...`, 'success');
      
      try {
        const response = await fetch('/.netlify/functions/contributor-invite', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            action: 'bulk-create',
            password
          })
        });
        
        const result = await response.json();
        
        if (result.success) {
          showToast(result.message, 'success');
          if (result.results?.failed?.length > 0) {
            console.log('Failed:', result.results.failed);
          }
          loadContributors();
        } else {
          showToast('Error: ' + (result.error || 'Unknown error'), 'error');
        }
      } catch (err) {
        showToast('Error creating accounts', 'error');
      }
    }
    
    function exportContributorsCSV() {
      const headers = ['Name', 'Email', 'Primary Area', 'Cell', 'Mailing Address', 'Venmo', 'Shirt Size', 
                       'NHIAA Alma Mater', 'College', 'Photographer', 'Videographer', 'Writer', 'Graphics', 
                       'Administrative', 'Website', 'Instagram', 'Facebook', 'Twitter', 'Camera Brand', 
                       'Computer Preference', 'Bio', 'SmugMug Name', 'Active', 'Has Account'];
      
      const rows = allContributors.map(c => [
        c.name || '',
        c.email || '',
        c.primary_area || '',
        c.cell || '',
        c.mailing_address || '',
        c.venmo || '',
        c.shirt_size || '',
        c.nhiaa_alma_mater || '',
        c.college || '',
        c.is_photographer ? 'Yes' : 'No',
        c.is_videographer ? 'Yes' : 'No',
        c.is_writer ? 'Yes' : 'No',
        c.is_graphics ? 'Yes' : 'No',
        c.is_administrative ? 'Yes' : 'No',
        c.website_url || '',
        c.instagram_url || '',
        c.facebook_url || '',
        c.twitter_url || '',
        c.camera_brand || '',
        c.computer_preference || '',
        (c.bio || '').replace(/"/g, '""'),
        c.smugmug_name || '',
        c.active ? 'Yes' : 'No',
        c.auth_user_id ? 'Yes' : 'No'
      ].map(val => `"${val}"`).join(','));
      
      const csv = [headers.join(','), ...rows].join('\n');
      const blob = new Blob([csv], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `ball603-contributors-${new Date().toISOString().split('T')[0]}.csv`;
      a.click();
      URL.revokeObjectURL(url);
      showToast('CSV exported!', 'success');
    }
    
    // ==================== SCHEDULE MANAGER ====================
    
    let allGames = [];
    let filteredGames = [];
    let importGamesData = [];
    
    async function loadGames() {
      try {
        const response = await fetch('/.netlify/functions/games?limit=5000');
        allGames = await response.json();
        filterGames();
        populateTeamsDatalist();
      } catch (err) {
        console.error('Failed to load games:', err);
        document.getElementById('gameList').innerHTML = '<div class="loading" style="color: #c62828;">Failed to load games</div>';
      }
    }
    
    function populateTeamsDatalist() {
      const datalist = document.getElementById('teamsList');
      if (!datalist || !allTeams) return;
      datalist.innerHTML = allTeams.map(t => `<option value="${t.shortname}">`).join('');
    }
    
    // Current date for navigation
    let currentViewDate = new Date().toLocaleDateString('en-CA', { timeZone: 'America/New_York' });
    
    function getTodayStr() {
      return new Date().toLocaleDateString('en-CA', { timeZone: 'America/New_York' });
    }
    
    function formatDateHeader(dateStr) {
      const date = new Date(dateStr + 'T12:00:00');
      const today = getTodayStr();
      const dayName = date.toLocaleDateString('en-US', { weekday: 'long' });
      const formatted = date.toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' });
      if (dateStr === today) return 'Today - ' + formatted;
      return dayName + ', ' + formatted;
    }
    
    function navigateGameDate(delta) {
      const date = new Date(currentViewDate + 'T12:00:00');
      date.setDate(date.getDate() + delta);
      currentViewDate = date.toISOString().split('T')[0];
      updateDateDisplay();
      scrollToDate(currentViewDate);
    }
    
    function goToToday() {
      currentViewDate = getTodayStr();
      updateDateDisplay();
      scrollToDate(currentViewDate);
    }
    
    function updateDateDisplay() {
      const btn = document.getElementById('currentGameDate');
      if (!btn) return;
      const today = getTodayStr();
      if (currentViewDate === today) {
        btn.textContent = 'Today';
        btn.style.background = '#e3f2fd';
        btn.style.borderColor = '#1565c0';
        btn.style.color = '#1565c0';
      } else {
        const date = new Date(currentViewDate + 'T12:00:00');
        btn.textContent = date.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
        btn.style.background = '#fff';
        btn.style.borderColor = '#ddd';
        btn.style.color = '#333';
      }
    }
    
    function scrollToDate(dateStr) {
      const container = document.getElementById('gameList');
      const header = document.getElementById('date-header-' + dateStr);
      if (header && container) {
        const headerTop = header.offsetTop;
        const stickyHeaderHeight = 45;
        container.scrollTop = headerTop - stickyHeaderHeight;
      }
    }
    
    function filterGames() {
      const level = document.getElementById('gameLevelFilter')?.value;
      const division = document.getElementById('gameDivisionFilter')?.value;
      const gender = document.getElementById('gameGenderFilter')?.value;
      const search = document.getElementById('gameSearchBox')?.value?.toLowerCase();
      const coverageOnly = document.getElementById('showCoverageOnly')?.checked;
      const finalOnly = document.getElementById('showFinalOnly')?.checked;
      
      filteredGames = allGames.filter(g => {
        if (level && g.level !== level) return false;
        if (division && g.division !== division) return false;
        if (gender && g.gender !== gender) return false;
        if (search && !g.home_team?.toLowerCase().includes(search) && !g.away_team?.toLowerCase().includes(search)) return false;
        if (coverageOnly && !g.photog1 && !g.photog2 && !g.videog && !g.writer) return false;
        if (finalOnly && g.status !== 'final') return false;
        return true;
      });
      
      filteredGames.sort((a, b) => a.date.localeCompare(b.date) || (a.time || '').localeCompare(b.time || ''));
      
      renderGameList();
    }
    
    function renderGameList() {
      const container = document.getElementById('gameList');
      const countEl = document.getElementById('gameCount');
      const today = getTodayStr();
      
      const finalCount = filteredGames.filter(g => g.status === 'final').length;
      countEl.textContent = filteredGames.length + ' games (' + finalCount + ' final)';
      
      if (filteredGames.length === 0) {
        container.innerHTML = '<div class="article-row header" style="grid-template-columns: 90px 1fr 1fr 70px 80px 50px 80px 100px; position: sticky; top: 0; z-index: 10; background: #fff;"><div>Time</div><div>Away</div><div>Home</div><div>Score</div><div>Division</div><div>URLs</div><div>Coverage</div><div>Actions</div></div><div style="padding: 40px; text-align: center; color: #888;">No games found</div>';
        return;
      }
      
      const gamesByDate = {};
      filteredGames.forEach(game => {
        if (!gamesByDate[game.date]) gamesByDate[game.date] = [];
        gamesByDate[game.date].push(game);
      });
      
      let html = '<div class="article-row header" style="grid-template-columns: 90px 1fr 1fr 70px 80px 50px 80px 100px; position: sticky; top: 0; z-index: 10; background: #fff;"><div>Time</div><div>Away</div><div>Home</div><div>Score</div><div>Division</div><div>URLs</div><div>Coverage</div><div>Actions</div></div>';
      
      Object.keys(gamesByDate).sort().forEach(date => {
        const isToday = date === today;
        const games = gamesByDate[date];
        
        html += '<div id="date-header-' + date + '" style="padding: 10px 15px; background: ' + (isToday ? '#1565c0' : '#f0f0f0') + '; color: ' + (isToday ? '#fff' : '#333') + '; font-weight: 600; font-size: 13px; border-bottom: 1px solid #ddd;">' + formatDateHeader(date) + ' (' + games.length + ' game' + (games.length !== 1 ? 's' : '') + ')</div>';
        
        games.forEach(game => {
          const hasPhotog = (game.photog1 && game.photog1.trim()) || (game.photog2 && game.photog2.trim());
          const hasVideog = game.videog && game.videog.trim();
          const hasWriter = game.writer && game.writer.trim();
          const coverageIcons = [];
          if (hasPhotog) coverageIcons.push('üì∑');
          if (hasVideog) coverageIcons.push('üé•');
          if (hasWriter) coverageIcons.push('‚úçÔ∏è');
          const hasUrls = game.photos_url || game.recap_url || game.highlights_url || game.live_stream_url;
          const urlCount = [game.photos_url, game.recap_url, game.highlights_url, game.live_stream_url].filter(Boolean).length;
          const score = game.status === 'final' ? (game.away_score || 0) + '-' + (game.home_score || 0) : (game.time || '-');
          const rowBg = isToday ? 'background: #e3f2fd;' : '';
          const cancelled = game.status === 'cancelled' ? 'opacity: 0.5; text-decoration: line-through;' : '';
          
          html += '<div class="article-row" style="grid-template-columns: 90px 1fr 1fr 70px 80px 50px 80px 100px; ' + rowBg + cancelled + '">';
          html += '<div style="font-size: 12px;"><div>' + (game.time || 'TBD') + '</div><div style="font-size: 10px; color: #888;">' + (game.gender || '') + '</div></div>';
          html += '<div style="font-size: 13px;">' + (game.away_team || '-') + '</div>';
          html += '<div style="font-size: 13px; font-weight: 500;">' + (game.home_team || '-') + '</div>';
          html += '<div style="font-size: 12px; ' + (game.status === 'final' ? 'font-weight: 600;' : 'color: #888;') + '">' + score + '<button onclick="openQuickScore(' + game.id + ')" style="background: none; border: none; cursor: pointer; padding: 2px; margin-left: 3px; font-size: 11px; color: #1565c0;" title="Quick edit score">‚úèÔ∏è</button></div>';
          html += '<div style="font-size: 11px; color: #666;">' + (game.division || '-') + '</div>';
          html += '<div style="text-align: center;"><button onclick="openUrlModal(' + game.id + ')" style="background: ' + (hasUrls ? '#f3e5f5' : '#f5f5f5') + '; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 12px;" title="' + (hasUrls ? urlCount + ' URL(s) set' : 'No URLs') + '">' + (hasUrls ? 'üîó' : '‚óã') + '</button></div>';
          html += '<div style="font-size: 14px;">' + (coverageIcons.join(' ') || '-') + '</div>';
          html += '<div class="article-actions"><button class="btn-edit" onclick="editGame(' + game.id + ')">Edit</button><button class="btn-delete" onclick="deleteGame(' + game.id + ')">Delete</button></div>';
          html += '</div>';
        });
      });
      
      container.innerHTML = html;
      setTimeout(function() { updateDateDisplay(); scrollToDate(currentViewDate); }, 100);
    }
    
    function openGameModal(game = null) {
      document.getElementById('gameModalTitle').textContent = game ? 'Edit Game' : 'Add Game';
      document.getElementById('gameModal').style.display = 'block';
      document.body.style.overflow = 'hidden';
      
      // Reset form
      document.getElementById('gameId').value = game?.id || '';
      document.getElementById('gameExternalId').value = game?.game_id || '';
      document.getElementById('gameDate').value = game?.date || '';
      document.getElementById('gameTime').value = game?.time || '';
      document.getElementById('gameStatus').value = game?.status || 'scheduled';
      document.getElementById('gameAwayTeam').value = game?.away_team || '';
      document.getElementById('gameAwayScore').value = game?.away_score ?? '';
      document.getElementById('gameHomeTeam').value = game?.home_team || '';
      document.getElementById('gameHomeScore').value = game?.home_score ?? '';
      document.getElementById('gameLevel').value = game?.level || 'NHIAA';
      updateGameDivisionOptions();
      document.getElementById('gameDivision').value = game?.division || '';
      document.getElementById('gameGender').value = game?.gender || 'Boys';
      document.getElementById('gamePhotog1').value = game?.photog1 || '';
      document.getElementById('gamePhotog2').value = game?.photog2 || '';
      document.getElementById('gameVideog').value = game?.videog || '';
      document.getElementById('gameWriter').value = game?.writer || '';
      document.getElementById('gamePhotosUrl').value = game?.photos_url || '';
      document.getElementById('gameRecapUrl').value = game?.recap_url || '';
      document.getElementById('gameHighlightsUrl').value = game?.highlights_url || '';
      document.getElementById('gameLiveStreamUrl').value = game?.live_stream_url || '';
      document.getElementById('gameSpecialEvent').value = game?.special_event || '';
      document.getElementById('gameLocation').value = game?.location || '';
      document.getElementById('gameNotes').value = game?.notes || '';
    }
    
    function closeGameModal() {
      document.getElementById('gameModal').style.display = 'none';
      document.body.style.overflow = 'auto';
    }
    
    function updateGameDivisionOptions() {
      const level = document.getElementById('gameLevel').value;
      const divSelect = document.getElementById('gameDivision');
      const currentVal = divSelect.value;
      
      if (level === 'NHIAA') {
        divSelect.innerHTML = `
          <option value="">None</option>
          <option value="D-I">D-I</option>
          <option value="D-II">D-II</option>
          <option value="D-III">D-III</option>
          <option value="D-IV">D-IV</option>
        `;
      } else if (level === 'Prep School') {
        divSelect.innerHTML = `
          <option value="">None</option>
          <option value="NEPSAC">NEPSAC</option>
        `;
      } else {
        divSelect.innerHTML = `
          <option value="">None</option>
          <option value="D1">D1 (NCAA)</option>
          <option value="D2">D2 (NCAA)</option>
          <option value="D3">D3 (NCAA)</option>
        `;
      }
      
      const validOptions = [...divSelect.options].map(o => o.value);
      if (validOptions.includes(currentVal)) {
        divSelect.value = currentVal;
      }
    }
    
    // Quick Score Functions
    function openQuickScore(gameId) {
      const game = allGames.find(g => g.id === gameId);
      if (!game) return;
      
      document.getElementById('quickScoreGameId').value = gameId;
      document.getElementById('quickScoreMatchup').textContent = `${game.away_team} @ ${game.home_team} ‚Ä¢ ${new Date(game.date + 'T12:00:00').toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}`;
      document.getElementById('quickScoreAwayLabel').textContent = game.away_team || 'Away';
      document.getElementById('quickScoreHomeLabel').textContent = game.home_team || 'Home';
      document.getElementById('quickScoreAway').value = game.away_score || '';
      document.getElementById('quickScoreHome').value = game.home_score || '';
      
      const modal = document.getElementById('quickScoreModal');
      modal.style.display = 'flex';
      
      // Focus away score input
      setTimeout(() => document.getElementById('quickScoreAway').focus(), 100);
    }
    
    function closeQuickScore() {
      document.getElementById('quickScoreModal').style.display = 'none';
    }
    
    async function saveQuickScore() {
      const gameId = parseInt(document.getElementById('quickScoreGameId').value);
      const awayScore = document.getElementById('quickScoreAway').value;
      const homeScore = document.getElementById('quickScoreHome').value;
      
      // Determine status based on scores
      const hasScore = awayScore !== '' && homeScore !== '';
      const status = hasScore ? 'final' : 'scheduled';
      
      try {
        const { error } = await db
          .from('games')
          .update({
            away_score: awayScore === '' ? null : parseInt(awayScore),
            home_score: homeScore === '' ? null : parseInt(homeScore),
            status: status
          })
          .eq('id', gameId);
        
        if (error) throw error;
        
        // Update local data
        const game = allGames.find(g => g.id === gameId);
        if (game) {
          game.away_score = awayScore === '' ? null : parseInt(awayScore);
          game.home_score = homeScore === '' ? null : parseInt(homeScore);
          game.status = status;
        }
        
        closeQuickScore();
        filterGames();
        showToast('Score updated!', 'success');
      } catch (err) {
        console.error('Error updating score:', err);
        showToast('Error updating score', 'error');
      }
    }
    
    async function clearQuickScore() {
      document.getElementById('quickScoreAway').value = '';
      document.getElementById('quickScoreHome').value = '';
      await saveQuickScore();
    }
    
    // Close quick score modal on escape key
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && document.getElementById('quickScoreModal').style.display === 'flex') {
        closeQuickScore();
      }
      if (e.key === 'Enter' && document.getElementById('quickScoreModal').style.display === 'flex') {
        saveQuickScore();
      }
    });
    
    async function editGame(gameId) {
      const game = allGames.find(g => g.id === gameId);
      if (game) {
        openGameModal(game);
      }
    }
    
    // URL Modal Functions
    function openUrlModal(gameId) {
      const game = allGames.find(g => g.id === gameId);
      if (!game) return;
      
      document.getElementById('urlGameId').value = gameId;
      document.getElementById('urlGameTitle').textContent = `${game.away_team} @ ${game.home_team}`;
      
      const dateDisplay = new Date(game.date + 'T12:00:00').toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric', year: 'numeric' });
      document.getElementById('urlGameMeta').textContent = `${dateDisplay} ${game.gender || ''} ${game.level || ''} ${game.division || ''}`.trim();
      
      document.getElementById('urlPhotos').value = game.photos_url || '';
      document.getElementById('urlRecap').value = game.recap_url || '';
      document.getElementById('urlHighlights').value = game.highlights_url || '';
      document.getElementById('urlLiveStream').value = game.live_stream_url || '';
      
      document.getElementById('urlModal').style.display = 'block';
      document.body.style.overflow = 'hidden';
    }
    
    function closeUrlModal() {
      document.getElementById('urlModal').style.display = 'none';
      document.body.style.overflow = 'auto';
    }
    
    function clearUrlField(fieldId) {
      document.getElementById(fieldId).value = '';
    }
    
    function clearAllUrls() {
      if (!confirm('Clear all URLs for this game?')) return;
      document.getElementById('urlPhotos').value = '';
      document.getElementById('urlRecap').value = '';
      document.getElementById('urlHighlights').value = '';
      document.getElementById('urlLiveStream').value = '';
    }
    
    async function saveUrls() {
      const gameId = document.getElementById('urlGameId').value;
      if (!gameId) return;
      
      const urlData = {
        photos_url: document.getElementById('urlPhotos').value.trim() || null,
        recap_url: document.getElementById('urlRecap').value.trim() || null,
        highlights_url: document.getElementById('urlHighlights').value.trim() || null,
        live_stream_url: document.getElementById('urlLiveStream').value.trim() || null
      };
      
      try {
        const response = await fetch(`/.netlify/functions/games?id=${gameId}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(urlData)
        });
        
        if (response.ok) {
          // Update local data
          const game = allGames.find(g => g.id === parseInt(gameId));
          if (game) {
            game.photos_url = urlData.photos_url;
            game.recap_url = urlData.recap_url;
            game.highlights_url = urlData.highlights_url;
            game.live_stream_url = urlData.live_stream_url;
          }
          
          closeUrlModal();
          renderGameList();
          showToast('URLs saved!', 'success');
        } else {
          throw new Error('Failed to save');
        }
      } catch (err) {
        console.error('Error saving URLs:', err);
        showToast('Error saving URLs', 'error');
      }
    }
    
    async function saveGame() {
      const gameId = document.getElementById('gameId').value;
      
      const gameData = {
        date: document.getElementById('gameDate').value,
        time: document.getElementById('gameTime').value || null,
        status: document.getElementById('gameStatus').value,
        away_team: document.getElementById('gameAwayTeam').value.trim(),
        home_team: document.getElementById('gameHomeTeam').value.trim(),
        away_score: document.getElementById('gameAwayScore').value ? parseInt(document.getElementById('gameAwayScore').value) : null,
        home_score: document.getElementById('gameHomeScore').value ? parseInt(document.getElementById('gameHomeScore').value) : null,
        level: document.getElementById('gameLevel').value,
        division: document.getElementById('gameDivision').value || null,
        gender: document.getElementById('gameGender').value,
        photog1: document.getElementById('gamePhotog1').value.trim() || null,
        photog2: document.getElementById('gamePhotog2').value.trim() || null,
        videog: document.getElementById('gameVideog').value.trim() || null,
        writer: document.getElementById('gameWriter').value.trim() || null,
        photos_url: document.getElementById('gamePhotosUrl').value.trim() || null,
        recap_url: document.getElementById('gameRecapUrl').value.trim() || null,
        highlights_url: document.getElementById('gameHighlightsUrl').value.trim() || null,
        live_stream_url: document.getElementById('gameLiveStreamUrl').value.trim() || null,
        special_event: document.getElementById('gameSpecialEvent').value.trim() || null,
        location: document.getElementById('gameLocation').value.trim() || null,
        notes: document.getElementById('gameNotes').value.trim() || null
      };
      
      // Validation
      if (!gameData.date || !gameData.away_team || !gameData.home_team || !gameData.level) {
        showToast('Please fill in required fields', 'error');
        return;
      }
      
      // Generate game_id for new games
      if (!gameId) {
        const homeSlug = gameData.home_team.toLowerCase().replace(/[^a-z0-9]/g, '');
        const awaySlug = gameData.away_team.toLowerCase().replace(/[^a-z0-9]/g, '');
        const genderCode = gameData.gender === 'Boys' ? 'b' : gameData.gender === 'Girls' ? 'g' : gameData.gender === 'Men' ? 'm' : 'w';
        const dateStr = gameData.date.replace(/-/g, '');
        const levelPrefix = gameData.level === 'NHIAA' ? 'nhiaa' : gameData.level === 'College' ? 'college' : 'prep';
        gameData.game_id = `${levelPrefix}_${homeSlug}_${genderCode}_${dateStr}_${awaySlug}`;
      }
      
      try {
        const url = gameId 
          ? `/.netlify/functions/games?id=${gameId}`
          : '/.netlify/functions/games';
        
        const response = await fetch(url, {
          method: gameId ? 'PUT' : 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(gameData)
        });
        
        if (response.ok) {
          showToast(gameId ? 'Game updated!' : 'Game created!', 'success');
          closeGameModal();
          loadGames();
        } else {
          const err = await response.json();
          showToast(err.error || 'Failed to save game', 'error');
        }
      } catch (err) {
        console.error('Save game error:', err);
        showToast('Failed to save game', 'error');
      }
    }
    
    async function deleteGame(gameId) {
      if (!confirm('Delete this game?')) return;
      
      try {
        const response = await fetch(`/.netlify/functions/games?id=${gameId}`, {
          method: 'DELETE'
        });
        
        if (response.ok) {
          showToast('Game deleted', 'success');
          loadGames();
        } else {
          showToast('Failed to delete game', 'error');
        }
      } catch (err) {
        console.error('Delete game error:', err);
        showToast('Failed to delete game', 'error');
      }
    }
    
    // Game CSV Import
    function openGameImportModal() {
      document.getElementById('gameImportModal').style.display = 'block';
      document.body.style.overflow = 'hidden';
      document.getElementById('gameImportPreview').style.display = 'none';
      document.getElementById('gameFileInput').value = '';
      importGamesData = [];
    }
    
    function closeGameImportModal() {
      document.getElementById('gameImportModal').style.display = 'none';
      document.body.style.overflow = 'auto';
    }
    
    function handleGameCsvFile(file) {
      if (!file || !file.name.endsWith('.csv')) {
        showToast('Please select a CSV file', 'error');
        return;
      }
      
      const reader = new FileReader();
      reader.onload = (e) => {
        parseGameCsv(e.target.result, file.name);
      };
      reader.readAsText(file);
    }
    
    function parseGameCsv(csv, filename) {
      const lines = csv.split('\n').filter(line => line.trim());
      if (lines.length < 2) {
        showToast('CSV file appears empty', 'error');
        return;
      }
      
      // Detect delimiter
      const firstLine = lines[0];
      const delimiter = firstLine.includes('\t') ? '\t' : ',';
      
      const headers = firstLine.split(delimiter).map(h => h.trim().toLowerCase().replace(/[^a-z0-9_]/g, ''));
      const games = [];
      
      for (let i = 1; i < lines.length; i++) {
        const values = delimiter === '\t' ? lines[i].split('\t') : parseCSVLine(lines[i]);
        if (values.length < headers.length - 1) continue;
        
        const game = {};
        headers.forEach((h, idx) => {
          let val = values[idx]?.trim() || null;
          game[h] = val;
        });
        
        // Map CSV columns to database columns
        const mappedGame = {
          game_id: game.game_id || game.gameid,
          date: game.date,
          time: game.time,
          away_team: game.away || game.away_team || game.awayteam,
          home_team: game.home || game.home_team || game.hometeam,
          away_score: game.away_score || game.awayscore,
          home_score: game.home_score || game.homescore,
          gender: game.gender,
          level: game.level,
          division: game.division,
          photog1: game.photog || game.photog1,
          photog2: game.photog2,
          videog: game.videog,
          writer: game.writer,
          photos_url: game.photos_url || game.photosurl,
          recap_url: game.recap_url || game.recapurl,
          highlights_url: game.highlights_url || game.highlightsurl,
          live_stream_url: game.live_stream_url || game.livestreamurl || game.livestream_url,
          game_description: game.gamedescription || game.game_description,
          special_event: game.specialevent || game.special_event,
          notes: game.notes,
          original_date: game.original_date || game.originaldate,
          schedule_changed: game.schedule_changed || game.schedulechanged
        };
        
        // Only add if has required fields
        if (mappedGame.game_id && mappedGame.date && mappedGame.away_team && mappedGame.home_team) {
          games.push(mappedGame);
        }
      }
      
      if (games.length === 0) {
        showToast('No valid games found in CSV', 'error');
        return;
      }
      
      importGamesData = games;
      showGameImportPreview(games, filename);
    }
    
    function showGameImportPreview(games, filename) {
      document.getElementById('gameImportPreview').style.display = 'block';
      document.getElementById('gameImportPreviewCount').textContent = `${games.length} games`;
      document.getElementById('gameImportPreviewFile').textContent = filename;
      
      const tbody = document.getElementById('gameImportPreviewBody');
      tbody.innerHTML = games.slice(0, 50).map(g => `
        <tr>
          <td style="padding: 6px 8px;">${g.date}</td>
          <td style="padding: 6px 8px;">${g.away_team}</td>
          <td style="padding: 6px 8px;">${g.home_team}</td>
          <td style="padding: 6px 8px;">${g.level}</td>
        </tr>
      `).join('');
      
      if (games.length > 50) {
        tbody.innerHTML += `<tr><td colspan="4" style="padding: 8px; color: #888; text-align: center;">...and ${games.length - 50} more</td></tr>`;
      }
    }
    
    async function executeGameImport() {
      if (importGamesData.length === 0) return;
      
      document.getElementById('btnExecuteGameImport').disabled = true;
      document.getElementById('btnExecuteGameImport').textContent = 'Importing...';
      
      try {
        const response = await fetch('/.netlify/functions/games', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ games: importGamesData })
        });
        
        const result = await response.json();
        
        showToast(`Import complete: ${result.inserted} inserted, ${result.updated} updated, ${result.errors?.length || 0} errors`, 'success');
        closeGameImportModal();
        loadGames();
        
        if (result.errors && result.errors.length > 0) {
          console.log('Import errors:', result.errors);
        }
      } catch (err) {
        console.error('Import error:', err);
        showToast('Import failed', 'error');
      }
      
      document.getElementById('btnExecuteGameImport').disabled = false;
      document.getElementById('btnExecuteGameImport').textContent = 'Import Games';
    }
    
    function exportGames() {
      if (allGames.length === 0) {
        showToast('No games to export', 'error');
        return;
      }
      
      const headers = ['game_id', 'date', 'time', 'away', 'away_score', 'home', 'home_score', 'gender', 'level', 'division', 'photog1', 'photog2', 'videog', 'writer', 'notes', 'original_date', 'schedule_changed', 'photos_url', 'recap_url', 'highlights_url', 'live_stream_url', 'gamedescription', 'specialevent'];
      
      let csv = headers.join(',') + '\n';
      
      filteredGames.forEach(game => {
        const row = [
          game.game_id,
          game.date,
          game.time,
          game.away_team,
          game.away_score ?? '',
          game.home_team,
          game.home_score ?? '',
          game.gender,
          game.level,
          game.division,
          game.photog1 || '',
          game.photog2 || '',
          game.videog || '',
          game.writer || '',
          game.notes || '',
          game.original_date || '',
          game.schedule_changed ? 'YES' : '',
          game.photos_url || '',
          game.recap_url || '',
          game.highlights_url || '',
          game.live_stream_url || '',
          game.game_description || '',
          game.special_event || ''
        ].map(val => {
          if (val === null || val === undefined) return '';
          val = String(val);
          if (val.includes(',') || val.includes('"') || val.includes('\n')) {
            return '"' + val.replace(/"/g, '""') + '"';
          }
          return val;
        });
        csv += row.join(',') + '\n';
      });
      
      const blob = new Blob([csv], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `ball603-schedule-${new Date().toISOString().split('T')[0]}.csv`;
      a.click();
      URL.revokeObjectURL(url);
      
      showToast('Schedule exported!', 'success');
    }
    
    // Restore coverage data from CSV (updates ONLY coverage fields, not game data)
    async function restoreCoverageFromCSV(file) {
      if (!file || !file.name.endsWith('.csv')) {
        showToast('Please select a CSV file', 'error');
        return;
      }
      
      showToast('Reading CSV...', 'success');
      
      const reader = new FileReader();
      reader.onload = async (e) => {
        try {
          const csv = e.target.result;
          const lines = csv.split('\n').filter(line => line.trim());
          
          if (lines.length < 2) {
            showToast('CSV file appears empty', 'error');
            return;
          }
          
          const delimiter = lines[0].includes('\t') ? '\t' : ',';
          const headers = lines[0].split(delimiter).map(h => h.trim().toLowerCase().replace(/[^a-z0-9_]/g, ''));
          
          const games = [];
          for (let i = 1; i < lines.length; i++) {
            const values = delimiter === '\t' ? lines[i].split('\t') : parseCSVLine(lines[i]);
            if (values.length < headers.length - 1) continue;
            
            const game = {};
            headers.forEach((h, idx) => {
              game[h] = values[idx]?.trim() || null;
            });
            
            // Only include if has game_id and any coverage data
            if (game.game_id && (game.photog1 || game.photog2 || game.videog || game.writer || 
                game.photos_url || game.recap_url || game.highlights_url || game.live_stream_url)) {
              games.push(game);
            }
          }
          
          if (games.length === 0) {
            showToast('No games with coverage data found in CSV', 'error');
            return;
          }
          
          showToast(`Restoring coverage for ${games.length} games...`, 'success');
          
          // Send to restore endpoint
          const response = await fetch('/.netlify/functions/import-coverage-restore', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ games })
          });
          
          const result = await response.json();
          
          if (result.success) {
            showToast(`Coverage restored for ${result.updated} games!`, 'success');
            loadGames();
          } else {
            showToast(result.error || 'Restore failed', 'error');
          }
        } catch (err) {
          console.error('Restore error:', err);
          showToast('Failed to restore coverage', 'error');
        }
      };
      reader.readAsText(file);
    }
    
    // ==================== END SCHEDULE MANAGER ====================
    
    // Drag and drop for CSV
    document.addEventListener('DOMContentLoaded', function() {
      const dropZone = document.getElementById('dropZone');
      if (dropZone) {
        dropZone.addEventListener('dragover', (e) => {
          e.preventDefault();
          dropZone.style.borderColor = '#1565c0';
          dropZone.style.background = '#e3f2fd';
        });
        dropZone.addEventListener('dragleave', () => {
          dropZone.style.borderColor = '#ddd';
          dropZone.style.background = 'transparent';
        });
        dropZone.addEventListener('drop', (e) => {
          e.preventDefault();
          dropZone.style.borderColor = '#ddd';
          dropZone.style.background = 'transparent';
          const file = e.dataTransfer.files[0];
          if (file && file.name.endsWith('.csv')) {
            handleCsvFile(file);
          } else {
            showToast('Please drop a CSV file', 'error');
          }
        });
      }
    });
    
    // Preview Modal
    function openPreview() {
      // Save article first, then open in new window
      const title = document.getElementById('articleTitle').value.trim();
      if (!title) {
        showToast('Please enter a headline first', 'error');
        return;
      }
      
      // If article exists, open preview in new window
      if (currentArticle && currentArticle.slug) {
        const previewUrl = `/article/${currentArticle.slug}?preview=true`;
        window.open(previewUrl, 'articlePreview', 'width=1200,height=800,scrollbars=yes,resizable=yes');
      } else {
        showToast('Save the article first to preview', 'error');
      }
    }
    
    function openPreviewOld() {
      const headline = document.getElementById('articleTitle').value || 'Untitled';
      const content = getEditorContent() || '<p>No content yet.</p>';
      const plainText = getEditorPlainText() || 'No content yet.';
      const excerpt = document.getElementById('articleExcerpt').value || '';
      const featuredImageUrl = document.getElementById('featuredImageUrl').value;
      const featuredImageCaption = document.getElementById('featuredImageCaptionField').value;
      
      // Featured image
      if (featuredImageUrl) {
        document.getElementById('previewFeaturedImg').src = featuredImageUrl;
        document.getElementById('previewFeaturedCaption').textContent = featuredImageCaption || '';
        document.getElementById('previewFeaturedImage').style.display = 'block';
      } else {
        document.getElementById('previewFeaturedImage').style.display = 'none';
      }
      
      document.getElementById('previewHeadline').textContent = headline;
      document.getElementById('previewExcerpt').textContent = excerpt;
      document.getElementById('previewContent').innerHTML = content; // Use innerHTML for rich content
      
      // Social posts - use generated ones if available, otherwise create basic versions
      if (generatedSocialPosts.facebookPost) {
        document.getElementById('previewFacebook').textContent = generatedSocialPosts.facebookPost;
      } else {
        document.getElementById('previewFacebook').textContent = plainText.substring(0, 500) + (plainText.length > 500 ? '...' : '');
      }
      
      if (generatedSocialPosts.instagramPost) {
        document.getElementById('previewInstagram').textContent = generatedSocialPosts.instagramPost;
      } else {
        document.getElementById('previewInstagram').textContent = 'No Instagram post generated. Use Scorebook Story or Boxscore Story to auto-generate social posts.';
      }
      
      if (generatedSocialPosts.twitterPost) {
        document.getElementById('previewTwitter').textContent = generatedSocialPosts.twitterPost;
      } else {
        document.getElementById('previewTwitter').textContent = 'No Twitter post generated. Use Scorebook Story or Boxscore Story to auto-generate social posts.';
      }
      
      document.getElementById('previewModal').classList.add('open');
      document.body.style.overflow = 'hidden';
    }
    
    function closePreview() {
      document.getElementById('previewModal').classList.remove('open');
      document.body.style.overflow = 'auto';
    }
    
    // SmugMug Browser
    let smugmugAlbums = [];
    let selectedAlbum = null;
    
    async function openSmugMugBrowser() {
      document.getElementById('smugmugModal').classList.add('open');
      document.getElementById('albumGrid').innerHTML = '<div class="loading">Loading albums...</div>';
      selectedAlbum = null;
      document.getElementById('btnSelectAlbum').disabled = true;
      
      try {
        const response = await fetch('/.netlify/functions/smugmug?action=albums');
        const data = await response.json();
        
        if (data.success) {
          smugmugAlbums = data.albums || [];
          renderAlbumGrid();
        } else {
          document.getElementById('albumGrid').innerHTML = '<div class="loading">Error loading albums</div>';
        }
      } catch (err) {
        console.error('SmugMug error:', err);
        document.getElementById('albumGrid').innerHTML = '<div class="loading">Could not connect to SmugMug</div>';
      }
    }
    
    function closeSmugMugBrowser() {
      document.getElementById('smugmugModal').classList.remove('open');
      selectedAlbum = null;
    }
    
    function renderAlbumGrid(filter = '') {
      const grid = document.getElementById('albumGrid');
      
      let filtered = smugmugAlbums;
      if (filter) {
        filtered = smugmugAlbums.filter(a => 
          a.name.toLowerCase().includes(filter.toLowerCase())
        );
      }
      
      if (filtered.length === 0) {
        grid.innerHTML = '<div class="loading">No albums found</div>';
        return;
      }
      
      grid.innerHTML = filtered.map(album => `
        <div class="album-card ${selectedAlbum?.key === album.key ? 'selected' : ''}" 
             onclick="selectAlbumCard('${album.key}')">
          <img class="album-thumb" 
               src="${album.highlightImage || 'data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><rect fill=%22%23f5f5f5%22 width=%22100%22 height=%22100%22/><text x=%2250%22 y=%2255%22 text-anchor=%22middle%22 fill=%22%23ccc%22 font-size=%2230%22></text></svg>'}" 
               alt="${album.name}"
               onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><rect fill=%22%23f5f5f5%22 width=%22100%22 height=%22100%22/><text x=%2250%22 y=%2255%22 text-anchor=%22middle%22 fill=%22%23ccc%22 font-size=%2230%22></text></svg>'">
          <div class="album-info">
            <div class="album-name" title="${album.name}">${album.name}</div>
            <div class="album-meta">${album.imageCount || 0} photos${album.date ? ' ' + album.date : ''}</div>
          </div>
        </div>
      `).join('');
    }
    
    function searchAlbums(value) {
      renderAlbumGrid(value);
    }
    
    function selectAlbumCard(key) {
      selectedAlbum = smugmugAlbums.find(a => a.key === key);
      document.getElementById('btnSelectAlbum').disabled = !selectedAlbum;
      renderAlbumGrid(document.getElementById('albumSearch').value);
    }
    
    function selectSmugMugAlbum() {
      if (!selectedAlbum) return;
      
      document.getElementById('smugmugUrl').value = selectedAlbum.url;
      document.getElementById('smugmugThumbUrl').value = selectedAlbum.highlightImage || '';
      
      // Show preview
      const preview = document.getElementById('selectedAlbumPreview');
      if (selectedAlbum.highlightImage) {
        document.getElementById('albumThumbnail').src = selectedAlbum.highlightImage;
        preview.style.display = 'block';
      } else {
        preview.style.display = 'none';
      }
      document.getElementById('albumInfo').textContent = `${selectedAlbum.name} ${selectedAlbum.imageCount} photos`;
      preview.style.display = 'block';
      
      closeSmugMugBrowser();
      showToast('Album selected!', 'success');
    }
    
    // =====================================
    // BONUS GALLERY FUNCTIONS
    // =====================================
    
    let currentBonusSlot = null;
    let selectedBonusAlbum = null;
    
    async function openBonusGalleryModal(slot) {
      currentBonusSlot = slot;
      selectedBonusAlbum = null;
      document.getElementById('btnSelectBonusAlbum').disabled = true;
      document.getElementById('bonusAlbumSearch').value = '';
      document.getElementById('bonusGalleryModal').classList.add('open');
      
      // Populate photographer dropdown
      await populateBonusPhotographerDropdown();
      
      // Load albums if not already loaded
      if (smugmugAlbums.length === 0) {
        document.getElementById('bonusAlbumGrid').innerHTML = '<div class="loading">Loading albums...</div>';
        try {
          const response = await fetch('/.netlify/functions/smugmug?action=albums');
          const data = await response.json();
          if (data.success) {
            smugmugAlbums = data.albums || [];
          }
        } catch (err) {
          console.error('SmugMug error:', err);
          document.getElementById('bonusAlbumGrid').innerHTML = '<div class="loading">Could not connect to SmugMug</div>';
          return;
        }
      }
      renderBonusAlbumGrid('');
    }
    
    function closeBonusGalleryModal() {
      document.getElementById('bonusGalleryModal').classList.remove('open');
      currentBonusSlot = null;
      selectedBonusAlbum = null;
    }
    
    async function populateBonusPhotographerDropdown() {
      const select = document.getElementById('bonusGalleryPhotographerSelect');
      select.innerHTML = '<option value="">Select photographer...</option>';
      
      try {
        const { data: photographers, error } = await db
          .from('contributors')
          .select('name')
          .eq('is_photographer', true)
          .eq('active', true)
          .order('name');
        
        if (!error && photographers && photographers.length > 0) {
          photographers.forEach(p => {
            if (p.name) {
              const option = document.createElement('option');
              option.value = p.name;
              option.textContent = p.name;
              select.appendChild(option);
            }
          });
        }
      } catch (err) {
        console.error('Error loading photographers for bonus gallery:', err);
      }
      
      // Add "Other..." option
      const otherOption = document.createElement('option');
      otherOption.value = 'other';
      otherOption.textContent = 'Other...';
      select.appendChild(otherOption);
    }
    
    function renderBonusAlbumGrid(searchTerm) {
      const grid = document.getElementById('bonusAlbumGrid');
      let filtered = smugmugAlbums;
      
      if (searchTerm) {
        const term = searchTerm.toLowerCase();
        filtered = smugmugAlbums.filter(a => a.name.toLowerCase().includes(term));
      }
      
      if (filtered.length === 0) {
        grid.innerHTML = '<div class="loading">No albums found</div>';
        return;
      }
      
      grid.innerHTML = filtered.map(album => `
        <div class="album-card ${selectedBonusAlbum?.key === album.key ? 'selected' : ''}" onclick="selectBonusAlbumCard('${album.key}')">
          <img class="album-thumb" 
               src="${album.highlightImage || 'data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><rect fill=%22%23f5f5f5%22 width=%22100%22 height=%22100%22/><text x=%2250%22 y=%2255%22 text-anchor=%22middle%22 fill=%22%23ccc%22 font-size=%2230%22></text></svg>'}" 
               alt="${album.name}"
               onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><rect fill=%22%23f5f5f5%22 width=%22100%22 height=%22100%22/><text x=%2250%22 y=%2255%22 text-anchor=%22middle%22 fill=%22%23ccc%22 font-size=%2230%22></text></svg>'">
          <div class="album-info">
            <div class="album-name" title="${album.name}">${album.name}</div>
            <div class="album-meta">${album.imageCount || 0} photos</div>
          </div>
        </div>
      `).join('');
    }
    
    function searchBonusAlbums(value) {
      renderBonusAlbumGrid(value);
    }
    
    function selectBonusAlbumCard(key) {
      selectedBonusAlbum = smugmugAlbums.find(a => a.key === key);
      document.getElementById('btnSelectBonusAlbum').disabled = !selectedBonusAlbum;
      renderBonusAlbumGrid(document.getElementById('bonusAlbumSearch').value);
    }
    
    async function selectBonusGalleryAlbum() {
      if (!selectedBonusAlbum || !currentBonusSlot) {
        console.log('No album or slot selected:', { selectedBonusAlbum, currentBonusSlot });
        return;
      }
      
      console.log('Selected album:', selectedBonusAlbum);
      
      const photographer = document.getElementById('bonusGalleryPhotographerSelect').value;
      
      // Store URL and photographer
      const albumUrl = selectedBonusAlbum.url || selectedBonusAlbum.WebUri || '';
      console.log('Album URL:', albumUrl);
      
      document.getElementById(`bonusGallery${currentBonusSlot}Url`).value = albumUrl;
      document.getElementById(`bonusGallery${currentBonusSlot}Photographer`).value = photographer || '';
      
      // Fetch thumbnail from SmugMug API
      let thumbUrl = selectedBonusAlbum.highlightImage || '';
      const albumKey = selectedBonusAlbum.key || selectedBonusAlbum.AlbumKey;
      
      if (!thumbUrl && albumKey) {
        try {
          console.log('Fetching thumbnail for album key:', albumKey);
          const response = await fetch(`/.netlify/functions/smugmug?action=albumThumb&albumKey=${albumKey}`);
          const data = await response.json();
          console.log('Thumbnail response:', data);
          if (data.success && data.thumbnailUrl) {
            thumbUrl = data.thumbnailUrl;
          }
        } catch (err) {
          console.error('Error fetching thumbnail:', err);
        }
      }
      
      console.log('Final thumb URL:', thumbUrl);
      document.getElementById(`bonusGallery${currentBonusSlot}ThumbUrl`).value = thumbUrl;
      
      // Update preview
      updateBonusGalleryPreview(currentBonusSlot);
      
      closeBonusGalleryModal();
      showToast(`Bonus Gallery ${currentBonusSlot} selected!`, 'success');
    }
    
    function updateBonusGalleryPreview(slot) {
      const url = document.getElementById(`bonusGallery${slot}Url`).value;
      const thumb = document.getElementById(`bonusGallery${slot}ThumbUrl`).value;
      const photog = document.getElementById(`bonusGallery${slot}Photographer`).value;
      
      const preview = document.getElementById(`bonusGallery${slot}Preview`);
      const thumbImg = document.getElementById(`bonusGallery${slot}Thumb`);
      const photogDiv = document.getElementById(`bonusGallery${slot}Photog`);
      
      if (url) {
        if (thumb) {
          thumbImg.src = thumb;
        } else {
          thumbImg.src = '/logo.png';
        }
        photogDiv.textContent = photog ? `üì∑ ${photog}` : 'No photographer';
        photogDiv.innerHTML = photog ? `üì∑ ${photog}` : 'No photographer';
        preview.style.display = 'block';
      } else {
        preview.style.display = 'none';
      }
    }
    
    function clearBonusGallery(slot) {
      document.getElementById(`bonusGallery${slot}Url`).value = '';
      document.getElementById(`bonusGallery${slot}ThumbUrl`).value = '';
      document.getElementById(`bonusGallery${slot}Photographer`).value = '';
      document.getElementById(`bonusGallery${slot}Preview`).style.display = 'none';
      showToast(`Bonus Gallery ${slot} cleared`, 'success');
    }
    
    // =====================================
    // ROSTER SUBMISSIONS MANAGEMENT
    // =====================================
    
    let allRosterSubmissions = [];
    let currentRoster = null;
    
    async function loadRosters() {
      document.getElementById('rosterList').innerHTML = `
        <div class="article-row header" style="grid-template-columns: 1fr 100px 100px 150px 120px 120px;">
          <div>School</div>
          <div>Gender</div>
          <div>Division</div>
          <div>Submitted</div>
          <div>Status</div>
          <div>Actions</div>
        </div>
        <div class="loading">Loading roster submissions...</div>
      `;
      
      try {
        const { data, error } = await db
          .from('roster_submissions')
          .select('*')
          .order('created_at', { ascending: false });
        
        if (error) throw error;
        
        allRosterSubmissions = data || [];
        renderRosters();
        populateSchoolsDatalist();
      } catch (err) {
        console.error('Error loading rosters:', err);
        showToast('Error loading roster submissions', 'error');
        document.getElementById('rosterList').innerHTML = `
          <div class="article-row header" style="grid-template-columns: 1fr 100px 100px 150px 120px 120px;">
            <div>School</div>
            <div>Gender</div>
            <div>Division</div>
            <div>Submitted</div>
            <div>Status</div>
            <div>Actions</div>
          </div>
          <div class="empty-state"><p>Error loading submissions. <button onclick="loadRosters()">Try again</button></p></div>
        `;
      }
    }
    
    function filterRosters() {
      renderRosters();
    }
    
    function renderRosters() {
      const statusFilter = document.getElementById('rosterStatusFilter').value;
      const genderFilter = document.getElementById('rosterGenderFilter').value;
      const searchTerm = document.getElementById('rosterSearchBox').value.toLowerCase();
      
      let filtered = allRosterSubmissions;
      
      if (statusFilter && statusFilter !== 'all') {
        filtered = filtered.filter(r => r.status === statusFilter);
      }
      if (genderFilter) {
        filtered = filtered.filter(r => r.gender === genderFilter);
      }
      if (searchTerm) {
        filtered = filtered.filter(r => 
          r.school?.toLowerCase().includes(searchTerm) ||
          r.submitted_by?.toLowerCase().includes(searchTerm)
        );
      }
      
      document.getElementById('rosterCount').textContent = `${filtered.length} submission${filtered.length !== 1 ? 's' : ''}`;
      
      const list = document.getElementById('rosterList');
      
      if (filtered.length === 0) {
        list.innerHTML = `
          <div class="article-row header" style="grid-template-columns: 1fr 100px 100px 150px 120px 120px;">
            <div>School</div>
            <div>Gender</div>
            <div>Division</div>
            <div>Submitted</div>
            <div>Status</div>
            <div>Actions</div>
          </div>
          <div class="empty-state"><p>No roster submissions found</p></div>
        `;
        return;
      }
      
      list.innerHTML = `
        <div class="article-row header" style="grid-template-columns: 1fr 100px 100px 150px 120px 120px;">
          <div>School</div>
          <div>Gender</div>
          <div>Division</div>
          <div>Submitted</div>
          <div>Status</div>
          <div>Actions</div>
        </div>
        ${filtered.map(roster => {
          const statusClass = roster.status === 'approved' ? 'published' : 
                              roster.status === 'rejected' ? 'draft' : 'scheduled';
          const playerCount = roster.players_json ? roster.players_json.length : 0;
          return `
            <div class="article-row" style="grid-template-columns: 1fr 100px 100px 150px 120px 120px;">
              <div>
                <div class="article-title" onclick="openRosterModal('${roster.id}')">${roster.school || 'Unknown'}</div>
                <div style="font-size: 11px; color: #888;">${playerCount} players ${roster.submission_type || 'form'}</div>
              </div>
              <div>${roster.gender || '-'}</div>
              <div>${roster.division || '-'}</div>
              <div class="article-date">${formatDate(roster.created_at)}</div>
              <div>
                <span class="article-status ${statusClass}">${roster.status || 'pending'}</span>
              </div>
              <div class="article-actions">
                <button class="btn-edit" onclick="openRosterModal('${roster.id}')">Review</button>
                <button class="btn-delete" onclick="deleteRoster('${roster.id}')">Delete</button>
              </div>
            </div>
          `;
        }).join('')}
      `;
    }
    
    function populateSchoolsDatalist() {
      // Use the teams list if available, or a basic list
      const datalist = document.getElementById('schoolsList');
      if (!datalist) return;
      
      // If teams are loaded, use those
      if (allTeams && allTeams.length > 0) {
        datalist.innerHTML = allTeams
          .map(t => `<option value="${t.shortname}">`)
          .join('');
      }
    }
    
    function openRosterModal(id) {
      currentRoster = allRosterSubmissions.find(r => r.id == id);
      if (!currentRoster) {
        showToast('Roster not found', 'error');
        return;
      }
      
      document.getElementById('rosterId').value = id;
      document.getElementById('rosterSchool').value = currentRoster.school || '';
      document.getElementById('rosterGender').value = currentRoster.gender || 'Boys';
      document.getElementById('rosterDivision').value = currentRoster.division || '';
      document.getElementById('rosterSeason').value = currentRoster.season || '2025-26';
      document.getElementById('rosterHeadCoach').value = currentRoster.head_coach || '';
      document.getElementById('rosterAssistants').value = currentRoster.assistant_coaches || '';
      document.getElementById('rosterManagers').value = currentRoster.managers || '';
      document.getElementById('rosterNotes').value = currentRoster.notes || '';
      
      // Submission info
      document.getElementById('rosterSubmitter').textContent = currentRoster.submitted_by || 'Anonymous';
      document.getElementById('rosterEmail').textContent = currentRoster.submitted_email || '-';
      document.getElementById('rosterType').textContent = currentRoster.submission_type || 'form';
      document.getElementById('rosterSubmitDate').textContent = formatDate(currentRoster.created_at);
      
      // PDF section
      if (currentRoster.pdf_url) {
        document.getElementById('rosterPdfSection').style.display = 'block';
        document.getElementById('rosterPdfLink').href = currentRoster.pdf_url;
      } else {
        document.getElementById('rosterPdfSection').style.display = 'none';
      }
      
      // Render players
      renderPlayersTable(currentRoster.players_json || []);
      
      document.getElementById('rosterModalTitle').textContent = 
        `Review: ${currentRoster.school} ${currentRoster.gender}`;
      document.getElementById('rosterModal').style.display = 'block';
      document.body.style.overflow = 'hidden';
    }
    
    function closeRosterModal() {
      document.getElementById('rosterModal').style.display = 'none';
      document.body.style.overflow = 'auto';
      currentRoster = null;
    }
    
    function renderPlayersTable(players) {
      const tbody = document.getElementById('playersTableBody');
      
      if (!players || players.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="5" style="padding: 20px; text-align: center; color: #888;">
              No players added yet. Click "Add Player" to start.
            </td>
          </tr>
        `;
        return;
      }
      
      tbody.innerHTML = players.map((player, index) => `
        <tr style="border-bottom: 1px solid #eee;">
          <td style="padding: 6px 10px;">
            <input type="text" value="${player.number || ''}" 
                   onchange="updatePlayer(${index}, 'number', this.value)"
                   style="width: 50px; padding: 5px; border: 1px solid #ddd; border-radius: 3px; font-size: 13px;">
          </td>
          <td style="padding: 6px 10px;">
            <input type="text" value="${escapeHtml(player.name || '')}" 
                   onchange="updatePlayer(${index}, 'name', this.value)"
                   style="width: 100%; padding: 5px; border: 1px solid #ddd; border-radius: 3px; font-size: 13px;">
          </td>
          <td style="padding: 6px 10px;">
            <select onchange="updatePlayer(${index}, 'class', this.value)"
                    style="padding: 5px; border: 1px solid #ddd; border-radius: 3px; font-size: 13px;">
              <option value="" ${!player.class ? 'selected' : ''}>-</option>
              <option value="FR" ${player.class === 'FR' ? 'selected' : ''}>FR</option>
              <option value="SO" ${player.class === 'SO' ? 'selected' : ''}>SO</option>
              <option value="JR" ${player.class === 'JR' ? 'selected' : ''}>JR</option>
              <option value="SR" ${player.class === 'SR' ? 'selected' : ''}>SR</option>
              <option value="8th" ${player.class === '8th' ? 'selected' : ''}>8th</option>
              <option value="7th" ${player.class === '7th' ? 'selected' : ''}>7th</option>
            </select>
          </td>
          <td style="padding: 6px 10px;">
            <select onchange="updatePlayer(${index}, 'position', this.value)"
                    style="padding: 5px; border: 1px solid #ddd; border-radius: 3px; font-size: 13px;">
              <option value="" ${!player.position ? 'selected' : ''}>-</option>
              <option value="G" ${player.position === 'G' ? 'selected' : ''}>G</option>
              <option value="F" ${player.position === 'F' ? 'selected' : ''}>F</option>
              <option value="C" ${player.position === 'C' ? 'selected' : ''}>C</option>
              <option value="G/F" ${player.position === 'G/F' ? 'selected' : ''}>G/F</option>
              <option value="F/C" ${player.position === 'F/C' ? 'selected' : ''}>F/C</option>
            </select>
          </td>
          <td style="padding: 6px 10px;">
            <button onclick="removePlayer(${index})" 
                    style="background: #ffebee; color: #c62828; border: none; padding: 4px 8px; border-radius: 3px; cursor: pointer; font-size: 11px;"></button>
          </td>
        </tr>
      `).join('');
    }
    
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
    
    function getPlayersFromTable() {
      const players = [];
      const rows = document.querySelectorAll('#playersTableBody tr');
      
      rows.forEach(row => {
        const inputs = row.querySelectorAll('input, select');
        if (inputs.length >= 4) {
          const number = inputs[0].value.trim();
          const name = inputs[1].value.trim();
          const playerClass = inputs[2].value;
          const position = inputs[3].value;
          
          if (name) { // Only add if name exists
            players.push({
              number: number,
              name: name,
              class: playerClass,
              position: position
            });
          }
        }
      });
      
      return players;
    }
    
    function updatePlayer(index, field, value) {
      if (!currentRoster) return;
      if (!currentRoster.players_json) currentRoster.players_json = [];
      if (!currentRoster.players_json[index]) currentRoster.players_json[index] = {};
      currentRoster.players_json[index][field] = value;
    }
    
    function addPlayerRow() {
      if (!currentRoster) return;
      if (!currentRoster.players_json) currentRoster.players_json = [];
      currentRoster.players_json.push({ number: '', name: '', class: '', position: '' });
      renderPlayersTable(currentRoster.players_json);
      
      // Scroll to bottom of players container
      const container = document.getElementById('playersContainer');
      container.scrollTop = container.scrollHeight;
    }
    
    function removePlayer(index) {
      if (!currentRoster || !currentRoster.players_json) return;
      currentRoster.players_json.splice(index, 1);
      renderPlayersTable(currentRoster.players_json);
    }
    
    async function saveRosterChanges() {
      const id = document.getElementById('rosterId').value;
      if (!id) return;
      
      const players = getPlayersFromTable();
      
      const updates = {
        school: document.getElementById('rosterSchool').value,
        gender: document.getElementById('rosterGender').value,
        division: document.getElementById('rosterDivision').value,
        season: document.getElementById('rosterSeason').value,
        head_coach: document.getElementById('rosterHeadCoach').value,
        assistant_coaches: document.getElementById('rosterAssistants').value,
        managers: document.getElementById('rosterManagers').value,
        notes: document.getElementById('rosterNotes').value,
        players_json: players
      };
      
      try {
        const { error } = await db
          .from('roster_submissions')
          .update(updates)
          .eq('id', id);
        
        if (error) throw error;
        
        showToast('Changes saved!', 'success');
        await loadRosters();
      } catch (err) {
        console.error('Error saving roster:', err);
        showToast('Error saving changes', 'error');
      }
    }
    
    async function approveRoster() {
      const id = document.getElementById('rosterId').value;
      if (!id) return;
      
      // First save any changes
      const players = getPlayersFromTable();
      
      const rosterData = {
        school: document.getElementById('rosterSchool').value,
        gender: document.getElementById('rosterGender').value,
        division: document.getElementById('rosterDivision').value,
        season: document.getElementById('rosterSeason').value,
        head_coach: document.getElementById('rosterHeadCoach').value,
        assistant_coaches: document.getElementById('rosterAssistants').value,
        managers: document.getElementById('rosterManagers').value,
        notes: document.getElementById('rosterNotes').value,
        players_json: players,
        status: 'approved',
        reviewed_at: new Date().toISOString(),
        reviewed_by: 'Admin'
      };
      
      try {
        const { error } = await db
          .from('roster_submissions')
          .update(rosterData)
          .eq('id', id);
        
        if (error) throw error;
        
        // Generate the roster export
        generateRosterExport(rosterData);
        
        showToast('Roster approved!', 'success');
        closeRosterModal();
        await loadRosters();
      } catch (err) {
        console.error('Error approving roster:', err);
        showToast('Error approving roster', 'error');
      }
    }
    
    function generateRosterExport(roster) {
      // Generate rosters_data.js format
      const entry = {
        school: roster.school,
        gender: roster.gender,
        players: roster.players_json.map(p => ({
          number: p.number,
          name: p.name,
          class: p.class,
          position: p.position
        })),
        head_coach: roster.head_coach,
        assistant_coaches: roster.assistant_coaches,
        managers: roster.managers
      };
      
      const jsonStr = JSON.stringify(entry, null, 2);
      
      // Create download
      const blob = new Blob([jsonStr], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `roster_${roster.school.toLowerCase().replace(/\s+/g, '-')}_${roster.gender.toLowerCase()}.json`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
      
      // Also show in a modal/alert for easy copy
      const copyText = `// ${roster.school} ${roster.gender}\n${jsonStr}`;
      
      if (confirm('Roster exported! Would you like to copy the formatted entry to clipboard?')) {
        navigator.clipboard.writeText(copyText).then(() => {
          showToast('Copied to clipboard!', 'success');
        });
      }
    }
    
    async function rejectRoster() {
      const id = document.getElementById('rosterId').value;
      if (!id) return;
      
      if (!confirm('Are you sure you want to reject this roster submission?')) return;
      
      try {
        const { error } = await db
          .from('roster_submissions')
          .update({
            status: 'rejected',
            notes: document.getElementById('rosterNotes').value,
            reviewed_at: new Date().toISOString(),
            reviewed_by: 'Admin'
          })
          .eq('id', id);
        
        if (error) throw error;
        
        showToast('Roster rejected', 'success');
        closeRosterModal();
        await loadRosters();
      } catch (err) {
        console.error('Error rejecting roster:', err);
        showToast('Error rejecting roster', 'error');
      }
    }
    
    async function deleteRoster(id) {
      if (!confirm('Are you sure you want to permanently delete this roster submission?')) return;
      
      try {
        const { error } = await db
          .from('roster_submissions')
          .delete()
          .eq('id', id);
        
        if (error) throw error;
        
        showToast('Roster deleted', 'success');
        await loadRosters();
      } catch (err) {
        console.error('Error deleting roster:', err);
        showToast('Error deleting roster', 'error');
      }
    }
    
    // Delete by Slug functionality
    function openDeleteBySlugModal() {
      const modal = document.getElementById('deleteBySlugModal');
      document.getElementById('deleteSlugInput').value = '';
      document.getElementById('deleteSlugResult').innerHTML = '';
      modal.style.display = 'flex';
    }
    
    function closeDeleteBySlugModal() {
      document.getElementById('deleteBySlugModal').style.display = 'none';
    }
    
    async function lookupBySlug() {
      const slug = document.getElementById('deleteSlugInput').value.trim();
      const resultDiv = document.getElementById('deleteSlugResult');
      
      if (!slug) {
        resultDiv.innerHTML = '<p style="color: #c62828;">Please enter a slug</p>';
        return;
      }
      
      // Extract slug from URL if full URL was pasted
      let cleanSlug = slug;
      if (slug.includes('/article/')) {
        cleanSlug = slug.split('/article/').pop().split('?')[0].split('#')[0];
      }
      document.getElementById('deleteSlugInput').value = cleanSlug;
      
      resultDiv.innerHTML = '<p>Looking up article...</p>';
      
      const { data, error } = await db
        .from('articles')
        .select('id, title, slug, status, created_at')
        .eq('slug', cleanSlug)
        .single();
      
      if (error || !data) {
        resultDiv.innerHTML = '<p style="color: #c62828;">No article found with that slug</p>';
        return;
      }
      
      resultDiv.innerHTML = `
        <div style="background: #f5f5f5; padding: 15px; border-radius: 8px; margin-top: 10px;">
          <p><strong>Title:</strong> ${data.title || 'Untitled'}</p>
          <p><strong>Status:</strong> ${data.status}</p>
          <p><strong>Created:</strong> ${formatDate(data.created_at)}</p>
          <p><strong>ID:</strong> ${data.id}</p>
          <button onclick="confirmDeleteBySlug('${data.id}', '${cleanSlug}')" style="background: #c62828; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin-top: 10px;">
             üóëÔ∏è Delete This Article
          </button>
        </div>
      `;
    }
    
    async function confirmDeleteBySlug(id, slug) {
      if (!confirm(`Are you sure you want to delete this article?\n\nSlug: ${slug}\n\nThis cannot be undone.`)) {
        return;
      }
      
      const { error } = await db
        .from('articles')
        .delete()
        .eq('id', id);
      
      if (error) {
        showToast('Error deleting article: ' + error.message, 'error');
        return;
      }
      
      showToast('Article deleted successfully', 'success');
      closeDeleteBySlugModal();
      
      // Refresh articles list
      const { data } = await db.from('articles').select('*').order('created_at', { ascending: false });
      articles = data || [];
      renderArticles();
    }
    
    // ===== THE BASH MANAGEMENT =====
    let bashSchedule = [];
    let bashChampions = [];
    let bashAwards = [];
    let bashSettings = {
      year: 2025,
      startDate: '2025-12-26',
      endDate: '2025-12-30',
      venue: 'Farmington High School'
    };
    
    function showBashTab(tab) {
      document.querySelectorAll('.bash-admin-tab').forEach(t => t.classList.remove('active'));
      event.target.classList.add('active');
      document.querySelectorAll('.bash-sub-panel').forEach(p => p.classList.remove('active'));
      document.getElementById('bash' + tab.charAt(0).toUpperCase() + tab.slice(1) + 'Panel').classList.add('active');
      
      // Initialize scorebook/recap when those tabs are shown
      if (tab === 'scorebook' || tab === 'recap') {
        initBashScorebook();
      }
      // Load content when stories tab is shown
      if (tab === 'stories') {
        loadBashContent();
      }
    }
    
    async function loadBashData() {
      await Promise.all([loadBashSchedule(), loadBashChampions(), loadBashAwards(), loadBashContent()]);
      populateBashAwardYearFilter();
    }
    
    async function loadBashSchedule() {
      const { data, error } = await db.from('bash_schedule').select('*').order('date').order('time');
      bashSchedule = error ? [] : (data || []);
      renderBashSchedule();
    }
    
    async function loadBashChampions() {
      const { data, error } = await db.from('bash_champions').select('*').order('year', { ascending: false });
      bashChampions = error ? [] : (data || []);
      renderBashChampions();
    }
    
    async function loadBashAwards() {
      const { data, error } = await db.from('bash_awards').select('*').order('year', { ascending: false }).order('gender');
      bashAwards = error ? [] : (data || []);
      renderBashAwards();
    }
    
    // ===== BASH CONTENT MANAGEMENT =====
    let bashContent = [];
    let bashArticles = [];
    
    async function loadBashContent() {
      // Load from bash_content table (legacy)
      const { data: content, error: contentError } = await db.from('bash_content').select('*').order('pinned', { ascending: false }).order('published_at', { ascending: false });
      bashContent = contentError ? [] : (content || []);
      
      // Also load from articles table where tags contain 'The Bash'
      const { data: articles, error: articlesError } = await db.from('articles').select('*').contains('tags', ['The Bash']).order('published_at', { ascending: false });
      bashArticles = articlesError ? [] : (articles || []);
      
      renderBashContent();
    }
    
    function renderBashContent() {
      const tbody = document.getElementById('bashContentBody');
      if (!tbody) return;
      const typeFilter = document.getElementById('bashContentTypeFilter')?.value || '';
      
      // Convert articles to bash_content format for unified display
      const articlesAsContent = bashArticles.map(a => ({
        id: a.id,
        title: a.title,
        content_type: 'story',
        published: a.status === 'published',
        published_at: a.published_at,
        teams: a.tags?.filter(t => t !== 'The Bash' && t !== 'Boys' && t !== 'Girls') || [],
        pinned: false,
        isArticle: true,
        slug: a.slug
      }));
      
      // Combine both sources, avoiding duplicates by title
      const existingTitles = new Set(bashContent.map(c => c.title));
      const combined = [...bashContent, ...articlesAsContent.filter(a => !existingTitles.has(a.title))];
      
      let filtered = combined.filter(c => !typeFilter || c.content_type === typeFilter);
      document.getElementById('bashContentCount').textContent = filtered.length + ' items';
      
      if (filtered.length === 0) {
        tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 40px; color: #888;">No content found.</td></tr>';
        return;
      }
      
      const typeLabels = { scorebook: 'üìä Scorebook', story: 'üì∞ Story', recap: 'üåô Recap' };
      const typeColors = { scorebook: '#e3f2fd', story: '#fff3e0', recap: '#e8f5e9' };
      
      tbody.innerHTML = filtered.map(c => `
        <tr>
          <td style="text-align: center;">
            ${c.isArticle ? '<span style="color: #888;">-</span>' : `<button onclick="toggleBashContentPin('${c.id}')" style="background: none; border: none; cursor: pointer; font-size: 16px; opacity: ${c.pinned ? '1' : '0.3'};">üìå</button>`}
          </td>
          <td><strong>${c.title || 'Untitled'}</strong></td>
          <td><span style="padding: 3px 8px; border-radius: 10px; font-size: 11px; background: ${typeColors[c.content_type] || '#f5f5f5'};">${typeLabels[c.content_type] || c.content_type}${c.isArticle ? ' (Article)' : ''}</span></td>
          <td>${c.day ? 'Day ' + c.day : '-'}</td>
          <td style="font-size: 11px; max-width: 120px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${(c.teams || []).join(', ') || '-'}</td>
          <td style="text-align: center;">${c.isArticle ? '<a href="/article/' + c.slug + '" target="_blank" style="font-size: 11px;">View</a>' : (c.show_on_main_site ? '‚úçÔ∏è‚Ä¶' : '-')}</td>
          <td><span style="padding: 3px 8px; border-radius: 10px; font-size: 11px; background: ${c.published ? '#e8f5e9' : '#ffebee'}; color: ${c.published ? '#2e7d32' : '#c62828'};">${c.published ? 'Published' : 'Draft'}</span></td>
          <td>
            ${c.isArticle ? `<button onclick="editArticle('${c.id}')" style="background: none; border: none; color: #1976d2; cursor: pointer; font-size: 12px;">Edit</button>` : (c.content_type === 'story' ? `<button onclick="editBashStory('${c.id}')" style="background: none; border: none; color: #1976d2; cursor: pointer; font-size: 12px;">Edit</button>` : '')}
            <button onclick="${c.isArticle ? `deleteArticle('${c.id}')` : `deleteBashContent('${c.id}')`}" style="background: none; border: none; color: #d32f2f; cursor: pointer; font-size: 12px;">Delete</button>
          </td>
        </tr>
      `).join('');
    }
    
    function filterBashContent() { renderBashContent(); }
    
    function openBashStoryModal(id) {
      document.getElementById('bashStoryModalTitle').textContent = id ? 'Edit Story' : 'New Story';
      document.getElementById('bashStoryId').value = id || '';
      
      if (id) {
        const s = bashContent.find(x => x.id === id);
        if (s) {
          document.getElementById('bashStoryTitle').value = s.title || '';
          document.getElementById('bashStoryDay').value = s.day || '';
          document.getElementById('bashStoryDivision').value = s.division || '';
          document.getElementById('bashStoryAuthor').value = s.author || 'Ball603 Staff';
          document.getElementById('bashStoryTeams').value = (s.teams || []).join(', ');
          document.getElementById('bashStoryImage').value = s.featured_image || '';
          document.getElementById('bashStoryContent').value = s.content || '';
          document.getElementById('bashStoryPinned').checked = s.pinned || false;
          document.getElementById('bashStoryPublished').checked = s.published !== false;
        }
      } else {
        document.getElementById('bashStoryTitle').value = '';
        document.getElementById('bashStoryDay').value = '';
        document.getElementById('bashStoryDivision').value = '';
        document.getElementById('bashStoryAuthor').value = 'Ball603 Staff';
        document.getElementById('bashStoryTeams').value = '';
        document.getElementById('bashStoryImage').value = '';
        document.getElementById('bashStoryContent').value = '';
        document.getElementById('bashStoryPinned').checked = false;
        document.getElementById('bashStoryPublished').checked = true;
      }
      document.getElementById('bashStoryModal').style.display = 'block';
    }
    
    function closeBashStoryModal() { document.getElementById('bashStoryModal').style.display = 'none'; }
    function editBashStory(id) { openBashStoryModal(id); }
    
    async function saveBashStory() {
      const id = document.getElementById('bashStoryId').value;
      const teamsStr = document.getElementById('bashStoryTeams').value;
      const teamsArray = teamsStr ? teamsStr.split(',').map(t => t.trim()).filter(t => t) : [];
      
      const data = {
        content_type: 'story',
        title: document.getElementById('bashStoryTitle').value,
        day: document.getElementById('bashStoryDay').value ? parseInt(document.getElementById('bashStoryDay').value) : null,
        division: document.getElementById('bashStoryDivision').value || null,
        author: document.getElementById('bashStoryAuthor').value || 'Ball603 Staff',
        teams: teamsArray,
        featured_image: document.getElementById('bashStoryImage').value || null,
        content: document.getElementById('bashStoryContent').value || null,
        pinned: document.getElementById('bashStoryPinned').checked,
        published: document.getElementById('bashStoryPublished').checked,
        show_on_main_site: false
      };
      
      if (!id) {
        data.slug = data.title.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/-+/g, '-').replace(/^-|-$/g, '') + '-' + Date.now();
        data.excerpt = (data.content || '').split('.').slice(0, 2).join('.') + '.';
      }
      
      try {
        const { error } = id 
          ? await db.from('bash_content').update(data).eq('id', id)
          : await db.from('bash_content').insert([data]);
        if (error) throw error;
        showToast('Story saved', 'success');
        closeBashStoryModal();
        await loadBashContent();
      } catch (err) {
        showToast('Error: ' + err.message, 'error');
      }
    }
    
    async function deleteBashContent(id) {
      if (!confirm('Delete this content?')) return;
      try {
        const { error } = await db.from('bash_content').delete().eq('id', id);
        if (error) throw error;
        showToast('Deleted', 'success');
        await loadBashContent();
      } catch (err) {
        showToast('Error: ' + err.message, 'error');
      }
    }
    
    async function toggleBashContentPin(id) {
      const item = bashContent.find(c => c.id === id);
      if (!item) return;
      try {
        const { error } = await db.from('bash_content').update({ pinned: !item.pinned }).eq('id', id);
        if (error) throw error;
        showToast(item.pinned ? 'Unpinned' : 'Pinned', 'success');
        await loadBashContent();
      } catch (err) {
        showToast('Error: ' + err.message, 'error');
      }
    }
    
    function renderBashSchedule() {
      const tbody = document.getElementById('bashScheduleBody');
      const divisionFilter = document.getElementById('bashDivisionFilter').value;
      let filtered = bashSchedule.filter(g => !divisionFilter || g.division === divisionFilter);
      document.getElementById('bashGameCount').textContent = filtered.length + ' games';
      if (filtered.length === 0) {
        tbody.innerHTML = '<tr><td colspan="10" style="text-align: center; padding: 40px; color: #888;">No games found. Click "Add Game" to create one.</td></tr>';
        return;
      }
      tbody.innerHTML = filtered.map(g => {
        const hasScore = g.away_score !== null && g.home_score !== null;
        const awayWon = hasScore && g.away_score > g.home_score;
        const homeWon = hasScore && g.home_score > g.away_score;
        const coverageIcons = [];
        if (g.recap) coverageIcons.push('R');
        if (g.photos) coverageIcons.push('P');
        if (g.video) coverageIcons.push('V');
        if (g.highlights) coverageIcons.push('H');
        return '<tr>' +
          '<td>' + g.date + '</td>' +
          '<td>' + g.time + '</td>' +
          '<td>' + (g.game_number || '-') + '</td>' +
          '<td><span class="division-badge ' + (g.division || '').toLowerCase() + '">' + (g.division || '-') + '</span></td>' +
          '<td class="' + (awayWon ? 'bash-winner' : '') + '">' + (g.away || '-') + '</td>' +
          '<td class="bash-score">' + (hasScore ? g.away_score + '-' + g.home_score + (g.overtime ? ' OT' : '') : 'vs') + '</td>' +
          '<td class="' + (homeWon ? 'bash-winner' : '') + '">' + (g.home || '-') + '</td>' +
          '<td>' + (g.site || '-') + '</td>' +
          '<td>' + (coverageIcons.join(' ') || '-') + '</td>' +
          '<td><button onclick="editBashGame(\'' + g.id + '\')" class="btn-edit">Edit</button> <button onclick="deleteBashGame(\'' + g.id + '\')" class="btn-delete">Del</button></td>' +
          '</tr>';
      }).join('');
    }
    
    function renderBashChampions() {
      const tbody = document.getElementById('bashChampionsBody');
      const divisionFilter = document.getElementById('bashChampionDivisionFilter').value;
      let filtered = bashChampions.filter(c => !divisionFilter || c.gender === divisionFilter);
      document.getElementById('bashChampionCount').textContent = filtered.length + ' records';
      if (filtered.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 40px; color: #888;">No champions found.</td></tr>';
        return;
      }
      tbody.innerHTML = filtered.map(c => '<tr>' +
        '<td><strong>' + c.year + '</strong></td>' +
        '<td><span class="division-badge ' + (c.gender || '').toLowerCase() + '">' + c.gender + '</span></td>' +
        '<td class="bash-winner">' + c.champion + '</td>' +
        '<td class="bash-score">' + c.champion_score + '-' + c.runner_up_score + '</td>' +
        '<td>' + c.runner_up + '</td>' +
        '<td>' + (c.overtime ? 'Y' : '') + '</td>' +
        '<td><button onclick="editBashChampion(\'' + c.id + '\')" class="btn-edit">Edit</button> <button onclick="deleteBashChampion(\'' + c.id + '\')" class="btn-delete">Del</button></td>' +
        '</tr>').join('');
    }
    
    function renderBashAwards() {
      const tbody = document.getElementById('bashAwardsBody');
      const yearFilter = document.getElementById('bashAwardYearFilter').value;
      const typeFilter = document.getElementById('bashAwardTypeFilter').value;
      let filtered = bashAwards.filter(a => (!yearFilter || a.year === parseInt(yearFilter)) && (!typeFilter || a.award === typeFilter));
      document.getElementById('bashAwardCount').textContent = filtered.length + ' records';
      if (filtered.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 40px; color: #888;">No awards found.</td></tr>';
        return;
      }
      tbody.innerHTML = filtered.map(a => '<tr>' +
        '<td><strong>' + a.year + '</strong></td>' +
        '<td><span class="division-badge ' + (a.gender || '').toLowerCase() + '">' + a.gender + '</span></td>' +
        '<td>' + a.award + '</td>' +
        '<td>' + (a.name || '(Team)') + '</td>' +
        '<td>' + a.school + '</td>' +
        '<td><button onclick="editBashAward(\'' + a.id + '\')" class="btn-edit">Edit</button> <button onclick="deleteBashAward(\'' + a.id + '\')" class="btn-delete">Del</button></td>' +
        '</tr>').join('');
    }
    
    function populateBashAwardYearFilter() {
      const select = document.getElementById('bashAwardYearFilter');
      const years = [...new Set(bashAwards.map(a => a.year))].sort((a, b) => b - a);
      select.innerHTML = '<option value="">All Years</option>' + years.map(y => '<option value="' + y + '">' + y + '</option>').join('');
    }
    
    function filterBashSchedule() { renderBashSchedule(); }
    function filterBashChampions() { renderBashChampions(); }
    function filterBashAwards() { renderBashAwards(); }
    
    function openBashGameModal(id) {
      document.getElementById('bashGameModalTitle').textContent = id ? 'Edit Game' : 'Add Game';
      document.getElementById('bashGameId').value = id || '';
      if (id) {
        const g = bashSchedule.find(x => x.id === id);
        if (g) {
          document.getElementById('bashGameDate').value = g.date;
          document.getElementById('bashGameTime').value = g.time;
          document.getElementById('bashGameNumber').value = g.game_number || '';
          document.getElementById('bashGameDivision').value = g.division;
          document.getElementById('bashGameAway').value = g.away;
          document.getElementById('bashGameAwayScore').value = g.away_score !== null ? g.away_score : '';
          document.getElementById('bashGameHome').value = g.home;
          document.getElementById('bashGameHomeScore').value = g.home_score !== null ? g.home_score : '';
          document.getElementById('bashGameSite').value = g.site || 'FHS';
          document.getElementById('bashGameOvertime').value = g.overtime ? 'true' : 'false';
          document.getElementById('bashGameSpecial').value = g.special ? 'true' : 'false';
          document.getElementById('bashGameRecap').value = g.recap || '';
          document.getElementById('bashGamePhotos').value = g.photos || '';
          document.getElementById('bashGameVideo').value = g.video || '';
          document.getElementById('bashGameHighlights').value = g.highlights || '';
        }
      } else {
        document.getElementById('bashGameDate').value = 'Dec 26';
        document.getElementById('bashGameTime').value = '';
        document.getElementById('bashGameNumber').value = '';
        document.getElementById('bashGameDivision').value = 'Boys';
        document.getElementById('bashGameAway').value = '';
        document.getElementById('bashGameAwayScore').value = '';
        document.getElementById('bashGameHome').value = '';
        document.getElementById('bashGameHomeScore').value = '';
        document.getElementById('bashGameSite').value = 'FHS';
        document.getElementById('bashGameOvertime').value = 'false';
        document.getElementById('bashGameSpecial').value = 'false';
        document.getElementById('bashGameRecap').value = '';
        document.getElementById('bashGamePhotos').value = '';
        document.getElementById('bashGameVideo').value = '';
        document.getElementById('bashGameHighlights').value = '';
      }
      document.getElementById('bashGameModal').style.display = 'block';
    }
    function closeBashGameModal() { document.getElementById('bashGameModal').style.display = 'none'; }
    function editBashGame(id) { openBashGameModal(id); }
    
    async function saveBashGame() {
      const id = document.getElementById('bashGameId').value;
      const data = {
        date: document.getElementById('bashGameDate').value,
        time: document.getElementById('bashGameTime').value,
        game_number: document.getElementById('bashGameNumber').value ? parseInt(document.getElementById('bashGameNumber').value) : null,
        division: document.getElementById('bashGameDivision').value,
        away: document.getElementById('bashGameAway').value,
        away_score: document.getElementById('bashGameAwayScore').value ? parseInt(document.getElementById('bashGameAwayScore').value) : null,
        home: document.getElementById('bashGameHome').value,
        home_score: document.getElementById('bashGameHomeScore').value ? parseInt(document.getElementById('bashGameHomeScore').value) : null,
        site: document.getElementById('bashGameSite').value,
        overtime: document.getElementById('bashGameOvertime').value === 'true',
        special: document.getElementById('bashGameSpecial').value === 'true',
        recap: document.getElementById('bashGameRecap').value || null,
        photos: document.getElementById('bashGamePhotos').value || null,
        video: document.getElementById('bashGameVideo').value || null,
        highlights: document.getElementById('bashGameHighlights').value || null
      };
      try {
        const { error } = id ? await db.from('bash_schedule').update(data).eq('id', id) : await db.from('bash_schedule').insert([data]);
        if (error) throw error;
        showToast('Game saved', 'success');
        closeBashGameModal();
        await loadBashSchedule();
      } catch (err) { showToast('Error: ' + err.message, 'error'); }
    }
    
    async function deleteBashGame(id) {
      if (!confirm('Delete this game?')) return;
      try {
        const { error } = await db.from('bash_schedule').delete().eq('id', id);
        if (error) throw error;
        showToast('Deleted', 'success');
        await loadBashSchedule();
      } catch (err) { showToast('Error', 'error'); }
    }
    
    function openBashChampionModal(id) {
      document.getElementById('bashChampionModalTitle').textContent = id ? 'Edit Champion' : 'Add Champion';
      document.getElementById('bashChampionId').value = id || '';
      if (id) {
        const c = bashChampions.find(x => x.id === id);
        if (c) {
          document.getElementById('bashChampionYear').value = c.year;
          document.getElementById('bashChampionDivision').value = c.gender;
          document.getElementById('bashChampionWinner').value = c.champion;
          document.getElementById('bashChampionWinnerScore').value = c.champion_score;
          document.getElementById('bashChampionRunnerUp').value = c.runner_up;
          document.getElementById('bashChampionRunnerUpScore').value = c.runner_up_score;
          document.getElementById('bashChampionOvertime').checked = c.overtime;
        }
      } else {
        document.getElementById('bashChampionYear').value = new Date().getFullYear();
        document.getElementById('bashChampionDivision').value = 'Boys';
        document.getElementById('bashChampionWinner').value = '';
        document.getElementById('bashChampionWinnerScore').value = '';
        document.getElementById('bashChampionRunnerUp').value = '';
        document.getElementById('bashChampionRunnerUpScore').value = '';
        document.getElementById('bashChampionOvertime').checked = false;
      }
      document.getElementById('bashChampionModal').style.display = 'block';
    }
    function closeBashChampionModal() { document.getElementById('bashChampionModal').style.display = 'none'; }
    function editBashChampion(id) { openBashChampionModal(id); }
    
    async function saveBashChampion() {
      const id = document.getElementById('bashChampionId').value;
      const data = {
        year: parseInt(document.getElementById('bashChampionYear').value),
        gender: document.getElementById('bashChampionDivision').value,
        champion: document.getElementById('bashChampionWinner').value,
        champion_score: parseInt(document.getElementById('bashChampionWinnerScore').value),
        runner_up: document.getElementById('bashChampionRunnerUp').value,
        runner_up_score: parseInt(document.getElementById('bashChampionRunnerUpScore').value),
        overtime: document.getElementById('bashChampionOvertime').checked
      };
      try {
        const { error } = id ? await db.from('bash_champions').update(data).eq('id', id) : await db.from('bash_champions').insert([data]);
        if (error) throw error;
        showToast('Champion saved', 'success');
        closeBashChampionModal();
        await loadBashChampions();
      } catch (err) { showToast('Error: ' + err.message, 'error'); }
    }
    
    async function deleteBashChampion(id) {
      if (!confirm('Delete?')) return;
      try {
        const { error } = await db.from('bash_champions').delete().eq('id', id);
        if (error) throw error;
        showToast('Deleted', 'success');
        await loadBashChampions();
      } catch (err) { showToast('Error', 'error'); }
    }
    
    function openBashAwardModal(id) {
      document.getElementById('bashAwardModalTitle').textContent = id ? 'Edit Award' : 'Add Award';
      document.getElementById('bashAwardId').value = id || '';
      if (id) {
        const a = bashAwards.find(x => x.id === id);
        if (a) {
          document.getElementById('bashAwardYear').value = a.year;
          document.getElementById('bashAwardDivision').value = a.gender;
          document.getElementById('bashAwardType').value = a.award;
          document.getElementById('bashAwardName').value = a.name || '';
          document.getElementById('bashAwardSchool').value = a.school;
        }
      } else {
        document.getElementById('bashAwardYear').value = new Date().getFullYear();
        document.getElementById('bashAwardDivision').value = 'Boys';
        document.getElementById('bashAwardType').value = 'MVP';
        document.getElementById('bashAwardName').value = '';
        document.getElementById('bashAwardSchool').value = '';
      }
      document.getElementById('bashAwardModal').style.display = 'block';
    }
    function closeBashAwardModal() { document.getElementById('bashAwardModal').style.display = 'none'; }
    function editBashAward(id) { openBashAwardModal(id); }
    
    async function saveBashAward() {
      const id = document.getElementById('bashAwardId').value;
      const data = {
        year: parseInt(document.getElementById('bashAwardYear').value),
        gender: document.getElementById('bashAwardDivision').value,
        award: document.getElementById('bashAwardType').value,
        name: document.getElementById('bashAwardName').value || null,
        school: document.getElementById('bashAwardSchool').value
      };
      try {
        const { error } = id ? await db.from('bash_awards').update(data).eq('id', id) : await db.from('bash_awards').insert([data]);
        if (error) throw error;
        showToast('Award saved', 'success');
        closeBashAwardModal();
        await loadBashAwards();
        populateBashAwardYearFilter();
      } catch (err) { showToast('Error: ' + err.message, 'error'); }
    }
    
    async function deleteBashAward(id) {
      if (!confirm('Delete?')) return;
      try {
        const { error } = await db.from('bash_awards').delete().eq('id', id);
        if (error) throw error;
        showToast('Deleted', 'success');
        await loadBashAwards();
      } catch (err) { showToast('Error', 'error'); }
    }
    
    function saveBashSettings() {
      bashSettings = {
        year: parseInt(document.getElementById('bashSettingYear').value),
        startDate: document.getElementById('bashSettingStartDate').value,
        endDate: document.getElementById('bashSettingEndDate').value,
        venue: document.getElementById('bashSettingVenue').value
      };
      localStorage.setItem('bashSettings', JSON.stringify(bashSettings));
      showToast('Settings saved', 'success');
    }
    
    function exportBashData() {
      const data = { settings: bashSettings, schedule: bashSchedule, champions: bashChampions, awards: bashAwards };
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'the-bash-data-' + new Date().toISOString().split('T')[0] + '.json';
      a.click();
      showToast('Exported', 'success');
    }
    
    function importBashData() {
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = '.json';
      input.onchange = async (e) => {
        const file = e.target.files[0];
        if (!file) return;
        try {
          const text = await file.text();
          const data = JSON.parse(text);
          if (data.schedule) for (const g of data.schedule) { delete g.id; await db.from('bash_schedule').insert([g]); }
          if (data.champions) for (const c of data.champions) { delete c.id; await db.from('bash_champions').insert([c]); }
          if (data.awards) for (const a of data.awards) { delete a.id; await db.from('bash_awards').insert([a]); }
          showToast('Imported', 'success');
          await loadBashData();
        } catch (err) { showToast('Error: ' + err.message, 'error'); }
      };
      input.click();
    }
    
    function regenerateBashDataFile() {
      const file = 'const BASH_DATA = ' + JSON.stringify({
        info: bashSettings,
        schedule: bashSchedule.map(g => ({ date: g.date, time: g.time, game: g.game_number, division: g.division, away: g.away, awayScore: g.away_score, home: g.home, homeScore: g.home_score, site: g.site, overtime: g.overtime, special: g.special, recap: g.recap, photos: g.photos, video: g.video, highlights: g.highlights })),
        champions: bashChampions.map(c => ({ year: c.year, gender: c.gender, champion: c.champion, championScore: c.champion_score, runnerUp: c.runner_up, runnerUpScore: c.runner_up_score, overtime: c.overtime })),
        awards: bashAwards.map(a => ({ year: a.year, gender: a.gender, award: a.award, name: a.name, school: a.school }))
      }, null, 2) + ';';
      const blob = new Blob([file], { type: 'application/javascript' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'the-bash-data.js';
      a.click();
      showToast('Generated', 'success');
    }
    
    // ===== BASH SCOREBOOK =====
    let bashSBSelectedGame = null;
    let bashSBOTCount = 0;
    
    function filterBashSBGames() {
      const dateFilter = document.getElementById('bashSBDateFilter').value;
      const divFilter = document.getElementById('bashSBDivFilter').value;
      
      let filtered = bashSchedule.filter(g => {
        if (g.special) return false; // Skip contest entries
        if (dateFilter && g.date !== dateFilter) return false;
        if (divFilter && g.division !== divFilter) return false;
        return true;
      });
      
      const container = document.getElementById('bashSBGameList');
      if (filtered.length === 0) {
        container.innerHTML = '<div style="padding: 20px; text-align: center; color: #888;">No games found</div>';
        return;
      }
      
      container.innerHTML = filtered.map(g => {
        const hasScore = g.away_score !== null && g.home_score !== null;
        const hasRecap = g.recap && g.recap.trim() !== '';
        const statusColor = hasRecap ? '#4caf50' : (hasScore ? '#ff9800' : '#ccc');
        const statusText = hasRecap ? 'Published' : (hasScore ? 'Has Score' : 'Pending');
        
        return '<div onclick="selectBashSBGame(\'' + g.id + '\')" style="padding: 10px 12px; border-bottom: 1px solid #eee; cursor: pointer; display: flex; justify-content: space-between; align-items: center;" onmouseover="this.style.background=\'#f5f5f5\'" onmouseout="this.style.background=\'\'"><div><div style="font-size: 13px; font-weight: 500;">' + g.away + ' @ ' + g.home + '</div><div style="font-size: 11px; color: #888;">' + g.date + ' ' + g.time + ' - ' + (g.division || '') + '</div></div><span style="font-size: 10px; padding: 2px 8px; border-radius: 10px; background: ' + statusColor + '; color: white;">' + statusText + '</span></div>';
      }).join('');
    }
    
    async function selectBashSBGame(gameId) {
      bashSBSelectedGame = bashSchedule.find(g => g.id === gameId);
      if (!bashSBSelectedGame) return;
      
      // Show entry panel, hide empty state
      document.getElementById('bashSBEmptyState').style.display = 'none';
      document.getElementById('bashSBEntryPanel').style.display = 'block';
      document.getElementById('bashSBPreviewPanel').style.display = 'none';
      
      // Populate fields
      document.getElementById('bashSBGameId').value = gameId;
      document.getElementById('bashSBMatchup').textContent = bashSBSelectedGame.away + ' @ ' + bashSBSelectedGame.home;
      document.getElementById('bashSBAwayName').textContent = bashSBSelectedGame.away;
      document.getElementById('bashSBHomeName').textContent = bashSBSelectedGame.home;
      document.getElementById('bashSBAwayLabel').textContent = bashSBSelectedGame.away;
      document.getElementById('bashSBHomeLabel').textContent = bashSBSelectedGame.home;
      
      // Clear quarter scores
      ['bashSBAwayQ1','bashSBAwayQ2','bashSBAwayQ3','bashSBAwayQ4','bashSBAwayFinal',
       'bashSBHomeQ1','bashSBHomeQ2','bashSBHomeQ3','bashSBHomeQ4','bashSBHomeFinal'].forEach(id => {
        document.getElementById(id).value = '';
      });
      
      // Reset OT
      bashSBOTCount = 0;
      document.getElementById('bashSBOTHeader').innerHTML = '';
      document.getElementById('bashSBAwayOTCell').innerHTML = '';
      document.getElementById('bashSBHomeOTCell').innerHTML = '';
      
      // Populate rosters from database
      const rosters = await getBashTeamRosters();
      populateBashRoster('away', rosters.away, bashSBSelectedGame.away);
      populateBashRoster('home', rosters.home, bashSBSelectedGame.home);
      
      // Reset totals
      document.getElementById('bashSBAwayTotal').textContent = '0';
      document.getElementById('bashSBHomeTotal').textContent = '0';
      
      document.getElementById('bashSBNotes').value = '';
    }
    
    async function getBashTeamRosters() {
      if (!bashSBSelectedGame) return { away: null, home: null };
      
      const gender = bashSBSelectedGame.division || 'Boys';
      const awayName = bashSBSelectedGame.away;
      const homeName = bashSBSelectedGame.home;
      
      console.log('=== getBashTeamRosters ===');
      console.log('Looking for:', { gender, awayName, homeName });
      
      try {
        // Fetch rosters from database (same as main scorebook)
        const { data: rosters, error } = await db
          .from('roster_submissions')
          .select('*')
          .eq('gender', gender);
        
        if (error) {
          console.error('Error fetching rosters:', error);
          return { away: null, home: null };
        }
        
        console.log('Found', rosters?.length || 0, 'rosters for gender:', gender);
        
        // Find matching rosters with flexible name matching
        const findRoster = (teamName) => {
          if (!rosters || !teamName) return null;
          const normalizedTeam = teamName.toLowerCase().trim();
          
          // First try approved roster with exact match
          let match = rosters.find(r => {
            if (r.status !== 'approved') return false;
            const normalizedSchool = (r.school || '').toLowerCase().trim();
            return normalizedSchool === normalizedTeam;
          });
          
          // Try approved with partial match
          if (!match) {
            match = rosters.find(r => {
              if (r.status !== 'approved') return false;
              const normalizedSchool = (r.school || '').toLowerCase().trim();
              return normalizedSchool.includes(normalizedTeam) || normalizedTeam.includes(normalizedSchool);
            });
          }
          
          // Fall back to any status with exact match
          if (!match) {
            match = rosters.find(r => {
              const normalizedSchool = (r.school || '').toLowerCase().trim();
              return normalizedSchool === normalizedTeam;
            });
          }
          
          // Fall back to any status with partial match
          if (!match) {
            match = rosters.find(r => {
              const normalizedSchool = (r.school || '').toLowerCase().trim();
              return normalizedSchool.includes(normalizedTeam) || normalizedTeam.includes(normalizedSchool);
            });
          }
          
          if (match) {
            console.log('Found roster for', teamName, ':', match.school, '(status:', match.status + ')');
          } else {
            console.log('No roster found for:', teamName);
          }
          
          return match;
        };
        
        const awayRoster = findRoster(awayName);
        const homeRoster = findRoster(homeName);
        
        // Convert database format to expected format
        const formatRoster = (r) => {
          if (!r) return null;
          return {
            school: r.school,
            gender: r.gender,
            players: r.players_json || [],
            head_coach: r.head_coach,
            assistant_coaches: r.assistant_coaches,
            managers: r.managers
          };
        };
        
        return { 
          away: formatRoster(awayRoster), 
          home: formatRoster(homeRoster) 
        };
        
      } catch (err) {
        console.error('Error in getBashTeamRosters:', err);
        return { away: null, home: null };
      }
    }
    
    function populateBashRoster(team, roster, teamName) {
      const container = document.getElementById('bashSB' + team.charAt(0).toUpperCase() + team.slice(1) + 'Scorers');
      container.innerHTML = '';
      
      if (roster && roster.players && roster.players.length > 0) {
        roster.players.forEach(player => {
          const row = document.createElement('div');
          row.className = 'bash-roster-row';
          row.innerHTML = 
            '<span class="player-info" data-player="' + player.name + '" data-team="' + team + '"><span class="player-num">#' + player.number + '</span>' + player.name + '</span>' +
            '<input type="number" class="pts-input" placeholder="Pts" data-player="' + player.name + '" data-team="' + team + '" onchange="updateBashPointsTotal(\'' + team + '\')">' +
            '<input type="number" class="fg3-input" placeholder="3FG" data-player="' + player.name + '" data-team="' + team + '">';
          container.appendChild(row);
        });
      } else {
        // No roster found - add blank rows
        for (let i = 0; i < 8; i++) {
          addBashBlankPlayer(team);
        }
      }
    }
    
    function addBashBlankPlayer(team) {
      const container = document.getElementById('bashSB' + team.charAt(0).toUpperCase() + team.slice(1) + 'Scorers');
      const row = document.createElement('div');
      row.className = 'bash-roster-row';
      row.innerHTML = 
        '<input type="text" placeholder="Player name" data-team="' + team + '">' +
        '<input type="number" class="pts-input" placeholder="Pts" data-team="' + team + '" onchange="updateBashPointsTotal(\'' + team + '\')">' +
        '<input type="number" class="fg3-input" placeholder="3FG" data-team="' + team + '">';
      container.appendChild(row);
    }
    
    function updateBashPointsTotal(team) {
      const container = document.getElementById('bashSB' + team.charAt(0).toUpperCase() + team.slice(1) + 'Scorers');
      let total = 0;
      container.querySelectorAll('.pts-input').forEach(input => {
        total += parseInt(input.value) || 0;
      });
      document.getElementById('bashSB' + team.charAt(0).toUpperCase() + team.slice(1) + 'Total').textContent = total;
      
      // Update match indicator
      const prefix = 'bashSB' + team.charAt(0).toUpperCase() + team.slice(1);
      const final = parseInt(document.getElementById(prefix + 'Final').value) || 0;
      const matchSpan = document.getElementById(prefix + 'Match');
      
      if (matchSpan) {
        if (!final) {
          matchSpan.textContent = '‚úî';
          matchSpan.style.color = '#888';
        } else if (total === final) {
          matchSpan.textContent = '‚úî';
          matchSpan.style.color = '#2e7d32';
        } else {
          matchSpan.textContent = '(off by ' + Math.abs(final - total) + ')';
          matchSpan.style.color = '#c62828';
        }
      }
    }
    
    function closeBashSBEntry() {
      document.getElementById('bashSBEntryPanel').style.display = 'none';
      document.getElementById('bashSBEmptyState').style.display = 'block';
      bashSBSelectedGame = null;
    }
    
    function calcBashSBFinal(team) {
      const prefix = 'bashSB' + team.charAt(0).toUpperCase() + team.slice(1);
      let total = 0;
      ['Q1','Q2','Q3','Q4'].forEach(q => {
        const val = parseInt(document.getElementById(prefix + q).value) || 0;
        total += val;
      });
      // Add OT scores
      for (let i = 1; i <= bashSBOTCount; i++) {
        const otVal = parseInt(document.getElementById(prefix + 'OT' + i)?.value) || 0;
        total += otVal;
      }
      document.getElementById(prefix + 'Final').value = total || '';
      // Update match indicator
      updateBashPointsTotal(team);
    }
    
    function addBashSBOT() {
      bashSBOTCount++;
      const headerCell = document.getElementById('bashSBOTHeader');
      const awayCell = document.getElementById('bashSBAwayOTCell');
      const homeCell = document.getElementById('bashSBHomeOTCell');
      
      headerCell.innerHTML += '<th style="padding: 8px; width: 45px;">OT' + bashSBOTCount + '</th>';
      awayCell.innerHTML += '<td><input type="number" id="bashSBAwayOT' + bashSBOTCount + '" class="quarter-input" onchange="calcBashSBFinal(\'away\')"></td>';
      homeCell.innerHTML += '<td><input type="number" id="bashSBHomeOT' + bashSBOTCount + '" class="quarter-input" onchange="calcBashSBFinal(\'home\')"></td>';
    }
    
    function collectBashSBScorers(team) {
      const container = document.getElementById('bashSB' + team.charAt(0).toUpperCase() + team.slice(1) + 'Scorers');
      const scorers = [];
      container.querySelectorAll('.bash-roster-row').forEach(row => {
        // Get player name - either from span (roster) or input (blank player)
        const nameSpan = row.querySelector('.player-info');
        const nameInput = row.querySelector('input[type="text"]');
        const ptsInput = row.querySelector('.pts-input');
        const fg3Input = row.querySelector('.fg3-input');
        
        let name = '';
        if (nameSpan) {
          name = nameSpan.dataset.player || nameSpan.textContent.replace(/#\d+\s*/, '').trim();
        } else if (nameInput) {
          name = nameInput.value.trim();
        }
        
        const pts = parseInt(ptsInput?.value) || 0;
        const fg3 = parseInt(fg3Input?.value) || 0;
        if (name && pts > 0) {
          scorers.push({ name, pts, fg3 });
        }
      });
      return scorers.sort((a, b) => b.pts - a.pts);
    }
    
    async function generateBashStory() {
      if (!bashSBSelectedGame) return;
      
      const awayFinal = parseInt(document.getElementById('bashSBAwayFinal').value) || 0;
      const homeFinal = parseInt(document.getElementById('bashSBHomeFinal').value) || 0;
      
      if (!awayFinal && !homeFinal) {
        showToast('Please enter quarter scores first', 'error');
        return;
      }
      
      // Collect quarter scores
      const awayQuarters = [
        parseInt(document.getElementById('bashSBAwayQ1').value) || 0,
        parseInt(document.getElementById('bashSBAwayQ2').value) || 0,
        parseInt(document.getElementById('bashSBAwayQ3').value) || 0,
        parseInt(document.getElementById('bashSBAwayQ4').value) || 0
      ];
      const homeQuarters = [
        parseInt(document.getElementById('bashSBHomeQ1').value) || 0,
        parseInt(document.getElementById('bashSBHomeQ2').value) || 0,
        parseInt(document.getElementById('bashSBHomeQ3').value) || 0,
        parseInt(document.getElementById('bashSBHomeQ4').value) || 0
      ];
      
      // Add OT if any
      for (let ot = 1; ot <= bashSBOTCount; ot++) {
        const awayOT = parseInt(document.getElementById('bashSBAwayOT' + ot)?.value) || 0;
        const homeOT = parseInt(document.getElementById('bashSBHomeOT' + ot)?.value) || 0;
        awayQuarters.push(awayOT);
        homeQuarters.push(homeOT);
      }
      
      // Collect scorers
      const awayScorersRaw = collectBashSBScorers('away');
      const homeScorersRaw = collectBashSBScorers('home');
      
      // Convert to API format
      const awayScorers = awayScorersRaw.map(s => ({ name: s.name, points: s.pts, threePointers: s.fg3 || 0 }));
      const homeScorers = homeScorersRaw.map(s => ({ name: s.name, points: s.pts, threePointers: s.fg3 || 0 }));
      
      // Validate scorer points match final
      const awayPtsTotal = awayScorers.reduce((sum, s) => sum + s.points, 0);
      const homePtsTotal = homeScorers.reduce((sum, s) => sum + s.points, 0);
      
      if (awayPtsTotal !== awayFinal) {
        showToast(bashSBSelectedGame.away + ' points (' + awayPtsTotal + ') don\'t match final (' + awayFinal + ')', 'error');
        return;
      }
      if (homePtsTotal !== homeFinal) {
        showToast(bashSBSelectedGame.home + ' points (' + homePtsTotal + ') don\'t match final (' + homeFinal + ')', 'error');
        return;
      }
      
      const btn = document.getElementById('bashSBGenerateBtn');
      btn.disabled = true;
      btn.textContent = '‚è≥ Writing story...';
      
      const notes = document.getElementById('bashSBNotes').value.trim();
      
      // Get rosters
      const rosters = await getBashTeamRosters();
      
      // Get school info
      const awaySchoolInfo = getSchoolInfo(bashSBSelectedGame.away);
      const homeSchoolInfo = getSchoolInfo(bashSBSelectedGame.home);
      
      // Build proofData - no records for tournament games
      const proofData = {
        awayTeam: bashSBSelectedGame.away,
        homeTeam: bashSBSelectedGame.home,
        awayQuarters,
        homeQuarters,
        awayFinal,
        homeFinal,
        awayScorers,
        homeScorers,
        gender: bashSBSelectedGame.division || 'Boys',
        division: '',
        date: bashSBSelectedGame.date || '',
        notes: notes + (notes ? '\n' : '') + 'This is a Bash holiday tournament game at Farmington High School. Do not mention team records - this is exhibition play.',
        hasOT: bashSBOTCount > 0,
        awayRecord: null,
        homeRecord: null,
        isTournament: true,
        tournamentName: 'The Bash'
      };
      
      try {
        const response = await fetch('/.netlify/functions/generate-article', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            mode: 'write',
            proofData,
            awayRoster: rosters.away,
            homeRoster: rosters.home,
            schoolData: {
              away: awaySchoolInfo,
              home: homeSchoolInfo
            },
            photographerName: null,
            galleryUrl: null
          })
        });
        
        const data = await response.json();
        
        if (data.success) {
          // Store for later
          bashSBGeneratedData = {
            headline: data.headline || '',
            article: data.article || '',
            excerpt: data.excerpt || '',
            proofData: proofData,
            rosters: rosters,
            schoolData: {
              away: awaySchoolInfo,
              home: homeSchoolInfo
            }
          };
          
          // Show preview panel
          document.getElementById('bashSBEntryPanel').style.display = 'none';
          document.getElementById('bashSBPreviewPanel').style.display = 'block';
          document.getElementById('bashSBHeadline').value = data.headline || '';
          document.getElementById('bashSBArticle').value = data.article || '';
          
          // Format article with paragraphs for display
          const articleHtml = (data.article || '').split('\n\n').map(p => '<p style="margin: 0 0 1em 0;">' + p + '</p>').join('');
          document.getElementById('bashSBPreviewArticleDisplay').innerHTML = articleHtml;
          
          // Populate quarter scores box
          document.getElementById('bashSBPreviewAwayName').textContent = bashSBSelectedGame.away;
          document.getElementById('bashSBPreviewHomeName').textContent = bashSBSelectedGame.home;
          document.getElementById('bashSBPreviewAwayQ1').textContent = awayQuarters[0] || '-';
          document.getElementById('bashSBPreviewAwayQ2').textContent = awayQuarters[1] || '-';
          document.getElementById('bashSBPreviewAwayQ3').textContent = awayQuarters[2] || '-';
          document.getElementById('bashSBPreviewAwayQ4').textContent = awayQuarters[3] || '-';
          document.getElementById('bashSBPreviewHomeQ1').textContent = homeQuarters[0] || '-';
          document.getElementById('bashSBPreviewHomeQ2').textContent = homeQuarters[1] || '-';
          document.getElementById('bashSBPreviewHomeQ3').textContent = homeQuarters[2] || '-';
          document.getElementById('bashSBPreviewHomeQ4').textContent = homeQuarters[3] || '-';
          document.getElementById('bashSBPreviewAwayFinal').textContent = awayFinal;
          document.getElementById('bashSBPreviewHomeFinal').textContent = homeFinal;
          
          // Handle OT columns
          let otHeadersHtml = '';
          let awayOTHtml = '';
          let homeOTHtml = '';
          for (let i = 4; i < awayQuarters.length; i++) {
            const otNum = i - 3;
            const otLabel = awayQuarters.length === 5 ? 'OT' : 'OT' + otNum;
            otHeadersHtml += '<th style="padding: 8px 6px; font-weight: 500; color: #666;">' + otLabel + '</th>';
            awayOTHtml += '<td style="padding: 10px;">' + (awayQuarters[i] || '-') + '</td>';
            homeOTHtml += '<td style="padding: 10px;">' + (homeQuarters[i] || '-') + '</td>';
          }
          document.getElementById('bashSBPreviewOTHeaders').innerHTML = otHeadersHtml;
          document.getElementById('bashSBPreviewAwayOT').innerHTML = awayOTHtml;
          document.getElementById('bashSBPreviewHomeOT').innerHTML = homeOTHtml;
          
          // Highlight winner
          if (awayFinal > homeFinal) {
            document.getElementById('bashSBPreviewAwayFinal').style.color = '#2e7d32';
            document.getElementById('bashSBPreviewHomeFinal').style.color = '#333';
          } else {
            document.getElementById('bashSBPreviewHomeFinal').style.color = '#2e7d32';
            document.getElementById('bashSBPreviewAwayFinal').style.color = '#333';
          }
          
          // Reset edit mode
          document.getElementById('bashSBPreviewArticleDisplay').style.display = 'block';
          document.getElementById('bashSBArticle').style.display = 'none';
          document.getElementById('bashSBEditToggleBtn').textContent = '‚úçÔ∏è Edit Text';
          
          showToast('Story generated! Review and edit before generating social posts.', 'success');
        } else {
          showToast(data.error || 'Failed to generate story', 'error');
        }
      } catch (err) {
        console.error('Story generation error:', err);
        showToast('Error generating story: ' + err.message, 'error');
      }
      
      btn.disabled = false;
      btn.textContent = '‚ú® Generate Story';
    }
    
    let bashSBGeneratedData = null;
    
    function backToBashSBEntry() {
      document.getElementById('bashSBPreviewPanel').style.display = 'none';
      document.getElementById('bashSBEntryPanel').style.display = 'block';
    }
    
    function toggleBashArticleEdit() {
      const display = document.getElementById('bashSBPreviewArticleDisplay');
      const textarea = document.getElementById('bashSBArticle');
      const btn = document.getElementById('bashSBEditToggleBtn');
      
      if (textarea.style.display === 'none') {
        // Switch to edit mode
        textarea.style.display = 'block';
        textarea.style.width = '100%';
        textarea.style.minHeight = '300px';
        textarea.style.padding = '12px';
        textarea.style.border = '1px solid #ddd';
        textarea.style.borderRadius = '6px';
        textarea.style.fontSize = '14px';
        textarea.style.lineHeight = '1.6';
        textarea.style.fontFamily = 'Georgia, serif';
        textarea.style.resize = 'vertical';
        display.style.display = 'none';
        btn.textContent = 'üëç Preview';
        textarea.focus();
      } else {
        // Switch to preview mode
        const articleHtml = textarea.value.split('\n\n').map(p => '<p style="margin: 0 0 1em 0;">' + p + '</p>').join('');
        display.innerHTML = articleHtml;
        display.style.display = 'block';
        textarea.style.display = 'none';
        btn.textContent = '‚úçÔ∏è Edit Text';
      }
    }
    
    // Write Your Own - skip AI, go straight to edit
    function writeBashOwn() {
      const awayFinal = parseInt(document.getElementById('bashSBAwayFinal').value) || 0;
      const homeFinal = parseInt(document.getElementById('bashSBHomeFinal').value) || 0;
      
      if (!awayFinal && !homeFinal) {
        showToast('Please enter quarter scores first', 'error');
        return;
      }
      
      // Collect quarter scores
      const awayQuarters = [
        parseInt(document.getElementById('bashSBAwayQ1').value) || 0,
        parseInt(document.getElementById('bashSBAwayQ2').value) || 0,
        parseInt(document.getElementById('bashSBAwayQ3').value) || 0,
        parseInt(document.getElementById('bashSBAwayQ4').value) || 0
      ];
      const homeQuarters = [
        parseInt(document.getElementById('bashSBHomeQ1').value) || 0,
        parseInt(document.getElementById('bashSBHomeQ2').value) || 0,
        parseInt(document.getElementById('bashSBHomeQ3').value) || 0,
        parseInt(document.getElementById('bashSBHomeQ4').value) || 0
      ];
      
      // Add OT if any
      for (let ot = 1; ot <= bashSBOTCount; ot++) {
        awayQuarters.push(parseInt(document.getElementById('bashSBAwayOT' + ot)?.value) || 0);
        homeQuarters.push(parseInt(document.getElementById('bashSBHomeOT' + ot)?.value) || 0);
      }
      
      const awayScorersRaw = collectBashSBScorers('away');
      const homeScorersRaw = collectBashSBScorers('home');
      const awayScorers = awayScorersRaw.map(s => ({ name: s.name, points: s.pts, threePointers: s.fg3 || 0 }));
      const homeScorers = homeScorersRaw.map(s => ({ name: s.name, points: s.pts, threePointers: s.fg3 || 0 }));
      
      const awaySchoolInfo = getSchoolInfo(bashSBSelectedGame.away);
      const homeSchoolInfo = getSchoolInfo(bashSBSelectedGame.home);
      
      // Store data for social post generation
      bashSBGeneratedData = {
        headline: '',
        article: '',
        excerpt: '',
        proofData: {
          awayTeam: bashSBSelectedGame.away,
          homeTeam: bashSBSelectedGame.home,
          awayQuarters,
          homeQuarters,
          awayFinal,
          homeFinal,
          awayScorers,
          homeScorers,
          gender: bashSBSelectedGame.division || 'Boys',
          division: '',
          date: bashSBSelectedGame.date || '',
          hasOT: bashSBOTCount > 0,
          isTournament: true,
          tournamentName: 'The Bash'
        },
        schoolData: {
          away: awaySchoolInfo,
          home: homeSchoolInfo
        }
      };
      
      // Show preview panel with empty article
      document.getElementById('bashSBEntryPanel').style.display = 'none';
      document.getElementById('bashSBPreviewPanel').style.display = 'block';
      document.getElementById('bashSBHeadline').value = '';
      document.getElementById('bashSBArticle').value = '';
      document.getElementById('bashSBPreviewArticleDisplay').innerHTML = '<p style="color: #888; font-style: italic;">Write your article here...</p>';
      
      // Populate quarter scores box
      document.getElementById('bashSBPreviewAwayName').textContent = bashSBSelectedGame.away;
      document.getElementById('bashSBPreviewHomeName').textContent = bashSBSelectedGame.home;
      document.getElementById('bashSBPreviewAwayQ1').textContent = awayQuarters[0] || '-';
      document.getElementById('bashSBPreviewAwayQ2').textContent = awayQuarters[1] || '-';
      document.getElementById('bashSBPreviewAwayQ3').textContent = awayQuarters[2] || '-';
      document.getElementById('bashSBPreviewAwayQ4').textContent = awayQuarters[3] || '-';
      document.getElementById('bashSBPreviewHomeQ1').textContent = homeQuarters[0] || '-';
      document.getElementById('bashSBPreviewHomeQ2').textContent = homeQuarters[1] || '-';
      document.getElementById('bashSBPreviewHomeQ3').textContent = homeQuarters[2] || '-';
      document.getElementById('bashSBPreviewHomeQ4').textContent = homeQuarters[3] || '-';
      document.getElementById('bashSBPreviewAwayFinal').textContent = awayFinal;
      document.getElementById('bashSBPreviewHomeFinal').textContent = homeFinal;
      
      // Handle OT
      let otHeadersHtml = '';
      let awayOTHtml = '';
      let homeOTHtml = '';
      for (let i = 4; i < awayQuarters.length; i++) {
        const otNum = i - 3;
        const otLabel = awayQuarters.length === 5 ? 'OT' : 'OT' + otNum;
        otHeadersHtml += '<th style="padding: 8px 6px; font-weight: 500; color: #666;">' + otLabel + '</th>';
        awayOTHtml += '<td style="padding: 10px;">' + (awayQuarters[i] || '-') + '</td>';
        homeOTHtml += '<td style="padding: 10px;">' + (homeQuarters[i] || '-') + '</td>';
      }
      document.getElementById('bashSBPreviewOTHeaders').innerHTML = otHeadersHtml;
      document.getElementById('bashSBPreviewAwayOT').innerHTML = awayOTHtml;
      document.getElementById('bashSBPreviewHomeOT').innerHTML = homeOTHtml;
      
      // Highlight winner
      if (awayFinal > homeFinal) {
        document.getElementById('bashSBPreviewAwayFinal').style.color = '#2e7d32';
        document.getElementById('bashSBPreviewHomeFinal').style.color = '#333';
      } else {
        document.getElementById('bashSBPreviewHomeFinal').style.color = '#2e7d32';
        document.getElementById('bashSBPreviewAwayFinal').style.color = '#333';
      }
      
      // Start in edit mode
      toggleBashArticleEdit();
    }
    
    async function saveBashAndGenerateSocial() {
      if (!bashSBGeneratedData) {
        showToast('No article data found', 'error');
        return;
      }
      
      const btn = document.getElementById('bashSBSaveBtn');
      btn.disabled = true;
      btn.textContent = '‚è≥ Generating social posts...';
      
      const editedHeadline = document.getElementById('bashSBHeadline').value;
      const editedArticle = document.getElementById('bashSBArticle').value;
      
      if (!editedArticle || editedArticle.trim() === '') {
        showToast('Article text is empty', 'error');
        btn.disabled = false;
        btn.textContent = '‚úî Save & Generate Social';
        return;
      }
      
      const excerpt = editedArticle.split('.').slice(0, 2).join('.').trim() + '.';
      
      try {
        // Call API to generate social posts
        const response = await fetch('/.netlify/functions/generate-article', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            mode: 'social',
            article: editedArticle,
            headline: editedHeadline,
            proofData: bashSBGeneratedData.proofData,
            schoolData: bashSBGeneratedData.schoolData,
            photographerName: null,
            galleryUrl: null
          })
        });
        
        const data = await response.json();
        
        if (data.success) {
          // Close Bash scorebook panel and open article editor
          document.getElementById('bashSBPreviewPanel').style.display = 'none';
          document.getElementById('bashSBEmptyState').style.display = 'block';
          
          // Store generated social posts
          generatedSocialPosts = {
            facebookPost: data.facebookPost || null,
            instagramPost: data.instagramPost || null,
            twitterPost: data.twitterPost || null
          };
          
          // Store game data for saving with article
          currentGameData = {
            awayTeam: bashSBGeneratedData.proofData.awayTeam,
            homeTeam: bashSBGeneratedData.proofData.homeTeam,
            awayQuarters: bashSBGeneratedData.proofData.awayQuarters,
            homeQuarters: bashSBGeneratedData.proofData.homeQuarters,
            awayFinal: bashSBGeneratedData.proofData.awayFinal,
            homeFinal: bashSBGeneratedData.proofData.homeFinal,
            awayScorers: bashSBGeneratedData.proofData.awayScorers,
            homeScorers: bashSBGeneratedData.proofData.homeScorers,
            gender: bashSBGeneratedData.proofData.gender,
            division: bashSBGeneratedData.proofData.division,
            isBashGame: true,
            bashGameId: bashSBSelectedGame.id
          };
          
          // Set up article editor
          currentArticle = null;
          document.getElementById('editorTitle').textContent = 'New Bash Article';
          document.getElementById('articleTitle').value = editedHeadline;
          const articleHtml = editedArticle.split('\n\n').map(p => '<p>' + p.trim() + '</p>').join('');
          setEditorContent(articleHtml);
          document.getElementById('articleExcerpt').value = excerpt;
          document.getElementById('selectedGameId').value = '';
          selectedGame = null;
          document.getElementById('smugmugUrl').value = '';
          document.getElementById('smugmugThumbUrl').value = '';
          setPhotographerValue('');
          document.getElementById('youtubeUrl').value = '';
          setAuthorValue('KJ Cardinal');
          document.getElementById('articleDate').value = getTodayEST();
          isScheduled = false;
          scheduledTime = null;
          document.getElementById('scheduledDateTime').value = '';
          updateScheduleButton();
          document.getElementById('socialPostsCard').style.display = 'block';
          
          // Auto-generate tags for Bash game
          currentTags = ['The Bash', bashSBGeneratedData.proofData.gender, bashSBSelectedGame.away, bashSBSelectedGame.home];
          renderTags();
          
          // Switch to editor panel
          showTab('articles');
          document.getElementById('articlesPanel').style.display = 'none';
          document.getElementById('editorPanel').style.display = 'block';
          
          showToast('Social posts generated! Ready to publish.', 'success');
        } else {
          showToast(data.error || 'Failed to generate social posts', 'error');
        }
      } catch (err) {
        console.error('Social generation error:', err);
        showToast('Failed to generate social posts', 'error');
      }
      
      btn.disabled = false;
      btn.textContent = '‚úî Save & Generate Social';
    }
    
    async function publishBashDirect() {
      console.log('=== publishBashDirect START ===');
      
      const btn = document.getElementById('bashSBPublishDirectBtn');
      if (!btn) {
        console.error('Button not found!');
        alert('ERROR: Publish button not found. You may be running old code. Please refresh the page.');
        return;
      }
      
      btn.disabled = true;
      btn.textContent = '‚è≥ Publishing...';
      
      const headline = document.getElementById('bashSBHeadline')?.value || '';
      const articleText = document.getElementById('bashSBArticle')?.value || '';
      
      console.log('Headline:', headline);
      console.log('Article length:', articleText.length);
      console.log('Article preview:', articleText.substring(0, 100));
      console.log('bashSBSelectedGame:', bashSBSelectedGame);
      
      if (!headline) {
        showToast('Please enter a headline', 'error');
        btn.disabled = false;
        btn.textContent = 'üì∞ Publish Without Social';
        return;
      }
      
      if (!articleText.trim()) {
        showToast('Article text is empty. Make sure to click "Edit Text" and enter content.', 'error');
        btn.disabled = false;
        btn.textContent = 'üì∞ Publish Without Social';
        return;
      }
      
      if (!bashSBSelectedGame) {
        showToast('No game selected. Please go back and select a game.', 'error');
        btn.disabled = false;
        btn.textContent = 'üì∞ Publish Without Social';
        return;
      }
      
      const awayFinal = parseInt(document.getElementById('bashSBAwayFinal')?.value) || 0;
      const homeFinal = parseInt(document.getElementById('bashSBHomeFinal')?.value) || 0;
      
      console.log('Scores:', awayFinal, '-', homeFinal);
      
      // Generate slug
      const slug = headline.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/-+/g, '-').replace(/^-|-$/g, '') + '-' + Date.now();
      console.log('Generated slug:', slug);
      
      // Convert to HTML
      const articleHtml = articleText.split('\n\n').map(p => '<p>' + p.trim() + '</p>').join('');
      
      // Create article data
      const articleData = {
        title: headline,
        slug: slug,
        content: articleHtml,
        excerpt: articleText.split('.').slice(0, 2).join('.') + '.',
        author: 'KJ Cardinal',
        status: 'published',
        tags: ['The Bash', bashSBSelectedGame.division || 'Boys', bashSBSelectedGame.away, bashSBSelectedGame.home],
        published_at: new Date().toISOString()
      };
      
      console.log('Article data to insert:', articleData);
      
      try {
        console.log('Inserting into articles table...');
        const { data: insertedArticle, error: insertError } = await db.from('articles').insert([articleData]).select();
        
        console.log('Insert result:', insertedArticle);
        console.log('Insert error:', insertError);
        
        if (insertError) {
          console.error('Article insert failed:', insertError);
          throw insertError;
        }
        
        console.log('Article inserted successfully! ID:', insertedArticle?.[0]?.id);
        
        // Update game score in bash_schedule
        console.log('Updating bash_schedule for game:', bashSBSelectedGame.id);
        const { data: updateData, error: updateError } = await db.from('bash_schedule').update({
          away_score: awayFinal,
          home_score: homeFinal,
          overtime: bashSBOTCount > 0,
          recap: '/article/' + slug
        }).eq('id', bashSBSelectedGame.id).select();
        
        console.log('Update result:', updateData);
        console.log('Update error:', updateError);
        
        if (updateError) {
          console.error('Schedule update failed:', updateError);
          // Don't throw - article is already created
          showToast('Article published but score update failed: ' + updateError.message, 'error');
        } else {
          showToast('Story published to The Bash!', 'success');
        }
        
        // Reset and refresh
        closeBashSBEntry();
        document.getElementById('bashSBPreviewPanel').style.display = 'none';
        document.getElementById('bashSBEmptyState').style.display = 'block';
        await loadBashSchedule();
        filterBashSBGames();
        await loadBashContent();
        
        console.log('=== publishBashDirect SUCCESS ===');
        
      } catch (err) {
        console.error('=== publishBashDirect ERROR ===');
        console.error('Full error:', err);
        showToast('Error publishing: ' + (err.message || JSON.stringify(err)), 'error');
      }
      
      btn.disabled = false;
      btn.textContent = 'üì∞ Publish Without Social';
    }
    
    async function publishBashStory() {
      const btn = document.getElementById('bashSBPublishBtn');
      btn.disabled = true;
      btn.textContent = '‚è≥ Publishing...';
      
      const headline = document.getElementById('bashSBHeadline').value;
      const articleText = document.getElementById('bashSBArticle').value;
      const awayFinal = parseInt(document.getElementById('bashSBAwayFinal').value) || 0;
      const homeFinal = parseInt(document.getElementById('bashSBHomeFinal').value) || 0;
      
      // Generate slug
      const slug = headline.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/-+/g, '-').replace(/^-|-$/g, '') + '-' + Date.now();
      
      // Convert to HTML
      const articleHtml = articleText.split('\n\n').map(p => '<p>' + p.trim() + '</p>').join('');
      
      // Create article with bash-game tag
      const articleData = {
        title: headline,
        slug: slug,
        content: articleHtml,
        excerpt: articleText.split('.').slice(0, 2).join('.') + '.',
        author: 'Ball603 Staff',
        status: 'published',
        tags: ['bash-game', bashSBSelectedGame.division || 'Boys', 'The Bash'],
        published_at: new Date().toISOString()
      };
      
      try {
        const { data, error } = await db.from('articles').insert([articleData]).select();
        if (error) throw error;
        
        // Update game score in bash_schedule
        await db.from('bash_schedule').update({
          away_score: awayFinal,
          home_score: homeFinal,
          overtime: bashSBOTCount > 0,
          recap: '/article/' + slug
        }).eq('id', bashSBSelectedGame.id);
        
        showToast('Story published!', 'success');
        
        // Reset and refresh
        closeBashSBEntry();
        document.getElementById('bashSBPreviewPanel').style.display = 'none';
        document.getElementById('bashSBEmptyState').style.display = 'block';
        await loadBashSchedule();
        filterBashSBGames();
        
      } catch (err) {
        console.error('Publish error:', err);
        showToast('Error publishing: ' + err.message, 'error');
      }
      
      btn.disabled = false;
      btn.textContent = '‚ú® Publish to The Bash';
    }
    
    // ===== BASH NIGHTLY RECAP =====
    function loadBashRecapSummary() {
      const date = document.getElementById('bashRecapDate').value;
      const gamesForDay = bashSchedule.filter(g => g.date === date && g.away_score !== null && g.home_score !== null);
      
      const summaryDiv = document.getElementById('bashRecapSummary');
      if (gamesForDay.length === 0) {
        summaryDiv.innerHTML = '<em>No completed games for ' + date + '</em>';
        return;
      }
      
      let html = '<div style="margin-bottom: 10px;"><strong>' + gamesForDay.length + ' games completed:</strong></div>';
      html += '<div style="display: grid; gap: 8px;">';
      gamesForDay.forEach(g => {
        const winner = g.away_score > g.home_score ? g.away : g.home;
        const loser = g.away_score > g.home_score ? g.home : g.away;
        const winScore = Math.max(g.away_score, g.home_score);
        const loseScore = Math.min(g.away_score, g.home_score);
        html += '<div style="padding: 8px; background: #f5f5f5; border-radius: 4px; font-size: 12px;"><strong>' + winner + '</strong> def. ' + loser + ' ' + winScore + '-' + loseScore + (g.overtime ? ' OT' : '') + ' <span style="color: #888;">(' + (g.division || '') + ')</span></div>';
      });
      html += '</div>';
      
      summaryDiv.innerHTML = html;
    }
    
    // Update summary when date changes
    document.getElementById('bashRecapDate')?.addEventListener('change', loadBashRecapSummary);
    
    async function generateBashRecap() {
      const date = document.getElementById('bashRecapDate').value;
      const gamesForDay = bashSchedule.filter(g => g.date === date && g.away_score !== null && g.home_score !== null);
      
      if (gamesForDay.length === 0) {
        showToast('No completed games for this day', 'error');
        return;
      }
      
      const dayNum = ['Dec 26', 'Dec 27', 'Dec 28', 'Dec 29', 'Dec 30'].indexOf(date) + 1;
      const dayNames = ['Opening Day', 'Day Two', 'Day Three', 'Semifinal Saturday', 'Championship Day'];
      
      // Generate headline
      const headline = 'The Bash Day ' + dayNum + ': ' + (dayNames[dayNum - 1] || 'Day ' + dayNum) + ' Recap';
      document.getElementById('bashRecapHeadline').value = headline;
      
      // Generate highlights from games
      let highlights = gamesForDay.map(g => {
        const winner = g.away_score > g.home_score ? g.away : g.home;
        const loser = g.away_score > g.home_score ? g.home : g.away;
        const winScore = Math.max(g.away_score, g.home_score);
        const loseScore = Math.min(g.away_score, g.home_score);
        return winner + ' defeated ' + loser + ' ' + winScore + '-' + loseScore + (g.overtime ? ' in overtime' : '');
      }).join('\n');
      
      document.getElementById('bashRecapHighlights').value = highlights;
      
      showToast('Recap generated - edit as needed', 'success');
    }
    
    async function publishBashRecap() {
      const headline = document.getElementById('bashRecapHeadline').value;
      const highlights = document.getElementById('bashRecapHighlights').value;
      const preview = document.getElementById('bashRecapPreview').value;
      const date = document.getElementById('bashRecapDate').value;
      
      if (!headline || !highlights) {
        showToast('Please fill in headline and highlights', 'error');
        return;
      }
      
      // Build article content
      let content = '<p>FARMINGTON - ' + highlights.split('\n')[0] + '</p>';
      content += '<h3>Results</h3><ul>';
      highlights.split('\n').forEach(line => {
        if (line.trim()) content += '<li>' + line.trim() + '</li>';
      });
      content += '</ul>';
      
      if (preview) {
        content += '<h3>Looking Ahead</h3><p>' + preview + '</p>';
      }
      
      content += '<p>The Bash continues through December 30 at Farmington High School.</p>';
      
      const slug = headline.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/-+/g, '-').replace(/^-|-$/g, '') + '-' + Date.now();
      
      const articleData = {
        title: headline,
        slug: slug,
        content: content,
        excerpt: highlights.split('\n')[0],
        author: 'Ball603 Staff',
        status: 'published',
        tags: ['bash-recap', 'The Bash', 'featured'],
        published_at: new Date().toISOString()
      };
      
      try {
        const { error } = await db.from('articles').insert([articleData]);
        if (error) throw error;
        
        showToast('Recap published to both sites!', 'success');
        
        // Clear form
        document.getElementById('bashRecapHeadline').value = '';
        document.getElementById('bashRecapHighlights').value = '';
        document.getElementById('bashRecapPreview').value = '';
        
      } catch (err) {
        console.error('Publish error:', err);
        showToast('Error: ' + err.message, 'error');
      }
    }
    
    // Initialize Scorebook when tab is shown
    function initBashScorebook() {
      if (bashSchedule.length > 0) {
        filterBashSBGames();
        loadBashRecapSummary();
      }
    }
    
    // =====================================
    // GRAPHICS CREATOR - NEW LAYERED SYSTEM
    // =====================================
    
    // Canvas state
    let gcCanvas = null;
    let gcTemplateCanvas = null;
    let gcInitialized = false;
    let gcZoomFactor = 1;
    let gcCanvasWidth = 2400;
    let gcCanvasHeight = 3000;
    const GC_MAX_PREVIEW_HEIGHT = 500;
    
    // Layer system
    let gcLayers = [];
    let gcSelectedLayerId = null;
    let gcLayerIdCounter = 0;
    let gcDraggedLayerId = null;
    
    // Template state
    let gcTemplates = [];
    let gcCurrentTemplate = null;
    let gcTemplateTeams = [];
    let gcTemplatePrimary = '#1e3a8a';
    let gcTemplateSecondary = '#fbbf24';
    
    // Google Fonts to load
    const GC_FONTS = ['Covered By Your Grace', 'Poppins', 'Oswald', 'Montserrat', 'Bebas Neue', 'Anton'];
    
    // ===== INITIALIZATION =====
    
    async function initGraphicsCreator() {
      if (gcInitialized) return;
      
      // Load Google Fonts
      await loadGcFonts();
      
      // Calculate preview scale
      updateCanvasSize();
      
      // Initialize Fabric canvas
      const canvasEl = document.getElementById('gcCanvas');
      gcCanvas = new fabric.Canvas('gcCanvas', {
        backgroundColor: '#ffffff',
        selection: true,
        preserveObjectStacking: true
      });
      
      // Set up canvas event handlers
      setupCanvasEvents();
      
      // Load teams for dropdowns
      await loadGcTeams();
      
      // Add default layers
      addDefaultLayers();
      
      // Render layer list
      renderGcLayersList();
      
      // Load saved templates
      loadGcTemplates();
      
      gcInitialized = true;
      
      // Initial render
      renderGcCanvas();
    }
    
    async function loadGcFonts() {
      const fontsToLoad = GC_FONTS.map(font => {
        const formatted = font.replace(/ /g, '+');
        return `family=${formatted}:wght@400;500;600;700`;
      }).join('&');
      
      const link = document.createElement('link');
      link.href = `https://fonts.googleapis.com/css2?${fontsToLoad}&display=swap`;
      link.rel = 'stylesheet';
      document.head.appendChild(link);
      
      // Wait a bit for fonts to load
      await new Promise(resolve => setTimeout(resolve, 500));
    }
    
    async function loadGcTeams() {
      // Always query database directly to ensure we have color data
      // (allTeams from the teams endpoint may not include primary_hex/secondary_hex)
      let teams = [];
      
      try {
        const { data, error } = await db
          .from('teams')
          .select('id, full_name, shortname, primary_hex, secondary_hex, gender, level, division')
          .eq('active', true)
          .order('shortname');
        
        if (!error && data) {
          teams = data;
          console.log('Loaded', teams.length, 'teams with colors');
          // Log a sample team to verify colors are present
          if (teams.length > 0) {
            const sample = teams.find(t => t.shortname === 'Farmington') || teams[0];
            console.log('Sample team:', sample.shortname, '- primary:', sample.primary_hex, 'secondary:', sample.secondary_hex);
          }
        }
      } catch (err) {
        console.error('Error loading teams for graphics:', err);
      }
      
      gcTemplateTeams = teams;
      
      // Group teams by level
      const grouped = {};
      teams.forEach(t => {
        const key = t.level || 'Other';
        if (!grouped[key]) grouped[key] = [];
        grouped[key].push(t);
      });
      
      // Helper to ensure hex color has # prefix
      function formatHex(hex) {
        if (!hex) return null;
        hex = hex.trim();
        if (hex && !hex.startsWith('#')) {
          hex = '#' + hex;
        }
        return hex;
      }
      
      // Helper to populate a select element
      function populateTeamSelect(selectId) {
        const select = document.getElementById(selectId);
        if (!select) {
          console.log('Select not found:', selectId);
          return;
        }
        
        select.innerHTML = '<option value="">Select team...</option>';
        
        let teamCount = 0;
        Object.keys(grouped).sort().forEach(level => {
          const optgroup = document.createElement('optgroup');
          optgroup.label = level;
          grouped[level].forEach(t => {
            const opt = document.createElement('option');
            opt.value = t.id;
            opt.textContent = `${t.shortname} (${t.gender || ''} ${t.division || ''})`.trim();
            const primary = formatHex(t.primary_hex) || '#1e3a8a';
            const secondary = formatHex(t.secondary_hex) || '#fbbf24';
            opt.dataset.primary = primary;
            opt.dataset.secondary = secondary;
            
            // Log Farmington specifically
            if (t.shortname === 'Farmington') {
              console.log('Farmington team data:', t);
              console.log('Farmington colors - raw primary_hex:', t.primary_hex, '-> formatted:', primary);
              console.log('Farmington colors - raw secondary_hex:', t.secondary_hex, '-> formatted:', secondary);
            }
            
            optgroup.appendChild(opt);
            teamCount++;
          });
          select.appendChild(optgroup);
        });
        
        console.log(`Populated ${selectId} with ${teamCount} teams`);
      }
      
      // Populate both selects
      populateTeamSelect('gcTemplateTeamSelect');
      populateTeamSelect('gcCreatorTeamSelect');
    }
    
    function applyCreatorTeamColors() {
      const select = document.getElementById('gcCreatorTeamSelect');
      const option = select?.selectedOptions[0];
      
      console.log('applyCreatorTeamColors - selected option:', option?.textContent);
      console.log('  dataset.primary:', option?.dataset?.primary);
      console.log('  dataset.secondary:', option?.dataset?.secondary);
      
      if (option && option.value) {
        gcTemplatePrimary = option.dataset.primary || '#1e3a8a';
        gcTemplateSecondary = option.dataset.secondary || '#fbbf24';
        
        console.log('  Applied colors - primary:', gcTemplatePrimary, 'secondary:', gcTemplateSecondary);
        
        // Update preview swatches
        const primaryPreview = document.getElementById('gcCreatorPrimaryPreview');
        const secondaryPreview = document.getElementById('gcCreatorSecondaryPreview');
        if (primaryPreview) primaryPreview.style.background = gcTemplatePrimary;
        if (secondaryPreview) secondaryPreview.style.background = gcTemplateSecondary;
        
        // Re-render canvas with new colors
        renderGcCanvas();
      }
    }
    
    // ===== CANVAS SIZE =====
    
    function updateCanvasSize() {
      gcCanvasWidth = parseInt(document.getElementById('gcOutputWidth')?.value) || 2400;
      gcCanvasHeight = parseInt(document.getElementById('gcOutputHeight')?.value) || 3000;
      
      // Update size label
      const label = document.getElementById('gcCanvasSizeLabel');
      if (label) label.textContent = `${gcCanvasWidth} √ó ${gcCanvasHeight}px`;
      
      // Calculate zoom to fit
      gcZoom('fit');
    }
    
    function applySizePreset() {
      const preset = document.getElementById('gcSizePreset').value;
      if (preset === 'custom') return;
      
      const [w, h] = preset.split('x').map(Number);
      document.getElementById('gcOutputWidth').value = w;
      document.getElementById('gcOutputHeight').value = h;
      
      updateCanvasSize();
      renderGcCanvas();
    }
    
    function gcZoom(action) {
      const container = document.getElementById('gcCanvasContainer');
      if (!container) return;
      
      const maxWidth = container.clientWidth - 40;
      const maxHeight = GC_MAX_PREVIEW_HEIGHT;
      
      if (action === 'fit') {
        const scaleW = maxWidth / gcCanvasWidth;
        const scaleH = maxHeight / gcCanvasHeight;
        gcZoomFactor = Math.min(scaleW, scaleH, 0.5);
      } else if (action === 'in') {
        gcZoomFactor = Math.min(gcZoomFactor + 0.1, 1);
      } else if (action === 'out') {
        gcZoomFactor = Math.max(gcZoomFactor - 0.1, 0.1);
      }
      
      // Update zoom display
      const zoomLabel = document.getElementById('gcZoomLevel');
      if (zoomLabel) zoomLabel.textContent = Math.round(gcZoomFactor * 100) + '%';
      
      // Resize canvas
      if (gcCanvas) {
        const newWidth = Math.round(gcCanvasWidth * gcZoomFactor);
        const newHeight = Math.round(gcCanvasHeight * gcZoomFactor);
        
        gcCanvas.setWidth(newWidth);
        gcCanvas.setHeight(newHeight);
        gcCanvas.setZoom(gcZoomFactor);
        gcCanvas.renderAll();
      }
    }
    
    // ===== LAYER SYSTEM =====
    
    function generateLayerId() {
      return 'layer-' + (++gcLayerIdCounter);
    }
    
    function addDefaultLayers() {
      // Add 3 default layers: background, image, text
      gcLayers = [
        {
          id: generateLayerId(),
          name: 'Background',
          type: 'solid',
          visible: true,
          locked: false,
          opacity: 100,
          position: { x: 0, y: 0 },
          size: { width: gcCanvasWidth, height: gcCanvasHeight },
          rotation: 0,
          editable: false,
          settings: {
            color: '#333333',
            useSchoolColor: false,
            schoolColorType: 'primary'
          }
        },
        {
          id: generateLayerId(),
          name: 'Photo',
          type: 'image',
          visible: true,
          locked: false,
          opacity: 100,
          position: { x: gcCanvasWidth / 2, y: gcCanvasHeight * 0.35 },
          size: { width: gcCanvasWidth, height: gcCanvasHeight * 0.65 },
          rotation: 0,
          editable: true,
          settings: {
            src: null,
            imageData: null,
            mask: null,
            fit: 'cover'
          }
        },
        {
          id: generateLayerId(),
          name: 'Headline',
          type: 'text',
          visible: true,
          locked: false,
          opacity: 100,
          position: { x: gcCanvasWidth / 2, y: gcCanvasHeight * 0.75 },
          size: { width: gcCanvasWidth * 0.85, height: 300 },
          rotation: 0,
          editable: true,
          settings: {
            content: '',
            placeholder: 'Enter headline...',
            font: 'Covered By Your Grace',
            fontSize: 120,
            color: '#ffffff',
            align: 'center',
            shadow: {
              enabled: true,
              color: 'rgba(0,0,0,0.5)',
              blur: 20,
              offsetX: 10,
              offsetY: 10
            }
          }
        }
      ];
    }
    
    function addGcLayer() {
      const newLayer = {
        id: generateLayerId(),
        name: 'New Layer',
        type: 'solid',
        visible: true,
        locked: false,
        opacity: 100,
        position: { x: 0, y: 0 },
        size: { width: gcCanvasWidth, height: gcCanvasHeight },
        rotation: 0,
        editable: false,
        settings: {
          color: '#cccccc'
        }
      };
      
      gcLayers.push(newLayer);
      gcSelectedLayerId = newLayer.id;
      renderGcLayersList();
      renderGcCanvas();
    }
    
    function deleteGcLayer(layerId) {
      if (gcLayers.length <= 1) {
        showToast('Cannot delete the last layer', 'error');
        return;
      }
      
      gcLayers = gcLayers.filter(l => l.id !== layerId);
      if (gcSelectedLayerId === layerId) {
        gcSelectedLayerId = gcLayers[gcLayers.length - 1]?.id || null;
      }
      
      renderGcLayersList();
      renderGcCanvas();
    }
    
    function toggleLayerVisibility(layerId) {
      const layer = gcLayers.find(l => l.id === layerId);
      if (layer) {
        layer.visible = !layer.visible;
        renderGcLayersList();
        renderGcCanvas();
      }
    }
    
    function toggleLayerLock(layerId) {
      const layer = gcLayers.find(l => l.id === layerId);
      if (layer) {
        layer.locked = !layer.locked;
        renderGcLayersList();
        renderGcCanvas();
      }
    }
    
    function selectGcLayer(layerId) {
      gcSelectedLayerId = layerId;
      renderGcLayersList();
      
      // Select corresponding object on canvas
      if (gcCanvas) {
        const objects = gcCanvas.getObjects();
        const obj = objects.find(o => o.layerId === layerId);
        if (obj) {
          gcCanvas.setActiveObject(obj);
          gcCanvas.renderAll();
        }
      }
    }
    
    function toggleGcLayerExpand(layerId) {
      const item = document.querySelector(`.gc-layer-item[data-layer-id="${layerId}"]`);
      if (item) {
        item.classList.toggle('expanded');
      }
    }
    
    function updateLayerSetting(layerId, path, value) {
      const layer = gcLayers.find(l => l.id === layerId);
      if (!layer) return;
      
      // Handle nested paths like 'settings.color'
      const parts = path.split('.');
      let obj = layer;
      for (let i = 0; i < parts.length - 1; i++) {
        obj = obj[parts[i]];
      }
      obj[parts[parts.length - 1]] = value;
      
      renderGcCanvas();
    }
    
    function updateLayerType(layerId, newType) {
      const layer = gcLayers.find(l => l.id === layerId);
      if (!layer) return;
      
      layer.type = newType;
      
      // Reset settings based on type
      switch (newType) {
        case 'solid':
          layer.settings = { color: '#cccccc', useSchoolColor: false };
          layer.size = { width: gcCanvasWidth, height: gcCanvasHeight };
          break;
        case 'gradient':
          layer.settings = { 
            colors: ['{{primary}}', '{{secondary}}'],
            direction: 'to-right',
            stops: [0, 100]
          };
          layer.size = { width: gcCanvasWidth, height: gcCanvasHeight };
          break;
        case 'image':
          layer.settings = { src: null, imageData: null, mask: null, fit: 'cover' };
          layer.size = { width: gcCanvasWidth, height: gcCanvasHeight * 0.6 };
          layer.position = { x: gcCanvasWidth / 2, y: gcCanvasHeight * 0.3 };
          break;
        case 'text':
          layer.settings = {
            content: '',
            placeholder: 'Enter text...',
            font: 'Poppins',
            fontSize: 48,
            color: '#333333',
            align: 'center',
            shadow: { enabled: false }
          };
          layer.size = { width: gcCanvasWidth * 0.8, height: 200 };
          layer.position = { x: gcCanvasWidth / 2, y: gcCanvasHeight / 2 };
          break;
      }
      
      renderGcLayersList();
      renderGcCanvas();
    }
    
    // ===== LAYER LIST RENDERING =====
    
    function renderGcLayersList() {
      const container = document.getElementById('gcLayersList');
      if (!container) return;
      
      // Render layers from top to bottom (reverse order)
      const reversedLayers = [...gcLayers].reverse();
      
      container.innerHTML = reversedLayers.map(layer => {
        const isSelected = layer.id === gcSelectedLayerId;
        const typeColors = {
          solid: '#9c27b0',
          gradient: '#e91e63',
          image: '#2196f3',
          text: '#4caf50'
        };
        
        return `
          <div class="gc-layer-item ${isSelected ? 'selected' : ''} ${layer.id === gcSelectedLayerId ? 'expanded' : ''}" 
               data-layer-id="${layer.id}" 
               draggable="true"
               ondragstart="handleLayerDragStart(event, '${layer.id}')"
               ondragover="handleLayerDragOver(event)"
               ondrop="handleLayerDrop(event, '${layer.id}')"
               ondragend="handleLayerDragEnd(event)">
            <div class="gc-layer-header" onclick="selectGcLayer('${layer.id}'); toggleGcLayerExpand('${layer.id}')">
              <span class="gc-layer-drag">‚ãÆ‚ãÆ</span>
              <span class="gc-layer-name">${layer.name}</span>
              <span class="gc-layer-type-badge" style="background: ${typeColors[layer.type] || '#999'}20; color: ${typeColors[layer.type] || '#999'}">${layer.type}</span>
              <div class="gc-layer-actions" onclick="event.stopPropagation()">
                <button class="gc-layer-btn ${layer.visible ? 'active' : 'visibility-off'}" onclick="toggleLayerVisibility('${layer.id}')" title="Visibility">
                  ${layer.visible ? 'üëÅ' : 'üëÅ‚Äçüó®'}
                </button>
                <button class="gc-layer-btn ${layer.locked ? 'active' : ''}" onclick="toggleLayerLock('${layer.id}')" title="Lock">
                  ${layer.locked ? 'üîí' : 'üîì'}
                </button>
                <button class="gc-layer-btn" onclick="deleteGcLayer('${layer.id}')" title="Delete">üóë</button>
              </div>
            </div>
            <div class="gc-layer-body">
              ${renderLayerSettings(layer)}
            </div>
          </div>
        `;
      }).join('');
      
      // Setup dropzones for image layers after DOM is updated
      setTimeout(() => {
        gcLayers.forEach(layer => {
          if (layer.type === 'image') {
            setupImageDropzone(layer.id);
          }
        });
      }, 0);
    }
    
    function renderLayerSettings(layer) {
      let html = `
        <div class="gc-layer-field">
          <label>Name</label>
          <input type="text" value="${layer.name}" onchange="updateLayerSetting('${layer.id}', 'name', this.value); renderGcLayersList()">
        </div>
        <div class="gc-layer-field">
          <label>Type</label>
          <select onchange="updateLayerType('${layer.id}', this.value)">
            <option value="solid" ${layer.type === 'solid' ? 'selected' : ''}>Solid Color</option>
            <option value="gradient" ${layer.type === 'gradient' ? 'selected' : ''}>Gradient</option>
            <option value="image" ${layer.type === 'image' ? 'selected' : ''}>Image</option>
            <option value="text" ${layer.type === 'text' ? 'selected' : ''}>Text</option>
          </select>
        </div>
        <hr style="border: none; border-top: 1px solid #eee; margin: 10px 0;">
      `;
      
      switch (layer.type) {
        case 'solid':
          html += renderSolidSettings(layer);
          break;
        case 'gradient':
          html += renderGradientSettings(layer);
          break;
        case 'image':
          html += renderImageSettings(layer);
          break;
        case 'text':
          html += renderTextSettings(layer);
          break;
      }
      
      // Common settings
      html += `
        <hr style="border: none; border-top: 1px solid #eee; margin: 10px 0;">
        <div class="gc-layer-field">
          <label>Align</label>
          <div style="display: flex; gap: 4px; margin-bottom: 6px;">
            <button onclick="alignLayer('${layer.id}', 'left')" class="gc-align-btn" title="Align Left">‚óÄ</button>
            <button onclick="alignLayer('${layer.id}', 'center-h')" class="gc-align-btn" title="Center Horizontally">‚¨å</button>
            <button onclick="alignLayer('${layer.id}', 'right')" class="gc-align-btn" title="Align Right">‚ñ∂</button>
            <span style="width: 10px;"></span>
            <button onclick="alignLayer('${layer.id}', 'top')" class="gc-align-btn" title="Align Top">‚ñ≤</button>
            <button onclick="alignLayer('${layer.id}', 'center-v')" class="gc-align-btn" title="Center Vertically">‚¨ç</button>
            <button onclick="alignLayer('${layer.id}', 'bottom')" class="gc-align-btn" title="Align Bottom">‚ñº</button>
          </div>
        </div>
        <div class="gc-layer-field">
          <label>Opacity: ${layer.opacity}%</label>
          <input type="range" min="0" max="100" value="${layer.opacity}" 
                 onchange="updateLayerSetting('${layer.id}', 'opacity', parseInt(this.value)); this.previousElementSibling.textContent = 'Opacity: ' + this.value + '%'">
        </div>
        <div class="gc-layer-field">
          <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
            <input type="checkbox" ${layer.editable ? 'checked' : ''} onchange="updateLayerSetting('${layer.id}', 'editable', this.checked)">
            Editable in template
          </label>
        </div>
      `;
      
      return html;
    }
    
    function renderSolidSettings(layer) {
      const s = layer.settings;
      return `
        <div class="gc-layer-field">
          <label>Color</label>
          <div style="display: flex; gap: 10px; align-items: center;">
            <input type="color" value="${s.color || '#cccccc'}" onchange="updateLayerSetting('${layer.id}', 'settings.color', this.value)">
            <input type="text" value="${s.color || '#cccccc'}" style="flex: 1;" onchange="updateLayerSetting('${layer.id}', 'settings.color', this.value); this.previousElementSibling.value = this.value">
          </div>
        </div>
        <div class="gc-layer-field">
          <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
            <input type="checkbox" ${s.useSchoolColor ? 'checked' : ''} onchange="updateLayerSetting('${layer.id}', 'settings.useSchoolColor', this.checked); if(this.checked && !gcLayers.find(l=>l.id==='${layer.id}').settings.schoolColorType) updateLayerSetting('${layer.id}', 'settings.schoolColorType', 'primary'); renderGcLayersList()">
            Use school color variable
          </label>
        </div>
        ${s.useSchoolColor ? `
          <div class="gc-layer-field">
            <select onchange="updateLayerSetting('${layer.id}', 'settings.schoolColorType', this.value); renderGcCanvas()">
              <option value="primary" ${s.schoolColorType !== 'secondary' ? 'selected' : ''}>{{primary}}</option>
              <option value="secondary" ${s.schoolColorType === 'secondary' ? 'selected' : ''}>{{secondary}}</option>
            </select>
          </div>
        ` : ''}
      `;
    }
    
    function renderGradientSettings(layer) {
      const s = layer.settings;
      const colors = s.colors || ['#333333', '#666666'];
      return `
        <div class="gc-layer-field">
          <label>Color 1</label>
          <div style="display: flex; gap: 10px; align-items: center;">
            <input type="color" value="${colors[0].startsWith('{{') ? '#333333' : colors[0]}" onchange="updateGradientColor('${layer.id}', 0, this.value)">
            <select style="flex: 1;" onchange="updateGradientColor('${layer.id}', 0, this.value)">
              <option value="{{primary}}" ${colors[0] === '{{primary}}' ? 'selected' : ''}>{{primary}}</option>
              <option value="{{secondary}}" ${colors[0] === '{{secondary}}' ? 'selected' : ''}>{{secondary}}</option>
              <option value="custom" ${!colors[0].startsWith('{{') ? 'selected' : ''}>Custom</option>
            </select>
          </div>
        </div>
        <div class="gc-layer-field">
          <label>Color 2</label>
          <div style="display: flex; gap: 10px; align-items: center;">
            <input type="color" value="${colors[1].startsWith('{{') ? '#666666' : colors[1]}" onchange="updateGradientColor('${layer.id}', 1, this.value)">
            <select style="flex: 1;" onchange="updateGradientColor('${layer.id}', 1, this.value)">
              <option value="{{primary}}" ${colors[1] === '{{primary}}' ? 'selected' : ''}>{{primary}}</option>
              <option value="{{secondary}}" ${colors[1] === '{{secondary}}' ? 'selected' : ''}>{{secondary}}</option>
              <option value="custom" ${!colors[1].startsWith('{{') ? 'selected' : ''}>Custom</option>
            </select>
          </div>
        </div>
        <div class="gc-layer-field">
          <label>Direction</label>
          <select onchange="updateLayerSetting('${layer.id}', 'settings.direction', this.value)">
            <option value="to-right" ${s.direction === 'to-right' ? 'selected' : ''}>‚Üí Horizontal</option>
            <option value="to-bottom" ${s.direction === 'to-bottom' ? 'selected' : ''}>‚Üì Vertical</option>
            <option value="to-bottom-right" ${s.direction === 'to-bottom-right' ? 'selected' : ''}>‚Üò Diagonal</option>
            <option value="to-top-right" ${s.direction === 'to-top-right' ? 'selected' : ''}>‚Üó Diagonal</option>
          </select>
        </div>
      `;
    }
    
    function updateGradientColor(layerId, index, value) {
      const layer = gcLayers.find(l => l.id === layerId);
      if (!layer) return;
      
      if (!layer.settings.colors) layer.settings.colors = ['#333333', '#666666'];
      layer.settings.colors[index] = value;
      
      renderGcLayersList();
      renderGcCanvas();
    }
    
    function renderImageSettings(layer) {
      const s = layer.settings;
      const hasImage = s.src || s.imageData;
      const hasPolygonMask = s.mask === 'polygon' && s.polygonPoints?.length > 0;
      
      return `
        <div class="gc-layer-field">
          <div class="gc-dropzone" id="dropzone-${layer.id}" 
               onclick="triggerImageUpload('${layer.id}')"
               ondragover="event.preventDefault(); this.classList.add('drag-over');"
               ondragleave="this.classList.remove('drag-over');"
               ondrop="event.preventDefault(); this.classList.remove('drag-over'); handleDropzoneFile('${layer.id}', event);">
            ${hasImage ? `
              <div style="font-size: 20px; color: #4caf50; margin-bottom: 5px;">‚úì</div>
              <div class="gc-dropzone-text">Image loaded. Click to replace.</div>
            ` : `
              <div class="gc-dropzone-icon">üì∑</div>
              <div class="gc-dropzone-text">Drop image or click to upload</div>
            `}
            <input type="file" id="imageInput-${layer.id}" accept="image/*" style="display: none;" onchange="handleLayerImageUpload('${layer.id}', this)">
          </div>
        </div>
        <div class="gc-layer-field">
          <label>Fit Mode</label>
          <select onchange="updateLayerSetting('${layer.id}', 'settings.fit', this.value)">
            <option value="cover" ${s.fit === 'cover' ? 'selected' : ''}>Cover (fill area)</option>
            <option value="contain" ${s.fit === 'contain' ? 'selected' : ''}>Contain (fit inside)</option>
            <option value="stretch" ${s.fit === 'stretch' ? 'selected' : ''}>Stretch</option>
          </select>
        </div>
        <div class="gc-layer-field">
          <label>Mask</label>
          <select id="maskSelect-${layer.id}" onchange="handleMaskChange('${layer.id}', this.value)">
            <option value="" ${!s.mask ? 'selected' : ''}>None</option>
            <option value="rectangle" ${s.mask === 'rectangle' ? 'selected' : ''}>Rectangle</option>
            <option value="circle" ${s.mask === 'circle' ? 'selected' : ''}>Circle</option>
            <option value="polygon" ${s.mask === 'polygon' ? 'selected' : ''}>Polygon (custom)</option>
          </select>
        </div>
        ${s.mask === 'polygon' ? `
          <div class="gc-layer-field">
            <div style="display: flex; gap: 6px;">
              <button onclick="startPolygonDrawing('${layer.id}')" class="gc-btn gc-btn-secondary" style="flex: 1; padding: 6px 10px; font-size: 11px;">
                ${gcPolygonDrawingLayerId === '${layer.id}' ? 'üéØ Drawing...' : '‚úèÔ∏è Draw Mask'}
              </button>
              ${hasPolygonMask ? `
                <button onclick="clearPolygonMask('${layer.id}')" class="gc-btn gc-btn-danger" style="padding: 6px 10px; font-size: 11px;">Clear</button>
              ` : ''}
            </div>
            ${hasPolygonMask ? `<div style="font-size: 10px; color: #4caf50; margin-top: 4px;">‚úì ${s.polygonPoints.length} points defined</div>` : `
              <div style="font-size: 10px; color: #888; margin-top: 4px;">Click canvas to add points. Double-click to finish.</div>
            `}
          </div>
        ` : ''}
      `;
    }
    
    function renderTextSettings(layer) {
      const s = layer.settings;
      const shadowEnabled = s.shadow?.enabled;
      
      return `
        <div class="gc-layer-field">
          <label>Content</label>
          <textarea rows="2" placeholder="${s.placeholder || 'Enter text...'}" onchange="updateLayerSetting('${layer.id}', 'settings.content', this.value)">${s.content || ''}</textarea>
        </div>
        <div class="gc-layer-field-row">
          <div class="gc-layer-field">
            <label>Font</label>
            <select onchange="updateLayerSetting('${layer.id}', 'settings.font', this.value)">
              ${GC_FONTS.map(f => `<option value="${f}" ${s.font === f ? 'selected' : ''}>${f}</option>`).join('')}
            </select>
          </div>
          <div class="gc-layer-field">
            <label>Size: ${s.fontSize}px</label>
            <input type="range" min="12" max="300" value="${s.fontSize || 48}" onchange="updateLayerSetting('${layer.id}', 'settings.fontSize', parseInt(this.value)); this.previousElementSibling.textContent = 'Size: ' + this.value + 'px'">
          </div>
        </div>
        <div class="gc-layer-field-row">
          <div class="gc-layer-field">
            <label>Color</label>
            <input type="color" value="${s.color || '#333333'}" onchange="updateLayerSetting('${layer.id}', 'settings.color', this.value)">
          </div>
          <div class="gc-layer-field">
            <label>Align</label>
            <select onchange="updateLayerSetting('${layer.id}', 'settings.align', this.value)">
              <option value="left" ${s.align === 'left' ? 'selected' : ''}>Left</option>
              <option value="center" ${s.align === 'center' ? 'selected' : ''}>Center</option>
              <option value="right" ${s.align === 'right' ? 'selected' : ''}>Right</option>
            </select>
          </div>
        </div>
        <div class="gc-layer-field">
          <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
            <input type="checkbox" ${shadowEnabled ? 'checked' : ''} onchange="toggleTextShadow('${layer.id}', this.checked)">
            Add shadow
          </label>
        </div>
      `;
    }
    
    function toggleTextShadow(layerId, enabled) {
      const layer = gcLayers.find(l => l.id === layerId);
      if (!layer) return;
      
      if (enabled) {
        layer.settings.shadow = {
          enabled: true,
          color: 'rgba(0,0,0,0.5)',
          blur: 20,
          offsetX: 10,
          offsetY: 10
        };
      } else {
        layer.settings.shadow = { enabled: false };
      }
      
      renderGcCanvas();
    }
    
    // ===== LAYER ALIGNMENT =====
    
    function alignLayer(layerId, alignment) {
      const layer = gcLayers.find(l => l.id === layerId);
      if (!layer) return;
      
      // Get layer dimensions
      const layerW = layer.size?.width || gcCanvasWidth;
      const layerH = layer.size?.height || gcCanvasHeight;
      
      // For text/image layers that use center origin, we calculate differently
      const usesCenterOrigin = (layer.type === 'text' || layer.type === 'image');
      
      switch (alignment) {
        case 'left':
          layer.position.x = usesCenterOrigin ? layerW / 2 : 0;
          break;
        case 'center-h':
          layer.position.x = gcCanvasWidth / 2;
          break;
        case 'right':
          layer.position.x = usesCenterOrigin ? gcCanvasWidth - layerW / 2 : gcCanvasWidth - layerW;
          break;
        case 'top':
          layer.position.y = usesCenterOrigin ? layerH / 2 : 0;
          break;
        case 'center-v':
          layer.position.y = gcCanvasHeight / 2;
          break;
        case 'bottom':
          layer.position.y = usesCenterOrigin ? gcCanvasHeight - layerH / 2 : gcCanvasHeight - layerH;
          break;
      }
      
      renderGcCanvas();
      showToast('Layer aligned', 'success');
    }
    
    // ===== MASK HANDLING =====
    
    function handleMaskChange(layerId, maskType) {
      const layer = gcLayers.find(l => l.id === layerId);
      if (!layer) return;
      
      layer.settings.mask = maskType || null;
      
      // Clear polygon points if switching away from polygon
      if (maskType !== 'polygon') {
        layer.settings.polygonPoints = null;
        stopPolygonDrawing();
      }
      
      renderGcLayersList();
      renderGcCanvas();
    }
    
    // ===== POLYGON MASK DRAWING =====
    
    let gcPolygonDrawingLayerId = null;
    let gcPolygonPoints = [];
    let gcPolygonPreviewObjects = [];
    let gcPolygonClickRect = null;
    
    function startPolygonDrawing(layerId) {
      // If already drawing this layer, stop
      if (gcPolygonDrawingLayerId === layerId) {
        stopPolygonDrawing();
        return;
      }
      
      // Start drawing
      gcPolygonDrawingLayerId = layerId;
      gcPolygonPoints = [];
      
      // Clear any existing preview objects
      gcPolygonPreviewObjects.forEach(obj => gcCanvas.remove(obj));
      gcPolygonPreviewObjects = [];
      
      // Disable selection on all objects temporarily
      gcCanvas.getObjects().forEach(obj => {
        obj._wasSelectable = obj.selectable;
        obj.selectable = false;
        obj.evented = false;
      });
      
      // Add a transparent rect to capture all clicks (including outside objects)
      gcPolygonClickRect = new fabric.Rect({
        left: 0,
        top: 0,
        width: gcCanvasWidth,
        height: gcCanvasHeight,
        fill: 'transparent',
        selectable: false,
        evented: true,
        hoverCursor: 'crosshair'
      });
      gcCanvas.add(gcPolygonClickRect);
      gcCanvas.bringToFront(gcPolygonClickRect);
      
      // Add click handler
      gcPolygonClickRect.on('mousedown', handlePolygonClick);
      gcCanvas.on('mouse:dblclick', finishPolygonDrawing);
      
      // Visual feedback
      document.getElementById('gcCanvasContainer').classList.add('gc-polygon-drawing');
      
      showToast('Click anywhere to add points. Double-click to finish.', 'success');
      renderGcLayersList();
    }
    
    function handlePolygonClick(e) {
      if (!gcPolygonDrawingLayerId) return;
      
      // Get click position in canvas coordinates
      const pointer = gcCanvas.getPointer(e.e);
      const x = pointer.x;
      const y = pointer.y;
      
      // Add point
      gcPolygonPoints.push({ x, y });
      
      // Draw point marker
      const circle = new fabric.Circle({
        left: x,
        top: y,
        radius: 8 / gcZoomFactor,
        fill: '#f57c00',
        stroke: '#fff',
        strokeWidth: 2 / gcZoomFactor,
        originX: 'center',
        originY: 'center',
        selectable: false,
        evented: false
      });
      gcCanvas.add(circle);
      gcPolygonPreviewObjects.push(circle);
      
      // Draw line to previous point
      if (gcPolygonPoints.length > 1) {
        const prev = gcPolygonPoints[gcPolygonPoints.length - 2];
        const line = new fabric.Line([prev.x, prev.y, x, y], {
          stroke: '#f57c00',
          strokeWidth: 2 / gcZoomFactor,
          selectable: false,
          evented: false
        });
        gcCanvas.add(line);
        gcPolygonPreviewObjects.push(line);
      }
      
      // Draw closing line preview (to first point)
      if (gcPolygonPoints.length > 2) {
        // Remove old closing line if exists
        const oldClosingLine = gcPolygonPreviewObjects.find(obj => obj._isClosingLine);
        if (oldClosingLine) {
          gcCanvas.remove(oldClosingLine);
          gcPolygonPreviewObjects = gcPolygonPreviewObjects.filter(obj => !obj._isClosingLine);
        }
        
        const first = gcPolygonPoints[0];
        const closingLine = new fabric.Line([x, y, first.x, first.y], {
          stroke: '#f57c00',
          strokeWidth: 2 / gcZoomFactor,
          strokeDashArray: [5, 5],
          selectable: false,
          evented: false
        });
        closingLine._isClosingLine = true;
        gcCanvas.add(closingLine);
        gcPolygonPreviewObjects.push(closingLine);
      }
      
      gcCanvas.renderAll();
    }
    
    function finishPolygonDrawing() {
      if (!gcPolygonDrawingLayerId || gcPolygonPoints.length < 3) {
        if (gcPolygonPoints.length > 0 && gcPolygonPoints.length < 3) {
          showToast('Need at least 3 points for a polygon', 'error');
        }
        return;
      }
      
      // Save points to layer (store as canvas coordinates)
      const layer = gcLayers.find(l => l.id === gcPolygonDrawingLayerId);
      if (layer) {
        layer.settings.polygonPoints = [...gcPolygonPoints];
      }
      
      const pointCount = gcPolygonPoints.length;
      
      // Clean up
      stopPolygonDrawing();
      
      // Re-render
      renderGcLayersList();
      renderGcCanvas();
      
      showToast(`Polygon mask created with ${pointCount} points`, 'success');
    }
    
    function stopPolygonDrawing() {
      // Remove click rect
      if (gcPolygonClickRect) {
        gcPolygonClickRect.off('mousedown', handlePolygonClick);
        gcCanvas.remove(gcPolygonClickRect);
        gcPolygonClickRect = null;
      }
      
      // Remove dblclick handler
      if (gcCanvas) {
        gcCanvas.off('mouse:dblclick', finishPolygonDrawing);
      }
      
      // Clear preview objects
      gcPolygonPreviewObjects.forEach(obj => {
        if (gcCanvas) gcCanvas.remove(obj);
      });
      gcPolygonPreviewObjects = [];
      
      // Restore selection on objects
      if (gcCanvas) {
        gcCanvas.getObjects().forEach(obj => {
          if (obj._wasSelectable !== undefined) {
            obj.selectable = obj._wasSelectable;
            obj.evented = !obj.locked;
            delete obj._wasSelectable;
          }
        });
      }
      
      // Reset state
      gcPolygonDrawingLayerId = null;
      gcPolygonPoints = [];
      
      // Remove cursor class
      document.getElementById('gcCanvasContainer')?.classList.remove('gc-polygon-drawing');
      
      if (gcCanvas) gcCanvas.renderAll();
    }
    
    function clearPolygonMask(layerId) {
      const layer = gcLayers.find(l => l.id === layerId);
      if (layer) {
        layer.settings.polygonPoints = null;
        renderGcLayersList();
        renderGcCanvas();
        showToast('Polygon mask cleared', 'success');
      }
    }
    
    // ===== IMAGE HANDLING =====
    
    function triggerImageUpload(layerId) {
      document.getElementById(`imageInput-${layerId}`).click();
    }
    
    function handleLayerImageUpload(layerId, input) {
      const file = input.files[0];
      if (!file) return;
      
      const reader = new FileReader();
      reader.onload = (e) => {
        const layer = gcLayers.find(l => l.id === layerId);
        if (layer) {
          layer.settings.imageData = e.target.result;
          layer.settings.src = null;
          renderGcLayersList();
          renderGcCanvas();
          showToast('Image loaded', 'success');
        }
      };
      reader.readAsDataURL(file);
    }
    
    function handleDropzoneFile(layerId, event) {
      const file = event.dataTransfer.files[0];
      if (!file || !file.type.startsWith('image/')) {
        showToast('Please drop an image file', 'error');
        return;
      }
      
      const reader = new FileReader();
      reader.onload = (e) => {
        const layer = gcLayers.find(l => l.id === layerId);
        if (layer) {
          layer.settings.imageData = e.target.result;
          layer.settings.src = null;
          renderGcLayersList();
          renderGcCanvas();
          showToast('Image loaded', 'success');
        }
      };
      reader.readAsDataURL(file);
    }
    
    // Setup dropzone drag and drop
    function setupImageDropzone(layerId) {
      const dropzone = document.getElementById(`dropzone-${layerId}`);
      if (!dropzone) return;
      
      dropzone.addEventListener('dragover', (e) => {
        e.preventDefault();
        dropzone.classList.add('drag-over');
      });
      
      dropzone.addEventListener('dragleave', () => {
        dropzone.classList.remove('drag-over');
      });
      
      dropzone.addEventListener('drop', (e) => {
        e.preventDefault();
        dropzone.classList.remove('drag-over');
        
        const file = e.dataTransfer.files[0];
        if (file && file.type.startsWith('image/')) {
          const reader = new FileReader();
          reader.onload = (ev) => {
            const layer = gcLayers.find(l => l.id === layerId);
            if (layer) {
              layer.settings.imageData = ev.target.result;
              renderGcLayersList();
              renderGcCanvas();
            }
          };
          reader.readAsDataURL(file);
        }
      });
    }
    
    // ===== LAYER DRAG & DROP REORDERING =====
    
    function handleLayerDragStart(e, layerId) {
      gcDraggedLayerId = layerId;
      e.target.classList.add('dragging');
      e.dataTransfer.effectAllowed = 'move';
    }
    
    function handleLayerDragOver(e) {
      e.preventDefault();
      e.dataTransfer.dropEffect = 'move';
    }
    
    function handleLayerDrop(e, targetLayerId) {
      e.preventDefault();
      
      if (!gcDraggedLayerId || gcDraggedLayerId === targetLayerId) return;
      
      const draggedIndex = gcLayers.findIndex(l => l.id === gcDraggedLayerId);
      const targetIndex = gcLayers.findIndex(l => l.id === targetLayerId);
      
      if (draggedIndex === -1 || targetIndex === -1) return;
      
      // Remove dragged layer
      const [draggedLayer] = gcLayers.splice(draggedIndex, 1);
      
      // Find new target index (may have shifted)
      const newTargetIndex = gcLayers.findIndex(l => l.id === targetLayerId);
      
      // Insert at target position
      gcLayers.splice(newTargetIndex, 0, draggedLayer);
      
      renderGcLayersList();
      renderGcCanvas();
    }
    
    function handleLayerDragEnd(e) {
      e.target.classList.remove('dragging');
      gcDraggedLayerId = null;
    }
    
    // ===== CANVAS RENDERING =====
    
    function renderGcCanvas() {
      if (!gcCanvas) return;
      
      // Clear canvas
      gcCanvas.clear();
      gcCanvas.backgroundColor = '#ffffff';
      
      // Render each layer (bottom to top)
      gcLayers.forEach((layer, index) => {
        if (!layer.visible) return;
        
        const obj = createFabricObject(layer, gcCanvas, gcLayers);
        if (obj) {
          obj.layerId = layer.id;
          obj.selectable = !layer.locked;
          obj.evented = !layer.locked;
          obj.opacity = layer.opacity / 100;
          gcCanvas.add(obj);
        }
      });
      
      gcCanvas.renderAll();
    }
    
    function createFabricObject(layer, targetCanvas, layersArray) {
      // Default to gcCanvas and gcLayers if not provided (backwards compatibility)
      targetCanvas = targetCanvas || gcCanvas;
      layersArray = layersArray || gcLayers;
      
      switch (layer.type) {
        case 'solid':
          return createSolidObject(layer);
        case 'gradient':
          return createGradientObject(layer);
        case 'image':
          return createImageObject(layer, targetCanvas, layersArray);
        case 'text':
          return createTextObject(layer);
        default:
          return null;
      }
    }
    
    function createSolidObject(layer) {
      let color = layer.settings.color;
      
      // Handle school color variables
      if (layer.settings.useSchoolColor) {
        // Default to primary if schoolColorType is not set or is 'primary'
        color = layer.settings.schoolColorType === 'secondary' ? gcTemplateSecondary : gcTemplatePrimary;
      }
      
      return new fabric.Rect({
        left: layer.position.x,
        top: layer.position.y,
        width: layer.size?.width || gcCanvasWidth,
        height: layer.size?.height || gcCanvasHeight,
        fill: color,
        angle: layer.rotation || 0,
        originX: 'left',
        originY: 'top'
      });
    }
    
    function createGradientObject(layer) {
      const colors = layer.settings.colors || ['#333333', '#666666'];
      const resolvedColors = colors.map(c => {
        if (c === '{{primary}}') return gcTemplatePrimary;
        if (c === '{{secondary}}') return gcTemplateSecondary;
        return c;
      });
      
      const direction = layer.settings.direction || 'to-right';
      let coords;
      const w = layer.size?.width || gcCanvasWidth;
      const h = layer.size?.height || gcCanvasHeight;
      
      switch (direction) {
        case 'to-right':
          coords = { x1: 0, y1: 0, x2: w, y2: 0 };
          break;
        case 'to-bottom':
          coords = { x1: 0, y1: 0, x2: 0, y2: h };
          break;
        case 'to-bottom-right':
          coords = { x1: 0, y1: 0, x2: w, y2: h };
          break;
        case 'to-top-right':
          coords = { x1: 0, y1: h, x2: w, y2: 0 };
          break;
        default:
          coords = { x1: 0, y1: 0, x2: w, y2: 0 };
      }
      
      const gradient = new fabric.Gradient({
        type: 'linear',
        coords: coords,
        colorStops: [
          { offset: 0, color: resolvedColors[0] },
          { offset: 1, color: resolvedColors[1] }
        ]
      });
      
      return new fabric.Rect({
        left: layer.position.x,
        top: layer.position.y,
        width: w,
        height: h,
        fill: gradient,
        angle: layer.rotation || 0,
        originX: 'left',
        originY: 'top'
      });
    }
    
    function createImageObject(layer, targetCanvas, layersArray) {
      // Default to gcCanvas/gcLayers if not provided
      targetCanvas = targetCanvas || gcCanvas;
      layersArray = layersArray || gcLayers;
      
      const imageData = layer.settings.imageData || layer.settings.src;
      
      if (!imageData) {
        // Return visible placeholder for editable image slots
        const placeholder = new fabric.Rect({
          left: layer.position.x,
          top: layer.position.y,
          width: layer.size?.width || 400,
          height: layer.size?.height || 300,
          fill: '#e8e8e8',
          stroke: '#bbb',
          strokeWidth: 3,
          strokeDashArray: [15, 10],
          originX: 'center',
          originY: 'center',
          layerId: layer.id
        });
        return placeholder;
      }
      
      // Determine if it's a data URL (base64) or external URL
      const isDataUrl = imageData.startsWith('data:');
      const imgOptions = isDataUrl ? {} : { crossOrigin: 'anonymous' };
      
      // Create a reference to capture current values
      const capturedLayer = JSON.parse(JSON.stringify(layer));
      const capturedCanvas = targetCanvas;
      const capturedLayers = layersArray;
      
      // Load image asynchronously
      fabric.Image.fromURL(imageData, (img) => {
        if (!img) {
          console.error('Failed to load image for layer:', capturedLayer.id);
          return;
        }
        
        if (!capturedCanvas) {
          console.error('Canvas not available for layer:', capturedLayer.id);
          return;
        }
        
        const targetW = capturedLayer.size?.width || gcCanvasWidth;
        const targetH = capturedLayer.size?.height || gcCanvasHeight * 0.65;
        
        // Calculate scale based on fit mode
        let scale;
        const fit = capturedLayer.settings.fit || 'cover';
        if (fit === 'cover') {
          scale = Math.max(targetW / img.width, targetH / img.height);
        } else if (fit === 'contain') {
          scale = Math.min(targetW / img.width, targetH / img.height);
        } else {
          scale = targetW / img.width;
        }
        
        img.set({
          left: capturedLayer.position.x,
          top: capturedLayer.position.y,
          scaleX: scale,
          scaleY: fit === 'stretch' ? targetH / img.height : scale,
          angle: capturedLayer.rotation || 0,
          originX: 'center',
          originY: 'center',
          layerId: capturedLayer.id,
          selectable: !capturedLayer.locked,
          opacity: (capturedLayer.opacity || 100) / 100
        });
        
        // Apply mask if set
        if (capturedLayer.settings.mask) {
          applyMask(img, capturedLayer.settings.mask, targetW, targetH, capturedLayer.settings.polygonPoints);
        }
        
        // Find and replace placeholder on the target canvas
        const objects = capturedCanvas.getObjects();
        const placeholder = objects.find(o => o.layerId === capturedLayer.id);
        if (placeholder) {
          capturedCanvas.remove(placeholder);
        }
        
        // Add at correct position using the captured layers array
        const layerIndex = capturedLayers.findIndex(l => l.id === capturedLayer.id);
        if (layerIndex >= 0) {
          capturedCanvas.insertAt(img, layerIndex);
        } else {
          capturedCanvas.add(img);
        }
        capturedCanvas.renderAll();
      }, imgOptions);
      
      // Return placeholder while loading
      const loadingPlaceholder = new fabric.Rect({
        left: layer.position.x,
        top: layer.position.y,
        width: layer.size?.width || 200,
        height: layer.size?.height || 200,
        fill: '#f0f0f0',
        stroke: '#ddd',
        strokeWidth: 1,
        originX: 'center',
        originY: 'center',
        layerId: layer.id
      });
      return loadingPlaceholder;
    }
    
    function applyMask(img, maskType, width, height, polygonPoints) {
      if (maskType === 'circle') {
        img.set({
          clipPath: new fabric.Circle({
            radius: Math.min(width, height) / 2,
            originX: 'center',
            originY: 'center',
            stroke: null,
            strokeWidth: 0
          })
        });
      } else if (maskType === 'rectangle') {
        img.set({
          clipPath: new fabric.Rect({
            width: width,
            height: height,
            originX: 'center',
            originY: 'center',
            rx: 20,
            ry: 20,
            stroke: null,
            strokeWidth: 0
          })
        });
      } else if (maskType === 'polygon' && polygonPoints?.length >= 3) {
        // Convert points to Fabric polygon format
        // Points are stored in absolute canvas coordinates, need to make relative to image center
        const imgCenterX = img.left;
        const imgCenterY = img.top;
        
        const relativePoints = polygonPoints.map(p => ({
          x: p.x - imgCenterX,
          y: p.y - imgCenterY
        }));
        
        img.set({
          clipPath: new fabric.Polygon(relativePoints, {
            originX: 'center',
            originY: 'center',
            stroke: null,
            strokeWidth: 0,
            fill: '#000000' // Solid fill for clip path
          })
        });
      }
    }
    
    function createTextObject(layer) {
      const s = layer.settings;
      const content = s.content || s.placeholder || '';
      
      // Use layer width or default to 80% of canvas
      const textWidth = layer.size?.width || (gcCanvasWidth * 0.8);
      
      const textOptions = {
        left: layer.position.x,
        top: layer.position.y,
        width: textWidth,
        fontFamily: s.font || 'Poppins',
        fontSize: s.fontSize || 48,
        fill: s.color || '#333333',
        textAlign: s.align || 'center',
        originX: 'center',
        originY: 'center',
        angle: layer.rotation || 0,
        splitByGrapheme: false
      };
      
      if (s.shadow?.enabled) {
        textOptions.shadow = new fabric.Shadow({
          color: s.shadow.color || 'rgba(0,0,0,0.5)',
          blur: s.shadow.blur || 20,
          offsetX: s.shadow.offsetX || 10,
          offsetY: s.shadow.offsetY || 10
        });
      }
      
      return new fabric.Textbox(content, textOptions);
    }
    
    // ===== CANVAS EVENTS =====
    
    function setupCanvasEvents() {
      // Track position changes while moving (real-time)
      gcCanvas.on('object:moving', (e) => {
        const obj = e.target;
        if (!obj.layerId) return;
        
        const layer = gcLayers.find(l => l.id === obj.layerId);
        if (layer) {
          layer.position.x = obj.left;
          layer.position.y = obj.top;
        }
      });
      
      // Track all modifications (move, scale, rotate)
      gcCanvas.on('object:modified', (e) => {
        const obj = e.target;
        if (!obj.layerId) return;
        
        const layer = gcLayers.find(l => l.id === obj.layerId);
        if (!layer) return;
        
        // Update layer position
        layer.position.x = obj.left;
        layer.position.y = obj.top;
        layer.rotation = obj.angle || 0;
        
        // Update size if scaled
        if (obj.width && obj.scaleX) {
          layer.size = {
            width: obj.width * obj.scaleX,
            height: obj.height * obj.scaleY
          };
        }
      });
      
      gcCanvas.on('selection:created', (e) => {
        const obj = e.selected[0];
        if (obj?.layerId) {
          gcSelectedLayerId = obj.layerId;
          // Don't re-render canvas, just update layer list UI
          updateLayerListSelection();
        }
      });
      
      gcCanvas.on('selection:updated', (e) => {
        const obj = e.selected[0];
        if (obj?.layerId) {
          gcSelectedLayerId = obj.layerId;
          updateLayerListSelection();
        }
      });
      
      gcCanvas.on('selection:cleared', () => {
        // Don't clear selection or re-render, just update UI
        updateLayerListSelection();
      });
    }
    
    // Update layer list selection highlighting without full re-render
    function updateLayerListSelection() {
      document.querySelectorAll('.gc-layer-item').forEach(item => {
        const layerId = item.dataset.layerId;
        if (layerId === gcSelectedLayerId) {
          item.classList.add('selected');
        } else {
          item.classList.remove('selected');
        }
      });
    }
    
    // ===== CARD TOGGLE =====
    
    function toggleGcCard(header) {
      const body = header.nextElementSibling;
      const toggle = header.querySelector('.gc-toggle');
      
      if (body.classList.contains('collapsed')) {
        body.classList.remove('collapsed');
        toggle?.classList.remove('collapsed');
      } else {
        body.classList.add('collapsed');
        toggle?.classList.add('collapsed');
      }
    }
    
    // ===== EXPORT =====
    
    function saveGcAsPNG() {
      if (!gcCanvas) {
        showToast('Canvas not initialized', 'error');
        return;
      }
      
      // Store current zoom
      const currentZoom = gcCanvas.getZoom();
      
      // Set to full size
      gcCanvas.setZoom(1);
      gcCanvas.setWidth(gcCanvasWidth);
      gcCanvas.setHeight(gcCanvasHeight);
      gcCanvas.renderAll();
      
      // Generate data URL
      const dataURL = gcCanvas.toDataURL({
        format: 'png',
        quality: 1,
        multiplier: 1
      });
      
      // Restore preview size
      gcCanvas.setZoom(currentZoom);
      gcCanvas.setWidth(Math.round(gcCanvasWidth * currentZoom));
      gcCanvas.setHeight(Math.round(gcCanvasHeight * currentZoom));
      gcCanvas.renderAll();
      
      // Generate filename
      let filename = 'ball603-graphic.png';
      const select = document.getElementById('gcCreatorTeamSelect');
      if (select && select.value) {
        const team = gcTemplateTeams.find(t => t.id == select.value);
        if (team) {
          const shortname = (team.shortname || 'Team').replace(/\s+/g, '');
          const gender = (team.gender || '').replace(/\s+/g, '');
          const now = new Date();
          const dateStr = String(now.getMonth() + 1).padStart(2, '0') + 
                          String(now.getDate()).padStart(2, '0') + 
                          String(now.getFullYear()).slice(-2);
          filename = `${shortname}${gender}${dateStr}.png`;
        }
      }
      
      // Download
      const link = document.createElement('a');
      link.download = filename;
      link.href = dataURL;
      link.click();
      
      showToast('Graphic downloaded!', 'success');
    }
    
    function previewGcFullSize() {
      if (!gcCanvas) return;
      
      // Store current zoom
      const currentZoom = gcCanvas.getZoom();
      
      // Set to full size
      gcCanvas.setZoom(1);
      gcCanvas.setWidth(gcCanvasWidth);
      gcCanvas.setHeight(gcCanvasHeight);
      gcCanvas.renderAll();
      
      // Generate data URL
      const dataURL = gcCanvas.toDataURL({
        format: 'png',
        quality: 1
      });
      
      // Restore preview size
      gcCanvas.setZoom(currentZoom);
      gcCanvas.setWidth(Math.round(gcCanvasWidth * currentZoom));
      gcCanvas.setHeight(Math.round(gcCanvasHeight * currentZoom));
      gcCanvas.renderAll();
      
      // Open in new window
      const win = window.open('', '_blank');
      win.document.write(`
        <html>
          <head><title>Ball603 Graphic Preview</title></head>
          <body style="margin: 0; display: flex; justify-content: center; align-items: center; min-height: 100vh; background: #333;">
            <img src="${dataURL}" style="max-width: 100%; max-height: 100vh;">
          </body>
        </html>
      `);
    }
    
    function resetGcCreator() {
      if (!confirm('Reset canvas and all layers? This cannot be undone.')) return;
      
      gcLayers = [];
      gcSelectedLayerId = null;
      gcLayerIdCounter = 0;
      
      addDefaultLayers();
      renderGcLayersList();
      renderGcCanvas();
      
      showToast('Canvas reset', 'success');
    }
    
    // ===== TEMPLATE SYSTEM =====
    
    async function loadGcTemplates() {
      try {
        const { data, error } = await db
          .from('graphic_templates')
          .select('*')
          .order('created_at', { ascending: false });
        
        if (error) throw error;
        
        gcTemplates = data || [];
        console.log('Loaded', gcTemplates.length, 'templates from database');
        gcTemplates.forEach((t, i) => {
          console.log(`  Template ${i}: ${t.name}, layers:`, t.layers?.length || 0);
        });
        
        renderTemplateGrid();
      } catch (err) {
        console.error('Error loading templates:', err);
      }
    }
    
    function renderTemplateGrid() {
      const container = document.getElementById('gcTemplatesList');
      if (!container) return;
      
      let html = `
        <div class="gc-template-card gc-template-new" onclick="showGraphicsSubTab('creator', document.querySelector('.graphics-subtab'))">
          <div style="font-size: 40px; margin-bottom: 8px;">+</div>
          <div style="font-size: 13px; font-weight: 500;">Create New</div>
        </div>
      `;
      
      gcTemplates.forEach(template => {
        html += `
          <div class="gc-template-card" onclick="selectTemplate('${template.id}')">
            ${template.thumbnail_url ? 
              `<img class="gc-template-thumb" src="${template.thumbnail_url}" alt="${template.name}">` :
              `<div class="gc-template-thumb" style="display: flex; align-items: center; justify-content: center; font-size: 24px;">üìÑ</div>`
            }
            <div class="gc-template-name">${template.name}</div>
            ${template.description ? `<div class="gc-template-desc">${template.description}</div>` : ''}
          </div>
        `;
      });
      
      container.innerHTML = html;
    }
    
    function openSaveTemplateModal() {
      document.getElementById('gcTemplateName').value = '';
      document.getElementById('gcTemplateDescription').value = '';
      document.getElementById('saveTemplateModal').classList.add('open');
    }
    
    function closeSaveTemplateModal() {
      document.getElementById('saveTemplateModal').classList.remove('open');
    }
    
    async function saveTemplate() {
      const name = document.getElementById('gcTemplateName').value.trim();
      const description = document.getElementById('gcTemplateDescription').value.trim();
      
      if (!name) {
        showToast('Please enter a template name', 'error');
        return;
      }
      
      console.log('Saving template:', name);
      console.log('Layers to save:', gcLayers.length);
      gcLayers.forEach((l, i) => {
        console.log(`  Layer ${i}: ${l.name} (${l.type})`, 
          l.type === 'image' ? `hasImageData: ${!!l.settings?.imageData}, hasSrc: ${!!l.settings?.src}` : '');
        if (l.type === 'image' && l.settings?.imageData) {
          console.log(`    imageData length: ${l.settings.imageData.length} chars`);
        }
      });
      
      try {
        // Generate thumbnail
        const thumbnailUrl = await generateTemplateThumbnail();
        
        const templateData = {
          name: name,
          description: description || null,
          width: gcCanvasWidth,
          height: gcCanvasHeight,
          layers: gcLayers,
          thumbnail_url: thumbnailUrl
        };
        
        const { data, error } = await db
          .from('graphic_templates')
          .insert([templateData])
          .select()
          .single();
        
        if (error) throw error;
        
        console.log('Template saved successfully, id:', data.id);
        
        gcTemplates.unshift(data);
        renderTemplateGrid();
        closeSaveTemplateModal();
        showToast('Template saved!', 'success');
      } catch (err) {
        console.error('Error saving template:', err);
        showToast('Error saving template: ' + err.message, 'error');
      }
    }
    
    async function generateTemplateThumbnail() {
      if (!gcCanvas) return null;
      
      const currentZoom = gcCanvas.getZoom();
      
      // Set small size for thumbnail
      const thumbScale = 0.1;
      gcCanvas.setZoom(thumbScale);
      gcCanvas.setWidth(Math.round(gcCanvasWidth * thumbScale));
      gcCanvas.setHeight(Math.round(gcCanvasHeight * thumbScale));
      gcCanvas.renderAll();
      
      const dataURL = gcCanvas.toDataURL({
        format: 'png',
        quality: 0.7
      });
      
      // Restore
      gcCanvas.setZoom(currentZoom);
      gcCanvas.setWidth(Math.round(gcCanvasWidth * currentZoom));
      gcCanvas.setHeight(Math.round(gcCanvasHeight * currentZoom));
      gcCanvas.renderAll();
      
      return dataURL;
    }
    
    function selectTemplate(templateId) {
      const template = gcTemplates.find(t => t.id == templateId);
      if (!template) {
        console.error('Template not found:', templateId);
        return;
      }
      
      console.log('Loading template:', template.name);
      console.log('Template layers:', template.layers?.length || 0);
      if (template.layers) {
        template.layers.forEach((l, i) => {
          console.log(`  Layer ${i}: ${l.name} (${l.type})`, 
            l.type === 'image' ? `hasImageData: ${!!l.settings?.imageData}, hasSrc: ${!!l.settings?.src}` : '');
        });
      }
      
      gcCurrentTemplate = template;
      
      // Show editor
      document.getElementById('gcTemplateGrid').style.display = 'none';
      document.getElementById('gcTemplateEditor').style.display = 'block';
      document.getElementById('gcTemplateEditorTitle').textContent = `Editing: ${template.name}`;
      
      // Initialize template canvas
      initTemplateCanvas(template);
      
      // Build editable fields
      buildEditableFields(template);
    }
    
    function backToTemplateGrid() {
      document.getElementById('gcTemplateGrid').style.display = 'block';
      document.getElementById('gcTemplateEditor').style.display = 'none';
      gcCurrentTemplate = null;
    }
    
    function initTemplateCanvas(template) {
      const canvasEl = document.getElementById('gcTemplateCanvas');
      
      // Calculate preview scale
      const maxHeight = 450;
      const scale = maxHeight / template.height;
      
      canvasEl.width = Math.round(template.width * scale);
      canvasEl.height = Math.round(template.height * scale);
      
      if (gcTemplateCanvas) {
        gcTemplateCanvas.dispose();
      }
      
      gcTemplateCanvas = new fabric.Canvas('gcTemplateCanvas', {
        backgroundColor: '#ffffff',
        selection: false
      });
      
      gcTemplateCanvas.setZoom(scale);
      
      // Render template layers
      renderTemplatePreview();
    }
    
    function renderTemplatePreview() {
      if (!gcTemplateCanvas || !gcCurrentTemplate) {
        console.error('renderTemplatePreview: Missing canvas or template');
        return;
      }
      
      gcTemplateCanvas.clear();
      gcTemplateCanvas.backgroundColor = '#ffffff';
      
      const layers = gcCurrentTemplate.layers || [];
      console.log('Rendering template with', layers.length, 'layers');
      
      layers.forEach((layer, index) => {
        if (!layer.visible) {
          console.log(`Layer ${index} (${layer.name}) is hidden`);
          return;
        }
        
        console.log(`Rendering layer ${index}: ${layer.name} (${layer.type})`, 
          layer.type === 'image' ? `hasImage: ${!!(layer.settings.imageData || layer.settings.src)}` : '');
        
        // Create object with template color substitutions, passing template canvas
        const obj = createTemplateObject(layer, gcTemplateCanvas, layers);
        if (obj) {
          obj.selectable = false;
          obj.evented = false;
          obj.opacity = (layer.opacity || 100) / 100;
          gcTemplateCanvas.add(obj);
        }
      });
      
      gcTemplateCanvas.renderAll();
    }
    
    function createTemplateObject(layer, targetCanvas, layersArray) {
      // Similar to createFabricObject but uses template colors
      const tempLayer = JSON.parse(JSON.stringify(layer));
      
      // Substitute color variables
      if (tempLayer.settings) {
        if (tempLayer.settings.color === '{{primary}}') {
          tempLayer.settings.color = gcTemplatePrimary;
        } else if (tempLayer.settings.color === '{{secondary}}') {
          tempLayer.settings.color = gcTemplateSecondary;
        }
        
        if (tempLayer.settings.useSchoolColor) {
          // Default to primary if schoolColorType is not set or is 'primary'
          tempLayer.settings.color = tempLayer.settings.schoolColorType === 'secondary' 
            ? gcTemplateSecondary : gcTemplatePrimary;
        }
        
        if (tempLayer.settings.colors) {
          tempLayer.settings.colors = tempLayer.settings.colors.map(c => {
            if (c === '{{primary}}') return gcTemplatePrimary;
            if (c === '{{secondary}}') return gcTemplateSecondary;
            return c;
          });
        }
      }
      
      return createFabricObject(tempLayer, targetCanvas, layersArray);
    }
    
    function buildEditableFields(template) {
      const container = document.getElementById('gcTemplateEditableFields');
      let html = '';
      
      const layers = template.layers || [];
      
      layers.forEach(layer => {
        if (!layer.editable) return;
        
        if (layer.type === 'image') {
          html += `
            <div class="gc-sidebar-card">
              <div class="gc-card-header">
                <span>üì∑ ${layer.name}</span>
              </div>
              <div class="gc-card-body">
                <div class="gc-dropzone" onclick="document.getElementById('templateImageInput-${layer.id}').click()">
                  <div class="gc-dropzone-icon">üì∑</div>
                  <div class="gc-dropzone-text">Drop image or click to upload</div>
                  <input type="file" id="templateImageInput-${layer.id}" accept="image/*" style="display: none;" onchange="handleTemplateImageUpload('${layer.id}', this)">
                </div>
              </div>
            </div>
          `;
        } else if (layer.type === 'text') {
          html += `
            <div class="gc-sidebar-card">
              <div class="gc-card-header">
                <span>‚úèÔ∏è ${layer.name}</span>
              </div>
              <div class="gc-card-body">
                <textarea id="templateText-${layer.id}" rows="2" placeholder="${layer.settings.placeholder || 'Enter text...'}" oninput="updateTemplateText('${layer.id}', this.value)">${layer.settings.content || ''}</textarea>
              </div>
            </div>
          `;
        }
      });
      
      container.innerHTML = html;
    }
    
    function applyTemplateTeamColors() {
      const select = document.getElementById('gcTemplateTeamSelect');
      const option = select.selectedOptions[0];
      
      console.log('applyTemplateTeamColors - selected option:', option?.textContent);
      console.log('  dataset.primary:', option?.dataset?.primary);
      console.log('  dataset.secondary:', option?.dataset?.secondary);
      
      if (option && option.value) {
        gcTemplatePrimary = option.dataset.primary || '#1e3a8a';
        gcTemplateSecondary = option.dataset.secondary || '#fbbf24';
        
        document.getElementById('gcTemplatePrimary').value = gcTemplatePrimary;
        document.getElementById('gcTemplatePrimaryHex').value = gcTemplatePrimary;
        document.getElementById('gcTemplateSecondary').value = gcTemplateSecondary;
        document.getElementById('gcTemplateSecondaryHex').value = gcTemplateSecondary;
        
        renderTemplatePreview();
      }
    }
    
    function updateTemplateColors() {
      gcTemplatePrimary = document.getElementById('gcTemplatePrimary').value;
      gcTemplateSecondary = document.getElementById('gcTemplateSecondary').value;
      
      document.getElementById('gcTemplatePrimaryHex').value = gcTemplatePrimary;
      document.getElementById('gcTemplateSecondaryHex').value = gcTemplateSecondary;
      
      renderTemplatePreview();
    }
    
    function updateTemplateColorFromHex(type) {
      if (type === 'primary') {
        gcTemplatePrimary = document.getElementById('gcTemplatePrimaryHex').value;
        document.getElementById('gcTemplatePrimary').value = gcTemplatePrimary;
      } else {
        gcTemplateSecondary = document.getElementById('gcTemplateSecondaryHex').value;
        document.getElementById('gcTemplateSecondary').value = gcTemplateSecondary;
      }
      
      renderTemplatePreview();
    }
    
    function toggleTemplateCustomColors() {
      const custom = document.getElementById('gcTemplateCustomColors').checked;
      if (custom) {
        document.getElementById('gcTemplateTeamSelect').value = '';
      }
    }
    
    function updateTemplateText(layerId, value) {
      if (!gcCurrentTemplate) return;
      
      const layer = gcCurrentTemplate.layers.find(l => l.id === layerId);
      if (layer) {
        layer.settings.content = value;
        renderTemplatePreview();
      }
    }
    
    function handleTemplateImageUpload(layerId, input) {
      const file = input.files[0];
      if (!file) return;
      
      const reader = new FileReader();
      reader.onload = (e) => {
        if (!gcCurrentTemplate) return;
        
        const layer = gcCurrentTemplate.layers.find(l => l.id === layerId);
        if (layer) {
          layer.settings.imageData = e.target.result;
          renderTemplatePreview();
          showToast('Image loaded', 'success');
        }
      };
      reader.readAsDataURL(file);
    }
    
    async function deleteCurrentTemplate() {
      if (!gcCurrentTemplate) return;
      
      if (!confirm(`Delete template "${gcCurrentTemplate.name}"? This cannot be undone.`)) return;
      
      try {
        const { error } = await db
          .from('graphic_templates')
          .delete()
          .eq('id', gcCurrentTemplate.id);
        
        if (error) throw error;
        
        gcTemplates = gcTemplates.filter(t => t.id !== gcCurrentTemplate.id);
        backToTemplateGrid();
        renderTemplateGrid();
        showToast('Template deleted', 'success');
      } catch (err) {
        console.error('Error deleting template:', err);
        showToast('Error deleting template: ' + err.message, 'error');
      }
    }
    
    function exportFromTemplate() {
      if (!gcTemplateCanvas || !gcCurrentTemplate) return;
      
      const currentZoom = gcTemplateCanvas.getZoom();
      
      // Set to full size
      gcTemplateCanvas.setZoom(1);
      gcTemplateCanvas.setWidth(gcCurrentTemplate.width);
      gcTemplateCanvas.setHeight(gcCurrentTemplate.height);
      gcTemplateCanvas.renderAll();
      
      // Generate data URL
      const dataURL = gcTemplateCanvas.toDataURL({
        format: 'png',
        quality: 1
      });
      
      // Restore preview size
      const maxHeight = 450;
      const scale = maxHeight / gcCurrentTemplate.height;
      gcTemplateCanvas.setZoom(scale);
      gcTemplateCanvas.setWidth(Math.round(gcCurrentTemplate.width * scale));
      gcTemplateCanvas.setHeight(Math.round(gcCurrentTemplate.height * scale));
      gcTemplateCanvas.renderAll();
      
      // Generate filename
      let filename = `ball603-${gcCurrentTemplate.name.toLowerCase().replace(/[^a-z0-9]/g, '-')}.png`;
      const select = document.getElementById('gcTemplateTeamSelect');
      if (select && select.value) {
        const team = gcTemplateTeams.find(t => t.id == select.value);
        if (team) {
          const shortname = (team.shortname || 'Team').replace(/\s+/g, '');
          const gender = (team.gender || '').replace(/\s+/g, '');
          const now = new Date();
          const dateStr = String(now.getMonth() + 1).padStart(2, '0') + 
                          String(now.getDate()).padStart(2, '0') + 
                          String(now.getFullYear()).slice(-2);
          filename = `${shortname}${gender}${dateStr}.png`;
        }
      }
      
      // Download
      const link = document.createElement('a');
      link.download = filename;
      link.href = dataURL;
      link.click();
      
      showToast('Graphic exported!', 'success');
    }
    
    // ===== SUB-TAB SWITCHING =====
    
    function showGraphicsSubTab(tab, btn) {
      // Update button styles
      document.querySelectorAll('.graphics-subtab').forEach(b => {
        b.style.background = 'none';
        b.style.color = '#666';
        b.style.borderColor = '#ddd';
      });
      btn.style.background = '#f57c00';
      btn.style.color = 'white';
      btn.style.borderColor = '#f57c00';
      
      // Show/hide panels
      document.getElementById('graphicsCreatorPanel').style.display = tab === 'creator' ? 'block' : 'none';
      document.getElementById('graphicsTemplatesPanel').style.display = tab === 'templates' ? 'block' : 'none';
      
      // Initialize if needed
      if (tab === 'templates') {
        loadGcTemplates();
      }
    }
    
    
    // ===== GALLERY MANAGER =====
    
    // All NHIAA teams organized by division
    const GALLERY_TEAMS_BY_DIVISION = {
      'D-I': ['Bedford', 'Bishop Guertin', 'Concord', 'Dover', 'Exeter', 'Goffstown', 'Londonderry', 'Manchester Central', 'Manchester Memorial', 'Merrimack', 'Nashua North', 'Nashua South', 'Pinkerton', 'Salem', 'Timberlane', 'Winnacunnet'],
      'D-II': ['Bow', 'Coe-Brown', 'Hanover', 'Hollis-Brookline', 'John Stark', 'Keene', 'Kennett', 'Kingswood', 'Laconia', 'Lebanon', 'Merrimack Valley', 'Milford', 'Oyster River', 'Pelham', 'Pembroke', 'Plymouth', 'Portsmouth', 'Souhegan', 'Spaulding', 'Windham'],
      'D-III': ['Belmont', 'Berlin', 'Bishop Brady', 'Campbell', 'ConVal', 'Derryfield', 'Fall Mountain', 'Franklin', 'Gilford', 'Hillsboro-Deering', 'Hopkinton', 'Inter-Lakes', 'Kearsarge', 'Mascenic', 'Mascoma Valley', 'Monadnock', 'Newfound', 'Newport', 'Prospect Mountain', 'Raymond', 'Sanborn', 'Somersworth', 'St. Thomas Aquinas', 'Stevens', 'Trinity', 'White Mountains', 'Winnisquam'],
      'D-IV': ['Colebrook', 'Concord Christian', 'Epping', 'Farmington', 'Gorham', 'Groveton', 'Hinsdale', 'Lin-Wood', 'Lisbon', 'Littleton', 'Moultonborough', 'Mount Royal', 'Newmarket', 'Nute', 'Pittsburg-Canaan', 'Portsmouth Christian', 'Profile', 'Sunapee', 'Wilton-Lyndeborough', 'Woodsville']
    };
    
    const ALL_GALLERY_TEAMS = [...new Set(Object.values(GALLERY_TEAMS_BY_DIVISION).flat())].sort();
    
    function teamToSlug(team) {
      return team.toLowerCase().replace(/[^a-z0-9]/g, '');
    }
    
    let galleryAlbums = [];
    let selectedGalleryAlbum = null;
    let galleryExistingTags = {};
    let galleryManagerFilter = 'all';
    let galleryManagerSearchTerm = '';
    
    // Gallery sub-tab switching
    function showGallerySubTab(tab, btn) {
      document.querySelectorAll('.gallery-subtab').forEach(b => {
        b.style.background = 'none';
        b.style.color = '#666';
        b.style.borderColor = '#ddd';
      });
      btn.style.background = '#f57c00';
      btn.style.color = 'white';
      btn.style.borderColor = '#f57c00';
      
      document.getElementById('galleryManagerSubPanel').style.display = tab === 'manager' ? 'block' : 'none';
      document.getElementById('galleryTeamsSubPanel').style.display = tab === 'teams' ? 'block' : 'none';
      
      if (tab === 'manager') {
        renderGalleryManagerList();
      } else {
        renderGalleryAlbumList();
      }
    }
    
    // Gallery Manager functions (pin/hide)
    function renderGalleryManagerList() {
      const container = document.getElementById('galleryManagerListBody');
      
      let filtered = [...galleryAlbums];
      
      // Apply filter
      if (galleryManagerFilter === 'pinned') {
        filtered = filtered.filter(g => g.pinned);
      } else if (galleryManagerFilter === 'hidden') {
        filtered = filtered.filter(g => g.hidden);
      }
      
      // Apply search
      if (galleryManagerSearchTerm) {
        const term = galleryManagerSearchTerm.toLowerCase();
        filtered = filtered.filter(g => g.name?.toLowerCase().includes(term));
      }
      
      document.getElementById('galleryManagerCount').textContent = `${filtered.length} galler${filtered.length !== 1 ? 'ies' : 'y'}`;
      
      if (filtered.length === 0) {
        container.innerHTML = '<div style="padding: 40px; text-align: center; color: #888;">No galleries found</div>';
        return;
      }
      
      container.innerHTML = filtered.map(gallery => {
        const date = gallery.album_date ? new Date(gallery.album_date).toLocaleDateString() : '--';
        return `
          <div style="display: grid; grid-template-columns: 80px 1fr 100px 80px 80px; padding: 10px 12px; border-bottom: 1px solid #eee; align-items: center; gap: 10px; ${gallery.pinned ? 'background: #fff8e1;' : ''} ${gallery.hidden ? 'opacity: 0.6;' : ''}">
            <div>
              <img src="${gallery.thumbnail_url || ''}" style="width: 70px; height: 45px; object-fit: cover; border-radius: 4px; background: #eee;" onerror="this.style.display='none'">
            </div>
            <div>
              <div style="font-size: 13px; font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${gallery.name}</div>
              <div style="font-size: 11px; color: #888;">${gallery.image_count || 0} photos</div>
            </div>
            <div style="font-size: 12px; color: #666;">${date}</div>
            <div>
              <button onclick="toggleGalleryPin('${gallery.album_key}', ${!gallery.pinned})" style="background: ${gallery.pinned ? '#fff3e0' : '#f5f5f5'}; border: none; padding: 6px 10px; border-radius: 4px; cursor: pointer; font-size: 12px;" title="${gallery.pinned ? 'Unpin' : 'Pin'}">
                ${gallery.pinned ? 'üìå' : '‚óã'}
              </button>
            </div>
            <div>
              <button onclick="toggleGalleryHidden('${gallery.album_key}', ${!gallery.hidden})" style="background: ${gallery.hidden ? '#ffebee' : '#f5f5f5'}; border: none; padding: 6px 10px; border-radius: 4px; cursor: pointer; font-size: 12px;" title="${gallery.hidden ? 'Show' : 'Hide'}">
                ${gallery.hidden ? 'üëç¬Å¬çüó®Ô∏è' : 'üëç¬Å'}
              </button>
            </div>
          </div>
        `;
      }).join('');
    }
    
    function filterGalleryManager(filter, btn) {
      galleryManagerFilter = filter;
      document.querySelectorAll('.gm-filter-btn').forEach(b => {
        b.style.background = '#fff';
        b.style.color = '#333';
      });
      btn.style.background = '#f57c00';
      btn.style.color = 'white';
      renderGalleryManagerList();
    }
    
    function searchGalleryManager(term) {
      galleryManagerSearchTerm = term;
      renderGalleryManagerList();
    }
    
    async function toggleGalleryPin(albumKey, pinned) {
      try {
        const { error } = await db
          .from('smugmug_albums')
          .update({ pinned })
          .eq('album_key', albumKey);
        
        if (error) throw error;
        
        const gallery = galleryAlbums.find(g => g.album_key === albumKey);
        if (gallery) gallery.pinned = pinned;
        renderGalleryManagerList();
        showToast(pinned ? 'Gallery pinned' : 'Gallery unpinned', 'success');
        
      } catch (err) {
        console.error('Error toggling pin:', err);
        showToast('Error updating gallery', 'error');
      }
    }
    
    async function toggleGalleryHidden(albumKey, hidden) {
      try {
        const { error } = await db
          .from('smugmug_albums')
          .update({ hidden })
          .eq('album_key', albumKey);
        
        if (error) throw error;
        
        const gallery = galleryAlbums.find(g => g.album_key === albumKey);
        if (gallery) gallery.hidden = hidden;
        renderGalleryManagerList();
        showToast(hidden ? 'Gallery hidden' : 'Gallery visible', 'success');
        
      } catch (err) {
        console.error('Error toggling hidden:', err);
        showToast('Error updating gallery', 'error');
      }
    }
    
    async function loadGalleryAlbums() {
      const container = document.getElementById('galleryAlbumList');
      container.innerHTML = '<div class="loading">Loading albums...</div>';
      
      try {
        const { data: albums, error } = await db
          .from('smugmug_albums')
          .select('*')
          .order('album_date', { ascending: false });
        
        if (error) throw error;
        
        galleryAlbums = albums || [];
        
        // Also load existing tags
        await loadGalleryExistingTags();
        
        renderGalleryAlbumList();
        renderGalleryManagerList();
      } catch (err) {
        console.error('Error loading albums:', err);
        container.innerHTML = '<div class="loading">Error loading albums</div>';
      }
    }
    
    async function loadGalleryExistingTags() {
      try {
        const { data: tags, error } = await db
          .from('team_galleries')
          .select('*');
        
        if (error) throw error;
        
        galleryExistingTags = {};
        for (const tag of (tags || [])) {
          if (!galleryExistingTags[tag.album_key]) {
            galleryExistingTags[tag.album_key] = [];
          }
          galleryExistingTags[tag.album_key].push(tag.team_slug);
        }
      } catch (err) {
        console.error('Error loading tags:', err);
      }
    }
    
    function renderGalleryAlbumList(filter = '') {
      const container = document.getElementById('galleryAlbumList');
      const filterLower = filter.toLowerCase();
      
      const filtered = galleryAlbums.filter(a => 
        !filter || a.name.toLowerCase().includes(filterLower)
      );
      
      if (filtered.length === 0) {
        container.innerHTML = '<div style="padding: 20px; text-align: center; color: #888;">No albums found</div>';
        return;
      }
      
      container.innerHTML = filtered.map(album => {
        const tags = galleryExistingTags[album.album_key] || [];
        const isSelected = selectedGalleryAlbum?.album_key === album.album_key;
        const date = album.album_date ? new Date(album.album_date).toLocaleDateString() : '';
        
        return `
          <div class="gallery-album-item" onclick="selectGalleryAlbum('${album.album_key}')" style="display: flex; align-items: center; gap: 10px; padding: 10px; border-bottom: 1px solid #eee; cursor: pointer; ${isSelected ? 'background: #fff3e0; border-left: 3px solid #f57c00;' : ''}" onmouseover="this.style.background='${isSelected ? '#fff3e0' : '#f5f5f5'}'" onmouseout="this.style.background='${isSelected ? '#fff3e0' : ''}'">
            <img src="${album.thumbnail_url || ''}" alt="" style="width: 50px; height: 35px; object-fit: cover; border-radius: 4px; background: #eee;" onerror="this.style.display='none'">
            <div style="flex: 1; min-width: 0;">
              <div style="font-size: 13px; font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${album.name}</div>
              <div style="font-size: 11px; color: #888;">${date} ‚Ä¢ ${album.image_count || 0} photos</div>
              ${tags.length > 0 ? `
                <div style="display: flex; flex-wrap: wrap; gap: 3px; margin-top: 4px;">
                  ${tags.slice(0, 3).map(t => `<span style="font-size: 9px; background: #e0e0e0; padding: 2px 5px; border-radius: 8px;">${t}</span>`).join('')}
                  ${tags.length > 3 ? `<span style="font-size: 9px; background: #e0e0e0; padding: 2px 5px; border-radius: 8px;">+${tags.length - 3}</span>` : ''}
                </div>
              ` : ''}
            </div>
          </div>
        `;
      }).join('');
    }
    
    function filterGalleryAlbums(value) {
      renderGalleryAlbumList(value);
    }
    
    function selectGalleryAlbum(albumKey) {
      selectedGalleryAlbum = galleryAlbums.find(a => a.album_key === albumKey);
      renderGalleryAlbumList(document.getElementById('galleryAlbumSearch').value);
      renderGalleryTagPanel();
    }
    
    function renderGalleryTagPanel() {
      const panel = document.getElementById('galleryTagPanel');
      
      if (!selectedGalleryAlbum) {
        panel.innerHTML = '<div style="text-align: center; padding: 60px 20px; color: #999;">Select an album from the left to tag it to teams</div>';
        return;
      }
      
      const currentTags = galleryExistingTags[selectedGalleryAlbum.album_key] || [];
      
      panel.innerHTML = `
        <div style="background: #fff; border-radius: 6px; padding: 12px; margin-bottom: 15px; border: 1px solid #eee;">
          <div style="font-weight: 500; font-size: 14px;">${selectedGalleryAlbum.name}</div>
          <div style="font-size: 12px; color: #666; margin-top: 4px;">
            ${selectedGalleryAlbum.image_count || 0} photos ‚Ä¢ 
            <a href="${selectedGalleryAlbum.url}" target="_blank" style="color: #1565c0;">View on SmugMug</a>
          </div>
        </div>
        
        <div style="margin-bottom: 15px;">
          <div style="font-size: 12px; font-weight: 600; color: #555; margin-bottom: 8px;">Quick Select</div>
          <div style="display: flex; flex-wrap: wrap; gap: 6px;">
            <button onclick="gallerySelectAll()" style="padding: 5px 10px; font-size: 11px; border: 1px solid #ddd; background: #fff; border-radius: 4px; cursor: pointer;">All Teams</button>
            <button onclick="gallerySelectNone()" style="padding: 5px 10px; font-size: 11px; border: 1px solid #ddd; background: #fff; border-radius: 4px; cursor: pointer;">Clear All</button>
            <button onclick="gallerySelectDivision('D-I')" style="padding: 5px 10px; font-size: 11px; border: 1px solid #ddd; background: #fff; border-radius: 4px; cursor: pointer;">All D-I</button>
            <button onclick="gallerySelectDivision('D-II')" style="padding: 5px 10px; font-size: 11px; border: 1px solid #ddd; background: #fff; border-radius: 4px; cursor: pointer;">All D-II</button>
            <button onclick="gallerySelectDivision('D-III')" style="padding: 5px 10px; font-size: 11px; border: 1px solid #ddd; background: #fff; border-radius: 4px; cursor: pointer;">All D-III</button>
            <button onclick="gallerySelectDivision('D-IV')" style="padding: 5px 10px; font-size: 11px; border: 1px solid #ddd; background: #fff; border-radius: 4px; cursor: pointer;">All D-IV</button>
          </div>
        </div>
        
        <div style="margin-bottom: 15px;">
          <div style="font-size: 12px; font-weight: 600; color: #555; margin-bottom: 8px;">Select Teams</div>
          <div style="max-height: 280px; overflow-y: auto; border: 1px solid #eee; border-radius: 6px; padding: 10px; background: #fff;">
            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 4px;">
              ${ALL_GALLERY_TEAMS.map(team => {
                const slug = teamToSlug(team);
                const checked = currentTags.includes(slug) ? 'checked' : '';
                return `
                  <label style="display: flex; align-items: center; gap: 5px; font-size: 12px; cursor: pointer; padding: 3px;">
                    <input type="checkbox" name="galleryTeam" value="${slug}" ${checked} style="accent-color: #f57c00;">
                    ${team}
                  </label>
                `;
              }).join('')}
            </div>
          </div>
        </div>
        
        <div style="display: flex; gap: 10px;">
          <button onclick="saveGalleryTags()" style="flex: 1; padding: 10px; background: #f57c00; color: #fff; border: none; border-radius: 5px; cursor: pointer; font-weight: 500;">Save Tags</button>
          <button onclick="selectedGalleryAlbum=null; renderGalleryTagPanel();" style="padding: 10px 15px; background: #f5f5f5; border: 1px solid #ddd; border-radius: 5px; cursor: pointer;">Cancel</button>
        </div>
        
        <div id="galleryStatusMessage" style="margin-top: 10px;"></div>
        
        ${currentTags.length > 0 ? `
          <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #eee;">
            <div style="font-size: 12px; font-weight: 600; color: #555; margin-bottom: 8px;">Current Tags (${currentTags.length})</div>
            <div style="display: flex; flex-wrap: wrap; gap: 6px;">
              ${currentTags.map(slug => `
                <span style="display: flex; align-items: center; gap: 4px; background: #e8f5e9; padding: 4px 8px; border-radius: 12px; font-size: 11px;">
                  ${slug}
                  <button onclick="removeGalleryTag('${slug}')" style="background: none; border: none; color: #c62828; cursor: pointer; font-size: 14px; line-height: 1; padding: 0;">√ó</button>
                </span>
              `).join('')}
            </div>
          </div>
        ` : ''}
      `;
    }
    
    function gallerySelectAll() {
      document.querySelectorAll('input[name="galleryTeam"]').forEach(cb => cb.checked = true);
    }
    
    function gallerySelectNone() {
      document.querySelectorAll('input[name="galleryTeam"]').forEach(cb => cb.checked = false);
    }
    
    function gallerySelectDivision(div) {
      const divisionTeams = new Set(GALLERY_TEAMS_BY_DIVISION[div].map(t => teamToSlug(t)));
      document.querySelectorAll('input[name="galleryTeam"]').forEach(cb => {
        if (divisionTeams.has(cb.value)) {
          cb.checked = true;
        }
      });
    }
    
    async function saveGalleryTags() {
      if (!selectedGalleryAlbum) return;
      
      const selectedTeams = Array.from(document.querySelectorAll('input[name="galleryTeam"]:checked'))
        .map(cb => cb.value);
      
      const currentTags = galleryExistingTags[selectedGalleryAlbum.album_key] || [];
      
      const toAdd = selectedTeams.filter(t => !currentTags.includes(t));
      const toRemove = currentTags.filter(t => !selectedTeams.includes(t));
      
      const statusEl = document.getElementById('galleryStatusMessage');
      
      try {
        // Remove unselected tags
        if (toRemove.length > 0) {
          for (const slug of toRemove) {
            await db
              .from('team_galleries')
              .delete()
              .eq('album_key', selectedGalleryAlbum.album_key)
              .eq('team_slug', slug);
          }
        }
        
        // Add new tags
        if (toAdd.length > 0) {
          const newTags = toAdd.map(slug => ({
            album_key: selectedGalleryAlbum.album_key,
            team_slug: slug,
            added_by: 'cms'
          }));
          
          await db
            .from('team_galleries')
            .upsert(newTags, { onConflict: 'album_key,team_slug' });
        }
        
        // Update local state
        galleryExistingTags[selectedGalleryAlbum.album_key] = selectedTeams;
        
        statusEl.innerHTML = '<div style="padding: 8px; background: #e8f5e9; color: #2e7d32; border-radius: 4px; font-size: 12px;">‚úçÔ∏è‚Äú Saved! Added ' + toAdd.length + ', removed ' + toRemove.length + ' tags.</div>';
        
        renderGalleryAlbumList(document.getElementById('galleryAlbumSearch').value);
        
        setTimeout(() => {
          renderGalleryTagPanel();
        }, 1500);
        
      } catch (err) {
        console.error('Error saving tags:', err);
        statusEl.innerHTML = '<div style="padding: 8px; background: #ffebee; color: #c62828; border-radius: 4px; font-size: 12px;">Error saving tags. Please try again.</div>';
      }
    }
    
    async function removeGalleryTag(slug) {
      if (!selectedGalleryAlbum) return;
      
      try {
        await db
          .from('team_galleries')
          .delete()
          .eq('album_key', selectedGalleryAlbum.album_key)
          .eq('team_slug', slug);
        
        const tags = galleryExistingTags[selectedGalleryAlbum.album_key] || [];
        galleryExistingTags[selectedGalleryAlbum.album_key] = tags.filter(t => t !== slug);
        
        renderGalleryAlbumList(document.getElementById('galleryAlbumSearch').value);
        renderGalleryTagPanel();
        
      } catch (err) {
        console.error('Error removing tag:', err);
        showToast('Error removing tag', 'error');
      }
    }
    
    // ===== SPONSORS MANAGER =====
    
    const SPONSOR_TEAMS = [
      'Alvirne', 'Bedford', 'Belmont', 'Berlin', 'Bishop Brady', 'Bishop Guertin', 'Bow', 'Campbell',
      'Coe-Brown', 'Colebrook', 'Conant', 'Concord', 'Concord Christian', 'ConVal', 'Derryfield', 'Dover',
      'Epping', 'Exeter', 'Fall Mountain', 'Farmington', 'Franklin', 'Gilford', 'Goffstown', 'Gorham',
      'Groveton', 'Hanover', 'Hillsboro-Deering', 'Hinsdale', 'Hollis-Brookline', 'Holy Family', 'Hopkinton',
      'Inter-Lakes', 'John Stark', 'Kearsarge', 'Keene', 'Kennett', 'Kingswood', 'Laconia', 'Lebanon',
      'Lin-Wood', 'Lisbon', 'Littleton', 'Londonderry', 'Manchester Central', 'Manchester Memorial',
      'Manchester West', 'Mascenic', 'Mascoma Valley', 'Merrimack', 'Merrimack Valley', 'Milford',
      'Monadnock', 'Moultonborough', 'Mount Royal', 'Nashua North', 'Nashua South', 'Newfound', 'Newmarket',
      'Newport', 'Nute', 'Oyster River', 'Pelham', 'Pembroke', 'Pinkerton', 'Pittsburg-Canaan', 'Plymouth',
      'Portsmouth', 'Portsmouth Christian', 'Profile', 'Prospect Mountain', 'Raymond', 'Salem', 'Sanborn',
      'Somersworth', 'Souhegan', 'Spaulding', 'Stevens', 'St. Thomas Aquinas', 'Sunapee', 'Timberlane',
      'Trinity', 'White Mountains', 'Wilton-Lyndeborough', 'Windham', 'Winnacunnet', 'Winnisquam', 'Woodsville'
    ];
    
    let allSponsors = [];
    
    async function loadSponsors() {
      const container = document.getElementById('sponsorList');
      
      try {
        const { data, error } = await db
          .from('sponsors')
          .select('*')
          .order('team_shortname', { ascending: true });
        
        if (error) throw error;
        
        allSponsors = data || [];
        
        // Populate team filter
        populateSponsorTeamFilter();
        
        renderSponsorList();
      } catch (err) {
        console.error('Error loading sponsors:', err);
        container.innerHTML = '<div class="loading">Error loading sponsors</div>';
      }
    }
    
    function populateSponsorTeamFilter() {
      const teamFilter = document.getElementById('sponsorTeamFilter');
      const teamSelect = document.getElementById('sponsorTeam');
      
      // Get unique teams from sponsors
      const teamsWithSponsors = [...new Set(allSponsors.map(s => s.team_shortname))].sort();
      
      // Team filter dropdown
      teamFilter.innerHTML = '<option value="">All Teams</option>' + 
        teamsWithSponsors.map(t => `<option value="${t}">${t}</option>`).join('');
      
      // Team select in modal
      teamSelect.innerHTML = '<option value="">Select team...</option>' + 
        SPONSOR_TEAMS.map(t => `<option value="${t}">${t}</option>`).join('');
      
      // Article sponsor dropdown
      populateArticleSponsorDropdown();
    }
    
    function populateArticleSponsorDropdown() {
      const dropdown = document.getElementById('manualSponsorId');
      if (!dropdown) return;
      
      const activeSponsors = allSponsors.filter(s => s.active);
      dropdown.innerHTML = '<option value="">Auto-detect from teams</option>' + 
        activeSponsors.map(s => `<option value="${s.id}">${s.name} (${s.team_shortname})</option>`).join('');
    }
    
    function filterSponsors() {
      renderSponsorList();
    }
    
    function renderSponsorList() {
      const container = document.getElementById('sponsorList');
      const teamFilter = document.getElementById('sponsorTeamFilter').value;
      const statusFilter = document.getElementById('sponsorStatusFilter').value;
      const searchFilter = document.getElementById('sponsorSearchBox').value.toLowerCase();
      
      let filtered = allSponsors;
      
      if (teamFilter) {
        filtered = filtered.filter(s => s.team_shortname === teamFilter);
      }
      
      if (statusFilter === 'active') {
        filtered = filtered.filter(s => s.active);
      } else if (statusFilter === 'inactive') {
        filtered = filtered.filter(s => !s.active);
      }
      
      if (searchFilter) {
        filtered = filtered.filter(s => 
          s.name.toLowerCase().includes(searchFilter) ||
          s.team_shortname.toLowerCase().includes(searchFilter)
        );
      }
      
      if (filtered.length === 0) {
        container.innerHTML = `
          <div class="article-row header" style="grid-template-columns: 80px 1fr 150px 100px 100px 120px;">
            <div>Logo</div>
            <div>Sponsor</div>
            <div>Team</div>
            <div>Tier</div>
            <div>Status</div>
            <div>Actions</div>
          </div>
          <div class="empty-state">
            <p>No sponsors found</p>
          </div>
        `;
        return;
      }
      
      container.innerHTML = `
        <div class="article-row header" style="grid-template-columns: 80px 1fr 150px 100px 100px 120px;">
          <div>Logo</div>
          <div>Sponsor</div>
          <div>Team</div>
          <div>Tier</div>
          <div>Status</div>
          <div>Actions</div>
        </div>
        ${filtered.map(sponsor => `
          <div class="article-row" style="grid-template-columns: 80px 1fr 150px 100px 100px 120px;">
            <div>
              <img src="${sponsor.logo_url}" alt="${sponsor.name}" style="max-width: 70px; max-height: 35px; object-fit: contain; border-radius: 4px;" onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 50%22><rect fill=%22%23f5f5f5%22 width=%22100%22 height=%2250%22/><text x=%2250%22 y=%2230%22 text-anchor=%22middle%22 fill=%22%23999%22 font-size=%2212%22>No Logo</text></svg>'">
            </div>
            <div>
              <div class="article-title" onclick="editSponsor('${sponsor.id}')">${sponsor.name}</div>
              ${sponsor.url ? `<div style="font-size: 11px; color: #888;"><a href="${sponsor.url}" target="_blank">${sponsor.url.replace('https://', '').substring(0, 30)}...</a></div>` : ''}
            </div>
            <div style="font-size: 13px;">${sponsor.team_shortname}</div>
            <div><span style="font-size: 11px; padding: 3px 8px; border-radius: 10px; background: ${sponsor.tier === 'premium' ? '#fff3e0' : sponsor.tier === 'presenting' ? '#e8f5e9' : '#f5f5f5'}; color: ${sponsor.tier === 'premium' ? '#e65100' : sponsor.tier === 'presenting' ? '#2e7d32' : '#666'};">${sponsor.tier || 'standard'}</span></div>
            <div><span class="article-status ${sponsor.active ? 'published' : 'draft'}">${sponsor.active ? 'Active' : 'Inactive'}</span></div>
            <div class="article-actions">
              <button class="btn-edit" onclick="editSponsor('${sponsor.id}')">Edit</button>
              <button class="btn-delete" onclick="confirmDeleteSponsor('${sponsor.id}', '${sponsor.name.replace(/'/g, "\\'")}')">Delete</button>
            </div>
          </div>
        `).join('')}
      `;
    }
    
    function openSponsorModal(sponsor = null) {
      document.getElementById('sponsorModal').style.display = 'flex';
      document.getElementById('sponsorModalTitle').textContent = sponsor ? 'Edit Sponsor' : 'Add Sponsor';
      document.getElementById('sponsorDeleteBtn').style.display = sponsor ? 'block' : 'none';
      
      // Reset file input
      document.getElementById('sponsorLogoFile').value = '';
      document.getElementById('sponsorUploadStatus').textContent = '';
      
      // Populate team dropdown
      const teamSelect = document.getElementById('sponsorTeam');
      if (teamSelect.options.length <= 1) {
        teamSelect.innerHTML = '<option value="">Select team...</option>' + 
          SPONSOR_TEAMS.map(t => `<option value="${t}">${t}</option>`).join('');
      }
      
      if (sponsor) {
        document.getElementById('sponsorId').value = sponsor.id;
        document.getElementById('sponsorName').value = sponsor.name || '';
        document.getElementById('sponsorLogoUrl').value = sponsor.logo_url || '';
        document.getElementById('sponsorWebsite').value = sponsor.url || '';
        document.getElementById('sponsorTeam').value = sponsor.team_shortname || '';
        document.getElementById('sponsorTier').value = sponsor.tier || 'standard';
        document.getElementById('sponsorStartDate').value = sponsor.start_date || '';
        document.getElementById('sponsorEndDate').value = sponsor.end_date || '';
        document.getElementById('sponsorNotes').value = sponsor.notes || '';
        document.getElementById('sponsorActive').checked = sponsor.active !== false;
        
        // Show logo preview
        if (sponsor.logo_url) {
          document.getElementById('sponsorLogoPreview').style.display = 'block';
          document.getElementById('sponsorLogoImg').src = sponsor.logo_url;
        } else {
          document.getElementById('sponsorLogoPreview').style.display = 'none';
        }
      } else {
        document.getElementById('sponsorId').value = '';
        document.getElementById('sponsorName').value = '';
        document.getElementById('sponsorLogoUrl').value = '';
        document.getElementById('sponsorWebsite').value = '';
        document.getElementById('sponsorTeam').value = '';
        document.getElementById('sponsorTier').value = 'standard';
        document.getElementById('sponsorStartDate').value = '';
        document.getElementById('sponsorEndDate').value = '';
        document.getElementById('sponsorNotes').value = '';
        document.getElementById('sponsorActive').checked = true;
        document.getElementById('sponsorLogoPreview').style.display = 'none';
      }
    }
    
    function closeSponsorModal() {
      document.getElementById('sponsorModal').style.display = 'none';
    }
    
    function editSponsor(id) {
      const sponsor = allSponsors.find(s => s.id === id);
      if (sponsor) {
        openSponsorModal(sponsor);
      }
    }
    
    async function saveSponsor() {
      const id = document.getElementById('sponsorId').value;
      const name = document.getElementById('sponsorName').value.trim();
      const logoUrl = document.getElementById('sponsorLogoUrl').value.trim();
      const website = document.getElementById('sponsorWebsite').value.trim();
      const team = document.getElementById('sponsorTeam').value;
      const tier = document.getElementById('sponsorTier').value;
      const startDate = document.getElementById('sponsorStartDate').value || null;
      const endDate = document.getElementById('sponsorEndDate').value || null;
      const notes = document.getElementById('sponsorNotes').value.trim();
      const active = document.getElementById('sponsorActive').checked;
      
      if (!name || !logoUrl || !team) {
        showToast('Please fill in Name, Logo URL, and Team', 'error');
        return;
      }
      
      const sponsorData = {
        name,
        logo_url: logoUrl,
        url: website || null,
        team_shortname: team,
        tier,
        start_date: startDate,
        end_date: endDate,
        notes: notes || null,
        active,
        updated_at: new Date().toISOString()
      };
      
      try {
        if (id) {
          // Update existing
          const { error } = await db
            .from('sponsors')
            .update(sponsorData)
            .eq('id', id);
          
          if (error) throw error;
          showToast('Sponsor updated successfully', 'success');
        } else {
          // Create new
          const { error } = await db
            .from('sponsors')
            .insert([sponsorData]);
          
          if (error) throw error;
          showToast('Sponsor created successfully', 'success');
        }
        
        closeSponsorModal();
        loadSponsors();
        
      } catch (err) {
        console.error('Error saving sponsor:', err);
        showToast('Error saving sponsor: ' + err.message, 'error');
      }
    }
    
    function confirmDeleteSponsor(id, name) {
      if (confirm(`Are you sure you want to delete the sponsor "${name}"?`)) {
        deleteSponsorById(id);
      }
    }
    
    async function deleteSponsor() {
      const id = document.getElementById('sponsorId').value;
      if (!id) return;
      
      const sponsor = allSponsors.find(s => s.id === id);
      if (confirm(`Are you sure you want to delete the sponsor "${sponsor?.name}"?`)) {
        await deleteSponsorById(id);
        closeSponsorModal();
      }
    }
    
    async function deleteSponsorById(id) {
      try {
        const { error } = await db
          .from('sponsors')
          .delete()
          .eq('id', id);
        
        if (error) throw error;
        
        showToast('Sponsor deleted', 'success');
        loadSponsors();
        
      } catch (err) {
        console.error('Error deleting sponsor:', err);
        showToast('Error deleting sponsor', 'error');
      }
    }
    
    async function handleSponsorLogoUpload(input) {
      const file = input.files[0];
      if (!file) return;
      
      const statusEl = document.getElementById('sponsorUploadStatus');
      const previewEl = document.getElementById('sponsorLogoPreview');
      const imgEl = document.getElementById('sponsorLogoImg');
      
      // Show preview immediately
      previewEl.style.display = 'block';
      imgEl.src = URL.createObjectURL(file);
      statusEl.textContent = 'Uploading...';
      statusEl.style.color = '#1565c0';
      
      try {
        // Generate unique filename
        const ext = file.name.split('.').pop();
        const filename = `sponsor_${Date.now()}.${ext}`;
        
        // Upload to Supabase Storage
        const { data, error } = await db.storage
          .from('sponsors')
          .upload(filename, file, {
            cacheControl: '3600',
            upsert: false
          });
        
        if (error) throw error;
        
        // Get public URL
        const { data: urlData } = db.storage
          .from('sponsors')
          .getPublicUrl(filename);
        
        const publicUrl = urlData.publicUrl;
        
        // Set the URL in the input
        document.getElementById('sponsorLogoUrl').value = publicUrl;
        
        statusEl.textContent = '‚úçÔ∏è‚Äú Uploaded successfully';
        statusEl.style.color = '#2e7d32';
        
      } catch (err) {
        console.error('Upload error:', err);
        statusEl.textContent = 'Upload failed: ' + err.message;
        statusEl.style.color = '#c62828';
      }
    }
    
    function previewSponsorLogo() {
      const url = document.getElementById('sponsorLogoUrl').value;
      if (url) {
        document.getElementById('sponsorLogoPreview').style.display = 'block';
        document.getElementById('sponsorLogoImg').src = url;
        document.getElementById('sponsorUploadStatus').textContent = '';
      } else {
        document.getElementById('sponsorLogoPreview').style.display = 'none';
      }
    }
    
    // Preview logo when URL changes
    document.addEventListener('DOMContentLoaded', function() {
      const logoInput = document.getElementById('sponsorLogoUrl');
      if (logoInput) {
        logoInput.addEventListener('input', previewSponsorLogo);
      }
    });
    
    // ==================== VIDEO MANAGEMENT ====================
    let allVideos = [];
    let currentVideoFilter = 'all';
    let videoSearchTerm = '';
    let currentVideoTags = [];
    
    async function loadVideos() {
      console.log('Loading videos...');
      document.getElementById('videoListBody').innerHTML = '<div class="loading">Loading videos...</div>';
      
      try {
        const { data: videos, error } = await db
          .from('youtube_videos')
          .select('*')
          .order('pinned', { ascending: false })
          .order('sort_order', { ascending: true })
          .order('published_at', { ascending: false });
        
        if (error) {
          console.error('Supabase error:', error);
          throw error;
        }
        
        console.log('Videos loaded:', videos?.length || 0);
        allVideos = videos || [];
        renderVideoList();
        populateVideoTeamSelect();
        
      } catch (err) {
        console.error('Error loading videos:', err);
        document.getElementById('videoListBody').innerHTML = `
          <div style="padding: 40px; text-align: center; color: #c62828;">
            <div style="font-size: 24px; margin-bottom: 10px;">‚ö†Ô∏è</div>
            <p style="margin: 0 0 10px 0;"><strong>Error loading videos</strong></p>
            <p style="margin: 0; font-size: 12px; color: #666;">${err.message || 'Unknown error'}</p>
            <p style="margin: 10px 0 0 0; font-size: 12px; color: #888;">Make sure you've run the SQL to create the youtube_videos table</p>
          </div>
        `;
      }
    }
    
    function renderVideoList() {
      let filtered = [...allVideos];
      
      // Apply filter
      if (currentVideoFilter === 'pinned') {
        filtered = filtered.filter(v => v.pinned);
      } else if (currentVideoFilter === 'hidden') {
        filtered = filtered.filter(v => v.hidden);
      } else {
        // 'all' shows non-hidden by default
        filtered = filtered.filter(v => !v.hidden);
      }
      
      // Apply search
      if (videoSearchTerm) {
        const term = videoSearchTerm.toLowerCase();
        filtered = filtered.filter(v => 
          v.title?.toLowerCase().includes(term) ||
          v.description?.toLowerCase().includes(term)
        );
      }
      
      document.getElementById('videoCountDisplay').textContent = `${filtered.length} video${filtered.length !== 1 ? 's' : ''}`;
      
      if (filtered.length === 0) {
        document.getElementById('videoListBody').innerHTML = `
          <div style="padding: 60px 20px; text-align: center; color: #888;">
            <div style="font-size: 40px; margin-bottom: 15px;">üé¨</div>
            <p>${allVideos.length === 0 ? 'No videos yet. Click "Add Video" to get started.' : 'No videos match your filters.'}</p>
          </div>
        `;
        return;
      }
      
      document.getElementById('videoListBody').innerHTML = filtered.map(video => {
        const thumbnail = video.thumbnail_url || `https://img.youtube.com/vi/${video.youtube_id}/mqdefault.jpg`;
        const publishedDate = video.published_at ? new Date(video.published_at).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' }) : '--';
        const tags = video.tags || [];
        
        return `
          <div style="display: grid; grid-template-columns: 120px 1fr 100px 80px 80px 120px; padding: 12px 15px; border-bottom: 1px solid #eee; align-items: center; gap: 10px; ${video.pinned ? 'background: #fff8e1;' : ''} ${video.hidden ? 'opacity: 0.6;' : ''}">
            <div>
              <img src="${thumbnail}" style="width: 100px; height: 56px; object-fit: cover; border-radius: 4px; cursor: pointer;" onclick="window.open('https://youtube.com/watch?v=${video.youtube_id}', '_blank')" onerror="this.src='https://img.youtube.com/vi/${video.youtube_id}/default.jpg'">
            </div>
            <div>
              <div style="font-weight: 500; color: #333; cursor: pointer; margin-bottom: 4px;" onclick="editVideo('${video.id}')">${video.title || 'Untitled'}</div>
              ${tags.length > 0 ? `<div style="display: flex; gap: 4px; flex-wrap: wrap;">${tags.slice(0, 3).map(t => `<span style="font-size: 10px; background: #e3f2fd; color: #1565c0; padding: 2px 6px; border-radius: 8px;">${t}</span>`).join('')}${tags.length > 3 ? `<span style="font-size: 10px; color: #888;">+${tags.length - 3}</span>` : ''}</div>` : ''}
            </div>
            <div style="font-size: 12px; color: #666;">${publishedDate}</div>
            <div>
              <button onclick="toggleVideoPin('${video.id}', ${!video.pinned})" style="background: ${video.pinned ? '#fff3e0' : '#f5f5f5'}; border: none; padding: 6px 10px; border-radius: 4px; cursor: pointer; font-size: 12px;" title="${video.pinned ? 'Unpin' : 'Pin'}">
                ${video.pinned ? 'üìå' : '‚óã'}
              </button>
            </div>
            <div>
              <button onclick="toggleVideoHidden('${video.id}', ${!video.hidden})" style="background: ${video.hidden ? '#ffebee' : '#f5f5f5'}; border: none; padding: 6px 10px; border-radius: 4px; cursor: pointer; font-size: 12px;" title="${video.hidden ? 'Show' : 'Hide'}">
                ${video.hidden ? 'üëç¬Å¬çüó®Ô∏è' : 'üëç¬Å'}
              </button>
            </div>
            <div style="display: flex; gap: 6px;">
              <button onclick="editVideo('${video.id}')" style="background: #e3f2fd; color: #1565c0; border: none; padding: 6px 12px; border-radius: 4px; font-size: 12px; cursor: pointer;">Edit</button>
              <button onclick="confirmDeleteVideo('${video.id}', '${(video.title || '').replace(/'/g, "\\'")}')" style="background: #ffebee; color: #c62828; border: none; padding: 6px 12px; border-radius: 4px; font-size: 12px; cursor: pointer;">Delete</button>
            </div>
          </div>
        `;
      }).join('');
    }
    
    function filterVideos(filter, btn) {
      currentVideoFilter = filter;
      document.querySelectorAll('#videoPanel .filter-btn').forEach(b => {
        b.style.background = '#fff';
        b.style.color = '#333';
      });
      btn.style.background = '#f57c00';
      btn.style.color = 'white';
      renderVideoList();
    }
    
    function searchVideos(term) {
      videoSearchTerm = term;
      renderVideoList();
    }
    
    async function toggleVideoPin(id, pinned) {
      try {
        const { error } = await db
          .from('youtube_videos')
          .update({ pinned, updated_at: new Date().toISOString() })
          .eq('id', id);
        
        if (error) throw error;
        
        const video = allVideos.find(v => v.id == id);
        if (video) video.pinned = pinned;
        renderVideoList();
        showToast(pinned ? 'Video pinned' : 'Video unpinned', 'success');
        
      } catch (err) {
        console.error('Error toggling pin:', err);
        showToast('Error updating video', 'error');
      }
    }
    
    async function toggleVideoHidden(id, hidden) {
      try {
        const { error } = await db
          .from('youtube_videos')
          .update({ hidden, updated_at: new Date().toISOString() })
          .eq('id', id);
        
        if (error) throw error;
        
        const video = allVideos.find(v => v.id == id);
        if (video) video.hidden = hidden;
        renderVideoList();
        showToast(hidden ? 'Video hidden' : 'Video visible', 'success');
        
      } catch (err) {
        console.error('Error toggling hidden:', err);
        showToast('Error updating video', 'error');
      }
    }
    
    async function populateVideoTeamSelect() {
      const select = document.getElementById('videoTeamSelect');
      if (!select) return;
      
      // Clear existing options except first
      select.innerHTML = '<option value="">+ Add team tag...</option>';
      
      // Use teams from the existing allTeams array if loaded, or fetch
      let teams = allTeams;
      if (!teams || teams.length === 0) {
        try {
          const { data, error } = await db
            .from('teams')
            .select('shortname')
            .eq('level', 'High School')
            .eq('active', true)
            .order('shortname');
          
          if (!error && data) {
            const seen = new Set();
            teams = data.filter(t => {
              if (seen.has(t.shortname)) return false;
              seen.add(t.shortname);
              return true;
            });
          }
        } catch (err) {
          console.error('Error loading teams for video select:', err);
        }
      }
      
      teams.forEach(t => {
        const name = t.shortname || t.name;
        const slug = name.toLowerCase().replace(/[^a-z0-9]/g, '');
        const option = document.createElement('option');
        option.value = slug;
        option.textContent = name;
        select.appendChild(option);
      });
    }
    
    function openAddVideoModal() {
      document.getElementById('videoModalTitle').textContent = 'Add YouTube Video';
      document.getElementById('videoId').value = '';
      document.getElementById('videoYoutubeInput').value = '';
      document.getElementById('videoTitle').value = '';
      document.getElementById('videoDescription').value = '';
      document.getElementById('videoPublishedAt').value = '';
      document.getElementById('videoDuration').value = '';
      document.getElementById('videoPinned').checked = false;
      document.getElementById('videoHidden').checked = false;
      document.getElementById('videoPreviewSection').style.display = 'none';
      document.getElementById('videoDeleteBtn').style.display = 'none';
      currentVideoTags = [];
      renderVideoTags();
      document.getElementById('videoModal').classList.add('open');
    }
    
    function editVideo(id) {
      const video = allVideos.find(v => v.id == id);
      if (!video) return;
      
      document.getElementById('videoModalTitle').textContent = 'Edit Video';
      document.getElementById('videoId').value = video.id;
      document.getElementById('videoYoutubeInput').value = video.youtube_id;
      document.getElementById('videoTitle').value = video.title || '';
      document.getElementById('videoDescription').value = video.description || '';
      document.getElementById('videoPublishedAt').value = video.published_at ? video.published_at.split('T')[0] : '';
      document.getElementById('videoDuration').value = video.duration || '';
      document.getElementById('videoPinned').checked = video.pinned || false;
      document.getElementById('videoHidden').checked = video.hidden || false;
      document.getElementById('videoDeleteBtn').style.display = 'block';
      
      // Show preview
      document.getElementById('videoPreviewSection').style.display = 'block';
      document.getElementById('videoPreviewThumb').src = video.thumbnail_url || `https://img.youtube.com/vi/${video.youtube_id}/maxresdefault.jpg`;
      document.getElementById('videoPreviewTitle').textContent = video.title || '';
      document.getElementById('videoPreviewMeta').textContent = `ID: ${video.youtube_id}`;
      
      currentVideoTags = Array.isArray(video.tags) ? [...video.tags] : [];
      renderVideoTags();
      
      document.getElementById('videoModal').classList.add('open');
    }
    
    function closeVideoModal() {
      document.getElementById('videoModal').classList.remove('open');
    }
    
    function extractYouTubeId(input) {
      if (!input) return null;
      input = input.trim();
      
      // Already just an ID (11 characters, alphanumeric with - and _)
      if (/^[a-zA-Z0-9_-]{11}$/.test(input)) {
        return input;
      }
      
      // Various YouTube URL formats
      const patterns = [
        /(?:youtube\.com\/watch\?v=|youtu\.be\/|youtube\.com\/embed\/|youtube\.com\/v\/)([a-zA-Z0-9_-]{11})/,
        /youtube\.com\/shorts\/([a-zA-Z0-9_-]{11})/
      ];
      
      for (const pattern of patterns) {
        const match = input.match(pattern);
        if (match) return match[1];
      }
      
      return null;
    }
    
    async function fetchVideoDetails() {
      const input = document.getElementById('videoYoutubeInput').value;
      const youtubeId = extractYouTubeId(input);
      
      if (!youtubeId) {
        showToast('Invalid YouTube URL or ID', 'error');
        return;
      }
      
      // Set the extracted ID
      document.getElementById('videoYoutubeInput').value = youtubeId;
      
      // Show preview with thumbnail
      const thumbnail = `https://img.youtube.com/vi/${youtubeId}/maxresdefault.jpg`;
      document.getElementById('videoPreviewSection').style.display = 'block';
      document.getElementById('videoPreviewThumb').src = thumbnail;
      document.getElementById('videoPreviewThumb').onerror = function() {
        this.src = `https://img.youtube.com/vi/${youtubeId}/hqdefault.jpg`;
      };
      document.getElementById('videoPreviewTitle').textContent = 'Video ID: ' + youtubeId;
      document.getElementById('videoPreviewMeta').textContent = 'Enter title manually or it will use YouTube title when available';
      
      // Set today's date as default if empty
      if (!document.getElementById('videoPublishedAt').value) {
        document.getElementById('videoPublishedAt').value = getTodayEST();
      }
      
      showToast('Video ID extracted. Please enter title manually.', 'success');
    }
    
    function addVideoTeamTag(slug) {
      if (!slug || currentVideoTags.includes(slug)) return;
      currentVideoTags.push(slug);
      renderVideoTags();
    }
    
    function removeVideoTeamTag(slug) {
      currentVideoTags = currentVideoTags.filter(t => t !== slug);
      renderVideoTags();
    }
    
    function renderVideoTags() {
      const container = document.getElementById('videoTeamTags');
      if (currentVideoTags.length === 0) {
        container.innerHTML = '<span style="color: #999; font-size: 12px;">No teams tagged</span>';
        return;
      }
      container.innerHTML = currentVideoTags.map(tag => `
        <span style="display: inline-flex; align-items: center; gap: 4px; background: #e3f2fd; color: #1565c0; padding: 4px 10px; border-radius: 15px; font-size: 12px;">
          ${tag}
          <button onclick="removeVideoTeamTag('${tag}')" style="background: none; border: none; color: #1565c0; cursor: pointer; padding: 0; font-size: 14px; line-height: 1;">&times;</button>
        </span>
      `).join('');
    }
    
    async function saveVideo() {
      const id = document.getElementById('videoId').value;
      const youtubeInput = document.getElementById('videoYoutubeInput').value;
      const youtubeId = extractYouTubeId(youtubeInput);
      const title = document.getElementById('videoTitle').value.trim();
      const description = document.getElementById('videoDescription').value.trim();
      const publishedAt = document.getElementById('videoPublishedAt').value;
      const duration = document.getElementById('videoDuration').value.trim();
      const pinned = document.getElementById('videoPinned').checked;
      const hidden = document.getElementById('videoHidden').checked;
      
      if (!youtubeId) {
        showToast('Please enter a valid YouTube URL or ID', 'error');
        return;
      }
      
      if (!title) {
        showToast('Please enter a title', 'error');
        return;
      }
      
      const videoData = {
        youtube_id: youtubeId,
        title,
        description: description || null,
        thumbnail_url: `https://img.youtube.com/vi/${youtubeId}/maxresdefault.jpg`,
        published_at: publishedAt ? new Date(publishedAt).toISOString() : null,
        duration: duration || null,
        pinned,
        hidden,
        tags: currentVideoTags,
        updated_at: new Date().toISOString()
      };
      
      try {
        if (id) {
          // Update existing
          const { error } = await db
            .from('youtube_videos')
            .update(videoData)
            .eq('id', id);
          
          if (error) throw error;
          showToast('Video updated successfully', 'success');
        } else {
          // Insert new
          videoData.created_at = new Date().toISOString();
          const { error } = await db
            .from('youtube_videos')
            .insert([videoData]);
          
          if (error) throw error;
          showToast('Video added successfully', 'success');
        }
        
        closeVideoModal();
        loadVideos();
        
      } catch (err) {
        console.error('Error saving video:', err);
        if (err.message?.includes('duplicate')) {
          showToast('This video already exists', 'error');
        } else {
          showToast('Error saving video: ' + err.message, 'error');
        }
      }
    }
    
    function confirmDeleteVideo(id, title) {
      if (confirm(`Are you sure you want to delete "${title}"?`)) {
        deleteVideoById(id);
      }
    }
    
    async function deleteVideo() {
      const id = document.getElementById('videoId').value;
      if (!id) return;
      
      const video = allVideos.find(v => v.id == id);
      if (confirm(`Are you sure you want to delete "${video?.title}"?`)) {
        await deleteVideoById(id);
        closeVideoModal();
      }
    }
    
    async function deleteVideoById(id) {
      try {
        const { error } = await db
          .from('youtube_videos')
          .delete()
          .eq('id', id);
        
        if (error) throw error;
        
        showToast('Video deleted', 'success');
        loadVideos();
        
      } catch (err) {
        console.error('Error deleting video:', err);
        showToast('Error deleting video', 'error');
      }
    }
    
    // ===== NCAA PLAYERS MANAGEMENT =====
    let allNCAAPlayers = [];
    let ncaaSortField = 'name';
    let ncaaSortDir = 'asc';
    
    async function loadNCAAPlayers() {
      try {
        const { data, error } = await db
          .from('ncaa_players')
          .select('*')
          .order('name', { ascending: true });
        
        if (error) throw error;
        
        allNCAAPlayers = data || [];
        populateCollegesFilter();
        populateCollegesDatalist();
        filterNCAAPlayers();
        
      } catch (err) {
        console.error('Error loading NCAA players:', err);
        showToast('Error loading NCAA players', 'error');
        document.getElementById('ncaaPlayersList').innerHTML = `
          <div class="article-row header" style="grid-template-columns: 1fr 180px 180px 60px 60px 100px;">
            <div>Name</div><div>High School</div><div>College</div><div>Gender</div><div>Div</div><div>Actions</div>
          </div>
          <div style="padding: 40px; text-align: center; color: #999;">Error loading players. Make sure the table exists.</div>`;
      }
    }
    
    function populateCollegesFilter() {
      const colleges = [...new Set(allNCAAPlayers.map(p => p.college))].sort();
      const select = document.getElementById('ncaaCollegeFilter');
      select.innerHTML = '<option value="">All Colleges</option>' + 
        colleges.map(c => `<option value="${c}">${c}</option>`).join('');
    }
    
    function populateCollegesDatalist() {
      const colleges = [...new Set(allNCAAPlayers.map(p => p.college))].sort();
      const datalist = document.getElementById('collegesList');
      datalist.innerHTML = colleges.map(c => `<option value="${c}">`).join('');
    }
    
    function filterNCAAPlayers() {
      const college = document.getElementById('ncaaCollegeFilter').value;
      const gender = document.getElementById('ncaaGenderFilter').value;
      const division = document.getElementById('ncaaDivisionFilter').value;
      const activeFilter = document.getElementById('ncaaActiveFilter').value;
      const search = document.getElementById('ncaaSearchBox').value.toLowerCase();
      
      let filtered = allNCAAPlayers.filter(p => {
        if (college && p.college !== college) return false;
        if (gender && p.gender !== gender) return false;
        if (division && p.division !== division) return false;
        if (activeFilter === 'true' && p.active === false) return false;
        if (activeFilter === 'false' && p.active !== false) return false;
        if (search && !p.name.toLowerCase().includes(search) && 
            !p.high_school.toLowerCase().includes(search) && 
            !p.college.toLowerCase().includes(search)) return false;
        return true;
      });
      
      // Sort
      filtered.sort((a, b) => {
        let aVal = a[ncaaSortField];
        let bVal = b[ncaaSortField];
        if (aVal === null && bVal === null) return 0;
        if (aVal === null) return 1;
        if (bVal === null) return -1;
        if (typeof aVal === 'string') aVal = aVal.toLowerCase();
        if (typeof bVal === 'string') bVal = bVal.toLowerCase();
        if (aVal < bVal) return ncaaSortDir === 'asc' ? -1 : 1;
        if (aVal > bVal) return ncaaSortDir === 'asc' ? 1 : -1;
        return 0;
      });
      
      renderNCAAPlayers(filtered);
    }
    
    function renderNCAAPlayers(players) {
      const container = document.getElementById('ncaaPlayersList');
      const countEl = document.getElementById('ncaaCount');
      
      const activeCount = allNCAAPlayers.filter(p => p.active !== false).length;
      countEl.textContent = `${players.length} of ${allNCAAPlayers.length} players | ${activeCount} currently active`;
      
      if (players.length === 0) {
        container.innerHTML = `
          <div class="article-row header" style="grid-template-columns: 1fr 180px 180px 60px 60px 100px;">
            <div>Name</div><div>High School</div><div>College</div><div>Gender</div><div>Div</div><div>Actions</div>
          </div>
          <div style="padding: 40px; text-align: center; color: #999;">No players found</div>`;
        return;
      }
      
      container.innerHTML = `
        <div class="article-row header" style="grid-template-columns: 1fr 180px 180px 60px 60px 100px;">
          <div class="sortable" onclick="sortNCAAPlayers('name')" style="cursor: pointer;">Name ${ncaaSortField === 'name' ? (ncaaSortDir === 'asc' ? '‚Üë' : '‚Üì') : ''}</div>
          <div class="sortable" onclick="sortNCAAPlayers('high_school')" style="cursor: pointer;">High School ${ncaaSortField === 'high_school' ? (ncaaSortDir === 'asc' ? '‚Üë' : '‚Üì') : ''}</div>
          <div class="sortable" onclick="sortNCAAPlayers('college')" style="cursor: pointer;">College ${ncaaSortField === 'college' ? (ncaaSortDir === 'asc' ? '‚Üë' : '‚Üì') : ''}</div>
          <div>Gender</div>
          <div>Div</div>
          <div>Actions</div>
        </div>
        ${players.map(p => `
          <div class="article-row ${p.active === false ? '' : ''}" style="grid-template-columns: 1fr 180px 180px 60px 60px 100px; ${p.active === false ? 'opacity: 0.5;' : ''}">
            <div style="font-weight: 500;">${p.name}${p.active === false ? ' <span style="color: #999; font-size: 11px;">(inactive)</span>' : ''}</div>
            <div style="font-size: 13px; color: #666;">${p.high_school}</div>
            <div style="font-size: 13px;">${p.college}</div>
            <div>${p.gender ? `<span style="background: ${p.gender === 'Boys' ? '#e3f2fd' : '#fce4ec'}; color: ${p.gender === 'Boys' ? '#1565c0' : '#c2185b'}; padding: 2px 6px; border-radius: 10px; font-size: 11px;">${p.gender === 'Boys' ? 'B' : 'G'}</span>` : '<span style="color: #ccc;">‚Äî</span>'}</div>
            <div style="font-size: 12px; color: ${p.division === 'D1' ? '#ff6f00' : '#666'};">${p.division || '‚Äî'}</div>
            <div class="article-actions">
              <button class="btn-edit" onclick="editNCAAPlayer(${p.id})">Edit</button>
              <button class="btn-delete" onclick="confirmDeleteNCAAPlayer(${p.id})">Del</button>
            </div>
          </div>
        `).join('')}`;
    }
    
    function sortNCAAPlayers(field) {
      if (ncaaSortField === field) {
        ncaaSortDir = ncaaSortDir === 'asc' ? 'desc' : 'asc';
      } else {
        ncaaSortField = field;
        ncaaSortDir = 'asc';
      }
      filterNCAAPlayers();
    }
    
    function openNCAAPlayerModal(player = null) {
      document.getElementById('ncaaPlayerId').value = player?.id || '';
      document.getElementById('ncaaPlayerName').value = player?.name || '';
      document.getElementById('ncaaPlayerHighSchool').value = player?.high_school || '';
      document.getElementById('ncaaPlayerCollege').value = player?.college || '';
      document.getElementById('ncaaPlayerGender').value = player?.gender || '';
      document.getElementById('ncaaPlayerDivision').value = player?.division || '';
      document.getElementById('ncaaPlayerGradYear').value = player?.grad_year || '';
      document.getElementById('ncaaPlayerPosition').value = player?.position || '';
      document.getElementById('ncaaPlayerNotes').value = player?.notes || '';
      document.getElementById('ncaaPlayerActive').checked = player?.active !== false;
      
      document.getElementById('ncaaPlayerModalTitle').textContent = player ? 'Edit NCAA Player' : 'Add NCAA Player';
      document.getElementById('ncaaPlayerDeleteBtn').style.display = player ? 'block' : 'none';
      
      document.getElementById('ncaaPlayerModal').style.display = 'flex';
    }
    
    function closeNCAAPlayerModal() {
      document.getElementById('ncaaPlayerModal').style.display = 'none';
    }
    
    function editNCAAPlayer(id) {
      const player = allNCAAPlayers.find(p => p.id === id);
      if (player) {
        openNCAAPlayerModal(player);
      }
    }
    
    async function saveNCAAPlayer() {
      const id = document.getElementById('ncaaPlayerId').value;
      const name = document.getElementById('ncaaPlayerName').value.trim();
      const high_school = document.getElementById('ncaaPlayerHighSchool').value.trim();
      const college = document.getElementById('ncaaPlayerCollege').value.trim();
      const gender = document.getElementById('ncaaPlayerGender').value || null;
      const division = document.getElementById('ncaaPlayerDivision').value || null;
      const grad_year = document.getElementById('ncaaPlayerGradYear').value ? parseInt(document.getElementById('ncaaPlayerGradYear').value) : null;
      const position = document.getElementById('ncaaPlayerPosition').value.trim() || null;
      const notes = document.getElementById('ncaaPlayerNotes').value.trim() || null;
      const active = document.getElementById('ncaaPlayerActive').checked;
      
      if (!name || !high_school || !college) {
        showToast('Please enter name, high school, and college', 'error');
        return;
      }
      
      try {
        const data = { name, high_school, college, gender, division, grad_year, position, notes, active, updated_at: new Date().toISOString() };
        
        if (id) {
          const { error } = await db.from('ncaa_players').update(data).eq('id', id);
          if (error) throw error;
          showToast('Player updated', 'success');
        } else {
          const { error } = await db.from('ncaa_players').insert(data);
          if (error) throw error;
          showToast('Player added', 'success');
        }
        
        closeNCAAPlayerModal();
        allNCAAPlayers = [];
        loadNCAAPlayers();
        
      } catch (err) {
        console.error('Error saving player:', err);
        showToast('Error saving player: ' + err.message, 'error');
      }
    }
    
    function confirmDeleteNCAAPlayer(id) {
      const player = allNCAAPlayers.find(p => p.id === id);
      if (player && confirm(`Delete ${player.name} (${player.college})?`)) {
        deleteNCAAPlayerById(id);
      }
    }
    
    async function deleteNCAAPlayer() {
      const id = document.getElementById('ncaaPlayerId').value;
      if (id && confirm('Are you sure you want to delete this player?')) {
        await deleteNCAAPlayerById(id);
        closeNCAAPlayerModal();
      }
    }
    
    async function deleteNCAAPlayerById(id) {
      try {
        const { error } = await db.from('ncaa_players').delete().eq('id', id);
        if (error) throw error;
        
        showToast('Player deleted', 'success');
        allNCAAPlayers = [];
        loadNCAAPlayers();
        
      } catch (err) {
        console.error('Error deleting player:', err);
        showToast('Error deleting player', 'error');
      }
    }
    
    function exportNCAAPlayers() {
      const college = document.getElementById('ncaaCollegeFilter').value;
      const gender = document.getElementById('ncaaGenderFilter').value;
      const activeFilter = document.getElementById('ncaaActiveFilter').value;
      
      let filtered = allNCAAPlayers;
      if (college) filtered = filtered.filter(p => p.college === college);
      if (gender) filtered = filtered.filter(p => p.gender === gender);
      if (activeFilter === 'true') filtered = filtered.filter(p => p.active !== false);
      if (activeFilter === 'false') filtered = filtered.filter(p => p.active === false);
      
      const csv = [
        'Name,High School,College,Gender,Division,Grad Year,Position,Active,Notes',
        ...filtered.map(p => 
          `"${p.name}","${p.high_school}","${p.college}",${p.gender || ''},${p.division || ''},${p.grad_year || ''},${p.position || ''},${p.active !== false ? 'Yes' : 'No'},"${(p.notes || '').replace(/"/g, '""')}"`
        )
      ].join('\n');
      
      const blob = new Blob([csv], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `603-in-ncaa${college ? '-' + college.toLowerCase().replace(/\s+/g, '-') : ''}.csv`;
      a.click();
      URL.revokeObjectURL(url);
      
      showToast(`Exported ${filtered.length} players`, 'success');
    }
    
    async function importNCAAPlayers(input) {
      const file = input.files[0];
      if (!file) return;
      
      try {
        const text = await file.text();
        const rows = parseCSV(text);
        
        if (rows.length < 2) {
          showToast('CSV file is empty or invalid', 'error');
          return;
        }
        
        // Expected headers: Name,High School,College,Gender,Division,Grad Year,Position,Active,Notes
        const headers = rows[0].map(h => h.toLowerCase().trim().replace(/[_-]/g, ' '));
        const data = rows.slice(1);
        
        const nameIdx = headers.findIndex(h => h === 'name');
        const hsIdx = headers.findIndex(h => h.includes('high school') || h === 'hs' || h === 'school');
        const collegeIdx = headers.findIndex(h => h === 'college');
        const genderIdx = headers.findIndex(h => h === 'gender');
        const divisionIdx = headers.findIndex(h => h === 'division' || h === 'div');
        const gradYearIdx = headers.findIndex(h => h.includes('grad') || h.includes('year') || h === 'class');
        const positionIdx = headers.findIndex(h => h === 'position' || h === 'pos');
        const activeIdx = headers.findIndex(h => h === 'active');
        const notesIdx = headers.findIndex(h => h === 'notes');
        
        if (nameIdx === -1 || hsIdx === -1 || collegeIdx === -1) {
          showToast('CSV must have Name, High School, and College columns', 'error');
          return;
        }
        
        const records = data.filter(row => row.length > 1 && row[nameIdx]).map(row => ({
          name: row[nameIdx]?.trim() || '',
          high_school: row[hsIdx]?.trim() || '',
          college: row[collegeIdx]?.trim() || '',
          gender: row[genderIdx]?.trim() || null,
          division: row[divisionIdx]?.trim() || null,
          grad_year: row[gradYearIdx] ? parseInt(row[gradYearIdx]) : null,
          position: row[positionIdx]?.trim() || null,
          active: activeIdx === -1 ? true : (row[activeIdx]?.toLowerCase() !== 'no' && row[activeIdx]?.toLowerCase() !== 'false'),
          notes: row[notesIdx]?.trim() || null
        })).filter(r => r.name && r.high_school && r.college);
        
        if (records.length === 0) {
          showToast('No valid records found in CSV', 'error');
          return;
        }
        
        if (!confirm(`Import ${records.length} players? This will add new records.`)) {
          input.value = '';
          return;
        }
        
        const { error } = await db.from('ncaa_players').insert(records);
        
        if (error) throw error;
        
        showToast(`Imported ${records.length} players`, 'success');
        input.value = '';
        allNCAAPlayers = [];
        loadNCAAPlayers();
        
      } catch (err) {
        console.error('Import error:', err);
        showToast('Error importing: ' + err.message, 'error');
        input.value = '';
      }
    }
    
    // ===== CHAMPIONSHIP HISTORY MANAGEMENT =====
    let allChampionships = [];
    let champSortField = 'year';
    let champSortDir = 'desc';
    
    async function loadChampionships() {
      try {
        const { data, error } = await db
          .from('championship_history')
          .select('*')
          .order('year', { ascending: false });
        
        if (error) throw error;
        
        allChampionships = data || [];
        populateDivisionFilter();
        filterChampionships();
        
      } catch (err) {
        console.error('Error loading championships:', err);
        showToast('Error loading championships', 'error');
        document.getElementById('championshipList').innerHTML = `
          <div class="article-row header" style="grid-template-columns: 60px 100px 150px 1fr 1fr 80px 100px;">
            <div>Year</div><div>Gender</div><div>Division</div><div>Champion</div><div>Runner-Up</div><div>Score</div><div>Actions</div>
          </div>
          <div style="padding: 40px; text-align: center; color: #999;">Error loading championships. Make sure the table exists.</div>`;
      }
    }
    
    function populateDivisionFilter() {
      const divisions = [...new Set(allChampionships.map(c => c.division))].sort();
      const select = document.getElementById('champDivisionFilter');
      select.innerHTML = '<option value="">All Divisions</option>' + 
        divisions.map(d => `<option value="${d}">${d}</option>`).join('');
    }
    
    function filterChampionships() {
      const gender = document.getElementById('champGenderFilter').value;
      const division = document.getElementById('champDivisionFilter').value;
      const year = document.getElementById('champYearFilter').value;
      const search = document.getElementById('champSearchBox').value.toLowerCase();
      
      let filtered = allChampionships.filter(c => {
        if (gender && c.gender !== gender) return false;
        if (division && c.division !== division) return false;
        if (year && c.year !== parseInt(year)) return false;
        if (search && !c.champion.toLowerCase().includes(search) && !c.runner_up.toLowerCase().includes(search)) return false;
        return true;
      });
      
      // Sort
      filtered.sort((a, b) => {
        let aVal = a[champSortField];
        let bVal = b[champSortField];
        if (typeof aVal === 'string') aVal = aVal.toLowerCase();
        if (typeof bVal === 'string') bVal = bVal.toLowerCase();
        if (aVal < bVal) return champSortDir === 'asc' ? -1 : 1;
        if (aVal > bVal) return champSortDir === 'asc' ? 1 : -1;
        return 0;
      });
      
      renderChampionships(filtered);
    }
    
    function sortChampionships(field) {
      if (champSortField === field) {
        champSortDir = champSortDir === 'asc' ? 'desc' : 'asc';
      } else {
        champSortField = field;
        champSortDir = 'desc';
      }
      filterChampionships();
    }
    
    function renderChampionships(championships) {
      const container = document.getElementById('championshipList');
      const countEl = document.getElementById('champCount');
      
      countEl.textContent = `${championships.length} of ${allChampionships.length} championships`;
      
      if (championships.length === 0) {
        container.innerHTML = `
          <div class="article-row header" style="grid-template-columns: 60px 100px 150px 1fr 1fr 80px 100px;">
            <div class="sortable" onclick="sortChampionships('year')" style="cursor: pointer;">Year ‚Üï</div>
            <div>Gender</div><div>Division</div><div>Champion</div><div>Runner-Up</div><div>Score</div><div>Actions</div>
          </div>
          <div style="padding: 40px; text-align: center; color: #999;">No championships found</div>`;
        return;
      }
      
      container.innerHTML = `
        <div class="article-row header" style="grid-template-columns: 60px 100px 150px 1fr 1fr 80px 100px;">
          <div class="sortable" onclick="sortChampionships('year')" style="cursor: pointer;">Year ${champSortField === 'year' ? (champSortDir === 'asc' ? '‚Üë' : '‚Üì') : '‚Üï'}</div>
          <div>Gender</div>
          <div>Division</div>
          <div class="sortable" onclick="sortChampionships('champion')" style="cursor: pointer;">Champion ${champSortField === 'champion' ? (champSortDir === 'asc' ? '‚Üë' : '‚Üì') : ''}</div>
          <div>Runner-Up</div>
          <div>Score</div>
          <div>Actions</div>
        </div>
        ${championships.map(c => `
          <div class="article-row" style="grid-template-columns: 60px 100px 150px 1fr 1fr 80px 100px;">
            <div style="font-weight: 600;">${c.year}</div>
            <div><span style="background: ${c.gender === 'Boys' ? '#e3f2fd' : '#fce4ec'}; color: ${c.gender === 'Boys' ? '#1565c0' : '#c2185b'}; padding: 2px 8px; border-radius: 10px; font-size: 11px;">${c.gender}</span></div>
            <div style="font-size: 12px;">${c.division}</div>
            <div style="font-weight: 500; color: #2e7d32;">üèÜ ${c.champion}</div>
            <div style="color: #666;">${c.runner_up}</div>
            <div style="font-size: 13px;">${c.champion_score || '?'}-${c.runner_up_score || '?'}${c.overtime ? ' OT' : ''}</div>
            <div class="article-actions">
              <button class="btn-edit" onclick="editChampionship(${c.id})">Edit</button>
              <button class="btn-delete" onclick="confirmDeleteChampionship(${c.id})">Del</button>
            </div>
          </div>
        `).join('')}`;
    }
    
    function openChampionshipModal(championship = null) {
      document.getElementById('championshipId').value = championship?.id || '';
      document.getElementById('champYear').value = championship?.year || new Date().getFullYear();
      document.getElementById('champGender').value = championship?.gender || 'Boys';
      document.getElementById('champDivision').value = championship?.division || 'Division I';
      document.getElementById('champChampion').value = championship?.champion || '';
      document.getElementById('champRunnerUp').value = championship?.runner_up || '';
      document.getElementById('champChampionScore').value = championship?.champion_score || '';
      document.getElementById('champRunnerUpScore').value = championship?.runner_up_score || '';
      document.getElementById('champOvertime').value = championship?.overtime ? 'true' : 'false';
      document.getElementById('champNotes').value = championship?.notes || '';
      
      document.getElementById('championshipModalTitle').textContent = championship ? 'Edit Championship' : 'Add Championship';
      document.getElementById('championshipDeleteBtn').style.display = championship ? 'block' : 'none';
      
      document.getElementById('championshipModal').style.display = 'flex';
    }
    
    function closeChampionshipModal() {
      document.getElementById('championshipModal').style.display = 'none';
    }
    
    function editChampionship(id) {
      const championship = allChampionships.find(c => c.id === id);
      if (championship) {
        openChampionshipModal(championship);
      }
    }
    
    async function saveChampionship() {
      const id = document.getElementById('championshipId').value;
      const year = parseInt(document.getElementById('champYear').value);
      const gender = document.getElementById('champGender').value;
      const division = document.getElementById('champDivision').value;
      const champion = document.getElementById('champChampion').value.trim();
      const runner_up = document.getElementById('champRunnerUp').value.trim();
      const champion_score = document.getElementById('champChampionScore').value ? parseInt(document.getElementById('champChampionScore').value) : null;
      const runner_up_score = document.getElementById('champRunnerUpScore').value ? parseInt(document.getElementById('champRunnerUpScore').value) : null;
      const overtime = document.getElementById('champOvertime').value === 'true';
      const notes = document.getElementById('champNotes').value.trim() || null;
      
      if (!year || !gender || !division || !champion || !runner_up) {
        showToast('Please fill in all required fields', 'error');
        return;
      }
      
      try {
        const data = { year, gender, division, champion, runner_up, champion_score, runner_up_score, overtime, notes, updated_at: new Date().toISOString() };
        
        if (id) {
          const { error } = await db.from('championship_history').update(data).eq('id', id);
          if (error) throw error;
          showToast('Championship updated', 'success');
        } else {
          const { error } = await db.from('championship_history').insert(data);
          if (error) throw error;
          showToast('Championship added', 'success');
        }
        
        closeChampionshipModal();
        allChampionships = [];
        loadChampionships();
        
      } catch (err) {
        console.error('Error saving championship:', err);
        showToast('Error saving championship: ' + err.message, 'error');
      }
    }
    
    function confirmDeleteChampionship(id) {
      const championship = allChampionships.find(c => c.id === id);
      if (championship && confirm(`Delete ${championship.year} ${championship.gender} ${championship.division} championship?\n\n${championship.champion} vs ${championship.runner_up}`)) {
        deleteChampionshipById(id);
      }
    }
    
    async function deleteChampionship() {
      const id = document.getElementById('championshipId').value;
      if (id && confirm('Are you sure you want to delete this championship?')) {
        await deleteChampionshipById(id);
        closeChampionshipModal();
      }
    }
    
    async function deleteChampionshipById(id) {
      try {
        const { error } = await db.from('championship_history').delete().eq('id', id);
        if (error) throw error;
        
        showToast('Championship deleted', 'success');
        allChampionships = [];
        loadChampionships();
        
      } catch (err) {
        console.error('Error deleting championship:', err);
        showToast('Error deleting championship', 'error');
      }
    }
    
    function exportChampionships() {
      const gender = document.getElementById('champGenderFilter').value;
      const division = document.getElementById('champDivisionFilter').value;
      
      let filtered = allChampionships;
      if (gender) filtered = filtered.filter(c => c.gender === gender);
      if (division) filtered = filtered.filter(c => c.division === division);
      
      const csv = [
        'Year,Gender,Division,Champion,Runner-Up,Champion Score,Runner-Up Score,Overtime,Notes',
        ...filtered.map(c => 
          `${c.year},${c.gender},"${c.division}","${c.champion}","${c.runner_up}",${c.champion_score || ''},${c.runner_up_score || ''},${c.overtime ? 'Yes' : 'No'},"${(c.notes || '').replace(/"/g, '""')}"`
        )
      ].join('\n');
      
      const blob = new Blob([csv], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `championships${gender ? '-' + gender.toLowerCase() : ''}${division ? '-' + division.replace(/\s+/g, '-').toLowerCase() : ''}.csv`;
      a.click();
      URL.revokeObjectURL(url);
      
      showToast(`Exported ${filtered.length} championships`, 'success');
    }
    
    async function importChampionships(input) {
      const file = input.files[0];
      if (!file) return;
      
      try {
        const text = await file.text();
        const rows = parseCSV(text);
        
        if (rows.length < 2) {
          showToast('CSV file is empty or invalid', 'error');
          return;
        }
        
        // Expected headers: Year,Gender,Division,Champion,Runner-Up,Champion Score,Runner-Up Score,Overtime,Notes
        const headers = rows[0].map(h => h.toLowerCase().trim());
        const data = rows.slice(1);
        
        const yearIdx = headers.findIndex(h => h.includes('year'));
        const genderIdx = headers.findIndex(h => h.includes('gender'));
        const divisionIdx = headers.findIndex(h => h.includes('division'));
        const championIdx = headers.findIndex(h => h === 'champion');
        const runnerUpIdx = headers.findIndex(h => h.includes('runner'));
        const champScoreIdx = headers.findIndex(h => h.includes('champion') && h.includes('score'));
        const runnerScoreIdx = headers.findIndex(h => h.includes('runner') && h.includes('score'));
        const otIdx = headers.findIndex(h => h.includes('overtime') || h === 'ot');
        const notesIdx = headers.findIndex(h => h.includes('notes'));
        
        if (yearIdx === -1 || championIdx === -1 || runnerUpIdx === -1) {
          showToast('CSV must have Year, Champion, and Runner-Up columns', 'error');
          return;
        }
        
        const records = data.filter(row => row.length > 1 && row[yearIdx]).map(row => ({
          year: parseInt(row[yearIdx]) || null,
          gender: row[genderIdx] || 'Boys',
          division: row[divisionIdx] || 'Division I',
          champion: row[championIdx]?.trim() || '',
          runner_up: row[runnerUpIdx]?.trim() || '',
          champion_score: row[champScoreIdx] ? parseInt(row[champScoreIdx]) : null,
          runner_up_score: row[runnerScoreIdx] ? parseInt(row[runnerScoreIdx]) : null,
          overtime: row[otIdx]?.toLowerCase() === 'yes' || row[otIdx]?.toLowerCase() === 'true',
          notes: row[notesIdx]?.trim() || null
        })).filter(r => r.year && r.champion && r.runner_up);
        
        if (records.length === 0) {
          showToast('No valid records found in CSV', 'error');
          return;
        }
        
        if (!confirm(`Import ${records.length} championships? This will add new records (duplicates by year/gender/division will be skipped).`)) {
          input.value = '';
          return;
        }
        
        const { data: inserted, error } = await db.from('championship_history').upsert(records, { 
          onConflict: 'gender,year,division',
          ignoreDuplicates: true 
        });
        
        if (error) throw error;
        
        showToast(`Imported ${records.length} championships`, 'success');
        input.value = '';
        allChampionships = [];
        loadChampionships();
        
      } catch (err) {
        console.error('Import error:', err);
        showToast('Error importing: ' + err.message, 'error');
        input.value = '';
      }
    }
    
    // ===== 1K SCORERS MANAGEMENT =====
    let allScorers1K = [];
    let scorer1kSortField = 'points';
    let scorer1kSortDir = 'desc';
    
    async function loadScorers1K() {
      try {
        const { data, error } = await db
          .from('scorers_1k')
          .select('*')
          .order('points', { ascending: false, nullsFirst: false });
        
        if (error) throw error;
        
        allScorers1K = data || [];
        populateSchoolsFilter();
        populateSchoolsDatalist();
        filterScorers1K();
        
      } catch (err) {
        console.error('Error loading 1K scorers:', err);
        showToast('Error loading 1K scorers', 'error');
        document.getElementById('scorers1kList').innerHTML = `
          <div class="article-row header" style="grid-template-columns: 1fr 180px 80px 80px 80px 100px;">
            <div>Name</div><div>School</div><div>Gender</div><div>Points</div><div>Class</div><div>Actions</div>
          </div>
          <div style="padding: 40px; text-align: center; color: #999;">Error loading scorers. Make sure the table exists.</div>`;
      }
    }
    
    function populateSchoolsFilter() {
      const schools = [...new Set(allScorers1K.map(s => s.school))].sort();
      const select = document.getElementById('scorer1kSchoolFilter');
      select.innerHTML = '<option value="">All Schools</option>' + 
        schools.map(s => `<option value="${s}">${s}</option>`).join('');
    }
    
    function populateSchoolsDatalist() {
      const schools = [...new Set(allScorers1K.map(s => s.school))].sort();
      const datalist = document.getElementById('schoolsList');
      datalist.innerHTML = schools.map(s => `<option value="${s}">`).join('');
    }
    
    function filterScorers1K() {
      const school = document.getElementById('scorer1kSchoolFilter').value;
      const gender = document.getElementById('scorer1kGenderFilter').value;
      const pointsFilter = document.getElementById('scorer1kPointsFilter').value;
      const search = document.getElementById('scorer1kSearchBox').value.toLowerCase();
      
      let filtered = allScorers1K.filter(s => {
        if (school && s.school !== school) return false;
        if (gender && s.gender !== gender) return false;
        if (pointsFilter === '2000' && (!s.points || s.points < 2000)) return false;
        if (pointsFilter === '1500' && (!s.points || s.points < 1500)) return false;
        if (pointsFilter === 'known' && !s.points) return false;
        if (search && !s.name.toLowerCase().includes(search) && !s.school.toLowerCase().includes(search)) return false;
        return true;
      });
      
      // Sort
      filtered.sort((a, b) => {
        let aVal = a[scorer1kSortField];
        let bVal = b[scorer1kSortField];
        // Handle nulls
        if (aVal === null && bVal === null) return 0;
        if (aVal === null) return 1;
        if (bVal === null) return -1;
        if (typeof aVal === 'string') aVal = aVal.toLowerCase();
        if (typeof bVal === 'string') bVal = bVal.toLowerCase();
        if (aVal < bVal) return scorer1kSortDir === 'asc' ? -1 : 1;
        if (aVal > bVal) return scorer1kSortDir === 'asc' ? 1 : -1;
        return 0;
      });
      
      renderScorers1K(filtered);
    }
    
    function renderScorers1K(scorers) {
      const container = document.getElementById('scorers1kList');
      const countEl = document.getElementById('scorer1kCount');
      
      const with2k = allScorers1K.filter(s => s.points && s.points >= 2000).length;
      countEl.textContent = `${scorers.length} of ${allScorers1K.length} scorers | ${with2k} in 2K Club`;
      
      if (scorers.length === 0) {
        container.innerHTML = `
          <div class="article-row header" style="grid-template-columns: 1fr 180px 80px 80px 80px 100px;">
            <div>Name</div><div>School</div><div>Gender</div><div>Points</div><div>Class</div><div>Actions</div>
          </div>
          <div style="padding: 40px; text-align: center; color: #999;">No scorers found</div>`;
        return;
      }
      
      container.innerHTML = `
        <div class="article-row header" style="grid-template-columns: 1fr 180px 80px 80px 80px 100px;">
          <div class="sortable" onclick="sortScorers1K('name')" style="cursor: pointer;">Name ${scorer1kSortField === 'name' ? (scorer1kSortDir === 'asc' ? '‚Üë' : '‚Üì') : ''}</div>
          <div class="sortable" onclick="sortScorers1K('school')" style="cursor: pointer;">School ${scorer1kSortField === 'school' ? (scorer1kSortDir === 'asc' ? '‚Üë' : '‚Üì') : ''}</div>
          <div>Gender</div>
          <div class="sortable" onclick="sortScorers1K('points')" style="cursor: pointer;">Points ${scorer1kSortField === 'points' ? (scorer1kSortDir === 'asc' ? '‚Üë' : '‚Üì') : '‚Üï'}</div>
          <div class="sortable" onclick="sortScorers1K('grad_year')" style="cursor: pointer;">Class ${scorer1kSortField === 'grad_year' ? (scorer1kSortDir === 'asc' ? '‚Üë' : '‚Üì') : ''}</div>
          <div>Actions</div>
        </div>
        ${scorers.map(s => `
          <div class="article-row ${s.points && s.points >= 2000 ? 'pinned' : ''}" style="grid-template-columns: 1fr 180px 80px 80px 80px 100px;">
            <div style="font-weight: 500;">${s.points && s.points >= 2000 ? '‚≠ê ' : ''}${s.name}${s.verified ? ' ‚úì' : ''}</div>
            <div style="font-size: 13px; color: #666;">${s.school}</div>
            <div>${s.gender ? `<span style="background: ${s.gender === 'Boys' ? '#e3f2fd' : '#fce4ec'}; color: ${s.gender === 'Boys' ? '#1565c0' : '#c2185b'}; padding: 2px 6px; border-radius: 10px; font-size: 11px;">${s.gender === 'Boys' ? 'B' : 'G'}</span>` : '<span style="color: #ccc;">‚Äî</span>'}</div>
            <div style="font-weight: 600; color: ${s.points && s.points >= 2000 ? '#ff6f00' : s.points ? '#2e7d32' : '#999'};">${s.points ? s.points.toLocaleString() : '1K+'}</div>
            <div style="font-size: 13px;">${s.grad_year ? "'" + String(s.grad_year).slice(-2) : '‚Äî'}</div>
            <div class="article-actions">
              <button class="btn-edit" onclick="editScorer1K(${s.id})">Edit</button>
              <button class="btn-delete" onclick="confirmDeleteScorer1K(${s.id})">Del</button>
            </div>
          </div>
        `).join('')}`;
    }
    
    function sortScorers1K(field) {
      if (scorer1kSortField === field) {
        scorer1kSortDir = scorer1kSortDir === 'asc' ? 'desc' : 'asc';
      } else {
        scorer1kSortField = field;
        scorer1kSortDir = field === 'points' ? 'desc' : 'asc';
      }
      filterScorers1K();
    }
    
    function openScorer1KModal(scorer = null) {
      document.getElementById('scorer1kId').value = scorer?.id || '';
      document.getElementById('scorer1kName').value = scorer?.name || '';
      document.getElementById('scorer1kSchool').value = scorer?.school || '';
      document.getElementById('scorer1kGender').value = scorer?.gender || '';
      document.getElementById('scorer1kPoints').value = scorer?.points || '';
      document.getElementById('scorer1kGradYear').value = scorer?.grad_year || '';
      document.getElementById('scorer1kNotes').value = scorer?.notes || '';
      document.getElementById('scorer1kVerified').checked = scorer?.verified || false;
      
      document.getElementById('scorer1kModalTitle').textContent = scorer ? 'Edit 1K Scorer' : 'Add 1K Scorer';
      document.getElementById('scorer1kDeleteBtn').style.display = scorer ? 'block' : 'none';
      
      document.getElementById('scorer1kModal').style.display = 'flex';
    }
    
    function closeScorer1KModal() {
      document.getElementById('scorer1kModal').style.display = 'none';
    }
    
    function editScorer1K(id) {
      const scorer = allScorers1K.find(s => s.id === id);
      if (scorer) {
        openScorer1KModal(scorer);
      }
    }
    
    async function saveScorer1K() {
      const id = document.getElementById('scorer1kId').value;
      const name = document.getElementById('scorer1kName').value.trim();
      const school = document.getElementById('scorer1kSchool').value.trim();
      const gender = document.getElementById('scorer1kGender').value || null;
      const points = document.getElementById('scorer1kPoints').value ? parseInt(document.getElementById('scorer1kPoints').value) : null;
      const grad_year = document.getElementById('scorer1kGradYear').value ? parseInt(document.getElementById('scorer1kGradYear').value) : null;
      const notes = document.getElementById('scorer1kNotes').value.trim() || null;
      const verified = document.getElementById('scorer1kVerified').checked;
      
      if (!name || !school) {
        showToast('Please enter name and school', 'error');
        return;
      }
      
      try {
        const data = { name, school, gender, points, grad_year, notes, verified, updated_at: new Date().toISOString() };
        
        if (id) {
          const { error } = await db.from('scorers_1k').update(data).eq('id', id);
          if (error) throw error;
          showToast('Scorer updated', 'success');
        } else {
          const { error } = await db.from('scorers_1k').insert(data);
          if (error) throw error;
          showToast('Scorer added', 'success');
        }
        
        closeScorer1KModal();
        allScorers1K = [];
        loadScorers1K();
        
      } catch (err) {
        console.error('Error saving scorer:', err);
        showToast('Error saving scorer: ' + err.message, 'error');
      }
    }
    
    function confirmDeleteScorer1K(id) {
      const scorer = allScorers1K.find(s => s.id === id);
      if (scorer && confirm(`Delete ${scorer.name} (${scorer.school})?`)) {
        deleteScorer1KById(id);
      }
    }
    
    async function deleteScorer1K() {
      const id = document.getElementById('scorer1kId').value;
      if (id && confirm('Are you sure you want to delete this scorer?')) {
        await deleteScorer1KById(id);
        closeScorer1KModal();
      }
    }
    
    async function deleteScorer1KById(id) {
      try {
        const { error } = await db.from('scorers_1k').delete().eq('id', id);
        if (error) throw error;
        
        showToast('Scorer deleted', 'success');
        allScorers1K = [];
        loadScorers1K();
        
      } catch (err) {
        console.error('Error deleting scorer:', err);
        showToast('Error deleting scorer', 'error');
      }
    }
    
    function exportScorers1K() {
      const school = document.getElementById('scorer1kSchoolFilter').value;
      const gender = document.getElementById('scorer1kGenderFilter').value;
      
      let filtered = allScorers1K;
      if (school) filtered = filtered.filter(s => s.school === school);
      if (gender) filtered = filtered.filter(s => s.gender === gender);
      
      const csv = [
        'Name,School,Gender,Points,Grad Year,Notes,Verified',
        ...filtered.map(s => 
          `"${s.name}","${s.school}",${s.gender || ''},${s.points || ''},${s.grad_year || ''},"${(s.notes || '').replace(/"/g, '""')}",${s.verified ? 'Yes' : 'No'}`
        )
      ].join('\n');
      
      const blob = new Blob([csv], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `1k-scorers${school ? '-' + school.toLowerCase().replace(/\s+/g, '-') : ''}.csv`;
      a.click();
      URL.revokeObjectURL(url);
      
      showToast(`Exported ${filtered.length} scorers`, 'success');
    }
    
    async function importScorers1K(input) {
      const file = input.files[0];
      if (!file) return;
      
      try {
        const text = await file.text();
        const rows = parseCSV(text);
        
        if (rows.length < 2) {
          showToast('CSV file is empty or invalid', 'error');
          return;
        }
        
        // Expected headers: Name,School,Gender,Points,Grad Year,Notes,Verified
        const headers = rows[0].map(h => h.toLowerCase().trim());
        const data = rows.slice(1);
        
        const nameIdx = headers.findIndex(h => h === 'name');
        const schoolIdx = headers.findIndex(h => h === 'school');
        const genderIdx = headers.findIndex(h => h === 'gender');
        const pointsIdx = headers.findIndex(h => h === 'points');
        const gradYearIdx = headers.findIndex(h => h.includes('grad') || h.includes('year') || h === 'class');
        const notesIdx = headers.findIndex(h => h === 'notes');
        const verifiedIdx = headers.findIndex(h => h === 'verified');
        
        if (nameIdx === -1 || schoolIdx === -1) {
          showToast('CSV must have Name and School columns', 'error');
          return;
        }
        
        const records = data.filter(row => row.length > 1 && row[nameIdx]).map(row => ({
          name: row[nameIdx]?.trim() || '',
          school: row[schoolIdx]?.trim() || '',
          gender: row[genderIdx]?.trim() || null,
          points: row[pointsIdx] ? parseInt(row[pointsIdx]) : null,
          grad_year: row[gradYearIdx] ? parseInt(row[gradYearIdx]) : null,
          notes: row[notesIdx]?.trim() || null,
          verified: row[verifiedIdx]?.toLowerCase() === 'yes' || row[verifiedIdx]?.toLowerCase() === 'true'
        })).filter(r => r.name && r.school);
        
        if (records.length === 0) {
          showToast('No valid records found in CSV', 'error');
          return;
        }
        
        if (!confirm(`Import ${records.length} scorers? This will add new records.`)) {
          input.value = '';
          return;
        }
        
        const { error } = await db.from('scorers_1k').insert(records);
        
        if (error) throw error;
        
        showToast(`Imported ${records.length} scorers`, 'success');
        input.value = '';
        allScorers1K = [];
        loadScorers1K();
        
      } catch (err) {
        console.error('Import error:', err);
        showToast('Error importing: ' + err.message, 'error');
        input.value = '';
      }
    }
    
    // ===== SITE SETTINGS =====
    let siteSettingsLoaded = false;
    
    async function loadSiteSettings() {
      if (siteSettingsLoaded) return;
      
      try {
        const { data, error } = await db
          .from('site_settings')
          .select('*')
          .eq('key', 'ticker_settings')
          .single();
        
        if (data && data.value) {
          const settings = data.value;
          
          // Set mode
          if (settings.mode === 'manual') {
            document.getElementById('tickerModeManual').checked = true;
            document.getElementById('tickerManualOptions').style.display = 'block';
          } else {
            document.getElementById('tickerModeAuto').checked = true;
            document.getElementById('tickerManualOptions').style.display = 'none';
          }
          
          // Set checkboxes
          document.getElementById('tickerShowYesterday').checked = settings.showYesterday !== false;
          document.getElementById('tickerShowToday').checked = settings.showToday !== false;
          document.getElementById('tickerShowTomorrow').checked = settings.showTomorrow === true;
        }
        
        siteSettingsLoaded = true;
      } catch (err) {
        console.log('No existing ticker settings, using defaults');
        siteSettingsLoaded = true;
      }
    }
    
    function updateTickerMode() {
      const isManual = document.getElementById('tickerModeManual').checked;
      document.getElementById('tickerManualOptions').style.display = isManual ? 'block' : 'none';
      
      // If switching to auto, reset to defaults
      if (!isManual) {
        document.getElementById('tickerShowYesterday').checked = true;
        document.getElementById('tickerShowToday').checked = true;
        document.getElementById('tickerShowTomorrow').checked = false;
      }
    }
    
    async function saveTickerSettings() {
      const isManual = document.getElementById('tickerModeManual').checked;
      
      const settings = {
        mode: isManual ? 'manual' : 'auto',
        showYesterday: document.getElementById('tickerShowYesterday').checked,
        showToday: document.getElementById('tickerShowToday').checked,
        showTomorrow: document.getElementById('tickerShowTomorrow').checked
      };
      
      try {
        // Upsert the settings
        const { error } = await db
          .from('site_settings')
          .upsert({
            key: 'ticker_settings',
            value: settings,
            updated_at: new Date().toISOString()
          }, {
            onConflict: 'key'
          });
        
        if (error) throw error;
        
        // Show success
        const status = document.getElementById('tickerSaveStatus');
        status.style.display = 'inline';
        setTimeout(() => { status.style.display = 'none'; }, 3000);
        
        showToast('Ticker settings saved', 'success');
      } catch (err) {
        console.error('Error saving ticker settings:', err);
        showToast('Error saving settings: ' + err.message, 'error');
      }
    }
  </script>
  
  <!-- Delete by Slug Modal -->
  <div id="deleteBySlugModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center;">
    <div style="background: white; padding: 30px; border-radius: 12px; max-width: 500px; width: 90%; max-height: 80vh; overflow-y: auto;">
      <h2 style="margin-top: 0; margin-bottom: 20px;">Delete Article by Slug</h2>
      <p style="color: #666; margin-bottom: 15px;">Paste the article URL or slug to find and delete it:</p>
      <div style="display: flex; gap: 10px; margin-bottom: 15px;">
        <input type="text" id="deleteSlugInput" placeholder="e.g. epping-edges-farmington-1765339497319" style="flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 5px; font-size: 14px;">
        <button onclick="lookupBySlug()" style="background: #1a73e8; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">Lookup</button>
      </div>
      <div id="deleteSlugResult"></div>
      <div style="margin-top: 20px; text-align: right;">
        <button onclick="closeDeleteBySlugModal()" style="background: #e0e0e0; color: #333; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">Cancel</button>
      </div>
    </div>
  </div>
  
  <!-- Pin Articles Modal -->
  <div id="pinArticlesModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center;">
    <div style="background: white; padding: 30px; border-radius: 12px; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h2 style="margin: 0;">üìå Pin Stories</h2>
        <span id="pinnedCount" style="background: #fff3e0; color: #e65100; padding: 4px 12px; border-radius: 15px; font-size: 13px;">0/3 pinned</span>
      </div>
      <p style="color: #666; margin-bottom: 15px;">Select up to 3 published stories to pin at the top. Pinned stories stay at the top regardless of sorting.</p>
      <div id="pinArticlesList" style="max-height: 400px; overflow-y: auto; border: 1px solid #eee; border-radius: 8px;">
        <!-- Articles will be rendered here -->
      </div>
      <div style="margin-top: 20px; display: flex; justify-content: space-between;">
        <button onclick="clearPinnedArticles()" style="background: #ffebee; color: #c62828; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">Clear All Pins</button>
        <button onclick="closePinArticlesModal()" style="background: #1a73e8; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">Done</button>
      </div>
    </div>
  </div>
</body>
</html>