<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ball603 CMS</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <!-- Quill.js Rich Text Editor -->
  <link href="https://cdn.quilljs.com/1.3.7/quill.snow.css" rel="stylesheet">
  <script src="https://cdn.quilljs.com/1.3.7/quill.min.js"></script>
  <!-- Cropper.js for image cropping -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.css" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.js"></script>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f5f5f5; color: #333; min-height: 100vh; }
    
    /* Header */
    .header { background: #fff; padding: 15px 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); position: relative; z-index: 1000; }
    .header-inner { max-width: 1200px; margin: 0 auto; display: flex; justify-content: space-between; align-items: center; }
    .header-left { display: flex; align-items: center; gap: 15px; }
    .header-left img { height: 50px; cursor: pointer; }
    .header-left h1 { font-size: 20px; color: #333; }
    .header-right { display: flex; align-items: center; gap: 15px; }
    .user-info { font-size: 13px; color: #666; }
    .btn-logout { background: #eee; border: none; padding: 8px 16px; border-radius: 5px; cursor: pointer; font-size: 13px; }
    .btn-logout:hover { background: #ddd; }
    
    /* Login Screen */
    .login-screen { display: flex; justify-content: center; align-items: center; min-height: 100vh; padding: 20px; }
    .login-box { background: #fff; padding: 40px; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); text-align: center; max-width: 400px; width: 100%; }
    .login-box img { height: 80px; margin-bottom: 20px; }
    .login-box h2 { margin-bottom: 10px; color: #333; }
    .login-box p { color: #666; margin-bottom: 25px; font-size: 14px; }
    .login-box input { width: 100%; padding: 12px 15px; border: 1px solid #ddd; border-radius: 5px; font-size: 14px; margin-bottom: 15px; }
    .login-box input:focus { outline: none; border-color: #f57c00; }
    .login-box button { width: 100%; padding: 12px; background: #f57c00; color: #fff; border: none; border-radius: 5px; font-size: 14px; font-weight: 600; cursor: pointer; }
    .login-box button:hover { background: #e56a00; }
    .login-error { color: #c00; font-size: 13px; margin-bottom: 15px; }
    
    /* Main Layout */
    .main-container { max-width: 1200px; margin: 0 auto; padding: 20px; display: none; }
    
    /* Tabs */
    .tabs { display: flex; gap: 5px; margin-bottom: 20px; }
    .tab { padding: 10px 20px; background: #fff; border: none; border-radius: 8px 8px 0 0; cursor: pointer; font-size: 14px; font-weight: 500; color: #666; }
    .tab:hover { background: #f0f0f0; }
    .tab.active { background: #f57c00; color: #fff; }
    
    /* Panel */
    .panel { background: #fff; border-radius: 0 8px 8px 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); padding: 20px; }
    
    /* Article List */
    .toolbar { display: flex; align-items: center; margin-bottom: 20px; gap: 10px; }
    .btn-new { background: #e0e0e0; color: #333; border: none; padding: 10px 20px; border-radius: 5px; font-size: 14px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 8px; }
    .btn-new:hover { background: #d0d0d0; }
    .search-box { padding: 10px 15px; border: 1px solid #ddd; border-radius: 5px; font-size: 14px; width: 250px; margin-left: auto; }
    
    .article-list { border: 1px solid #eee; border-radius: 8px; overflow: hidden; }
    .article-row { display: grid; grid-template-columns: 1fr 120px 150px 100px; padding: 15px; border-bottom: 1px solid #eee; align-items: center; }
    .article-row:last-child { border-bottom: none; }
    .article-row:hover { background: #f9f9f9; }
    .article-row.header { background: #f5f5f5; font-weight: 600; font-size: 12px; text-transform: uppercase; color: #666; }
    .article-row.header:hover { background: #f5f5f5; }
    .article-title { font-weight: 500; color: #333; cursor: pointer; }
    .article-title:hover { color: #f57c00; }
    .article-status { font-size: 12px; padding: 4px 10px; border-radius: 20px; display: inline-block; }
    .article-status.draft { background: #fff3e0; color: #e65100; }
    .article-status.published { background: #e8f5e9; color: #2e7d32; }
    .article-status.scheduled { background: #f3e5f5; color: #7b1fa2; }
    .article-date { font-size: 13px; color: #666; }
    .article-actions { display: flex; gap: 8px; }
    .btn-edit, .btn-delete { padding: 6px 12px; border: none; border-radius: 4px; font-size: 12px; cursor: pointer; }
    .btn-edit { background: #e3f2fd; color: #1565c0; }
    .btn-edit:hover { background: #bbdefb; }
    .btn-delete { background: #ffebee; color: #c62828; }
    .btn-delete:hover { background: #ffcdd2; }
    
    /* Editor */
    .editor-panel { display: none; }
    .editor-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid #eee; }
    .editor-header h2 { font-size: 18px; }
    .editor-actions { display: flex; gap: 10px; }
    .btn-back { background: #e0e0e0; color: #333; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-size: 14px; }
    .btn-back:hover { background: #d0d0d0; }
    .btn-save { background: #f57c00; color: #fff; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-size: 14px; font-weight: 500; }
    .btn-save:hover { background: #e56a00; }
    .btn-publish { background: #f57c00; color: #fff; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-size: 14px; font-weight: 500; }
    .btn-publish:hover { background: #e56a00; }
    .btn-preview { background: #e0e0e0; color: #333; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-size: 14px; font-weight: 500; }
    .btn-preview:hover { background: #d0d0d0; }
    
    .form-grid { display: grid; grid-template-columns: 2fr 1fr; gap: 30px; }
    .form-main, .form-sidebar { display: flex; flex-direction: column; gap: 20px; }
    
    .form-group { display: flex; flex-direction: column; gap: 6px; }
    .form-group label { font-size: 13px; font-weight: 600; color: #555; }
    .form-group input, .form-group select, .form-group textarea { padding: 10px 12px; border: 1px solid #ddd; border-radius: 5px; font-size: 14px; font-family: inherit; }
    .form-group input:focus, .form-group select:focus, .form-group textarea:focus { outline: none; border-color: #f57c00; }
    .form-group textarea { min-height: 300px; resize: vertical; }
    .form-group small { font-size: 11px; color: #999; }
    
    .sidebar-card { background: #f9f9f9; border-radius: 8px; padding: 15px; }
    .sidebar-card h4 { font-size: 13px; font-weight: 600; margin-bottom: 12px; color: #555; }
    
    /* Quill Editor Styles */
    .ql-container { font-size: 15px; font-family: inherit; }
    .ql-editor { min-height: 350px; line-height: 1.7; }
    .ql-editor p { margin-bottom: 1em; }
    .ql-toolbar.ql-snow { border-radius: 5px 5px 0 0; background: #fafafa; }
    .ql-container.ql-snow { border-radius: 0 0 5px 5px; }
    
    /* Custom Image Styles in Editor */
    .ql-editor .article-image { margin: 20px 0; }
    .ql-editor .article-image.align-left { float: left; margin-right: 20px; margin-bottom: 10px; clear: left; }
    .ql-editor .article-image.align-right { float: right; margin-left: 20px; margin-bottom: 10px; clear: right; }
    .ql-editor .article-image.align-center { display: block; margin-left: auto; margin-right: auto; clear: both; }
    .ql-editor .article-image.size-small { width: 25%; }
    .ql-editor .article-image.size-medium { width: 50%; }
    .ql-editor .article-image.size-full { width: 100%; }
    .ql-editor .article-image img { width: 100%; height: auto; border-radius: 6px; }
    .ql-editor .article-image .caption { font-size: 13px; color: #666; font-style: italic; margin-top: 6px; text-align: center; }
    .ql-editor .clearfix { clear: both; }
    
    /* Featured Image */
    .featured-image-container { border: 2px dashed #ddd; border-radius: 8px; padding: 20px; text-align: center; margin-bottom: 15px; cursor: pointer; transition: all 0.2s; background: #fafafa; }
    .featured-image-container:hover { border-color: #f57c00; background: #fff8f0; }
    .featured-image-container.has-image { border-style: solid; border-color: #ddd; padding: 0; overflow: hidden; }
    .featured-image-container .placeholder { color: #888; }
    .featured-image-container .placeholder span { font-size: 40px; display: block; margin-bottom: 10px; }
    .featured-image-preview { position: relative; }
    .featured-image-preview img { width: 100%; aspect-ratio: 16/9; object-fit: cover; display: block; }
    .featured-image-preview .remove-btn { position: absolute; top: 10px; right: 10px; background: rgba(0,0,0,0.7); color: white; border: none; border-radius: 50%; width: 30px; height: 30px; cursor: pointer; font-size: 16px; }
    .featured-image-preview .image-info { padding: 10px; background: #f5f5f5; font-size: 12px; color: #666; }
    
    /* Image Insert Modal */
    .image-modal { max-width: 500px; }
    .image-modal .form-group { margin-bottom: 15px; }
    .image-modal .alignment-options, .image-modal .size-options { display: flex; gap: 10px; }
    .image-modal .alignment-options label, .image-modal .size-options label { flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 5px; text-align: center; cursor: pointer; transition: all 0.2s; }
    .image-modal .alignment-options input, .image-modal .size-options input { display: none; }
    .image-modal .alignment-options input:checked + span, .image-modal .size-options input:checked + span { background: #f57c00; color: white; }
    .image-modal .alignment-options label:has(input:checked), .image-modal .size-options label:has(input:checked) { border-color: #f57c00; background: #fff8f0; }
    
    /* Cropper Modal */
    .cropper-modal-content { max-width: 700px; }
    .cropper-container-wrapper { max-height: 400px; overflow: hidden; background: #333; border-radius: 6px; }
    .cropper-container-wrapper img { max-width: 100%; display: block; }
    .crop-aspect-buttons { display: flex; gap: 8px; margin-bottom: 15px; flex-wrap: wrap; }
    .crop-aspect-buttons button { padding: 8px 14px; border: 1px solid #ddd; background: #fff; border-radius: 5px; cursor: pointer; font-size: 13px; }
    .crop-aspect-buttons button:hover { background: #f5f5f5; }
    .crop-aspect-buttons button.active { background: #f57c00; color: white; border-color: #f57c00; }
    
    .game-selector { border: 1px solid #ddd; border-radius: 5px; max-height: 200px; overflow-y: auto; background: #fff; }
    .game-option { padding: 10px; border-bottom: 1px solid #eee; cursor: pointer; font-size: 13px; }
    .game-option:hover { background: #fff3e0; }
    .game-option.selected { background: #f57c00; color: #fff; }
    .game-option .teams { font-weight: 500; }
    .game-option .meta { font-size: 11px; opacity: 0.8; margin-top: 3px; }
    
    .ai-generate { margin-top: 15px; }
    .btn-ai { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: #fff; border: none; padding: 12px 20px; border-radius: 5px; cursor: pointer; font-size: 14px; font-weight: 500; width: 100%; display: flex; align-items: center; justify-content: center; gap: 8px; }
    .btn-ai:hover { opacity: 0.9; }
    .btn-ai:disabled { opacity: 0.5; cursor: not-allowed; }
    
    /* Social posting */
    .social-buttons { display: flex; flex-direction: column; gap: 8px; }
    .btn-social { padding: 10px; border: none; border-radius: 5px; cursor: pointer; font-size: 13px; font-weight: 500; display: flex; align-items: center; gap: 8px; }
    .btn-social.facebook { background: #1877f2; color: #fff; }
    .btn-social.instagram { background: linear-gradient(45deg, #f09433, #e6683c, #dc2743, #cc2366, #bc1888); color: #fff; }
    .btn-social.twitter { background: #000; color: #fff; }
    .btn-social:disabled { opacity: 0.5; }
    .btn-social .posted { margin-left: auto; font-size: 11px; opacity: 0.8; }
    
    /* Browse button */
    .btn-browse { background: #f57c00; color: #fff; border: none; padding: 10px 15px; border-radius: 5px; cursor: pointer; font-size: 13px; font-weight: 500; white-space: nowrap; }
    .btn-browse:hover { background: #e56a00; }
    
    /* SmugMug Modal */
    .modal-overlay { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.6); z-index: 3000; justify-content: center; align-items: center; }
    .modal-overlay.open { display: flex; }
    .modal { background: #fff; border-radius: 10px; width: 90%; max-width: 800px; max-height: 80vh; display: flex; flex-direction: column; }
    .modal-header { padding: 15px 20px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
    .modal-header h3 { font-size: 16px; }
    .modal-close { background: none; border: none; font-size: 24px; cursor: pointer; color: #999; }
    .modal-close:hover { color: #333; }
    .modal-search { padding: 15px 20px; border-bottom: 1px solid #eee; }
    .modal-search input { width: 100%; padding: 10px 15px; border: 1px solid #ddd; border-radius: 5px; font-size: 14px; }
    .modal-body { flex: 1; overflow-y: auto; padding: 15px; }
    .album-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 15px; }
    .album-card { border: 1px solid #eee; border-radius: 8px; overflow: hidden; cursor: pointer; transition: box-shadow 0.2s; }
    .album-card:hover { box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
    .album-card.selected { border: 2px solid #f57c00; }
    .album-thumb { width: 100%; height: 120px; object-fit: cover; background: #f5f5f5; }
    .album-info { padding: 10px; }
    .album-name { font-size: 13px; font-weight: 500; margin-bottom: 4px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .album-meta { font-size: 11px; color: #888; }
    .modal-footer { padding: 15px 20px; border-top: 1px solid #eee; display: flex; justify-content: flex-end; gap: 10px; }
    .btn-modal { padding: 10px 20px; border-radius: 5px; font-size: 14px; cursor: pointer; }
    .btn-modal-cancel { background: #eee; border: none; color: #333; }
    .btn-modal-cancel:hover { background: #ddd; }
    .btn-modal-select { background: #f57c00; border: none; color: #fff; font-weight: 500; }
    .btn-modal-select:hover { background: #e56a00; }
    .btn-modal-select:disabled { background: #ccc; cursor: not-allowed; }
    
    /* Empty state */
    .empty-state { text-align: center; padding: 60px 20px; color: #888; }
    .empty-state p { margin-bottom: 20px; }
    
    /* Toast notifications */
    .toast { position: fixed; bottom: 20px; right: 20px; padding: 15px 25px; background: #333; color: #fff; border-radius: 8px; font-size: 14px; z-index: 2000; display: none; }
    .toast.success { background: #4CAF50; }
    .toast.error { background: #f44336; }
    
    /* Loading */
    .loading { text-align: center; padding: 40px; color: #888; }
    
    @media (max-width: 900px) {
      .form-grid { grid-template-columns: 1fr; }
      .article-row { grid-template-columns: 1fr; gap: 8px; }
      .article-row.header { display: none; }
    }
  </style>
</head>
<body>
  <!-- Login Screen -->
  <div class="login-screen" id="loginScreen">
    <div class="login-box">
      <img src="logo.png" alt="Ball603">
      <h2>Ball603 CMS</h2>
      <p>Content Management System</p>
      <div class="login-error" id="loginError" style="display: none;"></div>
      <input type="password" id="loginPassword" placeholder="Enter password" onkeypress="if(event.key==='Enter')login()">
      <button onclick="login()">Sign In</button>
    </div>
  </div>
  
  <!-- Main App -->
  <div class="header" id="mainHeader" style="display: none;">
    <div class="header-inner">
      <div class="header-left">
        <img src="logo.png" alt="Ball603" onclick="window.location.href='/'">
        <h1>CMS</h1>
      </div>
      <div class="header-right">
        <span class="user-info">Welcome, Admin</span>
        <button class="btn-logout" onclick="logout()">Logout</button>
      </div>
    </div>
  </div>
  
  <div class="main-container" id="mainContainer">
    <div class="tabs">
      <button class="tab active" onclick="showTab('articles')">Articles</button>
      <button class="tab" onclick="showTab('schedule')">Schedule</button>
      <button class="tab" onclick="showTab('teams')">Teams</button>
      <button class="tab" onclick="showTab('contributors')">Contributors</button>
      <button class="tab" onclick="showTab('sponsors')">Sponsors</button>
      <button class="tab" onclick="showTab('products')">Webstore</button>
    </div>
    
    <!-- Articles List Panel -->
    <div class="panel" id="articlesPanel">
      <div class="toolbar">
        <button class="btn-new" onclick="newGameStory()">
          <span>+</span> Scorebook Story
        </button>
        <button class="btn-new" onclick="newBoxscoreStory()">
          <span>+</span> Boxscore Story
        </button>
        <button class="btn-new" onclick="newArticle()">
          <span>+</span> News Article
        </button>
        <input type="text" class="search-box" placeholder="Search articles..." oninput="filterArticles(this.value)">
      </div>
      
      <div class="article-list" id="articleList">
        <div class="article-row header">
          <div>Title</div>
          <div>Status</div>
          <div>Date</div>
          <div>Actions</div>
        </div>
        <div class="loading">Loading articles...</div>
      </div>
    </div>
    
    <!-- Schedule Panel -->
    <div class="panel" id="schedulePanel" style="display: none;">
      <div class="toolbar" style="flex-wrap: wrap; gap: 10px;">
        <button class="btn-new" onclick="openGameModal()">
          <span>+</span> Add Game
        </button>
        <button class="btn-new" style="background: #e3f2fd; color: #1565c0;" onclick="openGameImportModal()">
          <span>ðŸ“¥</span> Import CSV
        </button>
        <button class="btn-new" style="background: #fff3e0; color: #e65100;" onclick="exportGames()">
          <span>ðŸ“¤</span> Export CSV
        </button>
        <button class="btn-new" style="background: #e8f5e9; color: #2e7d32;" onclick="document.getElementById('coverageRestoreInput').click()">
          <span>ðŸ”„</span> Restore Coverage
        </button>
        <input type="file" id="coverageRestoreInput" accept=".csv" style="display: none;" onchange="restoreCoverageFromCSV(this.files[0])">
        <div style="display: flex; gap: 8px; align-items: center; margin-left: auto; flex-wrap: wrap;">
          <input type="date" id="gameStartDate" onchange="filterGames()" style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 5px; font-size: 13px;">
          <span style="color: #888;">to</span>
          <input type="date" id="gameEndDate" onchange="filterGames()" style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 5px; font-size: 13px;">
          <select id="gameLevelFilter" onchange="filterGames()" style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 5px; font-size: 13px;">
            <option value="">All Levels</option>
            <option value="NHIAA">NHIAA</option>
            <option value="College">College</option>
            <option value="Prep School">Prep School</option>
          </select>
          <select id="gameDivisionFilter" onchange="filterGames()" style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 5px; font-size: 13px;">
            <option value="">All Divisions</option>
            <optgroup label="High School">
              <option value="D-I">D-I</option>
              <option value="D-II">D-II</option>
              <option value="D-III">D-III</option>
              <option value="D-IV">D-IV</option>
            </optgroup>
            <optgroup label="College">
              <option value="D1">D1 (NCAA)</option>
              <option value="D2">D2 (NCAA)</option>
              <option value="D3">D3 (NCAA)</option>
            </optgroup>
            <optgroup label="Prep">
              <option value="NEPSAC">NEPSAC</option>
            </optgroup>
          </select>
          <select id="gameGenderFilter" onchange="filterGames()" style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 5px; font-size: 13px;">
            <option value="">All Genders</option>
            <option value="Boys">Boys</option>
            <option value="Girls">Girls</option>
            <option value="Men">Men</option>
            <option value="Women">Women</option>
          </select>
          <input type="text" id="gameSearchBox" placeholder="Search games..." oninput="filterGames()" style="width: 150px; padding: 8px 12px; border: 1px solid #ddd; border-radius: 5px; font-size: 13px;">
        </div>
      </div>
      
      <div style="padding: 10px 15px; background: #f5f5f5; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center;">
        <span id="gameCount" style="font-size: 13px; color: #666;">Loading games...</span>
        <div style="display: flex; gap: 10px;">
          <label style="font-size: 12px; display: flex; align-items: center; gap: 5px; cursor: pointer;">
            <input type="checkbox" id="showCoverageOnly" onchange="filterGames()"> With coverage
          </label>
          <label style="font-size: 12px; display: flex; align-items: center; gap: 5px; cursor: pointer;">
            <input type="checkbox" id="showFinalOnly" onchange="filterGames()"> Final only
          </label>
        </div>
      </div>
      
      <div class="article-list" id="gameList">
        <div class="article-row header" style="grid-template-columns: 90px 1fr 1fr 70px 80px 50px 80px 100px;">
          <div>Date</div>
          <div>Away</div>
          <div>Home</div>
          <div>Score</div>
          <div>Division</div>
          <div>URLs</div>
          <div>Coverage</div>
          <div>Actions</div>
        </div>
        <div class="loading">Loading games...</div>
      </div>
    </div>
    
    <!-- Game Edit Modal -->
    <div id="gameModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 2000; overflow-y: auto;">
      <div style="max-width: 800px; margin: 30px auto; background: #fff; border-radius: 10px; overflow: hidden; box-shadow: 0 4px 20px rgba(0,0,0,0.3);">
        <div style="background: #1565c0; color: white; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center;">
          <h2 style="margin: 0; font-size: 16px; font-weight: 500;" id="gameModalTitle">Add Game</h2>
          <button onclick="closeGameModal()" style="background: none; border: none; color: white; font-size: 24px; cursor: pointer; line-height: 1;">&times;</button>
        </div>
        
        <div style="padding: 20px;">
          <input type="hidden" id="gameId">
          <input type="hidden" id="gameExternalId">
          
          <!-- Row 1: Date, Time, Status -->
          <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin-bottom: 15px;">
            <div class="form-group">
              <label>Date *</label>
              <input type="date" id="gameDate">
            </div>
            <div class="form-group">
              <label>Time</label>
              <input type="text" id="gameTime" placeholder="7:00 PM or FINAL">
            </div>
            <div class="form-group">
              <label>Status</label>
              <select id="gameStatus">
                <option value="scheduled">Scheduled</option>
                <option value="final">Final</option>
                <option value="postponed">Postponed</option>
                <option value="cancelled">Cancelled</option>
              </select>
            </div>
          </div>
          
          <!-- Row 2: Teams -->
          <div style="display: grid; grid-template-columns: 1fr 80px 1fr 80px; gap: 15px; margin-bottom: 15px;">
            <div class="form-group">
              <label>Away Team *</label>
              <input type="text" id="gameAwayTeam" placeholder="Farmington" list="teamsList">
            </div>
            <div class="form-group">
              <label>Away Score</label>
              <input type="number" id="gameAwayScore" min="0">
            </div>
            <div class="form-group">
              <label>Home Team *</label>
              <input type="text" id="gameHomeTeam" placeholder="Berlin" list="teamsList">
            </div>
            <div class="form-group">
              <label>Home Score</label>
              <input type="number" id="gameHomeScore" min="0">
            </div>
          </div>
          <datalist id="teamsList"></datalist>
          
          <!-- Row 3: Classification -->
          <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin-bottom: 15px;">
            <div class="form-group">
              <label>Level *</label>
              <select id="gameLevel" onchange="updateGameDivisionOptions()">
                <option value="NHIAA">NHIAA</option>
                <option value="College">College</option>
                <option value="Prep School">Prep School</option>
              </select>
            </div>
            <div class="form-group">
              <label>Division</label>
              <select id="gameDivision">
                <option value="">None</option>
                <option value="D-I">D-I</option>
                <option value="D-II">D-II</option>
                <option value="D-III">D-III</option>
                <option value="D-IV">D-IV</option>
              </select>
            </div>
            <div class="form-group">
              <label>Gender</label>
              <select id="gameGender">
                <option value="Boys">Boys</option>
                <option value="Girls">Girls</option>
                <option value="Men">Men</option>
                <option value="Women">Women</option>
              </select>
            </div>
          </div>
          
          <!-- Coverage Section -->
          <div style="background: #f9f9f9; border: 1px solid #eee; border-radius: 8px; padding: 15px; margin-bottom: 15px;">
            <h3 style="margin: 0 0 12px 0; font-size: 14px; color: #333;">Coverage Assignments</h3>
            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px;">
              <div class="form-group" style="min-width: 0;">
                <label>Photog 1</label>
                <input type="text" id="gamePhotog1" placeholder="Name" style="width: 100%; min-width: 0;">
              </div>
              <div class="form-group" style="min-width: 0;">
                <label>Photog 2</label>
                <input type="text" id="gamePhotog2" placeholder="Name" style="width: 100%; min-width: 0;">
              </div>
              <div class="form-group" style="min-width: 0;">
                <label>Videog</label>
                <input type="text" id="gameVideog" placeholder="Name" style="width: 100%; min-width: 0;">
              </div>
              <div class="form-group" style="min-width: 0;">
                <label>Writer</label>
                <input type="text" id="gameWriter" placeholder="Name" style="width: 100%; min-width: 0;">
              </div>
            </div>
          </div>
          
          <!-- Links Section -->
          <div style="background: #e3f2fd; border: 1px solid #bbdefb; border-radius: 8px; padding: 15px; margin-bottom: 15px;">
            <h3 style="margin: 0 0 12px 0; font-size: 14px; color: #1565c0;">Coverage Links</h3>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
              <div class="form-group">
                <label>Photos URL</label>
                <input type="url" id="gamePhotosUrl" placeholder="https://ball603.smugmug.com/...">
              </div>
              <div class="form-group">
                <label>Recap/Article URL</label>
                <input type="url" id="gameRecapUrl" placeholder="https://ball603.com/...">
              </div>
              <div class="form-group">
                <label>Highlights URL</label>
                <input type="url" id="gameHighlightsUrl" placeholder="https://youtube.com/...">
              </div>
              <div class="form-group">
                <label>Live Stream URL</label>
                <input type="url" id="gameLiveStreamUrl" placeholder="https://...">
              </div>
            </div>
          </div>
          
          <!-- Additional Info -->
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
            <div class="form-group">
              <label>Special Event</label>
              <input type="text" id="gameSpecialEvent" placeholder="Tournament name, rivalry, etc.">
            </div>
            <div class="form-group">
              <label>Location (if not home team)</label>
              <input type="text" id="gameLocation" placeholder="Venue name">
            </div>
          </div>
          
          <div class="form-group" style="margin-bottom: 15px;">
            <label>Notes</label>
            <textarea id="gameNotes" rows="2" placeholder="Internal notes..." style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; font-size: 14px; resize: vertical;"></textarea>
          </div>
          
          <div style="display: flex; justify-content: flex-end; gap: 10px; padding-top: 15px; border-top: 1px solid #eee;">
            <button onclick="closeGameModal()" style="padding: 10px 20px; background: #f5f5f5; border: 1px solid #ddd; border-radius: 5px; cursor: pointer;">Cancel</button>
            <button onclick="saveGame()" style="padding: 10px 25px; background: #1565c0; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: 500;">Save Game</button>
          </div>
        </div>
      </div>
    </div>
    
    <!-- URL Management Modal -->
    <div id="urlModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 2000; overflow-y: auto;">
      <div style="max-width: 550px; margin: 80px auto; background: #fff; border-radius: 10px; overflow: hidden; box-shadow: 0 4px 20px rgba(0,0,0,0.3);">
        <div style="background: #7b1fa2; color: white; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center;">
          <h2 style="margin: 0; font-size: 16px; font-weight: 500;">ðŸ”— Manage Coverage URLs</h2>
          <button onclick="closeUrlModal()" style="background: none; border: none; color: white; font-size: 24px; cursor: pointer; line-height: 1;">&times;</button>
        </div>
        
        <div style="padding: 20px;">
          <input type="hidden" id="urlGameId">
          
          <!-- Game Info Header -->
          <div style="background: #f5f5f5; border-radius: 8px; padding: 12px 15px; margin-bottom: 20px;">
            <div style="font-weight: 600; font-size: 14px;" id="urlGameTitle">Loading...</div>
            <div style="font-size: 12px; color: #666; margin-top: 4px;" id="urlGameMeta"></div>
          </div>
          
          <!-- URL Fields -->
          <div style="display: flex; flex-direction: column; gap: 15px;">
            <div class="form-group">
              <label style="display: flex; align-items: center; gap: 6px;">
                <span>ðŸ“·</span> Photos URL
              </label>
              <div style="display: flex; gap: 8px;">
                <input type="url" id="urlPhotos" placeholder="https://ball603.smugmug.com/..." style="flex: 1;">
                <button onclick="clearUrlField('urlPhotos')" style="padding: 8px 12px; background: #ffebee; color: #c62828; border: none; border-radius: 5px; cursor: pointer;" title="Clear">âœ•</button>
              </div>
            </div>
            
            <div class="form-group">
              <label style="display: flex; align-items: center; gap: 6px;">
                <span>ðŸ“°</span> Recap/Article URL
              </label>
              <div style="display: flex; gap: 8px;">
                <input type="url" id="urlRecap" placeholder="https://ball603.com/..." style="flex: 1;">
                <button onclick="clearUrlField('urlRecap')" style="padding: 8px 12px; background: #ffebee; color: #c62828; border: none; border-radius: 5px; cursor: pointer;" title="Clear">âœ•</button>
              </div>
            </div>
            
            <div class="form-group">
              <label style="display: flex; align-items: center; gap: 6px;">
                <span>ðŸŽ¬</span> Highlights URL
              </label>
              <div style="display: flex; gap: 8px;">
                <input type="url" id="urlHighlights" placeholder="https://youtube.com/..." style="flex: 1;">
                <button onclick="clearUrlField('urlHighlights')" style="padding: 8px 12px; background: #ffebee; color: #c62828; border: none; border-radius: 5px; cursor: pointer;" title="Clear">âœ•</button>
              </div>
            </div>
            
            <div class="form-group">
              <label style="display: flex; align-items: center; gap: 6px;">
                <span>ðŸ“º</span> Live Stream URL
              </label>
              <div style="display: flex; gap: 8px;">
                <input type="url" id="urlLiveStream" placeholder="https://..." style="flex: 1;">
                <button onclick="clearUrlField('urlLiveStream')" style="padding: 8px 12px; background: #ffebee; color: #c62828; border: none; border-radius: 5px; cursor: pointer;" title="Clear">âœ•</button>
              </div>
            </div>
          </div>
          
          <!-- Actions -->
          <div style="display: flex; justify-content: space-between; gap: 10px; padding-top: 20px; margin-top: 20px; border-top: 1px solid #eee;">
            <button onclick="clearAllUrls()" style="padding: 10px 16px; background: #ffebee; color: #c62828; border: none; border-radius: 5px; cursor: pointer; font-size: 13px;">Clear All URLs</button>
            <div style="display: flex; gap: 10px;">
              <button onclick="closeUrlModal()" style="padding: 10px 20px; background: #f5f5f5; border: 1px solid #ddd; border-radius: 5px; cursor: pointer;">Cancel</button>
              <button onclick="saveUrls()" style="padding: 10px 25px; background: #7b1fa2; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: 500;">Save URLs</button>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Game Import Modal -->
    <div id="gameImportModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 2000; overflow-y: auto;">
      <div style="max-width: 700px; margin: 30px auto; background: #fff; border-radius: 10px; overflow: hidden; box-shadow: 0 4px 20px rgba(0,0,0,0.3);">
        <div style="background: #1565c0; color: white; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center;">
          <h2 style="margin: 0; font-size: 16px; font-weight: 500;">Import Games from CSV</h2>
          <button onclick="closeGameImportModal()" style="background: none; border: none; color: white; font-size: 24px; cursor: pointer; line-height: 1;">&times;</button>
        </div>
        
        <div style="padding: 20px;">
          <div id="gameImportDropZone" style="border: 2px dashed #1565c0; border-radius: 10px; padding: 40px; text-align: center; margin-bottom: 15px; cursor: pointer; transition: all 0.2s;"
               ondragover="event.preventDefault(); this.style.background='#e3f2fd';"
               ondragleave="this.style.background='transparent';"
               ondrop="event.preventDefault(); this.style.background='transparent'; handleGameCsvFile(event.dataTransfer.files[0]);"
               onclick="document.getElementById('gameFileInput').click();">
            <div style="font-size: 48px; margin-bottom: 10px;">ðŸ“„</div>
            <p style="margin: 0; color: #666;">Drop CSV file here or click to browse</p>
            <p style="margin: 5px 0 0 0; font-size: 12px; color: #999;">Supports Ball603 schedule export format</p>
            <input type="file" id="gameFileInput" accept=".csv" style="display: none;" onchange="handleGameCsvFile(this.files[0])">
          </div>
          
          <div id="gameImportPreview" style="display: none;">
            <div style="background: #e8f5e9; padding: 10px 15px; border-radius: 5px; margin-bottom: 15px;">
              <strong id="gameImportPreviewCount">0 games</strong> ready to import from <span id="gameImportPreviewFile"></span>
            </div>
            <div style="max-height: 300px; overflow-y: auto; border: 1px solid #ddd; border-radius: 5px;">
              <table style="width: 100%; border-collapse: collapse; font-size: 13px;">
                <thead style="background: #f5f5f5; position: sticky; top: 0;">
                  <tr>
                    <th style="padding: 8px; text-align: left; border-bottom: 1px solid #ddd;">Date</th>
                    <th style="padding: 8px; text-align: left; border-bottom: 1px solid #ddd;">Away</th>
                    <th style="padding: 8px; text-align: left; border-bottom: 1px solid #ddd;">Home</th>
                    <th style="padding: 8px; text-align: left; border-bottom: 1px solid #ddd;">Level</th>
                  </tr>
                </thead>
                <tbody id="gameImportPreviewBody"></tbody>
              </table>
            </div>
            <div style="margin-top: 15px; display: flex; justify-content: flex-end; gap: 10px;">
              <button onclick="closeGameImportModal()" style="padding: 10px 20px; background: #f5f5f5; border: 1px solid #ddd; border-radius: 5px; cursor: pointer;">Cancel</button>
              <button id="btnExecuteGameImport" onclick="executeGameImport()" style="padding: 10px 25px; background: #1565c0; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: 500;">Import Games</button>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Teams Panel -->
    <div class="panel" id="teamsPanel" style="display: none;">
      <div class="toolbar" style="flex-wrap: wrap; gap: 10px;">
        <button class="btn-new" onclick="openTeamModal()">
          <span>+</span> Add Team
        </button>
        <button class="btn-new" style="background: #e3f2fd; color: #1565c0;" onclick="openImportModal()">
          <span>ðŸ“¥</span> Import CSV
        </button>
        <button class="btn-new" style="background: #fff3e0; color: #e65100;" onclick="exportTeams()">
          <span>ðŸ“¤</span> Export CSV
        </button>
        <div style="display: flex; gap: 8px; align-items: center; margin-left: auto;">
          <select id="teamLevelFilter" onchange="filterTeams()" style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 5px; font-size: 13px;">
            <option value="">All Levels</option>
            <option value="High School">High School</option>
            <option value="College">College</option>
            <option value="Prep School">Prep School</option>
          </select>
          <select id="teamDivisionFilter" onchange="filterTeams()" style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 5px; font-size: 13px;">
            <option value="">All Divisions</option>
            <optgroup label="High School">
              <option value="D1">D1</option>
              <option value="D2">D2</option>
              <option value="D3">D3</option>
              <option value="D4">D4</option>
            </optgroup>
            <optgroup label="College">
              <option value="DI">DI (NCAA)</option>
              <option value="DII">DII (NCAA)</option>
              <option value="DIII">DIII (NCAA)</option>
            </optgroup>
            <optgroup label="Prep School">
              <option value="NEPSAC">NEPSAC</option>
            </optgroup>
          </select>
          <select id="teamGenderFilter" onchange="filterTeams()" style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 5px; font-size: 13px;">
            <option value="">All Genders</option>
            <option value="Boys">Boys</option>
            <option value="Girls">Girls</option>
            <option value="Men">Men</option>
            <option value="Women">Women</option>
          </select>
          <input type="text" class="search-box" id="teamSearchBox" placeholder="Search teams..." oninput="filterTeams()" style="width: 200px;">
        </div>
      </div>
      
      <div style="margin-bottom: 15px; display: flex; gap: 15px; font-size: 13px; color: #666;">
        <span id="teamCount">0 teams</span>
        <span id="teamActiveCount"></span>
      </div>
      
      <div class="article-list" id="teamList">
        <div class="article-row header" style="grid-template-columns: 50px 1fr 100px 80px 80px 100px 120px;">
          <div>Logo</div>
          <div>Team</div>
          <div>Level</div>
          <div>Division</div>
          <div>Gender</div>
          <div>Location</div>
          <div>Actions</div>
        </div>
        <div class="loading">Loading teams...</div>
      </div>
    </div>
    
    <!-- Team Edit Modal -->
    <div id="teamModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 2000; overflow-y: auto;">
      <div style="max-width: 700px; margin: 30px auto; background: #fff; border-radius: 10px; overflow: hidden; box-shadow: 0 4px 20px rgba(0,0,0,0.3);">
        <div style="background: #f57c00; color: white; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center;">
          <h2 style="margin: 0; font-size: 16px; font-weight: 500;" id="teamModalTitle">Add Team</h2>
          <button onclick="closeTeamModal()" style="background: none; border: none; color: white; font-size: 24px; cursor: pointer; line-height: 1;">&times;</button>
        </div>
        
        <div style="padding: 20px;">
          <input type="hidden" id="teamId">
          
          <!-- Row 1: Names -->
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
            <div class="form-group">
              <label>Full Name *</label>
              <input type="text" id="teamFullName" placeholder="Farmington High School">
            </div>
            <div class="form-group">
              <label>Short Name *</label>
              <input type="text" id="teamShortname" placeholder="Farmington" oninput="updateLogoPreview()">
            </div>
          </div>
          
          <!-- Row 2: Abbrev, Emoji, Mascot -->
          <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin-bottom: 15px;">
            <div class="form-group">
              <label>Abbreviation *</label>
              <input type="text" id="teamAbbrev" placeholder="FHS" maxlength="10">
            </div>
            <div class="form-group">
              <label>Emoji</label>
              <input type="text" id="teamEmoji" placeholder="ðŸ…" maxlength="5">
            </div>
            <div class="form-group">
              <label>Mascot</label>
              <input type="text" id="teamMascot" placeholder="Tigers">
            </div>
          </div>
          
          <!-- Row 2b: Logo Preview -->
          <div style="background: #f9f9f9; border: 1px solid #eee; border-radius: 8px; padding: 15px; margin-bottom: 15px;">
            <div style="display: flex; align-items: center; gap: 20px;">
              <div>
                <label style="font-size: 13px; font-weight: 600; color: #555; display: block; margin-bottom: 8px;">Team Logo</label>
                <div id="teamLogoPreview" onclick="triggerLogoUpload()" style="width: 100px; height: 100px; border: 2px dashed #ddd; border-radius: 8px; background: #fff; display: flex; align-items: center; justify-content: center; overflow: hidden; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.borderColor='#f57c00'; this.style.background='#fff8f0';" onmouseout="this.style.borderColor='#ddd'; this.style.background='#fff';">
                  <span style="color: #ccc; font-size: 12px; text-align: center;">Click to<br>upload</span>
                </div>
                <input type="file" id="logoUploadInput" accept="image/*" style="display: none;" onchange="handleLogoUpload(event)">
                <input type="hidden" id="teamLogoUrl">
              </div>
              <div style="flex: 1;">
                <p style="font-size: 12px; color: #666; margin: 0 0 8px 0;">
                  Click to upload a logo, or it will look for <code style="background: #eee; padding: 2px 6px; border-radius: 3px;">/logos/100px/{ShortName}.png</code>
                </p>
                <p style="font-size: 11px; color: #999; margin: 0;">
                  Uploaded logos are stored in Supabase. Recommended size: 100x100px or larger (square).
                </p>
                <button type="button" id="removeLogoBtn" onclick="removeTeamLogo()" style="display: none; margin-top: 8px; background: #ffebee; color: #c62828; border: none; padding: 5px 10px; border-radius: 4px; font-size: 11px; cursor: pointer;">
                  Remove uploaded logo
                </button>
              </div>
            </div>
          </div>
          
          <!-- Row 3: Level, Division, Gender -->
          <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin-bottom: 15px;">
            <div class="form-group">
              <label>Level *</label>
              <select id="teamLevel" onchange="updateDivisionOptions()">
                <option value="High School">High School</option>
                <option value="College">College</option>
                <option value="Prep School">Prep School</option>
              </select>
            </div>
            <div class="form-group">
              <label>Division</label>
              <select id="teamDivision">
                <option value="">None</option>
                <option value="D1">D1</option>
                <option value="D2">D2</option>
                <option value="D3">D3</option>
                <option value="D4">D4</option>
              </select>
            </div>
            <div class="form-group">
              <label>Gender</label>
              <select id="teamGender">
                <option value="">N/A (Both)</option>
                <option value="Boys">Boys</option>
                <option value="Girls">Girls</option>
                <option value="Men">Men</option>
                <option value="Women">Women</option>
              </select>
            </div>
          </div>
          
          <!-- Row 4: Location, Conference -->
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
            <div class="form-group">
              <label>Location (Town)</label>
              <input type="text" id="teamLocation" placeholder="Farmington">
            </div>
            <div class="form-group">
              <label>Conference</label>
              <input type="text" id="teamConference" placeholder="NHIAA, America East, etc.">
            </div>
          </div>
          
          <!-- Row 5: Colors (simplified - hex only) -->
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
            <div class="form-group">
              <label>Primary Color</label>
              <div style="display: flex; gap: 8px; align-items: center;">
                <input type="color" id="teamPrimaryHexPicker" style="width: 50px; height: 36px; border: 1px solid #ddd; border-radius: 4px; cursor: pointer;" onchange="document.getElementById('teamPrimaryHex').value = this.value">
                <input type="text" id="teamPrimaryHex" placeholder="#000000" style="flex: 1;" oninput="syncColorPicker('teamPrimaryHexPicker', this.value)">
              </div>
            </div>
            <div class="form-group">
              <label>Secondary Color</label>
              <div style="display: flex; gap: 8px; align-items: center;">
                <input type="color" id="teamSecondaryHexPicker" style="width: 50px; height: 36px; border: 1px solid #ddd; border-radius: 4px; cursor: pointer;" onchange="document.getElementById('teamSecondaryHex').value = this.value">
                <input type="text" id="teamSecondaryHex" placeholder="#FFFFFF" style="flex: 1;" oninput="syncColorPicker('teamSecondaryHexPicker', this.value)">
              </div>
            </div>
          </div>
          
          <!-- Row 6: Website, Livestream -->
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
            <div class="form-group">
              <label>Website URL</label>
              <input type="url" id="teamWebsite" placeholder="https://...">
            </div>
            <div class="form-group">
              <label>Livestream URL</label>
              <input type="url" id="teamLivestream" placeholder="https://...">
            </div>
          </div>
          
          <!-- Row 7: Combined Team -->
          <div style="background: #f9f9f9; border: 1px solid #eee; border-radius: 8px; padding: 15px; margin-bottom: 15px;">
            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; margin-bottom: 10px;">
              <input type="checkbox" id="teamCombined" onchange="toggleCombinedSection()">
              <span style="font-weight: 600;">This is a combined team</span>
              <span style="font-size: 12px; color: #666;">(e.g., Pittsburg-Canaan)</span>
            </label>
            <div id="combinedTeamSection" style="display: none;">
              <label style="font-size: 13px; color: #555; display: block; margin-bottom: 6px;">Select teams being combined:</label>
              <input type="text" id="combinedTeamSearch" placeholder="Search teams..." oninput="filterCombinedTeams()" style="width: 100%; padding: 8px 12px; border: 1px solid #ddd; border-radius: 4px; margin-bottom: 8px; font-size: 13px;">
              <div id="combinedTeamList" style="max-height: 150px; overflow-y: auto; border: 1px solid #ddd; border-radius: 4px; background: #fff;">
                <!-- Populated dynamically -->
              </div>
              <div id="selectedCombinedTeams" style="margin-top: 10px; display: flex; flex-wrap: wrap; gap: 6px;">
                <!-- Selected teams shown as chips -->
              </div>
            </div>
          </div>
          
          <!-- Row 8: Notes and Active -->
          <div style="display: grid; grid-template-columns: 1fr auto; gap: 15px; margin-bottom: 15px;">
            <div class="form-group">
              <label>Notes</label>
              <input type="text" id="teamNotes" placeholder="Internal notes...">
            </div>
            <div class="form-group">
              <label>&nbsp;</label>
              <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; padding: 10px 0;">
                <input type="checkbox" id="teamActive" checked>
                <span>Active</span>
              </label>
            </div>
          </div>
          
          <div style="display: flex; gap: 10px; justify-content: flex-end; padding-top: 15px; border-top: 1px solid #eee;">
            <button onclick="closeTeamModal()" style="background: #eee; border: none; padding: 12px 25px; border-radius: 5px; cursor: pointer; font-size: 14px;">Cancel</button>
            <button onclick="saveTeam()" style="background: #f57c00; color: white; border: none; padding: 12px 25px; border-radius: 5px; cursor: pointer; font-size: 14px; font-weight: 500;">Save Team</button>
          </div>
        </div>
      </div>
    </div>
    
    <!-- CSV Import Modal -->
    <div id="importModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 2000; overflow-y: auto;">
      <div style="max-width: 600px; margin: 30px auto; background: #fff; border-radius: 10px; overflow: hidden; box-shadow: 0 4px 20px rgba(0,0,0,0.3);">
        <div style="background: #1565c0; color: white; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center;">
          <h2 style="margin: 0; font-size: 16px; font-weight: 500;">Import Teams from CSV</h2>
          <button onclick="closeImportModal()" style="background: none; border: none; color: white; font-size: 24px; cursor: pointer; line-height: 1;">&times;</button>
        </div>
        
        <div style="padding: 20px;">
          <div style="background: #e3f2fd; padding: 15px; border-radius: 8px; margin-bottom: 20px; font-size: 13px;">
            <strong>Expected CSV columns:</strong><br>
            <code style="font-size: 11px; color: #1565c0;">full_name, shortname, abbrev, emoji, mascot, level, division, gender, location, conference, primary_color, primary_hex, secondary_color, secondary_hex, website, active</code>
            <br><br>
            <em>Required: full_name, shortname, abbrev, level</em>
          </div>
          
          <div style="border: 2px dashed #ddd; border-radius: 8px; padding: 40px 20px; text-align: center; margin-bottom: 20px; cursor: pointer;" id="dropZone" onclick="document.getElementById('csvFileInput').click()">
            <input type="file" id="csvFileInput" accept=".csv" style="display: none;" onchange="handleCsvFile(this.files[0])">
            <div style="font-size: 40px; margin-bottom: 10px;">ðŸ“„</div>
            <p style="color: #666; margin: 0;">Drop CSV file here or click to browse</p>
          </div>
          
          <div id="importPreview" style="display: none; margin-bottom: 20px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
              <strong id="importPreviewCount">0 teams ready to import</strong>
              <span style="font-size: 12px; color: #666;" id="importPreviewFile"></span>
            </div>
            <div style="max-height: 200px; overflow-y: auto; border: 1px solid #ddd; border-radius: 5px;">
              <table style="width: 100%; font-size: 12px; border-collapse: collapse;">
                <thead style="position: sticky; top: 0; background: #f5f5f5;">
                  <tr>
                    <th style="padding: 8px; text-align: left;">Short Name</th>
                    <th style="padding: 8px; text-align: left;">Full Name</th>
                    <th style="padding: 8px; text-align: left;">Level</th>
                    <th style="padding: 8px; text-align: left;">Division</th>
                  </tr>
                </thead>
                <tbody id="importPreviewBody"></tbody>
              </table>
            </div>
          </div>
          
          <div id="importResults" style="display: none; margin-bottom: 20px; padding: 15px; border-radius: 8px;"></div>
          
          <div style="display: flex; gap: 10px; justify-content: flex-end; padding-top: 15px; border-top: 1px solid #eee;">
            <button onclick="closeImportModal()" style="background: #eee; border: none; padding: 12px 25px; border-radius: 5px; cursor: pointer; font-size: 14px;">Cancel</button>
            <button onclick="executeImport()" id="btnExecuteImport" disabled style="background: #1565c0; color: white; border: none; padding: 12px 25px; border-radius: 5px; cursor: pointer; font-size: 14px; font-weight: 500;">Import Teams</button>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Game Story Modal -->
    <div id="gameStoryModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 1000; overflow-y: auto;">
      <div style="max-width: 550px; margin: 30px auto; background: #f5f5f5; border-radius: 10px; overflow: hidden; box-shadow: 0 4px 20px rgba(0,0,0,0.3);">
        
        <!-- Modal Header -->
        <div style="background: #444; color: white; padding: 12px 16px; display: flex; justify-content: space-between; align-items: center;">
          <h2 style="margin: 0; font-size: 15px; font-weight: 500;" id="gameStoryTitle">New Scorebook Story</h2>
          <button onclick="closeGameStory()" style="background: none; border: none; color: #ccc; font-size: 20px; cursor: pointer; line-height: 1;">&times;</button>
        </div>
        
        <!-- Step 1: Select Game -->
        <div id="gsStep1" style="padding: 16px;">
          <!-- Date Nav + Search + Gender -->
          <div style="display: flex; align-items: center; gap: 6px; margin-bottom: 12px;">
            <button onclick="gsPrevDay()" style="background: #fff; border: 1px solid #ccc; border-radius: 4px; padding: 6px 10px; cursor: pointer; font-size: 14px;">â—€</button>
            <div id="gsCurrentDate" style="font-size: 12px; font-weight: 600; min-width: 90px; text-align: center;"></div>
            <button onclick="gsNextDay()" style="background: #fff; border: 1px solid #ccc; border-radius: 4px; padding: 6px 10px; cursor: pointer; font-size: 14px;">â–¶</button>
            <input type="text" id="gsGameSearch" placeholder="Search..." oninput="filterGameList()" style="width: 70px; padding: 5px 6px; border: 1px solid #ccc; border-radius: 4px; font-size: 11px;">
            <div style="display: flex; gap: 6px; font-size: 11px; white-space: nowrap;">
              <label style="display: flex; align-items: center; gap: 2px; cursor: pointer;">
                <input type="radio" name="gsGender" value="Boys" checked onchange="filterGameList()"> Boys
              </label>
              <label style="display: flex; align-items: center; gap: 2px; cursor: pointer;">
                <input type="radio" name="gsGender" value="Girls" onchange="filterGameList()"> Girls
              </label>
              <label style="display: flex; align-items: center; gap: 2px; cursor: pointer;">
                <input type="radio" name="gsGender" value="Men" onchange="filterGameList()"> Men
              </label>
              <label style="display: flex; align-items: center; gap: 2px; cursor: pointer;">
                <input type="radio" name="gsGender" value="Women" onchange="filterGameList()"> Women
              </label>
            </div>
          </div>
          <div id="gsGameList" class="gs-game-list">
            <!-- Games populated here -->
          </div>
        </div>
        
        <!-- Step 2: Box Score Entry -->
        <div id="gsStep2" style="display: none; padding: 16px;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <button onclick="backToGameSelect()" style="background: #f5f5f5; border: none; padding: 8px 15px; border-radius: 6px; cursor: pointer;">â† Back</button>
            <h3 style="margin: 0; font-size: 16px; color: #333;" id="gsMatchupTitle">Game</h3>
            <div style="width: 80px;"></div>
          </div>
          
          <!-- Quarter Scores -->
          <div style="background: #fff; border: 1px solid #ddd; border-radius: 6px; padding: 12px; margin-bottom: 12px;">
            <span style="font-weight: 600; font-size: 12px; display: block; margin-bottom: 8px;">Quarter Scores</span>
            <table style="width: 100%; font-size: 12px; border-collapse: collapse;">
              <thead>
                <tr style="background: #f5f5f5;">
                  <th style="padding: 6px; text-align: left; width: 120px;">Team</th>
                  <th style="padding: 6px; width: 40px;">Q1</th>
                  <th style="padding: 6px; width: 40px;">Q2</th>
                  <th style="padding: 6px; width: 40px;">Q3</th>
                  <th style="padding: 6px; width: 40px;">Q4</th>
                  <th id="otHeaders" style="padding: 0;"></th>
                  <th style="padding: 6px; width: 40px;"><button onclick="addOT()" style="background: #e0e0e0; border: none; padding: 3px 6px; border-radius: 3px; cursor: pointer; font-size: 10px;">+OT</button></th>
                  <th style="padding: 6px; width: 50px;">Final</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td id="gsAwayName" style="padding: 6px; font-weight: 500;">Away</td>
                  <td><input type="text" id="gsAwayQ1" class="quarter-input" onchange="calcGameFinal('away')"></td>
                  <td><input type="text" id="gsAwayQ2" class="quarter-input" onchange="calcGameFinal('away')"></td>
                  <td><input type="text" id="gsAwayQ3" class="quarter-input" onchange="calcGameFinal('away')"></td>
                  <td><input type="text" id="gsAwayQ4" class="quarter-input" onchange="calcGameFinal('away')"></td>
                  <td id="gsAwayOT" style="padding: 0;"></td>
                  <td></td>
                  <td><input type="text" id="gsAwayFinal" class="quarter-input" style="background: #e8f5e9; font-weight: bold;" readonly></td>
                </tr>
                <tr>
                  <td id="gsHomeName" style="padding: 6px; font-weight: 500;">Home</td>
                  <td><input type="text" id="gsHomeQ1" class="quarter-input" onchange="calcGameFinal('home')"></td>
                  <td><input type="text" id="gsHomeQ2" class="quarter-input" onchange="calcGameFinal('home')"></td>
                  <td><input type="text" id="gsHomeQ3" class="quarter-input" onchange="calcGameFinal('home')"></td>
                  <td><input type="text" id="gsHomeQ4" class="quarter-input" onchange="calcGameFinal('home')"></td>
                  <td id="gsHomeOT" style="padding: 0;"></td>
                  <td></td>
                  <td><input type="text" id="gsHomeFinal" class="quarter-input" style="background: #e8f5e9; font-weight: bold;" readonly></td>
                </tr>
              </tbody>
            </table>
          </div>
          
          <!-- Team Rosters Stacked - Away (Road) on top -->
          <div style="margin-bottom: 15px;">
            <!-- Away Team -->
            <div style="background: #fff; border: 1px solid #ddd; border-radius: 6px; padding: 12px; margin-bottom: 12px;">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                <span style="font-weight: 600; font-size: 13px;" id="gsAwayLabel">Away</span>
                <span style="font-size: 11px; color: #666;">Pts: <strong id="gsAwayPtsTotal">0</strong> <span id="gsAwayMatch"></span></span>
              </div>
              <div style="display: grid; grid-template-columns: 1fr 45px 45px; gap: 5px; font-size: 10px; color: #888; margin-bottom: 5px; padding: 0 5px;">
                <span>Player</span>
                <span style="text-align: center;">Pts</span>
                <span style="text-align: center;">3FG</span>
              </div>
              <div id="gsAwayRoster">
                <!-- Roster rows -->
              </div>
              <button onclick="addBlankPlayer('away')" style="width: 100%; margin-top: 8px; background: #e0e0e0; border: none; padding: 6px; border-radius: 4px; cursor: pointer; font-size: 11px;">+ Add Player</button>
            </div>
            
            <!-- Home Team -->
            <div style="background: #fff; border: 1px solid #ddd; border-radius: 6px; padding: 12px;">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                <span style="font-weight: 600; font-size: 13px;" id="gsHomeLabel">Home</span>
                <span style="font-size: 11px; color: #666;">Pts: <strong id="gsHomePtsTotal">0</strong> <span id="gsHomeMatch"></span></span>
              </div>
              <div style="display: grid; grid-template-columns: 1fr 45px 45px; gap: 5px; font-size: 10px; color: #888; margin-bottom: 5px; padding: 0 5px;">
                <span>Player</span>
                <span style="text-align: center;">Pts</span>
                <span style="text-align: center;">3FG</span>
              </div>
              <div id="gsHomeRoster">
                <!-- Roster rows -->
              </div>
              <button onclick="addBlankPlayer('home')" style="width: 100%; margin-top: 8px; background: #e0e0e0; border: none; padding: 6px; border-radius: 4px; cursor: pointer; font-size: 11px;">+ Add Player</button>
            </div>
          </div>
          
          <!-- Notes -->
          <div style="margin-bottom: 12px;">
            <label style="font-size: 12px; font-weight: 600; color: #333; display: block; margin-bottom: 5px;">Game Notes (optional)</label>
            <textarea id="gsNotes" style="width: 100%; min-height: 50px; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 13px;" placeholder="Any storylines, key plays, milestones..."></textarea>
          </div>
          
          <!-- Photographers -->
          <div id="gsPhotographers" style="margin-bottom: 15px; padding: 10px 12px; background: #fff; border: 1px solid #ddd; border-radius: 6px; font-size: 12px; display: none;">
            <span style="color: #666; font-weight: 500;">ðŸ“· Photo Credit:</span>
            <div id="gsPhotogCheckboxes" style="margin-top: 8px;"></div>
          </div>
          
          <!-- Generate Button -->
          <button onclick="generateGameStory()" id="gsGenerateBtn" style="width: 100%; background: #444; color: white; border: none; padding: 15px; border-radius: 6px; font-size: 14px; font-weight: 600; cursor: pointer;">
            âœ¨ Generate Story
          </button>
        </div>
        
      </div>
    </div>
    
    <!-- Boxscore Story Modal (for collegiate games with full stats) -->
    <div id="boxscoreStoryModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 1000; overflow-y: auto;">
      <div style="max-width: 600px; margin: 30px auto; background: #f5f5f5; border-radius: 10px; overflow: hidden; box-shadow: 0 4px 20px rgba(0,0,0,0.3);">
        
        <!-- Modal Header -->
        <div style="background: #1565c0; color: white; padding: 12px 16px; display: flex; justify-content: space-between; align-items: center;">
          <h2 style="margin: 0; font-size: 15px; font-weight: 500;" id="boxscoreStoryTitle">New Boxscore Story</h2>
          <button onclick="closeBoxscoreStory()" style="background: none; border: none; color: #ccc; font-size: 20px; cursor: pointer; line-height: 1;">&times;</button>
        </div>
        
        <!-- Step 1: Select Game -->
        <div id="bsStep1" style="padding: 16px;">
          <!-- Date Nav + Search + Gender -->
          <div style="display: flex; align-items: center; gap: 6px; margin-bottom: 12px;">
            <button onclick="bsPrevDay()" style="background: #fff; border: 1px solid #ccc; border-radius: 4px; padding: 6px 10px; cursor: pointer; font-size: 14px;">â—€</button>
            <div id="bsCurrentDate" style="font-size: 12px; font-weight: 600; min-width: 90px; text-align: center;"></div>
            <button onclick="bsNextDay()" style="background: #fff; border: 1px solid #ccc; border-radius: 4px; padding: 6px 10px; cursor: pointer; font-size: 14px;">â–¶</button>
            <input type="text" id="bsGameSearch" placeholder="Search..." oninput="filterBsGameList()" style="width: 70px; padding: 5px 6px; border: 1px solid #ccc; border-radius: 4px; font-size: 11px;">
            <div style="display: flex; gap: 6px; font-size: 11px; white-space: nowrap;">
              <label style="display: flex; align-items: center; gap: 2px; cursor: pointer;">
                <input type="radio" name="bsGender" value="Boys" onchange="filterBsGameList()"> Boys
              </label>
              <label style="display: flex; align-items: center; gap: 2px; cursor: pointer;">
                <input type="radio" name="bsGender" value="Girls" onchange="filterBsGameList()"> Girls
              </label>
              <label style="display: flex; align-items: center; gap: 2px; cursor: pointer;">
                <input type="radio" name="bsGender" value="Men" checked onchange="filterBsGameList()"> Men
              </label>
              <label style="display: flex; align-items: center; gap: 2px; cursor: pointer;">
                <input type="radio" name="bsGender" value="Women" onchange="filterBsGameList()"> Women
              </label>
            </div>
          </div>
          <div id="bsGameList" class="gs-game-list">
            <!-- Games populated here -->
          </div>
        </div>
        
        <!-- Step 2: Paste Boxscore -->
        <div id="bsStep2" style="display: none; padding: 16px;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
            <button onclick="backToBsGameSelect()" style="background: #f5f5f5; border: none; padding: 8px 15px; border-radius: 6px; cursor: pointer;">â† Back</button>
            <h3 style="margin: 0; font-size: 16px; color: #333;" id="bsMatchupTitle">Game</h3>
            <div style="width: 80px;"></div>
          </div>
          
          <!-- Boxscore Paste Area -->
          <div style="margin-bottom: 15px;">
            <label style="font-size: 12px; font-weight: 600; color: #333; display: block; margin-bottom: 5px;">Paste Full Boxscore</label>
            <textarea id="bsBoxscoreText" style="width: 100%; min-height: 200px; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 12px; font-family: monospace; resize: vertical;" placeholder="Paste the complete boxscore here including:
- Team names and final score
- Quarter/half scores
- Individual player stats (MIN, FG, 3PT, FT, REB, AST, STL, BLK, TO, PTS)
- Team totals

Example:
TEAM A 75, Team B 68

Player        MIN  FG    3PT   FT    REB  AST  STL  BLK  TO  PTS
J. Smith      32   8-14  2-5   4-4   7    3    2    0    2   22
..."></textarea>
            <small style="color: #888; font-size: 11px;">Copy/paste from official box score. Include all available stats.</small>
          </div>
          
          <!-- Game Notes -->
          <div style="margin-bottom: 15px;">
            <label style="font-size: 12px; font-weight: 600; color: #333; display: block; margin-bottom: 5px;">Game Notes (optional)</label>
            <textarea id="bsNotes" style="width: 100%; min-height: 60px; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 13px;" placeholder="Any storylines, key plays, milestones, context..."></textarea>
          </div>
          
          <!-- Photographers -->
          <div id="bsPhotographers" style="margin-bottom: 15px; padding: 10px 12px; background: #fff; border: 1px solid #ddd; border-radius: 6px; font-size: 12px; display: none;">
            <span style="color: #666; font-weight: 500;">ðŸ“· Photo Credit:</span>
            <div id="bsPhotogCheckboxes" style="margin-top: 8px;"></div>
          </div>
          
          <!-- Generate Button -->
          <button onclick="generateBoxscoreStory()" id="bsGenerateBtn" style="width: 100%; background: #1565c0; color: white; border: none; padding: 15px; border-radius: 6px; font-size: 14px; font-weight: 600; cursor: pointer;">
            âœ¨ Generate Story
          </button>
        </div>
        
      </div>
    </div>
    
    <style>
      .quarter-input {
        width: 45px;
        padding: 6px;
        text-align: center;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 13px;
        -moz-appearance: textfield;
      }
      .quarter-input::-webkit-outer-spin-button,
      .quarter-input::-webkit-inner-spin-button {
        -webkit-appearance: none;
        margin: 0;
      }
      .roster-row {
        display: grid;
        grid-template-columns: 1fr 50px 50px;
        gap: 5px;
        margin-bottom: 4px;
        align-items: center;
      }
      .roster-row input {
        padding: 6px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 12px;
        -moz-appearance: textfield;
      }
      .roster-row input::-webkit-outer-spin-button,
      .roster-row input::-webkit-inner-spin-button {
        -webkit-appearance: none;
        margin: 0;
      }
      .roster-row .player-name {
        font-size: 12px;
        color: #333;
        padding: 6px;
        background: #fff;
        border-radius: 4px;
      }
      .roster-row input[type="text"] {
        text-align: center;
      }
      .game-row {
        padding: 12px 15px;
        border-bottom: 1px solid #eee;
        cursor: pointer;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      .game-row:hover {
        background: #f5f5f5;
      }
      .game-row-hover:hover {
        background: #e0e0e0;
      }
      .game-row .teams {
        font-size: 14px;
        font-weight: 500;
      }
      .game-row .meta {
        font-size: 12px;
        color: #888;
      }
      .gs-game-list {
        max-height: 350px;
        overflow-y: auto;
        background: #fff;
        border: 1px solid #ddd;
        border-radius: 6px;
        -ms-overflow-style: none;
        scrollbar-width: none;
      }
      .gs-game-list::-webkit-scrollbar {
        display: none;
      }
      .gs-roster-list {
        max-height: 250px;
        overflow-y: auto;
        -ms-overflow-style: none;
        scrollbar-width: none;
      }
      .gs-roster-list::-webkit-scrollbar {
        display: none;
      }
    </style>
    <!-- Article Editor Panel -->
    <div class="panel editor-panel" id="editorPanel">
      <div class="editor-header">
        <h2 id="editorTitle">New Article</h2>
        <div style="display: flex; flex-direction: column; align-items: flex-end; gap: 6px;">
          <div class="editor-actions">
            <button class="btn-back" onclick="closeEditor()">â† Back</button>
            <button class="btn-preview" onclick="openPreview()">ðŸ‘ Preview</button>
            <button class="btn-preview" onclick="saveAndPreviewSocial()" title="Save as draft and preview social posts">ðŸ“± Social</button>
            <button class="btn-preview" onclick="saveArticle()">Save Draft</button>
            <button class="btn-publish" onclick="publishArticle()">Publish</button>
          </div>
          <button onclick="openScheduleModal()" style="background: none; border: none; color: #666; font-size: 12px; cursor: pointer; padding: 2px 0;" id="scheduleBtn">
            ðŸ“… <span id="scheduleBtnText">Schedule for later</span>
          </button>
        </div>
      </div>
      
      <div class="form-grid">
        <div class="form-main">
          <div class="form-group">
            <label>Headline</label>
            <input type="text" id="articleTitle" placeholder="Enter headline...">
          </div>
          
          <!-- Featured Image -->
          <div class="form-group">
            <label>Featured Image</label>
            <div class="featured-image-container" id="featuredImageContainer" onclick="openFeaturedImageModal()">
              <div class="placeholder" id="featuredImagePlaceholder">
                <span>ðŸ“·</span>
                <div>Click to add featured image</div>
                <small style="color: #aaa;">Appears at top of article</small>
              </div>
              <div class="featured-image-preview" id="featuredImagePreview" style="display: none;">
                <img id="featuredImageImg" src="" alt="Featured">
                <button class="remove-btn" onclick="event.stopPropagation(); removeFeaturedImage()">Ã—</button>
                <div class="image-info" id="featuredImageInfo"></div>
              </div>
            </div>
            <input type="hidden" id="featuredImageUrl">
            <input type="hidden" id="featuredImageCaption">
          </div>
          
          <!-- Story Editor (Quill) -->
          <div class="form-group">
            <label>Story</label>
            <div id="quillToolbar">
              <span class="ql-formats">
                <select class="ql-header">
                  <option value="">Normal</option>
                  <option value="2">Heading</option>
                  <option value="3">Subheading</option>
                </select>
              </span>
              <span class="ql-formats">
                <button class="ql-bold"></button>
                <button class="ql-italic"></button>
                <button class="ql-underline"></button>
              </span>
              <span class="ql-formats">
                <button class="ql-list" value="ordered"></button>
                <button class="ql-list" value="bullet"></button>
              </span>
              <span class="ql-formats">
                <button class="ql-link"></button>
                <button class="ql-blockquote"></button>
              </span>
              <span class="ql-formats">
                <button class="ql-insertImage" title="Insert Image">ðŸ–¼ï¸</button>
              </span>
              <span class="ql-formats">
                <button class="ql-clean"></button>
              </span>
            </div>
            <div id="articleContent"></div>
          </div>
          
          <div class="form-group">
            <label>Excerpt</label>
            <textarea id="articleExcerpt" placeholder="Brief summary for previews..." style="min-height: 80px;"></textarea>
            <small>Used for social media and article previews</small>
          </div>
        </div>
        
        <div class="form-sidebar">
          <div class="sidebar-card">
            <h4>ðŸ“¸ Photo Gallery</h4>
            <div class="form-group">
              <label>SmugMug Gallery</label>
              <div style="display: flex; gap: 8px;">
                <input type="text" id="smugmugUrl" placeholder="https://ball603.smugmug.com/..." style="flex: 1;">
                <button type="button" class="btn-browse" onclick="openSmugMugBrowser()">Browse</button>
              </div>
              <div id="selectedAlbumPreview" style="margin-top: 8px; display: none;">
                <img id="albumThumbnail" style="width: 100%; border-radius: 4px; margin-bottom: 5px;">
                <small id="albumInfo" style="color: #666;"></small>
              </div>
            </div>
          </div>
          
          <div class="sidebar-card">
            <h4>ðŸŽ¥ Video</h4>
            <div class="form-group">
              <label>YouTube URL</label>
              <input type="text" id="youtubeUrl" placeholder="https://youtube.com/watch?v=...">
            </div>
          </div>
          
          <input type="hidden" id="selectedGameId">
          
          <div class="sidebar-card">
            <h4>âœï¸ Author</h4>
            <div class="form-group">
              <select id="articleAuthor" onchange="toggleOtherAuthor()">
                <option value="KJ Cardinal">KJ Cardinal</option>
                <option value="Ball603 Staff">Ball603 Staff</option>
                <option value="Guest Contributor">Guest Contributor</option>
                <option value="other">Other...</option>
              </select>
              <input type="text" id="articleAuthorOther" placeholder="Enter author name..." style="display: none; margin-top: 8px;">
            </div>
          </div>
          
          <div class="sidebar-card" id="socialPostsCard" style="display: none;">
            <h4>ðŸ“± Social Posts</h4>
            <button onclick="viewSocialPosts()" style="width: 100%; padding: 10px; background: #9c27b0; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 13px;">
              ðŸ“± View Social Posts
            </button>
            <small style="display: block; margin-top: 8px; color: #888;">Edit and copy social media posts</small>
          </div>
        </div>
      </div>
      
      <!-- Tags Section -->
      <div style="margin-top: 20px; padding: 15px; background: #f9f9f9; border-radius: 8px;">
        <h4 style="margin: 0 0 12px 0; font-size: 13px; font-weight: 600; color: #555;">ðŸ·ï¸ Tags</h4>
        <div id="tagsContainer" style="display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 10px;">
          <!-- Tags will be rendered here -->
        </div>
        <div style="display: flex; gap: 8px;">
          <input type="text" id="newTagInput" placeholder="Add custom tag..." style="flex: 1; padding: 8px 12px; border: 1px solid #ddd; border-radius: 5px; font-size: 13px;" onkeypress="if(event.key==='Enter'){event.preventDefault();addCustomTag();}">
          <button onclick="addCustomTag()" style="padding: 8px 15px; background: #f57c00; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 13px;">Add</button>
        </div>
        <small style="color: #999; font-size: 11px; margin-top: 8px; display: block;">Tags are auto-generated based on linked game. Click Ã— to remove.</small>
      </div>
    </div>
    
    <!-- Sponsors Panel -->
    <div class="panel" id="sponsorsPanel" style="display: none;">
      <div class="toolbar">
        <button class="btn-new" onclick="newSponsor()">
          <span>+</span> Add Sponsor
        </button>
      </div>
      <div id="sponsorList">
        <div class="empty-state">
          <p>No sponsors yet</p>
        </div>
      </div>
    </div>
    
    <!-- Contributors Panel -->
    <div class="panel" id="contributorsPanel" style="display: none;">
      <div class="toolbar" style="flex-wrap: wrap; gap: 10px;">
        <button class="btn-new" onclick="showCreateAccount()">
          <span>+</span> Create Account
        </button>
        <button onclick="bulkCreateAccounts()" style="background: #555; color: white; border: none; padding: 8px 16px; border-radius: 5px; cursor: pointer; font-size: 13px;">
          ðŸ‘¥ Create All Accounts
        </button>
        <button onclick="exportContributorsCSV()" style="background: #666; color: white; border: none; padding: 8px 16px; border-radius: 5px; cursor: pointer; font-size: 13px;">
          ðŸ“¥ Export CSV
        </button>
        <div style="margin-left: auto; display: flex; gap: 10px; flex-wrap: wrap;">
          <select id="contributorTypeFilter" onchange="filterContributors()" style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 5px; font-size: 14px;">
            <option value="all">All Types</option>
            <option value="photographer">Photographers</option>
            <option value="videographer">Videographers</option>
            <option value="writer">Writers</option>
            <option value="graphics">Graphics</option>
            <option value="administrative">Administrative</option>
          </select>
          <select id="contributorStatusFilter" onchange="filterContributors()" style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 5px; font-size: 14px;">
            <option value="active">Active</option>
            <option value="inactive">Inactive</option>
            <option value="all">All</option>
          </select>
          <input type="text" id="contributorSearch" placeholder="Search..." oninput="filterContributors()" style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 5px; font-size: 14px; width: 150px;">
        </div>
      </div>
      
      <!-- Email Lists -->
      <div style="background: #e3f2fd; border-radius: 8px; padding: 15px; margin-bottom: 20px;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
          <h4 style="margin: 0; font-size: 14px; color: #1565c0;">ðŸ“§ Email Lists</h4>
          <button onclick="toggleEmailLists()" id="emailListToggle" style="background: none; border: none; color: #1565c0; cursor: pointer; font-size: 12px;">Show Lists â–¼</button>
        </div>
        <div id="emailListsContainer" style="display: none;">
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px;">
            <div>
              <label style="font-size: 12px; font-weight: 600; color: #555; display: block; margin-bottom: 5px;">All Contributors</label>
              <textarea id="emailListAll" readonly style="width: 100%; height: 60px; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 11px; resize: none;"></textarea>
              <button onclick="copyEmailList('emailListAll')" style="margin-top: 5px; background: #1565c0; color: white; border: none; padding: 5px 10px; border-radius: 4px; font-size: 11px; cursor: pointer;">Copy</button>
            </div>
            <div>
              <label style="font-size: 12px; font-weight: 600; color: #555; display: block; margin-bottom: 5px;">Photographers Only</label>
              <textarea id="emailListPhotog" readonly style="width: 100%; height: 60px; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 11px; resize: none;"></textarea>
              <button onclick="copyEmailList('emailListPhotog')" style="margin-top: 5px; background: #1565c0; color: white; border: none; padding: 5px 10px; border-radius: 4px; font-size: 11px; cursor: pointer;">Copy</button>
            </div>
            <div>
              <label style="font-size: 12px; font-weight: 600; color: #555; display: block; margin-bottom: 5px;">Videographers Only</label>
              <textarea id="emailListVideog" readonly style="width: 100%; height: 60px; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 11px; resize: none;"></textarea>
              <button onclick="copyEmailList('emailListVideog')" style="margin-top: 5px; background: #1565c0; color: white; border: none; padding: 5px 10px; border-radius: 4px; font-size: 11px; cursor: pointer;">Copy</button>
            </div>
            <div>
              <label style="font-size: 12px; font-weight: 600; color: #555; display: block; margin-bottom: 5px;">Writers Only</label>
              <textarea id="emailListWriter" readonly style="width: 100%; height: 60px; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 11px; resize: none;"></textarea>
              <button onclick="copyEmailList('emailListWriter')" style="margin-top: 5px; background: #1565c0; color: white; border: none; padding: 5px 10px; border-radius: 4px; font-size: 11px; cursor: pointer;">Copy</button>
            </div>
            <div>
              <label style="font-size: 12px; font-weight: 600; color: #555; display: block; margin-bottom: 5px;">Graphics Only</label>
              <textarea id="emailListGraphics" readonly style="width: 100%; height: 60px; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 11px; resize: none;"></textarea>
              <button onclick="copyEmailList('emailListGraphics')" style="margin-top: 5px; background: #1565c0; color: white; border: none; padding: 5px 10px; border-radius: 4px; font-size: 11px; cursor: pointer;">Copy</button>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Contributors Count -->
      <div style="font-size: 13px; color: #666; margin-bottom: 10px;">
        <span id="contributorCount">0 contributors</span>
      </div>
      
      <!-- Contributors List -->
      <div class="article-list" id="contributorList">
        <div class="article-row header" style="grid-template-columns: 50px 1fr 150px 120px 100px 120px;">
          <div></div>
          <div>Name</div>
          <div>Type</div>
          <div>Area</div>
          <div>Status</div>
          <div>Actions</div>
        </div>
        <div class="loading">Loading contributors...</div>
      </div>
    </div>
    
    <!-- Contributor Edit Modal -->
    <div id="contributorModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 2000; overflow-y: auto;">
      <div style="max-width: 800px; margin: 30px auto; background: #fff; border-radius: 10px; overflow: hidden; box-shadow: 0 4px 20px rgba(0,0,0,0.3);">
        <div style="background: #9c27b0; color: white; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center;">
          <h2 style="margin: 0; font-size: 16px; font-weight: 500;" id="contributorModalTitle">Edit Contributor</h2>
          <button onclick="closeContributorModal()" style="background: none; border: none; color: white; font-size: 24px; cursor: pointer; line-height: 1;">&times;</button>
        </div>
        
        <div style="padding: 20px; max-height: 70vh; overflow-y: auto;">
          <input type="hidden" id="contributorId">
          
          <!-- Basic Info -->
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
            <div class="form-group">
              <label>Name *</label>
              <input type="text" id="contribName">
            </div>
            <div class="form-group">
              <label>Email *</label>
              <input type="email" id="contribEmail">
            </div>
            <div class="form-group">
              <label>Primary Area</label>
              <input type="text" id="contribPrimaryArea">
            </div>
            <div class="form-group">
              <label>Cell</label>
              <input type="text" id="contribCell">
            </div>
          </div>
          
          <div class="form-group" style="margin-bottom: 15px;">
            <label>Mailing Address</label>
            <input type="text" id="contribAddress">
          </div>
          
          <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin-bottom: 15px;">
            <div class="form-group">
              <label>Venmo</label>
              <input type="text" id="contribVenmo">
            </div>
            <div class="form-group">
              <label>Shirt Size</label>
              <select id="contribShirtSize">
                <option value="">Select...</option>
                <option value="XS">XS</option>
                <option value="S">S</option>
                <option value="M">M</option>
                <option value="L">L</option>
                <option value="XL">XL</option>
                <option value="2XL">2XL</option>
                <option value="3XL">3XL</option>
              </select>
            </div>
            <div class="form-group">
              <label>SmugMug Name</label>
              <input type="text" id="contribSmugmugName" placeholder="Name as shown in galleries">
            </div>
          </div>
          
          <!-- Contributor Types -->
          <div style="background: #f9f9f9; border-radius: 8px; padding: 15px; margin-bottom: 15px;">
            <label style="font-size: 13px; font-weight: 600; color: #555; display: block; margin-bottom: 10px;">Contributor Type(s)</label>
            <div style="display: flex; gap: 20px; flex-wrap: wrap;">
              <label style="display: flex; align-items: center; gap: 6px; cursor: pointer;">
                <input type="checkbox" id="contribIsPhotographer"> ðŸ“¸ Photographer
              </label>
              <label style="display: flex; align-items: center; gap: 6px; cursor: pointer;">
                <input type="checkbox" id="contribIsVideographer"> ðŸŽ¥ Videographer
              </label>
              <label style="display: flex; align-items: center; gap: 6px; cursor: pointer;">
                <input type="checkbox" id="contribIsWriter"> ðŸ“ Writer
              </label>
              <label style="display: flex; align-items: center; gap: 6px; cursor: pointer;">
                <input type="checkbox" id="contribIsGraphics"> ðŸŽ¨ Graphics
              </label>
              <label style="display: flex; align-items: center; gap: 6px; cursor: pointer;">
                <input type="checkbox" id="contribIsAdministrative"> ðŸ”§ Administrative
              </label>
            </div>
          </div>
          
          <!-- Admin Settings -->
          <div style="background: #fff3e0; border-radius: 8px; padding: 15px; margin-bottom: 15px;">
            <label style="font-size: 13px; font-weight: 600; color: #e65100; display: block; margin-bottom: 10px;">Admin Settings</label>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
              <div class="form-group">
                <label>Top-10 Dropbox URL</label>
                <input type="url" id="contribTop10Url" placeholder="https://dropbox.com/request/...">
              </div>
              <div class="form-group">
                <label>&nbsp;</label>
                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; padding: 10px 0;">
                  <input type="checkbox" id="contribActive" checked>
                  <span style="font-weight: 600;">Active Contributor</span>
                </label>
              </div>
            </div>
          </div>
          
          <!-- Auth Status -->
          <div id="contribAuthStatus" style="background: #e8f5e9; border-radius: 8px; padding: 15px; margin-bottom: 15px; display: none;">
            <label style="font-size: 13px; font-weight: 600; color: #2e7d32; display: block; margin-bottom: 5px;">âœ“ Account Created</label>
            <p style="font-size: 12px; color: #666; margin: 0;">This contributor has a login account.</p>
          </div>
          
          <!-- Save -->
          <div style="display: flex; justify-content: space-between; align-items: center; padding-top: 15px; border-top: 1px solid #eee;">
            <button onclick="deleteContributor()" id="deleteContribBtn" style="background: #ffebee; color: #c62828; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-size: 13px;">
              ðŸ—‘ï¸ Delete
            </button>
            <div style="display: flex; gap: 10px;">
              <button onclick="closeContributorModal()" style="background: #eee; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">Cancel</button>
              <button onclick="saveContributor()" style="background: #f57c00; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-weight: 500;">Save</button>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Create Account Modal -->
    <div id="createAccountModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 2000; overflow-y: auto;">
      <div style="max-width: 500px; margin: 100px auto; background: #fff; border-radius: 10px; overflow: hidden; box-shadow: 0 4px 20px rgba(0,0,0,0.3);">
        <div style="background: #555; color: white; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center;">
          <h2 style="margin: 0; font-size: 16px; font-weight: 500;">Create Contributor Account</h2>
          <button onclick="closeCreateAccountModal()" style="background: none; border: none; color: white; font-size: 24px; cursor: pointer; line-height: 1;">&times;</button>
        </div>
        
        <div style="padding: 20px;">
          <p style="font-size: 13px; color: #666; margin-bottom: 20px;">Create a new contributor account with login credentials.</p>
          
          <div class="form-group" style="margin-bottom: 15px;">
            <label>Full Name *</label>
            <input type="text" id="createName">
          </div>
          <div class="form-group" style="margin-bottom: 15px;">
            <label>Email Address *</label>
            <input type="email" id="createEmail">
          </div>
          <div class="form-group" style="margin-bottom: 15px;">
            <label>Password *</label>
            <input type="text" id="createPassword" value="Gr@niteSt@teHoops">
          </div>
          
          <div style="display: flex; justify-content: flex-end; gap: 10px;">
            <button onclick="closeCreateAccountModal()" style="background: #eee; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">Cancel</button>
            <button onclick="createAccount()" style="background: #555; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-weight: 500;">Create Account</button>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Products Panel -->
    <div class="panel" id="productsPanel" style="display: none;">
      <div class="toolbar">
        <button class="btn-new" onclick="newProduct()">
          <span>+</span> Add Product
        </button>
      </div>
      <div id="productList">
        <div class="empty-state">
          <p>No products yet</p>
        </div>
      </div>
    </div>
    
    <!-- Social Publishing Panel -->
    <div class="panel" id="socialPublishingPanel" style="display: none;">
      <div class="editor-header">
        <h2>ðŸ“± Social Media Posts</h2>
        <div class="editor-actions">
          <button class="btn-back" onclick="closeSocialPublishing()">â† Done</button>
        </div>
      </div>
      
      <p style="color: #666; margin-bottom: 20px;">Your article has been published! Edit and copy these posts for social media.</p>
      
      <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px;">
        <!-- Facebook -->
        <div class="sidebar-card" style="background: #fff; border: 2px solid #1877f2;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
            <h4 style="color: #1877f2; margin: 0;">ðŸ“˜ Facebook</h4>
            <button onclick="copySocialPost('facebook')" style="background: #1877f2; color: #fff; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 12px;">Copy</button>
          </div>
          <textarea id="socialFacebookPost" style="width: 100%; min-height: 300px; border: 1px solid #ddd; border-radius: 6px; padding: 10px; font-size: 13px; line-height: 1.5; resize: vertical; font-family: inherit;"></textarea>
          <div style="margin-top: 8px; font-size: 11px; color: #888;">
            <span id="fbCharCount">0</span> characters
          </div>
        </div>
        
        <!-- Instagram -->
        <div class="sidebar-card" style="background: #fff; border: 2px solid #e1306c;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
            <h4 style="color: #e1306c; margin: 0;">ðŸ“¸ Instagram</h4>
            <button onclick="copySocialPost('instagram')" style="background: linear-gradient(45deg, #f09433, #e6683c, #dc2743, #cc2366, #bc1888); color: #fff; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 12px;">Copy</button>
          </div>
          <textarea id="socialInstagramPost" style="width: 100%; min-height: 300px; border: 1px solid #ddd; border-radius: 6px; padding: 10px; font-size: 13px; line-height: 1.5; resize: vertical; font-family: inherit;"></textarea>
          <div style="margin-top: 8px; font-size: 11px; color: #888;">
            <span id="igCharCount">0</span> / 2,200 characters
          </div>
        </div>
        
        <!-- Twitter -->
        <div class="sidebar-card" style="background: #fff; border: 2px solid #000;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
            <h4 style="color: #000; margin: 0;">ð• Twitter</h4>
            <button onclick="copySocialPost('twitter')" style="background: #000; color: #fff; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 12px;">Copy</button>
          </div>
          <textarea id="socialTwitterPost" style="width: 100%; min-height: 300px; border: 1px solid #ddd; border-radius: 6px; padding: 10px; font-size: 13px; line-height: 1.5; resize: vertical; font-family: inherit;"></textarea>
          <div style="margin-top: 8px; font-size: 11px;">
            <span id="twCharCount" style="color: #888;">0</span><span style="color: #888;"> / 280 characters</span>
          </div>
        </div>
      </div>
      
      <div style="margin-top: 20px; padding: 15px; background: #f5f5f5; border-radius: 8px;">
        <p style="margin: 0; font-size: 13px; color: #666;">
          ðŸ’¡ <strong>Tip:</strong> Copy each post, then paste into Hootsuite. Select your images from your photo gallery and schedule or post.
        </p>
      </div>
    </div>
  </div>
  
  <!-- Toast -->
  <div class="toast" id="toast"></div>
  
  <!-- SmugMug Browser Modal -->
  <div class="modal-overlay" id="smugmugModal">
    <div class="modal">
      <div class="modal-header">
        <h3>ðŸ“¸ Select SmugMug Gallery</h3>
        <button class="modal-close" onclick="closeSmugMugBrowser()">&times;</button>
      </div>
      <div class="modal-search">
        <input type="text" id="albumSearch" placeholder="Search albums..." oninput="searchAlbums(this.value)">
      </div>
      <div class="modal-body">
        <div class="album-grid" id="albumGrid">
          <div class="loading">Loading albums...</div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn-modal btn-modal-cancel" onclick="closeSmugMugBrowser()">Cancel</button>
        <button class="btn-modal btn-modal-select" id="btnSelectAlbum" onclick="selectSmugMugAlbum()" disabled>Select Album</button>
      </div>
    </div>
  </div>

  <!-- Featured Image Modal -->
  <div class="modal-overlay" id="featuredImageModal">
    <div class="modal image-modal">
      <div class="modal-header">
        <h3>ðŸ“· Featured Image</h3>
        <button class="modal-close" onclick="closeFeaturedImageModal()">&times;</button>
      </div>
      <div class="modal-body" style="padding: 20px;">
        <!-- Upload Section -->
        <div class="form-group">
          <label>Upload Image</label>
          <div style="display: flex; gap: 10px; align-items: center;">
            <input type="file" id="featuredImageFile" accept="image/*" onchange="handleFeaturedImageUpload(this)" style="flex: 1;">
            <span id="featuredUploadStatus" style="font-size: 12px; color: #888;"></span>
          </div>
        </div>
        <div style="text-align: center; color: #999; font-size: 12px; margin: 10px 0;">â€” or â€”</div>
        <div class="form-group">
          <label>Image URL</label>
          <input type="text" id="featuredImageUrlInput" placeholder="https://...">
          <small>Paste URL from SmugMug or elsewhere</small>
        </div>
        <div class="form-group">
          <label>Caption (optional)</label>
          <input type="text" id="featuredImageCaptionInput" placeholder="Photo caption...">
        </div>
        <div id="featuredImagePreviewBox" style="margin-top: 15px; display: none;">
          <img id="featuredImagePreviewImg" style="width: 100%; max-height: 200px; object-fit: cover; border-radius: 6px;">
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn-modal btn-modal-cancel" onclick="closeFeaturedImageModal()">Cancel</button>
        <button class="btn-modal btn-modal-select" onclick="saveFeaturedImage()">Save</button>
      </div>
    </div>
  </div>

  <!-- Insert Image Modal -->
  <div class="modal-overlay" id="insertImageModal">
    <div class="modal image-modal">
      <div class="modal-header">
        <h3>ðŸ–¼ï¸ Insert Image</h3>
        <button class="modal-close" onclick="closeInsertImageModal()">&times;</button>
      </div>
      <div class="modal-body" style="padding: 20px;">
        <!-- Upload Section -->
        <div class="form-group">
          <label>Upload Image</label>
          <div style="display: flex; gap: 10px; align-items: center;">
            <input type="file" id="insertImageFile" accept="image/*" onchange="handleInsertImageUpload(this)" style="flex: 1;">
            <span id="insertUploadStatus" style="font-size: 12px; color: #888;"></span>
          </div>
        </div>
        <div style="text-align: center; color: #999; font-size: 12px; margin: 10px 0;">â€” or â€”</div>
        <div class="form-group">
          <label>Image URL</label>
          <input type="text" id="insertImageUrl" placeholder="https://...">
        </div>
        <div class="form-group">
          <label>Caption (optional)</label>
          <input type="text" id="insertImageCaption" placeholder="Photo caption...">
        </div>
        <div class="form-group">
          <label>Link To (optional)</label>
          <input type="text" id="insertImageLink" placeholder="https://...">
          <label style="margin-top: 8px; display: flex; align-items: center; gap: 8px; font-weight: normal; cursor: pointer;">
            <input type="checkbox" id="insertImageNewWindow">
            <span>Open in new window</span>
          </label>
        </div>
        <div class="form-group">
          <label>Alignment</label>
          <div class="alignment-options">
            <label><input type="radio" name="imageAlign" value="left"><span>â¬…ï¸ Left</span></label>
            <label><input type="radio" name="imageAlign" value="center" checked><span>â†”ï¸ Center</span></label>
            <label><input type="radio" name="imageAlign" value="right"><span>âž¡ï¸ Right</span></label>
          </div>
        </div>
        <div class="form-group">
          <label>Size</label>
          <div class="size-options">
            <label><input type="radio" name="imageSize" value="small"><span>Small</span></label>
            <label><input type="radio" name="imageSize" value="medium" checked><span>Medium</span></label>
            <label><input type="radio" name="imageSize" value="full"><span>Full</span></label>
          </div>
        </div>
        <div id="insertImagePreviewBox" style="margin-top: 15px; display: none;">
          <img id="insertImagePreviewImg" style="max-width: 100%; max-height: 150px; border-radius: 6px;">
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn-modal btn-modal-cancel" onclick="closeInsertImageModal()">Cancel</button>
        <button class="btn-modal btn-modal-select" onclick="insertImageToEditor()">Insert</button>
      </div>
    </div>
  </div>

  <!-- Image Cropper Modal -->
  <div class="modal-overlay" id="cropperModal">
    <div class="modal cropper-modal-content">
      <div class="modal-header">
        <h3>âœ‚ï¸ Crop Image</h3>
        <button class="modal-close" onclick="closeCropperModal()">&times;</button>
      </div>
      <div class="modal-body" style="padding: 20px;">
        <div class="crop-aspect-buttons">
          <button onclick="setCropAspect(NaN)" class="active" id="aspectFree">Free</button>
          <button onclick="setCropAspect(16/9)" id="aspect169">16:9</button>
          <button onclick="setCropAspect(4/3)" id="aspect43">4:3</button>
          <button onclick="setCropAspect(1)" id="aspect11">1:1</button>
          <button onclick="setCropAspect(3/4)" id="aspect34">3:4</button>
          <button onclick="setCropAspect(9/16)" id="aspect916">9:16</button>
        </div>
        <div class="cropper-container-wrapper">
          <img id="cropperImage" src="" alt="Crop preview">
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn-modal btn-modal-cancel" onclick="closeCropperModal()">Cancel</button>
        <button class="btn-modal btn-modal-select" onclick="applyCrop()">Apply Crop</button>
      </div>
    </div>
  </div>

  <!-- Schedule Modal -->
  <div class="modal-overlay" id="scheduleModal">
    <div class="modal" style="max-width: 400px;">
      <div class="modal-header">
        <h3>ðŸ“… Schedule Publication</h3>
        <button class="modal-close" onclick="closeScheduleModal()">&times;</button>
      </div>
      <div class="modal-body" style="padding: 20px;">
        <div class="form-group">
          <label style="font-weight: 600; margin-bottom: 8px; display: block;">Publish Date & Time</label>
          <input type="datetime-local" id="scheduledDateTime" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
        </div>
        <p style="font-size: 12px; color: #666; margin-top: 12px;">
          The article will be automatically published at the scheduled time.
        </p>
      </div>
      <div class="modal-footer">
        <button class="btn-modal btn-modal-cancel" onclick="clearSchedule()">Clear Schedule</button>
        <button class="btn-modal btn-modal-select" onclick="setSchedule()">Set Schedule</button>
      </div>
    </div>
  </div>

  <!-- Preview Modal -->
  <div class="modal-overlay" id="previewModal">
    <div class="modal" style="max-width: 1000px; max-height: 90vh;">
      <div class="modal-header">
        <h3>ðŸ‘ Article Preview</h3>
        <button class="modal-close" onclick="closePreview()">&times;</button>
      </div>
      <div class="modal-body" style="padding: 0;">
        <div style="display: flex; height: calc(90vh - 120px);">
          <!-- Article Preview -->
          <div style="flex: 1; padding: 20px; overflow-y: auto; border-right: 1px solid #eee;">
            <h4 style="font-size: 12px; color: #888; margin-bottom: 15px; text-transform: uppercase;">Article</h4>
            <div id="previewFeaturedImage" style="display: none; margin-bottom: 20px;">
              <img id="previewFeaturedImg" src="" alt="Featured" style="width: 100%; aspect-ratio: 16/9; object-fit: cover; border-radius: 8px;">
              <p id="previewFeaturedCaption" style="font-size: 13px; color: #666; font-style: italic; margin-top: 8px; text-align: center;"></p>
            </div>
            <h1 id="previewHeadline" style="font-size: 24px; margin-bottom: 10px; line-height: 1.3;"></h1>
            <p id="previewExcerpt" style="font-size: 14px; color: #666; font-style: italic; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid #eee;"></p>
            <div id="previewContent" style="font-size: 15px; line-height: 1.7;"></div>
          </div>
          <!-- Social Preview -->
          <div style="width: 350px; padding: 20px; overflow-y: auto; background: #f9f9f9;">
            <h4 style="font-size: 12px; color: #888; margin-bottom: 15px; text-transform: uppercase;">Social Media Posts</h4>
            
            <div style="margin-bottom: 20px;">
              <div style="font-size: 12px; font-weight: 600; color: #1877f2; margin-bottom: 8px;">ðŸ“˜ Facebook</div>
              <div id="previewFacebook" style="background: #fff; padding: 12px; border-radius: 8px; font-size: 13px; line-height: 1.5; white-space: pre-wrap; border: 1px solid #ddd;"></div>
            </div>
            
            <div style="margin-bottom: 20px;">
              <div style="font-size: 12px; font-weight: 600; color: #e1306c; margin-bottom: 8px;">ðŸ“¸ Instagram</div>
              <div id="previewInstagram" style="background: #fff; padding: 12px; border-radius: 8px; font-size: 13px; line-height: 1.5; white-space: pre-wrap; border: 1px solid #ddd;"></div>
            </div>
            
            <div style="margin-bottom: 20px;">
              <div style="font-size: 12px; font-weight: 600; color: #000; margin-bottom: 8px;">ð• Twitter</div>
              <div id="previewTwitter" style="background: #fff; padding: 12px; border-radius: 8px; font-size: 13px; line-height: 1.5; white-space: pre-wrap; border: 1px solid #ddd;"></div>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn-modal btn-modal-cancel" onclick="closePreview()">Close</button>
        <button class="btn-modal btn-modal-select" onclick="closePreview(); publishArticle();">Publish Now</button>
      </div>
    </div>
  </div>

  <script src="rosters_data.js"></script>
  <script>
    // Supabase config
    const SUPABASE_URL = 'https://suncdkxfqkwwnmhosxcf.supabase.co';
    const SUPABASE_ANON_KEY = 'sb_publishable_hHSpgZPD327r11GaQG9iHw_uZbuaWmF';
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    
    // CMS Password
    const CMS_PASSWORD = 'Gr@niteSt@teHoops';
    
    // State
    let articles = [];
    let games = [];
    let currentArticle = null;
    let selectedGame = null;
    
    // Generated social posts (populated by story generators)
    let generatedSocialPosts = {
      facebookPost: null,
      instagramPost: null,
      twitterPost: null
    };
    
    // Quill Editor
    let quillEditor = null;
    
    function initQuillEditor() {
      if (quillEditor) return; // Already initialized
      
      // Custom image insert button handler
      const insertImageHandler = function() {
        openInsertImageModal();
      };
      
      quillEditor = new Quill('#articleContent', {
        theme: 'snow',
        modules: {
          toolbar: {
            container: '#quillToolbar',
            handlers: {
              'insertImage': insertImageHandler
            }
          }
        },
        placeholder: 'Write your article...'
      });
      
      // Add custom button styling
      const insertBtn = document.querySelector('.ql-insertImage');
      if (insertBtn) {
        insertBtn.innerHTML = 'ðŸ–¼ï¸';
        insertBtn.style.width = 'auto';
        insertBtn.style.padding = '0 8px';
      }
    }
    
    // Featured Image Functions
    function openFeaturedImageModal() {
      const currentUrl = document.getElementById('featuredImageUrl').value;
      const currentCaption = document.getElementById('featuredImageCaption').value;
      
      document.getElementById('featuredImageUrlInput').value = currentUrl || '';
      document.getElementById('featuredImageCaptionInput').value = currentCaption || '';
      document.getElementById('featuredImageFile').value = ''; // Reset file input
      document.getElementById('featuredUploadStatus').textContent = ''; // Reset status
      
      if (currentUrl) {
        document.getElementById('featuredImagePreviewImg').src = currentUrl;
        document.getElementById('featuredImagePreviewBox').style.display = 'block';
      } else {
        document.getElementById('featuredImagePreviewBox').style.display = 'none';
      }
      
      document.getElementById('featuredImageModal').classList.add('open');
      
      // Preview on URL input
      document.getElementById('featuredImageUrlInput').oninput = function() {
        const url = this.value.trim();
        if (url) {
          document.getElementById('featuredImagePreviewImg').src = url;
          document.getElementById('featuredImagePreviewBox').style.display = 'block';
        } else {
          document.getElementById('featuredImagePreviewBox').style.display = 'none';
        }
      };
    }
    
    function closeFeaturedImageModal() {
      document.getElementById('featuredImageModal').classList.remove('open');
    }
    
    function saveFeaturedImage() {
      const url = document.getElementById('featuredImageUrlInput').value.trim();
      const caption = document.getElementById('featuredImageCaptionInput').value.trim();
      
      document.getElementById('featuredImageUrl').value = url;
      document.getElementById('featuredImageCaption').value = caption;
      
      if (url) {
        document.getElementById('featuredImageContainer').classList.add('has-image');
        document.getElementById('featuredImagePlaceholder').style.display = 'none';
        document.getElementById('featuredImagePreview').style.display = 'block';
        document.getElementById('featuredImageImg').src = url;
        document.getElementById('featuredImageInfo').textContent = caption || 'No caption';
      } else {
        removeFeaturedImage();
      }
      
      closeFeaturedImageModal();
    }
    
    function removeFeaturedImage() {
      document.getElementById('featuredImageUrl').value = '';
      document.getElementById('featuredImageCaption').value = '';
      document.getElementById('featuredImageContainer').classList.remove('has-image');
      document.getElementById('featuredImagePlaceholder').style.display = 'block';
      document.getElementById('featuredImagePreview').style.display = 'none';
    }
    
    // Inline Image Insert Functions
    function openInsertImageModal() {
      document.getElementById('insertImageUrl').value = '';
      document.getElementById('insertImageCaption').value = '';
      document.getElementById('insertImageLink').value = '';
      document.getElementById('insertImageNewWindow').checked = false;
      document.querySelector('input[name="imageAlign"][value="center"]').checked = true;
      document.querySelector('input[name="imageSize"][value="medium"]').checked = true;
      document.getElementById('insertImagePreviewBox').style.display = 'none';
      document.getElementById('insertImageFile').value = ''; // Reset file input
      document.getElementById('insertUploadStatus').textContent = ''; // Reset status
      
      document.getElementById('insertImageModal').classList.add('open');
      
      // Preview on URL input
      document.getElementById('insertImageUrl').oninput = function() {
        const url = this.value.trim();
        if (url) {
          document.getElementById('insertImagePreviewImg').src = url;
          document.getElementById('insertImagePreviewBox').style.display = 'block';
        } else {
          document.getElementById('insertImagePreviewBox').style.display = 'none';
        }
      };
    }
    
    function closeInsertImageModal() {
      document.getElementById('insertImageModal').classList.remove('open');
    }
    
    function insertImageToEditor() {
      const url = document.getElementById('insertImageUrl').value.trim();
      if (!url) {
        showToast('Please enter an image URL', 'error');
        return;
      }
      
      const caption = document.getElementById('insertImageCaption').value.trim();
      const link = document.getElementById('insertImageLink').value.trim();
      const newWindow = document.getElementById('insertImageNewWindow').checked;
      const align = document.querySelector('input[name="imageAlign"]:checked').value;
      const size = document.querySelector('input[name="imageSize"]:checked').value;
      
      // Build the HTML for the image block
      let imgHtml = `<img src="${url}" alt="${caption || 'Article image'}">`;
      
      if (link) {
        const target = newWindow ? ' target="_blank" rel="noopener"' : '';
        imgHtml = `<a href="${link}"${target}>${imgHtml}</a>`;
      }
      
      let captionHtml = caption ? `<div class="caption">${caption}</div>` : '';
      
      const imageBlock = `<div class="article-image align-${align} size-${size}" contenteditable="false">${imgHtml}${captionHtml}</div><p><br></p>`;
      
      // Insert at cursor position in Quill
      const range = quillEditor.getSelection(true);
      quillEditor.clipboard.dangerouslyPasteHTML(range.index, imageBlock);
      
      closeInsertImageModal();
      showToast('Image inserted!', 'success');
    }
    
    // Helper to get Quill content as HTML
    function getEditorContent() {
      if (quillEditor) {
        return quillEditor.root.innerHTML;
      }
      return '';
    }
    
    // Helper to set Quill content from HTML
    function setEditorContent(html) {
      if (quillEditor) {
        if (html) {
          quillEditor.root.innerHTML = html;
        } else {
          quillEditor.setText('');
        }
      }
    }
    
    // Helper to get plain text from Quill (for excerpts, social posts)
    function getEditorPlainText() {
      if (quillEditor) {
        return quillEditor.getText().trim();
      }
      return '';
    }
    
    // Author "Other" toggle
    function toggleOtherAuthor() {
      const select = document.getElementById('articleAuthor');
      const otherInput = document.getElementById('articleAuthorOther');
      
      if (select.value === 'other') {
        otherInput.style.display = 'block';
        otherInput.focus();
      } else {
        otherInput.style.display = 'none';
        otherInput.value = '';
      }
    }
    
    // Get the actual author value (handles "other" option)
    function getAuthorValue() {
      const select = document.getElementById('articleAuthor');
      if (select.value === 'other') {
        return document.getElementById('articleAuthorOther').value.trim() || 'Guest Contributor';
      }
      return select.value;
    }
    
    // Set author value (handles custom names)
    function setAuthorValue(author) {
      const select = document.getElementById('articleAuthor');
      const otherInput = document.getElementById('articleAuthorOther');
      
      // Check if author matches one of the preset options
      const options = Array.from(select.options).map(o => o.value);
      if (options.includes(author) && author !== 'other') {
        select.value = author;
        otherInput.style.display = 'none';
        otherInput.value = '';
      } else {
        // Custom author - select "other" and fill in the name
        select.value = 'other';
        otherInput.style.display = 'block';
        otherInput.value = author || '';
      }
    }
    
    // Image Upload to Supabase Storage
    async function uploadImageToSupabase(file, folder = 'articles') {
      const timestamp = Date.now();
      const safeName = file.name.replace(/[^a-zA-Z0-9.-]/g, '_');
      const filePath = `${folder}/${timestamp}-${safeName}`;
      
      const { data, error } = await supabase.storage
        .from('images')
        .upload(filePath, file, {
          cacheControl: '3600',
          upsert: false
        });
      
      if (error) {
        console.error('Upload error:', error);
        throw error;
      }
      
      // Get public URL
      const { data: urlData } = supabase.storage
        .from('images')
        .getPublicUrl(filePath);
      
      return urlData.publicUrl;
    }
    
    // Featured Image Upload Handler
    // Cropper state
    let cropper = null;
    let cropperCallback = null;
    let currentCropFile = null;
    let currentCropFolder = 'articles';
    let currentCropStatusEl = null;
    let currentCropUrlInput = null;
    let currentCropPreviewImg = null;
    let currentCropPreviewBox = null;
    
    function openCropperModal(file, folder, statusEl, urlInput, previewImg, previewBox) {
      currentCropFile = file;
      currentCropFolder = folder;
      currentCropStatusEl = statusEl;
      currentCropUrlInput = urlInput;
      currentCropPreviewImg = previewImg;
      currentCropPreviewBox = previewBox;
      
      // Create object URL for the image
      const imageUrl = URL.createObjectURL(file);
      const cropperImage = document.getElementById('cropperImage');
      cropperImage.src = imageUrl;
      
      // Destroy existing cropper if any
      if (cropper) {
        cropper.destroy();
        cropper = null;
      }
      
      document.getElementById('cropperModal').classList.add('open');
      
      // Initialize cropper after image loads
      cropperImage.onload = function() {
        cropper = new Cropper(cropperImage, {
          viewMode: 2,
          autoCropArea: 1,
          responsive: true,
          background: false
        });
      };
      
      // Reset aspect buttons
      document.querySelectorAll('.crop-aspect-buttons button').forEach(b => b.classList.remove('active'));
      document.getElementById('aspectFree').classList.add('active');
    }
    
    function closeCropperModal() {
      document.getElementById('cropperModal').classList.remove('open');
      if (cropper) {
        cropper.destroy();
        cropper = null;
      }
      // Revoke object URL
      const cropperImage = document.getElementById('cropperImage');
      if (cropperImage.src.startsWith('blob:')) {
        URL.revokeObjectURL(cropperImage.src);
      }
    }
    
    function setCropAspect(ratio) {
      if (cropper) {
        cropper.setAspectRatio(ratio);
      }
      // Update button states
      document.querySelectorAll('.crop-aspect-buttons button').forEach(b => b.classList.remove('active'));
      event.target.classList.add('active');
    }
    
    async function applyCrop() {
      if (!cropper) return;
      
      const statusEl = currentCropStatusEl;
      statusEl.textContent = 'Processing...';
      statusEl.style.color = '#f57c00';
      
      try {
        // Get cropped canvas
        const canvas = cropper.getCroppedCanvas({
          maxWidth: 2000,
          maxHeight: 2000
        });
        
        // Convert to blob
        const blob = await new Promise(resolve => {
          canvas.toBlob(resolve, 'image/jpeg', 0.9);
        });
        
        // Create file from blob
        const croppedFile = new File([blob], currentCropFile.name.replace(/\.[^/.]+$/, '.jpg'), {
          type: 'image/jpeg'
        });
        
        statusEl.textContent = 'Uploading...';
        
        // Upload
        const url = await uploadImageToSupabase(croppedFile, currentCropFolder);
        
        // Update the appropriate fields
        document.getElementById(currentCropUrlInput).value = url;
        document.getElementById(currentCropPreviewImg).src = url;
        document.getElementById(currentCropPreviewBox).style.display = 'block';
        
        statusEl.textContent = 'âœ“ Uploaded';
        statusEl.style.color = '#4CAF50';
        
        closeCropperModal();
        showToast('Image cropped and uploaded!', 'success');
        
      } catch (err) {
        console.error('Crop/upload failed:', err);
        statusEl.textContent = 'âœ— Failed';
        statusEl.style.color = '#f44336';
        showToast('Image processing failed', 'error');
      }
    }
    
    // Featured Image Upload Handler - Opens Cropper
    function handleFeaturedImageUpload(input) {
      const file = input.files[0];
      if (!file) return;
      
      openCropperModal(
        file,
        'featured',
        document.getElementById('featuredUploadStatus'),
        'featuredImageUrlInput',
        'featuredImagePreviewImg',
        'featuredImagePreviewBox'
      );
    }
    
    // Insert Image Upload Handler - Opens Cropper
    function handleInsertImageUpload(input) {
      const file = input.files[0];
      if (!file) return;
      
      openCropperModal(
        file,
        'articles',
        document.getElementById('insertUploadStatus'),
        'insertImageUrl',
        'insertImagePreviewImg',
        'insertImagePreviewBox'
      );
    }
    
    // Login
    function login() {
      const password = document.getElementById('loginPassword').value;
      if (password === CMS_PASSWORD) {
        sessionStorage.setItem('cms_auth', 'true');
        showApp();
      } else {
        document.getElementById('loginError').textContent = 'Incorrect password';
        document.getElementById('loginError').style.display = 'block';
      }
    }
    
    function logout() {
      sessionStorage.removeItem('cms_auth');
      location.reload();
    }
    
    function showApp() {
      document.getElementById('loginScreen').style.display = 'none';
      document.getElementById('mainHeader').style.display = 'block';
      document.getElementById('mainContainer').style.display = 'block';
      loadArticles();
      loadGamesForStory();
      
      // Initialize Quill editor
      setTimeout(() => {
        initQuillEditor();
      }, 100);
    }
    
    // Check auth on load
    if (sessionStorage.getItem('cms_auth') === 'true') {
      showApp();
    }
    
    // Tabs
    function showTab(tab) {
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      event.target.classList.add('active');
      
      document.getElementById('articlesPanel').style.display = tab === 'articles' ? 'block' : 'none';
      document.getElementById('schedulePanel').style.display = tab === 'schedule' ? 'block' : 'none';
      document.getElementById('teamsPanel').style.display = tab === 'teams' ? 'block' : 'none';
      document.getElementById('contributorsPanel').style.display = tab === 'contributors' ? 'block' : 'none';
      document.getElementById('sponsorsPanel').style.display = tab === 'sponsors' ? 'block' : 'none';
      document.getElementById('productsPanel').style.display = tab === 'products' ? 'block' : 'none';
      document.getElementById('editorPanel').style.display = 'none';
      
      // Load teams when tab is selected
      if (tab === 'teams' && allTeams.length === 0) {
        loadTeams();
      }
      
      // Load games when schedule tab is selected
      if (tab === 'schedule' && allGames.length === 0) {
        loadGames();
      }
      
      // Load contributors when tab is selected
      if (tab === 'contributors' && allContributors.length === 0) {
        loadContributors();
      }
    }
    
    // Load articles
    async function loadArticles() {
      const { data, error } = await supabase
        .from('articles')
        .select('*')
        .order('created_at', { ascending: false });
      
      if (error) {
        console.error('Error loading articles:', error);
        showToast('Error loading articles', 'error');
        return;
      }
      
      articles = data || [];
      renderArticles();
    }
    
    function renderArticles(filter = '') {
      const list = document.getElementById('articleList');
      const filtered = articles.filter(a => 
        a.title.toLowerCase().includes(filter.toLowerCase())
      );
      
      if (filtered.length === 0) {
        list.innerHTML = `
          <div class="article-row header">
            <div>Title</div>
            <div>Status</div>
            <div>Date</div>
            <div>Actions</div>
          </div>
          <div class="empty-state">
            <p>No articles found</p>
            <button class="btn-new" onclick="newArticle()">Create your first article</button>
          </div>
        `;
        return;
      }
      
      list.innerHTML = `
        <div class="article-row header">
          <div>Title</div>
          <div>Status</div>
          <div>Date</div>
          <div>Actions</div>
        </div>
        ${filtered.map(article => {
          const isPublished = article.status === 'published';
          const articleUrl = isPublished ? `https://ball603.com/articles/${article.slug}` : '';
          const shareButtons = isPublished ? `
            <div style="display: flex; gap: 4px; margin-top: 4px;">
              <button onclick="event.stopPropagation(); shareArticle('facebook', '${articleUrl}')" style="padding: 3px 6px; font-size: 10px; background: #1877f2; color: white; border: none; border-radius: 3px; cursor: pointer;" title="Share to Facebook">FB</button>
              <button onclick="event.stopPropagation(); shareArticle('twitter', '${articleUrl}', '${article.title.replace(/'/g, "\\'")}')" style="padding: 3px 6px; font-size: 10px; background: #000; color: white; border: none; border-radius: 3px; cursor: pointer;" title="Share to X">X</button>
              <button onclick="event.stopPropagation(); copyArticleUrl('${articleUrl}')" style="padding: 3px 6px; font-size: 10px; background: #666; color: white; border: none; border-radius: 3px; cursor: pointer;" title="Copy Link">ðŸ”—</button>
              ${article.social_posts ? `<button onclick="event.stopPropagation(); viewStoredSocialPosts('${article.id}')" style="padding: 3px 6px; font-size: 10px; background: #9c27b0; color: white; border: none; border-radius: 3px; cursor: pointer;" title="View Social Posts">ðŸ“±</button>` : ''}
            </div>
          ` : '';
          const scheduledInfo = article.scheduled_at ? `<div style="font-size: 10px; color: #9c27b0;">ðŸ“… ${formatDateTime(article.scheduled_at)}</div>` : '';
          
          return `
          <div class="article-row">
            <div>
              <div class="article-title" onclick="editArticle('${article.id}')">${article.title || 'Untitled'}</div>
              ${shareButtons}
            </div>
            <div>
              <span class="article-status ${article.status}">${article.status}</span>
              ${scheduledInfo}
            </div>
            <div class="article-date">${formatDate(article.created_at)}</div>
            <div class="article-actions">
              <button class="btn-edit" onclick="editArticle('${article.id}')">Edit</button>
              <button class="btn-delete" onclick="deleteArticle('${article.id}')">Delete</button>
            </div>
          </div>
        `}).join('')}
      `;
    }
    
    function filterArticles(value) {
      renderArticles(value);
    }
    
    function formatDate(dateStr) {
      if (!dateStr) return '-';
      const date = new Date(dateStr);
      return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
    }
    
    function formatDateTime(dateStr) {
      if (!dateStr) return '-';
      const date = new Date(dateStr);
      return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }) + ' ' + 
             date.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
    }
    
    // Social sharing functions
    function shareArticle(platform, url, title = '') {
      let shareUrl;
      if (platform === 'facebook') {
        shareUrl = `https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(url)}`;
      } else if (platform === 'twitter') {
        shareUrl = `https://twitter.com/intent/tweet?url=${encodeURIComponent(url)}&text=${encodeURIComponent(title)}`;
      }
      window.open(shareUrl, '_blank', 'width=600,height=400');
    }
    
    function copyArticleUrl(url) {
      navigator.clipboard.writeText(url).then(() => {
        showToast('Link copied!', 'success');
      });
    }
    
    async function viewStoredSocialPosts(articleId) {
      const article = articles.find(a => a.id === articleId);
      if (!article || !article.social_posts) {
        showToast('No social posts found', 'error');
        return;
      }
      
      // Load the social posts into the generatedSocialPosts object
      generatedSocialPosts = article.social_posts;
      currentArticle = article;
      
      // Show the social publishing panel
      showSocialPublishing(article);
    }
    
    // Schedule modal functions
    let isScheduled = false;
    let scheduledTime = null;
    
    function openScheduleModal() {
      const modal = document.getElementById('scheduleModal');
      modal.classList.add('open');
      document.body.style.overflow = 'hidden';
      
      // If already scheduled, show that time; otherwise default to tomorrow 9 AM
      if (scheduledTime) {
        document.getElementById('scheduledDateTime').value = scheduledTime;
      } else if (!document.getElementById('scheduledDateTime').value) {
        const tomorrow = new Date();
        tomorrow.setDate(tomorrow.getDate() + 1);
        tomorrow.setHours(9, 0, 0, 0);
        document.getElementById('scheduledDateTime').value = tomorrow.toISOString().slice(0, 16);
      }
    }
    
    function closeScheduleModal() {
      document.getElementById('scheduleModal').classList.remove('open');
      document.body.style.overflow = 'auto';
    }
    
    function setSchedule() {
      const dateTime = document.getElementById('scheduledDateTime').value;
      if (dateTime) {
        isScheduled = true;
        scheduledTime = dateTime;
        updateScheduleButton();
        closeScheduleModal();
        showToast('Schedule set!', 'success');
      }
    }
    
    function clearSchedule() {
      isScheduled = false;
      scheduledTime = null;
      document.getElementById('scheduledDateTime').value = '';
      updateScheduleButton();
      closeScheduleModal();
      showToast('Schedule cleared', 'success');
    }
    
    function updateScheduleButton() {
      const btn = document.getElementById('scheduleBtnText');
      if (isScheduled && scheduledTime) {
        const date = new Date(scheduledTime);
        const formatted = date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', hour: 'numeric', minute: '2-digit' });
        btn.textContent = `Scheduled: ${formatted}`;
        btn.parentElement.style.color = '#9c27b0';
      } else {
        btn.textContent = 'Schedule for later';
        btn.parentElement.style.color = '#666';
      }
    }
    
    // Tags management
    let currentTags = [];
    
    function generateAutoTags() {
      let tags = ['news'];
      
      if (selectedGame) {
        if (selectedGame.home) tags.push(selectedGame.home.toLowerCase().replace(/\s+/g, '-'));
        if (selectedGame.away) tags.push(selectedGame.away.toLowerCase().replace(/\s+/g, '-'));
        if (selectedGame.level) tags.push(selectedGame.level.toLowerCase());
        if (selectedGame.gender) tags.push(selectedGame.gender.toLowerCase());
        if (selectedGame.division) tags.push(selectedGame.division.toLowerCase().replace(/\s+/g, '-'));
        if (selectedGame.conference) tags.push(selectedGame.conference.toLowerCase().replace(/\s+/g, '-'));
      }
      
      const youtubeUrl = document.getElementById('youtubeUrl').value;
      const smugmugUrl = document.getElementById('smugmugUrl').value;
      if (youtubeUrl) tags.push('video');
      if (smugmugUrl) tags.push('photo-gallery');
      
      return [...new Set(tags)]; // Remove duplicates
    }
    
    function renderTags() {
      const container = document.getElementById('tagsContainer');
      if (!container) return;
      
      // Generate auto tags if currentTags is empty
      if (currentTags.length === 0) {
        currentTags = generateAutoTags();
      }
      
      container.innerHTML = currentTags.map(tag => `
        <span style="display: inline-flex; align-items: center; gap: 5px; padding: 4px 10px; background: #e3f2fd; color: #1565c0; border-radius: 20px; font-size: 12px;">
          ${tag}
          <button onclick="removeTag('${tag}')" style="background: none; border: none; cursor: pointer; color: #1565c0; font-size: 14px; line-height: 1; padding: 0;">&times;</button>
        </span>
      `).join('');
    }
    
    function removeTag(tag) {
      currentTags = currentTags.filter(t => t !== tag);
      renderTags();
    }
    
    function addCustomTag() {
      const input = document.getElementById('newTagInput');
      const tag = input.value.trim().toLowerCase().replace(/\s+/g, '-');
      
      if (tag && !currentTags.includes(tag)) {
        currentTags.push(tag);
        renderTags();
      }
      
      input.value = '';
    }
    
    function refreshTags() {
      // Refresh auto-generated tags based on current game selection
      const autoTags = generateAutoTags();
      // Keep custom tags (tags not in auto-generated list that were manually added)
      const customTags = currentTags.filter(t => !['news', 'video', 'photo-gallery'].includes(t) && 
        !(selectedGame && [
          selectedGame.home?.toLowerCase().replace(/\s+/g, '-'),
          selectedGame.away?.toLowerCase().replace(/\s+/g, '-'),
          selectedGame.level?.toLowerCase(),
          selectedGame.gender?.toLowerCase(),
          selectedGame.division?.toLowerCase().replace(/\s+/g, '-'),
          selectedGame.conference?.toLowerCase().replace(/\s+/g, '-')
        ].includes(t)));
      
      currentTags = [...new Set([...autoTags, ...customTags])];
      renderTags();
    }
    
    // View social posts for current article
    function viewSocialPosts() {
      if (!currentArticle || !currentArticle.social_posts) {
        showToast('No social posts available', 'error');
        return;
      }
      generatedSocialPosts = currentArticle.social_posts;
      showSocialPublishing(currentArticle);
    }
    
    // Load games for selector (Scorebook/Boxscore Story modals)
    async function loadGamesForStory() {
      try {
        const response = await fetch('/.netlify/functions/games?limit=5000');
        const data = await response.json();
        games = data || [];
        renderGameSelector();
      } catch (err) {
        console.error('Error loading games:', err);
        document.getElementById('gameSelector').innerHTML = '<div style="padding: 10px; color: #999;">Could not load games</div>';
      }
    }
    
    function renderGameSelector(filter = '') {
      const selector = document.getElementById('gameSelector');
      
      let filtered = games.filter(g => {
        if (filter) {
          const search = filter.toLowerCase();
          return g.away?.toLowerCase().includes(search) || 
                 g.home?.toLowerCase().includes(search);
        }
        return true;
      }).slice(0, 20);
      
      if (filtered.length === 0) {
        selector.innerHTML = '<div style="padding: 10px; color: #999;">No games found</div>';
        return;
      }
      
      selector.innerHTML = filtered.map(g => `
        <div class="game-option ${g.game_id === document.getElementById('selectedGameId').value ? 'selected' : ''}" 
             onclick="selectGame('${g.game_id}', '${g.away} @ ${g.home}')">
          <div class="teams">${g.away || 'TBD'} @ ${g.home || 'TBD'}</div>
          <div class="meta">${g.date} â€¢ ${g.gender} ${g.division || ''}</div>
        </div>
      `).join('');
    }
    
    function searchGames(value) {
      renderGameSelector(value);
    }
    
    function selectGame(gameId, label) {
      document.getElementById('selectedGameId').value = gameId;
      selectedGame = games.find(g => g.game_id === gameId) || null;
      renderGameSelector();
    }
    
    // Game Story Modal Functions
    let gsSelectedGame = null;
    let otCount = 0;
    let gsSelectedDate = new Date();
    
    function newGameStory() {
      gsSelectedGame = null;
      otCount = 0;
      gsSelectedDate = new Date(); // Start with today
      document.getElementById('gameStoryModal').style.display = 'block';
      document.getElementById('gsStep1').style.display = 'block';
      document.getElementById('gsStep2').style.display = 'none';
      document.getElementById('gsGameSearch').value = '';
      updateGsDateDisplay();
      populateGameList();
      document.body.style.overflow = 'hidden';
    }
    
    function closeGameStory() {
      document.getElementById('gameStoryModal').style.display = 'none';
      document.body.style.overflow = 'auto';
    }
    
    function formatDateShort(date) {
      const months = ['Jan.', 'Feb.', 'Mar.', 'Apr.', 'May', 'June', 'July', 'Aug.', 'Sept.', 'Oct.', 'Nov.', 'Dec.'];
      return `${months[date.getMonth()]} ${date.getDate()}, ${date.getFullYear()}`;
    }
    
    function formatGameDate(dateStr) {
      if (!dateStr) return '';
      const date = new Date(dateStr + 'T12:00:00');
      return formatDateShort(date);
    }
    
    function updateGsDateDisplay() {
      document.getElementById('gsCurrentDate').textContent = formatDateShort(gsSelectedDate);
    }
    
    function gsPrevDay() {
      gsSelectedDate.setDate(gsSelectedDate.getDate() - 1);
      updateGsDateDisplay();
      populateGameList();
    }
    
    function gsNextDay() {
      gsSelectedDate.setDate(gsSelectedDate.getDate() + 1);
      updateGsDateDisplay();
      populateGameList();
    }
    
    function getDateString(date) {
      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const day = String(date.getDate()).padStart(2, '0');
      return `${year}-${month}-${day}`;
    }
    
    function populateGameList() {
      const container = document.getElementById('gsGameList');
      
      // Check if games have loaded
      if (!games || games.length === 0) {
        container.innerHTML = '<div style="padding: 20px; text-align: center; color: #888;">Loading games...</div>';
        setTimeout(() => {
          if (games && games.length > 0) populateGameList();
        }, 500);
        return;
      }
      
      const searchFilter = document.getElementById('gsGameSearch').value.toLowerCase();
      const selectedDateStr = getDateString(gsSelectedDate);
      const selectedGender = document.querySelector('input[name="gsGender"]:checked')?.value || 'Boys';
      
      // Filter by selected date, gender, and search
      let filtered = games.filter(g => {
        // Must match selected date
        if (g.date !== selectedDateStr) return false;
        // Must match selected gender
        if (g.gender !== selectedGender) return false;
        // Filter by search
        if (searchFilter) {
          const searchStr = `${g.away} ${g.home}`.toLowerCase();
          if (!searchStr.includes(searchFilter)) return false;
        }
        return true;
      });
      
      // Sort by time, then gender
      filtered.sort((a, b) => {
        if (a.time !== b.time) return (a.time || '').localeCompare(b.time || '');
        return (a.gender || '').localeCompare(b.gender || '');
      });
      
      if (filtered.length === 0) {
        const message = searchFilter 
          ? `No ${selectedGender.toLowerCase()} games found for "${searchFilter}"` 
          : `No ${selectedGender.toLowerCase()} games on this date`;
        container.innerHTML = `<div style="padding: 30px; text-align: center; color: #888; font-size: 13px;">${message}</div>`;
        return;
      }
      
      // Build simple list
      let html = '';
      
      filtered.forEach(g => {
        const hasRecap = g.recap_link && g.recap_link.trim() !== '';
        const rowStyle = hasRecap 
          ? 'background: #f9f9f9; color: #bbb; cursor: not-allowed;' 
          : 'cursor: pointer;';
        const hoverClass = hasRecap ? '' : 'game-row-hover';
        const onclick = hasRecap ? '' : `onclick="selectGameForStory('${g.game_id}')"`;
        
        html += `
          <div class="${hoverClass}" style="padding: 10px 12px; border-bottom: 1px solid #eee; ${rowStyle}" ${onclick}>
            <span style="font-size: 13px;">${g.away} @ ${g.home}${hasRecap ? ' <span style="font-size: 10px; color: #aaa;">(done)</span>' : ''}</span>
          </div>`;
      });
      
      container.innerHTML = html;
    }
    
    function filterGameList() {
      populateGameList();
    }
    
    function selectGameForStory(gameId) {
      gsSelectedGame = games.find(g => g.game_id === gameId);
      if (!gsSelectedGame) return;
      
      // Move to step 2
      document.getElementById('gsStep1').style.display = 'none';
      document.getElementById('gsStep2').style.display = 'block';
      
      // Set matchup title
      document.getElementById('gsMatchupTitle').textContent = `${gsSelectedGame.away} @ ${gsSelectedGame.home}`;
      document.getElementById('gsAwayName').textContent = gsSelectedGame.away;
      document.getElementById('gsHomeName').textContent = gsSelectedGame.home;
      document.getElementById('gsAwayLabel').textContent = gsSelectedGame.away;
      document.getElementById('gsHomeLabel').textContent = gsSelectedGame.home;
      
      // Clear quarter scores
      ['gsAwayQ1', 'gsAwayQ2', 'gsAwayQ3', 'gsAwayQ4', 'gsAwayFinal', 
       'gsHomeQ1', 'gsHomeQ2', 'gsHomeQ3', 'gsHomeQ4', 'gsHomeFinal'].forEach(id => {
        document.getElementById(id).value = '';
      });
      
      // Clear OT
      otCount = 0;
      document.getElementById('otHeaders').innerHTML = '';
      document.getElementById('gsAwayOT').innerHTML = '';
      document.getElementById('gsHomeOT').innerHTML = '';
      
      // Populate rosters
      const rosters = getTeamRosters();
      populateGSRoster('away', rosters.away, gsSelectedGame.away);
      populateGSRoster('home', rosters.home, gsSelectedGame.home);
      
      // Clear notes
      document.getElementById('gsNotes').value = '';
      
      // Show photographers if assigned
      console.log('Game data:', gsSelectedGame.game_id, 'photog1:', gsSelectedGame.photog1, 'photog2:', gsSelectedGame.photog2);
      const photogs = [gsSelectedGame.photog1, gsSelectedGame.photog2].filter(p => p && p.trim());
      const photogDiv = document.getElementById('gsPhotographers');
      const checkboxContainer = document.getElementById('gsPhotogCheckboxes');
      if (photogs.length > 0) {
        checkboxContainer.innerHTML = photogs.map((p, i) => `
          <label style="display: flex; align-items: center; gap: 6px; margin-bottom: 4px; cursor: pointer;">
            <input type="checkbox" name="gsPhotog" value="${p}" checked style="cursor: pointer;">
            <span>${p}</span>
          </label>
        `).join('');
        photogDiv.style.display = 'block';
      } else {
        photogDiv.style.display = 'none';
      }
      
      // Reset totals
      updateGSPointsTotal('away');
      updateGSPointsTotal('home');
    }
    
    function getTeamRosters() {
      // Works for both game story modal and regular article editor
      const game = gsSelectedGame || selectedGame;
      if (!game || typeof ROSTERS_DATA === 'undefined') return { away: null, home: null };
      
      const gender = game.gender || 'Boys';
      const awayName = game.away;
      const homeName = game.home;
      
      let awayRoster = null;
      let homeRoster = null;
      
      if (ROSTERS_DATA.rosters) {
        awayRoster = ROSTERS_DATA.rosters.find(r => 
          r.gender === gender && 
          (r.school === awayName || awayName.includes(r.school) || r.school.includes(awayName))
        );
        homeRoster = ROSTERS_DATA.rosters.find(r => 
          r.gender === gender && 
          (r.school === homeName || homeName.includes(r.school) || r.school.includes(homeName))
        );
      }
      
      return { away: awayRoster, home: homeRoster };
    }
    
    function populateGSRoster(team, roster, teamName) {
      const container = document.getElementById(`gs${team.charAt(0).toUpperCase() + team.slice(1)}Roster`);
      container.innerHTML = '';
      
      if (roster && roster.players && roster.players.length > 0) {
        roster.players.forEach(player => {
          const row = document.createElement('div');
          row.className = 'roster-row';
          row.innerHTML = `
            <span class="player-name" data-player="${player.name}" data-team="${team}">#${player.number} ${player.name}</span>
            <input type="text" class="gs-pts" data-player="${player.name}" data-team="${team}" placeholder="" onchange="updateGSPointsTotal('${team}')">
            <input type="text" class="gs-3fg" data-player="${player.name}" data-team="${team}" placeholder="">
          `;
          container.appendChild(row);
        });
      } else {
        // No roster - add blank rows
        for (let i = 0; i < 12; i++) {
          addBlankPlayer(team);
        }
      }
    }
    
    function addBlankPlayer(team) {
      const container = document.getElementById(`gs${team.charAt(0).toUpperCase() + team.slice(1)}Roster`);
      const row = document.createElement('div');
      row.className = 'roster-row';
      row.innerHTML = `
        <input type="text" class="gs-name" data-team="${team}" placeholder="Player name" style="text-align: left;">
        <input type="text" class="gs-pts" data-team="${team}" placeholder="" onchange="updateGSPointsTotal('${team}')">
        <input type="text" class="gs-3fg" data-team="${team}" placeholder="">
      `;
      container.appendChild(row);
    }
    
    function addOT() {
      otCount++;
      
      // Add header
      const headerCell = document.getElementById('otHeaders');
      headerCell.innerHTML += `<th style="padding: 8px; width: 50px;">OT${otCount > 1 ? otCount : ''}</th>`;
      
      // Add away input
      const awayOT = document.getElementById('gsAwayOT');
      awayOT.innerHTML += `<td><input type="text" id="gsAwayOT${otCount}" class="quarter-input" onchange="calcGameFinal('away')"></td>`;
      
      // Add home input
      const homeOT = document.getElementById('gsHomeOT');
      homeOT.innerHTML += `<td><input type="text" id="gsHomeOT${otCount}" class="quarter-input" onchange="calcGameFinal('home')"></td>`;
    }
    
    function calcGameFinal(team) {
      const prefix = team === 'away' ? 'gsAway' : 'gsHome';
      let total = 0;
      
      // Add quarters
      for (let q = 1; q <= 4; q++) {
        total += parseInt(document.getElementById(`${prefix}Q${q}`).value) || 0;
      }
      
      // Add OT periods
      for (let ot = 1; ot <= otCount; ot++) {
        const otInput = document.getElementById(`${prefix}OT${ot}`);
        if (otInput) {
          total += parseInt(otInput.value) || 0;
        }
      }
      
      document.getElementById(`${prefix}Final`).value = total || '';
      updateGSPointsTotal(team);
    }
    
    function updateGSPointsTotal(team) {
      const container = document.getElementById(`gs${team.charAt(0).toUpperCase() + team.slice(1)}Roster`);
      const ptsInputs = container.querySelectorAll('.gs-pts');
      let total = 0;
      
      ptsInputs.forEach(input => {
        total += parseInt(input.value) || 0;
      });
      
      document.getElementById(`gs${team.charAt(0).toUpperCase() + team.slice(1)}PtsTotal`).textContent = total;
      
      const prefix = team === 'away' ? 'gsAway' : 'gsHome';
      const final = parseInt(document.getElementById(`${prefix}Final`).value) || 0;
      const matchSpan = document.getElementById(`gs${team.charAt(0).toUpperCase() + team.slice(1)}Match`);
      
      if (!final) {
        matchSpan.textContent = '';
        matchSpan.style.color = '#888';
      } else if (total === final) {
        matchSpan.textContent = 'âœ“';
        matchSpan.style.color = '#2e7d32';
      } else {
        matchSpan.textContent = `(off by ${Math.abs(final - total)})`;
        matchSpan.style.color = '#c62828';
      }
    }
    
    function backToGameSelect() {
      document.getElementById('gsStep1').style.display = 'block';
      document.getElementById('gsStep2').style.display = 'none';
    }
    
    function collectGSScorers(team) {
      const container = document.getElementById(`gs${team.charAt(0).toUpperCase() + team.slice(1)}Roster`);
      const scorers = [];
      
      container.querySelectorAll('.roster-row').forEach(row => {
        const nameEl = row.querySelector('.player-name');
        const nameInput = row.querySelector('.gs-name');
        const ptsInput = row.querySelector('.gs-pts');
        const threeFgInput = row.querySelector('.gs-3fg');
        
        let name = '';
        if (nameEl) {
          name = nameEl.getAttribute('data-player');
        } else if (nameInput) {
          name = nameInput.value.trim();
        }
        
        const pts = parseInt(ptsInput?.value) || 0;
        const threeFg = parseInt(threeFgInput?.value) || 0;
        
        if (name && pts > 0) {
          scorers.push({ name, points: pts, threePointers: threeFg });
        }
      });
      
      // Sort by points descending
      scorers.sort((a, b) => b.points - a.points);
      return scorers;
    }
    
    async function generateGameStory() {
      const awayFinal = parseInt(document.getElementById('gsAwayFinal').value) || 0;
      const homeFinal = parseInt(document.getElementById('gsHomeFinal').value) || 0;
      
      if (!awayFinal && !homeFinal) {
        showToast('Please enter quarter scores first', 'error');
        return;
      }
      
      // Collect quarters + OT
      const awayQuarters = [
        parseInt(document.getElementById('gsAwayQ1').value) || 0,
        parseInt(document.getElementById('gsAwayQ2').value) || 0,
        parseInt(document.getElementById('gsAwayQ3').value) || 0,
        parseInt(document.getElementById('gsAwayQ4').value) || 0
      ];
      const homeQuarters = [
        parseInt(document.getElementById('gsHomeQ1').value) || 0,
        parseInt(document.getElementById('gsHomeQ2').value) || 0,
        parseInt(document.getElementById('gsHomeQ3').value) || 0,
        parseInt(document.getElementById('gsHomeQ4').value) || 0
      ];
      
      // Add OT if any
      for (let ot = 1; ot <= otCount; ot++) {
        const awayOT = parseInt(document.getElementById(`gsAwayOT${ot}`)?.value) || 0;
        const homeOT = parseInt(document.getElementById(`gsHomeOT${ot}`)?.value) || 0;
        awayQuarters.push(awayOT);
        homeQuarters.push(homeOT);
      }
      
      const awayScorers = collectGSScorers('away');
      const homeScorers = collectGSScorers('home');
      
      // Validate
      const awayPtsTotal = awayScorers.reduce((sum, s) => sum + s.points, 0);
      const homePtsTotal = homeScorers.reduce((sum, s) => sum + s.points, 0);
      
      if (awayPtsTotal !== awayFinal) {
        showToast(`${gsSelectedGame.away} points (${awayPtsTotal}) don't match final (${awayFinal})`, 'error');
        return;
      }
      if (homePtsTotal !== homeFinal) {
        showToast(`${gsSelectedGame.home} points (${homePtsTotal}) don't match final (${homeFinal})`, 'error');
        return;
      }
      
      const btn = document.getElementById('gsGenerateBtn');
      btn.disabled = true;
      btn.textContent = 'â³ Writing story...';
      
      const rosters = getTeamRosters();
      
      // Get school info for mascots and towns
      const awaySchoolInfo = getSchoolInfo(gsSelectedGame.away);
      const homeSchoolInfo = getSchoolInfo(gsSelectedGame.home);
      
      // Get selected photographer(s)
      const selectedPhotogs = [];
      document.querySelectorAll('input[name="gsPhotog"]:checked').forEach(cb => {
        selectedPhotogs.push(cb.value);
      });
      const photographerName = selectedPhotogs.join(' & ');
      
      const proofData = {
        awayTeam: gsSelectedGame.away,
        homeTeam: gsSelectedGame.home,
        awayQuarters,
        homeQuarters,
        awayFinal,
        homeFinal,
        awayScorers,
        homeScorers,
        gender: gsSelectedGame.gender || 'Boys',
        division: gsSelectedGame.division || '',
        date: gsSelectedGame.date || '',
        notes: document.getElementById('gsNotes').value.trim(),
        hasOT: otCount > 0
      };
      
      try {
        const response = await fetch('/.netlify/functions/generate-article', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            mode: 'write',
            proofData,
            awayRoster: rosters.away,
            homeRoster: rosters.home,
            schoolData: {
              away: awaySchoolInfo,
              home: homeSchoolInfo
            },
            photographerName: photographerName || null,
            galleryUrl: null
          })
        });
        
        const data = await response.json();
        
        if (data.success) {
          // Close modal and open editor with generated content
          closeGameStory();
          
          // Store generated social posts for later use
          generatedSocialPosts = {
            facebookPost: data.facebookPost || null,
            instagramPost: data.instagramPost || null,
            twitterPost: data.twitterPost || null
          };
          
          // Set up article editor
          currentArticle = null;
          document.getElementById('editorTitle').textContent = 'New Article';
          document.getElementById('articleTitle').value = data.headline || '';
          setEditorContent(data.article || '');
          document.getElementById('articleExcerpt').value = data.excerpt || '';
          document.getElementById('selectedGameId').value = gsSelectedGame.game_id;
          selectedGame = gsSelectedGame;
          document.getElementById('smugmugUrl').value = '';
          document.getElementById('youtubeUrl').value = '';
          setAuthorValue('KJ Cardinal');
          isScheduled = false;
          scheduledTime = null;
          document.getElementById('scheduledDateTime').value = '';
          updateScheduleButton();
          document.getElementById('socialPostsCard').style.display = 'block';
          
          // Generate auto tags based on linked game
          currentTags = generateAutoTags();
          renderTags();
          
          document.getElementById('articlesPanel').style.display = 'none';
          document.getElementById('editorPanel').style.display = 'block';
          
          renderGameSelector();
          showToast('Story generated! Review and edit as needed.', 'success');
        } else {
          showToast(data.error || 'Failed to generate story', 'error');
        }
      } catch (err) {
        console.error('Generation error:', err);
        showToast('Failed to generate story', 'error');
      }
      
      btn.disabled = false;
      btn.textContent = 'âœ¨ Generate Story';
    }

    // ==================== BOXSCORE STORY MODAL FUNCTIONS ====================
    let bsSelectedGame = null;
    let bsSelectedDate = new Date();
    
    function newBoxscoreStory() {
      bsSelectedGame = null;
      bsSelectedDate = new Date(); // Start with today
      document.getElementById('boxscoreStoryModal').style.display = 'block';
      document.getElementById('bsStep1').style.display = 'block';
      document.getElementById('bsStep2').style.display = 'none';
      document.getElementById('bsGameSearch').value = '';
      updateBsDateDisplay();
      populateBsGameList();
      document.body.style.overflow = 'hidden';
    }
    
    function closeBoxscoreStory() {
      document.getElementById('boxscoreStoryModal').style.display = 'none';
      document.body.style.overflow = 'auto';
    }
    
    function updateBsDateDisplay() {
      document.getElementById('bsCurrentDate').textContent = formatDateShort(bsSelectedDate);
    }
    
    function bsPrevDay() {
      bsSelectedDate.setDate(bsSelectedDate.getDate() - 1);
      updateBsDateDisplay();
      populateBsGameList();
    }
    
    function bsNextDay() {
      bsSelectedDate.setDate(bsSelectedDate.getDate() + 1);
      updateBsDateDisplay();
      populateBsGameList();
    }
    
    function populateBsGameList() {
      const container = document.getElementById('bsGameList');
      
      // Check if games have loaded
      if (!games || games.length === 0) {
        container.innerHTML = '<div style="padding: 20px; text-align: center; color: #888;">Loading games...</div>';
        setTimeout(() => {
          if (games && games.length > 0) populateBsGameList();
        }, 500);
        return;
      }
      
      const searchFilter = document.getElementById('bsGameSearch').value.toLowerCase();
      const selectedDateStr = getDateString(bsSelectedDate);
      const selectedGender = document.querySelector('input[name="bsGender"]:checked')?.value || 'Men';
      
      // Filter by selected date, gender, and search
      let filtered = games.filter(g => {
        // Must match selected date
        if (g.date !== selectedDateStr) return false;
        // Must match selected gender
        if (g.gender !== selectedGender) return false;
        // Filter by search
        if (searchFilter) {
          const searchStr = `${g.away} ${g.home}`.toLowerCase();
          if (!searchStr.includes(searchFilter)) return false;
        }
        return true;
      });
      
      // Sort by time, then gender
      filtered.sort((a, b) => {
        if (a.time !== b.time) return (a.time || '').localeCompare(b.time || '');
        return (a.gender || '').localeCompare(b.gender || '');
      });
      
      if (filtered.length === 0) {
        const genderLabel = selectedGender.toLowerCase();
        const message = searchFilter 
          ? `No ${genderLabel}'s games found for "${searchFilter}"` 
          : `No ${genderLabel}'s games on this date`;
        container.innerHTML = `<div style="padding: 30px; text-align: center; color: #888; font-size: 13px;">${message}</div>`;
        return;
      }
      
      // Build simple list
      let html = '';
      
      filtered.forEach(g => {
        const hasRecap = g.recap_link && g.recap_link.trim() !== '';
        const rowStyle = hasRecap 
          ? 'background: #f9f9f9; color: #bbb; cursor: not-allowed;' 
          : 'cursor: pointer;';
        const hoverClass = hasRecap ? '' : 'game-row-hover';
        const onclick = hasRecap ? '' : `onclick="selectGameForBoxscore('${g.game_id}')"`;
        
        html += `
          <div class="${hoverClass}" style="padding: 10px 12px; border-bottom: 1px solid #eee; ${rowStyle}" ${onclick}>
            <span style="font-size: 13px;">${g.away} @ ${g.home}${hasRecap ? ' <span style="font-size: 10px; color: #aaa;">(done)</span>' : ''}</span>
          </div>`;
      });
      
      container.innerHTML = html;
    }
    
    function filterBsGameList() {
      populateBsGameList();
    }
    
    function selectGameForBoxscore(gameId) {
      bsSelectedGame = games.find(g => g.game_id === gameId);
      if (!bsSelectedGame) return;
      
      // Move to step 2
      document.getElementById('bsStep1').style.display = 'none';
      document.getElementById('bsStep2').style.display = 'block';
      
      // Set matchup title
      document.getElementById('bsMatchupTitle').textContent = `${bsSelectedGame.away} @ ${bsSelectedGame.home}`;
      
      // Clear boxscore and notes
      document.getElementById('bsBoxscoreText').value = '';
      document.getElementById('bsNotes').value = '';
      
      // Show photographers if assigned
      const photogs = [bsSelectedGame.photog1, bsSelectedGame.photog2].filter(p => p && p.trim());
      const photogDiv = document.getElementById('bsPhotographers');
      const checkboxContainer = document.getElementById('bsPhotogCheckboxes');
      if (photogs.length > 0) {
        checkboxContainer.innerHTML = photogs.map((p, i) => `
          <label style="display: flex; align-items: center; gap: 6px; margin-bottom: 4px; cursor: pointer;">
            <input type="checkbox" name="bsPhotog" value="${p}" checked style="cursor: pointer;">
            <span>${p}</span>
          </label>
        `).join('');
        photogDiv.style.display = 'block';
      } else {
        photogDiv.style.display = 'none';
      }
    }
    
    function backToBsGameSelect() {
      document.getElementById('bsStep1').style.display = 'block';
      document.getElementById('bsStep2').style.display = 'none';
    }
    
    async function generateBoxscoreStory() {
      const boxscoreText = document.getElementById('bsBoxscoreText').value.trim();
      
      if (!boxscoreText) {
        showToast('Please paste the boxscore data first', 'error');
        return;
      }
      
      const btn = document.getElementById('bsGenerateBtn');
      btn.disabled = true;
      btn.textContent = 'â³ Writing story...';
      
      // Get selected photographer(s)
      const selectedPhotogs = [];
      document.querySelectorAll('input[name="bsPhotog"]:checked').forEach(cb => {
        selectedPhotogs.push(cb.value);
      });
      const photographerName = selectedPhotogs.join(' & ');
      
      // Get school info
      const awaySchoolInfo = getSchoolInfo(bsSelectedGame.away);
      const homeSchoolInfo = getSchoolInfo(bsSelectedGame.home);
      
      try {
        const response = await fetch('/.netlify/functions/generate-article', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            mode: 'boxscore',
            boxscoreText: boxscoreText,
            gameInfo: {
              awayTeam: bsSelectedGame.away,
              homeTeam: bsSelectedGame.home,
              gender: bsSelectedGame.gender || 'Men',
              division: bsSelectedGame.division || '',
              date: bsSelectedGame.date || ''
            },
            notes: document.getElementById('bsNotes').value.trim(),
            schoolData: {
              away: awaySchoolInfo,
              home: homeSchoolInfo
            },
            photographerName: photographerName || null
          })
        });
        
        const data = await response.json();
        
        if (data.success) {
          // Close modal and open editor with generated content
          closeBoxscoreStory();
          
          // Store generated social posts for later use
          generatedSocialPosts = {
            facebookPost: data.facebookPost || null,
            instagramPost: data.instagramPost || null,
            twitterPost: data.twitterPost || null
          };
          
          // Set up article editor
          currentArticle = null;
          document.getElementById('editorTitle').textContent = 'New Article';
          document.getElementById('articleTitle').value = data.headline || '';
          setEditorContent(data.article || '');
          document.getElementById('articleExcerpt').value = data.excerpt || '';
          document.getElementById('selectedGameId').value = bsSelectedGame.game_id;
          selectedGame = bsSelectedGame;
          document.getElementById('smugmugUrl').value = '';
          document.getElementById('youtubeUrl').value = '';
          setAuthorValue('KJ Cardinal');
          isScheduled = false;
          scheduledTime = null;
          document.getElementById('scheduledDateTime').value = '';
          updateScheduleButton();
          document.getElementById('socialPostsCard').style.display = 'block';
          
          // Generate auto tags based on linked game
          currentTags = generateAutoTags();
          renderTags();
          
          document.getElementById('articlesPanel').style.display = 'none';
          document.getElementById('editorPanel').style.display = 'block';
          
          renderGameSelector();
          showToast('Story generated! Review and edit as needed.', 'success');
        } else {
          showToast(data.error || 'Failed to generate story', 'error');
        }
      } catch (err) {
        console.error('Generation error:', err);
        showToast('Failed to generate story', 'error');
      }
      
      btn.disabled = false;
      btn.textContent = 'âœ¨ Generate Story';
    }
    
    // Helper function to get school info from ROSTERS_DATA
    function getSchoolInfo(schoolName) {
      if (typeof ROSTERS_DATA === 'undefined' || !ROSTERS_DATA.schools) return null;
      
      // Try exact match first
      for (const [fullName, info] of Object.entries(ROSTERS_DATA.schools)) {
        if (info.shortname === schoolName || fullName === schoolName || fullName.includes(schoolName)) {
          return info;
        }
      }
      return null;
    }

    // Article CRUD
    function newArticle() {
      currentArticle = null;
      document.getElementById('editorTitle').textContent = 'New Article';
      document.getElementById('articleTitle').value = '';
      setEditorContent(''); // Clear Quill editor
      document.getElementById('articleExcerpt').value = '';
      document.getElementById('selectedGameId').value = '';
      selectedGame = null;
      document.getElementById('smugmugUrl').value = '';
      document.getElementById('youtubeUrl').value = '';
      setAuthorValue('KJ Cardinal');
      isScheduled = false;
      scheduledTime = null;
      document.getElementById('scheduledDateTime').value = '';
      updateScheduleButton();
      document.getElementById('socialPostsCard').style.display = 'none';
      
      // Clear featured image
      removeFeaturedImage();
      
      // Clear generated social posts (this is a manual article)
      generatedSocialPosts = {
        facebookPost: null,
        instagramPost: null,
        twitterPost: null
      };
      
      // Reset tags
      currentTags = [];
      renderTags();
      
      document.getElementById('articlesPanel').style.display = 'none';
      document.getElementById('editorPanel').style.display = 'block';
      
      renderGameSelector();
    }
    
    async function editArticle(id) {
      const article = articles.find(a => a.id === id);
      if (!article) return;
      
      currentArticle = article;
      document.getElementById('editorTitle').textContent = 'Edit Article';
      document.getElementById('articleTitle').value = article.title || '';
      setEditorContent(article.content || ''); // Load into Quill editor
      document.getElementById('articleExcerpt').value = article.excerpt || '';
      document.getElementById('selectedGameId').value = article.game_id || '';
      selectedGame = article.game_id ? games.find(g => g.game_id === article.game_id) : null;
      document.getElementById('smugmugUrl').value = article.smugmug_gallery_url || '';
      document.getElementById('youtubeUrl').value = article.youtube_url || '';
      setAuthorValue(article.author || 'KJ Cardinal');
      
      // Handle featured image
      if (article.featured_image_url) {
        document.getElementById('featuredImageUrl').value = article.featured_image_url;
        document.getElementById('featuredImageCaption').value = article.featured_image_caption || '';
        document.getElementById('featuredImageContainer').classList.add('has-image');
        document.getElementById('featuredImagePlaceholder').style.display = 'none';
        document.getElementById('featuredImagePreview').style.display = 'block';
        document.getElementById('featuredImageImg').src = article.featured_image_url;
        document.getElementById('featuredImageInfo').textContent = article.featured_image_caption || 'No caption';
      } else {
        removeFeaturedImage();
      }
      
      // Handle scheduling
      if (article.scheduled_at) {
        isScheduled = true;
        scheduledTime = article.scheduled_at.slice(0, 16);
        document.getElementById('scheduledDateTime').value = scheduledTime;
      } else {
        isScheduled = false;
        scheduledTime = null;
        document.getElementById('scheduledDateTime').value = '';
      }
      updateScheduleButton();
      
      // Handle tags
      currentTags = article.tags || [];
      if (currentTags.length === 0) {
        currentTags = generateAutoTags();
      }
      renderTags();
      
      // Handle social posts
      if (article.social_posts) {
        generatedSocialPosts = article.social_posts;
        document.getElementById('socialPostsCard').style.display = 'block';
      } else {
        generatedSocialPosts = {
          facebookPost: null,
          instagramPost: null,
          twitterPost: null
        };
        document.getElementById('socialPostsCard').style.display = 'none';
      }
      
      document.getElementById('articlesPanel').style.display = 'none';
      document.getElementById('editorPanel').style.display = 'block';
      
      renderGameSelector();
    }
    
    function closeEditor() {
      document.getElementById('editorPanel').style.display = 'none';
      document.getElementById('articlesPanel').style.display = 'block';
      currentArticle = null;
    }
    
    function showSocialPublishing(article) {
      // Hide editor, show social publishing panel
      document.getElementById('editorPanel').style.display = 'none';
      document.getElementById('socialPublishingPanel').style.display = 'block';
      
      // Populate the textareas
      const fbPost = generatedSocialPosts.facebookPost || '';
      const igPost = generatedSocialPosts.instagramPost || '';
      const twPost = generatedSocialPosts.twitterPost || '';
      
      document.getElementById('socialFacebookPost').value = fbPost;
      document.getElementById('socialInstagramPost').value = igPost;
      document.getElementById('socialTwitterPost').value = twPost;
      
      // Update character counts
      updateCharCount('facebook');
      updateCharCount('instagram');
      updateCharCount('twitter');
      
      // Add input listeners for character counts
      document.getElementById('socialFacebookPost').oninput = () => updateCharCount('facebook');
      document.getElementById('socialInstagramPost').oninput = () => updateCharCount('instagram');
      document.getElementById('socialTwitterPost').oninput = () => updateCharCount('twitter');
    }
    
    function closeSocialPublishing() {
      document.getElementById('socialPublishingPanel').style.display = 'none';
      document.getElementById('articlesPanel').style.display = 'block';
      
      // Don't clear generatedSocialPosts - they're stored with the article
      // and can be re-accessed via the View Social Posts button
    }
    
    function updateCharCount(platform) {
      const textareaId = `social${platform.charAt(0).toUpperCase() + platform.slice(1)}Post`;
      const text = document.getElementById(textareaId).value;
      const count = text.length;
      
      if (platform === 'facebook') {
        document.getElementById('fbCharCount').textContent = count;
      } else if (platform === 'instagram') {
        document.getElementById('igCharCount').textContent = count;
        document.getElementById('igCharCount').style.color = count > 2200 ? '#c00' : '#888';
      } else if (platform === 'twitter') {
        document.getElementById('twCharCount').textContent = count;
        document.getElementById('twCharCount').style.color = count > 280 ? '#c00' : '#888';
      }
    }
    
    function copySocialPost(platform) {
      const textareaId = `social${platform.charAt(0).toUpperCase() + platform.slice(1)}Post`;
      const text = document.getElementById(textareaId).value;
      
      navigator.clipboard.writeText(text).then(() => {
        showToast(`${platform.charAt(0).toUpperCase() + platform.slice(1)} post copied!`, 'success');
      }).catch(err => {
        console.error('Copy failed:', err);
        showToast('Failed to copy', 'error');
      });
    }
    
    function generateSlug(title) {
      return title
        .toLowerCase()
        .replace(/[^a-z0-9]+/g, '-')
        .replace(/(^-|-$)/g, '')
        .substring(0, 60);
    }
    
    async function saveArticle() {
      const title = document.getElementById('articleTitle').value.trim();
      if (!title) {
        showToast('Please enter a headline', 'error');
        return;
      }
      
      // Check if this was a published article (will unpublish it)
      const wasPublished = currentArticle && currentArticle.status === 'published';
      
      // Handle scheduling
      let scheduledAt = null;
      if (isScheduled && scheduledTime) {
        scheduledAt = new Date(scheduledTime).toISOString();
      }
      
      const articleData = {
        title,
        slug: currentArticle?.slug || (generateSlug(title) + '-' + Date.now()),
        content: getEditorContent(), // Get from Quill
        excerpt: document.getElementById('articleExcerpt').value,
        game_id: document.getElementById('selectedGameId').value || null,
        smugmug_gallery_url: document.getElementById('smugmugUrl').value || null,
        youtube_url: document.getElementById('youtubeUrl').value || null,
        featured_image_url: document.getElementById('featuredImageUrl').value || null,
        featured_image_caption: document.getElementById('featuredImageCaption').value || null,
        author: getAuthorValue(),
        tags: currentTags,
        scheduled_at: scheduledAt,
        status: 'draft',
        published_at: null, // Clear published_at when saving as draft
        updated_at: new Date().toISOString()
      };
      
      let result;
      if (currentArticle) {
        result = await supabase
          .from('articles')
          .update(articleData)
          .eq('id', currentArticle.id)
          .select();
      } else {
        result = await supabase
          .from('articles')
          .insert([articleData])
          .select();
      }
      
      if (result.error) {
        console.error('Save error:', result.error);
        showToast('Error saving article', 'error');
        return;
      }
      
      if (wasPublished) {
        showToast('Article unpublished and saved as draft!', 'success');
      } else {
        showToast('Article saved!', 'success');
      }
      currentArticle = result.data[0];
      loadArticles();
    }
    
    async function saveAndPreviewSocial() {
      // First save the article
      const title = document.getElementById('articleTitle').value.trim();
      if (!title) {
        showToast('Please enter a headline', 'error');
        return;
      }
      
      // Handle scheduling
      let scheduledAt = null;
      if (isScheduled && scheduledTime) {
        scheduledAt = new Date(scheduledTime).toISOString();
      }
      
      // Build social posts object for storage
      const socialPosts = (generatedSocialPosts.facebookPost || generatedSocialPosts.instagramPost || generatedSocialPosts.twitterPost) ? {
        facebookPost: generatedSocialPosts.facebookPost || null,
        instagramPost: generatedSocialPosts.instagramPost || null,
        twitterPost: generatedSocialPosts.twitterPost || null
      } : null;
      
      const articleData = {
        title,
        slug: currentArticle?.slug || (generateSlug(title) + '-' + Date.now()),
        content: getEditorContent(), // Get from Quill
        excerpt: document.getElementById('articleExcerpt').value,
        game_id: document.getElementById('selectedGameId').value || null,
        smugmug_gallery_url: document.getElementById('smugmugUrl').value || null,
        youtube_url: document.getElementById('youtubeUrl').value || null,
        featured_image_url: document.getElementById('featuredImageUrl').value || null,
        featured_image_caption: document.getElementById('featuredImageCaption').value || null,
        author: getAuthorValue(),
        tags: currentTags,
        social_posts: socialPosts,
        scheduled_at: scheduledAt,
        status: 'draft',
        updated_at: new Date().toISOString()
      };
      
      let result;
      if (currentArticle) {
        result = await supabase
          .from('articles')
          .update(articleData)
          .eq('id', currentArticle.id)
          .select();
      } else {
        result = await supabase
          .from('articles')
          .insert([articleData])
          .select();
      }
      
      if (result.error) {
        console.error('Save error:', result.error);
        showToast('Error saving article', 'error');
        return;
      }
      
      currentArticle = result.data[0];
      loadArticles();
      
      // Check if we have social posts to preview
      if (generatedSocialPosts.facebookPost || generatedSocialPosts.instagramPost || generatedSocialPosts.twitterPost) {
        showToast('Draft saved! Opening social preview...', 'success');
        showSocialPublishing(currentArticle);
      } else {
        // Show preview modal instead (which shows social posts placeholder)
        showToast('Draft saved! Note: Use Scorebook or Boxscore Story to generate social posts.', 'success');
        openPreview();
      }
    }
    
    async function publishArticle() {
      const title = document.getElementById('articleTitle').value.trim();
      if (!title) {
        showToast('Please enter a headline', 'error');
        return;
      }
      
      const gameId = document.getElementById('selectedGameId').value || null;
      const smugmugUrl = document.getElementById('smugmugUrl').value || null;
      const youtubeUrl = document.getElementById('youtubeUrl').value || null;
      const slug = currentArticle?.slug || (generateSlug(title) + '-' + Date.now());
      
      // Check if scheduling
      let scheduledAt = null;
      if (isScheduled && scheduledTime) {
        scheduledAt = new Date(scheduledTime).toISOString();
      }
      
      // Use currentTags (which may have been edited by user)
      // Refresh auto tags first to make sure we have latest
      if (currentTags.length === 0) {
        currentTags = generateAutoTags();
      }
      
      // Build social posts object for storage
      const socialPosts = (generatedSocialPosts.facebookPost || generatedSocialPosts.instagramPost || generatedSocialPosts.twitterPost) ? {
        facebookPost: generatedSocialPosts.facebookPost || null,
        instagramPost: generatedSocialPosts.instagramPost || null,
        twitterPost: generatedSocialPosts.twitterPost || null
      } : null;
      
      const articleData = {
        title,
        slug,
        content: getEditorContent(), // Get from Quill
        excerpt: document.getElementById('articleExcerpt').value,
        game_id: gameId,
        smugmug_gallery_url: smugmugUrl,
        youtube_url: youtubeUrl,
        featured_image_url: document.getElementById('featuredImageUrl').value || null,
        featured_image_caption: document.getElementById('featuredImageCaption').value || null,
        author: getAuthorValue(),
        tags: currentTags,
        social_posts: socialPosts,
        scheduled_at: scheduledAt,
        status: isScheduled ? 'scheduled' : 'published',
        published_at: isScheduled ? null : new Date().toISOString(),
        updated_at: new Date().toISOString()
      };
      
      let result;
      if (currentArticle) {
        result = await supabase
          .from('articles')
          .update(articleData)
          .eq('id', currentArticle.id)
          .select();
      } else {
        result = await supabase
          .from('articles')
          .insert([articleData])
          .select();
      }
      
      if (result.error) {
        console.error('Publish error:', result.error);
        showToast('Error publishing article', 'error');
        return;
      }
      
      currentArticle = result.data[0];
      
      // Update game record with URLs if we have a game linked (and not scheduled)
      if (gameId && selectedGame && !isScheduled) {
        const gameUpdate = {};
        const articleUrl = `https://ball603.com/articles/${slug}`;
        
        gameUpdate.recap_url = articleUrl;
        if (smugmugUrl) gameUpdate.photos_url = smugmugUrl;
        if (youtubeUrl) gameUpdate.highlights_url = youtubeUrl;
        
        const { error: gameError } = await supabase
          .from('games')
          .update(gameUpdate)
          .eq('game_id', gameId);
        
        if (gameError) {
          console.error('Error updating game:', gameError);
        }
      }
      
      if (isScheduled) {
        showToast(`Article scheduled for ${formatDateTime(scheduledAt)}!`, 'success');
        closeEditor();
      } else {
        showToast('Article published!', 'success');
        loadArticles();
        
        // Show social publishing page if we have generated posts
        if (generatedSocialPosts.facebookPost || generatedSocialPosts.instagramPost || generatedSocialPosts.twitterPost) {
          showSocialPublishing(currentArticle);
        } else {
          closeEditor();
        }
      }
    }
    
    async function deleteArticle(id) {
      if (!confirm('Delete this article?')) return;
      
      const { error } = await supabase
        .from('articles')
        .delete()
        .eq('id', id);
      
      if (error) {
        showToast('Error deleting article', 'error');
        return;
      }
      
      showToast('Article deleted', 'success');
      loadArticles();
    }
    
    // AI Generation
    let scorePhotoBase64 = null;
    let extractedData = null;
    
    function previewScorePhoto(input) {
      const file = input.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
          scorePhotoBase64 = e.target.result;
          document.getElementById('photoPreviewImg').src = scorePhotoBase64;
          document.getElementById('photoPreview').style.display = 'block';
        };
        reader.readAsDataURL(file);
      }
    }
    
    function clearScorePhoto() {
      scorePhotoBase64 = null;
      document.getElementById('scorePhoto').value = '';
      document.getElementById('photoPreview').style.display = 'none';
    }
    
    // Get rosters for selected teams
    
    // Update roster status when game is selected
    function updateRosterStatus() {
      const status = document.getElementById('rosterStatus');
      if (!selectedGame) {
        status.textContent = 'âš ï¸ Select a game above to enable roster matching';
        status.style.color = '#e65100';
        return;
      }
      
      const rosters = getTeamRosters();
      const hasAway = !!rosters.away;
      const hasHome = !!rosters.home;
      
      if (hasAway && hasHome) {
        status.innerHTML = `âœ… Rosters loaded: <strong>${selectedGame.away}</strong> & <strong>${selectedGame.home}</strong>`;
        status.style.color = '#2e7d32';
      } else if (hasAway || hasHome) {
        const missing = !hasAway ? selectedGame.away : selectedGame.home;
        status.innerHTML = `âš ï¸ Roster missing for: <strong>${missing}</strong>`;
        status.style.color = '#e65100';
      } else {
        status.innerHTML = `âš ï¸ No rosters found for either team`;
        status.style.color = '#e65100';
      }
    }
    
    // Add scorer row to proof form
    function addScorerRow(team, data = {}) {
      const container = document.getElementById(team + 'Scorers');
      const rosters = getTeamRosters();
      const roster = team === 'away' ? rosters.away : rosters.home;
      
      const row = document.createElement('div');
      row.style.cssText = 'display: flex; gap: 5px; margin-bottom: 5px; align-items: center;';
      
      // Build player dropdown if roster available
      let playerSelect = '';
      if (roster && roster.players) {
        playerSelect = `<select style="flex: 2; padding: 4px; font-size: 12px;" onchange="this.nextElementSibling.value=this.value">
          <option value="">-- Select --</option>
          ${roster.players.map(p => `<option value="${p.name}" ${data.name === p.name ? 'selected' : ''}>#${p.number} ${p.name} (${p.class})</option>`).join('')}
        </select>`;
      }
      
      row.innerHTML = `
        ${playerSelect}
        <input type="text" placeholder="Player name" value="${data.name || ''}" style="flex: 2; padding: 4px; font-size: 12px;">
        <input type="text" placeholder="Pts" value="${data.points || ''}" style="width: 35px; padding: 4px; font-size: 12px; text-align: center;">
        <button type="button" onclick="this.parentElement.remove()" style="background: #ffebee; border: none; padding: 4px 8px; border-radius: 3px; cursor: pointer; color: #c62828; font-size: 11px;">âœ•</button>
      `;
      container.appendChild(row);
    }
    
    // Extract box score from image
    async function extractBoxScore() {
      if (!scorePhotoBase64 && !document.getElementById('aiInput').value.trim()) {
        showToast('Please upload a scorebook photo or enter notes', 'error');
        return;
      }
      
      if (!selectedGame) {
        showToast('Please select a game first to enable roster matching', 'error');
        return;
      }
      
      const btn = document.getElementById('btnExtract');
      btn.disabled = true;
      btn.innerHTML = 'â³ Reading scorebook...';
      
      const rosters = getTeamRosters();
      const notes = document.getElementById('aiInput').value.trim();
      
      try {
        const response = await fetch('/.netlify/functions/generate-article', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            mode: 'extract',
            image: scorePhotoBase64,
            notes: notes,
            gameInfo: {
              away: selectedGame.away,
              home: selectedGame.home,
              gender: selectedGame.gender,
              date: selectedGame.date,
              division: selectedGame.division
            },
            awayRoster: rosters.away,
            homeRoster: rosters.home
          })
        });
        
        const data = await response.json();
        
        if (data.success && data.extracted) {
          extractedData = data.extracted;
          populateProofForm(data.extracted);
          document.getElementById('aiStep1').style.display = 'none';
          document.getElementById('aiStep2').style.display = 'block';
          showToast('Box score extracted! Please verify and edit if needed.', 'success');
        } else {
          showToast(data.error || 'Failed to extract box score', 'error');
        }
      } catch (err) {
        console.error('Extract error:', err);
        showToast('Failed to extract box score', 'error');
      }
      
      btn.disabled = false;
      btn.innerHTML = 'ðŸ“‹ Extract & Review';
    }
    
    // Populate proof form with extracted data
    function populateProofForm(data) {
      // Team names
      document.getElementById('proofAwayTeam').textContent = selectedGame.away;
      document.getElementById('proofHomeTeam').textContent = selectedGame.home;
      document.getElementById('awayScorerLabel').textContent = selectedGame.away + ' Scorers';
      document.getElementById('homeScorerLabel').textContent = selectedGame.home + ' Scorers';
      
      // Quarter scores
      document.getElementById('awayQ1').value = data.awayQuarters?.[0] || '';
      document.getElementById('awayQ2').value = data.awayQuarters?.[1] || '';
      document.getElementById('awayQ3').value = data.awayQuarters?.[2] || '';
      document.getElementById('awayQ4').value = data.awayQuarters?.[3] || '';
      document.getElementById('awayFinal').value = data.awayFinal || '';
      
      document.getElementById('homeQ1').value = data.homeQuarters?.[0] || '';
      document.getElementById('homeQ2').value = data.homeQuarters?.[1] || '';
      document.getElementById('homeQ3').value = data.homeQuarters?.[2] || '';
      document.getElementById('homeQ4').value = data.homeQuarters?.[3] || '';
      document.getElementById('homeFinal').value = data.homeFinal || '';
      
      // Clear and populate scorers
      document.getElementById('awayScorers').innerHTML = '';
      document.getElementById('homeScorers').innerHTML = '';
      
      (data.awayScorers || []).forEach(s => addScorerRow('away', s));
      (data.homeScorers || []).forEach(s => addScorerRow('home', s));
      
      // Add empty rows if none
      if (!data.awayScorers?.length) addScorerRow('away');
      if (!data.homeScorers?.length) addScorerRow('home');
      
      // Notes
      document.getElementById('proofNotes').value = data.notes || '';
    }
    
    // Go back to upload step
    function backToUpload() {
      document.getElementById('aiStep1').style.display = 'block';
      document.getElementById('aiStep2').style.display = 'none';
    }
    
    // Collect data from proof form
    function collectProofData() {
      const awayScorers = [];
      document.querySelectorAll('#awayScorers > div').forEach(row => {
        const inputs = row.querySelectorAll('input[type="text"]');
        const name = inputs[inputs.length - 2]?.value?.trim();
        const points = inputs[inputs.length - 1]?.value?.trim();
        if (name && points) awayScorers.push({ name, points });
      });
      
      const homeScorers = [];
      document.querySelectorAll('#homeScorers > div').forEach(row => {
        const inputs = row.querySelectorAll('input[type="text"]');
        const name = inputs[inputs.length - 2]?.value?.trim();
        const points = inputs[inputs.length - 1]?.value?.trim();
        if (name && points) homeScorers.push({ name, points });
      });
      
      return {
        awayTeam: selectedGame.away,
        homeTeam: selectedGame.home,
        gender: selectedGame.gender,
        division: selectedGame.division,
        date: selectedGame.date,
        awayQuarters: [
          document.getElementById('awayQ1').value,
          document.getElementById('awayQ2').value,
          document.getElementById('awayQ3').value,
          document.getElementById('awayQ4').value
        ],
        homeQuarters: [
          document.getElementById('homeQ1').value,
          document.getElementById('homeQ2').value,
          document.getElementById('homeQ3').value,
          document.getElementById('homeQ4').value
        ],
        awayFinal: document.getElementById('awayFinal').value,
        homeFinal: document.getElementById('homeFinal').value,
        awayScorers,
        homeScorers,
        notes: document.getElementById('proofNotes').value
      };
    }
    
    // Generate article from confirmed proof data
    // Generate article from manual box score entry
    async function generateArticle() {
      // Validate quarters entered
      const awayFinal = parseInt(document.getElementById('awayFinal').value) || 0;
      const homeFinal = parseInt(document.getElementById('homeFinal').value) || 0;
      
      if (!awayFinal && !homeFinal) {
        showToast('Please enter quarter scores first', 'error');
        return;
      }
      
      // Collect quarter scores
      const awayQuarters = [
        parseInt(document.getElementById('awayQ1').value) || 0,
        parseInt(document.getElementById('awayQ2').value) || 0,
        parseInt(document.getElementById('awayQ3').value) || 0,
        parseInt(document.getElementById('awayQ4').value) || 0
      ];
      const homeQuarters = [
        parseInt(document.getElementById('homeQ1').value) || 0,
        parseInt(document.getElementById('homeQ2').value) || 0,
        parseInt(document.getElementById('homeQ3').value) || 0,
        parseInt(document.getElementById('homeQ4').value) || 0
      ];
      
      // Collect scorers from roster entries
      const awayScorers = collectScorers('away');
      const homeScorers = collectScorers('home');
      
      // Validate points match
      const awayPtsTotal = awayScorers.reduce((sum, s) => sum + s.points, 0);
      const homePtsTotal = homeScorers.reduce((sum, s) => sum + s.points, 0);
      
      if (awayPtsTotal !== awayFinal) {
        showToast(`${selectedGame.away} points (${awayPtsTotal}) don't match final (${awayFinal})`, 'error');
        return;
      }
      if (homePtsTotal !== homeFinal) {
        showToast(`${selectedGame.home} points (${homePtsTotal}) don't match final (${homeFinal})`, 'error');
        return;
      }
      
      const btn = document.getElementById('btnGenerate');
      btn.disabled = true;
      btn.innerHTML = 'â³ Writing article...';
      
      const rosters = getTeamRosters();
      const notes = document.getElementById('gameNotes').value.trim();
      
      const proofData = {
        awayTeam: selectedGame.away,
        homeTeam: selectedGame.home,
        awayQuarters: awayQuarters,
        homeQuarters: homeQuarters,
        awayFinal: awayFinal,
        homeFinal: homeFinal,
        awayScorers: awayScorers,
        homeScorers: homeScorers,
        gender: selectedGame.gender || 'Boys',
        division: selectedGame.division || '',
        date: selectedGame.date || '',
        notes: notes
      };
      
      try {
        const response = await fetch('/.netlify/functions/generate-article', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            mode: 'write',
            proofData: proofData,
            awayRoster: rosters.away,
            homeRoster: rosters.home
          })
        });
        
        const data = await response.json();
        
        if (data.success) {
          if (data.headline) {
            document.getElementById('articleTitle').value = data.headline;
          }
          if (data.article) {
            setEditorContent(data.article || '');
          }
          if (data.excerpt) {
            document.getElementById('articleExcerpt').value = data.excerpt;
          }
          
          showToast('Article generated! Review and edit as needed.', 'success');
        } else {
          showToast(data.error || 'Failed to generate article', 'error');
        }
      } catch (err) {
        console.error('Generation error:', err);
        showToast('Failed to generate article', 'error');
      }
      
      btn.disabled = false;
      btn.innerHTML = 'âœ¨ Generate Article';
    }
    
    // Collect scorers from roster entry section
    function collectScorers(team) {
      const container = document.getElementById(team + 'RosterEntry');
      const scorers = [];
      
      // Roster players with points
      container.querySelectorAll('.pts-input[data-player]').forEach(input => {
        const pts = parseInt(input.value) || 0;
        if (pts > 0) {
          const name = input.getAttribute('data-player');
          const threePtInput = container.querySelector(`.threept-input[data-player="${name}"]`);
          const threePts = parseInt(threePtInput?.value) || 0;
          scorers.push({ name: name, points: pts, threePointers: threePts });
        }
      });
      
      // Manual entries
      container.querySelectorAll('.manual-name').forEach(nameInput => {
        const name = nameInput.value.trim();
        if (name) {
          const row = nameInput.parentElement;
          const ptsInput = row.querySelector('.manual-pts');
          const threePtInput = row.querySelector('.threept-input');
          const pts = parseInt(ptsInput?.value) || 0;
          const threePts = parseInt(threePtInput?.value) || 0;
          if (pts > 0) {
            scorers.push({ name: name, points: pts, threePointers: threePts });
          }
        }
      });
      
      // Sort by points descending
      scorers.sort((a, b) => b.points - a.points);
      return scorers;
    }

    async function generateFromProof() {
      const proofData = collectProofData();
      
      if (!proofData.awayFinal || !proofData.homeFinal) {
        showToast('Please enter final scores', 'error');
        return;
      }
      
      const btn = document.getElementById('btnGenerate');
      btn.disabled = true;
      btn.innerHTML = 'â³ Writing article...';
      
      const rosters = getTeamRosters();
      
      try {
        const response = await fetch('/.netlify/functions/generate-article', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            mode: 'write',
            proofData: proofData,
            awayRoster: rosters.away,
            homeRoster: rosters.home
          })
        });
        
        const data = await response.json();
        
        if (data.success) {
          if (data.headline) {
            document.getElementById('articleTitle').value = data.headline;
          }
          if (data.article) {
            setEditorContent(data.article || '');
          }
          if (data.excerpt) {
            document.getElementById('articleExcerpt').value = data.excerpt;
          }
          
          // Reset AI section
          backToUpload();
          clearScorePhoto();
          document.getElementById('aiInput').value = '';
          
          showToast('Article generated! Review and edit as needed.', 'success');
        } else {
          showToast(data.error || 'Failed to generate article', 'error');
        }
      } catch (err) {
        console.error('Generation error:', err);
        showToast('Failed to generate article', 'error');
      }
      
      btn.disabled = false;
      btn.innerHTML = 'âœ¨ Generate Article';
    }
    
    // Social posting
    // Toast
    function showToast(message, type = 'success') {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.className = `toast ${type}`;
      toast.style.display = 'block';
      setTimeout(() => toast.style.display = 'none', 3000);
    }
    
    // Sponsors & Products (placeholders)
    function newSponsor() {
      showToast('Sponsor management coming soon!', 'error');
    }
    
    function newProduct() {
      showToast('Product management coming soon!', 'error');
    }
    
    // ==========================================
    // TEAM MANAGER FUNCTIONS
    // ==========================================
    let allTeams = [];
    let importTeamsData = [];
    
    async function loadTeams() {
      document.getElementById('teamList').innerHTML = `
        <div class="article-row header" style="grid-template-columns: 50px 1fr 100px 80px 80px 100px 120px;">
          <div>Logo</div>
          <div>Team</div>
          <div>Level</div>
          <div>Division</div>
          <div>Gender</div>
          <div>Location</div>
          <div>Actions</div>
        </div>
        <div class="loading">Loading teams...</div>
      `;
      
      try {
        const response = await fetch('/.netlify/functions/teams');
        const data = await response.json();
        
        if (data.success) {
          allTeams = data.teams || [];
          filterTeams();
        } else {
          showToast('Error loading teams', 'error');
        }
      } catch (err) {
        console.error('Error loading teams:', err);
        showToast('Could not connect to server', 'error');
      }
    }
    
    function filterTeams() {
      const level = document.getElementById('teamLevelFilter').value;
      const division = document.getElementById('teamDivisionFilter').value;
      const gender = document.getElementById('teamGenderFilter').value;
      const search = document.getElementById('teamSearchBox').value.toLowerCase();
      
      let filtered = allTeams.filter(t => {
        if (level && t.level !== level) return false;
        if (division && t.division !== division) return false;
        if (gender && t.gender !== gender) return false;
        if (search) {
          const searchStr = `${t.shortname} ${t.full_name} ${t.mascot} ${t.location}`.toLowerCase();
          if (!searchStr.includes(search)) return false;
        }
        return true;
      });
      
      renderTeamList(filtered);
    }
    
    function renderTeamList(teams) {
      const list = document.getElementById('teamList');
      const activeCount = teams.filter(t => t.active).length;
      
      document.getElementById('teamCount').textContent = `${teams.length} team${teams.length !== 1 ? 's' : ''}`;
      document.getElementById('teamActiveCount').textContent = activeCount < teams.length ? `(${activeCount} active)` : '';
      
      if (teams.length === 0) {
        list.innerHTML = `
          <div class="article-row header" style="grid-template-columns: 50px 1fr 100px 80px 80px 100px 120px;">
            <div>Logo</div>
            <div>Team</div>
            <div>Level</div>
            <div>Division</div>
            <div>Gender</div>
            <div>Location</div>
            <div>Actions</div>
          </div>
          <div class="empty-state">
            <p>No teams found</p>
            <button class="btn-new" onclick="openTeamModal()">Add your first team</button>
          </div>
        `;
        return;
      }
      
      list.innerHTML = `
        <div class="article-row header" style="grid-template-columns: 50px 1fr 100px 80px 80px 100px 120px;">
          <div>Logo</div>
          <div>Team</div>
          <div>Level</div>
          <div>Division</div>
          <div>Gender</div>
          <div>Location</div>
          <div>Actions</div>
        </div>
        ${teams.map(team => {
          const logoName = (team.shortname || '').replace(/[^a-zA-Z0-9]/g, '');
          const logoSrc = team.logo_url || `/logos/100px/${logoName}.png`;
          return `
          <div class="article-row" style="grid-template-columns: 50px 1fr 100px 80px 80px 100px 120px; ${!team.active ? 'opacity: 0.5;' : ''}">
            <div style="text-align: center;">
              <img src="${logoSrc}" alt="" style="width: 32px; height: 32px; object-fit: contain;" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
              <span style="display: none; font-size: 18px;">ðŸ€</span>
            </div>
            <div>
              <div style="font-weight: 500; color: #333;">
                ${team.shortname} ${team.emoji || ''}
                ${team.combined_team ? '<span style="background: #e3f2fd; color: #1565c0; font-size: 9px; padding: 2px 5px; border-radius: 3px; margin-left: 5px;">COMBINED</span>' : ''}
              </div>
              <div style="font-size: 11px; color: #888;">${team.mascot || ''} ${team.abbrev ? '(' + team.abbrev + ')' : ''}</div>
            </div>
            <div style="font-size: 12px;">${team.level === 'High School' ? 'HS' : team.level === 'Prep School' ? 'Prep' : 'College'}</div>
            <div style="font-size: 12px;">${team.division || '-'}</div>
            <div style="font-size: 12px;">${team.gender || '-'}</div>
            <div style="font-size: 12px; color: #666;">${team.location || '-'}</div>
            <div class="article-actions">
              <button class="btn-edit" onclick="editTeam(${team.id})">Edit</button>
              <button class="btn-delete" onclick="deleteTeam(${team.id}, '${team.shortname}')">Delete</button>
            </div>
          </div>
        `}).join('')}
      `;
    }
    
    function openTeamModal(team = null) {
      document.getElementById('teamModalTitle').textContent = team ? 'Edit Team' : 'Add Team';
      document.getElementById('teamModal').style.display = 'block';
      document.body.style.overflow = 'hidden';
      
      // Reset form
      document.getElementById('teamId').value = team?.id || '';
      document.getElementById('teamFullName').value = team?.full_name || '';
      document.getElementById('teamShortname').value = team?.shortname || '';
      document.getElementById('teamAbbrev').value = team?.abbrev || '';
      document.getElementById('teamEmoji').value = team?.emoji || '';
      document.getElementById('teamMascot').value = team?.mascot || '';
      document.getElementById('teamLevel').value = team?.level || 'High School';
      updateDivisionOptions();
      document.getElementById('teamDivision').value = team?.division || '';
      document.getElementById('teamGender').value = team?.gender || '';
      document.getElementById('teamLocation').value = team?.location || '';
      document.getElementById('teamConference').value = team?.conference || '';
      document.getElementById('teamPrimaryHex').value = team?.primary_hex || '';
      document.getElementById('teamPrimaryHexPicker').value = team?.primary_hex || '#000000';
      document.getElementById('teamSecondaryHex').value = team?.secondary_hex || '';
      document.getElementById('teamSecondaryHexPicker').value = team?.secondary_hex || '#ffffff';
      document.getElementById('teamWebsite').value = team?.website || '';
      document.getElementById('teamLivestream').value = team?.livestream_url || '';
      document.getElementById('teamNotes').value = team?.notes || '';
      document.getElementById('teamActive').checked = team?.active !== false;
      
      // Logo URL
      document.getElementById('teamLogoUrl').value = team?.logo_url || '';
      
      // Combined team handling
      document.getElementById('teamCombined').checked = team?.combined_team || false;
      selectedCombinedTeamIds = team?.combined_with || [];
      toggleCombinedSection();
      renderSelectedCombinedTeams();
      
      // Update logo preview
      updateLogoPreview();
    }
    
    // Update logo preview - check custom URL first, then fall back to static path
    function updateLogoPreview() {
      const customLogoUrl = document.getElementById('teamLogoUrl').value;
      const shortname = document.getElementById('teamShortname').value.trim();
      const container = document.getElementById('teamLogoPreview');
      const removeBtn = document.getElementById('removeLogoBtn');
      
      // If there's a custom uploaded logo, show it
      if (customLogoUrl) {
        container.innerHTML = `<img src="${customLogoUrl}" alt="Team logo" style="max-width: 100%; max-height: 100%; object-fit: contain;">`;
        container.style.borderStyle = 'solid';
        removeBtn.style.display = 'inline-block';
        return;
      }
      
      removeBtn.style.display = 'none';
      container.style.borderStyle = 'dashed';
      
      if (!shortname) {
        container.innerHTML = '<span style="color: #ccc; font-size: 12px; text-align: center;">Click to<br>upload</span>';
        return;
      }
      
      // Try to load from static path
      const logoName = shortname.replace(/[^a-zA-Z0-9]/g, '');
      const logoUrl = `/logos/100px/${logoName}.png`;
      container.innerHTML = `<img src="${logoUrl}" alt="${shortname} logo" style="max-width: 100%; max-height: 100%; object-fit: contain;" onerror="this.parentElement.innerHTML='<span style=\\'color: #ccc; font-size: 11px; text-align: center;\\'>Click to<br>upload</span>'">`;
    }
    
    // Logo upload functions
    function triggerLogoUpload() {
      document.getElementById('logoUploadInput').click();
    }
    
    async function handleLogoUpload(event) {
      const file = event.target.files[0];
      if (!file) return;
      
      // Validate file type
      if (!file.type.startsWith('image/')) {
        showToast('Please select an image file', 'error');
        return;
      }
      
      // Show loading state
      const container = document.getElementById('teamLogoPreview');
      container.innerHTML = '<span style="color: #666; font-size: 11px;">Uploading...</span>';
      
      try {
        // Generate unique filename
        const shortname = document.getElementById('teamShortname').value.trim() || 'team';
        const logoName = shortname.replace(/[^a-zA-Z0-9]/g, '');
        const ext = file.name.split('.').pop();
        const filename = `logos/${logoName}-${Date.now()}.${ext}`;
        
        // Upload to Supabase Storage
        const { data, error } = await supabase.storage
          .from('images')
          .upload(filename, file, {
            cacheControl: '3600',
            upsert: false
          });
        
        if (error) throw error;
        
        // Get public URL
        const { data: urlData } = supabase.storage
          .from('images')
          .getPublicUrl(filename);
        
        const logoUrl = urlData.publicUrl;
        
        // Save to hidden field and update preview
        document.getElementById('teamLogoUrl').value = logoUrl;
        updateLogoPreview();
        showToast('Logo uploaded!', 'success');
        
      } catch (err) {
        console.error('Logo upload error:', err);
        showToast('Failed to upload logo: ' + err.message, 'error');
        updateLogoPreview(); // Reset preview
      }
      
      // Clear the file input
      event.target.value = '';
    }
    
    function removeTeamLogo() {
      document.getElementById('teamLogoUrl').value = '';
      updateLogoPreview();
      showToast('Logo removed (will use default if available)', 'success');
    }
    
    // Combined team variables and functions
    let selectedCombinedTeamIds = [];
    
    function toggleCombinedSection() {
      const isChecked = document.getElementById('teamCombined').checked;
      document.getElementById('combinedTeamSection').style.display = isChecked ? 'block' : 'none';
      if (isChecked) {
        renderCombinedTeamList();
      }
    }
    
    function renderCombinedTeamList(filter = '') {
      const currentTeamId = parseInt(document.getElementById('teamId').value) || 0;
      const currentGender = document.getElementById('teamGender').value;
      const currentLevel = document.getElementById('teamLevel').value;
      
      // Filter to same gender and level, exclude current team
      let eligibleTeams = allTeams.filter(t => 
        t.id !== currentTeamId &&
        t.gender === currentGender &&
        t.level === currentLevel
      );
      
      if (filter) {
        const search = filter.toLowerCase();
        eligibleTeams = eligibleTeams.filter(t => 
          t.shortname.toLowerCase().includes(search) ||
          t.full_name.toLowerCase().includes(search)
        );
      }
      
      const list = document.getElementById('combinedTeamList');
      
      if (eligibleTeams.length === 0) {
        list.innerHTML = '<div style="padding: 10px; color: #888; font-size: 12px;">No matching teams found</div>';
        return;
      }
      
      list.innerHTML = eligibleTeams.slice(0, 30).map(t => `
        <div style="padding: 8px 12px; border-bottom: 1px solid #eee; cursor: pointer; font-size: 13px; display: flex; align-items: center; gap: 8px; ${selectedCombinedTeamIds.includes(t.id) ? 'background: #fff3e0;' : ''}" 
             onclick="toggleCombinedTeam(${t.id}, '${t.shortname}', '${t.emoji || 'ðŸ€'}')">
          <input type="checkbox" ${selectedCombinedTeamIds.includes(t.id) ? 'checked' : ''} style="pointer-events: none;">
          <span>${t.emoji || 'ðŸ€'}</span>
          <span>${t.shortname}</span>
          <span style="color: #888; font-size: 11px;">${t.gender || ''}</span>
        </div>
      `).join('');
    }
    
    function filterCombinedTeams() {
      const filter = document.getElementById('combinedTeamSearch').value;
      renderCombinedTeamList(filter);
    }
    
    function toggleCombinedTeam(teamId, shortname, emoji) {
      const idx = selectedCombinedTeamIds.indexOf(teamId);
      if (idx > -1) {
        selectedCombinedTeamIds.splice(idx, 1);
      } else {
        selectedCombinedTeamIds.push(teamId);
      }
      renderCombinedTeamList(document.getElementById('combinedTeamSearch').value);
      renderSelectedCombinedTeams();
    }
    
    function renderSelectedCombinedTeams() {
      const container = document.getElementById('selectedCombinedTeams');
      
      if (selectedCombinedTeamIds.length === 0) {
        container.innerHTML = '<span style="font-size: 12px; color: #888;">No teams selected</span>';
        return;
      }
      
      const selectedTeams = allTeams.filter(t => selectedCombinedTeamIds.includes(t.id));
      container.innerHTML = selectedTeams.map(t => `
        <span style="background: #f57c00; color: white; padding: 4px 10px; border-radius: 20px; font-size: 12px; display: inline-flex; align-items: center; gap: 5px;">
          ${t.emoji || 'ðŸ€'} ${t.shortname}
          <span style="cursor: pointer; margin-left: 3px;" onclick="removeCombinedTeam(${t.id})">&times;</span>
        </span>
      `).join('');
    }
    
    function removeCombinedTeam(teamId) {
      selectedCombinedTeamIds = selectedCombinedTeamIds.filter(id => id !== teamId);
      renderCombinedTeamList(document.getElementById('combinedTeamSearch').value);
      renderSelectedCombinedTeams();
    }
    
    function closeTeamModal() {
      document.getElementById('teamModal').style.display = 'none';
      document.body.style.overflow = 'auto';
    }
    
    function updateDivisionOptions() {
      const level = document.getElementById('teamLevel').value;
      const divSelect = document.getElementById('teamDivision');
      const currentVal = divSelect.value;
      
      if (level === 'High School') {
        divSelect.innerHTML = `
          <option value="">None</option>
          <option value="D1">D1</option>
          <option value="D2">D2</option>
          <option value="D3">D3</option>
          <option value="D4">D4</option>
        `;
      } else if (level === 'Prep School') {
        divSelect.innerHTML = `
          <option value="">None</option>
          <option value="NEPSAC">NEPSAC</option>
        `;
      } else {
        divSelect.innerHTML = `
          <option value="">None</option>
          <option value="DI">DI (NCAA)</option>
          <option value="DII">DII (NCAA)</option>
          <option value="DIII">DIII (NCAA)</option>
        `;
      }
      
      // Try to restore previous value if still valid
      const validOptions = [...divSelect.options].map(o => o.value);
      if (validOptions.includes(currentVal)) {
        divSelect.value = currentVal;
      }
    }
    
    function syncColorPicker(pickerId, hexValue) {
      if (/^#[0-9A-Fa-f]{6}$/.test(hexValue)) {
        document.getElementById(pickerId).value = hexValue;
      }
    }
    
    async function editTeam(teamId) {
      const team = allTeams.find(t => t.id === teamId);
      if (team) {
        openTeamModal(team);
      }
    }
    
    async function saveTeam() {
      const teamId = document.getElementById('teamId').value;
      const teamData = {
        full_name: document.getElementById('teamFullName').value.trim(),
        shortname: document.getElementById('teamShortname').value.trim(),
        abbrev: document.getElementById('teamAbbrev').value.trim().toUpperCase(),
        emoji: document.getElementById('teamEmoji').value.trim() || null,
        mascot: document.getElementById('teamMascot').value.trim() || null,
        level: document.getElementById('teamLevel').value,
        division: document.getElementById('teamDivision').value || null,
        gender: document.getElementById('teamGender').value || null,
        location: document.getElementById('teamLocation').value.trim() || null,
        conference: document.getElementById('teamConference').value.trim() || null,
        primary_hex: document.getElementById('teamPrimaryHex').value.trim() || null,
        secondary_hex: document.getElementById('teamSecondaryHex').value.trim() || null,
        website: document.getElementById('teamWebsite').value.trim() || null,
        livestream_url: document.getElementById('teamLivestream').value.trim() || null,
        logo_url: document.getElementById('teamLogoUrl').value.trim() || null,
        notes: document.getElementById('teamNotes').value.trim() || null,
        active: document.getElementById('teamActive').checked,
        combined_team: document.getElementById('teamCombined').checked,
        combined_with: document.getElementById('teamCombined').checked && selectedCombinedTeamIds.length > 0 
          ? selectedCombinedTeamIds 
          : null
      };
      
      // Validation
      if (!teamData.full_name || !teamData.shortname || !teamData.abbrev || !teamData.level) {
        showToast('Please fill in required fields', 'error');
        return;
      }
      
      try {
        const url = teamId 
          ? `/.netlify/functions/teams?id=${teamId}` 
          : '/.netlify/functions/teams';
        
        const response = await fetch(url, {
          method: teamId ? 'PUT' : 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(teamData)
        });
        
        const result = await response.json();
        
        if (result.success) {
          showToast(teamId ? 'Team updated!' : 'Team created!', 'success');
          closeTeamModal();
          loadTeams();
        } else {
          showToast(result.error || 'Error saving team', 'error');
        }
      } catch (err) {
        console.error('Error saving team:', err);
        showToast('Could not save team', 'error');
      }
    }
    
    async function deleteTeam(teamId, teamName) {
      if (!confirm(`Are you sure you want to delete ${teamName}?`)) return;
      
      try {
        const response = await fetch(`/.netlify/functions/teams?id=${teamId}`, {
          method: 'DELETE'
        });
        
        const result = await response.json();
        
        if (result.success) {
          showToast('Team deleted', 'success');
          loadTeams();
        } else {
          showToast(result.error || 'Error deleting team', 'error');
        }
      } catch (err) {
        console.error('Error deleting team:', err);
        showToast('Could not delete team', 'error');
      }
    }
    
    // CSV Import Functions
    function openImportModal() {
      document.getElementById('importModal').style.display = 'block';
      document.body.style.overflow = 'hidden';
      document.getElementById('importPreview').style.display = 'none';
      document.getElementById('importResults').style.display = 'none';
      document.getElementById('btnExecuteImport').disabled = true;
      importTeamsData = [];
    }
    
    function closeImportModal() {
      document.getElementById('importModal').style.display = 'none';
      document.body.style.overflow = 'auto';
    }
    
    function handleCsvFile(file) {
      if (!file) return;
      
      const reader = new FileReader();
      reader.onload = function(e) {
        const csv = e.target.result;
        parseCsv(csv, file.name);
      };
      reader.readAsText(file);
    }
    
    function parseCsv(csv, filename) {
      const lines = csv.split('\n').filter(line => line.trim());
      if (lines.length < 2) {
        showToast('CSV file appears empty', 'error');
        return;
      }
      
      // Detect delimiter (tab or comma)
      const firstLine = lines[0];
      const delimiter = firstLine.includes('\t') ? '\t' : ',';
      
      const headers = firstLine.split(delimiter).map(h => h.trim().toLowerCase().replace(/[^a-z0-9_\s]/g, ''));
      const teams = [];
      
      // Header mapping from Google Sheets to database columns
      const headerMap = {
        'team id': '_skip',
        'full school name': 'full_name',
        'fullschoolname': 'full_name',
        'full_name': 'full_name',
        'fullname': 'full_name',
        'name': 'full_name',
        'shortname': 'shortname',
        'short': 'shortname',
        'abbrev': 'abbrev',
        'abbr': 'abbrev',
        'abbreviation': 'abbrev',
        'level': 'level',
        'conference': 'conference',
        'gender': 'gender',
        'division': 'division',
        'location': 'location',
        'town': 'location',
        'city': 'location',
        'mascot': 'mascot',
        'primary color': 'primary_color',
        'primarycolor': 'primary_color',
        'primary_color': 'primary_color',
        'primary hex': 'primary_hex',
        'primaryhex': 'primary_hex',
        'primary_hex': 'primary_hex',
        'secondary color': 'secondary_color',
        'secondarycolor': 'secondary_color',
        'secondary_color': 'secondary_color',
        'secondary hex': 'secondary_hex',
        'secondaryhex': 'secondary_hex',
        'secondary_hex': 'secondary_hex',
        'official website': 'website',
        'officialwebsite': 'website',
        'website': 'website',
        'live stream link': 'livestream_url',
        'livestreamlink': 'livestream_url',
        'livestream_url': 'livestream_url',
        'livestream': 'livestream_url',
        'combined team': 'combined_team',
        'combinedteam': 'combined_team',
        'combined_team': 'combined_team',
        'combined with team ids': 'combined_with',
        'combinedwithteamids': 'combined_with',
        'combined_with': 'combined_with',
        'active': 'active',
        'active_': 'active',
        'notes': 'notes',
        'emoji': 'emoji'
      };
      
      for (let i = 1; i < lines.length; i++) {
        const values = delimiter === '\t' ? lines[i].split('\t') : parseCSVLine(lines[i]);
        
        // Allow slight mismatch in column count (some CSVs have trailing commas)
        if (values.length < headers.length - 1) continue;
        
        const team = {};
        headers.forEach((h, idx) => {
          let val = values[idx]?.trim() || null;
          
          // Map header to database column
          const dbColumn = headerMap[h] || h.replace(/\s+/g, '_');
          
          // Skip certain columns
          if (dbColumn === '_skip' || !dbColumn) return;
          
          // Handle boolean fields
          if (dbColumn === 'active' || dbColumn === 'combined_team') {
            if (val === null || val === '') {
              val = dbColumn === 'active' ? true : false;
            } else {
              val = val.toLowerCase() === 'true' || val === '1' || val.toLowerCase() === 'yes';
            }
          }
          
          // Handle combined_with as array (skip for now, complex)
          if (dbColumn === 'combined_with' && val) {
            // Could parse comma-separated IDs, but skip for initial import
            return;
          }
          
          team[dbColumn] = val;
        });
        
        // Only add if has required fields
        if (team.full_name && team.shortname && team.abbrev && team.level) {
          teams.push(team);
        }
      }
      
      console.log('Parsed headers:', headers);
      console.log('First team parsed:', teams[0] || 'none');
      
      if (teams.length === 0) {
        console.log('Header mapping check:', headers.map(h => h + ' -> ' + (headerMap[h] || h.replace(/\s+/g, '_'))));
        showToast('No valid teams found in CSV. Check required fields: Full School Name, Shortname, abbrev, Level', 'error');
        return;
      }
      
      importTeamsData = teams;
      showImportPreview(teams, filename);
    }
    
    function parseCSVLine(line) {
      const result = [];
      let current = '';
      let inQuotes = false;
      
      for (let i = 0; i < line.length; i++) {
        const char = line[i];
        if (char === '"') {
          inQuotes = !inQuotes;
        } else if (char === ',' && !inQuotes) {
          result.push(current);
          current = '';
        } else {
          current += char;
        }
      }
      result.push(current);
      return result;
    }
    
    function showImportPreview(teams, filename) {
      document.getElementById('importPreview').style.display = 'block';
      document.getElementById('importPreviewCount').textContent = `${teams.length} teams ready to import`;
      document.getElementById('importPreviewFile').textContent = filename;
      document.getElementById('btnExecuteImport').disabled = false;
      
      const tbody = document.getElementById('importPreviewBody');
      tbody.innerHTML = teams.slice(0, 50).map(t => `
        <tr>
          <td style="padding: 6px 8px;">${t.shortname}</td>
          <td style="padding: 6px 8px;">${t.full_name}</td>
          <td style="padding: 6px 8px;">${t.level}</td>
          <td style="padding: 6px 8px;">${t.division || '-'}</td>
        </tr>
      `).join('');
      
      if (teams.length > 50) {
        tbody.innerHTML += `<tr><td colspan="4" style="padding: 8px; color: #888; text-align: center;">...and ${teams.length - 50} more</td></tr>`;
      }
    }
    
    async function executeImport() {
      if (importTeamsData.length === 0) return;
      
      document.getElementById('btnExecuteImport').disabled = true;
      document.getElementById('btnExecuteImport').textContent = 'Importing...';
      
      try {
        const response = await fetch('/.netlify/functions/teams', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ teams: importTeamsData })
        });
        
        const result = await response.json();
        
        const resultsDiv = document.getElementById('importResults');
        resultsDiv.style.display = 'block';
        
        if (result.success) {
          resultsDiv.style.background = '#e8f5e9';
          resultsDiv.innerHTML = `
            <strong style="color: #2e7d32;">âœ“ Import Complete</strong><br>
            <span style="font-size: 13px;">${result.results.inserted} inserted, ${result.results.updated} updated</span>
          `;
          showToast('Teams imported successfully!', 'success');
          loadTeams();
        } else {
          resultsDiv.style.background = '#ffebee';
          resultsDiv.innerHTML = `
            <strong style="color: #c62828;">Import had errors</strong><br>
            <span style="font-size: 13px;">${result.results?.inserted || 0} inserted, ${result.results?.updated || 0} updated, ${result.results?.errors?.length || 0} errors</span>
            ${result.results?.errors?.length ? '<br><small>' + result.results.errors.slice(0, 5).map(e => e.team + ': ' + e.error).join('<br>') + '</small>' : ''}
          `;
        }
      } catch (err) {
        console.error('Import error:', err);
        showToast('Import failed', 'error');
      }
      
      document.getElementById('btnExecuteImport').textContent = 'Import Teams';
    }
    
    function exportTeams() {
      if (allTeams.length === 0) {
        showToast('No teams to export', 'error');
        return;
      }
      
      const headers = ['full_name', 'shortname', 'abbrev', 'emoji', 'mascot', 'level', 'division', 'gender', 'location', 'conference', 'primary_color', 'primary_hex', 'secondary_color', 'secondary_hex', 'website', 'livestream_url', 'active'];
      
      let csv = headers.join(',') + '\n';
      
      allTeams.forEach(team => {
        const row = headers.map(h => {
          let val = team[h];
          if (val === null || val === undefined) return '';
          if (typeof val === 'boolean') return val ? 'true' : 'false';
          val = String(val);
          if (val.includes(',') || val.includes('"') || val.includes('\n')) {
            return '"' + val.replace(/"/g, '""') + '"';
          }
          return val;
        });
        csv += row.join(',') + '\n';
      });
      
      const blob = new Blob([csv], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `ball603-teams-${new Date().toISOString().split('T')[0]}.csv`;
      a.click();
      URL.revokeObjectURL(url);
      
      showToast('Teams exported!', 'success');
    }
    
    // ==================== CONTRIBUTOR MANAGER ====================
    
    let allContributors = [];
    
    async function loadContributors() {
      document.getElementById('contributorList').innerHTML = `
        <div class="article-row header" style="grid-template-columns: 50px 1fr 150px 120px 100px 120px;">
          <div></div>
          <div>Name</div>
          <div>Type</div>
          <div>Area</div>
          <div>Status</div>
          <div>Actions</div>
        </div>
        <div class="loading">Loading contributors...</div>
      `;
      
      const { data, error } = await supabase
        .from('contributors')
        .select('*')
        .order('name');
      
      if (error) {
        console.error('Error loading contributors:', error);
        showToast('Error loading contributors', 'error');
        return;
      }
      
      allContributors = data || [];
      filterContributors();
      updateEmailLists();
    }
    
    function filterContributors() {
      const typeFilter = document.getElementById('contributorTypeFilter').value;
      const statusFilter = document.getElementById('contributorStatusFilter').value;
      const search = document.getElementById('contributorSearch').value.toLowerCase();
      
      let filtered = allContributors;
      
      // Type filter
      if (typeFilter === 'photographer') filtered = filtered.filter(c => c.is_photographer);
      else if (typeFilter === 'videographer') filtered = filtered.filter(c => c.is_videographer);
      else if (typeFilter === 'writer') filtered = filtered.filter(c => c.is_writer);
      else if (typeFilter === 'graphics') filtered = filtered.filter(c => c.is_graphics);
      else if (typeFilter === 'administrative') filtered = filtered.filter(c => c.is_administrative);
      
      // Status filter
      if (statusFilter === 'active') filtered = filtered.filter(c => c.active);
      else if (statusFilter === 'inactive') filtered = filtered.filter(c => !c.active);
      
      // Search
      if (search) {
        filtered = filtered.filter(c => 
          c.name.toLowerCase().includes(search) ||
          (c.email && c.email.toLowerCase().includes(search)) ||
          (c.primary_area && c.primary_area.toLowerCase().includes(search))
        );
      }
      
      renderContributorList(filtered);
    }
    
    function renderContributorList(contributors) {
      const list = document.getElementById('contributorList');
      
      document.getElementById('contributorCount').textContent = `${contributors.length} contributor${contributors.length !== 1 ? 's' : ''}`;
      
      if (contributors.length === 0) {
        list.innerHTML = `
          <div class="article-row header" style="grid-template-columns: 50px 1fr 150px 120px 100px 120px;">
            <div></div>
            <div>Name</div>
            <div>Type</div>
            <div>Area</div>
            <div>Status</div>
            <div>Actions</div>
          </div>
          <div class="empty-state">
            <p>No contributors found</p>
          </div>
        `;
        return;
      }
      
      list.innerHTML = `
        <div class="article-row header" style="grid-template-columns: 50px 1fr 150px 120px 100px 120px;">
          <div></div>
          <div>Name</div>
          <div>Type</div>
          <div>Area</div>
          <div>Status</div>
          <div>Actions</div>
        </div>
        ${contributors.map(c => {
          const types = [];
          if (c.is_photographer) types.push('ðŸ“¸');
          if (c.is_videographer) types.push('ðŸŽ¥');
          if (c.is_writer) types.push('ðŸ“');
          if (c.is_graphics) types.push('ðŸŽ¨');
          if (c.is_administrative) types.push('ðŸ”§');
          
          return `
          <div class="article-row" style="grid-template-columns: 50px 1fr 150px 120px 100px 120px; ${!c.active ? 'opacity: 0.5;' : ''}">
            <div style="text-align: center;">
              ${c.headshot_url ? `<img src="${c.headshot_url}" style="width: 36px; height: 36px; border-radius: 50%; object-fit: cover;">` : '<span style="font-size: 24px;">ðŸ‘¤</span>'}
            </div>
            <div>
              <div style="font-weight: 500; color: #333;">${c.name}</div>
              <div style="font-size: 11px; color: #888;">${c.email}</div>
            </div>
            <div style="font-size: 16px;">${types.join(' ') || '-'}</div>
            <div style="font-size: 12px; color: #666;">${c.primary_area || '-'}</div>
            <div>
              <button onclick="toggleContributorActive(${c.id}, ${!c.active})" style="background: ${c.active ? '#e8f5e9' : '#ffebee'}; color: ${c.active ? '#2e7d32' : '#c62828'}; border: none; padding: 4px 10px; border-radius: 12px; font-size: 11px; cursor: pointer;">
                ${c.active ? 'Active' : 'Inactive'}
              </button>
            </div>
            <div class="article-actions">
              <button class="btn-edit" onclick="editContributor(${c.id})">Edit</button>
            </div>
          </div>
        `}).join('')}
      `;
    }
    
    function updateEmailLists() {
      const active = allContributors.filter(c => c.active);
      
      document.getElementById('emailListAll').value = active.map(c => c.email).join(', ');
      document.getElementById('emailListPhotog').value = active.filter(c => c.is_photographer).map(c => c.email).join(', ');
      document.getElementById('emailListVideog').value = active.filter(c => c.is_videographer).map(c => c.email).join(', ');
      document.getElementById('emailListWriter').value = active.filter(c => c.is_writer).map(c => c.email).join(', ');
      document.getElementById('emailListGraphics').value = active.filter(c => c.is_graphics).map(c => c.email).join(', ');
    }
    
    function toggleEmailLists() {
      const container = document.getElementById('emailListsContainer');
      const btn = document.getElementById('emailListToggle');
      if (container.style.display === 'none') {
        container.style.display = 'block';
        btn.textContent = 'Hide Lists â–²';
      } else {
        container.style.display = 'none';
        btn.textContent = 'Show Lists â–¼';
      }
    }
    
    function copyEmailList(id) {
      const textarea = document.getElementById(id);
      navigator.clipboard.writeText(textarea.value);
      showToast('Email list copied!', 'success');
    }
    
    async function toggleContributorActive(id, active) {
      const { error } = await supabase
        .from('contributors')
        .update({ active, updated_at: new Date().toISOString() })
        .eq('id', id);
      
      if (error) {
        showToast('Error updating status', 'error');
        return;
      }
      
      const contrib = allContributors.find(c => c.id === id);
      if (contrib) contrib.active = active;
      filterContributors();
      updateEmailLists();
      showToast(active ? 'Contributor activated' : 'Contributor deactivated', 'success');
    }
    
    function editContributor(id) {
      const contrib = allContributors.find(c => c.id === id);
      if (!contrib) return;
      
      document.getElementById('contributorModalTitle').textContent = 'Edit Contributor';
      document.getElementById('contributorModal').style.display = 'block';
      document.body.style.overflow = 'hidden';
      
      document.getElementById('contributorId').value = contrib.id;
      document.getElementById('contribName').value = contrib.name || '';
      document.getElementById('contribEmail').value = contrib.email || '';
      document.getElementById('contribPrimaryArea').value = contrib.primary_area || '';
      document.getElementById('contribCell').value = contrib.cell || '';
      document.getElementById('contribAddress').value = contrib.mailing_address || '';
      document.getElementById('contribVenmo').value = contrib.venmo || '';
      document.getElementById('contribShirtSize').value = contrib.shirt_size || '';
      document.getElementById('contribSmugmugName').value = contrib.smugmug_name || '';
      
      document.getElementById('contribIsPhotographer').checked = contrib.is_photographer || false;
      document.getElementById('contribIsVideographer').checked = contrib.is_videographer || false;
      document.getElementById('contribIsWriter').checked = contrib.is_writer || false;
      document.getElementById('contribIsGraphics').checked = contrib.is_graphics || false;
      document.getElementById('contribIsAdministrative').checked = contrib.is_administrative || false;
      
      document.getElementById('contribTop10Url').value = contrib.top10_dropbox_url || '';
      document.getElementById('contribActive').checked = contrib.active !== false;
      
      // Show auth status if they have an auth account
      document.getElementById('contribAuthStatus').style.display = contrib.auth_user_id ? 'block' : 'none';
    }
    
    function closeContributorModal() {
      document.getElementById('contributorModal').style.display = 'none';
      document.body.style.overflow = 'auto';
    }
    
    async function saveContributor() {
      const id = document.getElementById('contributorId').value;
      
      const updateData = {
        name: document.getElementById('contribName').value.trim(),
        email: document.getElementById('contribEmail').value.trim(),
        primary_area: document.getElementById('contribPrimaryArea').value.trim() || null,
        cell: document.getElementById('contribCell').value.trim() || null,
        mailing_address: document.getElementById('contribAddress').value.trim() || null,
        venmo: document.getElementById('contribVenmo').value.trim() || null,
        shirt_size: document.getElementById('contribShirtSize').value || null,
        smugmug_name: document.getElementById('contribSmugmugName').value.trim() || null,
        is_photographer: document.getElementById('contribIsPhotographer').checked,
        is_videographer: document.getElementById('contribIsVideographer').checked,
        is_writer: document.getElementById('contribIsWriter').checked,
        is_graphics: document.getElementById('contribIsGraphics').checked,
        is_administrative: document.getElementById('contribIsAdministrative').checked,
        top10_dropbox_url: document.getElementById('contribTop10Url').value.trim() || null,
        active: document.getElementById('contribActive').checked,
        updated_at: new Date().toISOString()
      };
      
      if (!updateData.name || !updateData.email) {
        showToast('Name and email are required', 'error');
        return;
      }
      
      const { error } = await supabase
        .from('contributors')
        .update(updateData)
        .eq('id', id);
      
      if (error) {
        showToast('Error saving contributor', 'error');
        return;
      }
      
      closeContributorModal();
      loadContributors();
      showToast('Contributor saved!', 'success');
    }
    
    async function deleteContributor() {
      const id = document.getElementById('contributorId').value;
      const name = document.getElementById('contribName').value;
      
      if (!id) return;
      
      if (!confirm(`Are you sure you want to delete ${name}?\n\nThis will also delete their login account and cannot be undone.`)) {
        return;
      }
      
      try {
        const response = await fetch('/.netlify/functions/contributor-invite', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ action: 'delete', contributorId: parseInt(id) })
        });
        
        const result = await response.json();
        
        if (result.success) {
          closeContributorModal();
          loadContributors();
          showToast(result.message, 'success');
        } else {
          showToast('Error: ' + (result.error || 'Unknown error'), 'error');
        }
      } catch (err) {
        showToast('Error deleting contributor', 'error');
      }
    }
    
    function showCreateAccount() {
      document.getElementById('createAccountModal').style.display = 'block';
      document.body.style.overflow = 'hidden';
      document.getElementById('createName').value = '';
      document.getElementById('createEmail').value = '';
      document.getElementById('createPassword').value = 'Gr@niteSt@teHoops';
    }
    
    function closeCreateAccountModal() {
      document.getElementById('createAccountModal').style.display = 'none';
      document.body.style.overflow = 'auto';
    }
    
    async function createAccount() {
      const name = document.getElementById('createName').value.trim();
      const email = document.getElementById('createEmail').value.trim();
      const password = document.getElementById('createPassword').value;
      
      if (!name || !email || !password) {
        showToast('Name, email, and password are required', 'error');
        return;
      }
      
      try {
        const response = await fetch('/.netlify/functions/contributor-invite', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            action: 'create-account',
            name,
            email,
            password
          })
        });
        
        const result = await response.json();
        
        if (result.success) {
          showToast(result.message, 'success');
          closeCreateAccountModal();
          loadContributors();
        } else {
          showToast('Error: ' + (result.error || 'Unknown error'), 'error');
        }
      } catch (err) {
        showToast('Error creating account', 'error');
      }
    }
    
    async function bulkCreateAccounts() {
      // Find contributors without auth accounts
      const noAuth = allContributors.filter(c => !c.auth_user_id);
      
      if (noAuth.length === 0) {
        showToast('All contributors already have accounts!', 'success');
        return;
      }
      
      const password = prompt(`Create accounts for ${noAuth.length} contributor(s):\n\n${noAuth.map(c => c.name).join('\n')}\n\nEnter password for all accounts:`, 'Gr@niteSt@teHoops');
      
      if (!password) return;
      
      showToast(`Creating ${noAuth.length} accounts...`, 'success');
      
      try {
        const response = await fetch('/.netlify/functions/contributor-invite', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            action: 'bulk-create',
            password
          })
        });
        
        const result = await response.json();
        
        if (result.success) {
          showToast(result.message, 'success');
          if (result.results?.failed?.length > 0) {
            console.log('Failed:', result.results.failed);
          }
          loadContributors();
        } else {
          showToast('Error: ' + (result.error || 'Unknown error'), 'error');
        }
      } catch (err) {
        showToast('Error creating accounts', 'error');
      }
    }
    
    function exportContributorsCSV() {
      const headers = ['Name', 'Email', 'Primary Area', 'Cell', 'Mailing Address', 'Venmo', 'Shirt Size', 
                       'NHIAA Alma Mater', 'College', 'Photographer', 'Videographer', 'Writer', 'Graphics', 
                       'Administrative', 'Website', 'Instagram', 'Facebook', 'Twitter', 'Camera Brand', 
                       'Computer Preference', 'Bio', 'SmugMug Name', 'Active', 'Has Account'];
      
      const rows = allContributors.map(c => [
        c.name || '',
        c.email || '',
        c.primary_area || '',
        c.cell || '',
        c.mailing_address || '',
        c.venmo || '',
        c.shirt_size || '',
        c.nhiaa_alma_mater || '',
        c.college || '',
        c.is_photographer ? 'Yes' : 'No',
        c.is_videographer ? 'Yes' : 'No',
        c.is_writer ? 'Yes' : 'No',
        c.is_graphics ? 'Yes' : 'No',
        c.is_administrative ? 'Yes' : 'No',
        c.website_url || '',
        c.instagram_url || '',
        c.facebook_url || '',
        c.twitter_url || '',
        c.camera_brand || '',
        c.computer_preference || '',
        (c.bio || '').replace(/"/g, '""'),
        c.smugmug_name || '',
        c.active ? 'Yes' : 'No',
        c.auth_user_id ? 'Yes' : 'No'
      ].map(val => `"${val}"`).join(','));
      
      const csv = [headers.join(','), ...rows].join('\n');
      const blob = new Blob([csv], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `ball603-contributors-${new Date().toISOString().split('T')[0]}.csv`;
      a.click();
      URL.revokeObjectURL(url);
      showToast('CSV exported!', 'success');
    }
    
    // ==================== SCHEDULE MANAGER ====================
    
    let allGames = [];
    let filteredGames = [];
    let importGamesData = [];
    
    async function loadGames() {
      try {
        const response = await fetch('/.netlify/functions/games?limit=5000');
        allGames = await response.json();
        filterGames();
        populateTeamsDatalist();
      } catch (err) {
        console.error('Failed to load games:', err);
        document.getElementById('gameList').innerHTML = '<div class="loading" style="color: #c62828;">Failed to load games</div>';
      }
    }
    
    function populateTeamsDatalist() {
      const datalist = document.getElementById('teamsList');
      if (!datalist || !allTeams) return;
      datalist.innerHTML = allTeams.map(t => `<option value="${t.shortname}">`).join('');
    }
    
    function filterGames() {
      const startDate = document.getElementById('gameStartDate')?.value;
      const endDate = document.getElementById('gameEndDate')?.value;
      const level = document.getElementById('gameLevelFilter')?.value;
      const division = document.getElementById('gameDivisionFilter')?.value;
      const gender = document.getElementById('gameGenderFilter')?.value;
      const search = document.getElementById('gameSearchBox')?.value?.toLowerCase();
      const coverageOnly = document.getElementById('showCoverageOnly')?.checked;
      const finalOnly = document.getElementById('showFinalOnly')?.checked;
      
      filteredGames = allGames.filter(g => {
        if (startDate && g.date < startDate) return false;
        if (endDate && g.date > endDate) return false;
        if (level && g.level !== level) return false;
        if (division && g.division !== division) return false;
        if (gender && g.gender !== gender) return false;
        if (search && !g.home_team?.toLowerCase().includes(search) && !g.away_team?.toLowerCase().includes(search)) return false;
        if (coverageOnly && !g.photog1 && !g.photog2 && !g.videog && !g.writer) return false;
        if (finalOnly && g.status !== 'final') return false;
        return true;
      });
      
      renderGameList();
    }
    
    function renderGameList() {
      const container = document.getElementById('gameList');
      const countEl = document.getElementById('gameCount');
      
      const finalCount = filteredGames.filter(g => g.status === 'final').length;
      countEl.textContent = `${filteredGames.length} games (${finalCount} final)`;
      
      if (filteredGames.length === 0) {
        container.innerHTML = `
          <div class="article-row header" style="grid-template-columns: 90px 1fr 1fr 70px 80px 50px 80px 100px;">
            <div>Date</div>
            <div>Away</div>
            <div>Home</div>
            <div>Score</div>
            <div>Division</div>
            <div>URLs</div>
            <div>Coverage</div>
            <div>Actions</div>
          </div>
          <div style="padding: 40px; text-align: center; color: #888;">No games found</div>
        `;
        return;
      }
      
      container.innerHTML = `
        <div class="article-row header" style="grid-template-columns: 90px 1fr 1fr 70px 80px 50px 80px 100px;">
          <div>Date</div>
          <div>Away</div>
          <div>Home</div>
          <div>Score</div>
          <div>Division</div>
          <div>URLs</div>
          <div>Coverage</div>
          <div>Actions</div>
        </div>
        ${filteredGames.map(game => {
          // Check for non-empty string values
          const hasPhotog = (game.photog1 && game.photog1.trim()) || (game.photog2 && game.photog2.trim());
          const hasVideog = game.videog && game.videog.trim();
          const hasWriter = game.writer && game.writer.trim();
          
          const coverageIcons = [];
          if (hasPhotog) coverageIcons.push('ðŸ“·');
          if (hasVideog) coverageIcons.push('ðŸŽ¥');
          if (hasWriter) coverageIcons.push('âœï¸');
          
          // Check for URLs
          const hasUrls = game.photos_url || game.recap_url || game.highlights_url || game.live_stream_url;
          const urlCount = [game.photos_url, game.recap_url, game.highlights_url, game.live_stream_url].filter(Boolean).length;
          
          const score = game.status === 'final' 
            ? `${game.away_score || 0}-${game.home_score || 0}`
            : (game.time || '-');
          
          const dateDisplay = new Date(game.date + 'T12:00:00').toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
          
          return `
            <div class="article-row" style="grid-template-columns: 90px 1fr 1fr 70px 80px 50px 80px 100px; ${game.status === 'cancelled' ? 'opacity: 0.5; text-decoration: line-through;' : ''}">
              <div style="font-size: 12px;">
                <div>${dateDisplay}</div>
                <div style="font-size: 10px; color: #888;">${game.gender || ''}</div>
              </div>
              <div style="font-size: 13px;">${game.away_team || '-'}</div>
              <div style="font-size: 13px; font-weight: 500;">${game.home_team || '-'}</div>
              <div style="font-size: 12px; ${game.status === 'final' ? 'font-weight: 600;' : 'color: #888;'}">${score}</div>
              <div style="font-size: 11px; color: #666;">${game.division || '-'}</div>
              <div style="text-align: center;">
                <button onclick="openUrlModal(${game.id})" style="background: ${hasUrls ? '#f3e5f5' : '#f5f5f5'}; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 12px;" title="${hasUrls ? urlCount + ' URL(s) set' : 'No URLs'}">
                  ${hasUrls ? 'ðŸ”—' : 'â—‹'}
                </button>
              </div>
              <div style="font-size: 14px;">${coverageIcons.join(' ') || '-'}</div>
              <div class="article-actions">
                <button class="btn-edit" onclick="editGame(${game.id})">Edit</button>
                <button class="btn-delete" onclick="deleteGame(${game.id})">Delete</button>
              </div>
            </div>
          `;
        }).join('')}
      `;
    }
    
    function openGameModal(game = null) {
      document.getElementById('gameModalTitle').textContent = game ? 'Edit Game' : 'Add Game';
      document.getElementById('gameModal').style.display = 'block';
      document.body.style.overflow = 'hidden';
      
      // Reset form
      document.getElementById('gameId').value = game?.id || '';
      document.getElementById('gameExternalId').value = game?.game_id || '';
      document.getElementById('gameDate').value = game?.date || '';
      document.getElementById('gameTime').value = game?.time || '';
      document.getElementById('gameStatus').value = game?.status || 'scheduled';
      document.getElementById('gameAwayTeam').value = game?.away_team || '';
      document.getElementById('gameAwayScore').value = game?.away_score ?? '';
      document.getElementById('gameHomeTeam').value = game?.home_team || '';
      document.getElementById('gameHomeScore').value = game?.home_score ?? '';
      document.getElementById('gameLevel').value = game?.level || 'NHIAA';
      updateGameDivisionOptions();
      document.getElementById('gameDivision').value = game?.division || '';
      document.getElementById('gameGender').value = game?.gender || 'Boys';
      document.getElementById('gamePhotog1').value = game?.photog1 || '';
      document.getElementById('gamePhotog2').value = game?.photog2 || '';
      document.getElementById('gameVideog').value = game?.videog || '';
      document.getElementById('gameWriter').value = game?.writer || '';
      document.getElementById('gamePhotosUrl').value = game?.photos_url || '';
      document.getElementById('gameRecapUrl').value = game?.recap_url || '';
      document.getElementById('gameHighlightsUrl').value = game?.highlights_url || '';
      document.getElementById('gameLiveStreamUrl').value = game?.live_stream_url || '';
      document.getElementById('gameSpecialEvent').value = game?.special_event || '';
      document.getElementById('gameLocation').value = game?.location || '';
      document.getElementById('gameNotes').value = game?.notes || '';
    }
    
    function closeGameModal() {
      document.getElementById('gameModal').style.display = 'none';
      document.body.style.overflow = 'auto';
    }
    
    function updateGameDivisionOptions() {
      const level = document.getElementById('gameLevel').value;
      const divSelect = document.getElementById('gameDivision');
      const currentVal = divSelect.value;
      
      if (level === 'NHIAA') {
        divSelect.innerHTML = `
          <option value="">None</option>
          <option value="D-I">D-I</option>
          <option value="D-II">D-II</option>
          <option value="D-III">D-III</option>
          <option value="D-IV">D-IV</option>
        `;
      } else if (level === 'Prep School') {
        divSelect.innerHTML = `
          <option value="">None</option>
          <option value="NEPSAC">NEPSAC</option>
        `;
      } else {
        divSelect.innerHTML = `
          <option value="">None</option>
          <option value="D1">D1 (NCAA)</option>
          <option value="D2">D2 (NCAA)</option>
          <option value="D3">D3 (NCAA)</option>
        `;
      }
      
      const validOptions = [...divSelect.options].map(o => o.value);
      if (validOptions.includes(currentVal)) {
        divSelect.value = currentVal;
      }
    }
    
    async function editGame(gameId) {
      const game = allGames.find(g => g.id === gameId);
      if (game) {
        openGameModal(game);
      }
    }
    
    // URL Modal Functions
    function openUrlModal(gameId) {
      const game = allGames.find(g => g.id === gameId);
      if (!game) return;
      
      document.getElementById('urlGameId').value = gameId;
      document.getElementById('urlGameTitle').textContent = `${game.away_team} @ ${game.home_team}`;
      
      const dateDisplay = new Date(game.date + 'T12:00:00').toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric', year: 'numeric' });
      document.getElementById('urlGameMeta').textContent = `${dateDisplay} â€¢ ${game.gender || ''} ${game.level || ''} ${game.division || ''}`.trim();
      
      document.getElementById('urlPhotos').value = game.photos_url || '';
      document.getElementById('urlRecap').value = game.recap_url || '';
      document.getElementById('urlHighlights').value = game.highlights_url || '';
      document.getElementById('urlLiveStream').value = game.live_stream_url || '';
      
      document.getElementById('urlModal').style.display = 'block';
      document.body.style.overflow = 'hidden';
    }
    
    function closeUrlModal() {
      document.getElementById('urlModal').style.display = 'none';
      document.body.style.overflow = 'auto';
    }
    
    function clearUrlField(fieldId) {
      document.getElementById(fieldId).value = '';
    }
    
    function clearAllUrls() {
      if (!confirm('Clear all URLs for this game?')) return;
      document.getElementById('urlPhotos').value = '';
      document.getElementById('urlRecap').value = '';
      document.getElementById('urlHighlights').value = '';
      document.getElementById('urlLiveStream').value = '';
    }
    
    async function saveUrls() {
      const gameId = document.getElementById('urlGameId').value;
      if (!gameId) return;
      
      const urlData = {
        photos_url: document.getElementById('urlPhotos').value.trim() || null,
        recap_url: document.getElementById('urlRecap').value.trim() || null,
        highlights_url: document.getElementById('urlHighlights').value.trim() || null,
        live_stream_url: document.getElementById('urlLiveStream').value.trim() || null
      };
      
      try {
        const response = await fetch(`/.netlify/functions/games?id=${gameId}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(urlData)
        });
        
        if (response.ok) {
          // Update local data
          const game = allGames.find(g => g.id === parseInt(gameId));
          if (game) {
            game.photos_url = urlData.photos_url;
            game.recap_url = urlData.recap_url;
            game.highlights_url = urlData.highlights_url;
            game.live_stream_url = urlData.live_stream_url;
          }
          
          closeUrlModal();
          renderGameList();
          showToast('URLs saved!', 'success');
        } else {
          throw new Error('Failed to save');
        }
      } catch (err) {
        console.error('Error saving URLs:', err);
        showToast('Error saving URLs', 'error');
      }
    }
    
    async function saveGame() {
      const gameId = document.getElementById('gameId').value;
      
      const gameData = {
        date: document.getElementById('gameDate').value,
        time: document.getElementById('gameTime').value || null,
        status: document.getElementById('gameStatus').value,
        away_team: document.getElementById('gameAwayTeam').value.trim(),
        home_team: document.getElementById('gameHomeTeam').value.trim(),
        away_score: document.getElementById('gameAwayScore').value ? parseInt(document.getElementById('gameAwayScore').value) : null,
        home_score: document.getElementById('gameHomeScore').value ? parseInt(document.getElementById('gameHomeScore').value) : null,
        level: document.getElementById('gameLevel').value,
        division: document.getElementById('gameDivision').value || null,
        gender: document.getElementById('gameGender').value,
        photog1: document.getElementById('gamePhotog1').value.trim() || null,
        photog2: document.getElementById('gamePhotog2').value.trim() || null,
        videog: document.getElementById('gameVideog').value.trim() || null,
        writer: document.getElementById('gameWriter').value.trim() || null,
        photos_url: document.getElementById('gamePhotosUrl').value.trim() || null,
        recap_url: document.getElementById('gameRecapUrl').value.trim() || null,
        highlights_url: document.getElementById('gameHighlightsUrl').value.trim() || null,
        live_stream_url: document.getElementById('gameLiveStreamUrl').value.trim() || null,
        special_event: document.getElementById('gameSpecialEvent').value.trim() || null,
        location: document.getElementById('gameLocation').value.trim() || null,
        notes: document.getElementById('gameNotes').value.trim() || null
      };
      
      // Validation
      if (!gameData.date || !gameData.away_team || !gameData.home_team || !gameData.level) {
        showToast('Please fill in required fields', 'error');
        return;
      }
      
      // Generate game_id for new games
      if (!gameId) {
        const homeSlug = gameData.home_team.toLowerCase().replace(/[^a-z0-9]/g, '');
        const awaySlug = gameData.away_team.toLowerCase().replace(/[^a-z0-9]/g, '');
        const genderCode = gameData.gender === 'Boys' ? 'b' : gameData.gender === 'Girls' ? 'g' : gameData.gender === 'Men' ? 'm' : 'w';
        const dateStr = gameData.date.replace(/-/g, '');
        const levelPrefix = gameData.level === 'NHIAA' ? 'nhiaa' : gameData.level === 'College' ? 'college' : 'prep';
        gameData.game_id = `${levelPrefix}_${homeSlug}_${genderCode}_${dateStr}_${awaySlug}`;
      }
      
      try {
        const url = gameId 
          ? `/.netlify/functions/games?id=${gameId}`
          : '/.netlify/functions/games';
        
        const response = await fetch(url, {
          method: gameId ? 'PUT' : 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(gameData)
        });
        
        if (response.ok) {
          showToast(gameId ? 'Game updated!' : 'Game created!', 'success');
          closeGameModal();
          loadGames();
        } else {
          const err = await response.json();
          showToast(err.error || 'Failed to save game', 'error');
        }
      } catch (err) {
        console.error('Save game error:', err);
        showToast('Failed to save game', 'error');
      }
    }
    
    async function deleteGame(gameId) {
      if (!confirm('Delete this game?')) return;
      
      try {
        const response = await fetch(`/.netlify/functions/games?id=${gameId}`, {
          method: 'DELETE'
        });
        
        if (response.ok) {
          showToast('Game deleted', 'success');
          loadGames();
        } else {
          showToast('Failed to delete game', 'error');
        }
      } catch (err) {
        console.error('Delete game error:', err);
        showToast('Failed to delete game', 'error');
      }
    }
    
    // Game CSV Import
    function openGameImportModal() {
      document.getElementById('gameImportModal').style.display = 'block';
      document.body.style.overflow = 'hidden';
      document.getElementById('gameImportPreview').style.display = 'none';
      document.getElementById('gameFileInput').value = '';
      importGamesData = [];
    }
    
    function closeGameImportModal() {
      document.getElementById('gameImportModal').style.display = 'none';
      document.body.style.overflow = 'auto';
    }
    
    function handleGameCsvFile(file) {
      if (!file || !file.name.endsWith('.csv')) {
        showToast('Please select a CSV file', 'error');
        return;
      }
      
      const reader = new FileReader();
      reader.onload = (e) => {
        parseGameCsv(e.target.result, file.name);
      };
      reader.readAsText(file);
    }
    
    function parseGameCsv(csv, filename) {
      const lines = csv.split('\n').filter(line => line.trim());
      if (lines.length < 2) {
        showToast('CSV file appears empty', 'error');
        return;
      }
      
      // Detect delimiter
      const firstLine = lines[0];
      const delimiter = firstLine.includes('\t') ? '\t' : ',';
      
      const headers = firstLine.split(delimiter).map(h => h.trim().toLowerCase().replace(/[^a-z0-9_]/g, ''));
      const games = [];
      
      for (let i = 1; i < lines.length; i++) {
        const values = delimiter === '\t' ? lines[i].split('\t') : parseCSVLine(lines[i]);
        if (values.length < headers.length - 1) continue;
        
        const game = {};
        headers.forEach((h, idx) => {
          let val = values[idx]?.trim() || null;
          game[h] = val;
        });
        
        // Map CSV columns to database columns
        const mappedGame = {
          game_id: game.game_id || game.gameid,
          date: game.date,
          time: game.time,
          away_team: game.away || game.away_team || game.awayteam,
          home_team: game.home || game.home_team || game.hometeam,
          away_score: game.away_score || game.awayscore,
          home_score: game.home_score || game.homescore,
          gender: game.gender,
          level: game.level,
          division: game.division,
          photog1: game.photog || game.photog1,
          photog2: game.photog2,
          videog: game.videog,
          writer: game.writer,
          photos_url: game.photos_url || game.photosurl,
          recap_url: game.recap_url || game.recapurl,
          highlights_url: game.highlights_url || game.highlightsurl,
          live_stream_url: game.live_stream_url || game.livestreamurl || game.livestream_url,
          game_description: game.gamedescription || game.game_description,
          special_event: game.specialevent || game.special_event,
          notes: game.notes,
          original_date: game.original_date || game.originaldate,
          schedule_changed: game.schedule_changed || game.schedulechanged
        };
        
        // Only add if has required fields
        if (mappedGame.game_id && mappedGame.date && mappedGame.away_team && mappedGame.home_team) {
          games.push(mappedGame);
        }
      }
      
      if (games.length === 0) {
        showToast('No valid games found in CSV', 'error');
        return;
      }
      
      importGamesData = games;
      showGameImportPreview(games, filename);
    }
    
    function showGameImportPreview(games, filename) {
      document.getElementById('gameImportPreview').style.display = 'block';
      document.getElementById('gameImportPreviewCount').textContent = `${games.length} games`;
      document.getElementById('gameImportPreviewFile').textContent = filename;
      
      const tbody = document.getElementById('gameImportPreviewBody');
      tbody.innerHTML = games.slice(0, 50).map(g => `
        <tr>
          <td style="padding: 6px 8px;">${g.date}</td>
          <td style="padding: 6px 8px;">${g.away_team}</td>
          <td style="padding: 6px 8px;">${g.home_team}</td>
          <td style="padding: 6px 8px;">${g.level}</td>
        </tr>
      `).join('');
      
      if (games.length > 50) {
        tbody.innerHTML += `<tr><td colspan="4" style="padding: 8px; color: #888; text-align: center;">...and ${games.length - 50} more</td></tr>`;
      }
    }
    
    async function executeGameImport() {
      if (importGamesData.length === 0) return;
      
      document.getElementById('btnExecuteGameImport').disabled = true;
      document.getElementById('btnExecuteGameImport').textContent = 'Importing...';
      
      try {
        const response = await fetch('/.netlify/functions/games', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ games: importGamesData })
        });
        
        const result = await response.json();
        
        showToast(`Import complete: ${result.inserted} inserted, ${result.updated} updated, ${result.errors?.length || 0} errors`, 'success');
        closeGameImportModal();
        loadGames();
        
        if (result.errors && result.errors.length > 0) {
          console.log('Import errors:', result.errors);
        }
      } catch (err) {
        console.error('Import error:', err);
        showToast('Import failed', 'error');
      }
      
      document.getElementById('btnExecuteGameImport').disabled = false;
      document.getElementById('btnExecuteGameImport').textContent = 'Import Games';
    }
    
    function exportGames() {
      if (allGames.length === 0) {
        showToast('No games to export', 'error');
        return;
      }
      
      const headers = ['game_id', 'date', 'time', 'away', 'away_score', 'home', 'home_score', 'gender', 'level', 'division', 'photog1', 'photog2', 'videog', 'writer', 'notes', 'original_date', 'schedule_changed', 'photos_url', 'recap_url', 'highlights_url', 'live_stream_url', 'gamedescription', 'specialevent'];
      
      let csv = headers.join(',') + '\n';
      
      filteredGames.forEach(game => {
        const row = [
          game.game_id,
          game.date,
          game.time,
          game.away_team,
          game.away_score ?? '',
          game.home_team,
          game.home_score ?? '',
          game.gender,
          game.level,
          game.division,
          game.photog1 || '',
          game.photog2 || '',
          game.videog || '',
          game.writer || '',
          game.notes || '',
          game.original_date || '',
          game.schedule_changed ? 'YES' : '',
          game.photos_url || '',
          game.recap_url || '',
          game.highlights_url || '',
          game.live_stream_url || '',
          game.game_description || '',
          game.special_event || ''
        ].map(val => {
          if (val === null || val === undefined) return '';
          val = String(val);
          if (val.includes(',') || val.includes('"') || val.includes('\n')) {
            return '"' + val.replace(/"/g, '""') + '"';
          }
          return val;
        });
        csv += row.join(',') + '\n';
      });
      
      const blob = new Blob([csv], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `ball603-schedule-${new Date().toISOString().split('T')[0]}.csv`;
      a.click();
      URL.revokeObjectURL(url);
      
      showToast('Schedule exported!', 'success');
    }
    
    // Restore coverage data from CSV (updates ONLY coverage fields, not game data)
    async function restoreCoverageFromCSV(file) {
      if (!file || !file.name.endsWith('.csv')) {
        showToast('Please select a CSV file', 'error');
        return;
      }
      
      showToast('Reading CSV...', 'success');
      
      const reader = new FileReader();
      reader.onload = async (e) => {
        try {
          const csv = e.target.result;
          const lines = csv.split('\n').filter(line => line.trim());
          
          if (lines.length < 2) {
            showToast('CSV file appears empty', 'error');
            return;
          }
          
          const delimiter = lines[0].includes('\t') ? '\t' : ',';
          const headers = lines[0].split(delimiter).map(h => h.trim().toLowerCase().replace(/[^a-z0-9_]/g, ''));
          
          const games = [];
          for (let i = 1; i < lines.length; i++) {
            const values = delimiter === '\t' ? lines[i].split('\t') : parseCSVLine(lines[i]);
            if (values.length < headers.length - 1) continue;
            
            const game = {};
            headers.forEach((h, idx) => {
              game[h] = values[idx]?.trim() || null;
            });
            
            // Only include if has game_id and any coverage data
            if (game.game_id && (game.photog1 || game.photog2 || game.videog || game.writer || 
                game.photos_url || game.recap_url || game.highlights_url || game.live_stream_url)) {
              games.push(game);
            }
          }
          
          if (games.length === 0) {
            showToast('No games with coverage data found in CSV', 'error');
            return;
          }
          
          showToast(`Restoring coverage for ${games.length} games...`, 'success');
          
          // Send to restore endpoint
          const response = await fetch('/.netlify/functions/import-coverage-restore', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ games })
          });
          
          const result = await response.json();
          
          if (result.success) {
            showToast(`Coverage restored for ${result.updated} games!`, 'success');
            loadGames();
          } else {
            showToast(result.error || 'Restore failed', 'error');
          }
        } catch (err) {
          console.error('Restore error:', err);
          showToast('Failed to restore coverage', 'error');
        }
      };
      reader.readAsText(file);
    }
    
    // ==================== END SCHEDULE MANAGER ====================
    
    // Drag and drop for CSV
    document.addEventListener('DOMContentLoaded', function() {
      const dropZone = document.getElementById('dropZone');
      if (dropZone) {
        dropZone.addEventListener('dragover', (e) => {
          e.preventDefault();
          dropZone.style.borderColor = '#1565c0';
          dropZone.style.background = '#e3f2fd';
        });
        dropZone.addEventListener('dragleave', () => {
          dropZone.style.borderColor = '#ddd';
          dropZone.style.background = 'transparent';
        });
        dropZone.addEventListener('drop', (e) => {
          e.preventDefault();
          dropZone.style.borderColor = '#ddd';
          dropZone.style.background = 'transparent';
          const file = e.dataTransfer.files[0];
          if (file && file.name.endsWith('.csv')) {
            handleCsvFile(file);
          } else {
            showToast('Please drop a CSV file', 'error');
          }
        });
      }
    });
    
    // Preview Modal
    function openPreview() {
      const headline = document.getElementById('articleTitle').value || 'Untitled';
      const content = getEditorContent() || '<p>No content yet.</p>';
      const plainText = getEditorPlainText() || 'No content yet.';
      const excerpt = document.getElementById('articleExcerpt').value || '';
      const featuredImageUrl = document.getElementById('featuredImageUrl').value;
      const featuredImageCaption = document.getElementById('featuredImageCaption').value;
      
      // Featured image
      if (featuredImageUrl) {
        document.getElementById('previewFeaturedImg').src = featuredImageUrl;
        document.getElementById('previewFeaturedCaption').textContent = featuredImageCaption || '';
        document.getElementById('previewFeaturedImage').style.display = 'block';
      } else {
        document.getElementById('previewFeaturedImage').style.display = 'none';
      }
      
      document.getElementById('previewHeadline').textContent = headline;
      document.getElementById('previewExcerpt').textContent = excerpt;
      document.getElementById('previewContent').innerHTML = content; // Use innerHTML for rich content
      
      // Social posts - use generated ones if available, otherwise create basic versions
      if (generatedSocialPosts.facebookPost) {
        document.getElementById('previewFacebook').textContent = generatedSocialPosts.facebookPost;
      } else {
        document.getElementById('previewFacebook').textContent = plainText.substring(0, 500) + (plainText.length > 500 ? '...' : '');
      }
      
      if (generatedSocialPosts.instagramPost) {
        document.getElementById('previewInstagram').textContent = generatedSocialPosts.instagramPost;
      } else {
        document.getElementById('previewInstagram').textContent = 'No Instagram post generated. Use Scorebook Story or Boxscore Story to auto-generate social posts.';
      }
      
      if (generatedSocialPosts.twitterPost) {
        document.getElementById('previewTwitter').textContent = generatedSocialPosts.twitterPost;
      } else {
        document.getElementById('previewTwitter').textContent = 'No Twitter post generated. Use Scorebook Story or Boxscore Story to auto-generate social posts.';
      }
      
      document.getElementById('previewModal').classList.add('open');
      document.body.style.overflow = 'hidden';
    }
    
    function closePreview() {
      document.getElementById('previewModal').classList.remove('open');
      document.body.style.overflow = 'auto';
    }
    
    // SmugMug Browser
    let smugmugAlbums = [];
    let selectedAlbum = null;
    
    async function openSmugMugBrowser() {
      document.getElementById('smugmugModal').classList.add('open');
      document.getElementById('albumGrid').innerHTML = '<div class="loading">Loading albums...</div>';
      selectedAlbum = null;
      document.getElementById('btnSelectAlbum').disabled = true;
      
      try {
        const response = await fetch('/.netlify/functions/smugmug?action=albums');
        const data = await response.json();
        
        if (data.success) {
          smugmugAlbums = data.albums || [];
          renderAlbumGrid();
        } else {
          document.getElementById('albumGrid').innerHTML = '<div class="loading">Error loading albums</div>';
        }
      } catch (err) {
        console.error('SmugMug error:', err);
        document.getElementById('albumGrid').innerHTML = '<div class="loading">Could not connect to SmugMug</div>';
      }
    }
    
    function closeSmugMugBrowser() {
      document.getElementById('smugmugModal').classList.remove('open');
      selectedAlbum = null;
    }
    
    function renderAlbumGrid(filter = '') {
      const grid = document.getElementById('albumGrid');
      
      let filtered = smugmugAlbums;
      if (filter) {
        filtered = smugmugAlbums.filter(a => 
          a.name.toLowerCase().includes(filter.toLowerCase())
        );
      }
      
      if (filtered.length === 0) {
        grid.innerHTML = '<div class="loading">No albums found</div>';
        return;
      }
      
      grid.innerHTML = filtered.map(album => `
        <div class="album-card ${selectedAlbum?.key === album.key ? 'selected' : ''}" 
             onclick="selectAlbumCard('${album.key}')">
          <img class="album-thumb" 
               src="${album.highlightImage || 'data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><rect fill=%22%23f5f5f5%22 width=%22100%22 height=%22100%22/><text x=%2250%22 y=%2255%22 text-anchor=%22middle%22 fill=%22%23ccc%22 font-size=%2230%22>ðŸ“·</text></svg>'}" 
               alt="${album.name}"
               onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><rect fill=%22%23f5f5f5%22 width=%22100%22 height=%22100%22/><text x=%2250%22 y=%2255%22 text-anchor=%22middle%22 fill=%22%23ccc%22 font-size=%2230%22>ðŸ“·</text></svg>'">
          <div class="album-info">
            <div class="album-name" title="${album.name}">${album.name}</div>
            <div class="album-meta">${album.imageCount || 0} photos${album.date ? ' â€¢ ' + album.date : ''}</div>
          </div>
        </div>
      `).join('');
    }
    
    function searchAlbums(value) {
      renderAlbumGrid(value);
    }
    
    function selectAlbumCard(key) {
      selectedAlbum = smugmugAlbums.find(a => a.key === key);
      document.getElementById('btnSelectAlbum').disabled = !selectedAlbum;
      renderAlbumGrid(document.getElementById('albumSearch').value);
    }
    
    function selectSmugMugAlbum() {
      if (!selectedAlbum) return;
      
      document.getElementById('smugmugUrl').value = selectedAlbum.url;
      
      // Show preview
      const preview = document.getElementById('selectedAlbumPreview');
      if (selectedAlbum.highlightImage) {
        document.getElementById('albumThumbnail').src = selectedAlbum.highlightImage;
        preview.style.display = 'block';
      } else {
        preview.style.display = 'none';
      }
      document.getElementById('albumInfo').textContent = `${selectedAlbum.name} â€¢ ${selectedAlbum.imageCount} photos`;
      preview.style.display = 'block';
      
      closeSmugMugBrowser();
      showToast('Album selected!', 'success');
    }
  </script>
</body>
</html>
