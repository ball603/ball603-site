<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" id="metaDescription" content="New Hampshire High School Basketball - Schedule, Roster, News, and History on Ball603">
  <meta name="theme-color" id="metaThemeColor" content="#f57c00">
  <title id="pageTitle">Loading... | Ball603</title>
  
  <!-- Favicon (updated dynamically) -->
  <link rel="icon" type="image/png" id="favicon" href="/logo.png">
  <link rel="apple-touch-icon" id="appleTouchIcon" href="/logo.png">
  
  <!-- Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-S4BN80729K"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-S4BN80729K');
  </script>
  
  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.0"></script>
  
  <!-- Shared Styles -->
  <link rel="stylesheet" href="/styles.css">
  <link rel="stylesheet" href="/team.css">
  
  <!-- Navigation Loader -->
  <script src="/includes/nav-loader.js" defer></script>
  
  <!-- Open Graph (updated dynamically) -->
  <meta property="og:title" id="ogTitle" content="Team Page | Ball603">
  <meta property="og:description" id="ogDescription" content="New Hampshire High School Basketball Coverage">
  <meta property="og:image" id="ogImage" content="https://ball603.com/logo.png">
  <meta property="og:url" id="ogUrl" content="https://ball603.com">
  
  <!-- Team-specific CSS Variables (injected dynamically) -->
  <style id="teamStyles">
    :root {
      --team-primary: #f57c00;
      --team-secondary: #333333;
      --team-accent: #ffb74d;
    }
  </style>
</head>
<body class="team-page">
  
  <!-- Header loaded from includes -->
  <div id="site-header"></div>
  
  <!-- Mobile menu loaded from includes -->
  <div id="mobile-menu"></div>

  <!-- Hero Section -->
  <section class="team-hero" id="teamHero">
    <div class="team-hero-bg"></div>
    <div class="particles-container" id="particlesContainer"></div>
    <div class="team-hero-content">
      <div class="team-hero-tagline" id="teamTagline">LOADING...</div>
      <div class="team-hero-logo-wrap">
        <img src="/logo.png" alt="Team Logo" class="team-hero-logo" id="teamLogo">
      </div>
      <div class="team-hero-meta" id="teamMeta"></div>
      <div class="team-hero-stats" id="heroStats"></div>
    </div>
  </section>

  <!-- Menu Bar -->
  <nav class="team-menu-bar">
    <div class="team-menu-inner">
      <a href="#news" class="team-menu-item" data-section="news">
        <span class="menu-icon">&#128240;</span>
        <span class="menu-text">News</span>
      </a>
      <a href="#galleries" class="team-menu-item" data-section="galleries">
        <span class="menu-icon">&#128247;</span>
        <span class="menu-text">Galleries</span>
      </a>
      <a href="#schedules" class="team-menu-item" data-section="schedules">
        <span class="menu-icon">&#128197;</span>
        <span class="menu-text">Schedules</span>
      </a>
      <a href="#rosters" class="team-menu-item" data-section="rosters">
        <span class="menu-icon">&#128101;</span>
        <span class="menu-text">Rosters</span>
      </a>
      <a href="#history" class="team-menu-item" data-section="history">
        <span class="menu-icon">&#127942;</span>
        <span class="menu-text">History</span>
      </a>
      <a href="#1k-club" class="team-menu-item" data-section="1k-club">
        <span class="menu-icon">&#127919;</span>
        <span class="menu-text">1K in the 603</span>
      </a>
      <a href="#college" class="team-menu-item" data-section="college">
        <span class="menu-icon">&#127891;</span>
        <span class="menu-text">603 in the NCAA</span>
      </a>
    </div>
  </nav>

  <!-- Quick Stats Bar -->
  <section class="team-quick-stats" id="quickStats">
    <div class="quick-stats-group boys-stats">
      <div class="quick-stats-label">BOYS</div>
      <div class="quick-stats-data">
        <div class="quick-stat">
          <span class="quick-stat-label">Record</span>
          <span class="quick-stat-value" id="boysRecord">--</span>
        </div>
        <div class="quick-stat">
          <span class="quick-stat-label">Last Result</span>
          <span class="quick-stat-value" id="boysLastResult">--</span>
        </div>
        <div class="quick-stat">
          <span class="quick-stat-label">Next Game</span>
          <span class="quick-stat-value" id="boysNextGame">--</span>
        </div>
      </div>
    </div>
    <div class="quick-stats-group girls-stats">
      <div class="quick-stats-label">GIRLS</div>
      <div class="quick-stats-data">
        <div class="quick-stat">
          <span class="quick-stat-label">Record</span>
          <span class="quick-stat-value" id="girlsRecord">--</span>
        </div>
        <div class="quick-stat">
          <span class="quick-stat-label">Last Result</span>
          <span class="quick-stat-value" id="girlsLastResult">--</span>
        </div>
        <div class="quick-stat">
          <span class="quick-stat-label">Next Game</span>
          <span class="quick-stat-value" id="girlsNextGame">--</span>
        </div>
      </div>
    </div>
  </section>

  <!-- Main Content -->
  <main class="team-main">
    
    <!-- NEWS SECTION -->
    <section class="team-section" id="news">
      <div class="section-header">
        <h2 class="section-title">&#128240; Latest News</h2>
        <a href="#" class="section-link" id="newsViewAllLink">View All →</a>
      </div>
      <div class="stories-featured" id="storiesFeatured">
        <div class="empty-state"><p>No stories yet. Check back soon!</p></div>
      </div>
    </section>

    <!-- GALLERIES SECTION -->
    <section class="team-section" id="galleries">
      <div class="section-header">
        <h2 class="section-title">&#128247; Photo Galleries</h2>
      </div>
      <div class="galleries-container">
        <button class="gallery-arrow gallery-arrow-left" id="galleryArrowLeft" aria-label="Scroll left">‹</button>
        <div class="galleries-scroll" id="galleriesGrid">
          <div class="empty-state"><p>Loading galleries...</p></div>
        </div>
        <button class="gallery-arrow gallery-arrow-right" id="galleryArrowRight" aria-label="Scroll right">›</button>
      </div>
    </section>

    <!-- SPONSOR SECTION -->
    <section class="team-section team-sponsor-section" id="sponsor">
      <div class="team-sponsor" id="sponsorBox">
        <a href="#" class="sponsor-link sponsor-fallback" id="sponsorFallbackLink">
          <img src="/logo.png" alt="Ball603" class="sponsor-logo-img">
          <div class="sponsor-fallback-text">
            <div class="sponsor-fallback-line1" id="sponsorFallbackLine1">Enjoying our coverage?</div>
            <div class="sponsor-fallback-line2">Click to inquire about becoming the official team sponsor</div>
          </div>
        </a>
      </div>
    </section>

    <!-- SCHEDULES SECTION -->
    <section class="team-section" id="schedules">
      <div class="section-header">
        <h2 class="section-title">&#128197; Schedules</h2>
      </div>
      <div class="schedules-grid">
        <div class="schedule-card">
          <div class="schedule-card-header boys">
            <span class="schedule-card-label">Boys Varsity</span>
            <span class="schedule-card-record" id="boysRecordCard">--</span>
          </div>
          <div class="schedule-card-games" id="boysScheduleGames">
            <div class="empty-state"><p>Loading schedule...</p></div>
          </div>
        </div>
        <div class="schedule-card">
          <div class="schedule-card-header girls">
            <span class="schedule-card-label">Girls Varsity</span>
            <span class="schedule-card-record" id="girlsRecordCard">--</span>
          </div>
          <div class="schedule-card-games" id="girlsScheduleGames">
            <div class="empty-state"><p>Loading schedule...</p></div>
          </div>
        </div>
      </div>
    </section>

    <!-- ROSTERS SECTION -->
    <section class="team-section" id="rosters">
      <div class="section-header">
        <h2 class="section-title">&#128101; Rosters</h2>
      </div>
      <div class="rosters-grid">
        <div class="roster-card" id="boysRosterCard">
          <div class="roster-card-header boys">
            <span class="roster-card-label">Boys Varsity</span>
            <span class="roster-card-count" id="boysRosterCount">--</span>
          </div>
          <div class="roster-card-body" id="boysRosterBody">
            <div class="roster-empty"><p>Loading roster...</p></div>
          </div>
          <div class="roster-card-coach" id="boysCoachInfo"></div>
        </div>
        <div class="roster-card" id="girlsRosterCard">
          <div class="roster-card-header girls">
            <span class="roster-card-label">Girls Varsity</span>
            <span class="roster-card-count" id="girlsRosterCount">--</span>
          </div>
          <div class="roster-card-body" id="girlsRosterBody">
            <div class="roster-empty"><p>Loading roster...</p></div>
          </div>
          <div class="roster-card-coach" id="girlsCoachInfo"></div>
        </div>
      </div>
    </section>

    <!-- HISTORY SECTION -->
    <section class="team-section" id="history">
      <div class="section-header">
        <h2 class="section-title">&#127942; Championship History</h2>
      </div>
      <div class="history-content" id="historyContent">
        <div class="empty-state"><p>Loading championship history...</p></div>
      </div>
    </section>

    <!-- 1K IN THE 603 & 603 IN NCAA -->
    <section class="team-section" id="features-row">
      <div class="features-grid">
        <div class="feature-box" id="1k-club">
          <div class="feature-box-header">
            <h2 class="feature-box-title">&#127919; 1K in the 603</h2>
            <span class="feature-box-subtitle" id="scorersSubtitle">1000-Point Scorers</span>
          </div>
          <div class="feature-box-content" id="scorersList">
            <div class="empty-state"><p>Loading...</p></div>
          </div>
          <div class="feature-box-footer">
            <a href="/1kinthe603" class="feature-footer-link">See full NHIAA list →</a>
            <a href="#" class="feature-footer-link secondary" id="scorersMailtoLink">Know someone? Let us know</a>
          </div>
        </div>
        <div class="feature-box" id="college">
          <div class="feature-box-header">
            <h2 class="feature-box-title">&#127891; 603 in the NCAA</h2>
            <span class="feature-box-subtitle" id="collegeSubtitle">Currently Playing in College</span>
          </div>
          <div class="feature-box-content" id="collegePlayersList">
            <div class="empty-state"><p>Loading...</p></div>
          </div>
          <div class="feature-box-footer">
            <a href="/603intheNCAA" class="feature-footer-link">See full NCAA list →</a>
            <a href="#" class="feature-footer-link secondary" id="collegeMailtoLink">Know someone? Let us know</a>
          </div>
        </div>
      </div>
    </section>

  </main>

  <!-- Site Footer -->
  <footer class="site-footer">
    <div class="footer-logo"><img src="/logo.png" alt="Ball603"></div>
    <div class="footer-links">
      <a href="/about">About Us</a>
      <a href="/contact">Contact</a>
    </div>
    <div class="footer-social">
      <a href="https://facebook.com/ball603" target="_blank" title="Facebook">
        <svg viewBox="0 0 24 24"><path d="M18 2h-3a5 5 0 0 0-5 5v3H7v4h3v8h4v-8h3l1-4h-4V7a1 1 0 0 1 1-1h3z"/></svg>
      </a>
      <a href="https://www.instagram.com/ball603nh/" target="_blank" title="Instagram">
        <svg viewBox="0 0 24 24"><path d="M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.849 0 3.205-.012 3.584-.069 4.849-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.07-4.85.07-3.204 0-3.584-.012-4.849-.07-3.26-.149-4.771-1.699-4.919-4.92-.058-1.265-.07-1.644-.07-4.849 0-3.204.013-3.583.07-4.849.149-3.227 1.664-4.771 4.919-4.919 1.266-.057 1.645-.069 4.849-.069zm0-2.163c-3.259 0-3.667.014-4.947.072-4.358.2-6.78 2.618-6.98 6.98-.059 1.281-.073 1.689-.073 4.948 0 3.259.014 3.668.072 4.948.2 4.358 2.618 6.78 6.98 6.98 1.281.058 1.689.072 4.948.072 3.259 0 3.668-.014 4.948-.072 4.354-.2 6.782-2.618 6.979-6.98.059-1.28.073-1.689.073-4.948 0-3.259-.014-3.667-.072-4.947-.196-4.354-2.617-6.78-6.979-6.98-1.281-.059-1.69-.073-4.949-.073zm0 5.838c-3.403 0-6.162 2.759-6.162 6.162s2.759 6.163 6.162 6.163 6.162-2.759 6.162-6.163c0-3.403-2.759-6.162-6.162-6.162zm0 10.162c-2.209 0-4-1.79-4-4 0-2.209 1.791-4 4-4s4 1.791 4 4c0 2.21-1.791 4-4 4zm6.406-11.845c-.796 0-1.441.645-1.441 1.44s.645 1.44 1.441 1.44c.795 0 1.439-.645 1.439-1.44s-.644-1.44-1.439-1.44z"/></svg>
      </a>
      <a href="https://x.com/Ball603NH" target="_blank" title="X (Twitter)">
        <svg viewBox="0 0 24 24"><path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/></svg>
      </a>
    </div>
    <p class="footer-copyright">© 2025 Ball603. All rights reserved.</p>
  </footer>

  <!-- Features Data -->
  <script src="/features-data.js"></script>
  
  <script>
    // ===== SUPABASE CLIENT =====
    const SUPABASE_URL = 'https://suncdkxfqkwwnmhosxcf.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InN1bmNka3hmcWt3d25taG9zeGNmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUwNTk4MzIsImV4cCI6MjA4MDYzNTgzMn0.aT6V8Zx_YozqOh1ZnC6x-czI9vo-QhHKmP69PgY-8xw';
    const db = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // ===== TEAM CONFIGURATION (built dynamically) =====
    let TEAM_CONFIG = null;

    // ===== STATE =====
    let teamData = {
      rosters: { boys: null, girls: null },
      schedules: { boys: [], girls: [] },
      championships: { boys: [], girls: [], totalTitles: 0, totalRunnerUp: 0 },
      scorers1K: [],
      ncaaPlayers: [],
      galleries: [],
      sponsor: null
    };

    // ===== SLUG & FILENAME UTILITIES =====
    function toSlug(name) {
      return name.toLowerCase().replace(/[^a-z0-9]/g, '');
    }

    function toLogoFilename(shortname) {
      const specialCases = {
        'coe-brown': 'CoeBrown',
        'st. thomas aquinas': 'StThomasAquinas',
        'lin-wood': 'LinWood'
      };
      const lower = shortname.toLowerCase();
      if (specialCases[lower]) return specialCases[lower];
      return shortname.split(/[\s-]+/).map(word => 
        word.charAt(0).toUpperCase() + word.slice(1).toLowerCase()
      ).join('');
    }

    function lightenColor(hex, percent = 30) {
      if (!hex || hex === 'TBD') return '#ffb74d';
      hex = hex.replace('#', '');
      const num = parseInt(hex, 16);
      const r = Math.min(255, (num >> 16) + Math.round(255 * percent / 100));
      const g = Math.min(255, ((num >> 8) & 0x00FF) + Math.round(255 * percent / 100));
      const b = Math.min(255, (num & 0x0000FF) + Math.round(255 * percent / 100));
      return `#${((r << 16) | (g << 8) | b).toString(16).padStart(6, '0')}`;
    }

    function getContrastTextColor(hex) {
      if (!hex || hex === 'TBD') return '#333';
      hex = hex.replace('#', '');
      const r = parseInt(hex.substr(0, 2), 16);
      const g = parseInt(hex.substr(2, 2), 16);
      const b = parseInt(hex.substr(4, 2), 16);
      // Calculate relative luminance (WCAG formula)
      const luminance = (0.299 * r + 0.587 * g + 0.114 * b) / 255;
      return luminance > 0.5 ? '#333' : '#fff';
    }

    // ===== INITIALIZATION =====
    document.addEventListener('DOMContentLoaded', async () => {
      const path = window.location.pathname;
      const slug = path.replace(/^\//, '').replace(/\/$/, '').split('/')[0].toLowerCase();
      
      if (!slug) { showTeamNotFound('No team specified'); return; }

      const teamLoaded = await loadTeamConfig(slug);
      if (!teamLoaded) { showTeamNotFound(slug); return; }

      updatePageWithTeamInfo();
      applyGenderVisibility();
      initMenuNavigation();
      createParticles();
      
      await Promise.all([
        loadRosters(),
        loadSchedules(),
        loadGalleries(),
        loadFeaturesData(),
        loadArticles(),
        loadSponsor()
      ]);
      
      renderAll();
    });

    // ===== LOAD TEAM CONFIG FROM DATABASE =====
    async function loadTeamConfig(slug) {
      try {
        const { data: teams, error } = await db
          .from('teams')
          .select('*')
          .eq('level', 'High School')
          .eq('active', true);

        if (error) throw error;

        // Find all team entries matching this slug (could be Boys, Girls, or both)
        const matchingTeams = teams.filter(t => toSlug(t.shortname) === slug);
        if (matchingTeams.length === 0) { console.error('Team not found for slug:', slug); return false; }

        // Use the first match for team info (they share same school info)
        const team = matchingTeams[0];
        
        // Determine which genders are available
        const hasBoys = matchingTeams.some(t => t.gender === 'Boys');
        const hasGirls = matchingTeams.some(t => t.gender === 'Girls');
        const isCombinedTeam = team.combined_team === true;

        // Use logo_filename from database if set, otherwise fall back to generated filename
        const logoFilename = team.logo_filename 
          ? team.logo_filename.replace('.png', '') 
          : toLogoFilename(team.shortname);
        const primaryColor = team.primary_hex && team.primary_hex !== 'TBD' ? team.primary_hex : '#f57c00';
        const secondaryColor = team.secondary_hex && team.secondary_hex !== 'TBD' ? team.secondary_hex : '#333333';

        // Build name variations
        let nameVariations = [
          team.shortname,
          team.full_name,
          team.abbrev,
          team.mascot ? `${team.shortname} ${team.mascot}` : null,
          team.mascot ? `${team.abbrev} ${team.mascot}` : null
        ].filter(Boolean);
        
        // Add special variations for combined teams
        if (isCombinedTeam && team.shortname === 'Central-West') {
          nameVariations.push('Manchester Central-West', 'Central West', 'CentralWest', 'Man. Central-Man. West');
        }

        TEAM_CONFIG = {
          slug: slug,
          name: team.shortname,
          shortname: team.shortname,
          mascot: team.mascot || '',
          fullName: team.mascot ? `${team.shortname} ${team.mascot}` : team.shortname,
          town: team.location || '',
          state: 'NH',
          colors: {
            primary: primaryColor,
            secondary: secondaryColor,
            accent: lightenColor(primaryColor, 25)
          },
          logo: `/logos/200px/${logoFilename}.png`,
          logoFilename: logoFilename,
          nameVariations: nameVariations,
          hasBoys: hasBoys,
          hasGirls: hasGirls,
          isCombinedTeam: isCombinedTeam
        };

        console.log('Loaded TEAM_CONFIG:', TEAM_CONFIG);
        return true;
      } catch (err) {
        console.error('Error loading team config:', err);
        return false;
      }
    }
    
    // ===== APPLY GENDER VISIBILITY =====
    function applyGenderVisibility() {
      if (!TEAM_CONFIG) return;
      
      const { hasBoys, hasGirls } = TEAM_CONFIG;
      
      // If team has both genders, nothing to hide
      if (hasBoys && hasGirls) return;
      
      // Single-gender team - hide the missing gender's elements
      if (!hasBoys) {
        // Hide boys elements
        document.querySelector('.boys-stats')?.classList.add('hidden');
        document.querySelector('.schedules-grid .schedule-card:first-child')?.classList.add('hidden');
        document.getElementById('boysRosterCard')?.classList.add('hidden');
      }
      
      if (!hasGirls) {
        // Hide girls elements
        document.querySelector('.girls-stats')?.classList.add('hidden');
        document.querySelector('.schedules-grid .schedule-card:last-child')?.classList.add('hidden');
        document.getElementById('girlsRosterCard')?.classList.add('hidden');
      }
      
      // Adjust grids for single-gender display
      if (!hasBoys || !hasGirls) {
        // Center the quick stats
        const quickStats = document.getElementById('quickStats');
        if (quickStats) quickStats.classList.add('single-gender');
        
        // Make schedule and roster grids single column
        document.querySelector('.schedules-grid')?.classList.add('single-gender');
        document.querySelector('.rosters-grid')?.classList.add('single-gender');
      }
    }

    // ===== UPDATE PAGE WITH TEAM INFO =====
    function updatePageWithTeamInfo() {
      if (!TEAM_CONFIG) return;
      const { name, mascot, fullName, town, colors, logo, slug, logoFilename } = TEAM_CONFIG;

      document.title = `${fullName} | Ball603`;
      const description = `${fullName} Basketball - Schedule, Roster, News, and History on Ball603`;
      document.getElementById('metaDescription')?.setAttribute('content', description);
      document.getElementById('metaThemeColor')?.setAttribute('content', colors.primary);
      document.getElementById('favicon')?.setAttribute('href', `/logos/100px/${logoFilename}.png`);
      document.getElementById('appleTouchIcon')?.setAttribute('href', `/logos/100px/${logoFilename}.png`);
      document.getElementById('ogTitle')?.setAttribute('content', `${fullName} | Ball603`);
      document.getElementById('ogDescription')?.setAttribute('content', description);
      document.getElementById('ogImage')?.setAttribute('content', `https://ball603.com/logos/200px/${logoFilename}.png`);
      document.getElementById('ogUrl')?.setAttribute('content', `https://ball603.com/${slug}`);

      document.getElementById('teamStyles').textContent = `
        :root {
          --team-primary: ${colors.primary};
          --team-secondary: ${colors.secondary};
          --team-accent: ${colors.accent};
          --team-accent-text: ${getContrastTextColor(colors.accent)};
        }
      `;

      document.getElementById('teamTagline').textContent = `${name.toUpperCase()} ${mascot.toUpperCase()} BASKETBALL`;
      document.getElementById('teamLogo').src = logo;
      document.getElementById('teamLogo').alt = fullName;
      document.getElementById('teamMeta').textContent = town ? `${town}, NH` : 'New Hampshire';

      document.getElementById('newsViewAllLink').href = `/news?team=${encodeURIComponent(name.toLowerCase())}`;
      document.getElementById('sponsorFallbackLink').href = `mailto:kj@ball603.com?subject=Team Sponsorship Inquiry - ${encodeURIComponent(name)}`;
      document.getElementById('sponsorFallbackLine1').textContent = `Enjoying our coverage of the ${fullName}?`;
      document.getElementById('scorersSubtitle').textContent = `${fullName} 1000-Point Scorers`;
      document.getElementById('collegeSubtitle').textContent = `Former ${mascot || name} Currently Playing in College`;
      document.getElementById('scorersMailtoLink').href = `mailto:kj@ball603.com?subject=1K Scorer - ${encodeURIComponent(name)}`;
      document.getElementById('collegeMailtoLink').href = `mailto:kj@ball603.com?subject=College Player - ${encodeURIComponent(name)}`;
    }

    // ===== TEAM NOT FOUND =====
    function showTeamNotFound(slug) {
      document.title = 'Team Not Found | Ball603';
      document.getElementById('teamTagline').textContent = 'TEAM NOT FOUND';
      document.getElementById('teamMeta').textContent = `No team found for "${slug}"`;
      document.getElementById('teamLogo').style.display = 'none';
      document.getElementById('heroStats').innerHTML = `
        <div style="text-align: center; margin-top: 20px;">
          <a href="/teams" style="color: white; text-decoration: underline;">Browse all teams →</a>
        </div>
      `;
      document.querySelectorAll('.team-section, .team-quick-stats, .team-menu-bar').forEach(el => el.style.display = 'none');
    }

    // ===== PARTICLES =====
    function createParticles() {
      const container = document.getElementById('particlesContainer');
      if (!container) return;
      const colorTypes = ['primary', 'accent', 'white'];
      const floatTypes = ['float-1', 'float-2', 'float-3', 'float-4'];
      for (let i = 0; i < 25; i++) {
        const particle = document.createElement('div');
        particle.className = `particle ${colorTypes[i % colorTypes.length]} ${floatTypes[Math.floor(Math.random() * floatTypes.length)]}`;
        const size = Math.random() * 5 + 3;
        particle.style.cssText = `width:${size}px;height:${size}px;left:${Math.random()*100}%;top:${Math.random()*100}%;animation-delay:${-Math.random()*20}s`;
        container.appendChild(particle);
      }
    }

    // ===== MENU NAVIGATION =====
    function initMenuNavigation() {
      document.querySelectorAll('.team-menu-item').forEach(item => {
        item.addEventListener('click', (e) => {
          e.preventDefault();
          const section = document.getElementById(item.dataset.section);
          if (section) {
            const offset = section.getBoundingClientRect().top + window.pageYOffset - 120;
            window.scrollTo({ top: offset, behavior: 'smooth' });
          }
        });
      });
    }

    // ===== TEAM NAME NORMALIZATION =====
    function normalizeTeamName(name) {
      if (!name) return name;
      const map = {
        'Farmington High School': 'Farmington', 'Alvirne High School': 'Alvirne', 'Bedford High School': 'Bedford',
        'Belmont High School': 'Belmont', 'Bishop Brady High School': 'Bishop Brady', 'Bishop Guertin High School': 'Bishop Guertin',
        'Bow High School': 'Bow', 'Campbell High School': 'Campbell', 'Coe-Brown Northwood Academy': 'Coe-Brown',
        'Concord High School': 'Concord', 'Concord Christian Academy': 'Concord Christian', 'ConVal Regional High School': 'ConVal',
        'Derryfield School': 'Derryfield', 'Dover High School': 'Dover', 'Exeter High School': 'Exeter',
        'Gilford High School': 'Gilford', 'Goffstown High School': 'Goffstown', 'Hanover High School': 'Hanover',
        'Hollis-Brookline High School': 'Hollis-Brookline', 'Keene High School': 'Keene', 'Kennett High School': 'Kennett',
        'Kingswood Regional High School': 'Kingswood', 'Laconia High School': 'Laconia', 'Lebanon High School': 'Lebanon',
        'Londonderry High School': 'Londonderry', 'Manchester Central High School': 'Manchester Central',
        'Manchester Memorial High School': 'Manchester Memorial', 'Manchester West High School': 'Manchester West',
        'Merrimack High School': 'Merrimack', 'Milford High School': 'Milford', 'Nashua High School North': 'Nashua North',
        'Nashua High School South': 'Nashua South', 'Oyster River High School': 'Oyster River', 'Pelham High School': 'Pelham',
        'Pembroke Academy': 'Pembroke', 'Pinkerton Academy': 'Pinkerton', 'Plymouth Regional High School': 'Plymouth',
        'Portsmouth High School': 'Portsmouth', 'Portsmouth Christian Academy': 'Portsmouth Christian', 'Salem High School': 'Salem', 'Souhegan High School': 'Souhegan',
        'Spaulding High School': 'Spaulding', 'St. Thomas Aquinas High School': 'St. Thomas Aquinas',
        'Timberlane Regional High School': 'Timberlane', 'Trinity High School': 'Trinity', 'Windham High School': 'Windham',
        'Winnacunnet High School': 'Winnacunnet'
      };
      return map[name] || name;
    }

    // ===== LOAD SCHEDULES =====
    async function loadSchedules() {
      if (!TEAM_CONFIG) return;
      try {
        const response = await fetch('/.netlify/functions/get-games');
        const data = await response.json();
        const allGames = (data.games || []).map(g => ({
          ...g, home: normalizeTeamName(g.home || g.home_team), away: normalizeTeamName(g.away || g.away_team)
        }));
        const teamNames = TEAM_CONFIG.nameVariations;
        
        // Exact match (case-insensitive) to avoid Portsmouth matching Portsmouth Christian, etc.
        function matchesTeamName(teamField, variations) {
          if (!teamField) return false;
          const normalized = teamField.trim().toLowerCase();
          return variations.some(v => v && v.trim().toLowerCase() === normalized);
        }
        
        const teamGames = allGames.filter(g => matchesTeamName(g.home, teamNames) || matchesTeamName(g.away, teamNames));
        
        // Normalize opponent name for deduplication - strip common suffixes and punctuation
        function normalizeForDedupe(name) {
          if (!name) return '';
          return name
            .toLowerCase()
            .replace(/\s*(high school|regional|academy|school|hs)\s*/gi, '')
            .replace(/[^a-z]/g, '');
        }
        
        // Deduplicate games by date + normalized opponent (ignore time - can vary between sources)
        function dedupeGames(games) {
          const seen = new Set();
          return games.filter(g => {
            const isHome = matchesTeamName(g.home, teamNames);
            const opponent = isHome ? g.away : g.home;
            const normalizedOpp = normalizeForDedupe(opponent);
            // Create unique key: date + normalized opponent only
            const key = `${g.date}|${normalizedOpp}`;
            if (seen.has(key)) {
              console.log('Deduped game:', g.date, opponent, '(key:', key, ')');
              return false;
            }
            seen.add(key);
            return true;
          });
        }
        
        teamData.schedules.boys = dedupeGames(teamGames.filter(g => g.gender === 'Boys'));
        teamData.schedules.girls = dedupeGames(teamGames.filter(g => g.gender === 'Girls'));
        console.log(`Schedules loaded: ${teamData.schedules.boys.length} boys, ${teamData.schedules.girls.length} girls games`);
        renderSchedules();
      } catch (err) { console.error('Error loading schedules:', err); renderScheduleError(); }
    }

    function renderSchedules() { renderScheduleCard('boys', teamData.schedules.boys); renderScheduleCard('girls', teamData.schedules.girls); }

    function renderScheduleCard(gender, games) {
      const container = document.getElementById(`${gender}ScheduleGames`);
      const recordEl = document.getElementById(`${gender}RecordCard`);
      const quickRecordEl = document.getElementById(`${gender}Record`);
      const nextGameEl = document.getElementById(`${gender}NextGame`);
      const lastResultEl = document.getElementById(`${gender}LastResult`);
      
      if (!games || games.length === 0) {
        container.innerHTML = '<div class="empty-state"><p>No games scheduled yet</p></div>';
        if (recordEl) recordEl.textContent = '0-0';
        if (quickRecordEl) quickRecordEl.textContent = '0-0';
        if (nextGameEl) nextGameEl.textContent = '--';
        if (lastResultEl) lastResultEl.textContent = '--';
        return;
      }
      
      const teamNames = TEAM_CONFIG.nameVariations;
      const isThisTeam = (name) => teamNames.some(n => n && name?.includes(n));
      games.sort((a, b) => new Date(a.date) - new Date(b.date));
      
      let wins = 0, losses = 0;
      const completedGames = [], upcomingGames = [];
      const today = new Date(new Date().toLocaleString('en-US', { timeZone: 'America/New_York' }));
      today.setHours(0, 0, 0, 0);
      
      games.forEach(g => {
        const gameDate = new Date(g.date + 'T12:00:00-05:00'); gameDate.setHours(0, 0, 0, 0);
        const isHome = isThisTeam(g.home);
        const hs = String(g.home_score || '').trim(), as = String(g.away_score || '').trim();
        const hasScore = hs !== '' && as !== '';
        if (hasScore) {
          const homeScore = parseInt(hs), awayScore = parseInt(as);
          const teamScore = isHome ? homeScore : awayScore, oppScore = isHome ? awayScore : homeScore;
          const won = teamScore > oppScore;
          if (won) wins++; else losses++;
          completedGames.push({ ...g, isHome, teamScore, oppScore, won });
        } else if (gameDate >= today) { upcomingGames.push({ ...g, isHome }); }
      });
      
      const record = `${wins}-${losses}`;
      if (recordEl) recordEl.textContent = record;
      if (quickRecordEl) quickRecordEl.textContent = record;
      if (nextGameEl) {
        if (upcomingGames.length > 0) {
          const next = upcomingGames[0], opp = next.isHome ? next.away : next.home;
          nextGameEl.textContent = `${formatShortDate(next.date)} ${next.isHome ? 'vs' : '@'} ${opp}`;
        } else nextGameEl.textContent = '--';
      }
      if (lastResultEl) {
        if (completedGames.length > 0) {
          const last = completedGames[completedGames.length - 1], opp = last.isHome ? last.away : last.home;
          lastResultEl.textContent = `${last.won ? 'W' : 'L'} ${last.teamScore}-${last.oppScore} ${last.isHome ? 'vs' : '@'} ${opp}`;
        } else lastResultEl.textContent = '--';
      }
      
      const allGames = games.map(g => {
        const isHome = isThisTeam(g.home);
        const hs = String(g.home_score || '').trim(), as = String(g.away_score || '').trim();
        const hasScore = hs !== '' && as !== '';
        let teamScore, oppScore, won;
        if (hasScore) {
          const homeScore = parseInt(hs), awayScore = parseInt(as);
          teamScore = isHome ? homeScore : awayScore; oppScore = isHome ? awayScore : homeScore;
          won = teamScore > oppScore;
        }
        return { ...g, isHome, teamScore, oppScore, won, hasScore };
      });
      
      container.innerHTML = allGames.map(g => {
        const opp = g.isHome ? g.away : g.home;
        let resultClass = 'upcoming', resultText = formatTime(g.time);
        if (g.hasScore) { resultClass = g.won ? 'win' : 'loss'; resultText = `${g.won ? 'W' : 'L'} ${g.teamScore}-${g.oppScore}`; }
        return `
          <div class="schedule-game-item">
            <div class="schedule-game-date">${formatShortDate(g.date)}</div>
            <div class="schedule-game-opponent">
              <img src="/logos/100px/${getLogoFilename(opp)}" onerror="this.style.display='none'" class="schedule-game-logo" alt="">
              <span>${g.isHome ? 'vs' : '@'} ${opp}</span>
            </div>
            <div class="schedule-game-result ${resultClass}">${resultText}</div>
          </div>
        `;
      }).join('');
    }

    function getLogoFilename(teamName) {
      if (!teamName) return 'Ball603-white.png';
      const specialCases = {
        'coe-brown': 'CoeBrown', 'bishop brady': 'BishopBrady', 'bishop guertin': 'BishopGuertin',
        'concord christian': 'ConcordChristian', 'con-val': 'ConVal', 'conval': 'ConVal', 'fall mountain': 'FallMountain',
        'hillsboro-deering': 'HillsboroDeering', 'hollis-brookline': 'HollisBrookline', 'holy family': 'HolyFamily',
        'inter-lakes': 'InterLakes', 'john stark': 'JohnStark', 'lin-wood': 'LinWood', 'manchester central': 'ManchesterCentral',
        'manchester memorial': 'ManchesterMemorial', 'manchester west': 'ManchesterWest', 'mascoma valley': 'Mascoma',
        'merrimack valley': 'MerrimackValley', 'mount royal': 'MountRoyal', 'nashua north': 'NashuaNorth',
        'nashua south': 'NashuaSouth', 'oyster river': 'OysterRiver', 'pittsburg-canaan': 'PittsburgCanaan',
        'portsmouth christian': 'PortsmouthChristian', 'prospect mountain': 'ProspectMountain',
        'st. thomas aquinas': 'StThomasAquinas', 'st thomas aquinas': 'StThomasAquinas', 'white mountains': 'WhiteMountains',
        'wilton-lyndeborough': 'WiltonLyndeborough'
      };
      const lower = teamName.toLowerCase().trim();
      if (specialCases[lower]) return specialCases[lower] + '.png';
      return teamName.split(/[\s-]+/).map(w => w.charAt(0).toUpperCase() + w.slice(1).toLowerCase()).join('') + '.png';
    }

    function renderScheduleError() {
      ['boys', 'girls'].forEach(gender => {
        document.getElementById(`${gender}ScheduleGames`).innerHTML = '<div class="empty-state"><p>Unable to load schedule</p></div>';
      });
    }

    // ===== ARTICLE DATE HELPERS (matching news.html) =====
    function getArticleDateString(article) {
      if (article.article_date) {
        return article.article_date; // Already YYYY-MM-DD
      }
      if (article.published_at) {
        return article.published_at.split('T')[0]; // Extract date part
      }
      return '1970-01-01';
    }
    
    function getArticleDisplayDate(article) {
      return article.article_date || article.published_at || null;
    }

    // ===== LOAD ARTICLES =====
    async function loadArticles() {
      if (!TEAM_CONFIG) return;
      try {
        const { data: articles, error } = await db.from('articles').select('*').eq('status', 'published');
        if (error) throw error;
        
        // Normalize team slug for comparison (strip all non-alphanumeric)
        const teamTagNormalized = TEAM_CONFIG.slug.toLowerCase().replace(/[^a-z0-9]/g, '');
        
        // Filter articles by team tag
        const teamArticles = (articles || []).filter(a => {
          if (!a.tags) return false;
          const tagArray = Array.isArray(a.tags) ? a.tags : JSON.parse(a.tags || '[]');
          return tagArray.some(tag => tag.toLowerCase().replace(/[^a-z0-9]/g, '') === teamTagNormalized);
        });
        
        // Sort by article_date (Publication Date), falling back to published_at
        teamArticles.sort((a, b) => {
          const dateA = getArticleDateString(a);
          const dateB = getArticleDateString(b);
          return dateB.localeCompare(dateA); // Newest first
        });
        
        renderArticles(teamArticles.slice(0, 6));
      } catch (err) { console.error('Error loading articles:', err); }
    }

    function renderArticles(articles) {
      const container = document.getElementById('storiesFeatured');
      if (!articles || articles.length === 0) { container.innerHTML = '<div class="empty-state"><p>No stories yet. Check back soon!</p></div>'; return; }
      const featured = articles[0], secondary = articles.slice(1, 6);
      const featuredPhotog = featured.photographer || featured.game_data?.photographerName || featured.featured_image_caption || '';
      container.innerHTML = `
        <a href="/article/${featured.slug}" class="story-box-large">
          <div class="story-box-image" style="background-image: url('${featured.featured_image_url || '/images/placeholder.jpg'}');">
            ${featuredPhotog ? `<div class="photo-credit">&#128247; ${featuredPhotog}</div>` : ''}
          </div>
          <div class="story-box-content">
            <h3 class="story-box-title">${featured.title}</h3>
            <span class="story-box-date">&#128197; ${formatDate(getArticleDisplayDate(featured))}</span>
          </div>
        </a>
        ${secondary.length > 0 ? `<div class="story-box-stack">${secondary.map(a => {
          const photog = a.photographer || a.game_data?.photographerName || a.featured_image_caption || '';
          return `
            <a href="/article/${a.slug}" class="story-box-small">
              <div class="story-box-image" style="background-image: url('${a.featured_image_url || '/images/placeholder.jpg'}');">
                ${photog ? `<div class="photo-credit">&#128247; ${photog}</div>` : ''}
              </div>
              <div class="story-box-content"><h4 class="story-box-title">${a.title}</h4><span class="story-box-date">&#128197; ${formatDate(getArticleDisplayDate(a))}</span></div>
            </a>`;
        }).join('')}</div>` : ''}
      `;
    }

    // ===== LOAD SPONSOR =====
    async function loadSponsor() {
      if (!TEAM_CONFIG) return;
      try {
        const { data: sponsor, error } = await db.from('sponsors').select('*').eq('team_shortname', TEAM_CONFIG.shortname).eq('active', true).single();
        if (!error && sponsor) { teamData.sponsor = sponsor; renderSponsor(sponsor); }
      } catch (err) { /* Fallback shown */ }
    }

    function renderSponsor(sponsor) {
      if (!sponsor || !TEAM_CONFIG) return;
      document.getElementById('sponsorBox').innerHTML = `
        <div class="sponsor-header">${TEAM_CONFIG.shortname.toUpperCase()} COVERAGE PRESENTED BY</div>
        <a href="${sponsor.url || '#'}" class="sponsor-link" ${sponsor.url ? 'target="_blank"' : ''}>
          <img src="${sponsor.logo_url}" alt="${sponsor.name}" class="sponsor-logo-img">
        </a>
      `;
    }

    // ===== LOAD ROSTERS =====
    async function loadRosters() {
      if (!TEAM_CONFIG) return;
      try {
        const response = await fetch(`/.netlify/functions/get-rosters?school=${encodeURIComponent(TEAM_CONFIG.name)}`);
        const data = await response.json();
        if (data.success && data.rosters) {
          data.rosters.forEach(r => { if (r.gender === 'Boys') teamData.rosters.boys = r; else if (r.gender === 'Girls') teamData.rosters.girls = r; });
        }
      } catch (err) { console.error('Error loading rosters:', err); }
      renderRosters();
    }

    function renderRosters() { renderRosterCard('boys', teamData.rosters.boys); renderRosterCard('girls', teamData.rosters.girls); }

    function renderRosterCard(gender, roster) {
      if (!TEAM_CONFIG) return;
      const bodyEl = document.getElementById(`${gender}RosterBody`), countEl = document.getElementById(`${gender}RosterCount`), coachEl = document.getElementById(`${gender}CoachInfo`);
      const genderLabel = gender.charAt(0).toUpperCase() + gender.slice(1);
      if (!roster || !roster.players_json || roster.players_json.length === 0) {
        countEl.textContent = '--'; coachEl.style.display = 'none';
        bodyEl.innerHTML = `<div class="roster-empty"><p>No roster submitted yet.</p><p><a href="mailto:kj@ball603.com?subject=Roster%20Submission%20-%20${encodeURIComponent(TEAM_CONFIG.name)}%20${genderLabel}">Submit Now</a></p></div>`;
        return;
      }
      const players = roster.players_json;
      countEl.textContent = `${players.length} Players`;
      if (roster.head_coach) {
        coachEl.style.display = 'block';
        coachEl.innerHTML = `<strong>Head Coach:</strong> ${roster.head_coach}${roster.assistant_coaches ? `<br><small>Assistants: ${roster.assistant_coaches}</small>` : ''}`;
      } else coachEl.style.display = 'none';
      bodyEl.innerHTML = `<table class="roster-table"><thead><tr><th>#</th><th>Name</th><th>Yr</th><th>Pos</th></tr></thead><tbody>${players.map(p => `<tr><td class="num">${p.number || '--'}</td><td class="name">${p.name}</td><td class="class">${p.class || '--'}</td><td class="pos">${p.position || '--'}</td></tr>`).join('')}</tbody></table>`;
    }

    // ===== LOAD GALLERIES =====
    // Helper function to check if album title matches team name with word boundaries
    function albumMatchesTeam(albumTitle, teamVariation) {
      if (!albumTitle || !teamVariation) return false;
      const title = albumTitle.toLowerCase();
      const variation = teamVariation.toLowerCase();
      // Create regex with word boundaries to avoid partial matches (e.g., "Con" matching "Concord")
      // Escape special regex characters in the team name
      const escaped = variation.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
      const regex = new RegExp(`(^|[^a-z])${escaped}([^a-z]|$)`, 'i');
      return regex.test(title);
    }

    async function loadGalleries() {
      if (!TEAM_CONFIG) return;
      try {
        const { data: albums, error } = await db.from('smugmug_albums').select('album_key, name, url, image_count, album_date, thumbnail_url').order('album_date', { ascending: false });
        if (error) throw error;
        if (!albums || albums.length === 0) { await loadGalleriesFromSmugMug(); return; }
        const matchingAlbums = albums.filter(a => { const title = a.name || ''; return TEAM_CONFIG.nameVariations.some(v => v && albumMatchesTeam(title, v)); });
        const { data: manualGalleries } = await db.from('team_galleries').select('album_key').eq('team_slug', TEAM_CONFIG.slug);
        const manualKeys = new Set((manualGalleries || []).map(g => g.album_key));
        const manualAlbums = albums.filter(a => manualKeys.has(a.album_key) && !matchingAlbums.find(m => m.album_key === a.album_key));
        const allMatching = [...matchingAlbums, ...manualAlbums].sort((a, b) => new Date(b.album_date) - new Date(a.album_date));
        teamData.galleries = allMatching.map(a => ({ id: a.album_key, title: a.name, thumbnail: a.thumbnail_url, url: a.url, date: a.album_date, photoCount: a.image_count }));
        renderGalleries();
      } catch (err) { console.error('Error loading galleries:', err); await loadGalleriesFromSmugMug(); }
    }

    async function loadGalleriesFromSmugMug() {
      if (!TEAM_CONFIG) return;
      try {
        const response = await fetch('/.netlify/functions/smugmug?action=albums');
        const data = await response.json();
        if (data.success && data.albums) {
          const matching = data.albums.filter(a => { const title = a.name || ''; return TEAM_CONFIG.nameVariations.some(v => v && albumMatchesTeam(title, v)); });
          teamData.galleries = matching.map(a => ({ id: a.key, title: a.name, thumbnail: null, url: a.url, date: a.date, photoCount: a.imageCount }));
          renderGalleries();
          await Promise.all(teamData.galleries.slice(0, 20).map(async g => {
            try {
              const r = await fetch(`/.netlify/functions/smugmug?action=albumThumb&albumKey=${g.id}`);
              const d = await r.json();
              if (d.success && d.thumbnailUrl) g.thumbnail = d.thumbnailUrl;
            } catch (e) {}
          }));
          renderGalleries();
        }
      } catch (err) { console.error('Error loading galleries from SmugMug:', err); }
    }

    function renderGalleries() {
      const container = document.getElementById('galleriesGrid');
      if (teamData.galleries.length === 0) { container.innerHTML = '<div class="empty-state"><p>No photo galleries yet.</p><p class="empty-help">Check back after game day!</p></div>'; return; }
      container.innerHTML = teamData.galleries.map(g => {
        const hasThumb = g.thumbnail && g.thumbnail.length > 0;
        return `
          <a href="${g.url}" class="gallery-card" target="_blank">
            <div class="gallery-card-image ${hasThumb ? '' : 'no-thumb'}" style="${hasThumb ? `background-image: url('${g.thumbnail}');` : ''}">
              ${g.photoCount ? `<div class="gallery-card-overlay"><span class="gallery-card-count">${g.photoCount} Photos</span></div>` : ''}
            </div>
            <div class="gallery-card-info"><h4 class="gallery-card-title">${g.title}</h4><span class="gallery-card-date">${formatDate(g.date)}</span></div>
          </a>`;
      }).join('');
      setupGalleryArrows();
    }

    function setupGalleryArrows() {
      const container = document.getElementById('galleriesGrid'), left = document.getElementById('galleryArrowLeft'), right = document.getElementById('galleryArrowRight');
      if (!container || !left || !right) return;
      const update = () => { left.disabled = container.scrollLeft <= 0; right.disabled = container.scrollLeft >= container.scrollWidth - container.clientWidth - 10; };
      left.addEventListener('click', () => container.scrollBy({ left: -480, behavior: 'smooth' }));
      right.addEventListener('click', () => container.scrollBy({ left: 480, behavior: 'smooth' }));
      container.addEventListener('scroll', update);
      update();
    }

    // ===== LOAD FEATURES DATA =====
    async function loadFeaturesData() {
      if (!TEAM_CONFIG) return;
      
      const schoolName = TEAM_CONFIG.name.toLowerCase()
        .replace(/\s+hs$/i, '')
        .replace(/\s+high\s+school$/i, '')
        .replace(/\s+academy$/i, '')
        .replace(/regional/i, '')
        .replace(/\s+/g, ' ')
        .trim();
      
      // Fetch 1K Scorers from Supabase
      try {
        const { data: scorers, error: scorersError } = await db
          .from('scorers_1k')
          .select('*')
          .ilike('school', schoolName)
          .order('points', { ascending: false, nullsFirst: false });
        
        if (scorersError) throw scorersError;
        
        teamData.scorers1K = scorers || [];
      } catch (err) {
        console.error('Error fetching 1K scorers from Supabase:', err);
        // Fallback to static data
        if (typeof getSchool1KScorers === 'function') {
          teamData.scorers1K = getSchool1KScorers(TEAM_CONFIG.name);
        } else {
          teamData.scorers1K = [];
        }
      }
      
      // Fetch NCAA players from Supabase
      try {
        const { data: players, error: playersError } = await db
          .from('ncaa_players')
          .select('*')
          .ilike('high_school', `%${schoolName}%`)
          .eq('active', true)
          .order('name', { ascending: true });
        
        if (playersError) throw playersError;
        
        teamData.ncaaPlayers = players || [];
      } catch (err) {
        console.error('Error fetching NCAA players from Supabase:', err);
        // Fallback to static data
        if (typeof getSchoolNCAAPlayers === 'function') {
          teamData.ncaaPlayers = getSchoolNCAAPlayers(TEAM_CONFIG.name);
        } else {
          teamData.ncaaPlayers = [];
        }
      }
      
      // Fetch championships from Supabase
      try {
        const { data, error } = await db
          .from('championship_history')
          .select('*')
          .or(`champion.ilike.${schoolName},runner_up.ilike.${schoolName}`)
          .order('year', { ascending: false });
        
        if (error) throw error;
        
        if (data && data.length > 0) {
          const results = { boys: [], girls: [], totalTitles: 0, totalRunnerUp: 0 };
          
          data.forEach(game => {
            const isChampion = game.champion.toLowerCase() === schoolName;
            const entry = {
              ...game,
              result: isChampion ? 'champion' : 'runner_up'
            };
            
            if (game.gender === 'Boys') {
              results.boys.push(entry);
            } else {
              results.girls.push(entry);
            }
            
            if (isChampion) {
              results.totalTitles++;
            } else {
              results.totalRunnerUp++;
            }
          });
          
          teamData.championships = results;
        } else {
          teamData.championships = { boys: [], girls: [], totalTitles: 0, totalRunnerUp: 0 };
        }
      } catch (err) {
        console.error('Error fetching championships from Supabase:', err);
        // Fallback to static data
        if (typeof getSchoolChampionships === 'function') {
          teamData.championships = getSchoolChampionships(TEAM_CONFIG.name);
        } else {
          teamData.championships = { boys: [], girls: [], totalTitles: 0, totalRunnerUp: 0 };
        }
      }
    }

    // ===== RENDER ALL =====
    function renderAll() { renderChampionshipStats(); renderChampionshipHistory(); render1KScorers(); renderNCAAPlayers(); }

    function renderChampionshipStats() {
      const champs = teamData.championships, container = document.getElementById('heroStats');
      const titles = champs.totalTitles || 0, runnerUps = champs.totalRunnerUp || 0, total = titles + runnerUps;
      if (total === 0) { container.innerHTML = ''; container.style.display = 'none'; return; }
      container.style.display = 'flex';
      
      // Count boys and girls titles
      const boysTitles = (champs.boys || []).filter(g => g.result === 'champion').length;
      const girlsTitles = (champs.girls || []).filter(g => g.result === 'champion').length;
      let sublabelText = '';
      if (boysTitles > 0 && girlsTitles > 0) {
        sublabelText = `${boysTitles} Boys &#8211; ${girlsTitles} Girls`;
      } else if (boysTitles > 0) {
        sublabelText = `${boysTitles} Boys`;
      } else if (girlsTitles > 0) {
        sublabelText = `${girlsTitles} Girls`;
      }
      
      container.innerHTML = `
        ${titles > 0 ? `<div class="team-hero-stats-primary"><div class="team-hero-stat championship"><span class="stat-icon">&#127942;</span><div class="stat-text"><span class="stat-value">${titles}</span><span class="stat-label">State Championship${titles !== 1 ? 's' : ''}</span><span class="stat-sublabel">${sublabelText}</span></div></div></div>` : ''}
        <div class="team-hero-stats-secondary">
          ${runnerUps > 0 ? `<div class="team-hero-stat-small runner-up"><span class="stat-icon">&#129352;</span><span class="stat-value">${runnerUps}</span><span class="stat-label">Runner-Up${runnerUps !== 1 ? 's' : ''}</span></div>` : ''}
          ${total > 0 ? `<div class="team-hero-stat-small finals"><span class="stat-icon">&#127936;</span><span class="stat-value">${total}</span><span class="stat-label">Title Game${total !== 1 ? 's' : ''}</span></div>` : ''}
        </div>`;
    }

    function renderChampionshipHistory() {
      const container = document.getElementById('historyContent'), champs = teamData.championships;
      let allGames = [...(champs.boys || []), ...(champs.girls || [])].sort((a, b) => b.year - a.year);
      if (allGames.length === 0) { container.innerHTML = '<div class="empty-state"><p>No championship game appearances on record.</p></div>'; return; }
      const wins = allGames.filter(g => g.result === 'champion');
      container.innerHTML = `
        ${wins.length > 0 ? `<div class="championship-cards-row">${wins.slice(0, 6).map(g => `<div class="championship-card"><div class="champ-year">${g.year}</div><div class="champ-trophy">&#127942;</div><div class="champ-gender">${g.gender || ''}</div><div class="champ-division">${g.division}</div><div class="champ-score-box"><span class="champ-score">${g.champion_score} - ${g.runner_up_score}${g.overtime ? ' OT' : ''}</span></div><div class="champ-opponent">vs ${g.runner_up}</div></div>`).join('')}</div>` : ''}
        <div class="history-timeline"><h3>All Title Game Appearances</h3><div class="timeline-list">${allGames.map(g => {
          const isChamp = g.result === 'champion', opp = isChamp ? g.runner_up : g.champion;
          const score = isChamp ? `${g.champion_score} - ${g.runner_up_score}` : `${g.runner_up_score} - ${g.champion_score}`;
          return `<div class="timeline-item ${isChamp ? 'champion' : 'runner-up'}"><span class="timeline-year">${g.year}</span><span class="timeline-gender">${g.gender || ''}</span><span class="timeline-result">${isChamp ? '&#127942; Champion' : '&#129352; Runner-Up'}</span><span class="timeline-score">${score}${g.overtime ? ' OT' : ''}</span><span class="timeline-opponent">vs ${opp}</span></div>`;
        }).join('')}</div></div>`;
    }

    function render1KScorers() {
      const container = document.getElementById('scorersList'), scorers = teamData.scorers1K;
      if (scorers.length === 0) { container.innerHTML = '<div class="empty-state"><p>No 1,000-point scorers on record yet.</p></div>'; return; }
      container.innerHTML = `<div class="scorers-list">${scorers.map(s => `<div class="scorer-item ${s.points >= 2000 ? 'elite' : ''}"><div class="scorer-info"><div class="scorer-name">${s.name}</div><div class="scorer-year">${s.grad_year ? `Class of ${s.grad_year}` : ''}</div></div><div class="scorer-points">${s.points ? s.points.toLocaleString() : '1,000+'}</div></div>`).join('')}</div>`;
    }

    function renderNCAAPlayers() {
      const container = document.getElementById('collegePlayersList'), players = teamData.ncaaPlayers;
      if (players.length === 0) { container.innerHTML = '<div class="empty-state"><p>No current college players on record.</p></div>'; return; }
      container.innerHTML = `<div class="college-players-list">${players.map(p => `<div class="college-player-item"><div class="college-player-name">${p.name}</div><div class="college-player-school">${p.college}</div></div>`).join('')}</div>`;
    }

    // ===== UTILITIES =====
    function formatDate(dateStr) {
      if (!dateStr) return '';
      const date = new Date(dateStr + 'T12:00:00-05:00');
      return isNaN(date) ? dateStr : date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric', timeZone: 'America/New_York' });
    }
    function formatShortDate(dateStr) {
      if (!dateStr) return '';
      const date = new Date(dateStr + 'T12:00:00-05:00');
      return isNaN(date) ? dateStr : date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', timeZone: 'America/New_York' });
    }
    function formatTime(timeStr) { return timeStr ? timeStr.replace(/^0(\d)/, '$1') : 'TBD'; }
  </script>
</body>
</html>
