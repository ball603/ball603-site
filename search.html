<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Search Ball603 - Find articles, teams, and coverage">
  <meta name="theme-color" content="#f57c00">
  <title>Search | Ball603</title>
  
  <link rel="icon" type="image/png" href="/logo.png">
  <link rel="apple-touch-icon" href="/logo.png">
  
  <!-- Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-S4BN80729K"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-S4BN80729K');
  </script>
  
  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  
  <!-- Shared Styles -->
  <link rel="stylesheet" href="/styles.css">
  
  <style>
    .search-page {
      max-width: 900px;
      margin: 0 auto;
      padding: 30px 20px 60px;
    }
    
    .search-header {
      margin-bottom: 30px;
    }
    
    .search-header h1 {
      font-size: 24px;
      font-weight: 700;
      color: var(--text-primary);
      margin: 0 0 20px;
    }
    
    .search-form {
      display: flex;
      gap: 10px;
    }
    
    .search-input {
      flex: 1;
      padding: 12px 16px;
      font-size: 16px;
      border: 2px solid var(--border-color);
      border-radius: 8px;
      background: var(--bg-primary);
      color: var(--text-primary);
      outline: none;
    }
    
    .search-input:focus {
      border-color: var(--accent);
    }
    
    .search-btn {
      padding: 12px 24px;
      font-size: 16px;
      font-weight: 600;
      background: var(--accent);
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
    }
    
    .search-btn:hover {
      background: var(--accent-hover);
    }
    
    .search-results-info {
      margin-bottom: 20px;
      color: var(--text-secondary);
      font-size: 14px;
    }
    
    .search-tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      border-bottom: 1px solid var(--border-color);
      padding-bottom: 10px;
    }
    
    .search-tab {
      padding: 8px 16px;
      font-size: 14px;
      font-weight: 600;
      color: var(--text-secondary);
      background: none;
      border: none;
      cursor: pointer;
      border-radius: 6px;
    }
    
    .search-tab.active {
      background: var(--accent);
      color: white;
    }
    
    .search-tab:hover:not(.active) {
      background: var(--bg-secondary);
    }
    
    .result-count {
      font-size: 12px;
      opacity: 0.7;
    }
    
    /* Article Results */
    .article-result {
      display: flex;
      gap: 16px;
      padding: 16px;
      background: var(--bg-card);
      border: 1px solid var(--border-color);
      border-radius: 10px;
      margin-bottom: 12px;
      text-decoration: none;
      transition: all 0.2s;
    }
    
    .article-result:hover {
      border-color: var(--accent);
      transform: translateX(4px);
    }
    
    .article-result-image {
      width: 120px;
      height: 80px;
      border-radius: 6px;
      object-fit: cover;
      flex-shrink: 0;
    }
    
    .article-result-content {
      flex: 1;
      min-width: 0;
    }
    
    .article-result-title {
      font-size: 16px;
      font-weight: 600;
      color: var(--text-primary);
      margin: 0 0 6px;
      line-height: 1.3;
    }
    
    .article-result-excerpt {
      font-size: 14px;
      color: var(--text-secondary);
      margin: 0 0 8px;
      line-height: 1.4;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }
    
    .article-result-meta {
      font-size: 12px;
      color: var(--text-muted);
    }
    
    /* Team Results */
    .team-result {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 16px;
      background: var(--bg-card);
      border: 1px solid var(--border-color);
      border-radius: 10px;
      margin-bottom: 8px;
      text-decoration: none;
      transition: all 0.2s;
    }
    
    .team-result:hover {
      border-color: var(--accent);
      transform: translateX(4px);
    }
    
    .team-result-logo {
      width: 40px;
      height: 40px;
      object-fit: contain;
    }
    
    .team-result-name {
      font-size: 16px;
      font-weight: 600;
      color: var(--text-primary);
    }
    
    .team-result-info {
      font-size: 12px;
      color: var(--text-secondary);
    }
    
    /* Empty State */
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: var(--text-secondary);
    }
    
    .empty-state-icon {
      font-size: 48px;
      margin-bottom: 16px;
    }
    
    .empty-state p {
      margin: 0;
      font-size: 16px;
    }
    
    /* Loading */
    .loading {
      text-align: center;
      padding: 40px;
      color: var(--text-secondary);
    }
    
    @media (max-width: 600px) {
      .article-result {
        flex-direction: column;
      }
      
      .article-result-image {
        width: 100%;
        height: 160px;
      }
      
      .search-form {
        flex-direction: column;
      }
    }
  </style>
</head>
<body>
  <!-- Navigation loaded by nav-loader.js -->
  
  <main class="search-page">
    <div class="search-header">
      <h1>&#128269; Search Ball603</h1>
      <form class="search-form" id="searchForm">
        <input type="text" id="searchQuery" class="search-input" placeholder="Search articles, teams..." autofocus>
        <button type="submit" class="search-btn">Search</button>
      </form>
    </div>
    
    <div id="searchTabs" class="search-tabs" style="display: none;">
      <button type="button" class="search-tab active" id="tabArticles">Articles <span class="result-count" id="articleCount"></span></button>
      <button type="button" class="search-tab" id="tabTeams">Teams <span class="result-count" id="teamCount"></span></button>
    </div>
    
    <div id="searchResultsInfo" class="search-results-info"></div>
    
    <div id="searchResults">
      <div class="empty-state">
        <div class="empty-state-icon">&#128269;</div>
        <p>Enter a search term to find articles and teams</p>
      </div>
    </div>
  </main>

  <footer class="site-footer">
    <div class="footer-logo">
      <img src="/logo.png" alt="Ball603">
    </div>
    <div class="footer-links">
      <a href="/about">About Us</a>
      <a href="/contact">Contact</a>
    </div>
    <div class="footer-social">
      <a href="https://facebook.com/ball603" target="_blank" title="Facebook">
        <svg viewBox="0 0 24 24"><path d="M18 2h-3a5 5 0 0 0-5 5v3H7v4h3v8h4v-8h3l1-4h-4V7a1 1 0 0 1 1-1h3z"/></svg>
      </a>
      <a href="https://www.instagram.com/ball603nh/" target="_blank" title="Instagram">
        <svg viewBox="0 0 24 24"><path d="M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.849 0 3.205-.012 3.584-.069 4.849-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.07-4.85.07-3.204 0-3.584-.012-4.849-.07-3.26-.149-4.771-1.699-4.919-4.92-.058-1.265-.07-1.644-.07-4.849 0-3.204.013-3.583.07-4.849.149-3.227 1.664-4.771 4.919-4.919 1.266-.057 1.645-.069 4.849-.069zm0-2.163c-3.259 0-3.667.014-4.947.072-4.358.2-6.78 2.618-6.98 6.98-.059 1.281-.073 1.689-.073 4.948 0 3.259.014 3.668.072 4.948.2 4.358 2.618 6.78 6.98 6.98 1.281.058 1.689.072 4.948.072 3.259 0 3.668-.014 4.948-.072 4.354-.2 6.782-2.618 6.979-6.98.059-1.28.073-1.689.073-4.948 0-3.259-.014-3.667-.072-4.947-.196-4.354-2.617-6.78-6.979-6.98-1.281-.059-1.69-.073-4.949-.073zm0 5.838c-3.403 0-6.162 2.759-6.162 6.162s2.759 6.163 6.162 6.163 6.162-2.759 6.162-6.163c0-3.403-2.759-6.162-6.162-6.162zm0 10.162c-2.209 0-4-1.79-4-4 0-2.209 1.791-4 4-4s4 1.791 4 4c0 2.21-1.791 4-4 4zm6.406-11.845c-.796 0-1.441.645-1.441 1.44s.645 1.44 1.441 1.44c.795 0 1.439-.645 1.439-1.44s-.644-1.44-1.439-1.44z"/></svg>
      </a>
      <a href="https://x.com/Ball603NH" target="_blank" title="X (Twitter)">
        <svg viewBox="0 0 24 24"><path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/></svg>
      </a>
    </div>
    <p class="footer-copyright">&copy; 2025 Ball603. All rights reserved.</p>
  </footer>

  <!-- Nav Loader -->
  <script src="/includes/nav-loader.js"></script>
  
  <script>
    // Supabase setup
    var SUPABASE_URL = 'https://suncdkxfqkwwnmhosxcf.supabase.co';
    var SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InN1bmNka3hmcWt3d25taG9zeGNmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUwNTk4MzIsImV4cCI6MjA4MDYzNTgzMn0.aT6V8Zx_YozqOh1ZnC6x-czI9vo-QhHKmP69PgY-8xw';
    var supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    
    // State
    var allArticles = [];
    var allTeams = [];
    var currentTab = 'articles';
    var currentQuery = '';
    
    // DOM elements
    var searchForm = document.getElementById('searchForm');
    var searchInput = document.getElementById('searchQuery');
    var searchTabs = document.getElementById('searchTabs');
    var tabArticles = document.getElementById('tabArticles');
    var tabTeams = document.getElementById('tabTeams');
    var articleCount = document.getElementById('articleCount');
    var teamCount = document.getElementById('teamCount');
    var resultsInfo = document.getElementById('searchResultsInfo');
    var resultsContainer = document.getElementById('searchResults');
    
    // Initialize on page load
    window.onload = function() {
      // Check for query in URL
      var params = new URLSearchParams(window.location.search);
      var query = params.get('q');
      
      if (query) {
        searchInput.value = query;
        doSearch(query);
      }
      
      // Form submit handler
      searchForm.onsubmit = function(e) {
        e.preventDefault();
        var query = searchInput.value.trim();
        if (query) {
          window.history.replaceState({}, '', '/search?q=' + encodeURIComponent(query));
          doSearch(query);
        }
      };
      
      // Tab click handlers
      tabArticles.onclick = function() {
        currentTab = 'articles';
        tabArticles.className = 'search-tab active';
        tabTeams.className = 'search-tab';
        showResults();
      };
      
      tabTeams.onclick = function() {
        currentTab = 'teams';
        tabArticles.className = 'search-tab';
        tabTeams.className = 'search-tab active';
        showResults();
      };
    };
    
    // Main search function
    function doSearch(query) {
      currentQuery = query.toLowerCase();
      resultsContainer.innerHTML = '<div class="loading">Loading...</div>';
      
      // Load data if needed, then show results
      if (allArticles.length === 0) {
        loadData(function() {
          searchTabs.style.display = 'flex';
          showResults();
        });
      } else {
        searchTabs.style.display = 'flex';
        showResults();
      }
    }
    
    // Load data from Supabase
    function loadData(callback) {
      var articlesLoaded = false;
      var teamsLoaded = false;
      
      function checkDone() {
        if (articlesLoaded && teamsLoaded && callback) {
          callback();
        }
      }
      
      // Load articles
      supabase
        .from('articles')
        .select('*')
        .eq('status', 'published')
        .order('published_at', { ascending: false })
        .then(function(result) {
          allArticles = result.data || [];
          articlesLoaded = true;
          checkDone();
        });
      
      // Load teams
      supabase
        .from('teams')
        .select('*')
        .eq('active', true)
        .order('full_name')
        .then(function(result) {
          allTeams = result.data || [];
          teamsLoaded = true;
          checkDone();
        });
    }
    
    // Display results
    function showResults() {
      // Filter articles
      var filteredArticles = [];
      for (var i = 0; i < allArticles.length; i++) {
        var a = allArticles[i];
        var searchText = (a.title || '') + ' ' + (a.content || '') + ' ' + (a.excerpt || '') + ' ' + (a.tags || []).join(' ');
        if (searchText.toLowerCase().indexOf(currentQuery) !== -1) {
          filteredArticles.push(a);
        }
      }
      
      // Filter teams
      var filteredTeams = [];
      for (var i = 0; i < allTeams.length; i++) {
        var t = allTeams[i];
        var searchText = (t.shortname || '') + ' ' + (t.full_name || '') + ' ' + (t.mascot || '');
        if (searchText.toLowerCase().indexOf(currentQuery) !== -1) {
          filteredTeams.push(t);
        }
      }
      
      // Update tab counts
      articleCount.textContent = '(' + filteredArticles.length + ')';
      teamCount.textContent = '(' + filteredTeams.length + ')';
      
      // Build HTML based on current tab
      var html = '';
      
      if (currentTab === 'articles') {
        resultsInfo.textContent = filteredArticles.length + ' article' + (filteredArticles.length !== 1 ? 's' : '') + ' found for "' + currentQuery + '"';
        
        if (filteredArticles.length === 0) {
          html = '<div class="empty-state"><div class="empty-state-icon">&#128240;</div><p>No articles found matching "' + escapeHtml(currentQuery) + '"</p></div>';
        } else {
          for (var i = 0; i < filteredArticles.length && i < 50; i++) {
            var article = filteredArticles[i];
            var title = escapeHtml(article.title || 'Untitled');
            var slug = article.slug || '';
            var excerpt = stripHtml(article.excerpt || article.content || '').substring(0, 150);
            var date = article.published_at ? formatDate(article.published_at) : '';
            var image = article.featured_image_url || '/logo.png';
            
            html += '<a href="/article/' + slug + '" class="article-result">';
            html += '<img src="' + image + '" alt="" class="article-result-image" onerror="this.src=\'/logo.png\'">';
            html += '<div class="article-result-content">';
            html += '<h3 class="article-result-title">' + title + '</h3>';
            html += '<p class="article-result-excerpt">' + excerpt + '...</p>';
            html += '<div class="article-result-meta">' + date + '</div>';
            html += '</div></a>';
          }
        }
      } else {
        resultsInfo.textContent = filteredTeams.length + ' team' + (filteredTeams.length !== 1 ? 's' : '') + ' found for "' + currentQuery + '"';
        
        if (filteredTeams.length === 0) {
          html = '<div class="empty-state"><div class="empty-state-icon">&#127936;</div><p>No teams found matching "' + escapeHtml(currentQuery) + '"</p></div>';
        } else {
          for (var i = 0; i < filteredTeams.length; i++) {
            var team = filteredTeams[i];
            var name = escapeHtml(team.full_name || team.shortname || 'Unknown');
            var shortname = team.shortname || '';
            var logoFile = team.logo_filename || (shortname.replace(/[^a-zA-Z0-9]/g, '') + '.png');
            var infoParts = [];
            if (team.gender) infoParts.push(team.gender);
            if (team.level) infoParts.push(team.level);
            if (team.division) infoParts.push(team.division);
            var info = infoParts.join(' &#8226; ');
            
            html += '<a href="/' + shortname + '" class="team-result">';
            html += '<img src="/logos/100px/' + logoFile + '" alt="" class="team-result-logo" onerror="this.src=\'/logo.png\'">';
            html += '<div>';
            html += '<div class="team-result-name">' + name + '</div>';
            html += '<div class="team-result-info">' + info + '</div>';
            html += '</div></a>';
          }
        }
      }
      
      // Set the HTML
      resultsContainer.innerHTML = html;
    }
    
    // Utility functions
    function stripHtml(str) {
      var div = document.createElement('div');
      div.innerHTML = str || '';
      return div.textContent || div.innerText || '';
    }
    
    function escapeHtml(str) {
      if (!str) return '';
      var div = document.createElement('div');
      div.textContent = str;
      return div.innerHTML;
    }
    
    function formatDate(dateStr) {
      var d = new Date(dateStr);
      var months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
      return months[d.getMonth()] + ' ' + d.getDate() + ', ' + d.getFullYear();
    }
  </script>
</body>
</html>
