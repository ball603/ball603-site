<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ball603 Contributor Coverage Schedule</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f5f5f5; color: #333; min-height: 100vh; }
    .container { max-width: 1400px; margin: 0 auto; padding: 20px; }
    
    /* Login */
    .login-box { background: #fff; padding: 40px; border-radius: 10px; max-width: 400px; margin: 100px auto; box-shadow: 0 2px 10px rgba(0,0,0,0.1); text-align: center; }
    .login-box img { max-width: 200px; margin-bottom: 20px; }
    .login-box input { width: 100%; padding: 12px; margin-bottom: 15px; border: 1px solid #ddd; border-radius: 5px; font-size: 16px; }
    .login-box button { width: 100%; padding: 12px; background: #c41e3a; color: white; border: none; border-radius: 5px; font-size: 16px; cursor: pointer; }
    .login-box button:hover { background: #a01830; }
    .error { color: #c41e3a; margin-top: 10px; }
    
    /* Header */
    .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 15px; background: #fff; padding: 15px 20px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
    .header-left { display: flex; align-items: center; gap: 15px; }
    .header-left img { height: 50px; }
    .header-left h1 { font-size: 18px; color: #333; }
    .user-info { display: flex; align-items: center; gap: 15px; }
    .user-info select { padding: 8px 12px; border-radius: 5px; border: 1px solid #ddd; font-size: 14px; }
    .logout-btn { padding: 8px 16px; background: #eee; color: #333; border: none; border-radius: 5px; cursor: pointer; }
    .logout-btn:hover { background: #ddd; }
    
    /* Filters */
    .filters { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
    .filters select, .filters input { padding: 8px 12px; border-radius: 5px; border: 1px solid #ddd; font-size: 14px; background: #fff; }
    .filters input { width: 200px; }
    
    /* Tabs */
    .tabs { display: flex; gap: 5px; margin-bottom: 20px; }
    .tab { padding: 10px 20px; background: #fff; border: 1px solid #ddd; color: #666; cursor: pointer; border-radius: 5px 5px 0 0; }
    .tab.active { background: #c41e3a; color: white; border-color: #c41e3a; }
    
    /* Games Table */
    .games-table { width: 100%; border-collapse: collapse; background: #fff; border-radius: 10px; overflow: hidden; box-shadow: 0 2px 5px rgba(0,0,0,0.05); font-size: 12px; }
    .games-table th { background: #e8e8e8; padding: 10px 8px; text-align: left; font-weight: 600; color: #333; white-space: nowrap; }
    .games-table td { padding: 8px; border-bottom: 1px solid #eee; vertical-align: top; }
    .games-table tr:nth-child(even) { background: #f9f9f9; }
    .games-table tr:hover { background: #f0f0f0; }
    
    /* Coverage cell */
    .coverage-cell { min-width: 120px; }
    .claim-cell { width: 30px; vertical-align: top; text-align: center; }
    .coverage-entry { display: flex; align-items: center; gap: 4px; margin-bottom: 3px; }
    .coverage-entry:last-child { margin-bottom: 0; }
    .coverage-emoji { font-size: 12px; }
    .coverage-name { font-size: 11px; color: #333; }
    .coverage-remove { background: none; border: none; color: #999; cursor: pointer; font-size: 12px; padding: 0 2px; }
    .coverage-remove:hover { color: #c41e3a; }
    
    /* Claim dropdown */
    .claim-wrapper { position: relative; display: inline-block; }
    .claim-btn { cursor: pointer; font-size: 16px; background: none; border: none; padding: 0; line-height: 1; }
    .claim-btn:hover { transform: scale(1.2); }
    .claim-dropdown { display: none; position: absolute; top: 100%; left: 0; background: #fff; border: 1px solid #ddd; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); z-index: 100; margin-top: 4px; overflow: hidden; }
    .claim-dropdown.show { display: block; }
    .claim-option { display: flex; align-items: center; gap: 8px; padding: 10px 16px; cursor: pointer; white-space: nowrap; font-size: 13px; }
    .claim-option:hover { background: #f5f5f5; }
    .claim-option .emoji { font-size: 16px; }
    
    /* Notes */
    .notes-cell { max-width: 150px; }
    .notes-input { width: 100%; padding: 3px 6px; border: 1px solid #ddd; border-radius: 4px; background: #fff; color: #333; font-size: 11px; }
    .notes-input:focus { outline: none; border-color: #c41e3a; }
    
    /* Alert banner */
    .alert-banner { background: #fff3cd; border: 1px solid #ffc107; color: #856404; padding: 15px 20px; border-radius: 8px; margin-bottom: 20px; }
    .alert-banner h3 { margin-bottom: 10px; display: flex; align-items: center; gap: 8px; }
    .alert-item { display: flex; align-items: center; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid rgba(0,0,0,0.1); }
    .alert-item:last-child { border-bottom: none; }
    .alert-info { flex: 1; }
    .alert-game { font-weight: 600; }
    .alert-change { font-size: 12px; color: #666; }
    .alert-buttons { display: flex; gap: 8px; }
    .alert-btn { padding: 6px 12px; border-radius: 5px; border: none; cursor: pointer; font-size: 12px; }
    .alert-btn.accept { background: #4CAF50; color: white; }
    .alert-btn.deny { background: #f44336; color: white; }
    .alert-btn:hover { opacity: 0.9; }
    .alert-contributor { font-size: 11px; color: #888; margin-left: 8px; }
    
    /* Changed game highlight */
    .game-changed { background: #fff3cd !important; }
    .date-change { display: flex; flex-direction: column; }
    .old-date { text-decoration: line-through; color: #999; font-size: 10px; }
    .new-date { color: #c41e3a; font-weight: 600; }
    
    /* Responsive */
    @media (max-width: 768px) {
      .games-table { font-size: 11px; }
      .games-table th, .games-table td { padding: 6px 4px; }
      .hide-mobile { display: none; }
      .header-left h1 { display: none; }
    }
    
    .loading { text-align: center; padding: 40px; color: #888; }
  </style>
</head>
<body>
  <div class="container" id="app">
    <!-- Login Screen -->
    <div class="login-box" id="loginScreen">
      <img src="logo.png" alt="Ball603">
      <input type="password" id="password" placeholder="Enter password" onkeypress="if(event.key==='Enter')login()">
      <button onclick="login()">Login</button>
      <div class="error" id="loginError"></div>
    </div>
    
    <!-- Main App (hidden until login) -->
    <div id="mainApp" style="display: none;">
      <div class="header">
        <div class="header-left">
          <img src="logo.png" alt="Ball603">
          <h1>Contributor Coverage Schedule</h1>
        </div>
        <div class="user-info">
          <span>You are:</span>
          <select id="contributorSelect" onchange="saveContributor()">
            <option value="">-- Select Your Name --</option>
          </select>
          <button class="logout-btn" onclick="logout()">Logout</button>
        </div>
      </div>
      
      <div id="alertBanner" class="alert-banner" style="display: none;">
        <h3>‚ö†Ô∏è Schedule Changes</h3>
        <div id="alertList"></div>
      </div>
      
      <div class="filters">
        <input type="text" id="searchInput" placeholder="Search teams..." oninput="renderGames()">
        <select id="genderFilter" onchange="renderGames()">
          <option value="">All Genders</option>
          <option value="Boys">Boys</option>
          <option value="Girls">Girls</option>
          <option value="Men">Men</option>
          <option value="Women">Women</option>
        </select>
        <select id="divisionFilter" onchange="renderGames()">
          <option value="">All Divisions</option>
        </select>
        <select id="assignmentFilter" onchange="renderGames()">
          <option value="">All Games</option>
          <option value="unclaimed">Unclaimed Only</option>
          <option value="mine">My Assignments</option>
          <option value="claimed">Claimed</option>
        </select>
      </div>
      
      <div class="tabs">
        <button class="tab active" data-tab="all" onclick="setTab('all')">All Games</button>
        <button class="tab" data-tab="NHIAA" onclick="setTab('NHIAA')">NHIAA</button>
        <button class="tab" data-tab="College" onclick="setTab('College')">College</button>
        <button class="tab" data-tab="Prep" onclick="setTab('Prep')">Prep</button>
      </div>
      
      <div id="gamesContainer">
        <div class="loading">Loading games...</div>
      </div>
    </div>
  </div>

  <script>
    const CONTRIBUTORS = [
      "Andy Romike", "Arinn Roy", "Betsy Hansen", "Cam Place", "Chris Laclair", "Chris Prangley",
      "Christine Gilbert", "Chuck Swierad", "Cindy Lavigne", "Connor Chrusciel", "Danielle Cook",
      "Dave Beliveau", "Frank V Fichera", "Greg Alnwick", "Hannah Smith", "Haven Deschenes",
      "Heather Savage-Erickson", "Heidi Green", "Jeff Criss", "Jessica Bonnette", "Jessica Tate",
      "Jill Stevens", "Jocelyn Sprague", "John Scott Sherburne", "KJ Cardinal", "Leo Cardinal", "LJ Hydock",
      "Logan Paronto", "Marc Hoak", "Maverick Thivierge", "Michael Griffin", "Mike Whaley",
      "Mindy Marcouillier", "Nate Ford", "Nichole Marrero", "Rick Wilson", "Sara Roberts",
      "Shawna Hurlbert", "Shirley Nickles", "Simon Scott", "Stefan Duncan", "Tim Lee",
      "Todd Grzywacz", "Tyson Thomas"
    ].sort();
    
    const ADMIN_USER = "KJ Cardinal";
    
    const CORRECT_PASSWORD = 'Gr@niteSt@teHoops';
    let allGames = [];
    let currentTab = 'all';
    let openDropdown = null;
    
    const MONTH_NAMES = ['Jan.', 'Feb.', 'Mar.', 'Apr.', 'May', 'Jun.', 'Jul.', 'Aug.', 'Sep.', 'Oct.', 'Nov.', 'Dec.'];
    
    // Close dropdown when clicking outside
    document.addEventListener('click', (e) => {
      if (openDropdown && !e.target.closest('.claim-wrapper')) {
        openDropdown.classList.remove('show');
        openDropdown = null;
      }
    });
    
    // Check if already logged in
    if (localStorage.getItem('ball603_auth') === 'true') {
      showMainApp();
    }
    
    function login() {
      const pw = document.getElementById('password').value;
      if (pw === CORRECT_PASSWORD) {
        localStorage.setItem('ball603_auth', 'true');
        showMainApp();
      } else {
        document.getElementById('loginError').textContent = 'Incorrect password';
      }
    }
    
    function logout() {
      localStorage.removeItem('ball603_auth');
      localStorage.removeItem('ball603_contributor');
      location.reload();
    }
    
    function showMainApp() {
      document.getElementById('loginScreen').style.display = 'none';
      document.getElementById('mainApp').style.display = 'block';
      populateContributors();
      loadGames();
    }
    
    function populateContributors() {
      const select = document.getElementById('contributorSelect');
      CONTRIBUTORS.forEach(name => {
        const opt = document.createElement('option');
        opt.value = name;
        opt.textContent = name;
        select.appendChild(opt);
      });
      const saved = localStorage.getItem('ball603_contributor');
      if (saved) select.value = saved;
    }
    
    function saveContributor() {
      const name = document.getElementById('contributorSelect').value;
      localStorage.setItem('ball603_contributor', name);
      renderAlerts();
      renderGames();
    }
    
    function getContributor() {
      return document.getElementById('contributorSelect').value;
    }
    
    function isAdmin() {
      return getContributor() === ADMIN_USER;
    }
    
    async function loadGames() {
      try {
        const response = await fetch('/.netlify/functions/get-games');
        const data = await response.json();
        allGames = data.games || [];
        populateDivisionFilter();
        renderAlerts();
        renderGames();
      } catch (err) {
        document.getElementById('gamesContainer').innerHTML = '<div class="loading">Error loading games. Please refresh.</div>';
      }
    }
    
    function renderAlerts() {
      const me = getContributor();
      if (!me) {
        document.getElementById('alertBanner').style.display = 'none';
        return;
      }
      
      // Get games with schedule changes
      let changedGames;
      if (isAdmin()) {
        // Admin sees ALL alerts
        changedGames = allGames.filter(g => g.schedule_changed);
      } else {
        // Regular user sees only their alerts
        changedGames = allGames.filter(g => {
          const isMine = g.photog1 === me || g.photog2 === me || g.videog === me || g.writer === me;
          return isMine && g.schedule_changed;
        });
      }
      
      if (changedGames.length === 0) {
        document.getElementById('alertBanner').style.display = 'none';
        return;
      }
      
      document.getElementById('alertBanner').style.display = 'block';
      
      let html = '';
      changedGames.forEach(game => {
        const contributors = [game.photog1, game.photog2, game.videog, game.writer].filter(Boolean);
        html += `
          <div class="alert-item">
            <div class="alert-info">
              <div class="alert-game">${game.away} @ ${game.home}</div>
              <div class="alert-change">
                Changed from ${formatDate(game.original_date)} ‚Üí ${formatDate(game.date)}
                ${isAdmin() ? `<span class="alert-contributor">(${contributors.join(', ')})</span>` : ''}
              </div>
            </div>
            <div class="alert-buttons">
              <button class="alert-btn accept" onclick="acceptChange('${game.game_id}')">‚úì Accept</button>
              <button class="alert-btn deny" onclick="denyChange('${game.game_id}')">‚úó Can't Do</button>
            </div>
          </div>
        `;
      });
      
      document.getElementById('alertList').innerHTML = html;
    }
    
    async function acceptChange(gameId) {
      // Clear the schedule_changed flag
      try {
        await fetch('/.netlify/functions/update-assignment', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ gameId, field: 'schedule_changed', value: '' })
        });
        
        const game = allGames.find(g => g.game_id === gameId);
        if (game) game.schedule_changed = false;
        renderAlerts();
        renderGames();
      } catch (err) {
        alert('Error updating. Please try again.');
      }
    }
    
    async function denyChange(gameId) {
      const me = getContributor();
      const game = allGames.find(g => g.game_id === gameId);
      if (!game) return;
      
      // Find which field(s) this user has claimed
      const fieldsToRemove = [];
      if (game.photog1 === me) fieldsToRemove.push('photog1');
      if (game.photog2 === me) fieldsToRemove.push('photog2');
      if (game.videog === me) fieldsToRemove.push('videog');
      if (game.writer === me) fieldsToRemove.push('writer');
      
      // If admin denying for someone else, just clear the flag
      if (isAdmin() && fieldsToRemove.length === 0) {
        await acceptChange(gameId);
        return;
      }
      
      try {
        // Remove their assignments
        for (const field of fieldsToRemove) {
          await fetch('/.netlify/functions/update-assignment', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ gameId, field, value: '' })
          });
          game[field] = '';
        }
        
        // Check if anyone else still has assignments
        const stillHasAssignments = game.photog1 || game.photog2 || game.videog || game.writer;
        
        // Clear schedule_changed if no one left, or if this user was the only one
        if (!stillHasAssignments) {
          await fetch('/.netlify/functions/update-assignment', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ gameId, field: 'schedule_changed', value: '' })
          });
          game.schedule_changed = false;
        }
        
        renderAlerts();
        renderGames();
      } catch (err) {
        alert('Error updating. Please try again.');
      }
    }
    
    function populateDivisionFilter() {
      const divisions = [...new Set(allGames.map(g => g.division).filter(Boolean))].sort();
      const select = document.getElementById('divisionFilter');
      divisions.forEach(div => {
        const opt = document.createElement('option');
        opt.value = div;
        opt.textContent = div;
        select.appendChild(opt);
      });
    }
    
    function setTab(tab) {
      currentTab = tab;
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.querySelector(`.tab[data-tab="${tab}"]`).classList.add('active');
      renderGames();
    }
    
    function renderGames() {
      const search = document.getElementById('searchInput').value.toLowerCase();
      const gender = document.getElementById('genderFilter').value;
      const division = document.getElementById('divisionFilter').value;
      const assignment = document.getElementById('assignmentFilter').value;
      const me = getContributor();
      
      let games = allGames.filter(g => {
        if (currentTab !== 'all' && g.level !== currentTab) return false;
        if (search && !g.home.toLowerCase().includes(search) && !g.away.toLowerCase().includes(search)) return false;
        if (gender && g.gender !== gender) return false;
        if (division && g.division !== division) return false;
        
        const hasClaim = g.photog1 || g.photog2 || g.videog || g.writer;
        const isMine = g.photog1 === me || g.photog2 === me || g.videog === me || g.writer === me;
        if (assignment === 'unclaimed' && hasClaim) return false;
        if (assignment === 'mine' && !isMine) return false;
        if (assignment === 'claimed' && !hasClaim) return false;
        
        return true;
      });
      
      const today = new Date().toISOString().split('T')[0];
      games = games.filter(g => g.date >= today);
      
      games.sort((a, b) => {
        if (a.date !== b.date) return a.date.localeCompare(b.date);
        return (a.time || '').localeCompare(b.time || '');
      });
      
      if (games.length === 0) {
        document.getElementById('gamesContainer').innerHTML = '<div class="loading">No games found</div>';
        return;
      }
      
      let html = `
        <table class="games-table">
          <thead>
            <tr>
              <th>Date</th>
              <th>Time</th>
              <th>Away</th>
              <th>Home</th>
              <th class="hide-mobile">Gender</th>
              <th class="hide-mobile">Level</th>
              <th class="hide-mobile">Div</th>
              <th></th>
              <th>Coverage</th>
              <th class="hide-mobile">Notes</th>
            </tr>
          </thead>
          <tbody>
      `;
      
      games.forEach(game => {
        const rowClass = game.schedule_changed ? 'game-changed' : '';
        html += `
          <tr data-id="${game.game_id}" class="${rowClass}">
            <td>${renderDateCell(game)}</td>
            <td>${formatTime(game.time)}</td>
            <td>${game.away}</td>
            <td>${game.home}</td>
            <td class="hide-mobile">${game.gender || ''}</td>
            <td class="hide-mobile">${game.level || ''}</td>
            <td class="hide-mobile">${game.division || ''}</td>
            <td class="claim-cell">${renderClaimCell(game)}</td>
            <td class="coverage-cell">${renderCoverageCell(game)}</td>
            <td class="hide-mobile notes-cell">${renderNotesCell(game)}</td>
          </tr>
        `;
      });
      
      html += '</tbody></table>';
      document.getElementById('gamesContainer').innerHTML = html;
    }
    
    function renderDateCell(game) {
      if (game.schedule_changed && game.original_date) {
        return `
          <div class="date-change">
            <span class="old-date">${formatDate(game.original_date)}</span>
            <span class="new-date">${formatDate(game.date)}</span>
          </div>
        `;
      }
      return formatDate(game.date);
    }
    
    function formatDate(isoDate) {
      if (!isoDate) return '';
      const [year, month, day] = isoDate.split('-');
      const monthName = MONTH_NAMES[parseInt(month, 10) - 1];
      const dayNum = parseInt(day, 10);
      return `${monthName} ${dayNum}`;
    }
    
    function formatTime(time) {
      if (!time) return '';
      return time.replace(/^0/, '');
    }
    
    function renderClaimCell(game) {
      const me = getContributor();
      if (!me) return '';
      
      const canClaimPhotog = !game.photog1 || (!game.photog2 && game.photog1 !== me);
      const canClaimVideo = !game.videog || game.videog !== me;
      const canClaimWriter = !game.writer || game.writer !== me;
      
      // Only show if there's something to claim
      if (!canClaimPhotog && !canClaimVideo && !canClaimWriter) return '';
      
      return `
        <div class="claim-wrapper">
          <button class="claim-btn" onclick="toggleClaimDropdown(event, '${game.game_id}')">‚ûï</button>
          <div class="claim-dropdown" id="dropdown-${game.game_id}">
            ${!game.photog1 ? `<div class="claim-option" onclick="claim('${game.game_id}', 'photog1')"><span class="emoji">üì∏</span> Photographer</div>` : ''}
            ${game.photog1 && !game.photog2 && game.photog1 !== me ? `<div class="claim-option" onclick="claim('${game.game_id}', 'photog2')"><span class="emoji">üì∏</span> Photographer (+1)</div>` : ''}
            ${!game.videog ? `<div class="claim-option" onclick="claim('${game.game_id}', 'videog')"><span class="emoji">üé•</span> Videographer</div>` : ''}
            ${!game.writer ? `<div class="claim-option" onclick="claim('${game.game_id}', 'writer')"><span class="emoji">üìù</span> Writer</div>` : ''}
          </div>
        </div>
      `;
    }
    
    function renderCoverageCell(game) {
      const me = getContributor();
      let html = '';
      
      // Show existing coverage
      const coverageItems = [
        { field: 'photog1', emoji: 'üì∏', name: game.photog1 },
        { field: 'photog2', emoji: 'üì∏', name: game.photog2 },
        { field: 'videog', emoji: 'üé•', name: game.videog },
        { field: 'writer', emoji: 'üìù', name: game.writer }
      ].filter(item => item.name);
      
      if (coverageItems.length === 0) {
        return '<span style="color:#999">-</span>';
      }
      
      coverageItems.forEach(item => {
        const isMine = item.name === me;
        html += `
          <div class="coverage-entry">
            <span class="coverage-emoji">${item.emoji}</span>
            <span class="coverage-name">${item.name}</span>
            ${isMine ? `<button class="coverage-remove" onclick="removeClaim('${game.game_id}', '${item.field}')">‚úï</button>` : ''}
          </div>
        `;
      });
      
      return html;
    }
    
    function toggleClaimDropdown(event, gameId) {
      event.stopPropagation();
      const dropdown = document.getElementById(`dropdown-${gameId}`);
      
      if (openDropdown && openDropdown !== dropdown) {
        openDropdown.classList.remove('show');
      }
      
      dropdown.classList.toggle('show');
      openDropdown = dropdown.classList.contains('show') ? dropdown : null;
    }
    
    function renderNotesCell(game) {
      return `<input class="notes-input" value="${game.notes || ''}" onblur="updateNotes('${game.game_id}', this.value)" placeholder="Add note...">`;
    }
    
    async function claim(gameId, field) {
      const me = getContributor();
      if (!me) {
        alert('Please select your name first');
        return;
      }
      
      // Close dropdown
      if (openDropdown) {
        openDropdown.classList.remove('show');
        openDropdown = null;
      }
      
      try {
        const response = await fetch('/.netlify/functions/update-assignment', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ gameId, field, value: me })
        });
        
        if (response.ok) {
          const game = allGames.find(g => g.game_id === gameId);
          if (game) game[field] = me;
          renderGames();
        } else {
          alert('Error saving. Please try again.');
        }
      } catch (err) {
        alert('Error saving. Please try again.');
      }
    }
    
    async function removeClaim(gameId, field) {
      try {
        const response = await fetch('/.netlify/functions/update-assignment', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ gameId, field, value: '' })
        });
        
        if (response.ok) {
          const game = allGames.find(g => g.game_id === gameId);
          if (game) game[field] = '';
          renderGames();
        }
      } catch (err) {
        alert('Error removing. Please try again.');
      }
    }
    
    async function updateNotes(gameId, value) {
      try {
        await fetch('/.netlify/functions/update-assignment', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ gameId, field: 'notes', value })
        });
        
        const game = allGames.find(g => g.game_id === gameId);
        if (game) game.notes = value;
      } catch (err) {
        // Silent fail for notes
      }
    }
  </script>
</body>
</html>
