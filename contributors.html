<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ball603 Contributors</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f5f5f5; color: #333; min-height: 100vh; }
    .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
    
    /* Login */
    .login-box { background: #fff; padding: 40px; border-radius: 10px; max-width: 400px; margin: 100px auto; box-shadow: 0 2px 10px rgba(0,0,0,0.1); text-align: center; }
    .login-box img { max-width: 200px; margin-bottom: 20px; }
    .login-box input { width: 100%; padding: 12px; margin-bottom: 15px; border: 1px solid #ddd; border-radius: 5px; font-size: 16px; }
    .login-box button { width: 100%; padding: 12px; background: #c41e3a; color: white; border: none; border-radius: 5px; font-size: 16px; cursor: pointer; }
    .login-box button:hover { background: #a01830; }
    .error { color: #c41e3a; margin-top: 10px; }
    
    /* Header */
    .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 15px; background: #fff; padding: 15px 20px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
    .header-left { display: flex; align-items: center; gap: 15px; }
    .header-left img { height: 50px; }
    .header-left h1 { font-size: 18px; color: #333; }
    .user-info { display: flex; align-items: center; gap: 15px; }
    .user-info select { padding: 8px 12px; border-radius: 5px; border: 1px solid #ddd; font-size: 14px; }
    .logout-btn { padding: 8px 16px; background: #eee; color: #333; border: none; border-radius: 5px; cursor: pointer; }
    .logout-btn:hover { background: #ddd; }
    
    /* Filters */
    .filters { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
    .filters select, .filters input { padding: 8px 12px; border-radius: 5px; border: 1px solid #ddd; font-size: 14px; background: #fff; }
    .filters input { width: 200px; }
    
    /* Tabs */
    .tabs { display: flex; gap: 5px; margin-bottom: 20px; }
    .tab { padding: 10px 20px; background: #fff; border: 1px solid #ddd; color: #666; cursor: pointer; border-radius: 5px 5px 0 0; }
    .tab.active { background: #c41e3a; color: white; border-color: #c41e3a; }
    
    /* Games Table */
    .games-table { width: 100%; border-collapse: collapse; background: #fff; border-radius: 10px; overflow: hidden; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
    .games-table th { background: #e8e8e8; padding: 12px; text-align: left; font-weight: 600; color: #333; }
    .games-table td { padding: 12px; border-bottom: 1px solid #eee; }
    .games-table tr:hover { background: #fafafa; }
    
    /* Claim buttons - pill style */
    .claim-btn { padding: 4px 12px; border-radius: 20px; cursor: pointer; font-size: 12px; transition: all 0.2s; }
    .claim-btn.available { background: transparent; border: 2px solid #4CAF50; color: #4CAF50; }
    .claim-btn.available:hover { background: #4CAF50; color: white; }
    .claim-btn.claimed { background: #c41e3a; border: 2px solid #c41e3a; color: white; }
    .claim-btn.remove { background: transparent; border: none; color: #999; padding: 2px 6px; font-size: 14px; }
    .claim-btn.remove:hover { color: #c41e3a; }
    
    /* Assignment badges */
    .assignment { display: inline-flex; align-items: center; gap: 4px; background: #c41e3a; color: white; padding: 4px 10px; border-radius: 20px; font-size: 12px; margin: 2px; }
    .assignment.video { background: #7b1fa2; }
    
    /* Notes */
    .notes-cell { max-width: 200px; }
    .notes-input { width: 100%; padding: 4px 8px; border: 1px solid #ddd; border-radius: 4px; background: #fff; color: #333; font-size: 12px; }
    .notes-input:focus { outline: none; border-color: #c41e3a; }
    
    /* Responsive */
    @media (max-width: 768px) {
      .games-table { font-size: 14px; }
      .games-table th, .games-table td { padding: 8px 6px; }
      .hide-mobile { display: none; }
      .header-left h1 { display: none; }
    }
    
    .loading { text-align: center; padding: 40px; color: #888; }
  </style>
</head>
<body>
  <div class="container" id="app">
    <!-- Login Screen -->
    <div class="login-box" id="loginScreen">
      <img src="logo.png" alt="Ball603">
      <input type="password" id="password" placeholder="Enter password" onkeypress="if(event.key==='Enter')login()">
      <button onclick="login()">Login</button>
      <div class="error" id="loginError"></div>
    </div>
    
    <!-- Main App (hidden until login) -->
    <div id="mainApp" style="display: none;">
      <div class="header">
        <div class="header-left">
          <img src="logo.png" alt="Ball603">
          <h1>Contributors</h1>
        </div>
        <div class="user-info">
          <span>You are:</span>
          <select id="contributorSelect" onchange="saveContributor()">
            <option value="">-- Select Your Name --</option>
          </select>
          <button class="logout-btn" onclick="logout()">Logout</button>
        </div>
      </div>
      
      <div class="filters">
        <input type="text" id="searchInput" placeholder="Search teams..." oninput="renderGames()">
        <select id="genderFilter" onchange="renderGames()">
          <option value="">All Genders</option>
          <option value="Boys">Boys</option>
          <option value="Girls">Girls</option>
          <option value="Men">Men</option>
          <option value="Women">Women</option>
        </select>
        <select id="divisionFilter" onchange="renderGames()">
          <option value="">All Divisions</option>
        </select>
        <select id="assignmentFilter" onchange="renderGames()">
          <option value="">All Games</option>
          <option value="unclaimed">Unclaimed Only</option>
          <option value="mine">My Assignments</option>
          <option value="claimed">Claimed</option>
        </select>
      </div>
      
      <div class="tabs">
        <button class="tab active" data-tab="all" onclick="setTab('all')">All Games</button>
        <button class="tab" data-tab="NHIAA" onclick="setTab('NHIAA')">NHIAA</button>
        <button class="tab" data-tab="College" onclick="setTab('College')">College</button>
        <button class="tab" data-tab="Prep" onclick="setTab('Prep')">Prep</button>
      </div>
      
      <div id="gamesContainer">
        <div class="loading">Loading games...</div>
      </div>
    </div>
  </div>

  <script>
    const CONTRIBUTORS = [
      "Andy Romike", "Arinn Roy", "Betsy Hansen", "Cam Place", "Chris Laclair", "Chris Prangley",
      "Christine Gilbert", "Chuck Swierad", "Cindy Lavigne", "Connor Chrusciel", "Danielle Cook",
      "Dave Beliveau", "Frank V Fichera", "Greg Alnwick", "Hannah Smith", "Haven Deschenes",
      "Heather Savage-Erickson", "Heidi Green", "Jeff Criss", "Jessica Bonnette", "Jessica Tate",
      "Jill Stevens", "Jocelyn Sprague", "John Scott Sherburne", "KJ Cardinal", "Leo Cardinal", "LJ Hydock",
      "Logan Paronto", "Marc Hoak", "Maverick Thivierge", "Michael Griffin", "Mike Whaley",
      "Mindy Marcouillier", "Nate Ford", "Nichole Marrero", "Rick Wilson", "Sara Roberts",
      "Shawna Hurlbert", "Shirley Nickles", "Simon Scott", "Stefan Duncan", "Tim Lee",
      "Todd Grzywacz", "Tyson Thomas"
    ].sort();
    
    const CORRECT_PASSWORD = 'Gr@niteSt@teHoops';
    let allGames = [];
    let currentTab = 'all';
    
    const MONTH_NAMES = ['Jan.', 'Feb.', 'Mar.', 'Apr.', 'May', 'Jun.', 'Jul.', 'Aug.', 'Sep.', 'Oct.', 'Nov.', 'Dec.'];
    
    // Check if already logged in
    if (localStorage.getItem('ball603_auth') === 'true') {
      showMainApp();
    }
    
    function login() {
      const pw = document.getElementById('password').value;
      if (pw === CORRECT_PASSWORD) {
        localStorage.setItem('ball603_auth', 'true');
        showMainApp();
      } else {
        document.getElementById('loginError').textContent = 'Incorrect password';
      }
    }
    
    function logout() {
      localStorage.removeItem('ball603_auth');
      localStorage.removeItem('ball603_contributor');
      location.reload();
    }
    
    function showMainApp() {
      document.getElementById('loginScreen').style.display = 'none';
      document.getElementById('mainApp').style.display = 'block';
      populateContributors();
      loadGames();
    }
    
    function populateContributors() {
      const select = document.getElementById('contributorSelect');
      CONTRIBUTORS.forEach(name => {
        const opt = document.createElement('option');
        opt.value = name;
        opt.textContent = name;
        select.appendChild(opt);
      });
      // Restore saved selection
      const saved = localStorage.getItem('ball603_contributor');
      if (saved) select.value = saved;
    }
    
    function saveContributor() {
      const name = document.getElementById('contributorSelect').value;
      localStorage.setItem('ball603_contributor', name);
      renderGames();
    }
    
    function getContributor() {
      return document.getElementById('contributorSelect').value;
    }
    
    async function loadGames() {
      try {
        const response = await fetch('/.netlify/functions/get-games');
        const data = await response.json();
        allGames = data.games || [];
        populateDivisionFilter();
        renderGames();
      } catch (err) {
        document.getElementById('gamesContainer').innerHTML = '<div class="loading">Error loading games. Please refresh.</div>';
      }
    }
    
    function populateDivisionFilter() {
      const divisions = [...new Set(allGames.map(g => g.division).filter(Boolean))].sort();
      const select = document.getElementById('divisionFilter');
      divisions.forEach(div => {
        const opt = document.createElement('option');
        opt.value = div;
        opt.textContent = div;
        select.appendChild(opt);
      });
    }
    
    function setTab(tab) {
      currentTab = tab;
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.querySelector(`.tab[data-tab="${tab}"]`).classList.add('active');
      renderGames();
    }
    
    function renderGames() {
      const search = document.getElementById('searchInput').value.toLowerCase();
      const gender = document.getElementById('genderFilter').value;
      const division = document.getElementById('divisionFilter').value;
      const assignment = document.getElementById('assignmentFilter').value;
      const me = getContributor();
      
      let games = allGames.filter(g => {
        // Tab filter
        if (currentTab !== 'all' && g.level !== currentTab) return false;
        
        // Search
        if (search && !g.home.toLowerCase().includes(search) && !g.away.toLowerCase().includes(search)) return false;
        
        // Gender
        if (gender && g.gender !== gender) return false;
        
        // Division
        if (division && g.division !== division) return false;
        
        // Assignment filter
        const hasClaim = g.photog1 || g.photog2 || g.videog;
        const isMine = g.photog1 === me || g.photog2 === me || g.videog === me;
        if (assignment === 'unclaimed' && hasClaim) return false;
        if (assignment === 'mine' && !isMine) return false;
        if (assignment === 'claimed' && !hasClaim) return false;
        
        return true;
      });
      
      // Only show future games (today and forward)
      const today = new Date().toISOString().split('T')[0];
      games = games.filter(g => g.date >= today);
      
      // Sort by date/time
      games.sort((a, b) => {
        if (a.date !== b.date) return a.date.localeCompare(b.date);
        return (a.time || '').localeCompare(b.time || '');
      });
      
      if (games.length === 0) {
        document.getElementById('gamesContainer').innerHTML = '<div class="loading">No games found</div>';
        return;
      }
      
      let html = `
        <table class="games-table">
          <thead>
            <tr>
              <th>Date</th>
              <th>Time</th>
              <th>Away</th>
              <th>Home</th>
              <th class="hide-mobile">Gender</th>
              <th class="hide-mobile">Level</th>
              <th class="hide-mobile">Div</th>
              <th>Photog</th>
              <th>Video</th>
              <th class="hide-mobile">Notes</th>
            </tr>
          </thead>
          <tbody>
      `;
      
      games.forEach(game => {
        const dateFormatted = formatDate(game.date);
        const timeFormatted = formatTime(game.time);
        html += `
          <tr data-id="${game.game_id}">
            <td>${dateFormatted}</td>
            <td>${timeFormatted}</td>
            <td>${game.away}</td>
            <td>${game.home}</td>
            <td class="hide-mobile">${game.gender || ''}</td>
            <td class="hide-mobile">${game.level || ''}</td>
            <td class="hide-mobile">${game.division || ''}</td>
            <td>${renderPhotogCell(game)}</td>
            <td>${renderVideoCell(game)}</td>
            <td class="hide-mobile notes-cell">${renderNotesCell(game)}</td>
          </tr>
        `;
      });
      
      html += '</tbody></table>';
      document.getElementById('gamesContainer').innerHTML = html;
    }
    
    function formatDate(isoDate) {
      if (!isoDate) return '';
      const [year, month, day] = isoDate.split('-');
      const monthName = MONTH_NAMES[parseInt(month, 10) - 1];
      const dayNum = parseInt(day, 10); // removes leading zero
      return `${monthName} ${dayNum}`;
    }
    
    function formatTime(time) {
      if (!time) return '';
      // Remove leading zero from hour
      return time.replace(/^0/, '');
    }
    
    function renderPhotogCell(game) {
      const me = getContributor();
      let html = '';
      
      // Show existing photogs
      if (game.photog1) {
        const isMine = game.photog1 === me;
        html += `<span class="assignment">${game.photog1}`;
        if (isMine) html += ` <button class="claim-btn remove" onclick="removeClaim('${game.game_id}', 'photog1')">âœ•</button>`;
        html += `</span>`;
      }
      if (game.photog2) {
        const isMine = game.photog2 === me;
        html += `<span class="assignment">${game.photog2}`;
        if (isMine) html += ` <button class="claim-btn remove" onclick="removeClaim('${game.game_id}', 'photog2')">âœ•</button>`;
        html += `</span>`;
      }
      
      // Show claim button if slot available and user selected
      if (me && !game.photog1) {
        html += `<button class="claim-btn available" onclick="claim('${game.game_id}', 'photog1')">ðŸ“¸ Claim</button>`;
      } else if (me && !game.photog2 && game.photog1 !== me) {
        html += `<button class="claim-btn available" onclick="claim('${game.game_id}', 'photog2')">ðŸ“¸ +1</button>`;
      }
      
      return html || '-';
    }
    
    function renderVideoCell(game) {
      const me = getContributor();
      let html = '';
      
      if (game.videog) {
        const isMine = game.videog === me;
        html += `<span class="assignment video">${game.videog}`;
        if (isMine) html += ` <button class="claim-btn remove" onclick="removeClaim('${game.game_id}', 'videog')">âœ•</button>`;
        html += `</span>`;
      } else if (me) {
        html += `<button class="claim-btn available" onclick="claim('${game.game_id}', 'videog')">ðŸŽ¥ Claim</button>`;
      }
      
      return html || '-';
    }
    
    function renderNotesCell(game) {
      return `<input class="notes-input" value="${game.notes || ''}" onblur="updateNotes('${game.game_id}', this.value)" placeholder="Add note...">`;
    }
    
    async function claim(gameId, field) {
      const me = getContributor();
      if (!me) {
        alert('Please select your name first');
        return;
      }
      
      try {
        const response = await fetch('/.netlify/functions/update-assignment', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ gameId, field, value: me })
        });
        
        if (response.ok) {
          // Update local data
          const game = allGames.find(g => g.game_id === gameId);
          if (game) game[field] = me;
          renderGames();
        } else {
          alert('Error saving. Please try again.');
        }
      } catch (err) {
        alert('Error saving. Please try again.');
      }
    }
    
    async function removeClaim(gameId, field) {
      try {
        const response = await fetch('/.netlify/functions/update-assignment', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ gameId, field, value: '' })
        });
        
        if (response.ok) {
          const game = allGames.find(g => g.game_id === gameId);
          if (game) game[field] = '';
          renderGames();
        }
      } catch (err) {
        alert('Error removing. Please try again.');
      }
    }
    
    async function updateNotes(gameId, value) {
      try {
        await fetch('/.netlify/functions/update-assignment', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ gameId, field: 'notes', value })
        });
        
        const game = allGames.find(g => g.game_id === gameId);
        if (game) game.notes = value;
      } catch (err) {
        // Silent fail for notes
      }
    }
  </script>
</body>
</html>
